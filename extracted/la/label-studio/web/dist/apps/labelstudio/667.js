(self.webpackChunklabelstudio=self.webpackChunklabelstudio||[]).push([[667],{47895:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,l:()=>o});const o={fillcolor:"#666",opacity:.2,strokecolor:"#666",strokewidth:1},i={FILL_COLOR:"",STROKE_COLOR:"",STROKE_WIDTH:1,LABEL_BACKGROUND:"#36B37E",EMPTY_LABEL:"blank",RELATION_BACKGROUND:"#fff",SHOW_LABEL_FILL:"white",SHOW_LABEL_BACKGROUND:"black",HIGHLIGHTED_STROKE_COLOR:"red",HIGHLIGHTED_STROKE_WIDTH:2,HIGHLIGHTED_CSS_BORDER:"1px dashed #00aeff",SUGGESTION_STROKE_WIDTH:4,DEFAULT_CURSOR:"default",CHOOSE_CURSOR:"pointer",POINTER_CURSOR:"pointer",MOVE_CURSOR:"hand",LINKING_MODE_CURSOR:"crosshair",BRIGHTNESS_VALUE:100,BRIGHTNESS_MAX:400,CONTRAST_VALUE:100,CONTRAST_MAX:400}},30997:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o={onDeleteAnnotation:function(){},onEntityCreate:function(){},onEntityDelete:function(){},onGroundTruth:function(){},onLabelStudioLoad:function(){},onSkipTask:function(){},onUnskipTask:function(){},onSubmitAnnotation:function(){},onSubmitDraft:function(e){},onTaskLoad:function(){},onUpdateAnnotation:function(){},onSelectAnnotation:function(e,t){},onAcceptAnnotation:function(e,t){},onRejectAnnotation:function(e,t){},onStorageInitialized:function(e){},onNextTask:function(e){},onPrevTask:function(e){}}},81117:()=>{0},97764:(e,t,n)=>{"use strict";n.r(t),n.d(t,{LabelStudio:()=>Rw,default:()=>_w});var o={};n.r(o),n.d(o,{drawMask:()=>kt});var i={};n.r(i),n.d(i,{canvasToBinaryMatrix:()=>Rt,createDragBoundFunc:()=>Kt,fixRectToFit:()=>At,getActualZoomingPosition:()=>Pt,getBoundingBoxAfterChanges:()=>Tt,getBoundingBoxAfterTransform:()=>_t,getTransformedImageData:()=>Et,reverseCoordinates:()=>jt});var s={};n.r(s),n.d(s,{currentISODate:()=>It,msToHMS:()=>Mt,prettyDate:()=>Dt,toISODateString:()=>Ot});var r={};n.r(r),n.d(r,{applySpanStyles:()=>Zt,applyTextGranularity:()=>Wt,captureSelection:()=>Ft,charsToCodePoints:()=>Qt,findNodesBetween:()=>qt,fixCodePointsInRange:()=>en,highlightRange:()=>Yt,highlightRangePart:()=>Xt,isSelectionContainsSpan:()=>on,isTextNode:()=>Lt,rangeToGlobalOffset:()=>tn,removeRange:()=>Jt,trimSelection:()=>Ht,wrapWithSpan:()=>Gt});var a={};n.r(a),n.d(a,{AudioVolumeControl:()=>Fo,FramesControl:()=>Io});var l={};n.r(l),n.d(l,{Brightness:()=>Wl,Brush:()=>fl,Contrast:()=>Yl,Ellipse:()=>El,Erase:()=>xl,KeyPoint:()=>wl,MagicWand:()=>Zl,Polygon:()=>Cl,Rect:()=>Tl,Rect3Point:()=>Al,Rotate:()=>Hl,Selection:()=>Ql,Zoom:()=>Nl});var d={};n.r(d),n.d(d,{VideoSettings:()=>fy});n(81117);var c=n(57896),u=n(77099),h=n(43144),g=n(83126),m=n(14041),p=n(56036),f=n(69447),v=n(56351);const y=new class{constructor(){this.tags=[],this.models={},this.views={},this.regions=[],this.objects=[],this.areas=new Map,this.views_models={},this.tools={},this.perRegionViews={}}addTag(e,t,n){this.tags.push(e),this.models[e]=t,this.views[e]=n,this.views_models[t.name]=n}addRegionType(e,t,n){this.regions.push(e),n&&(e.detectByValue=n);const o=this.areas.get(t);o?o.push(e):this.areas.set(t,[e])}regionTypes(){return this.regions}addObjectType(e){this.objects.push(e)}objectTypes(){return this.objects}modelsArr(){return Object.values(this.models)}getViewByModel(e){const t=this.views_models[e];if(!t)throw new Error(`No view for model: ${e}`);return t}getViewByTag(e){return this.views[e]}getAvailableAreas(e,t){const n=this.areas.get(e);if(!n)return[];if(t)for(const e of n)if(e.detectByValue&&e.detectByValue(t))return[e];return n.filter((e=>!e.detectByValue))}getTool(e){const t=this.tools[e];if(!t){const t=Object.keys(this.tools);throw new Error(`No model registered for tool: ${e}\nAvailable models:\n\t${t.join("\n\t")}`)}return t}getModelByTag(e){const t=this.models[e];if(!t){const t=Object.keys(this.models);throw new Error(`No model registered for tag: ${e}\nAvailable models:\n\t${t.join("\n\t")}`)}return t}addPerRegionView(e,t,n){const o=this.perRegionViews[e]||{};o[t]=n,this.perRegionViews[e]=o}getPerRegionView(e,t){var n;return null==(n=this.perRegionViews[e])?void 0:n[t]}};y.getTool=y.getTool.bind(y),y.getModelByTag=y.getModelByTag.bind(y);const b=y;var x=n(48862),S=n(5157),w=n.n(S);const k=(e,t)=>{var n;const o=/\$[\w[\].{}]+/gi;return e?(null==(n=e.match(o))?void 0:n[0])===e?null!=(i=w()(t,e.slice(1)))?i:"":e.replace(o,(e=>{var n;return w()(t,null!=(n=e.slice(1))?n:"")})):"";var i},C=e=>{var t;const[,n,o]=null!=(t=e.match(/^(\w+)(.)?/))?t:[],i={};if(o){e.split(o).slice(1).forEach((e=>{const[t,n]=e.split("=",2);i[t]=null==n||n}))}return{type:n,sep:o,options:i}};var j=n(84826);const R=()=>{var e;return(0,j.VS)(j.Sm)&&!1===(null==(e=window.APP_SETTINGS.billing)?void 0:e.enterprise)};var _=n(74331);const T=(e=10)=>(0,_.Ak)(e);var A=n(31085);const K="skip",E="stop";const P=(e,t,n)=>{!function e(o){if(void 0===o.attributes)return;const i=Array.from(o.attributes).map((e=>e.name));for(const e of i){var s;const i=o.getAttribute(e);o.setAttribute(e,null!=(s=null==i||null==i.replace?void 0:i.replace(n,`${t}`))?s:"")}o.childNodes.forEach((t=>e(t)))}(e)};function M(e,t,n){var o,i;const s=function(e,t){const n={};if(!e)return n;for(const o of e.attributes){const{name:e,value:i}=o;if("value"!==e&&["true","false"].includes(i))n[e.toLowerCase()]="true"===i;else if(t){let o=i;for(const[e,n]of Object.entries(t))o=o.replace(e,n);n[e.toLowerCase()]=o}else n[e.toLowerCase()]=i}return n}(e,n),r=e.tagName.toLowerCase(),a=null!=(o=s.indexflag)?o:"{{idx}}",l=(0,j.VS)(j.cE)&&null!=(i=e.getAttribute("name"))?i:T(),d=Object.assign({},s,{id:l,tagName:e.tagName,type:r});if("repeater"===r){const o=k(s.on,t)||[],i=[];for(let s=0;s<o.length;s++){const o=Object.assign({},n,{[a]:s}),r={id:T(),tagName:"View",type:"view",children:[...e.children].map((e=>{const n=e.cloneNode(!0);return P(n,s,a),M(n,t,o)}))};i.push(r)}d.tagName="View","pagination"===s.mode?d.type="pagedview":d.type="view",d.children=i}else if(!e.childNodes.length||e.children.length&&"hypertext"!==r)e.children.length&&(d.children=[...e.children].map((e=>M(e,t))));else{var c;d.value=(null==(c=e.innerHTML)?void 0:c.trim())||d.value||""}return d}function D(e,t,n=!0){var o;let i=e;if((0,j.VS)(j.cE)){var s;if(!t)return null;i=t.ids.get(I(null!=(s=e.id)?s:e.name))||i}var r;if(!i)return console.error(`Can't find element ${null!=(r=e.id)?r:e.name} in annotation ${null==t?void 0:t.id}`),null;const a=(0,u.Pw)(i),l=a.identifierAttribute,d=a.name,c=b.getViewByModel(d),h=(0,j.VS)(j.U2)&&!R()&&(null==t||null==(o=t.store)?void 0:o.hasInterface("annotation:bulk")),g=!0!==i.isIndependent;if(h&&g)return null;if(!c)throw new Error(`No view for model: ${d}`);const m=l&&i[l]||T();return(0,A.jsx)(c,{item:i},n?m:void 0)}function O(e,t){const n=e=>{const o=t(e);if(o!==K){if(o===E)return E;if(e.children)for(const t of e.children){if(n(t)===E)return E}}};n(e)}const I=e=>e.replace(/@.*/,"");const L={renderItem:D,renderChildren:function(e,t){return e&&e.children&&e.children.length?e.children.map((e=>D(e,t))):null},treeToModel:function(e,t){var n,o,i;const s=(new DOMParser).parseFromString(e,"application/xml"),r=null==s||null==(n=s.children)?void 0:n[0],a=function(e){var t;let n=null==e||null==(t=e.children)?void 0:t[0];for(let e=0;e<3;e++){var o,i;if("parsererror"===(null==(o=n)?void 0:o.tagName))return n.textContent;n=null==(i=n)||null==(i=i.children)?void 0:i[0]}}(s);if(a)throw new Error(a);return M(r,null!=(o=null==(i=t.task)?void 0:i.dataObj)?o:{})},findParentOfType:function(e,t){for(const n of t)try{const t=(0,u.k2)(e,n);if(t)return t}catch(e){console.error(e)}return null},filterChildrenOfType:function(e,t){const n=[],o=Array.isArray(t)?t:[t];return O(e,(e=>{for(const t of o)(0,u.Pw)(e).name===t&&n.push(e)})),n},cssConverter:function(e){if(!e)return null;const t={},n=e.split(";");let o,i,s,r;for(i=0;i<n.length;i++){if(o=n[i].indexOf(":"),s=n[i].substring(0,o),r=n[i].substring(o+1),s=s.replace(/ /g,""),s.length<1)continue;" "===r[0]&&(r=r.substring(1))," "===r[r.length-1]&&(r=r.substring(0,r.length-1));t[s.replace(/(-.)/g,(e=>e[1].toUpperCase()))]=r}return t},traverseTree:O,extractNames:function(e){const t=[],n=new Map,o=new Map,i=b.objectTypes().map((e=>e.name.replace("Model","").toLowerCase()));return O(e,(e=>{e.name&&(n.set(I(e.name),e),i.includes(e.type)&&t.push(I(e.name)))})),O(e,(e=>{if(e.name&&!i.includes(e.type)&&!e.toname&&1===t.length&&(e.toname=t[0]),e&&e.toname){const t=o.get(e.toname);t?t.push(n.get(I(e.name))):o.set(e.toname,[n.get(I(e.name))])}})),{names:n,toNames:o}},cleanUpId:I},N=()=>{const e=(0,m.useRef)(!0);return(0,m.useEffect)((()=>(e.current=!0,()=>{e.current=!1})),[]),e};var z=n(47895);const V=u.gK.model("CommentMode",{}).volatile((()=>({comment:null}))).views((e=>({get annotation(){return(0,u.PA)(e,2)},get regionStore(){return e.annotation.regionStore}}))).actions((e=>({start(t){e.comment=t},stop(){e.comment=null,e.regionStore.unhighlightAll()},addLinkedRegion(t){e.comment.setRegionLink(t),e.stop()},addLinkedResult(t){e.comment.setResultLink(t),e.stop()}}))),H={key:"link_to_comment",model:V},B={key:"create_relation",model:u.gK.model("RelationsMode",{}).volatile((()=>({region:null}))).views((e=>({get annotation(){return(0,u.PA)(e,2)},get regionStore(){return e.annotation.regionStore},get relationStore(){return e.annotation.relationStore}}))).actions((e=>({start(t){e.region=t},stop(){e.region=null,e.regionStore.unhighlightAll()},addLinkedRegion(t){e.relationStore.addRelation(e.region,t),e.stop()}})))},F=B.key,W=H.key,$=u.gK.union(H.model,B.model),U=u.gK.model("LinkingModes",{linkingModes:u.gK.optional(u.gK.map($),(()=>({[B.key]:B.model.create({}),[H.key]:H.model.create({})})))}).volatile((e=>({linkingMode:!1}))).views((e=>({get currentLinkingMode(){return e.linkingMode&&e.linkingModes.has(e.linkingMode)?e.linkingModes.get(e.linkingMode):null},get isLinkingMode(){return!!e.linkingMode},get relationMode(){return console.warn("`relationMode` is deprecated. Use `isLinkingMode` instead."),e.isLinkingMode}}))).actions((e=>({startLinkingMode(t,n){e.isLinkingMode&&e.stopLinkingMode(),e.linkingMode=t,e.currentLinkingMode?(e.currentLinkingMode.start(n),document.body.style.cursor=z.A.CHOOSE_CURSOR):e.linkingMode=!1},stopLinkingMode(){document.body.style.cursor=z.A.DEFAULT_CURSOR,e.currentLinkingMode&&e.currentLinkingMode.stop(),e.linkingMode=!1},addLinkedRegion(t){e.currentLinkingMode&&(null==e.currentLinkingMode.addLinkedRegion||e.currentLinkingMode.addLinkedRegion(t))},addLinkedResult(t){e.currentLinkingMode&&(null==e.currentLinkingMode.addLinkedResult||e.currentLinkingMode.addLinkedResult(t))},startRelationMode(t){console.warn("`startRelationMode` is deprecated. Use `startLinkingMode(CREATE_RELATION_MODE, obj)` instead."),e.startLinkingMode(B.key,t)},stopRelationMode(){console.warn("`stopRelationMode` is deprecated. Use `stopLinkingMode` instead."),e.stopLinkingMode()}})));var Y;const X=null!=(Y=window.ResizeObserver)?Y:class{observe(){}unobserve(){}disconnect(){}};function G(e,t,n=!1){let o;return function(...i){const s=n&&!o;clearTimeout(o),o=setTimeout((()=>{o=null,n||e.apply(this,i)}),t),s&&e.apply(this,i)}}class Z{static normalizeAngle(e){return(e+360)%360*(Math.PI/180)}static getPointsBBox(e){const t=[null,null,null,null];return e.forEach(((e,n)=>{const o=2*Math.round(n/2)-n;0===o?((null===t[0]||t[0]>=e)&&(t[0]=e),(null===t[2]||t[2]<=e)&&(t[2]=e)):1===o&&((null===t[1]||t[1]>=e)&&(t[1]=e),(null===t[3]||t[3]<=e)&&(t[3]=e))})),t}static distance(e,t){const[n,o]=e,[i,s]=t;return Math.sqrt((i-n)**2+(s-o)**2)}static toRectCoordinates(e){const{x:t,y:n,width:o,height:i}=e,[s,r]=[t+o,n],[a,l]=[t+o,n+i],[d,c]=[t,n+i];return{x1:t,x2:s,x3:a,x4:d,y1:n,y2:r,y3:l,y4:c}}static convertToRectBBox(e){return{x:e.x1,y:e.y1,width:e.x2-e.x1,height:e.y3-e.y1}}static closestRects(e,t){return e.reduce(((e,n)=>{const o=Z.toRectCoordinates(n);return t.forEach((t=>{const n=Z.toRectCoordinates(t),i=[Z.distance([o.x1,o.y1],[n.x1,o.y1]),Z.distance([o.x2,o.y2],[n.x2,o.y2]),Z.distance([o.x3,o.y3],[n.x3,o.y3]),Z.distance([o.x4,o.y4],[n.x4,n.y4])].reduce(((e,t)=>e+t))/4;e.push({distance:i,bbox:[Z.convertToRectBBox(o),Z.convertToRectBBox(n)]})})),e}),[]).sort(((e,t)=>e.distance-t.distance))[0].bbox}static scaleBBox(e,t=1){return Object.assign({},e,{x:e.x*t,y:e.y*t,width:e.width*t,height:e.height*t})}static modifyBBoxCoords(e,t=e=>e){const n=t([e.x,e.y]),o=t([e.width+e.x,e.height+e.y]);return Object.assign({},e,{x:Math.min(n[0],o[0]),y:Math.min(n[1],o[1]),width:Math.abs(o[0]-n[0]),height:Math.abs(o[1]-n[1])})}static padding(e,t=0){const n=e.width<1?0:t,o=e.height<1?0:t;return Object.assign({},e,{x:e.x-n,y:e.y-o,width:e.width+2*n,height:e.height+2*o})}static getEllipseBBox(e,t,n,o,i){const s=Z.normalizeAngle(i),r=2*Math.max(n,o),a=2*Math.min(n,o),[l,d]=(()=>{const t=Math.atan(-a/2*Math.tan(s)/(r/2));return[t,t+Math.PI].map((t=>e+r/2*Math.cos(t)*Math.cos(s)-a/2*Math.sin(t)*Math.sin(s))).sort(((e,t)=>t-e))})(),[c,u]=(()=>{const e=Math.atan(a/2*1/Math.tan(s)/(r/2));return[e,e+Math.PI].map((e=>t+a/2*Math.sin(e)*Math.cos(s)+r/2*Math.cos(e)*Math.sin(s))).sort(((e,t)=>t-e))})();return{x:d,y:u,width:l-d,height:c-u}}static getRectBBox(e,t,n,o,i){const s=Z.normalizeAngle(i),r=(n,o)=>[(n-e)*Math.cos(s)-(o-t)*Math.sin(s)+e,(n-e)*Math.sin(s)+(o-t)*Math.cos(s)+t],[a,l,d,c]=Z.getPointsBBox([e,t,...r(e+n,t),...r(e+n,t+o),...r(e,t+o)]);return{x:a,y:l,width:d-a,height:c-l}}static getPolygonBBox(e){const t=e.reduce(((e,t)=>[...e,t.x,t.y]),[]),[n,o,i,s]=Z.getPointsBBox(t);return{x:n,y:o,width:i-n,height:s-o}}static getBrushBBox(e){const[t,n,o,i]=Z.getPointsBBox(e);return{x:t,y:n,width:o-t,height:i-n}}static getImageDataBBox(e,t,n){if(e.length!==t*n*4)return null;const o={x:t,y:n},i={x:0,y:0};for(let s=0;s<n;s++)for(let n=0;n<t;n++){e[4*(s*t+n)+3]&&(o.x>n&&(o.x=n),o.y>s&&(o.y=s),i.x<n&&(i.x=n),i.y<s&&(i.y=s))}return o.x<=i.x&&o.y<=i.y?{x:o.x,y:o.y,width:i.x-o.x,height:i.y-o.y}:null}static combineBBoxes(...e){const[t,n,o,i]=Z.getPointsBBox(e.reduce(((e,t)=>(t&&t.x&&t.y&&(e.push(t.x),e.push(t.y),e.push(t.x+t.width),e.push(t.y+t.height)),e)),[]));return{x:t,y:n,width:o-t,height:i-n}}static clampBBox(e,t,n){const o=[(0,x.clamp)(e.x,t.x,n.x),(0,x.clamp)(e.y,t.y,n.y)],i=[(0,x.clamp)(e.width+e.x,t.x,n.x),(0,x.clamp)(e.height+e.y,t.y,n.y)];return{x:o[0],y:o[1],width:i[0]-o[0],height:i[1]-o[1]}}static getDOMBBox(e,t=!1){if(!e)return null;const n=e.getClientRects();if(0===n.length)return null;const o=e=>({x:e.x,y:e.y,width:e.width,height:e.height});return t?o(n[0]):Array.from(e.getClientRects()).map(o)}}const q={x:0,y:0,width:0,height:0};class J{static bbox(e){const t=Q(e);return(0,x.wrapArray)(t).map((e=>Object.assign(Object.assign({},q),e)))}constructor(e){this.options={},Object.assign(this.options,e)}get _source(){return this.options.source}get x(){return this.options.getX(this._source)}get y(){return this.options.getY(this._source)}get width(){return this.options.getWidth(this._source)}get height(){return this.options.getHeight(this._source)}}const Q=e=>{var t;if(!!e.from_name)return Z.getDOMBBox(null==(t=e.from_name.elementRef)?void 0:t.current);let n=e.type;switch("audioregion"===n&&(n=(0,j.VS)(j.vS)?"audioregion::ultra":"audioregion::old"),n){case"textrange":case"richtextregion":case"textarearegion":case"audioregion::old":case"paragraphs":case"timeseriesregion":{var o;const t=Z.getDOMBBox(e.getRegionElement()),n=null==(o=e.parent)||null==(o=o.mountNodeRef)?void 0:o.current;if("IFRAME"===(null==n?void 0:n.tagName)){const e=Z.getDOMBBox(n,!0);return(null==t?void 0:t.map((t=>Object.assign({},t,{x:t.x+e.x,y:t.y+e.y}))))||null}return t}case"audioregion::ultra":{var i;const t=e.bboxCoordsCanvas,n=null==(i=e.parent)||null==(i=i.stageRef)?void 0:i.current,o=Z.getDOMBBox(n,!0);return t?o?{x:o.x+t.left,y:o.y+t.top,width:t.right-t.left,height:t.bottom-t.top}:t:q}case"rectangleregion":case"ellipseregion":case"polygonregion":case"keypointregion":case"brushregion":{const t=e.bboxCoordsCanvas;return t?((e,t)=>{var n;if(null==(n=e.parent)||!n.stageRef)return null;const o=Z.getDOMBBox(e.parent.stageRef.content,!0),i=Z.clampBBox(Z.modifyBBoxCoords(t,e.parent.zoomOriginalCoords),{x:0,y:0},{x:e.parent.canvasSize.width,y:e.parent.canvasSize.height});return Object.assign({},i,{x:o.x+i.x,y:o.y+i.y})})(e,{x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top}):q}default:return console.warn(`Unknown region type: ${e.type}`),Object.assign({},q)}};class ee{constructor(e){this.params={},this._onUpdated=null,this.onChanged=()=>{var e;null==(e=this.onUpdated)||e.call(this)},Object.assign(this.params,e),this.params.watcher&&(this._watcher=new this.params.watcher(this.params.root,this.params.element,this.onChanged))}boundingBox(){return J.bbox(this.params.element)}onUpdate(e){this.onUpdated=e}destroy(){this.onUpdated=null}}class te{constructor(e,t,n){this.onUpdate=()=>{this.callback()},this.root=e,this.element=t.getRegionElement(),this.callback=n,this.handleUpdate()}handleResize(){window.addEventListener("resize",this.onUpdate)}handleUpdate(){this.element&&(this.observer=new MutationObserver(this.onUpdate),this.observer.observe(this.element,{attributes:!0}))}destroy(){window.removeEventListener("resize",this.onUpdate),this.observer.disconnect()}}const ne=e=>class{constructor(e,t,n){this.onUpdate=G((()=>{this.callback()}),10),this.root=e,this.element=t,this.callback=n,this.handleUpdate()}handleUpdate(){this.disposers=this._watchProperties(this.element,e,[])}destroy(){this.disposers.forEach((e=>e()))}_watchProperties(e,t,n){return t.reduce(((o,i)=>("string"!=typeof i?Object.keys(i).forEach((t=>{this._watchProperties(e[t],i[t],n)})):Array.isArray(e)?e.forEach((e=>this._watchProperties(e,t,n))):o.push((0,c.lB)(e,i,this.onUpdate,!0)),o)),n)}},oe={parent:["zoomScale","zoomingPositionX","zoomingPositionY","rotation","currentImage",...(0,j.VS)(j.v1)?["containerWidth","containerHeight","canvasSize"]:[]]},ie=e=>{if(!!e.from_name)return te;switch(e.type){case"richtextregion":case"paragraphs":return te;case"audioregion":return(0,j.VS)(j.vS)?ne(["bboxTriggers"]):e.getRegionElement?te:null;case"rectangleregion":return ne(["x","y","width","height","hidden",oe]);case"ellipseregion":return ne(["x","y","radiusX","radiusY","rotation","hidden",oe]);case"polygonregion":return ne(["hidden",{points:["x","y"]},oe]);case"keypointregion":return ne(["x","y","hidden",oe]);case"brushregion":return ne(["needsUpdate","hidden","touchesLength",oe]);case"timeseriesregion":return ne(["start","end",{parent:["zoomedRange"]}]);default:return null}},se=(e,t)=>new ee({root:t,element:e,watcher:ie(e)}),re=(e,t)=>{var n;const{x:o,y:i}=null!=(n=Z.getDOMBBox(t,!0))?n:{x:0,y:0};return e.boundingBox().map((e=>{const t=Z.padding(e,3);return Object.assign({},t,{x:t.x-o,y:t.y-i})}))},ae=({x1:e,y1:t,w1:n,x2:o,y2:i,w2:s,limit:r})=>{const a=e+.5*n,l=o+.5*s,d=Math.min(t,i)-r;return{x1:a,x2:l,y1:t,y2:i,l1:Math.min(d,t-r),l2:Math.min(d,i-r),toEnd:a<l}},le=({x1:e,y1:t,w1:n,h1:o,x2:i,y2:s,w2:r,h2:a,limit:l})=>{let d,c,u,h,g,m,p="left";if(Math.min(e,i)-l<0&&(p="right"),"left"===p){d=e,u=t+.5*o,c=i,h=s+.5*a;const n=Math.min(d,c)-l;g=Math.min(n,d-l),m=Math.min(n,c-l)}else{d=e+n,u=t+.5*o,c=i+r,h=s+.5*a;const p=Math.max(d,c)+l;g=Math.max(p,d+l),m=Math.max(p,c+l)}return{x1:d,x2:c,y1:u,y2:h,l1:g,l2:m,toEnd:u<h,renderingSide:p}},de=se,ce=(e,t)=>{var n;return{id:e.id,label:(0,x.wrapArray)(null!=(n=e.labels)?n:[]).join(", "),color:"#fa541c",direction:e.direction,start:se(e.startNode,t),end:se(e.endNode,t),onChange(e){const t=G(e,50);this.start.onUpdate(t),this.end.onUpdate(t)},destroy(){this.start.destroy(),this.end.destroy()}}},ue=({start:e,end:t,root:n})=>{const[o,i]=Z.closestRects(re(e,n),re(t,n));return{start:o,end:i}},he=(e,t)=>{const{x:n,y:o,width:i,height:s}=e,{x:r,y:a,width:l,height:d}=t,c=(({x1:e,y1:t,w1:n,x2:o,y2:i,w2:s})=>t!==i&&(e<=o&&o<=e+n||e<=o+s&&o+s<=e+n))({x1:n,y1:o,w1:i,x2:r,y2:a,w2:l}),u=(({x1:e,y1:t,x2:n,y2:o,l1:i,l2:s,toEnd:r,renderingSide:a},l)=>{const d="vertical"===l;let c,u,h,g,m,p,f,v,y,b,x,S,w;return d?(c=e,u=t,h=e,g=i+5,m=n+5*(r?-1:1),p=s,f=n,v=o,y=r?1:0,b=r?"5 -5":"-5 -5",x=r?"5 5":"-5 5",S=Math.min(e,n)+Math.abs(n-e)/2,w=i):d||"right"!==a?d||"left"!==a||(c=e,u=t,h=i+5,g=t,m=s,p=o+5*(r?-1:1),f=n,v=o,y=r?0:1,b=r?"-5 5":"-5 -5",x=r?"5 5":"5 -5",S=i,w=Math.min(t,o)+Math.abs(o-t)/2):(c=e,u=t,h=i-5,g=t,m=s,p=o+5*(r?-1:1),f=n,v=o,y=r?1:0,b=r?"5 5":"5 -5",x=r?"-5 5":"-5 -5",S=i,w=Math.min(t,o)+Math.abs(o-t)/2),[[`M ${c} ${u}`,`${h} ${g}`,`a 5 5 0 0 ${y} ${b}`,`L ${m} ${p}`,`a 5 5 0 0 ${y} ${x}`,`L ${f} ${v}`].join(" "),[S,w]]})((c?le:ae)({x1:n,y1:o,w1:i,h1:s,x2:r,y2:a,w2:l,h2:d,limit:15}),c?"horizontal":"vertical");return u},ge=re,me="container--gJBc5",pe="commentItem--aJS6d",fe="commentIcon--X3v6h",ve="commentIconBackground--EofOZ",ye="commentIconLines--uQaUg",be="_highlighting--qltMP",xe="_highlighted--Ksg1R",Se=()=>(0,A.jsxs)("g",{className:fe,children:[(0,A.jsx)("path",{className:ve,d:"M0 12C0 5.3726 5.3726 0 12 0C18.6274 0 24 5.3726 24 12C24 18.6274 18.6274 24 12 24H0V12Z"}),(0,A.jsx)("path",{className:ye,d:"M18 8V9.3333H6V8H18ZM6 16H12V14.6667H6V16ZM6 12.6667H18V11.3333H6V12.6667Z"})]}),we=(0,v.PA)((({comment:e,rootRef:t})=>{var n;const o=t.current,i=null==(n=e.regionRef)?void 0:n.overlayNode,s=!i,[r,a]=(0,m.useState)({}),l=(0,m.useCallback)((()=>{e.setHighlighted(!0)}),[e]),d=(0,m.useCallback)((()=>{e.setHighlighted(!1)}),[e]),c=(0,m.useMemo)((()=>i&&o?de(i,o):null),[i,o]),{shapeBBox:u,positionStyle:h}=(0,m.useMemo)((()=>{const e=c&&o?ge(c,o)[0]:{x:0,y:0,width:0,height:0};return{shapeBBox:e,positionStyle:{transform:`translate(${e.x+e.width-3-4}px, ${e.y-24+3+4}px)`}}}),[c,o,r]);if((0,m.useEffect)((()=>(null==c||c.onUpdate((()=>{a({})})),()=>{null==c||c.destroy()})),[c]),!o||!i||s)return null;if(u.width<1||u.height<1)return null;const g=[pe];return e.isHighlighted&&g.push(xe),(0,A.jsx)("g",{className:g.join(" "),style:h,onMouseEnter:l,onMouseLeave:d,onClick:e.scrollIntoView,children:(0,A.jsx)(Se,{})})})),ke=e=>{const{isClassificationTag:t}=e.from_name,n=e.area.classification,o=e.area.selected;return t&&(n||o)},Ce=(0,v.PA)((({result:e,rootRef:t})=>{const n=t.current,o=e.area,i=!o||o.hidden,[s,r]=(0,m.useState)({}),[a,l]=(0,m.useState)(!1),d=(0,m.useMemo)((()=>e&&n?de(e,n):null),[e,n]),c=(0,m.useMemo)((()=>d&&n?ge(d,n)[0]:{x:0,y:0,width:0,height:0}),[d,n,s]);if((0,m.useEffect)((()=>(null==d||d.onUpdate((()=>{r({})})),()=>{null==d||d.destroy()})),[d]),!n||!o||i)return null;if(c.width<1||c.height<1)return null;const u={pointerEvents:"all",stroke:"var(--grape_600)",strokeDasharray:a?void 0:"4 2",cursor:"crosshair"};return(0,A.jsx)("rect",Object.assign({},c,{rx:3,ry:3,style:u,onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),stroke:"red",strokeWidth:1,fill:"none",onClick:()=>{e.annotation.addLinkedResult(e),e.annotation.stopLinkingMode()}}))})),je=(0,v.PA)((({annotation:e,commentStore:t})=>{var n;const{overlayComments:o}=t||{},i=(0,m.useRef)(),[s,r]=(0,m.useState)(T()),a=N();(0,m.useEffect)((()=>{(async()=>{await t.listComments({mounted:a,suppressClearComments:t.isRelevantList})})()}),[null==(n=t.annotation)?void 0:n.id]);const l=(0,m.useMemo)((()=>{let e;return new X((t=>{cancelAnimationFrame(e),e=requestAnimationFrame((()=>{r(T())}))}))}),[]);(0,m.useEffect)((()=>()=>{null==l||l.disconnect()}),[]);const d=(0,m.useCallback)((e=>{const t=e||void 0;e?(null==l||l.observe(e),null==l||l.observe(document.body)):i.current&&(null==l||l.unobserve(i.current),null==l||l.unobserve(document.body)),i.current=t}),[]);if(!o)return null;const c=[me];return null!=t&&t.isHighlighting&&c.push(be),(0,A.jsx)("svg",{className:c.join(" "),ref:d,xmlns:"http://www.w3.org/2000/svg",children:(0,A.jsxs)("g",{children:[e.linkingMode===W&&e.results.filter(ke).map((e=>(0,A.jsx)(Ce,{result:e,rootRef:i},e.id))),o.map((e=>{const{id:t}=e;return(0,A.jsx)(we,{comment:e,rootRef:i},t)}))]},s)})})),Re=(0,m.memo)((0,v.PA)((({tags:e,children:t})=>Array.from(e.values()).every((e=>{var t;return!!(0,u._n)(e)&&(null==(t=null==e?void 0:e.isReady)||t)}),!0)?(0,A.jsx)(A.Fragment,{children:t}):null))),_e=(0,v.PA)((e=>{const{annotation:t}=e;return(0,A.jsx)(Re,{tags:t.names,children:(0,A.jsx)(je,Object.assign({},e))})}));var Te=n(39067);const Ae="error--SXGAh";var Ke=n(84411);const Ee=({error:e})=>{if("string"==typeof e)return(0,A.jsx)("div",{className:Ae,dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(e)}});const t=e instanceof Error?e.message:e;return(0,A.jsx)("div",{className:Ae,children:t})},Pe=(0,v.WQ)("store")((0,v.PA)((({store:e,errors:t})=>(0,A.jsx)("div",{className:"lsf-errors",children:t.map(((t,n)=>(0,A.jsx)(Ee,{error:(0,u._$)(e).messages[t.error](t)},`error-${n}`)))}))));Pe.propTypes={errors:Te.PropTypes.array.isRequired};const Me={range:(e=0,t=1)=>u.gK.custom({name:`Range(${e}..${t})`,fromSnapshot:e=>Number.parseFloat(e),toSnapshot:e=>e.toString(),isTargetType(n){const o=Number.parseFloat(n);return e<=o&&o<=t},getValidationMessage(n){return this.isTargetType(n)?"":`Value ${n} is outside of range ${e}..${t}.`}}),color:u.gK.custom({name:"CSSColor",fromSnapshot:e=>String(e),toSnapshot:e=>e.toString(),isTargetType(e){const t=(new Option).style;return t.color=e,""!==t.color},getValidationMessage(e){return this.isTargetType(e)?"":`Value ${e} doesn't appear to be a valid HEX color.`}})};function De(e){return t=>u.gK.maybeNull(u.gK.array(e(t)))}function Oe(e,t){return n=>u.gK.union({dispatcher:o=>{if(n.find((e=>o.type===e)))return e(o.type);throw Error(t+o.type)}})}const Ie=Oe(b.getModelByTag,"Not expecting tag: ");const Le={unionArray:function(e){const t=u.gK.maybeNull(u.gK.array(Ie(e)));return t.value=e,t},allModelsTypes:function(){const e=[{dispatcher:e=>{if(!e)return u.gK.literal(void 0);if(b.tags.includes(e.type))return b.getModelByTag(e.type);throw Error(`Not expecting tag: ${e.type}`)}},b.modelsArr()],t=[].concat.apply([],e);return u.gK.union.apply(null,t)},unionTag:function(e){return u.gK.maybeNull(u.gK.enumeration("unionTag",e))},tagsTypes:function(e){const t=u.gK.frozen(e.map((e=>e.toLowerCase())));return t.describe=()=>`(${e.join("|")})`,t.value=e,t},isType:function(e,t){const n=(0,u.Pw)(e);for(const e of t)if(n===e)return!0;return!1},getParentOfTypeString:function(e,t){let n=(0,u.PA)(e);for(Array.isArray(t)||(t=[t]);n;){const e=(0,u.Pw)(n).name;if(t.find((t=>t===e)))return n;n=(0,u.jX)(n)?null:(0,u.PA)(n)}return null},getParentTagOfTypeString:function(e,t){let n=(0,u.PA)(e);for(Array.isArray(t)||(t=[t]);n;){const e=n.type;if(t.find((t=>t===e)))return n;n=(0,u.jX)(n)?null:(0,u.PA)(n)}return null},tagsArray:De(Ie),toolsArray:De(Oe(b.getTool,"Not expecting tool: "))},Ne=u.gK.model("AnnotationMixin",{}).views((e=>({get annotation(){var t;if((0,j.VS)(j.F5)&&!window.STORE_INIT_OK&&console.error("LSF: annotation accessed before store is initialized",e),!(0,u._n)(e))return null;if((0,j.VS)(j.cE)){var n;const t=(0,u.Zn)(e);return t===e?e.control?e.control.annotation:e.obj?e.obj.annotation:null:null!=(n=t.annotationStore)&&n.selectedHistory?t.annotationStore.selectedHistory:Le.getParentOfTypeString(e,"Annotation")}const o=e.annotationStore;return null!=(t=null==o?void 0:o.selectedHistory)?t:null==o?void 0:o.selected},get annotationStore(){const t=(0,u.Zn)(e);return t===e?e.control?(0,u.Zn)(e.control).annotationStore:e.obj?(0,u.Zn)(e.obj).annotationStore:null:t.annotationStore}}))),ze=u.gK.model({}).volatile((()=>({_isReady:!0}))).views((e=>({get isReady(){return e._isReady}}))).actions((e=>({setReady(t){e._isReady=t}}))),Ve=ze,He=ze.views((e=>({get isReady(){var t;return e._isReady&&!(null!=(t=e.regs)&&t.filter((e=>!e.isReady)).length)}})));var Be=n(41880),Fe=n.n(Be);const We={csv(e,t={}){var n;const o=!t.headless,{data:i,meta:{fields:s}}=Fe().parse(e,{delimiter:t.separator,header:o}),{column:r=(o?s[0]:0)}=t,a=i[0];let l=a[r];var d;void 0===l&&(l=a[null!=(d=s[r])?d:s[0]]);return String(null!=(n=l)?n:"")}},$e=u.gK.model({resolver:u.gK.maybeNull(u.gK.string)}).actions((e=>({updateLocalValue(t){e._value=t},updateValue(t){var n,o;e._value=k(e.value,null!=(n=null==t||null==(o=t.task)?void 0:o.dataObj)?n:{})},resolveValue:(0,u.L3)((function*(t){if(!e.resolver)return t;const{type:n,options:o}=C(e.resolver);if(!Object.prototype.hasOwnProperty.call(We,n))return console.error(`Resolver "${null!=n?n:e.resolver}" looks unfamiliar`),t;const i=yield fetch(t),s=yield i.text();return We[n](s,o)}))}))),Ue=$e;class Ye{constructor(){this.syncTargets=new Map,this.locked=null,this.audioTags=0}register(e){this.syncTargets.set(e.name,e),"audio"===e.type&&(this.audioTags+=1)}unregister(e){this.syncTargets.delete(e.name),"audio"===e.type&&(this.audioTags-=1)}sync(e,t,n){if(this.locked&&this.locked!==n||console.log("SYNC",{event:t,locked:this.locked,data:e,origin:n}),this.locked&&this.locked!==n)return!1;this.locked||setTimeout((()=>this.locked=null),100),this.locked=n;for(const o of this.syncTargets.values())n!==o.name&&o.syncReceive(e,t);return!0}}const Xe={managers:new Map,get(e,t){let n=this.managers.get(e);return!n&&t&&(n=this.managers.get(t)),n||(n=new Ye,this.managers.set(e,n)),n}},Ge=u.gK.model("SyncableMixin",{name:u.gK.string,type:u.gK.string,sync:u.gK.optional(u.gK.string,"")}).volatile((()=>({syncHandlers:new Map,syncManager:null}))).actions((()=>({syncMuted(e){}}))).actions((e=>({afterCreate(){e.sync&&(e.syncManager=Xe.get(e.sync,e.name),e.syncManager.register(e),e.registerSyncHandlers())},registerSyncHandlers(){},syncSend(t,n){if(!e.sync)return;e.syncManager.sync(t,n,e.name)&&"play"===n&&e.syncMuted("audio"!==e.type&&e.syncManager.audioTags>0)},syncReceive(t,n){const o=e.syncHandlers.get(n);"play"===n&&e.syncMuted("audio"!==e.type),o&&o(t,n)},destroy(){e.syncManager.unregister(e)}}))),Ze=u.gK.model({meta:u.gK.frozen({})}).actions((e=>({setMetaText(t){if(t)e.meta=Object.assign({},e.meta,{text:[t]});else{const t=Object.assign({},e.meta);delete t.text,e.meta=t}}}))).actions((e=>({deleteMetaText(){e.setMetaText("")}}))),qe=u.gK.model("ReadOnlyControlMixin",{}).views((e=>({isReadOnly(){var t,n;return(null==(t=e.result)?void 0:t.isReadOnly())||(null==(n=e.annotation)?void 0:n.isReadOnly())}}))),Je=u.gK.model("ReadOnlyRegionMixin",{readonly:u.gK.optional(u.gK.boolean,!1)}).views((e=>({isReadOnly(){var t;return!!(0,u._n)(e)&&(e.locked||e.readonly||e.annotation.isReadOnly()||e.parent&&((null==e.parent.isReadOnly?void 0:e.parent.isReadOnly())||(null==(t=e.parent.result)||null==t.isReadOnly?void 0:t.isReadOnly())))}})));var Qe=n(50494),et=n(18094);const tt=100,nt=100,ot="edge",it="center",st=(0,v.PA)((0,m.forwardRef)((({imageEntity:e,imageTransform:t,updateImageSize:n,usedValue:o,size:i,overlay:s},r)=>{const a=(0,m.useMemo)((()=>({width:1===i.width?"100%":i.width,height:1===i.height?"auto":i.height})),[i]),l=(0,m.useCallback)((t=>{n(t),e.setImageLoaded(!0)}),[n,e]);return(0,A.jsxs)(Qe.eB,{name:"image",style:a,children:[s,(0,A.jsx)(rt,{downloading:e.downloading,progress:e.progress,error:e.error,src:e.src,usedValue:o}),e.downloaded?(0,A.jsx)(lt,{alt:"image",ref:r,src:e.currentSrc,onLoad:l,isLoaded:e.imageLoaded,imageTransform:t}):null]})}))),rt=(0,v.PA)((({downloading:e,progress:t,error:n,src:o,usedValue:i})=>e?(0,A.jsxs)(Qe.eB,{name:"image-progress",children:[(0,A.jsx)(Qe.Sl,{name:"message",children:"Downloading image"}),(0,A.jsx)(Qe.Sl,{tag:"progress",name:"bar",value:t,min:"0",max:1,step:1e-4})]}):n?(0,A.jsx)(dt,{src:o,value:i}):null)),at={};(0,j.VS)(j.xS)&&(at.crossOrigin="anonymous");const lt=(0,v.PA)((0,m.forwardRef)((({src:e,onLoad:t,imageTransform:n,isLoaded:o},i)=>{const s=(0,m.useMemo)((()=>{const e=null!=n?n:{};return Object.assign({},e,{maxWidth:"unset",visibility:o?"visible":"hidden"})}),[n,o]);return(0,A.jsx)("img",Object.assign({},at,{ref:i,alt:"image",src:e,onLoad:t,style:s}))}))),dt=({src:e,value:t})=>{const n=(0,m.useMemo)((()=>et.A.ERR_LOADING_HTTP({url:e,error:"",attr:t})),[e]);return(0,A.jsx)(Ee,{error:n})},ct=u.gK.model({pid:u.gK.optional(u.gK.string,T),score:u.gK.maybeNull(u.gK.number),filtered:u.gK.optional(u.gK.boolean,!1),parentID:u.gK.optional(u.gK.string,""),fromSuggestion:!1,dynamic:!1,origin:u.gK.optional(u.gK.enumeration(["prediction","prediction-changed","manual"]),"manual"),item_index:u.gK.maybeNull(u.gK.number)}).volatile((()=>({_highlighted:!1,hidden:!1,locked:!1,isDrawing:!1,perRegionFocusRequest:null,shapeRef:null,drawingTimeout:null}))).views((e=>({get perRegionStates(){const t=e.states;return t&&t.filter((e=>!0===e.perregion))},get store(){return(0,u.Zn)(e)},get parent(){return(0,u.PA)(e)},get editable(){throw new Error("Not implemented")},get isCompleted(){return!e.isDrawing},get highlighted(){return e._highlighted},get inSelection(){var t;return null==(t=e.annotation)?void 0:t.regionStore.isSelected(e)},get isReady(){return!0},get currentImageEntity(){var t;return e.parent.findImageEntity(null!=(t=e.item_index)?t:0)},getConnectedDynamicRegions(t){var n;const{regions:o=[]}=(null==(n=(0,u.Zn)(e).annotationStore)?void 0:n.selected)||{},{type:i,labelName:s}=e;return o.filter((n=>{var o,r;if(t&&n===e)return!1;return(!e.supportSuggestions||e.dynamic)&&n.type===i&&n.labelName===s&&(null==(o=n.results)||null==(o=o[0])?void 0:o.to_name)===(null==(r=e.results)||null==(r=r[0])?void 0:r.to_name)}))},get isRealRegion(){var t;return null==(t=e.annotation)||null==(t=t.areas)?void 0:t.has(e.id)},get shouldNotifyDrawingFinished(){if(!e.isRealRegion)return!1;if(e.annotation.isSuggestionsAccepting)return!1;const t=!e.supportSuggestions||e.dynamic&&!e.fromSuggestion;return e.results.some((e=>e.from_name.smartEnabled))&&t}}))).actions((e=>({setParentID(t){e.parentID=t},setDrawing(t){e.isDrawing=t},setShapeRef(t){t&&(e.shapeRef=t)},setItemIndex(t){if(!(0,x.isDefined)(t))throw new Error("Index must be provided for",e);e.item_index=t},beforeDestroy(){if(e.isRealRegion)return e.beforeDestroyArea()},beforeDestroyArea(){e.notifyDrawingFinished({destroy:!0})},setLocked(t){e.locked=t instanceof Function?t(e.locked):t},makeDynamic(){e.dynamic=!0},convertXToPerc:t=>t*tt/e.currentImageEntity.stageWidth,convertYToPerc:t=>t*nt/e.currentImageEntity.stageHeight,convertHDimensionToPerc:t=>t*(e.scaleX||1)*tt/e.currentImageEntity.stageWidth,convertVDimensionToPerc:t=>t*(e.scaleY||1)*nt/e.currentImageEntity.stageHeight,updateAppearenceFromState(){},serialize(){console.error("Region class needs to implement serialize")},selectRegion(){},unselectRegion(e=!1){console.log("UNSELECT REGION","you should not be here")},afterUnselectRegion(){},onClickRegion(t){const n=e.annotation;(e.isReadOnly()||!e.isDrawing&&!n.isDrawing)&&(!e.isReadOnly()&&n.isLinkingMode?(n.addLinkedRegion(e),n.stopLinkingMode(),n.regionStore.unselectAll()):e._selectArea((null==t?void 0:t.ctrlKey)||(null==t?void 0:t.metaKey)))},_selectArea(t=!1){this.cancelPerRegionFocus();const n=e.annotation;if(t)n.toggleRegionSelection(e);else{!e.selected?n.selectArea(e):n.unselectAll()}},requestPerRegionFocus(){e.perRegionFocusRequest=Date.now()},cancelPerRegionFocus(){e.perRegionFocusRequest=null},setHighlight(t){e._highlighted=t},toggleHighlight(){e.setHighlight(!e._highlighted)},toggleFiltered(t){e.filtered=!e.filtered,e.toggleHidden(t,!0),t&&t.stopPropagation()},toggleHidden(t,n=!1){n||(e.filtered=!1),e.hidden=!e.hidden,t&&t.stopPropagation()},updateOriginOnEdit(){"prediction"===e.origin&&(e.origin="prediction-changed")},notifyDrawingFinished({destroy:t=!1}={}){if(e.updateOriginOnEdit(),e.shouldNotifyDrawingFinished&&(clearTimeout(e.drawingTimeout),!1===e.isDrawing)){const n=(0,u.Pw)(e).name.match(/brush/i)?1200:0,o=(0,u._$)(e);e.drawingTimeout=setTimeout((()=>{const n=e.getConnectedDynamicRegions(t);o.events.invoke("regionFinishedDrawing",e,n)}),n)}}}))),ut=u.gK.compose(ct,Je,Ne),ht=u.gK.model("Result",{id:u.gK.optional(u.gK.identifier,T),score:u.gK.maybeNull(u.gK.number),readonly:u.gK.optional(u.gK.boolean,!1),from_name:u.gK.late((()=>u.gK.reference(u.gK.union(...b.modelsArr())))),to_name:u.gK.late((()=>u.gK.reference(u.gK.union(...b.objectTypes())))),type:u.gK.enumeration(["labels","hypertextlabels","paragraphlabels","rectangle","keypoint","polygon","brush","ellipse","magicwand","rectanglelabels","keypointlabels","polygonlabels","brushlabels","ellipselabels","timeserieslabels","timelinelabels","choices","datetime","number","taxonomy","textarea","rating","pairwise","videorectangle","ranker"]),value:u.gK.model({ranker:u.gK.union(u.gK.array(u.gK.string),u.gK.frozen(),u.gK.null),datetime:u.gK.maybe(u.gK.string),number:u.gK.maybe(u.gK.number),rating:u.gK.maybe(u.gK.number),item_index:u.gK.maybeNull(u.gK.number),text:u.gK.maybe(u.gK.union(u.gK.string,u.gK.array(u.gK.string))),choices:u.gK.maybe(u.gK.array(u.gK.union(u.gK.string,u.gK.array(u.gK.string)))),selected:u.gK.maybe(u.gK.enumeration(["left","right"])),labels:u.gK.maybe(u.gK.array(u.gK.string)),htmllabels:u.gK.maybe(u.gK.array(u.gK.string)),hypertextlabels:u.gK.maybe(u.gK.array(u.gK.string)),paragraphlabels:u.gK.maybe(u.gK.array(u.gK.string)),rectanglelabels:u.gK.maybe(u.gK.array(u.gK.string)),keypointlabels:u.gK.maybe(u.gK.array(u.gK.string)),polygonlabels:u.gK.maybe(u.gK.array(u.gK.string)),ellipselabels:u.gK.maybe(u.gK.array(u.gK.string)),brushlabels:u.gK.maybe(u.gK.array(u.gK.string)),timeserieslabels:u.gK.maybe(u.gK.array(u.gK.string)),timelinelabels:u.gK.maybe(u.gK.array(u.gK.string)),taxonomy:u.gK.frozen(),sequence:u.gK.frozen()}),meta:u.gK.frozen()}).views((e=>({get perRegionStates(){const t=e.states;return t&&t.filter((e=>!0===e.perregion))},get store(){return(0,u.Zn)(e)},get area(){return(0,u.PA)(e,2)},get mainValue(){return e.value[e.from_name.valueType]},mergeMainValue(t){var n,o,i;t=null!=(n=t)&&n.toJSON?t.toJSON():t;const s=null!=(o=e.mainValue)&&null!=o.toJSON&&o.toJSON()?null==(i=e.mainValue)||null==i.toJSON?void 0:i.toJSON():e.mainValue;return typeof t!=typeof s?null:e.type.endsWith("labels")?t.filter((e=>s.includes(e))):t===s?t:null},get hasValue(){const t=e.mainValue;return!!(0,x.isDefined)(t)&&(!Array.isArray(t)||t.length>0)},get editable(){throw new Error("Not implemented")},isReadOnly:()=>e.readonly||e.area.isReadOnly(),isSelfReadOnly:()=>e.readonly,getSelectedString(t=" "){var n;return(null==(n=e.mainValue)?void 0:n.join(t))||""},get selectedLabels(){var t,n,o;return 0===(null==(t=e.mainValue)?void 0:t.length)&&e.from_name.allowempty?e.from_name.findLabel(null):null!=(n=null==(o=e.mainValue)?void 0:o.map((t=>e.from_name.findLabel(t))).filter(Boolean))?n:[]},get canBeSubmitted(){const t=e.from_name;if(t.perregion){const n=t.whenlabelvalue;if(n&&!e.area.hasLabel(n))return!1}const n=e=>e.map((e=>Array.isArray(e)?e.at(-1):e)),o=()=>{var o,i;const s=t.whentagname,r=null!=(o=null==(i=t.whenchoicevalue)?void 0:i.split(","))?o:null,a=e.annotation.results.filter((t=>["choices","taxonomy"].includes(t.type)&&t!==e));if(s){const t=a.find((t=>t.from_name.name===s&&(!t.from_name.perregion||t.area===e.area)));if(!t)return!1;if(r&&!r.some((e=>n(t.mainValue).some((n=>t.from_name.selectedChoicesMatch(e,n))))))return!1}else{if(!a.length)return!1;if(r&&!a.some((e=>r.some((t=>n(e.mainValue).some((n=>e.from_name.selectedChoicesMatch(t,n))))))))return!1}return!0};return t.perregion&&"choice-selected"===t.visiblewhen?o():"choice-unselected"===t.visiblewhen?!o():!(!t.perregion&&function(e,t){let n=e;for(;n;){if(n.visiblewhen===t)return n;try{if(n=(0,u.PA)(n),!n)break}catch(e){break}}return null}(t,"choice-selected"))||!1!==t.isVisible&&o()},get tag(){const t=e.mainValue;return t&&t.length&&e.from_name.findLabel?e.from_name.findLabel(t[0]):null},get style(){var t;if(!e.tag)return null;const n=e.tag.background||(null==(t=e.tag.parent)?void 0:t.fillcolor);if(!n)return null;const o=e.tag.background||e.tag.parent.strokecolor,{strokewidth:i,fillopacity:s,opacity:r}=e.tag.parent;return{strokecolor:o,strokewidth:i,fillcolor:n,fillopacity:s,opacity:r}},get emptyStyle(){const t=e.from_name.emptyLabel;if(!t)return null;const n=t.background||t.parent.fillcolor;if(!n)return null;const o=t.background||t.parent.strokecolor,{strokewidth:i,fillopacity:s,opacity:r}=t.parent;return{strokecolor:o,strokewidth:i,fillcolor:n,fillopacity:s,opacity:r}},get controlStyle(){if(!e.from_name)return null;const{fillcolor:t,strokecolor:n,strokewidth:o,fillopacity:i,opacity:s}=e.from_name;return{strokecolor:n,strokewidth:o,fillcolor:t,fillopacity:i,opacity:s}},getRegionElement(){var t;return null==(t=e.from_name)||null==t.getRegionElement?void 0:t.getRegionElement()}}))).volatile((()=>({pid:"",selected:!1}))).actions((e=>({setValue(t){e.value[e.from_name.valueType]=t},afterCreate(){e.pid=e.id},afterAttach(){},setParentID(t){e.parentID=t},setMetaValue(t,n){e.meta=Object.assign({},e.meta,{[t]:n})},updateAppearenceFromState(){},serialize(t){var n;const o=(0,u.dV)(e),{type:i,score:s,value:r,meta:a}=o,{valueType:l}=e.from_name,d=e.area?e.area.serialize(t):{},c=null==(n=e.area)?void 0:n.cleanId,h=L.cleanUpId(o.from_name),g=L.cleanUpId(o.to_name);if(!d)return null;if(!e.canBeSubmitted)return null;if((0,x.isDefined)(d.value)||(d.value={}),e.to_name.mergeLabelsAndResults){var m;if("labels"===i)return null;i.endsWith("labels")||null==(m=e.area)||null==(m=m.labels)||!m.length||e.from_name.perregion||(d.value.labels=e.area.labels)}return(a||e.area.meta&&Object.keys(e.area.meta).length)&&(d.meta=Object.assign({},a,e.area.meta)),e.area.parentID&&(d.parentID=e.area.parentID.replace(/#.*/,"")),Object.assign(d,{id:c,from_name:h,to_name:g,type:i,origin:e.area.origin}),(0,x.isDefined)(r[l])&&Object.assign(d.value,{[l]:r[l]}),"number"==typeof s&&(d.score=s),e.isSelfReadOnly()&&(d.readonly=!0),(0,j.VS)(j.gF)&&(0,x.isDefined)(e.area.item_index)&&(d.item_index=e.area.item_index),d},deleteRegion(){e.annotation.isReadOnly()||(e.unselectRegion(),e.annotation.relationStore.deleteNodeRelation(e),"polygonregion"===e.type&&e.destroyRegion(),e.annotation.regionStore.deleteRegion(e),e.annotation.deleteRegion(e))},setHighlight(t){e._highlighted=t},toggleHighlight(){e.setHighlight(!e._highlighted)},toggleHidden(){e.hidden=!e.hidden}}))),gt=u.gK.compose("Result",ht,Ne),mt={TAG:"tag",REGION_LIST:"region-list"},pt=u.gK.model({perregion:u.gK.optional(u.gK.boolean,!1),whenlabelvalue:u.gK.maybeNull(u.gK.string),displaymode:u.gK.optional(u.gK.enumeration(Object.values(mt)),mt.TAG)}).extend((e=>{if(!0!==e.isClassificationTag)throw new Error("The PerRegionMixin mixin should be used only for classification control-tags");return{}})).volatile((()=>({focusable:!1}))).views((e=>({get perRegionArea(){return e.perregion?e.annotation.highlightedNode:null},get _perRegionResult(){const t=e.perRegionArea;return t?e.annotation.results.find((n=>n.from_name===e&&n.area===t)):null},perRegionVisible(){if(!e.perregion)return!0;const t=e.perRegionArea;return!!t&&(t.parent.name===e.toname&&(null===e.whenlabelvalue||void 0===e.whenlabelvalue||t.hasLabel(e.whenlabelvalue)))}}))).actions((e=>({_validatePerRegion(){const t=e.toNameTag;for(const o of t.allRegs){var n;const t=null==(n=o.results.find((t=>t.from_name===e)))?void 0:n.mainValue;if(!e.validateValue(t))return e.annotation.selectArea(o),!1}return!0},createPerRegionResult(){var t;null==(t=e.perRegionArea)||t.setValue(e)}})));let ft=1;const vt=u.gK.model({id:u.gK.optional(u.gK.identifier,T),ouid:u.gK.optional(u.gK.number,(()=>ft++)),results:u.gK.array(gt),parentID:u.gK.maybeNull(u.gK.string)}).views((e=>({get cleanId(){return e.id.replace(/#.*/,"")},get labelings(){return e.results.filter((e=>e.from_name.isLabeling))},get labeling(){if((0,u._n)(e))return e.results.find((e=>e.from_name.isLabeling&&e.hasValue))},get emptyLabel(){var t;return null==(t=e.results.find((e=>{var t;return null==(t=e.from_name)?void 0:t.emptyLabel})))||null==(t=t.from_name)?void 0:t.emptyLabel},get texting(){return(0,u._n)(e)&&e.results.find((e=>"textarea"===e.type&&e.hasValue))},get tag(){var t;return null==(t=e.labeling)?void 0:t.from_name},hasLabel(t){var n;const o=null==(n=e.labeling)?void 0:n.mainValue;return!(!o||!t)&&(!!o.includes(t)||!!t.includes(",")&&t.split(",").some((e=>o.includes(e))))},get perRegionTags(){var t;return(null==(t=e.annotation.toNames.get(e.object.name))?void 0:t.filter((e=>e.perregion)))||[]},get labelingTags(){var t;return(0,j.VS)(j.um)&&(null==(t=e.annotation.toNames.get(e.object.name))?void 0:t.filter((e=>e.classification&&e.isLabeling)))||[]},get perRegionDescControls(){return e.perRegionTags.filter((e=>e.displaymode===mt.REGION_LIST))},get perRegionFocusTarget(){return e.perRegionTags.find((e=>!1!==e.isVisible&&e.focusable))},get labelName(){var t,n;if((0,u._n)(e))return(null==(t=e.labeling)||null==(t=t.mainValue)?void 0:t[0])||(null==(n=e.emptyLabel)?void 0:n._value)},get labels(){var t,n;return Array.from(null!=(t=null==(n=e.labeling)?void 0:n.mainValue)?t:[])},getLabelText(t){var n;const o=e.region_index,i=e.labeling,s=null==(n=e.texting)||null==(n=n.mainValue)||null==(n=n[0])?void 0:n.replace(/\n\r|\n/," "),r=null==i?void 0:i.getSelectedString(t),a=[];return o&&a.push(String(o)),r&&a.push(r),s&&a.push(s),a.join(": ")},get parent(){if((0,u._n)(e))return e.object},get style(){if(!(0,u._n)(e))return;const t=e.results.find((e=>e.style));if(t&&t.style)return t.style;const n=e.results.find((e=>e.emptyStyle));if(n&&n.emptyStyle)return n.emptyStyle;const o=e.results.find((t=>e.type.startsWith(t.type)));return o&&o.controlStyle},get selected(){var t;return(null==(t=e.annotation)?void 0:t.highlightedNode)===e},getOneColor:()=>(e.style||z.l).fillcolor,get highlighted(){var t;return null!=(t=e.parent)&&null!=(t=t.selectionArea)&&t.isActive?e.isInSelectionArea:e._highlighted},get isInSelectionArea(){var t;return!((0,j.VS)(j.q$)&&e.hidden||null==(t=e.parent)||null==(t=t.selectionArea)||!t.isActive)&&e.parent.selectionArea.intersectsBbox(e.bboxCoords)},get supportSuggestions(){return e.object.supportSuggestions},get region_index(){var t;return e.isRealRegion&&(null==(t=e.annotation)?void 0:t.regionStore.regionIndexMap[e.id])||null}}))).actions((e=>({beforeDestroy(){var t;e.results.forEach((e=>(0,u.zr)(e))),null==(t=e.annotation)||null==t.updateAppearenceFromState||t.updateAppearenceFromState()},setSelected(t){e.selected=t},deleteRegion(){e.annotation.isReadOnly()||e.isReadOnly()||(e.selected&&e.annotation.unselectAll(!0),e.destroyRegion&&e.destroyRegion(),e.annotation.deleteRegion(e))},addResult(t){e.results.push(t)},applyAdditionalDataFromResult(e){},removeResult(t){const n=e.results.indexOf(t);n<0||(e.results.splice(n,1),(0,u.zr)(t),e.results.length||e.annotation.deleteArea(e))},setValue(t){const n=e.results.find((e=>e.from_name===t)),o=t.selectedValues();n?t.holdsState?n.setValue(o):e.removeResult(n):e.results.push({area:e,from_name:t,to_name:e.object,type:t.resultType,value:{[t.valueType]:o}}),e.updateAppearenceFromState&&e.updateAppearenceFromState()}}))),yt=u.gK.compose("AreaMixin",vt,Je);var bt=n(72902),xt=n(75696),St=n.n(xt);const wt=(()=>{const e={};return e.floodFill=(e,t,n,o,i)=>{let s,r,a,l,d,c,u,h,g,m;const p=e.data,f=e.width,v=e.height,y=e.bytes;let b=-1,x=f+1,S=-1,w=v+1,k=n*f+t;const C=new Uint8Array(f*v),j=new Uint8Array(i||f*v);if(1===j[k])return null;k*=y;const R=[p[k],p[k+1],p[k+2],p[k+3]],_=[{y:n,left:t-1,right:t+1,dir:1}];do{for(l=_.shift(),m=!1,r=l.left+1;r<l.right;r++)if(u=l.y*f,k=(u+r)*y,1!==j[u+r]&&(s=p[k]-R[0],!(s>o||s<-o||(s=p[k+1]-R[1],s>o||s<-o||(s=p[k+2]-R[2],s>o||s<-o))))){for(m=!0,C[u+r]=1,j[u+r]=1,c=r-1;!(!(c>-1&&(h=u+c,k=h*y,1!==j[h]))||(s=p[k]-R[0],s>o||s<-o)||(s=p[k+1]-R[1],s>o||s<-o)||(s=p[k+2]-R[2],s>o||s<-o));)C[h]=1,j[h]=1,c--;for(d=r+1;!(!(d<f&&(g=u+d,k=g*y,1!==j[g]))||(s=p[k]-R[0],s>o||s<-o)||(s=p[k+1]-R[1],s>o||s<-o)||(s=p[k+2]-R[2],s>o||s<-o));)C[g]=1,j[g]=1,d++;c<x&&(x=c+1),d>b&&(b=d-1),a=l.y-l.dir,a>=0&&a<v&&(c<l.left&&_.push({y:a,left:c,right:l.left,dir:-l.dir}),l.right<d&&_.push({y:a,left:l.right,right:d,dir:-l.dir})),a=l.y+l.dir,a>=0&&a<v&&c<d&&_.push({y:a,left:c,right:d,dir:l.dir})}m&&(l.y<w&&(w=l.y),l.y>S&&(S=l.y))}while(_.length>0);return{data:C,width:e.width,height:e.height,bounds:{minX:x,minY:w,maxX:b,maxY:S}}},e.gaussBlur=(e,t)=>{let n,o,i,s,r,a,l,d;const c=2*t+1,u=t*t,h=new Float32Array(c);let g=0;const m=e.width,p=e.height,f=e.data,v=e.bounds.minX,y=e.bounds.maxX,b=e.bounds.minY,x=e.bounds.maxY;for(n=0;n<t;n++){const e=(t-n)*(t-n),o=Math.exp(-e/(2*u))/(2*Math.PI*u);h[t+n]=h[t-n]=o,g+=2*o}for(n=0;n<c;n++)h[n]/=g;const S=new Uint8Array(m*p),w=t+m,k=t+p;for(r=b;r<x+1;r++)for(s=v;s<y+1;s++){for(a=0,o=r*m+s,l=t-s>0?t-s:0,d=w-s<c?w-s:c,i=o-t,n=l;n<d;n++)a+=f[i+n]*h[n];for(l=t-r>0?t-r:0,d=k-r<c?k-r:c,i=o-t*m,n=l;n<d;n++)a+=f[i+n*m]*h[n];S[o]=a>.5?1:0}return{data:S,width:m,height:p,bounds:{minX:v,minY:b,maxX:y,maxY:x}}},e.gaussBlurOnlyBorder=(e,t,n)=>{const o=function(e,t,n){let o,i,s,r,a,l,d;const c=e.width,u=e.height,h=e.data,g=new Uint8Array(h),m=e.bounds.minX,p=e.bounds.maxX,f=e.bounds.minY,v=e.bounds.maxY;let y=c*u;const b=new Uint8Array(y),x=[],S=Math.max(m,1),w=Math.min(p,c-2),k=Math.max(f,1),C=Math.min(v,u-2);if(n&&n.length>0)for(a=0;a<y;a++)1===n[a]&&(g[a]=1);for(r=k;r<C+1;r++)for(o=S;o<w+1;o++)a=r*c+o,0!==h[a]&&(l=a+c,d=a-c,0!==g[a+1]&&0!==g[a-1]&&0!==g[l]&&0!==g[l+1]&&0!==g[l-1]&&0!==g[d]&&0!==g[d+1]&&0!==g[d-1]||x.push(a));if(0===m)for(r=f;r<v+1;r++)1===h[r*c]&&x.push(r*c);if(p===c-1)for(r=f;r<v+1;r++)1===h[r*c+p]&&x.push(r*c+p);if(0===f)for(o=m;o<p+1;o++)1===h[o]&&x.push(o);if(v===u-1)for(o=m;o<p+1;o++)1===h[v*c+o]&&x.push(v*c+o);const j=[];let R,_;const T=t+c,A=t+u,K=2*t+1;for(y=x.length,s=0;s<y;s++){for(a=x[s],b[a]=1,j.push(a),o=a%c,r=(a-o)/c,R=t-o>0?t-o:0,_=T-o<K?T-o:K,l=a-t,i=R;i<_;i++)d=l+i,0===b[d]&&(b[d]=1,j.push(d));for(R=t-r>0?t-r:0,_=A-r<K?A-r:K,l=a-t*c,i=R;i<_;i++)d=l+i*c,0===b[d]&&(b[d]=1,j.push(d))}return j}(e,t,n);let i,s,r,a,l,d,c,u,h,g,m;const p=2*t+1,f=2*t*t,v=new Float32Array(p);let y=0;const b=e.width,x=e.height,S=e.data;let w=e.bounds.minX,k=e.bounds.maxX,C=e.bounds.minY,j=e.bounds.maxY;const R=o.length;for(r=0;r<t;r++)s=(t-r)*(t-r),i=Math.exp(-s/f)/Math.PI,v[t+r]=v[t-r]=i,y+=2*i;for(r=0;r<p;r++)v[r]/=y;const _=new Uint8Array(S),T=t+b,A=t+x;for(r=0;r<R;r++){for(l=o[r],h=0,c=l%b,u=(l-c)/b,g=t-c>0?t-c:0,m=T-c<p?T-c:p,d=l-t,a=g;a<m;a++)h+=S[d+a]*v[a];if(h>.5)_[l]=1,c<w&&(w=c),c>k&&(k=c),u<C&&(C=u),u>j&&(j=u);else{for(g=t-u>0?t-u:0,m=A-u<p?A-u:p,d=l-t*b,a=g;a<m;a++)h+=S[d+a*b]*v[a];h>.5?(_[l]=1,c<w&&(w=c),c>k&&(k=c),u<C&&(C=u),u>j&&(j=u)):_[l]=0}}return{data:_,width:b,height:x,bounds:{minX:w,minY:C,maxX:k,maxY:j}}},e.createBorderMask=e=>{let t,n,o,i,s;const r=e.width,a=e.height,l=e.data,d=e.bounds.minX,c=e.bounds.maxX,u=e.bounds.minY,h=e.bounds.maxY,g=c-d+1,m=h-u+1,p=new Uint8Array(g*m),f=Math.max(d,1),v=Math.min(c,r-2),y=Math.max(u,1),b=Math.min(h,a-2);for(n=y;n<b+1;n++)for(t=f;t<v+1;t++)o=n*r+t,0!==l[o]&&(i=o+r,s=o-r,0!==l[o+1]&&0!==l[o-1]&&0!==l[i]&&0!==l[i+1]&&0!==l[i-1]&&0!==l[s]&&0!==l[s+1]&&0!==l[s-1]||(p[(n-u)*g+(t-d)]=1));if(0===d)for(n=u;n<h+1;n++)1===l[n*r]&&(p[(n-u)*g]=1);if(c===r-1)for(n=u;n<h+1;n++)1===l[n*r+c]&&(p[(n-u)*g+(c-d)]=1);if(0===u)for(t=d;t<c+1;t++)1===l[t]&&(p[t-d]=1);if(h===a-1)for(t=d;t<c+1;t++)1===l[h*r+t]&&(p[(h-u)*g+(t-d)]=1);return{data:p,width:g,height:m,offset:{x:d,y:u}}},e.getBorderIndices=e=>{let t,n,o,i,s;const r=e.width,a=e.height,l=e.data,d=[],c=r-1,u=a-1;for(n=1;n<u;n++)for(t=1;t<c;t++)o=n*r+t,0!==l[o]&&(i=o+r,s=o-r,0!==l[o+1]&&0!==l[o-1]&&0!==l[i]&&0!==l[i+1]&&0!==l[i-1]&&0!==l[s]&&0!==l[s+1]&&0!==l[s-1]||d.push(o));for(n=0;n<a;n++)1===l[n*r]&&d.push(n*r);for(t=0;t<r;t++)1===l[t]&&d.push(t);for(o=r-1,n=0;n<a;n++)1===l[n*r+o]&&d.push(n*r+o);for(o=(a-1)*r,t=0;t<r;t++)1===l[o+t]&&d.push(o+t);return d},e.traceContours=e=>{const t=function(e){let t,n;const o=e.width,i=e.data,s=e.bounds.minX,r=e.bounds.maxX,a=e.bounds.minY,l=e.bounds.maxY,d=r-s+3,c=l-a+3,u=new Uint8Array(d*c);for(n=a;n<l+1;n++)for(t=s;t<r+1;t++)1===i[n*o+t]&&(u[(n-a+1)*d+(t-s+1)]=1);return{data:u,width:d,height:c,offset:{x:s-1,y:a-1}}}(e),n=[];let o=0;const i=t.width,s=2*i,r=t.height,a=t.data,l=t.offset.x,d=t.offset.y,c=new Uint8Array(a);let u,h,g,m,p,f,v,y,b,x,S,w,k,C,j;const R=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(m=1;m<r-1;m++)for(g=1;g<i-1;g++)if(p=m*i+g,1===a[p])for(u=-i;u<s;u+=s)if(0===a[p+u]&&0===c[p+u]){for(y=u===i,o++,v=[],b=y?2:6,w=k=x={x:g,y:m},S=null;;){for(c[w.y*i+w.x]=o,h=0;h<8;h++){if(b=(b+1)%8,j=R[b],C={x:w.x+j[0],y:w.y+j[1]},f=C.y*i+C.x,1===a[f]){c[f]=o;break}c[f]=-1,C=null}if(null===C)break;if(w=C,S){if(k.x===x.x&&k.y===x.y&&w.x===S.x&&w.y===S.y)break}else S=C;v.push({x:k.x+l,y:k.y+d}),k=w,b=(b+4)%8}null!==C&&(v.push({x:x.x+l,y:x.y+d}),n.push({inner:y,label:o,points:v}))}return n},e.simplifyContours=(e,t,n)=>{const o=e.length,i=[];let s,r,a,l,d,c,u,h,g,m,p,f,v,y,b,x,S,w,k,C,j;for(r=0;r<o;r++)if(l=e[r],d=l.points,c=l.points.length,c<n){for(u=[],a=0;a<c;a++)u.push({x:d[a].x,y:d[a].y});i.push({inner:l.inner,label:l.label,points:u,initialCount:c})}else{h=[0,c-1],g=[{first:0,last:c-1}];do{if(m=g.shift(),!(m.last<=m.first+1)){for(p=-1,f=m.first,s=m.first+1;s<m.last;s++)k=d[s],C=d[m.first],j=d[m.last],S=k.x-C.x,w=k.y-C.y,y=Math.sqrt(S*S+w*w),S=k.x-j.x,w=k.y-j.y,b=Math.sqrt(S*S+w*w),S=C.x-j.x,w=C.y-j.y,x=Math.sqrt(S*S+w*w),v=y>=Math.sqrt(b*b+x*x)?b:b>=Math.sqrt(y*y+x*x)?y:Math.abs((w*k.x-S*k.y+C.x*j.y-j.x*C.y)/x),v>p&&(f=s,p=v);p>t&&(h.push(f),g.push({first:m.first,last:f}),g.push({first:f,last:m.last}))}}while(g.length>0);for(u=[],c=h.length,h.sort(((e,t)=>e-t)),a=0;a<c;a++)u.push({x:d[h[a]].x,y:d[h[a]].y});i.push({inner:l.inner,label:l.label,points:u,initialCount:l.points.length})}return i},e})();function kt(e,t,n,o,i,s,r,a,l,d,c){const u={data:e.data,width:n,height:o,bytes:4};let h=wt.floodFill(u,i,s,r,null);return h&&(h=wt.gaussBlurOnlyBorder(h,d,null)),c&&function(e,t,n,o,i,s){if(!o)return;const[r,a,l]=St()(i).rgb();let d,c;s=Math.round(255*s);const{data:u,bounds:h,width:g}=o,m=e.createImageData(t,n);for(c=h.minY;c<=h.maxY;c++)for(d=h.minX;d<=h.maxX;d++){if(0===u[c*g+d])continue;const e=4*(c*t+d);m.data[e]=r,m.data[e+1]=a,m.data[e+2]=l,m.data[e+3]=s}e.putImageData(m,0,0)}(t,n,o,h,a,l),h}var Ct=n(68541);function jt(e,t){let n,o=e.x,i=e.y,s=t.x,r=t.y;return o>s&&(n=Math.abs(o-s),o=s,s=o+n),i>r&&(n=Math.abs(i-r),i=r,r=i+n),{x1:o,y1:i,x2:s,y2:r}}function Rt(e,t){const n=e.stageRef.getLayers().filter((e=>e.attrs.id===t.id))[0].canvas.context,o=n.getImageData(0,0,n.canvas.width,n.canvas.height),i=[];for(let t=0;t<e.stageRef.bufferCanvas.context.canvas.width*e.stageRef.bufferCanvas.context.canvas.height*4;t+=4){const e=o.data[t+0],n=o.data[t+1],s=o.data[t+2],r=o.data[t+3];e>0||n>0||s>0||r>0?i.push(1):i.push(0)}return i}function _t(e,t){let n,o,i,s;return[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}].forEach((e=>{const r=t.point(e);void 0===n&&(n=i=r.x,o=s=r.y),n=Math.min(n,r.x),o=Math.min(o,r.y),i=Math.max(i,r.x),s=Math.max(s,r.y)})),{x:n,y:o,width:i-n,height:s-o}}function Tt(e,t,n=0){const o=new Ct.A.Transform;return o.translate(t.x,t.y),o.rotate(n),_t(e,o)}function At(e,t,n){let{x:o,y:i,width:s,height:r}=e;return o<0?(s+=o,o=0):o+s>t&&(s=t-o),i<0?(r+=i,i=0):i+r>n&&(r=n-i),Object.assign({},e,{x:o,y:i,width:s,height:r})}function Kt(e,t={x:0,y:0}){const{parent:n}=e;return o=>n.fixForZoomWrapper(o,(o=>{let{x:i,y:s}=o;(0,j.VS)(j.MV)&&(i=n.canvasToInternalX(i),s=n.canvasToInternalY(s)),i-=t.x,s-=t.y;const r=e.selected||!e.inSelection,{top:a,left:l,right:d,bottom:c}=e.bboxCoords,{top:u,left:h,right:g,bottom:m}=(null==n?void 0:n.selectedRegionsBBox)||{},p=r?{x:i,y:s,width:d-l,height:c-a}:{x:h-l+i,y:u-a+s,width:g-h,height:m-u},f=(0,j.VS)(j.MV)?At(p,100,100):At(p,n.stageWidth,n.stageHeight);return f.width!==p.width&&(i+=(f.width-p.width)*(f.x!==p.x?-1:1)),f.height!==p.height&&(s+=(f.height-p.height)*(f.y!==p.y?-1:1)),i+=t.x,s+=t.y,(0,j.VS)(j.MV)?{x:n.internalToCanvasX(i),y:n.internalToCanvasY(s)}:{x:i,y:s}}))}function Et(e,t,n,o,i,s,r,a,l,d,c){let u,h;c?(u=Math.min(s,o),h=Math.min(r,i)):(u=s,h=r);const g=document.createElement("canvas");g.width=u,g.height=h;const m=g.getContext("2d"),[p,f]=Pt(t,n,o,i,l,d);let v,y;c?(v=t,y=n):(v=Math.ceil(s/o*t),y=Math.ceil(r/i*n));const b=p,x=f,S=v,w=y,k=u,C=h;let j;m.drawImage(e,b,x,S,w,0,0,k,C);try{j=m.getImageData(0,0,g.width,g.height)}catch(e){const t="Please configure CORS cross-domain headers correctly for getting image labeling data";throw alert(t),console.error(t),t}return[j,g]}function Pt(e,t,n,o,i,s){const r=Math.abs(i)/n,a=Math.abs(s)/o;return[Math.floor(r*e),Math.floor(a*t)]}function Mt(e){let t=e/1e3;const n=Number.parseInt(t/3600);t%=3600;const o=Number.parseInt(t/60);return t=Math.floor(t),`${n}:${o}:${t}`}function Dt(e){if(!("string"==typeof e||e instanceof Date||(t=e,/\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z)/.test(t))))return;var t;const n=new Date(e),o=((new Date).getTime()-n.getTime())/1e3,i=Math.floor(o/86400);return isNaN(i)||i<0?void 0:0===i&&((o<60?"just now":o<120&&"1 minute ago")||o<3600&&`${Math.floor(o/60)} minutes ago`||o<7200&&"1 hour ago"||o<86400&&`${Math.floor(o/3600)} hours ago`)||1===i&&"Yesterday"||i<7&&`${i} days ago`||i<31&&`${Math.ceil(i/7)} weeks ago`||`${i} days ago`}function Ot(e){const t=6e4*(e=e||new Date).getTimezoneOffset();return new Date(e.getTime()-t).toISOString().slice(0,-1)}function It(){return Ot()}const Lt=e=>e&&e.nodeType===Node.TEXT_NODE,Nt=e=>e&&/[\w']/i.test(e),zt=e=>e&&/[\s\t]/i.test(e),Vt=e=>{const t=e.getRangeAt(0),{startOffset:n,startContainer:o,endOffset:i,endContainer:s}=t;return{selection:e,range:t,startOffset:n,startContainer:o,endOffset:i,endContainer:s,firstSymbol:o.textContent[n],prevSymbol:o.textContent[n-1],lastSymbol:s.textContent[i-1],nextSymbol:s.textContent[i]}},Ht=e=>{(e=>{const t=e.getRangeAt(0);e.removeAllRanges(),e.collapse(t.startContainer,t.startOffset);let n=e.getRangeAt(0);do{e.collapse(n.endContainer,n.endOffset),e.modify("extend","forward","character"),n=e.getRangeAt(0)}while(!Lt(n.startContainer)||zt(n.startContainer.textContent[n.startOffset]));t.setStart(n.startContainer,n.startOffset),e.removeAllRanges(),e.addRange(t)})(e),(e=>{const t=e.getRangeAt(0);e.removeAllRanges(),e.collapse(t.endContainer,t.endOffset);let n=e.getRangeAt(0);do{e.collapse(n.startContainer,n.startOffset),e.modify("extend","backward","character"),n=e.getRangeAt(0)}while(!Lt(n.startContainer)||zt(n.startContainer.textContent[n.startOffset]));t.setEnd(n.endContainer,n.endOffset),e.removeAllRanges(),e.addRange(t)})(e)},Bt=(e,t)=>{const n="symbol"!==t,{startOffset:o,startContainer:i,endOffset:s,endContainer:r,firstSymbol:a,prevSymbol:l,lastSymbol:d,nextSymbol:c}=Vt(e);if(n)t.endsWith("boundary")?((e,t)=>{const{range:n,startOffset:o,startContainer:i,endOffset:s,endContainer:r}=Vt(e),a={};let l;e.collapse(i,o),e.modify("move","forward","character"),e.modify("move","backward",t),1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)&&(e.collapse(i,o),e.modify("move","backward",t)),l=e.getRangeAt(0),Object.assign(a,{startContainer:l.startContainer,startOffset:l.startOffset}),e.collapse(r,s),e.modify("move","backward","character"),e.modify("move","forward",t),-1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)&&(e.collapse(r,s),e.modify("move","forward",t)),l=e.getRangeAt(0),Object.assign(a,{endContainer:l.endContainer,endOffset:l.endOffset}),e.removeAllRanges();const d=new Range;d.setStart(a.startContainer,a.startOffset),d.setEnd(a.endContainer,a.endOffset),e.addRange(d)})(e,t):((e,t)=>{const{range:n,startOffset:o,startContainer:i,endOffset:s,endContainer:r}=Vt(e),a={};let l;for(e.collapse(r,s);1===e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n);)e.modify("move","backward",t);for(;e.getRangeAt(0).compareBoundaryPoints(Range.START_TO_START,n)<1;)l=e.getRangeAt(0),Object.assign(a,{startContainer:l.startContainer,startOffset:l.startOffset}),e.modify("move","forward",t);for(e.collapse(i,o);-1===e.getRangeAt(0).compareBoundaryPoints(Range.END_TO_END,n);)e.modify("move","forward",t);for(;e.getRangeAt(0).compareBoundaryPoints(Range.END_TO_END,n)>-1;)l=e.getRangeAt(0),Object.assign(a,{endContainer:l.endContainer,endOffset:l.endOffset}),e.modify("move","backward",t);e.removeAllRanges();const d=new Range;d.setStart(a.startContainer,a.startOffset),d.setEnd(a.endContainer,a.endOffset),e.addRange(d),Ht(e)})(e,t);else{if(!Nt(a)||Nt(l)){e.getRangeAt(0).setEnd(i,o),e.modify("move","backward",t)}if(!Nt(d)||Nt(c)){e.getRangeAt(0).setEnd(r,s),e.modify("extend","forward",t)}}},Ft=(e,{granularity:t,beforeCleanup:n,window:o}={granularity:"symbol"})=>{const i=o.getSelection();if(i.isCollapsed)return;if("symbol"!==t&&Ht(i),i.isCollapsed)return;Wt(i,t);const s=i.toString().replace(/[\n\r]/g,"\\n");for(let t=0;t<i.rangeCount;t++){e({selectionText:s,range:Ut(i.getRangeAt(t))})}null==n||n(),i.removeAllRanges()},Wt=(e,t)=>{if(e.modify&&t&&"symbol"!==t)try{switch(t){case"word":Bt(e,"word");break;case"sentence":Bt(e,"sentenceboundary");break;case"paragraph":Bt(e,"paragraphboundary")}}catch(e){console.warn("Probably, you're using browser that doesn't support granularity.")}},$t=(e,t,n,o="forward")=>{const i=t===e?t.childNodes[n]:t;if(Lt(i)&&!o.endsWith("next"))return i;const s=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ALL);let r,a=s.nextNode();for(;a&&a!==i;)Lt(a)&&(r=a),a=s.nextNode();if(a&&o.startsWith("backward"))return r;for("forward-next"===o&&(a=s.nextNode());a;){if(Lt(a))return a;a=s.nextNode()}},Ut=e=>{const{endOffset:t,commonAncestorContainer:n}=e;let{startOffset:o,startContainer:i,endContainer:s}=e;if(!Lt(i)){if(i=$t(n,i,o,"forward"),!i)return null;e.setStart(i,0),o=0}const r=e=>/^\s*$/.test(e.wholeText);if(i.wholeText.length===o||r(i)){do{if(i=$t(n,i,o,"forward-next"),!i)return null}while(r(i));e.setStart(i,0),o=0}if(!Lt(s)){if(s=$t(n,s,t,"backward"),!s)return null;for(;/^\s*$/.test(s.wholeText);)if(s=$t(n,s,t,"backward-next"),!s)return null;e.setEnd(s,s.length)}return e},Yt=(e,{index:t,label:n,classNames:o})=>{const{startContainer:i,endContainer:s,commonAncestorContainer:r}=e,{startOffset:a,endOffset:l}=e,d=[],c=(...e)=>Xt(...e,o);if(i===s)d.push(c(i,a,l));else{qt(i,s,r).forEach((e=>{let t=a,n=l;e!==i&&(t=0),e!==s&&(n=e.length),d.push(c(e,t,n))}))}const u=d[d.length-1];return u&&(u.setAttribute("data-label",null!=n?n:""),u.setAttribute("data-index",t?String(t):"")),d},Xt=(e,t,n,o)=>{let i;const s=e.textContent,r=e.parentNode;if(0===t&&e.length===n&&r.classList.contains(o[0])&&r.innerText===s){const t=e.ownerDocument.createElement("span"),n=r.parentNode;n.replaceChild(t,r),i=Gt(r,o),n.replaceChild(i,t)}else{const a=s.substring(t,n),l=e.ownerDocument.createTextNode(a),d=e.cloneNode(),c=e.cloneNode();d.textContent=s.substring(0,t),c.textContent=s.substring(n,s.length);const u=e.ownerDocument.createDocumentFragment();i=Gt(l,o),d.length&&u.appendChild(d),u.appendChild(i),c.length&&u.appendChild(c),r.replaceChild(u,e)}return i},Gt=(e,t,n)=>{const o=e.ownerDocument.createElement("span");return o.appendChild(e),Zt(o,{classNames:t,label:n}),o},Zt=(e,{classNames:t,index:n,label:o})=>{t&&(e.className="",e.classList.add(...t)),null!=o&&o.length?e.setAttribute("data-label",o):e.removeAttribute("data-label"),e.setAttribute("data-index",n?String(n):"")},qt=(e,t,n)=>{const o=n.ownerDocument.createTreeWalker(n,NodeFilter.SHOW_ALL);let i=!1;const s=[];let{currentNode:r}=o;for(;r&&(r===e&&(i=!0),i&&r.nodeType===Node.TEXT_NODE&&s.push(r),!i||r!==t);)r=o.nextNode();return s},Jt=e=>{e&&e.forEach((e=>{const t=e.ownerDocument.createDocumentFragment(),n=e.parentNode;Array.from(e.childNodes).forEach((e=>{e.remove(),t.appendChild(e)})),n.replaceChild(t,e),Array.from(n.childNodes).forEach((e=>{const t=e.previousSibling;Lt(t)&&Lt(e)&&(t.data+=e.data,e.remove())}))}))},Qt=({node:e,position:t})=>{const n=e.textContent.substr(0,t);return{node:e,position:[...n].length}},en=e=>{const t=Qt({node:e.startContainer,position:e.startOffset}),n=Qt({node:e.endContainer,position:e.endOffset});return e.setStart(e.startContainer,t.position),e.setEnd(e.endContainer,n.position),e},tn=(e,t)=>[nn(e.startContainer,e.startOffset,t),nn(e.endContainer,e.endOffset,t)],nn=(e,t,n)=>{var o;const i=(null!=(o=n.contentDocument)?o:n.ownerDocument).createTreeWalker(n,NodeFilter.SHOW_ALL);let s=0,r=!1,a=i.nextNode();for(;a;){r=r||e===a;const n=e===a||a.contains(e),o=a.nodeType===Node.TEXT_NODE,l="BR"===a.nodeName;if(r&&!1===n)break;if(o||l){let e=(0,x.isDefined)(a.length)?[...a.textContent].length:1;n&&(e=Math.min(t,e)),s+=e}a=i.nextNode()}return s},on=e=>{const t=window.getSelection(),n=document.createRange(),o=e.childNodes[0];n.setStart(o,0),n.setEnd(o,o.length);for(let e=t.rangeCount;e--;){const o=t.getRangeAt(e);if(o.compareBoundaryPoints(Range.START_TO_START,n)<1&&o.compareBoundaryPoints(Range.END_TO_END,n)>-1)return!0}return!1};const sn={Image:i,HTML:Ke,Checkers:x,Colors:bt,UDate:s,guidGenerator:T,debounce:G,styleToProp:function(e){return e?e.split(";").filter((e=>e.split(":")[0]&&e.split(":")[1])).map((e=>[e.split(":")[0].trim().replace(/-./g,(e=>e.substr(1).toUpperCase())),e.split(":").slice(1).join(":").trim()])).reduce(((e,t)=>Object.assign({},e,{[t[0]]:t[1]})),{}):null},Magicwand:o,Selection:r},rn=u.gK.model("AudioUltraRegionModel",{type:"audioregion",object:u.gK.late((()=>u.gK.reference(Us))),start:u.gK.number,end:u.gK.number,channel:u.gK.optional(u.gK.number,0),selectedregionbg:u.gK.optional(u.gK.string,"rgba(0, 0, 0, 0.5)")}).volatile((()=>({hideable:!0,_ws_region:null}))).views((e=>({get bboxTriggers(){var t,n;return[e.start,e.end,e._ws_region,null==(t=e.object)?void 0:t._ws,null==(n=e.object)?void 0:n._wfFrame]},get bboxCoordsCanvas(){if(!e.bboxTriggers)return null;const{_ws_region:t}=e;if(!t)return null;if(!t.inViewport)return null;const{xStart:n,xEnd:o,yStart:i,yEnd:s,visualizer:r}=t;return{left:(0,x.clamp)(n,0,r.width),top:i,right:(0,x.clamp)(o,0,r.width),bottom:s}},wsRegionOptions(){var t;return{id:e.id,start:e.start,end:e.end,color:e.getColor(),visible:!e.hidden,updateable:!e.isReadOnly(),deletable:!e.isReadOnly(),channel:null!=(t=e.channel)?t:0}}}))).actions((e=>{const t={setProperty:e.setProperty,setLocked:e.setLocked};return{serialize(){var t;return{original_length:null==(t=e.object._ws)?void 0:t.duration,value:{start:e.start,end:e.end,channel:e.channel}}},getColor:(t=1)=>sn.Colors.convertToRGBA(e.getOneColor(),t),updateColor(t=1){var n;const o=e.getColor(t);null==(n=e._ws_region)||n.updateColor(o)},updatePosition(t,n){var o;null==(o=e._ws_region)||o.updatePosition(null!=t?t:e.start,null!=n?n:e.end)},selectRegion(){e._ws_region&&(e._ws_region.handleSelected(!0),e._ws_region.bringToFront(),e._ws_region.scrollToRegion())},deleteRegion(){e.annotation.deleteRegion(e)},afterUnselectRegion(){e._ws_region&&e._ws_region.handleSelected(!1)},setHighlight(t){e._highlighted=t,e._ws_region&&e._ws_region.handleHighlighted(t)},beforeDestroy(){e._ws_region&&e._ws_region.remove()},setLocked(n){t.setLocked(n),e._ws_region&&e._ws_region.setLocked(e.locked)},onMouseOver(){e.annotation.isLinkingMode&&(e.setHighlight(!0),e._ws_region.switchCursor(z.A.LINKING_MODE_CURSOR))},onMouseLeave(){e.annotation.isLinkingMode&&(e.setHighlight(!1),e._ws_region.switchCursor(z.A.MOVE_CURSOR))},onUpdateEnd(){e.start=e._ws_region.start,e.end=e._ws_region.end,e.notifyDrawingFinished()},toggleHidden(t){null==t||t.stopPropagation(),e.hidden=!e.hidden,e._ws_region&&e._ws_region.setVisibility(!e.hidden)},setProperty(n,o){t.setProperty(n,o),["start","end"].includes(n)&&e.updatePosition()},setWSRegion(t){e._ws_region=t,t&&(t.on("mouseOver",e.onMouseOver),t.on("mouseLeave",e.onMouseLeave))}}})),an=u.gK.model("AudioRegionModel",{type:"audioregion",object:u.gK.late((()=>u.gK.reference(Us))),start:u.gK.number,end:u.gK.number,channel:u.gK.optional(u.gK.number,0),selectedregionbg:u.gK.optional(u.gK.string,"rgba(0, 0, 0, 0.5)")}).volatile((()=>({hideable:!0}))).views((e=>({getRegionElement:()=>e.wsRegionElement(e._ws_region),wsRegionElement(e){if(!e)return null;const t=e.id;return document.querySelector(`[data-id="${t}"]`)},get wsRegionOptions(){const t={id:e.id,start:e.start,end:e.end,channel:e.channel,color:"orange"};return e.readonly&&(t.drag=!1,t.resize=!1),t}}))).actions((e=>({serialize(){var t;return{original_length:null==(t=e.object._ws)?void 0:t.getDuration(),value:{start:e.start,end:e.end,channel:e.channel}}},updateColor(t=1){const n=sn.Colors.convertToRGBA(e.getOneColor(),t);try{var o;null==(o=e._ws_region)||o.update({color:n})}catch(e){}},updateAppearenceFromState(){var t;null!=(t=e._ws_region)&&t.update&&(e._ws_region.start=e.start,e._ws_region.end=e.end,e.applyCSSClass(e._ws_region))},applyCSSClass(t){e.updateColor(.3);const n=(0,u.Zn)(e).settings,o=e.wsRegionElement(t);if(!o)return;const i=o.className.split(" ");for(const e in i)i[e].indexOf("htx-label")>=0&&i.splice(e,1);const s=[...new Set([...i,"htx-highlight","htx-highlight-last"])];if(e.parent.showlabels||n.showLabels){var r;const t=sn.HTML.labelWithCSS(o,{labels:null==(r=e.labeling)?void 0:r.mainValue,score:e.score});s.push(t)}else s.push("htx-no-label");o.className=s.filter(Boolean).join(" ")},selectRegion(){e.updateColor(.8);const t=e.wsRegionElement(e._ws_region);if(t){const e=window.document.scrollingElement,n=e.scrollTop,o=e.scrollLeft;t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView(),window.document.scrollingElement.scrollTo(o,n)}},afterUnselectRegion(){e.updateColor(.3)},setHighlight(t){e._highlighted=t,e._ws_region&&(t?(e.updateColor(.8),e._ws_region.element.style.border=z.A.HIGHLIGHTED_CSS_BORDER):(e.updateColor(.3),e._ws_region.element.style.border="none"))},beforeDestroy(){e._ws_region&&e._ws_region.remove()},setLocked(t){e.locked=t instanceof Function?t(e.locked):t,e._ws_region&&(e._ws_region.drag=!e.locked,e._ws_region.resize=!e.locked)},onClick(t,n){e.annotation.isLinkingMode||e._ws_region.update({color:sn.Colors.rgbaChangeAlpha(e.selectedregionbg,.8)}),e.onClickRegion(n)},onMouseOver(){e.annotation.isLinkingMode&&(e.setHighlight(!0),e._ws_region.element.style.cursor=z.A.LINKING_MODE_CURSOR)},onMouseLeave(){e.annotation.isLinkingMode&&(e.setHighlight(!1),e._ws_region.element.style.cursor=z.A.MOVE_CURSOR)},onUpdateEnd(){var t;e.start=e._ws_region.start,e.end=e._ws_region.end,e.channel=null!=(t=e._ws_region.channelIdx)?t:0,e.updateColor(e.selected?.8:.3),e.notifyDrawingFinished()},toggleHidden(t){e.hidden=!e.hidden,e._ws_region.element.style.display=e.hidden?"none":"block",null==t||t.stopPropagation()}}))),ln=u.gK.model("EditableRegion").volatile((()=>({editorEnabled:!0,editableFields:[]}))).views((e=>({getProperty:t=>e[t],getPropertyType:t=>(0,u.Pw)(e).properties[t],isPropertyEditable:t=>e.editableFields.some((e=>e.property===t)),get hasEditableFields(){return e.editableFields.length>0}}))).actions((e=>({setProperty(t,n){if(!e.isPropertyEditable(t))throw new Error(`Property ${t} of model ${e.type} is not editable`);e[t]=n}}))),dn=u.gK.model("EditableAudioModel",{}).volatile((()=>({editableFields:[{property:"start",label:"Start"},{property:"end",label:"End"}]}))),un=u.gK.compose("AudioRegionModel",ut,yt,Ze,ln,dn,an),hn=u.gK.compose("AudioRegionModel",ut,yt,Ze,ln,dn,rn);let gn=un;(0,j.VS)(j.vS)&&(gn=hn),b.addRegionType(gn,"audioplus"),b.addRegionType(gn,"audio");var mn=n(8392),pn=n.n(mn),fn=n(26324);const vn=(e,t,n)=>{const o={type:"",title:""};switch(e){case"error":o.type=fn.A.error,o.title="Error";break;case"warning":o.type=fn.A.warning,o.title="Warning";break;case"success":o.type=fn.A.success,o.title="Success";break;default:o.type=fn.A.info,o.title="Info"}return o.type({title:n||o.title,content:t})},yn={error:(e,t)=>vn("error",e,t),warning:(e,t)=>vn("warning",e,t),success:(e,t)=>vn("success",e,t),info:(e,t)=>vn("info",e,t)},bn=u.gK.model("BaseTag"),xn=u.gK.model(Object.assign({},(0,j.VS)(j.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{_needsUpdate:u.gK.optional(u.gK.number,0)})).volatile((()=>({isObjectTag:!0,supportSuggestions:!1}))).views((e=>({get allRegs(){var t;return(null==(t=e.annotation)?void 0:t.regionStore.regions.filter((t=>t.object===e)))||[]},get regs(){return e.allRegs},findRegion(t){let n=null;return e._regionsCache&&e._regionsCache.length&&(n=e._regionsCache.find((({region:e})=>pn()(e,t)))),n||e.regions.find((e=>pn()(e,t)))},get isReady(){return!0}}))).actions((e=>{const t={};return{addProp:function(n,o){t[n]=o,e._needsUpdate=e._needsUpdate+1},getProps:function(){return t},getAvailableStates:function(){const t=(e.states()||[]).reduce(((e,t)=>t.checkMaxUsages?e.concat(t.checkMaxUsages()):e),[]).filter((e=>e.selected));t.forEach((e=>e.setSelected(!1)));const n=e.activeStates()||[];if(0===n.length){if(t.length){const e=t[0];yn.warning(`You can't use ${e.value} more than ${e.maxUsages} time(s)`)}e.annotation.unselectAll()}return n}}})),Sn=u.gK.compose(xn,bn,Ne),wn={min:1,max:1500,step:10,default:1},kn={min:.5,max:2,step:.01,default:1},Cn={min:0,max:1,step:.01,default:1},jn=u.gK.model({value:u.gK.maybeNull(u.gK.string),muted:u.gK.optional(u.gK.boolean,!1),zoom:u.gK.optional(u.gK.boolean,!0),defaultzoom:u.gK.optional(u.gK.string,wn.default.toString()),volume:u.gK.optional(u.gK.boolean,!0),defaultvolume:u.gK.optional(u.gK.string,Cn.default.toString()),speed:u.gK.optional(u.gK.boolean,!0),defaultspeed:u.gK.optional(u.gK.string,kn.default.toString()),hotkey:u.gK.maybeNull(u.gK.string),showlabels:u.gK.optional(u.gK.boolean,!1),showscores:u.gK.optional(u.gK.boolean,!1),height:u.gK.optional(u.gK.string,"88"),cursorwidth:u.gK.optional(u.gK.string,"2"),cursorcolor:u.gK.optional(Me.color,"#333"),defaultscale:u.gK.optional(u.gK.string,"1"),autocenter:u.gK.optional(u.gK.boolean,!0),scrollparent:u.gK.optional(u.gK.boolean,!0)}),Rn=u.gK.compose("AudioModel",jn,Ge,Ue,Sn,Ne,Ve,u.gK.model("AudioModel",{type:"audio",_value:u.gK.optional(u.gK.string,""),playing:u.gK.optional(u.gK.boolean,!1),regions:u.gK.array(gn)}).volatile((()=>({errors:[]}))).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},get store(){return(0,u.Zn)(e)},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t&&t.filter((e=>"LabelsModel"===(0,u.Pw)(e).name&&e.isSelected))}}))).actions((e=>({triggerSync(t,n){var o;e._ws&&e.syncSend(Object.assign({playing:e._ws.isPlaying(),time:e._ws.getCurrentTime(),speed:null!=(o=e._ws.rate)?o:1},n),t)},triggerSyncPlay(){e.triggerSync("play")},triggerSyncPause(){e.triggerSync("pause")},handleSyncPlay(t){var n;e._ws&&(e.handleSyncSeek(t),e._ws.isPlaying()||null==(n=e._ws)||n.play())},handleSyncPause(t){var n;e._ws&&(e.handleSyncSeek(t),e._ws.isPlaying()&&(null==(n=e._ws)||n.pause()))},handleSyncSpeed(){},handleSyncSeek({time:t}){try{e._ws&&t!==e._ws.getCurrentTime()&&e._ws.setCurrentTime(t)}catch(e){console.log(e)}},registerSyncHandlers(){e.syncHandlers.set("play",e.handleSyncPlay),e.syncHandlers.set("pause",e.handleSyncPause),e.syncHandlers.set("seek",e.handleSyncSeek),e.syncHandlers.set("speed",e.handleSyncSpeed)}}))).actions((e=>({needsUpdate(){e.handleNewRegions()},onReady(){e.setReady(!0)},handleNewRegions(){var t;null!=(t=e._ws)&&t.isReady&&e.regs.map((t=>{t._ws_region||e.createWsRegion(t)}))},onHotKey:t=>(t&&t.preventDefault(),e._ws.playPause(),!1),setRangeValue(t){e.rangeValue=t},setPlaybackRate(t){e.playBackRate=t},createRegion(t,n){let o=e.selectedregionbg;const i=n.find((e=>"labels"===e.type));i&&(o=sn.Colors.convertToRGBA(i.getSelectedColor(),.3));const s=gn.create({id:t.id?t.id:T(),pid:t.pid?t.pid:T(),parentID:null===t.parent_id?"":t.parent_id,start:t.start,end:t.end,score:t.score,readonly:t.readonly,regionbg:e.regionbg,selectedregionbg:o,normalization:t.normalization,states:n});return s._ws_region=t,e.regions.push(s),e.annotation.addRegion(s),s},selectRange(t,n){const o=e.regs.filter((e=>e.start>=n.start&&e.end<=n.end));n.remove&&n.remove(),o.length&&e.annotation.selectAreas(o)},addRegion(t){const n=e.annotation.areas.get(t.id);if(n)return n.applyCSSClass(t),n._ws_region=t,n;if(0===e.getAvailableStates().length)return void t.on("update-end",(n=>e.selectRange(n,t)));const o=e.activeStates()[0],i={[o.valueType]:o.selectedValues()},s=e.annotation.createResult(t,i,o,e);return s._ws_region=t,s.updateAppearenceFromState(),s},handlePlay(){e._ws&&(e.playing=!e.playing,e._ws.isPlaying()?e.triggerSync("play"):e.triggerSync("pause"))},handleSeek(){e.triggerSync("seek")},handleSpeed(t){e.triggerSync("speed",{speed:t})},createWsRegion(t){const n=t.wsRegionOptions;t.annotation.isReadOnly()&&(n.drag=!1,n.resize=!1);const o=e._ws.addRegion(t.wsRegionOptions);t._ws_region=o,t.updateAppearenceFromState()},onLoad(t){e._ws=t;const n=e.annotation.history;e.regs.forEach((t=>{e.createWsRegion(t)})),setTimeout((()=>n.setSkipNextUndoState(!1)),0)},onError(t){e.errors=[t]},wsCreated(t){e._ws=t},beforeDestroy(){try{(0,x.isDefined)(e._ws)&&(e._ws.destroy(),e._ws=null)}catch(t){e._ws=null,console.warn("Already destroyed")}}})))),_n=u.gK.model({name:u.gK.identifier,value:u.gK.maybeNull(u.gK.string),muted:u.gK.optional(u.gK.boolean,!1),zoom:u.gK.optional(u.gK.boolean,!0),defaultzoom:u.gK.optional(u.gK.string,1..toString()),volume:u.gK.optional(u.gK.boolean,!0),defaultvolume:u.gK.optional(u.gK.string,1..toString()),speed:u.gK.optional(u.gK.boolean,!0),defaultspeed:u.gK.optional(u.gK.string,1..toString()),hotkey:u.gK.maybeNull(u.gK.string),showlabels:u.gK.optional(u.gK.boolean,!1),showscores:u.gK.optional(u.gK.boolean,!1),height:u.gK.optional(u.gK.string,"96"),waveheight:u.gK.optional(u.gK.string,"32"),cursorwidth:u.gK.optional(u.gK.string,"2"),cursorcolor:u.gK.optional(Me.color,"#333"),defaultscale:u.gK.optional(u.gK.string,"1"),autocenter:u.gK.optional(u.gK.boolean,!0),scrollparent:u.gK.optional(u.gK.boolean,!0),splitchannels:u.gK.optional(u.gK.boolean,!1),decoder:u.gK.optional(u.gK.enumeration(["ffmpeg","webaudio"]),"webaudio"),player:u.gK.optional(u.gK.enumeration(["html5","webaudio"]),"html5")}),Tn=u.gK.compose("AudioModel",_n,Ge,Ue,Sn,Ne,Ve,u.gK.model("AudioModel",{type:"audio",_value:u.gK.optional(u.gK.string,""),regions:u.gK.array(gn)}).volatile((()=>({errors:[],stageRef:(0,m.createRef)(),_ws:null,_wfFrame:null}))).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},get store(){return(0,u.Zn)(e)},states(){var t;return(null==(t=e.annotation)?void 0:t.toNames.get(e.name))||[]},activeStates(){const t=e.states();return t&&t.filter((e=>"LabelsModel"===(0,u.Pw)(e).name&&e.isSelected))},get activeState(){const t=e.states();return t&&t.filter((e=>"LabelsModel"===(0,u.Pw)(e).name&&e.isSelected))[0]},get activeLabel(){var t;const n=e.activeState;return null==n||null==(t=n.selectedValues())?void 0:t[0]}}))).actions((e=>({triggerSync(t,n){e._ws&&e.syncSend(Object.assign({playing:e._ws.playing,time:e._ws.currentTime,speed:e._ws.rate},n),t)},triggerSyncSpeed(t){e.triggerSync("speed",{speed:t})},triggerSyncPlay(){e.handleSyncPlay(),e.triggerSync("play",{playing:!0})},triggerSyncPause(){e.handleSyncPause(),e.triggerSync("pause",{playing:!1})},triggerSyncSeek(t){e.triggerSync("seek",{time:t})},registerSyncHandlers(){["play","pause","seek"].forEach((t=>{e.syncHandlers.set(t,e.handleSync)})),e.syncHandlers.set("speed",e.handleSyncSpeed)},handleSync(t){var n,o,i;null!=(n=e._ws)&&n.loaded&&(e.handleSyncSeek(t),t.playing?e._ws.playing||null==(o=e._ws)||o.play():e._ws.playing&&(null==(i=e._ws)||i.pause()))},handleSyncPlay(){var t,n;null!=(t=e._ws)&&t.playing||null==(n=e._ws)||n.play()},handleSyncPause(){var t,n;null!=(t=e._ws)&&t.playing&&(null==(n=e._ws)||n.pause())},handleSyncSeek({time:t}){var n;if(null!=(n=e._ws)&&n.loaded&&(0,x.isDefined)(t))try{e._ws.setCurrentTime(t,!0),e._ws.syncCursor()}catch(e){console.log(e)}},handleSyncSpeed({speed:t}){e._ws&&(e._ws.rate=t)},syncMuted(t){e._ws&&(e._ws.muted=t)}}))).actions((e=>{let t,n=null;return{afterCreate(){t=(0,c.lB)(e,"activeLabel",(()=>{var t;const n=null==(t=e._ws)||null==(t=t.regions)?void 0:t.selected;if(!n||0===n.length)return;const o=e.activeState,i=null==o?void 0:o.selectedColor,s=null==o?void 0:o.selectedValues();n.forEach((t=>{t.update({color:i,labels:null!=s?s:[]});const n=t.isRegion?e.updateRegion(t):e.addRegion(t);e.annotation.selectArea(n)})),n.length&&e.requestWSUpdate()}),!1)},needsUpdate(){e.handleNewRegions(),e.requestWSUpdate()},requestWSUpdate(){e._ws&&(n&&clearTimeout(n),n=setTimeout((()=>{e._ws.regions.redraw()}),33))},onReady(){e.setReady(!0)},onRateChange(t){e.triggerSyncSpeed(t)},loadSyncedParagraphs(){if(!e.syncManager)return;Array.from(e.syncManager.syncTargets,(([,e])=>e)).filter((e=>"paragraphs"===e.type&&e.contextscroll)).forEach((t=>{const n=Object.values(t.regionsStartEnd).map((({start:e,end:t})=>({start:e,end:t,showInTimeline:!0,external:!0,locked:!0})));e._ws.addRegions(n)}))},handleNewRegions(){e._ws&&e.regs.map((t=>{t._ws_region?e.updateWsRegion(t):e.createWsRegion(t)}))},findRegionByWsRegion:t=>e.regs.find((e=>{var n;return(null==(n=e._ws_region)?void 0:n.id)===(null==t?void 0:t.id)})),getRegionColor(){const t=e.activeState;return t?t.selectedColor:null},onHotKey:t=>(t&&t.preventDefault(),e._ws.togglePlay(),!1),setRangeValue(t){e.rangeValue=t},setPlaybackRate(t){e.playBackRate=t},createRegion(t,n){let o=e.selectedregionbg;const i=n.find((e=>"labels"===e.type));i&&(o=sn.Colors.convertToRGBA(i.getSelectedColor(),.3));const s=gn.create({id:t.id?t.id:T(),pid:t.pid?t.pid:T(),parentID:null===t.parent_id?"":t.parent_id,start:t.start,end:t.end,score:t.score,readonly:t.readonly,regionbg:e.regionbg,selectedregionbg:o,normalization:t.normalization,states:n});return s.setWSRegion(t),e.regions.push(s),e.annotation.addRegion(s),s},addRegion(t){const n=e.annotation.areas.get(t.id);if(n)return n.setWSRegion(t),n.updateColor(),n;if(0===e.getAvailableStates().length)return void(t.isRegion&&t.convertToSegment().handleSelected());const o=e.activeState,i={[o.valueType]:o.selectedValues()},s=e.annotation.createResult(t,i,o,e),r=t.convertToRegion(i.labels);return s.setWSRegion(r),s.updateColor(),s},updateRegion(t){const n=e.findRegionByWsRegion(t);if(n)return n.onUpdateEnd(),n},createWsRegion(t){var n;if(!e._ws)return;const o=t.wsRegionOptions();o.labels=null!=(n=t.labels)&&n.length?t.labels:void 0;const i=e._ws.addRegion(o,!1);t.setWSRegion(i)},updateWsRegion(t){var n;if(!e._ws)return;const o=t.wsRegionOptions();o.labels=null!=(n=t.labels)&&n.length?t.labels:void 0,e._ws.updateRegion(o,!1)},clearRegionMappings(){e.regs.forEach((e=>{e.setWSRegion(null)}))},onLoad(t){e.clearRegionMappings(),e._ws=t,e.checkReady(),e.needsUpdate(),(0,j.VS)(j.LG)&&e.loadSyncedParagraphs()},checkReady(){e._ws&&!e._ws.destroyed&&(e._ws.isDrawing?requestAnimationFrame((()=>e.checkReady())):e.onReady())},onSeek(t){e.triggerSyncSeek(t)},onPlaying(t){t?e.triggerSyncPlay():e.triggerSyncPause()},onError(t){let n;n="HTTPError"===t.name?"ERR_LOADING_HTTP":"ERR_LOADING_AUDIO";const o=(0,u._$)(e.store).messages[n]({attr:e.value,url:e._value,error:t.message});e.errors=[o]},beforeDestroy(){try{n&&clearTimeout(n),t&&t(),(0,x.isDefined)(e._ws)&&(e._ws.destroy(),e._ws=null)}catch(t){e._ws=null,console.warn("Already destroyed")}},setWFFrame(t){e._wfFrame=t}}}))),An=({item:e,style:t,className:n,children:o})=>{const i=e.getProps&&e.getProps(),s=(0,Qe.cn)("object").toClassName();return(0,A.jsx)("div",Object.assign({className:[s,n].join(" "),"data-needs-update":e._needsUpdate,style:t},i,{children:o}))},Kn=(0,v.PA)(An),En=(0,v.PA)(An);var Pn=n(92006),Mn=n.n(Pn),Dn=n(53871),On=n.n(Dn),In=n(1474),Ln=n(17022),Nn=n(64381),zn=n.n(Nn),Vn=n(38573),Hn=n.n(Vn),Bn=n(57290),Fn=n.n(Bn);const Wn="wave--XFK_Q",$n="link--MtZ3P";var Un=n(82149),Yn=n(61747),Xn=n(35455),Gn=n(27078),Zn=n(73033),qn=n(37442),Jn=n.n(qn),Qn=n(68564);const eo=e=>(0,A.jsx)(Qe.eB,{name:"hint",tag:"sup",className:e.className,"data-copy":e.copy,style:e.style,children:e.children}),to=JSON.parse('{"audio:back":{"key":"ctrl+b","mac":"command+b","description":"Back for one second"},"audio:playpause":{"key":"ctrl+p","mac":"command+p","description":"Play/pause"},"audio:step-backward":{"key":"alt+a","description":"Go one step back"},"audio:step-forward":{"key":"alt+d","description":"Go one step forward"},"ts:grow-left":{"key":"left","description":"Increase region to the left"},"ts:grow-right":{"key":"right","description":"Increase region to the right"},"ts:shrink-left":{"key":"alt+left","description":"Decrease region on the left"},"ts:shrink-right":{"key":"alt+right","description":"Decrease region on the right"},"ts:grow-left-largre":{"key":"shift+left"},"ts:grow-right-largre":{"key":"shift+right"},"ts:shrink-left-largre":{"key":"shift+alt+left"},"ts:shrink-right-largre":{"key":"shift+alt+right"},"annotation:submit":{"key":"ctrl+enter","mac":"command+enter","description":"Submit annotation"},"annotation:skip":{"key":"ctrl+space","mac":"alt+enter","description":"Skip task"},"annotation:undo":{"key":"ctrl+z","mac":"command+z","description":"Undo"},"annotation:redo":{"key":"ctrl+shift+z","mac":"command+shift+z","description":"Redo"},"polygon:undo":{"key":"ctrl+z","mac":"command+z","description":"Undo"},"polygon:redo":{"key":"ctrl+shift+z","mac":"command+shift+z","description":"Redo"},"region:delete-all":{"key":"ctrl+backspace","mac":"command+backspace","description":"Delete all regions"},"region:focus":{"key":"enter","description":"Focus first focusable region"},"region:relation":{"key":"alt+r","description":"Create relation between regions"},"region:visibility":{"key":"alt+h","description":"Toggle selected region visibility"},"region:visibility-all":{"key":"ctrl+h","mac":"ctrl+h","description":"Toggle all regions visibility"},"region:lock":{"key":"alt+l","description":"Lock selected region"},"region:meta":{"key":"alt+m","description":"Edit selected region meta"},"region:unselect":{"key":"u","description":"Unselect region"},"region:exit":{"key":"escape","description":"Exit relation mode, unselect region"},"region:delete":{"key":"backspace","description":"Delete selected region"},"region:cycle":{"key":"alt+.","description":"Cycle through regions"},"region:duplicate":{"key":"ctrl+d","mac":"command+d","description":"Duplicate selected region"},"segment:delete":{"key":"delete","description":"Delete selected region"},"media:playpause":{"key":"ctrl+alt+space","mac":"control+space","description":"Play/pause"},"media:step-backward":{"key":"alt+left","description":"Go one step back"},"media:step-forward":{"key":"alt+right","description":"Go one step forward"},"video:keyframe-backward":{"key":"ctrl+alt+left","description":"Go to previous keyframe"},"video:keyframe-forward":{"key":"ctrl+alt+right","description":"Go to next keyframe"},"video:backward":{"key":"alt+left","description":"Go back"},"video:rewind":{"key":"shift+ctrl+alt+left","description":"Go to first frame"},"video:forward":{"key":"shift+alt+right","description":"Go forward"},"video:fastforward":{"key":"shift+ctrl+alt+right","description":"Go to last frame"},"video:hop-backward":{"key":"shift+alt+left","description":"Hop Backward"},"video:hop-forward":{"key":"shift+alt+right","description":"Hop Forward"},"repeater:next-page":{"key":"alt+right","description":"Next Page"},"repeater:previous-page":{"key":"alt+left","description":"Previous Page"},"image:prev":{"key":"ctrl+left","mac":"command+left","description":"Previous Image"},"image:next":{"key":"ctrl+right","mac":"command+right","description":"Next Image"}}'),no=["store","name","children"];if(!(0,j.VS)(j.xB)){const e=to["image:prev"],t=to["image:next"];e&&(e.key=e.mac="ctrl+a"),t&&(t.key=t.mac="ctrl+d")}const oo=["key","mac","description","modifier","modifierDescription"],io=e=>{Object.entries(e).forEach((([e,t])=>{Object.keys(t).forEach((t=>{if(!oo.includes(t))throw new Error(`Unknown keymap property ${t} for key ${e}`)}))}))};io(to);const so="__main__",ro="__input__",ao={},lo={},co=[],uo={[so]:{},[ro]:{}};Jn().filter=e=>{var t;if("__none__"===Jn().getScope())return!1;const n=null==(t=e.target||e.srcElement)?void 0:t.tagName;return e.keyCode>=96&&e.keyCode<=105&&(e=>{const t=e.keyCode-48;document.dispatchEvent(new KeyboardEvent("keydown",{keyCode:t}))})(e),n&&Jn().setScope(/^(INPUT|TEXTAREA|SELECT)$/.test(n)?ro:so),!0};const ho={plus:"=",minus:"-",",":""},go=(e="global",t="Hotkeys")=>{var n;let o={};lo[e]=null!=(n=lo[e])?n:{description:t,get keys(){return o},get descriptions(){const e=Object.keys(this.keys).reduce(((e,t)=>(ao[t]&&e.push([t,ao[t]]),e)),[]);return Object.fromEntries(e)}};const i=(t,n)=>{const o=uo[t];o&&o[n]&&(o[n]=o[n].filter((t=>t.namespace!==e)))},s=(e,t)=>{const n=uo[e];n&&n[t]&&n[t].forEach((n=>{Jn()(t,e,n.func)}))},r=e=>[...e.replace(/\s/,"").matchAll(/((?:\w+\+)*(?:[^,]+|,)),?/g)].map((e=>e[1])),a=()=>{for(const e of[so,ro])for(const t of Object.keys(o)){const n=r(t);for(const t of n)i(e,t),Jn().unbind(t,e),s(e,t),delete ao[t]}o={}};return co.push(a),{applyAliases:e=>r(e).map((e=>e.split("+").map((e=>{var t;return null!=(t=ho[e.trim()])?t:e})).join("+"))).join(","),addKey(t,n,i,s=so){if(!(0,x.isDefined)(t))return;o[t]&&console.warn(`Key already added: ${t}. It's possibly a bug.`);const r=this.applyAliases(t.toLowerCase());o[r]=n,i&&(ao[r]=i),s.split(",").map((e=>e.trim())).filter(Boolean).forEach((t=>{const o=(...e)=>{const t=e[0];t.stopPropagation(),t.preventDefault(),n(...e)};((t,n,o)=>{(0,x.isDefined)(uo[t])||(uo[t]={});const i=uo[t];(0,x.isDefined)(i[n])||(i[n]=[]),i[n].push({namespace:e,func:o})})(t,r,o),Jn()(r,t,o)}))},overwriteKey(e,t,n,o=so){(0,x.isDefined)(e)&&(this.hasKey(e)&&this.removeKey(e,o),this.addKey(e,t,n,o))},removeKey(e,t=so){if(!(0,x.isDefined)(e))return;const n=e.toLowerCase();this.hasKey(n)&&(t.split(",").map((e=>e.trim())).filter(Boolean).forEach((t=>{i(t,e),Jn().unbind(n,t),s(t,e)})),delete o[n],delete ao[n])},addNamed(e,t,n){const o=go.keymap[e];if(!(0,x.isDefined)(o))throw new Error(`Unknown named hotkey ${o}`);{var i;const e=(0,x.isMacOS)()&&null!=(i=o.mac)?i:o.key;this.addKey(e,t,o.description,n),o.modifier&&this.addKey(`${o.modifier}+${e}`,t,o.modifierDescription,n)}},removeNamed(e,t){const n=go.keymap[e];if(!(0,x.isDefined)(n))throw new Error(`Unknown named hotkey ${n}`);{var o;const e=(0,x.isMacOS)()&&null!=(o=n.mac)?o:n.key;this.removeKey(e,t),n.modifier&&this.removeKey(`${n.modifier}+${e}`)}},overwriteNamed(e,t,n){const o=go.keymap[e];if(!(0,x.isDefined)(o))throw new Error(`Unknown named hotkey ${e}`);{var i;const e=(0,x.isMacOS)()&&null!=(i=o.mac)?i:o.key;this.overwriteKey(e,t,o.description,n),o.modifier&&this.overwriteKey(`${o.modifier}+${e}`,t,o.modifierDescription,n)}},hasKey(e){if(!(0,x.isDefined)(e))return;const t=e.toLowerCase();return(0,x.isDefined)(o[t])},getKeys:()=>Object.keys(o),getNamespace:()=>lo[e],addDescription(e,t){o[e]||(ao[e]=t)},removeDescription(e){o||ao[e]},unbindAll(){a()},makeComb(){const e="1234567890qwetasdfgzxcvbyiopjklnm".split("");for(let t=0;t<=e.length;t++){let n;if(n=e[t],!{}.hasOwnProperty.call(o,n))return n}return null}}};go.DEFAULT_SCOPE=so,go.INPUT_SCOPE=ro,go.ALL_SCOPES=[so,ro].join(","),go.keymap=Object.assign({},to),go.setKeymap=e=>{io(e),Object.assign(go.keymap,e)},go.keysDescipritions=()=>ao,go.namespaces=()=>lo,go.unbindAll=()=>{co.forEach((e=>e()))},go.setScope=e=>{Jn().setScope(e)},go.Tooltip=(0,v.WQ)("store")((0,v.PA)((e=>{let{store:t,name:n,children:o}=e,i=(0,Zn.A)(e,no);const s=go.keymap[n],r=t.settings.enableTooltips&&t.settings.enableHotkeys;if((0,x.isDefined)(s)){var a,l;const e=(0,x.isMacOS)()&&null!=(a=s.mac)?a:s.key,t=null!=(l=i.title)?l:s.description,n=[];return r&&e.split(",").forEach((e=>{const t=e.split("+").map((e=>(0,m.createElement)(Qe.Sl,{tag:"kbd",name:"key"},e)));n.push((0,m.createElement)(Qe.eB,{name:"key-group",tag:"span",style:{marginLeft:5}},...t))})),(0,m.createElement)(Qn.m_M,Object.assign({},i,{theme:"light",title:(0,m.createElement)(m.Fragment,{},t,...n)}),o)}return o}))),go.Hint=(0,v.WQ)("store")((0,v.PA)((({store:e,name:t})=>{const n=go.keymap[t],o=e.settings.enableTooltips&&e.settings.enableHotkeys;if((0,x.isDefined)(n)&&o){var i;const e=(0,x.isMacOS)()&&null!=(i=n.mac)?i:n.key;return(0,m.createElement)(eo,{},[e])}return null})));const mo=["0.5","0.75","1.0","1.25","1.5","2.0"].map((e=>({value:+e,label:`Speed ${e}`})));function po(e,t){e=Number(e);const n=Math.floor(e/60);e%=60;let o=Math.round(e).toString();return t>=250?o=e.toFixed(2):t>=25&&(o=e.toFixed(1)),n>0?(e<10&&(o=`0${o}`),`${n}:${o}`):o}function fo(e){let t=1;return t=e>=2500?.01:e>=1e3?.025:e>=250?.1:e>=100?.25:e>=25?1:5*e>=25?5:15*e>=25?15:60*Math.ceil(.5/e),t}function vo(e){let t=1;return t=e>=2500?10:e>=1e3?4:e>=250?10:e>=100?4:e>=25?1:5*e>=25?5:15*e>=25?15:60*Math.ceil(.5/e),t}function yo(e){return Math.floor(10/fo(e))}class bo extends m.Component{constructor(e){super(e),this.onChangeZoom=e=>{this.setState(Object.assign({},this.state,{zoom:e})),this.wavesurfer.zoom(e)},this.onChangeZoomY=e=>{this.setState(Object.assign({},this.state,{zoomY:e}),this.updateZoomY)},this.updateZoomY=On()((()=>{this.wavesurfer.params.barHeight=this.state.zoomY,this.wavesurfer.drawBuffer()}),100),this.onChangeVolume=e=>{this.setState(Object.assign({},this.state,{volume:e})),this.wavesurfer.setVolume(e)},this.onChangeSpeed=e=>{this.setState(Object.assign({},this.state,{speed:e})),this.wavesurfer.setPlaybackRate(e)},this.onZoomPlus=(e,t=10)=>{let n=this.state.zoom;return n+=t,n>700&&(n=700),this.onChangeZoom(n),e&&e.preventDefault(),!1},this.onZoomMinus=(e,t=10)=>{let n=this.state.zoom;return n-=t,n<0&&(n=0),this.onChangeZoom(n),e.preventDefault(),!1},this.onZoomYPlus=(e,t=1)=>{let n=this.state.zoomY;return n+=t,n>50&&(n=50),this.onChangeZoomY(n),e.preventDefault(),!1},this.onZoomYMinus=(e,t=1)=>{let n=this.state.zoomY;return n-=t,n<1&&(n=1),this.onChangeZoomY(n),e&&e.preventDefault(),!1},this.onWheel=e=>{if(e&&!e.shiftKey)return;e&&e.shiftKey&&e.preventDefault();const t=e.deltaY>0?5:-5;this.onZoomPlus(e,t)},this.onBack=()=>{let e=this.wavesurfer.getCurrentTime();return!!e&&(e--,this.wavesurfer.setCurrentTime(e>0?e:0),!1)},this.setWaveformRef=e=>{this.$waveform=e},this.hotkeys=go("Audio","Audio Segmentation"),this.state={src:this.props.src,pos:0,colors:{waveColor:"var(--color-neutral-subtle)",progressColor:"var(--color-positive-surface)"},zoom:0,zoomY:1,speed:1,volume:e.muted?0:1}}componentDidMount(){const e=this.props.messages||et.A;let t={container:this.$waveform,waveColor:this.state.colors.waveColor,height:this.props.height,backend:"MediaElement",progressColor:this.state.colors.progressColor,splitChannels:!0,cursorWidth:this.props.cursorWidth,cursorColor:this.props.cursorColor,barHeight:1};this.props.regions&&(t=Object.assign({},t,{plugins:[zn().create({dragSelection:{slop:5}}),Hn().create({container:"#timeline",formatTimeCallback:po,timeInterval:fo,primaryLabelInterval:vo,secondaryLabelInterval:yo,primaryColor:"blue",secondaryColor:"blue",primaryFontColor:"#000",secondaryFontColor:"#000"}),Mn().create({wrapper:this.$waveform,showTime:!0,opacity:1})]})),this.wavesurfer=Fn().create(Object.assign({},t)),this.props.defaultVolume&&this.wavesurfer.setVolume(this.props.defaultVolume),this.props.muted&&this.wavesurfer.setVolume(0),this.props.defaultSpeed&&this.wavesurfer.setPlaybackRate(this.props.defaultSpeed),this.props.defaultZoom&&this.wavesurfer.zoom(this.props.defaultZoom),this.wavesurfer.on("error",(t=>{const n=String(t.message||t||""),o=this.props.src;let i=e.ERR_LOADING_AUDIO({attr:this.props.dataField,error:n,url:o});if(null!=n&&n.includes("HTTP")||null!=n&&n.includes("fetch"))this.wavesurfer.hadNetworkError=!0,i=e.ERR_LOADING_HTTP({attr:this.props.dataField,error:n,url:o});else if("string"==typeof t&&t.includes("media element")){if(this.wavesurfer.hadNetworkError)return;i="Error while processing audio. Check media format and availability."}this.props.onError&&this.props.onError(i)})),this.wavesurfer.load(this.props.src),this.wavesurfer.setPlaybackRate(this.state.speed);const n=this;this.props.regions&&(this.wavesurfer.on("region-mouseenter",(e=>{var t;null==(t=e._region)||t.onMouseOver()})),this.wavesurfer.on("region-mouseleave",(e=>{var t;null==(t=e._region)||t.onMouseLeave()})),this.wavesurfer.on("region-created",(e=>{n.props.item.annotation.history.setSkipNextUndoState();const t=n.props.addRegion(e);t&&(e._region=t,e.color=t.selectedregionbg,-1===e.channelIdx&&(e.channelIdx=t.channel),e.on("click",(e=>t.onClick(n.wavesurfer,e))),e.on("update-end",(()=>t.onUpdateEnd(n.wavesurfer))),e.on("dblclick",(()=>{window.setTimeout((()=>{e.play()}),0)})),e.on("out",(()=>{})))})));const o=document.querySelector("#slider");o&&(o.oninput=function(){n.wavesurfer.zoom(Number(this.value))}),this.wavesurfer.on("ready",(()=>{n.props.onCreate(this.wavesurfer),this.wavesurfer.container.onwheel=On()(this.onWheel,100)})),this.wavesurfer.on("waveform-ready",(()=>{var e,t;null==(e=(t=this.props).onReady)||e.call(t,this.wavesurfer)})),this.wavesurfer.on("pause",n.props.handlePlay),this.wavesurfer.on("play",n.props.handlePlay),this.wavesurfer.on("seek",n.props.handleSeek),this.props.regions&&this.props.onLoad(this.wavesurfer),this.hotkeys.addNamed("audio:back",this.onBack,`${go.DEFAULT_SCOPE},${go.INPUT_SCOPE}`)}componentWillUnmount(){this.hotkeys.unbindAll(),this.wavesurfer.unAll()}render(){return(0,A.jsxs)("div",{children:[(0,A.jsx)("div",{id:"wave",ref:this.setWaveformRef,className:Wn}),(0,A.jsx)("div",{id:"timeline"}),this.props.zoom&&(0,A.jsxs)(Un.A,{gutter:16,style:{marginTop:"1em"},children:[(0,A.jsx)(Yn.A,{flex:8,style:{textAlign:"right",marginTop:"6px"},children:(0,A.jsxs)("div",{style:{display:"flex"},children:[(0,A.jsx)("div",{style:{marginTop:"6px",marginRight:"5px"},children:(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Horizontal zoom out",children:(0,A.jsx)(In.A,{onClick:this.onZoomMinus,className:$n})})}),(0,A.jsx)("div",{style:{width:"100%"},children:(0,A.jsx)(Xn.A,{min:0,step:10,max:500,value:"number"==typeof this.state.zoom?this.state.zoom:0,onChange:e=>{this.onChangeZoom(e)}})}),(0,A.jsx)("div",{style:{marginTop:"6px",marginLeft:"5px"},children:(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Horizontal zoom in",children:(0,A.jsx)(Ln.A,{onClick:this.onZoomPlus,className:$n})})})]})}),(0,A.jsx)(Yn.A,{flex:4,style:{textAlign:"right",marginTop:"6px"},children:(0,A.jsxs)("div",{style:{display:"flex"},children:[(0,A.jsx)("div",{style:{marginTop:"6px",marginRight:"5px"},children:(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Vertical zoom out",children:(0,A.jsx)(In.A,{onClick:this.onZoomYMinus,className:$n})})}),(0,A.jsx)("div",{style:{width:"100%"},children:(0,A.jsx)(Xn.A,{min:1,step:.1,max:50,value:"number"==typeof this.state.zoomY?this.state.zoomY:1,onChange:e=>{this.onChangeZoomY(e)}})}),(0,A.jsx)("div",{style:{marginTop:"6px",marginLeft:"5px"},children:(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Vertical zoom in",children:(0,A.jsx)(Ln.A,{onClick:this.onZoomYPlus,className:$n})})})]})}),(0,A.jsx)(Yn.A,{flex:3,children:this.props.volume&&(0,A.jsxs)("div",{style:{display:"flex",marginTop:"6.5px"},children:[(0,A.jsx)("div",{style:{width:"100%"},children:(0,A.jsx)(Xn.A,{min:0,max:1,step:.1,value:"number"==typeof this.state.volume?this.state.volume:1,onChange:e=>{this.onChangeVolume(e)}})}),(0,A.jsx)("div",{style:{marginLeft:"10px",marginTop:"5px"},children:(0,A.jsx)(Gn.A,{})})]})}),(0,A.jsx)(Yn.A,{flex:1,style:{marginTop:"6px"},children:this.props.speed&&(0,A.jsx)(Qn.l6P,{placeholder:"Speed",style:{width:"100%"},defaultValue:this.state.speed,onChange:this.onChangeSpeed,options:mo})})]})]})}}var xo=n(76363),So=n(52345),wo=n(53567);const ko=(0,v.PA)((({item:e,store:t})=>(0,A.jsx)("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"1em"},children:(0,A.jsxs)(xo.A,{type:"primary",onClick:()=>{e._ws.playPause()},children:[e.playing&&(0,A.jsxs)(m.Fragment,{children:[(0,A.jsx)(So.A,{})," ",(0,A.jsx)("span",{children:"Pause"}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,A.jsxs)(eo,{children:["[",e.hotkey,"]"]})]}),!e.playing&&(0,A.jsxs)(m.Fragment,{children:[(0,A.jsx)(wo.A,{})," ",(0,A.jsx)("span",{children:"Play"}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,A.jsxs)(eo,{children:["[",e.hotkey,"]"]})]})]})}))),Co=(0,v.WQ)("store")((0,v.PA)((({store:e,item:t})=>{var n;if(!t._value)return null;const o=(0,u._$)(e).messages;return(0,A.jsx)(En,{item:t,children:(0,A.jsxs)(m.Fragment,{children:[null==(n=t.errors)?void 0:n.map(((e,t)=>(0,A.jsx)(Ee,{error:e},`err-${t}`))),(0,A.jsx)(bo,{dataField:t.value,src:t._value,muted:t.muted,item:t,selectRegion:t.selectRegion,handlePlay:t.handlePlay,handleSeek:t.handleSeek,onCreate:t.wsCreated,addRegion:t.addRegion,onLoad:t.onLoad,onReady:t.onReady,onError:t.onError,speed:t.speed,zoom:t.zoom,defaultVolume:Number(t.defaultvolume),defaultSpeed:Number(t.defaultspeed),defaultZoom:Number(t.defaultzoom),volume:t.volume,regions:!0,height:t.height,cursorColor:t.cursorcolor,cursorWidth:t.cursorwidth,messages:o}),(0,A.jsx)(ko,{item:t,store:e}),(0,A.jsx)("div",{style:{marginBottom:"4px"}})]})})}))),jo=e=>{const t=(0,m.useRef)(e);return(0,m.useEffect)((()=>{Object.assign(t.current,e)}),[e]),t.current},Ro=(0,m.createContext)({position:0,length:0,regions:[],step:10,playing:!1,settings:{},visibleWidth:0,seekOffset:0,data:void 0}),_o=Ro.Provider;var To=n(10967);const Ao=go(),Ko=(e,t,n)=>{const o=(0,m.useRef)(null),i=(0,m.useRef)(null),s=(0,m.useRef)(t),r=(0,m.useRef)(((e,t)=>{null==s.current||s.current(e,t)}));(0,m.useEffect)((()=>{const t=e!==o.current,s=n!==i.current;(t||s)&&(e?(((e,t,n)=>{go.keymap[e]?Ao.overwriteNamed(e,t,n):Ao.overwriteKey(e,t,n)})(e,r.current,n),o.current=e):o.current&&!e&&(((e,t)=>{go.keymap[e]?Ao.removeNamed(e,t):Ao.removeKey(e,t)})(o.current,i.current),o.current=null))}),[e,n]),(0,m.useEffect)((()=>{s.current=t}),[t])},Eo=["children","type","extra","className","size","waiting","icon","tag","look","primary","danger","hotkey","hotkeyScope","displayedHotkey","tooltip","tooltipTheme","nopadding"],Po=(0,m.forwardRef)(((e,t)=>{let{children:n,type:o,extra:i,className:s,size:r,waiting:a,icon:l,tag:d,look:c,primary:u,danger:h,hotkey:g,hotkeyScope:p,displayedHotkey:f,tooltip:v,tooltipTheme:y="light",nopadding:b}=e,S=(0,Zn.A)(e,Eo);const w=null!=d?d:S.href?"a":"button",k={size:r,waiting:a,type:o,danger:h,nopadding:b,look:null!=c?c:[],withIcon:!!l,withExtra:!!i};u&&(k.look="primary");const C=(0,m.useMemo)((()=>{if(!l)return null;if((0,x.isDefined)(l.props.size))return l;switch(r){case"small":return(0,m.cloneElement)(l,Object.assign({},l.props,{size:12,width:12,height:12}));case"compact":return(0,m.cloneElement)(l,Object.assign({},l.props,{size:14,width:14,height:14}));default:return l}}),[l,r]);Ko(g,S.onClick,p);const j=(0,A.jsx)(Qe.eB,Object.assign({name:"button",mod:k,mix:s,ref:t,tag:w,type:o},S,{children:(0,A.jsxs)(A.Fragment,{children:[C&&(0,A.jsx)(Qe.Sl,{tag:"span",name:"icon",children:C}),C&&n?(0,A.jsx)("span",{children:n}):n,void 0!==i?(0,A.jsx)(Qe.Sl,{name:"extra",children:i}):null]})}));return g&&(0,x.isDefined)(go.keymap[g])||f&&(0,x.isDefined)(go.keymap[f])?(0,A.jsx)(go.Tooltip,{name:g||f,title:v,children:j}):v?(0,A.jsx)(Qn.m_M,{title:v,theme:y,ref:t,children:j}):j}));Po.displayName="Button";Po.Group=({className:e,children:t,collapsed:n})=>(0,A.jsx)(Qe.eB,{name:"button-group",mod:{collapsed:n},mix:e,children:t});const Mo=["direction","size","className","style","children","spread","stretch","align","collapsed","truncated"],{Block:Do}=(0,Qe.JE)(),Oo=e=>{let{direction:t="horizontal",size:n,className:o,style:i,children:s,spread:r,stretch:a,align:l,collapsed:d,truncated:c}=e,u=(0,Zn.A)(e,Mo);return(0,A.jsx)(Do,Object.assign({name:"space",mod:{direction:t,size:n,spread:r,stretch:a,align:l,collapsed:d,truncated:c},mix:o,style:i},u,{children:s}))},Io=({position:e=0,length:t=0,onPositionChange:n})=>{const[o,i]=(0,m.useState)(!1),s=(0,m.useMemo)((()=>t-1),[t]);return(0,A.jsx)(Qe.eB,{name:"frames-control",onClick:()=>i(!0),children:o?(0,A.jsx)(No,{length:s,position:e,onChange:e=>{null==n||n((0,x.clamp)(e,0,t))},onFinishEditing:()=>{i(!1)}}):(0,A.jsxs)(A.Fragment,{children:[(0,x.clamp)(Math.round(e+1),1,s+1)," ",(0,A.jsxs)("span",{children:["of ",s+1]})]})})},Lo=["ArrowUp","ArrowDown","Backspace","Delete","Enter",/[0-9]/],No=({length:e,position:t,onChange:n,onFinishEditing:o})=>{const i=(0,m.useRef)(),s=t=>{null==n||n((0,x.clamp)(t,1,e))};return(0,A.jsx)("input",{type:"text",ref:i,defaultValue:t+1,autoFocus:!0,onFocus:()=>{var e;return null==(e=i.current)?void 0:e.select()},onKeyDown:t=>{const n=Lo.find((e=>e instanceof RegExp?e.test(t.key):e===t.key));n||t.metaKey||t.preventDefault();const r=Number.parseInt(i.current.value),a=t.shiftKey?10:1;"Enter"===t.key?(null==s||s(r),null==o||o()):"Escape"===t.key?null==o||o():"ArrowUp"===n?(i.current.value=(0,x.clamp)(r+a,1,e).toString(),t.preventDefault()):"ArrowDown"===n&&(i.current.value=(0,x.clamp)(r-a,1,e).toString(),t.preventDefault())},onBlur:()=>null==o?void 0:o()})},zo=(e,t=!1)=>t?[...e].reverse():e,Vo=({value:e,defaultValue:t,multi:n=!1,reverse:o=!1,continuous:i=!1,min:s=0,max:r=100,step:a=1,size:l=120,align:d="horizontal",resetValue:c,minIcon:u,maxIcon:h,onChange:g,onMinIconClick:p,onMaxIconClick:f})=>{var v;const y=null!=(v=null!=e?e:t)?v:n?[0,100]:0,[b,S]=((e,t)=>{const n=(0,m.useMemo)((()=>{var n;return null!=(n=null!=e?e:t)?n:""}),[e,t]),[o,i]=(0,m.useState)(n);return(0,m.useEffect)((()=>{i(n)}),[n]),[o,e=>i(e)]})(y,null!=t?t:y);let w=b;const k=n&&Array.isArray(b),C=e=>(0,x.clamp)(Math.round(e/a)*a,s,r),j=(e,t=!0,o=!1)=>{const s=n&&Array.isArray(e)?e.map(C):C(e);(w!==s||o)&&(S(s),(t||i||o)&&(null==g||g(e)),w=s)},R=(0,m.useCallback)((e=>(e-s)/(r-s)*100),[s,r]),_=(0,m.useCallback)((e=>{const t=r-s;return(0,x.clamp)(t*(e/l)+s,s,r)}),[s,r,l]),T=(0,m.useCallback)((()=>{if(!n)return f?f(b):void j(b+a)}),[a,n,b]),K=(0,m.useCallback)((()=>{if(!n)return p?p(b):void j(b-a)}),[a,n,b]),E=(0,m.useCallback)((e=>{const t=e.currentTarget.getBoundingClientRect(),i="horizontal"===d,a=i?t.width:t.height,l=i?t.left:t.top,c=i?e.clientX:e.clientY,u=(0,x.clamp)(c-l,0,a)/a;let h=(r-s)*u+s;if(o&&(h=r-h),n&&Array.isArray(b)){const e=u>.5?1:0,t=[...b];t[e]=h,j(t,!0,!1)}else j(h,!0,!1)}),[d,s,r,o,b]),P="horizontal"===d?"minWidth":"minHeight";return(0,A.jsxs)(Qe.eB,{name:"range",mod:{align:d},style:{[P]:l},children:[o?h&&(0,A.jsx)(Qe.Sl,{name:"icon",onMouseDown:T,children:h}):u&&(0,A.jsx)(Qe.Sl,{name:"icon",onMouseDown:K,children:u}),(0,A.jsxs)(Qe.Sl,{name:"body",onClick:E,children:[(0,A.jsx)(Qe.Sl,{name:"line"}),(0,A.jsx)(Bo,{align:d,reverse:o,value:b,valueConvert:R}),k?zo(b,o).map(((e,t)=>{const n=o?0===t?1:0:t,i=0===n?1:0,a=e=>{const t=[],o=b[i];return t[n]=0===n?(0,x.clamp)(e,s,o):(0,x.clamp)(e,o,r),t[i]=b[i],t};return(0,A.jsx)(Ho,{align:d,value:e,bodySize:l,reverse:o,resetValue:c[n],valueConvert:R,offsetConvert:_,onChangePosition:e=>j(a(e),!1),onChange:e=>j(a(e),!0,!0)},`handle-${n}`)})):(0,A.jsx)(Ho,{align:d,bodySize:l,reverse:o,value:b,valueConvert:R,offsetConvert:_,resetValue:c,onChangePosition:e=>j(e,!1),onChange:e=>j(e,!0,!0)})]}),o?u&&(0,A.jsx)(Qe.Sl,{name:"icon",onMouseDown:K,children:u}):h&&(0,A.jsx)(Qe.Sl,{name:"icon",onMouseDown:T,children:h})]})},Ho=({value:e,valueConvert:t,offsetConvert:n,onChangePosition:o,onChange:i,resetValue:s,align:r,bodySize:a,reverse:l=!1})=>{const d=t(e),c="horizontal"===r?l?"right":"left":l?"bottom":"top",u="horizontal"===r?"pageX":"pageY";return(0,A.jsx)(Qe.Sl,{name:"range-handle",style:{[c]:`${t(e)}%`},onMouseDownCapture:e=>{e.stopPropagation();const t=e[u];let s;const r=e=>{const i=l?t-e[u]:e[u]-t,r=(0,x.clamp)(i+d/100*a,0,a);s=n(r),requestAnimationFrame((()=>{null==o||o(s)}))},c=e=>{e.stopPropagation(),(0,x.isDefined)(s)&&(null==i||i(s)),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",c)},onDoubleClick:()=>{(0,x.isDefined)(s)&&(null==i||i(s))}})},Bo=({value:e,valueConvert:t,align:n,reverse:o})=>{const i={},s=Array.isArray(e);return"horizontal"===n?(s?(i.left=`${t(e[0])}%`,i.right=100-t(e[1])+"%"):(i.left=0,i.right=100-t(e)+"%"),o&&!s&&([i.left,i.right]=[i.right,i.left])):"vertical"===n&&(s?(i.top=`${t(e[0])}%`,i.bottom=100-t(e[1])+"%"):(i.top=0,i.bottom=100-t(e)+"%"),o&&!s&&([i.top,i.bottom]=[i.bottom,i.top])),(0,A.jsx)(Qe.Sl,{name:"indicator",style:i})},Fo=({volume:e=.5,onVolumeChange:t})=>{const n=(0,m.useRef)(e),o={color:"#99A0AE"},i=(0,m.useMemo)((()=>e>.5?(0,A.jsx)(To.Xaw,{style:o}):e>0?(0,A.jsx)(To.JFg,{style:o}):(0,A.jsx)(To.zau,{style:o})),[e]);return(0,A.jsx)(Vo,{continuous:!0,min:Cn.min,max:Cn.max,step:Cn.step,value:e,minIcon:i,onChange:e=>null==t?void 0:t(Number(e)),onMinIconClick:()=>{0===e?null==t||t(n.current):(n.current=e,null==t||t(0))}})},Wo=({description:e,info:t,max:n,min:o,value:i,step:s=1,onChange:r})=>{const a=(0,m.useRef)(),[l,d]=(0,m.useState)();(0,m.useEffect)((()=>{c()}),[i]);const c=()=>{a.current&&(a.current.style.backgroundSize=100*(i-o)/(n-o)+"% 100%")},u=e=>{d(void 0);if(e.currentTarget.value.match(/^[0-9]*\.$/))return void d(e.currentTarget.value);const t=e.currentTarget.value.match(/^\.[0-9]*$/)?`0${e.currentTarget.value}`:e.currentTarget.value,i=Number.parseFloat(t);isNaN(i)?d(e.currentTarget.value):i>n||i<o?d(i):r(e)};return(0,A.jsxs)(Qe.eB,{name:"audio-slider",children:[(0,A.jsx)(Qe.Sl,{ref:a,name:"range",tag:"input",type:"range",min:o,max:n,step:s,value:i,onChange:u}),(0,A.jsxs)(Qe.Sl,{name:"control",children:[(0,A.jsxs)(Qe.Sl,{name:"info",children:[e,t&&(0,A.jsx)(Qn.m_M,{title:t,children:(0,A.jsx)(To.ehj,{})})]}),(0,A.jsx)(Qe.Sl,{name:"input",tag:"input",type:"text",mod:void 0!==l&&("string"==typeof l||l>n||l<o)&&{error:"control"},min:o,max:n,value:void 0===l?i:l,onChange:u})]})]})},$o=100,Uo=({volume:e,onVolumeChange:t,onSetModal:n,audioModal:o})=>{const[i,s]=(0,m.useState)(!1);(0,m.useEffect)((()=>{s(e<=0)}),[e]);const r=e=>{const n=Number.parseInt(e.currentTarget.value);n?n>$o?null==t||t(1):n<0?null==t||t(0):null==t||t(n/$o):null==t||t(0)},a=()=>{s(!i),null==t||t(i?1:0)},l=()=>(0,A.jsx)(Qe.Sl,{name:"mute",children:(0,A.jsx)(Qe.Sl,{name:"mute-button",onClick:a,children:i?"Unmute":"Mute"})});return(0,A.jsxs)(Qe.eB,{name:"audio-control",onClick:e=>e.stopPropagation(),children:[(0,A.jsx)(oi,{look:o?"active":void 0,onClick:n,children:i?(0,A.jsx)(Qn.I9Y,{}):(0,A.jsx)(Qn.$Rd,{})}),o&&(0,A.jsxs)(Qe.Sl,{name:"modal",children:[(0,A.jsx)(Wo,{min:0,max:$o,value:Math.round(e*$o),onChange:r,description:"Volume",info:"Increase or decrease the volume of the audio"}),l()]})]})},Yo=({configModal:e,speed:t,amp:n,onSpeedChange:o,onSetModal:i,onAmpChange:s,toggleVisibility:r,layerVisibility:a})=>{const l=null!=t?t:1,[d,c]=(0,m.useState)(!0),[u,h]=(0,m.useState)(!0),{settings:g,changeSetting:p}=(0,m.useContext)(Ro);(0,m.useEffect)((()=>{if(a){var e,t;const n=!0;c(null!=(e=null==a||null==a.get?void 0:a.get("timeline"))?e:n),h(null!=(t=null==a||null==a.get?void 0:a.get("waveform"))?t:n)}}),[a]);const f=()=>{c(!d),null==r||r("timeline",!d)},v=()=>{h(!u),null==r||r("waveform",!u),null==r||r("regions",!u)},y=e=>{const t=Number.parseFloat(e.currentTarget.value);isNaN(t)||o(t)},b=e=>{const t=Number.parseFloat(e.currentTarget.value);s(t)};return(0,A.jsxs)(Qe.eB,{name:"audio-config",onClick:e=>e.stopPropagation(),children:[(0,A.jsx)(oi,{look:e?"active":void 0,onClick:i,children:(0,A.jsx)(Qn.sKi,{})}),e&&(0,A.jsxs)(Qe.Sl,{name:"modal",children:[(0,A.jsx)(Wo,{min:.5,max:2.5,step:.1,value:l,description:"Playback speed",info:"Increase or decrease the playback speed",onChange:y}),(0,A.jsx)(Wo,{min:1,max:150,step:.1,value:n,description:"Audio zoom y-axis",info:"Increase or decrease the appearance of amplitude",onChange:b}),(0,A.jsx)(Qe.Sl,{name:"toggle",children:(0,A.jsx)(Qn.lMk,{checked:null==g?void 0:g.loopRegion,onChange:e=>null==p?void 0:p("loopRegion",e.target.checked),label:"Loop Regions",labelProps:{size:"normal"}})}),(0,A.jsx)(Qe.Sl,{name:"toggle",children:(0,A.jsx)(Qn.lMk,{checked:null==g?void 0:g.autoPlayNewSegments,onChange:e=>null==p?void 0:p("autoPlayNewSegments",e.target.checked),label:"Auto-play New Regions",labelProps:{size:"normal"}})}),(0,A.jsxs)(Qe.Sl,{name:"buttons",children:[(0,A.jsxs)(Qe.Sl,{name:"menu-button",onClick:f,children:[d?"Hide":"Show"," timeline"]}),(0,A.jsxs)(Qe.Sl,{name:"menu-button",onClick:v,children:[u?"Hide":"Show"," audio wave"]})]})]})]})};class Xo{constructor(e,t,n,o="_"){this.input=void 0,this.maskPattern=void 0,this.proxyChar=void 0,this.numValidate=void 0,this.stringValidate=void 0,this.mask=void 0,this.validators=void 0,this.placeholder=void 0,this.regExp=void 0,this.onChange=void 0,this.input=e,this.maskPattern=t,this.proxyChar=o,this.onChange=n,this.numValidate=/^\d$/,this.stringValidate=/^[a-zA-Z]$/,this.mask=t.split("").map((e=>{let t;return"A"===e?t=this.stringValidate:"1"===e&&(t=this.numValidate),{char:e,validator:t}})),this.validators=this.mask.filter((e=>e.validator)),this.placeholder=this.mask.map((e=>e.validator?this.proxyChar:e.char)).join("");const i="\\^$*+?.()|{}[]".split(""),s=this.mask.map((e=>{const{validator:t,char:n}=e;return t?t===this.numValidate?"\\d":"[a-zA-Z]":i.includes(n)?`\\${n}`:n})).join("");this.regExp=s,e.pattern=s,e.placeholder=e.placeholder||this.placeholder,e.addEventListener("keydown",this.__inputKeydownMask.bind(this)),e.addEventListener("paste",this.__inputPaste.bind(this)),e.addEventListener("focus",this.__inputFocus.bind(this)),e.addEventListener("blur",this.__inputBlur.bind(this))}parseRaw(e){const t=(e=e||"").replace(/\W/g,"");if(t.length===this.validators.length){if(!t.split("").map(((e,t)=>!!e.match(this.validators[t].validator))).reduce(((e,t)=>!1!==t&&e)))return!1;let e=-1;return this.mask.map((n=>n.validator?(e+=1,t[e]):n.char)).join("")}}disconnect(){this.input.addEventListener("keydown",this.__inputKeydownMask.bind(this)),this.input.addEventListener("paste",this.__inputPaste.bind(this)),this.input.addEventListener("focus",this.__inputFocus.bind(this)),this.input.addEventListener("blur",this.__inputBlur.bind(this))}get value(){return this.parseRaw(this.input.value)}parsePartial(e=""){const t=(e=e||"").replace(/\W/g,"");let n=-1;return this.mask.map((e=>e.validator?(n+=1,t[n]||this.proxyChar):e.char||this.proxyChar)).join("")||this.placeholder}splice(e,t,n){return e.slice(0,t)+n+e.slice(t+1)}__inputBlur(e){e.target.value===this.placeholder&&this.onChange("")}__inputFocus(e){e.target.value||this.onChange(this.placeholder)}__inputKeydownMask(e){const{selectionStart:t,selectionEnd:n}=e.target,o=e.key;let i=t>this.mask.length-1?this.mask.length-1:t,s=this.mask[i];if(!["Tab","Enter","Escape","ArrowLeft","ArrowRight","Shift"].includes(o)&&!e.metaKey)if(t===n){e.preventDefault();let n=null;if("Backspace"===o?n=1:"Delete"===o&&(n=0),null!==n){const o=this.mask[t-n];if(o){const i=o.validator?this.proxyChar:o.char;this.onChange(this.splice(e.target.value,t-n,i)),e.target.setSelectionRange(t-n,t-n)}return}for(;s&&!s.validator&&o!==s.char;)this.onChange(this.splice(e.target.value,i,s.char)),e.target.setSelectionRange(i+1,i+1),s=this.mask[i+1],i+=1;if(s&&s.validator){if(!!!o.match(s.validator))return e.preventDefault(),!1}this.onChange(this.splice(e.target.value,i,o)),setTimeout((e=>e.setSelectionRange(i+1,i+1)),0,e.target)}else setTimeout((()=>{let i=e.target.value;const s="Backspace"===o||"Delete"===o?this.proxyChar:o,r="Backspace"===o||"Delete"===o?t:t+1;for(let e=t;e<n;e++)":"!==i[e]&&(i=`${i.substring(0,e)}${e===t?s:this.proxyChar}${i.substring(e+1,i.length)}`);this.onChange(i),this.input.setSelectionRange(r,r)}))}__inputPaste(e){const t=e.clipboardData.getData("text/plain"),n=this.parseRaw(t);!1!==n&&setTimeout((()=>{this.onChange(n)}))}}const Go=(0,m.forwardRef)((({text:e,children:t,required:n,placement:o,description:i,size:s,large:r,style:a,simple:l,flat:d},c)=>{const u=l?"div":"label",h={size:s,large:r,flat:d,placement:o,withDescription:!!i,empty:!t};return(0,A.jsxs)(Qe.eB,{ref:c,name:"field-label",mod:h,tag:u,style:a,"data-required":n,children:[(0,A.jsx)(Qe.Sl,{name:"text",children:(0,A.jsxs)(Qe.Sl,{name:"content",children:[e,i&&(0,A.jsx)(Qe.Sl,{name:"description",children:i})]})}),(0,A.jsx)(Qe.Sl,{name:"field",children:t})]})})),Zo=["sidepanel","value","readonly","onChange","label"],qo=e=>{let{sidepanel:t=!1,value:n,readonly:o=!1,onChange:i,label:s}=e,r=(0,Zn.A)(e,Zo);const a=m.createRef(),[l,d]=(0,m.useState)(n);(0,m.useEffect)((()=>{a.current&&new Xo(a.current,"11:11:11:111",(e=>{d(e)}))}),[]),(0,m.useEffect)((()=>{d(c(n||0,!0))}),[n]);const c=(0,m.useCallback)(((e,t=!1)=>{const n=new Date(1e3*e).toISOString();let o=e>3600?n.substr(11,8):`00:${n.substr(14,5)}`;if(t){const e="00"!==n.substr(11,2);o=n.substr(e?11:14,e?12:9).replace(".",":"),o=e?o:`00:${o}`}return o}),[]),u=e=>{const t=e.currentTarget.value.split(":");t[0]=1===t[0].toString().length?`0${t[0].toString()}`:`${t[0]}`,(e=>{const t=e.split(":").reverse();let n=0;if(e.indexOf("_")>=0)return;const o=[e=>e/1e3,e=>e,e=>60*e,e=>60*e*60];t.forEach(((e,t)=>{n+=o[t](Number.parseFloat(e))})),i(n)})(t.join(":")),d(c(n||0,!0))},h=e=>{var t;"Enter"===e.key&&(null==(t=e.currentTarget)||null==t.blur||t.blur())},g=(0,A.jsx)(Qe.eB,Object.assign({name:"time-box",mod:{sidepanel:t}},r,{children:(0,A.jsx)(Qe.Sl,{name:"input-time",maxLength:12,tag:"input",ref:a,type:"text",readOnly:o,value:l,onKeyDown:h,onChange:()=>{},onBlur:u})}));return s?(0,A.jsx)(Go,{size:"small",flat:!0,text:s,children:g}):g},Jo=({isSidepanel:e=!1,startTime:t,endTime:n=0,minTime:o,maxTime:i=0,currentTime:s,startTimeReadonly:r=!1,endTimeReadonly:a=!1,onChangeStartTime:l,onChangeEndTime:d,showDuration:c=!1,showLabels:u=!1})=>{const h=s||t;return(0,A.jsxs)(Qe.eB,{name:"timer-duration-control",children:[(0,A.jsx)(qo,{sidepanel:e,readonly:r,value:h,onChange:e=>{e>=o&&e<=i&&e<=n&&(null==l||l(e))},label:u?"Start":void 0,"data-testid":"timebox-current-time"}),(0,A.jsx)(qo,{sidepanel:e,readonly:a,value:n,onChange:e=>{e>=o&&e<=i&&e>=h&&(null==d||d(e))},"data-testid":"timebox-end-time",label:u?"End":void 0}),c&&(0,A.jsx)(qo,{sidepanel:e,readonly:!0,value:n-t,onChange:()=>{},"data-testid":"timebox-duration-time",label:u?"Duration":void 0})]})},Qo=["length","position","frameRate","playing","collapsed","duration","extraControls","fullscreen","altHopSize","disableFrames","allowFullscreen","allowViewCollapse","onRewind","onForward","onPlay","onPause","onFullScreenToggle","onStepBackward","onPositionChange","onStepForward","onSpeedChange","onToggleCollapsed","formatPosition","toggleVisibility","layerVisibility","mediaType"],ei=["children"],ti=({time:e,fps:t})=>{const n=Math.round(t).toString(),o=1e3/t,i=1e3*e%1e3;return Math.round(i/o).toString().padStart(n.length,"0")},ni=(0,m.memo)((e=>{let{length:t=1e3,position:n,frameRate:o=1024,playing:i,collapsed:s,duration:r,extraControls:l,fullscreen:d,altHopSize:c,disableFrames:u,allowFullscreen:h,allowViewCollapse:g,onRewind:p,onForward:f,onPlay:v,onPause:y,onFullScreenToggle:b,onStepBackward:S,onPositionChange:w,onStepForward:k,onSpeedChange:C,onToggleCollapsed:R,formatPosition:_,toggleVisibility:T,layerVisibility:K,mediaType:E}=e,P=(0,Zn.A)(e,Qo);const{settings:M}=(0,m.useContext)(Ro),[D,O]=(0,m.useState)(!1),[I,L]=(0,m.useState)(!1),[N,z]=(0,m.useState)(!1),[V,H]=[1===n,n===t],B=(0,m.useMemo)((()=>Math.max((t-1)/o,0)),[t,o]),F=(0,m.useMemo)((()=>(n-1)/o),[n,o]),W=ai(P.customControls),$=(e,t)=>n=>{e(n,null!=t?t:void 0)},U=(0,m.useCallback)((()=>{i?null==y||y():null==v||v()}),[i,v,y]),Y=e=>{e.stopPropagation(),I&&L(!1),z(!N)},X=e=>{e.stopPropagation(),N&&z(!1),L(!I)},G=()=>{L(!1),z(!1)};(0,m.useEffect)((()=>{const e=e=>{if(null==M||!M.stepSize)return;const t="Shift"===e.key;"keydown"===e.type&&t&&!D?O(!0):"keyup"===e.type&&t&&D&&O(!1)};return document.addEventListener("keydown",e),document.addEventListener("keyup",e),document.addEventListener("click",G),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",e),document.removeEventListener("click",G)}}),[D]);return(0,A.jsxs)(Qe.eB,{name:"timeline-controls",tag:Oo,spread:!0,style:{gridAutoColumns:"auto"},children:[(0,j.VS)(j.vS)&&"audio"===E?(0,A.jsxs)(Qe.Sl,{name:"group",tag:Oo,size:"small",style:{gridAutoColumns:"auto"},children:[(0,A.jsx)(Yo,{onSetModal:X,onAmpChange:P.onAmpChange,configModal:I,onSpeedChange:e=>null==C?void 0:C(e),speed:P.speed||0,amp:P.amp||0,toggleVisibility:T,layerVisibility:K}),(0,A.jsx)(Uo,{volume:P.volume||0,onVolumeChange:P.onVolumeChange,onSetModal:Y,audioModal:N})]}):(0,A.jsxs)(Qe.Sl,{name:"group",tag:Oo,size:"small",style:{gridAutoColumns:"auto"},children:[P.controls&&Object.entries(P.controls).map((([e,o])=>{if(!1===o)return;const i=a[e];return(0,x.isDefined)(i)&&(0,A.jsx)(i,{length:t,position:n-1,volume:P.volume,onPositionChange:w,onVolumeChange:P.onVolumeChange},e)})),null==W?void 0:W.left]}),(0,A.jsxs)(Qe.Sl,{name:"main-controls",children:[(0,A.jsx)(Qe.Sl,{name:"group",tag:Oo,collapsed:!0,children:l}),(0,A.jsxs)(Qe.Sl,{name:"group",tag:Oo,collapsed:!0,children:[null==W?void 0:W.leftCenter,(0,A.jsx)(ri,{showAlterantive:D&&!u,main:(0,A.jsxs)(A.Fragment,{children:[(null==M?void 0:M.stepSize)&&!u&&(0,A.jsx)(oi,{onClick:$(S,M.stepSize),hotkey:null==M?void 0:M.stepAltBack,disabled:V,children:(0,A.jsx)(To.rH_,{})}),(0,A.jsx)(oi,{onClick:$(S),hotkey:null==M?void 0:M.stepBackHotkey,disabled:V,children:(0,A.jsx)(To.gu7,{})})]}),alt:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(oi,{onClick:()=>null==p?void 0:p(),disabled:V,hotkey:null==M?void 0:M.skipToBeginning,children:(0,A.jsx)(To.f20,{})}),(0,A.jsx)(oi,{onClick:()=>null==p?void 0:p(c),disabled:V,hotkey:null==M?void 0:M.hopBackward,children:(0,A.jsx)(To.T9g,{})})]})}),(0,A.jsx)(oi,{"data-testid":"playback-button:"+(i?"pause":"play"),onClick:U,hotkey:null==M?void 0:M.playpauseHotkey,hotkeyScope:go.ALL_SCOPES,children:i?(0,A.jsx)(To.jmo,{}):(0,A.jsx)(To.PB1,{})}),(0,A.jsx)(ri,{showAlterantive:D&&!u,main:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(oi,{onClick:$(k),hotkey:null==M?void 0:M.stepForwardHotkey,disabled:H,children:(0,A.jsx)(To.Vjx,{})}),(null==M?void 0:M.stepSize)&&!u&&(0,A.jsx)(oi,{disabled:H,onClick:$(k,M.stepSize),hotkey:null==M?void 0:M.stepAltForward,children:(0,A.jsx)(To.j3e,{})})]}),alt:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(oi,{onClick:()=>null==f?void 0:f(c),disabled:H,hotkey:null==M?void 0:M.hopForward,children:(0,A.jsx)(To.ZgM,{})}),(0,A.jsx)(oi,{onClick:()=>null==f?void 0:f(),disabled:H,hotkey:null==M?void 0:M.skipToEnd,children:(0,A.jsx)(To.jau,{})})]})}),null==W?void 0:W.rightCenter]}),(0,A.jsxs)(Qe.Sl,{name:"group",tag:Oo,collapsed:!0,children:[!u&&g&&(0,A.jsx)(oi,{tooltip:"Toggle Timeline",onClick:()=>null==R?void 0:R(!s),children:s?(0,A.jsx)(To.iWI,{}):(0,A.jsx)(To.tlL,{})}),h&&(0,A.jsx)(oi,{tooltip:"Fullscreen",onClick:()=>null==b?void 0:b(!1),children:d?(0,A.jsx)(To.ReQ,{}):(0,A.jsx)(To.L9n,{})})]})]}),(0,A.jsx)(Qe.Sl,{name:"group",tag:Oo,size:"small",children:(0,j.VS)(j.vS)&&"audio"===E?(0,A.jsxs)(A.Fragment,{children:[null==W?void 0:W.right,(0,A.jsx)(Jo,{startTime:0,endTime:r,minTime:0,maxTime:r,endTimeReadonly:!0,currentTime:n,onChangeStartTime:e=>{w(e)}})]}):(0,A.jsxs)(A.Fragment,{children:[null==W?void 0:W.right,(0,A.jsx)(ii,{currentTime:F,duration:B,length:t,position:n,framerate:o,formatPosition:_})]})})]})})),oi=e=>{let{children:t}=e,n=(0,Zn.A)(e,ei);return(0,A.jsx)(Po,Object.assign({},n,{type:"text",style:{width:36,height:36,padding:0},children:t}))},ii=({currentTime:e,position:t,duration:n,framerate:o,length:i,formatPosition:s})=>{const r=null!=s?s:ti,a={position:t-1,fps:o,length:i},l=r(Object.assign({time:e},a)),d=r(Object.assign({time:n},a));return(0,A.jsxs)(Qe.Sl,{name:"time",children:[(0,A.jsx)(Qe.Sl,{name:"time-section",children:(0,A.jsx)(si,{time:e,position:l})}),(0,A.jsx)(Qe.Sl,{name:"time-section",children:(0,A.jsx)(si,{time:Math.max(n,0),position:d})})]})},si=({time:e,position:t})=>{const n=new Date(1e3*e).toISOString(),o=e>3600?n.substr(11,8):n.substr(14,5);return(0,A.jsxs)(A.Fragment,{children:[o,t?(0,A.jsx)("span",{children:t}):null]})},ri=e=>e.hidden?null:e.showAlterantive?e.alt:e.main,ai=e=>{if(!e)return null;return null==e?void 0:e.reduce(((e,t)=>{var n;const o=null!=(n=e[t.position])?n:[],i=t.component instanceof Function?t.component():t.component;return o.push(i),e[t.position]=o,e}),{})};var li=n(45250);const di=["position","length","seekOffset","seekVisible","onIndicatorMove","onSeek","minimap","step"],ci=e=>{var t;let{position:n,length:o,seekOffset:i,seekVisible:s,onIndicatorMove:r,onSeek:a,minimap:l,step:d}=e;const c=(null!=(t=(0,Zn.A)(e,di).leftOffset)?t:150)/d,u=(0,m.useRef)(),h=(0,m.useRef)(),g=(0,m.useRef)(),p=s>0,f=(Math.ceil(s)-Math.floor(c)+1.5)/o*100+"%",v=o-(s-c),y=Math.min(i,v)/o*100+"%",b=n/o*100,x=(0,m.useCallback)((e=>{const t=g.current,n=u.current.getBoundingClientRect(),i=t.clientWidth,s=e.pageX,a=s-n.left-i/2,l=n.width,d=l-i,c=(0,li.clamp)(Math.ceil(o*(a/l)),0,d);null==r||r(c);const h=e=>{const t=(0,li.clamp)(a+(e.pageX-s),0,d)/l;null==r||r(Math.ceil(o*t))},m=()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",m)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",m)}),[o]),S=(0,m.useCallback)((e=>{const t=h.current,n=u.current.getBoundingClientRect(),i=t.clientWidth,s=e.pageX,r=s-n.left-i/2,l=n.width,d=e=>{const n=l-t.clientWidth,i=(0,li.clamp)(r+(e.pageX-s),0,n)/l,d=Math.ceil(o*i);null==a||a(d)};d(e);const c=e=>{d(e)},g=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",g)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",g)}),[o]),w=(0,m.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),e.target===g.current?x(e):S(e)}),[x,S]);return(0,A.jsxs)(Qe.eB,{name:"seeker",ref:u,onMouseDown:w,children:[(0,A.jsx)(Qe.Sl,{name:"track"}),p&&(0,A.jsx)(Qe.Sl,{name:"indicator",ref:g,style:{left:y,width:f}}),(0,A.jsx)(Qe.Sl,{name:"position",ref:h,style:{left:`${b}%`}}),(0,A.jsx)(Qe.Sl,{name:"minimap",children:l})]})},ui=(e,t)=>{if(0===e.length)return[];const n=[],o=e[0].frame-1;for(let i=0,s=e.length;i<s;i++){const s=n[n.length-1],r=e[i],a=e[i-1],l=(r.frame-o-1)*t;s&&null!=s&&s.enabled?null!=a&&a.enabled&&(s.width=(r.frame-s.points[0].frame)*t,s.length=r.frame-s.start,s.enabled=r.enabled,s.points.push(r)):n.push({offset:l,width:0,length:0,enabled:r.enabled,start:r.frame,points:[r]})}return n},hi=["points"],gi=({idx:e,region:t,startOffset:n,renderable:o,onSelectRegion:i})=>{const{step:s,seekOffset:r,visibleWidth:a,length:l}=(0,m.useContext)(Ro),{label:d,color:c,visible:u,sequence:h,selected:g,timeline:p}=t,f=(0,m.useMemo)((()=>Math.round(a/2)),[a]),v=(0,m.useMemo)((()=>(0,x.clamp)(r-f,0,l)),[r,f,l]),y=(0,m.useMemo)((()=>(0,x.clamp)(r+a+f,0,l)),[r,a,f,l]),b=h[0],S=b?b.frame-1:0,w=b?S*s:n,k=(0,m.useMemo)((()=>({"--offset":`${n}px`,"--color":c,"--point-color":St()(c).alpha(1).css(),"--lifespan-color":St()(c).alpha(u?.4:1).css()})),[n,c,u]),C=(0,m.useMemo)((()=>o?ui(h,s).map((e=>(e.points=e.points.filter((({frame:e})=>e>=v&&e<=y)),e))):[]),[h,S,s,o,v,y]),j=(0,m.useCallback)(((e,n)=>{e.stopPropagation(),null==i||i(e,t.id,n)}),[t.id,i]),R=p?h.map((e=>e.frame)):[];return(0,A.jsxs)(Qe.eB,{name:"keypoints",style:k,mod:{selected:g,timeline:p},"data-id":t.id,"data-start":R[0],"data-end":R[1],children:[(0,A.jsxs)(Qe.Sl,{name:"label",onClick:j,children:[(0,A.jsx)(Qe.Sl,{name:"name",children:d}),(0,A.jsx)(Qe.Sl,{name:"data",children:(0,A.jsx)(Qe.Sl,{name:"data-item",mod:{faded:!0},children:e})})]}),(0,A.jsx)(Qe.Sl,{name:"keypoints",onClick:e=>j(e,!0),children:(0,A.jsx)(mi,{lifespans:C,step:s,visible:u,offset:w})})]})},mi=({lifespans:e,step:t,offset:n,visible:o})=>(0,A.jsx)(A.Fragment,{children:e.map(((i,s)=>{const r=s+1===e.length,{points:a}=i,l=(0,Zn.A)(i,hi);return(0,A.jsx)(pi,Object.assign({mainOffset:n,step:t,isLast:r,visible:o,points:a.map((({frame:e})=>e))},l),`${s}-${a.length}-${r}-${o}`)}))}),pi=(0,m.memo)((({mainOffset:e,width:t,start:n,step:o,offset:i,enabled:s,visible:r,isLast:a,points:l})=>{const d=e+i+o/2,c=a&&s?0:"auto",u=a&&s?"auto":t,h=(0,m.useMemo)((()=>({left:d,width:u,right:c})),[d,c,u]);return(0,A.jsx)(Qe.Sl,{name:"lifespan",mod:{hidden:!r,instant:!t},style:h,children:l.map(((e,t)=>{const i=(e-n)*o;return(0,A.jsx)(Qe.Sl,{name:"point",style:{left:i},mod:{last:!!i}},t)}))})})),fi=["offset","position","length","step","regions","onScroll","onPositionChange","onResize","onSelectRegion"],vi=(e,t)=>Math.floor(e/t),yi=(e,t)=>vi(e,t)*t,bi=({regions:e,startOffset:t,scrollTop:n,disabled:o,onSelectRegion:i})=>{const s=(0,m.useMemo)((()=>{const t=(0,li.clamp)(Math.ceil(n/24)-1,0,e.length),o=(0,li.clamp)(t+(Math.ceil(6.875)-1),0,e.length);return[(0,li.clamp)(t-5,0,e.length),(0,li.clamp)(o+5,0,e.length)]}),[n,e.length]);return(0,A.jsx)(Qe.Sl,{name:"keypoints",style:{height:24*e.length},children:e.map(((e,n)=>e.sequence.length>0||e.timeline?(0,A.jsx)(gi,{idx:e.index,region:e,startOffset:t,onSelectRegion:o?void 0:i,renderable:s[0]<=n&&n<=s[1]},e.id):null))})},xi={View:e=>{var t;let{offset:n=0,position:o=1,length:i=1024,step:s,regions:r,onScroll:a,onPositionChange:l,onResize:d,onSelectRegion:c}=e,u=(0,Zn.A)(e,fi);const h=null!=(t=u.leftOffset)?t:150,g=(0,m.useRef)(),p=(0,m.useRef)(0),f=(0,m.useRef)(o),[v,y]=(0,m.useState)(!0),[b,S]=(0,m.useState)(null),[w,k]=(0,m.useState)(n),C=(0,m.useRef)(w),[j,R]=(0,m.useState)(0),[_,T]=(0,m.useState)(!1);C.current=w;const K=(0,m.useMemo)((()=>i*s),[i,s]),E=(0,m.useMemo)((()=>{var e,t;return vi(yi((null!=(e=null==(t=g.current)?void 0:t.clientWidth)?e:0)-h,s),s)}),[g.current,s,h]),P=jo({onPositionChange:l}),M=(0,m.useMemo)((()=>[`repeating-linear-gradient(90deg, var(--color-neutral-background) 1px, var(--color-neutral-background) ${s-1}px, rgba(255,255,255,0) ${s-1}px, rgba(255,255,255,0) ${s+1}px)`,"linear-gradient(0deg, var(--color-neutral-surface), rgba(255,255,255,0) 50%)"].join(", ")),[s]),D=(0,m.useCallback)((({left:e,top:t})=>{if(i&&(S(null),(0,x.isDefined)(t)&&j!==t&&R(t),(0,x.isDefined)(e)&&w!==e)){k(e);const t=vi(yi(e,s),s);null==a||a((0,li.clamp)(t,1,i))}}),[w,j,s,i]),O=(0,m.useCallback)((e=>{const t=vi(yi(e,s),s);null==P.onPositionChange||P.onPositionChange((0,li.clamp)(t+1,1,i))}),[s,i,o]),I=(0,m.useCallback)((e=>{const t=g.current;if(Math.abs(e.deltaX)>Math.abs(e.deltaY)){const n=t.scrollWidth-t.clientWidth,o=(0,li.clamp)(w+1.25*e.deltaX,0,n);D({left:o})}else{const n=t.scrollHeight-t.clientHeight,o=(0,li.clamp)(j+1.25*e.deltaY,0,n);D({top:o})}}),[g,w,j,D]),L=(0,m.useMemo)((()=>yi(w,s)),[w,s,i]),N=(0,m.useMemo)((()=>j),[j]),z=(0,m.useCallback)((e=>{y(!1);const t=e.target,n=t.offsetLeft+L,o=e.pageX,i=g.current.scrollWidth-t.clientWidth;let r=0;const a=e=>{const t=yi(e.pageX-o,s),a=(0,li.clamp)(n+t,0,i);a!==r&&(r=a,O(a))},l=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l),y(!0)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}),[L,O,s]),V=(0,m.useCallback)((e=>{if(g.current){const o=g.current.getBoundingClientRect().left,i=e.pageX-o-h,r=vi(i+L,s)+1,a=e.target.closest("[data-id]");if(a){var t,n;const[e,o]=[null==(t=a.dataset)?void 0:t.start,null==(n=a.dataset)?void 0:n.end];e===String(r)||o===String(r)?a.style.cursor="col-resize":"col-resize"===a.style.cursor&&(a.style.cursor="auto")}S(i>0?i:null)}}),[L,s]),H=(0,m.useCallback)((()=>{b&&(O(b+L),S(null))}),[b,L,s,O]),B=(0,m.useMemo)((()=>{const e=(0,li.clamp)(o,0,i)*s;return yi(e-L,s)+h}),[o,L,s,i]),F=(0,m.useCallback)((e=>{var t;const n=g.current.getBoundingClientRect(),o=n.left,i=n.width-h,r=e.target.closest("[data-id]"),a=e.pageX-o>h,l=a&&(!r||"new"===(null==(t=r.dataset)?void 0:t.id));let d,c;const m=e=>e.pageX-o-h+L,p=m(e);let f=vi(p,s)+1,v=!1;if(a&&O(p),l)d=null==u.onStartDrawing?void 0:u.onStartDrawing({frame:f}),c="new";else if(r&&a&&(d=null==u.onStartDrawing?void 0:u.onStartDrawing({region:r.dataset.id,frame:f}),d)){const{start:e,end:t}=d.ranges[0];c="edit",f===e?f=t:f===t&&(f=e),e===t&&(v=!0)}const b=e=>{const t=m(e),n=vi(t,s)+1;if(t>=L&&t<=i+L&&(y(!1),T(!0),O(t)),d)if(v)d.setRange([n,n],{mode:c});else{const[e,t]=n>f?[f,n]:[n,f];d.setRange([e,t],{mode:c})}},x=()=>{y(!0),T(!1),null==u.onFinishDrawing||u.onFinishDrawing({mode:c}),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",x)};document.addEventListener("mousemove",b),document.addEventListener("mouseup",x)}),[L,O]);(0,m.useEffect)((()=>{g.current&&(g.current.scrollLeft=L,g.current.scrollTop=N)}),[L,N]),(0,m.useEffect)((()=>{const e=g.current,t=t=>{const n=e.scrollTop,o=e.scrollHeight-e.clientHeight,i=Math.abs(t.deltaX)>Math.abs(t.deltaY),{deltaY:s}=t;!i&&(0===n&&s<0||n===o&&s>0)||t.preventDefault()};return e.addEventListener("wheel",t),()=>e.removeEventListener("wheel",t)}),[]),(0,m.useEffect)((()=>{null==d||d(vi(g.current.clientWidth,s))}),[K,s]),(0,m.useEffect)((()=>{const e=g.current;if((0,x.isDefined)(e)){const t=(0,li.clamp)(n*s,0,e.scrollWidth-e.clientWidth);p.current=yi(t,s),k(t)}}),[n,s]),(0,m.useEffect)((()=>{const e=g.current;if(!(0,x.isDefined)(e)||E<1)return;const t=vi(yi(C.current,s),s)+1,n=t+E-1,i=Math.abs(o-f.current);if(f.current=o,1===i&&(o<t||o>n)){if(o<t){const n=(0,li.clamp)((t-1-E)*s,0,e.scrollWidth-e.clientWidth);p.current=yi(n,s),D({left:n})}else if(o>n){const t=(0,li.clamp)(n*s,0,e.scrollWidth-e.clientWidth);p.current=yi(t,s),D({left:t})}return}const r=yi(o-1,E),a=(o-1)*s-p.current;(a>(E-1)*s||a<0)&&(D({left:r*s}),p.current=r*s)}),[o,E,s]);const W={"--view-height":u.height?`${u.height}px`:null,"--frame-size":`${s}px`,"--view-size":`${K}px`,"--offset":`${h}px`};return(0,A.jsxs)(Qe.eB,{name:"timeline-frames",style:W,children:[(0,A.jsxs)(Qe.Sl,{name:"controls",children:[(0,A.jsx)(Qe.Sl,{name:"indicator",onMouseDown:z,style:{left:(0,li.clamp)(B-s,h-s,K)}}),(0,x.isDefined)(b)&&v&&(0,A.jsx)(Qe.Sl,{name:"hover",style:{left:yi(b,s),marginLeft:h},"data-frame":vi(L+b,s)+1})]}),(0,A.jsx)(Qe.Sl,{name:"labels-bg",style:{width:h}}),(0,A.jsx)(Qe.Sl,{name:"scroll",ref:g,onWheel:I,onMouseMove:V,onMouseLeave:()=>S(null),onClickCapture:H,onMouseDown:F,children:(0,A.jsx)(Qe.Sl,{name:"filler",children:(0,A.jsx)(bi,{regions:r,scrollTop:N,startOffset:h,onSelectRegion:c,disabled:_})})}),(0,A.jsx)(Qe.Sl,{name:"background",style:{backgroundImage:M}})]})},Minimap:()=>{const{regions:e,length:t}=(0,m.useContext)(Ro),n=(0,m.useRef)(),[o,i]=(0,m.useState)(0),s=(0,m.useMemo)((()=>e.map((({id:e,color:t,sequence:n})=>({id:e,color:t,lifespans:ui(n,o)})))),[o,e]);return(0,m.useEffect)((()=>{(0,x.isDefined)(n.current)&&t>0&&i(n.current.clientWidth/t)}),[t]),(0,A.jsx)(Qe.eB,{ref:n,name:"minimap",children:s.slice(0,5).map((({id:e,color:t,lifespans:n})=>(0,A.jsx)(Qe.Sl,{name:"region",style:{"--color":t},children:n.map(((t,i)=>{const s=i+1===n.length,r=t.start*o,a=s&&t.enabled?"100%":t.width;return(0,A.jsx)(Qe.Sl,{name:"connection",style:{left:r,width:a}},`${e}${i}`)}))},e)))})},Controls:({onAction:e})=>{const{position:t,regions:n}=(0,m.useContext)(Ro),o=n.some((({selected:e,timeline:t})=>e&&!t)),i=(0,m.useMemo)((()=>{const e=n.find((e=>e.selected&&!e.timeline));return null==e?void 0:e.sequence.filter((({frame:e})=>e<=t)).slice(-1)[0]}),[n,t]),s=(null==i?void 0:i.frame)!==t,r=!1===(null==i?void 0:i.enabled),a=(0,m.useCallback)((n=>{s?null==e||e(n,"keypoint_add",{frame:t}):null==e||e(n,"keypoint_remove",{frame:i.frame})}),[e,s,t,null==i?void 0:i.frame]),l=(0,m.useCallback)((t=>{r?null==e||e(t,"lifespan_add",{frame:i.frame}):null==e||e(t,"lifespan_remove",{frame:i.frame})}),[e,r,null==i?void 0:i.frame]),d=(0,m.useMemo)((()=>s?(0,A.jsx)(Qn.ShN,{}):(0,A.jsx)(Qn.iwh,{})),[s,i]),c=(0,m.useMemo)((()=>r?(0,A.jsx)(Qn.rf7,{}):(0,A.jsx)(Qn.Ovv,{})),[i,r]);return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(oi,{onClick:a,disabled:!o,tooltip:"Toggle Keypoint",children:d}),(0,A.jsx)(oi,{onClick:l,disabled:!i,tooltip:"Toggle Interpolation",children:c})]})},settings:{stepSize:(e,t,n,o)=>((e,t,n)=>{const o=t.find((e=>e.selected));let i;return i=o?o.sequence.map((({frame:e})=>e)):Array.from(t.reduce(((e,{sequence:t})=>{const n=t.map((({frame:e})=>e));return new Set([...e,...n])}),new Set)).sort(((e,t)=>e-t)),((e,t,n)=>{var o;const i=e.filter((e=>-1===n?e<t:e>t));return null!=(o=i[-1===n?i.length-1:0])?o:t})(i,e,n)})(t,n,o),fastTravelSize:()=>10,playpauseHotkey:"media:playpause",stepBackHotkey:"media:step-backward",stepForwardHotkey:"media:step-forward",stepAltBack:"video:keyframe-backward",stepAltForward:"video:keyframe-forward",leftOffset:150,skipToBeginning:"video:rewind",skipToEnd:"video:fastforward",hopBackward:"video:hop-backward",hopForward:"video:hop-forward"}},Si=xi;var wi=n(35775),ki=n(41128);const Ci=(e,t)=>{const n=t>=250?14:e>=3600?11:14,o=t>=250?23:19;return new Date(1e3*e).toISOString().substring(n,o)},ji=e=>{let t=1;return t=e>=2500?.01:e>=1e3?.025:e>=250?.1:e>=100?.25:e>=25?1:5*e>=25?5:15*e>=25?15:60*Math.ceil(.5/e),t},Ri=e=>Math.floor(10/ji(e));var _i=n(25345);const Ti=({containter:e,timelineContainer:t,regions:n,speed:o,data:i,params:s,onLoaded:r,onSeek:a,onPlay:l,onPause:d,onPlayFinished:c,onAddRegion:u,onReady:h,onScroll:g,onZoom:p})=>{const f=(0,m.useRef)();return(0,m.useEffect)((()=>{var m,v;const y=e.current,b=Fn().create(Object.assign({autoCenter:!0,scrollParent:!0},s,{barHeight:1,container:y,height:Number(null!=(m=null==e||null==(v=e.current)||null==(v=v.parentElement)?void 0:v.offsetHeight)?m:146),hideScrollbar:!0,maxCanvasWidth:8e3,waveColor:"#D5D5D5",progressColor:"#656F83",cursorWidth:0,backend:"MediaElement",loopSelection:!0,audioRate:o,pixelRatio:1,minPxPerSec:wn.default,plugins:[wi.A.create({slop:5,deferInit:!0,dragSelection:!0}),ki.A.create({deferInit:!0,container:t.current,formatTimeCallback:Ci,timeInterval:ji,secondaryLabelInterval:Ri,primaryColor:"rgba(0,0,0,0.1)",secondaryColor:"rgba(0,0,0,0.1)",primaryFontColor:"rgba(0,0,0,0.4)",secondaryFontColor:"#000",labelPadding:5,unlabeledNotchColor:"#ccc",notchPercentHeight:50}),_i.A.create({wrapper:t.current,color:"#000",showTime:!0,followCursorY:"true",opacity:"1",padding:"20px"})]}));Object.assign(window,{wsi:b}),b.setCurrentTime=e=>{const t=b.getDuration();isNaN(t)||e===b.getCurrentTime()||(e=(0,x.clamp)(e,0,t),b.seekTo(e/b.getDuration()))};const S=()=>{Object.values(b.regions.list).filter((e=>!(0,x.isDefined)(e._region))).forEach((e=>e.remove()))};b.on("ready",(()=>{r(!1),b.initPlugin("regions"),b.initPlugin("timeline"),n&&(b.on("region-mouseenter",(e=>{var t;null==(t=e._region)||t.onMouseOver()})),b.on("region-mouseleave",(e=>{var t;null==(t=e._region)||t.onMouseLeave()})),b.on("region-created",(e=>{var t;const n=null==(t=i.annotation)?void 0:t.history;null==n||n.setSkipNextUndoState();const o=null==u?void 0:u(e);if(!o)return S(),void e.on("update-end",(()=>{const t=b.addRegion({start:e.start,end:e.end,resize:!1});t.on("click",(()=>t.remove()));const n=()=>{b.setCurrentTime(e.start),t.play()};t.on("out",(()=>{b.setCurrentTime(e.end),n()})),n()}));e._region=o,e.color=o.selectedregionbg,e.on("click",(e=>{o.onClick(b,e)})),e.on("dblclick",(t=>{t.preventDefault(),t.stopPropagation(),setTimeout((()=>{e.playLoop()}),0)})),e.on("update-end",(()=>{o.onUpdateEnd(b)}))}))),null==h||h({duration:b.getDuration(),surfer:b})})),b.setPlaybackRate(o),b.zoom(wn.default),b.on("scroll",(e=>g(e.target.scrollLeft))),b.on("play",(()=>{const e=b.getCurrentTime();a(1e3*e),null==l||l()})),b.on("pause",(()=>null==d?void 0:d())),b.on("finish",(()=>{null==c||c()})),b.on("zoom",(e=>null==p?void 0:p(e))),b.on("seek",(()=>{const e=b.getCurrentTime();a(1e3*e)})),i._value&&b.load(i._value),f.current=b;const w=()=>{S()};return y.addEventListener("click",w),()=>{y.removeEventListener("click",w);try{Object.entries(b.getActivePlugins()).forEach((([e,t])=>{t&&b.destroyPlugin(e)})),b.destroy()}catch(e){console.error("Error:",e)}}}),[]),f},Ai={frames:Si,wave:{View:({position:e,length:t,regions:n,volume:o=1,zoom:i=wn.default,speed:s=kn.default,onReady:r,onPositionChange:a,onSeek:l,onAddRegion:d,onZoom:c,onPlay:u,onPause:h,onSpeedChange:g})=>{const{data:p}=(0,m.useContext)(Ro),f=(0,m.useRef)(null),v=(0,m.useRef)(),y=(0,m.useRef)(),b=(0,m.useRef)(),S=(0,m.useRef)(),[w,k]=(0,m.useState)(i),[C,j]=(0,m.useState)(!0),[R,_]=(0,m.useState)(0),[T,K]=(0,m.useState)(0),[E,P]=(0,m.useState)(Number.parseInt(p.defaultscale,10)||1),M=(0,m.useRef)({zoom:w,scroll:R}),D=(0,m.useRef)(!1),O=(0,m.useCallback)((e=>{const t=(0,x.clamp)(e,wn.min,wn.max);M.current.zoom=t,k(t)}),[]),I=(0,m.useCallback)((()=>{D.current||(D.current=!0)}),[]),L=(0,m.useCallback)((()=>{D.current&&(D.current=!1)}),[]),N=(0,m.useRef)((()=>{const e=W.current;e&&(null==F.onPositionChange||F.onPositionChange(1e3*e.getCurrentTime()),e.getCurrentTime()!==e.getDuration()||D||I(),f.current=setTimeout(N.current))})),z=(0,m.useCallback)((()=>{const e=W.current;e&&!f.current&&(D.current&&(L(),e.setCurrentTime(0)),!0===e.isPlaying()&&(null==u||u()),N.current())}),[u,a]),V=(0,m.useCallback)((()=>{const e=W.current;!1===(null==e?void 0:e.isPlaying())&&(null==h||h()),f.current&&(clearTimeout(f.current),f.current=null)}),[h]),H=(0,m.useCallback)((e=>{var t;const n=null==(t=y.current)?void 0:t.querySelector("wave");M.current.scroll=e,n&&(n.scrollLeft=e)}),[]),B=(0,m.useCallback)((()=>{I(),V()}),[V,I]),F=jo({onZoom:c,onSeek:l,onPositionChange:a,onFinish:B,onPlay:z,onPause:V}),W=Ti({containter:y,timelineContainer:b,speed:s,regions:n,data:p,params:{autoCenter:p.autocenter,scrollParent:p.scrollparent,autoCenterImmediately:!0},onLoaded:j,onPlay:()=>{L(),F.onPlay()},onPause:()=>F.onPause(),onPlayFinished:()=>F.onFinish(),onAddRegion:d,onReady:r,onScroll:e=>{M.current.scroll=e,_(e)},onSeek:e=>{L(),null==F.onSeek||F.onSeek(e)},onZoom:e=>null==F.onZoom?void 0:F.onZoom(e)}),$=(0,m.useCallback)((e=>{var t,n;const o=y.current.querySelector("wave"),i=o.getBoundingClientRect().left,s=null==(t=W.current)?void 0:t.getDuration(),r=(o.scrollLeft+(e.clientX-i))/o.scrollWidth*(null!=s?s:0);null==(n=W.current)||n.setCurrentTime(r)}),[]);(0,m.useEffect)((()=>{var n;let o=0;const i=null==(n=y.current)||null==n.querySelector?void 0:n.querySelector("wave");if(i&&t>0){const n=e/t;o=i.scrollWidth*n-i.scrollLeft}K(o)}),[e,t,i,w,R,C]),(0,m.useEffect)((()=>{(()=>{const t=W.current,n=null==t?void 0:t.getDuration(),o=null==t?void 0:t.getCurrentTime(),i=(0,x.clamp)(e/1e3,0,null!=n?n:0);t&&(t.isPlaying()||n&&!isNaN(n)&&i!==o&&t.setCurrentTime(i))})()}),[e]),(0,m.useEffect)((()=>{requestAnimationFrame((()=>{var e;const t=W.current;t&&t.params.minPxPerSec!==w&&(null==(e=W.current)||e.zoom(w)),H(M.current.scroll)}))}),[w,R]),(0,m.useEffect)((()=>{var e;null==(e=W.current)||e.setPlaybackRate(s)}),[s]),(0,m.useEffect)((()=>{H(R)}),[R]),(0,m.useEffect)((()=>{var e;null==(e=W.current)||e.setVolume(o)}),[o]),(0,m.useEffect)((()=>{const e=W.current;e&&(e.params.barHeight=E,e.drawBuffer())}),[E]),(0,m.useEffect)((()=>{const e=new X((()=>{const e=W.current;requestAnimationFrame((()=>{e&&e.drawBuffer(),H(M.current.scroll)}))}));return v.current&&e.observe(v.current),()=>{e.disconnect()}}),[]),(0,m.useEffect)((()=>{const e=S.current,t=e.querySelector("wave"),n=(0,x.isMacOS)(),o=e=>{const o=Math.abs(e.deltaY)>Math.abs(e.deltaX),i=Math.abs(e.deltaY)<Math.abs(e.deltaX);if(e.ctrlKey&&o)return e.preventDefault(),void requestAnimationFrame((()=>{O(Math.round(w+1.2*-e.deltaY))}));(i&&n||o||e.shiftKey)&&e.preventDefault();_((()=>{const o=!n||e.shiftKey?e.deltaY:e.deltaX;return(0,x.clamp)(t.scrollLeft+1.25*o,0,t.scrollWidth)})())};return e.addEventListener("wheel",o),()=>e.removeEventListener("wheel",o)}),[w]);const U=(0,m.useMemo)((()=>{var e;return{left:T,width:Number(null!=(e=p.cursorwidth)?e:2),background:p.cursorcolor}}),[T]);return(0,A.jsxs)(Qe.eB,{name:"wave",ref:v,children:[(0,A.jsx)(Qe.Sl,{name:"controls",children:(0,A.jsxs)(Oo,{spread:!0,style:{gridAutoColumns:"auto"},children:[(0,A.jsx)(Vo,{continuous:!0,value:s,resetValue:kn.default,step:kn.step,min:kn.min,max:kn.max,minIcon:(0,A.jsx)(To.f3x,{style:{color:"#99A0AE"}}),maxIcon:(0,A.jsx)(To.ite,{style:{color:"#99A0AE"}}),onChange:e=>null==g?void 0:g(Number(e))}),(0,A.jsx)(Vo,{continuous:!0,value:w,resetValue:wn.default,step:wn.step,min:wn.min,max:wn.max,minIcon:(0,A.jsx)(To.Nin,{}),maxIcon:(0,A.jsx)(To.mc3,{}),onChange:e=>O(Number(e))})]})}),(0,A.jsxs)(Qe.Sl,{name:"wrapper",children:[(0,A.jsxs)(Qe.Sl,{name:"body",ref:S,onClick:$,children:[(0,A.jsx)(Qe.Sl,{name:"cursor",style:U}),(0,A.jsx)(Qe.Sl,{name:"surfer",ref:y,onClick:e=>e.stopPropagation()}),(0,A.jsx)(Qe.Sl,{name:"timeline",ref:b}),C&&(0,A.jsx)(Qe.Sl,{name:"loader",mod:{animated:!0}})]}),(0,A.jsx)(Qe.Sl,{name:"scale",children:(0,A.jsx)(Vo,{min:1,max:50,step:.1,reverse:!0,continuous:!0,value:E,resetValue:1,align:"vertical",onChange:e=>P(Number(e))})})]})]})},settings:{playpauseHotkey:"media:playpause",stepBackHotkey:"media:step-backward",stepForwardHotkey:"media:step-forward"}}},Ki=["regions","zoom","mode","length","position","framerate","hopSize","playing","fullscreen","disableView","defaultStepSize","allowSeek","allowFullscreen","allowViewCollapse","controlsOnTop","data","speed","className","formatPosition"],Ei=(0,v.PA)((e=>{var t,n;let{regions:o,zoom:i=1,mode:s="frames",length:r=1024,position:a=1,framerate:l=24,hopSize:d=1,playing:c=!1,fullscreen:u=!1,disableView:h=!1,defaultStepSize:g=10,allowSeek:p=!0,allowFullscreen:f=!0,allowViewCollapse:v=!0,controlsOnTop:y=!0,data:b,speed:S,className:w,formatPosition:k}=e,C=(0,Zn.A)(e,Ki);const j=Ai[s],[R,_]=(0,m.useState)((0,x.clamp)(a,1,Number.POSITIVE_INFINITY)),[T,K]=(0,m.useState)(0),[E,P]=(0,m.useState)(0),[M,D]=((e,t,n={})=>{var o;const i=localStorage.getItem(e),s=i?null!=(o=null==n.fromString?void 0:n.fromString(i))?o:i:t,[r,a]=(0,m.useState)(s);return[r,t=>{var o;const i=null!=(o=null==n||null==n.toString?void 0:n.toString(t))?o:t.toString();localStorage.setItem(e,i),a(t)}]})("video-timeline",!1,{fromString:e=>"true"===e,toString:e=>String(e)}),O=(0,m.useRef)((()=>R)),I=(0,m.useMemo)((()=>g*i),[i,g]),L=jo({onReady:C.onReady,onPlay:C.onPlay,onPause:C.onPause,onSeek:C.onSeek,onPositionChange:C.onPositionChange,onToggleVisibility:C.onToggleVisibility,onAddRegion:C.onAddRegion,onDeleteRegion:C.onDeleteRegion,onSelectRegion:C.onSelectRegion,onStartDrawing:C.onStartDrawing,onFinishDrawing:C.onFinishDrawing,onAction:C.onAction,onFullscreenToggle:C.onFullscreenToggle,onSpeedChange:C.onSpeedChange}),N=e=>{_((t=>{const n=(0,x.clamp)(e,1,r);return n!==t?(null==L.onPositionChange||L.onPositionChange(n),n):t}))},z=(0,m.useMemo)((()=>({position:a,length:r,regions:o,step:I,data:b,playing:c,seekOffset:T,settings:j.settings,visibleWidth:E})),[a,T,E,r,o,I,c,j.settings,b]);(0,m.useEffect)((()=>{const e=O.current();a!==e&&_((0,x.clamp)(a,1,r))}),[a,r]);const V=(0,A.jsxs)(Qe.Sl,{name:"topbar",children:[(0,A.jsx)(ni,{length:r,position:R,frameRate:l,playing:c,volume:C.volume,controls:C.controls,altHopSize:C.altHopSize,customControls:C.customControls,collapsed:M,onPlay:()=>null==L.onPlay?void 0:L.onPlay(),onPause:()=>null==L.onPause?void 0:L.onPause(),fullscreen:u,disableFrames:h,allowFullscreen:f,allowViewCollapse:v,onFullScreenToggle:e=>null==L.onFullscreenToggle?void 0:L.onFullscreenToggle(e),onVolumeChange:C.onVolumeChange,onStepBackward:(e,t)=>{var n;const i=null!=(n=null==t?void 0:t(r,R,o,-1))?n:R-d;N(i)},onStepForward:(e,t)=>{var n;const i=null!=(n=null==t?void 0:t(r,R,o,1))?n:R+d;N(i)},onRewind:e=>N((0,x.isDefined)(e)?R-e:0),onForward:e=>N((0,x.isDefined)(e)?R+e:r),onPositionChange:N,onToggleCollapsed:D,formatPosition:k,extraControls:j.Controls&&!h?(0,A.jsx)(j.Controls,{onAction:(e,t,n)=>{null==L.onAction||L.onAction(e,t,n)}}):null,mediaType:"timeline"}),p&&(0,A.jsx)(ci,{length:r,step:I,leftOffset:null==(t=j.settings)?void 0:t.leftOffset,position:R,seekOffset:T,seekVisible:E,onIndicatorMove:K,onSeek:N,minimap:j.Minimap?(0,A.jsx)(j.Minimap,{}):null})]});o.map((e=>(0,x.fixMobxObserve)(e.sequence)));const H=!M&&!h&&(0,A.jsx)(Qe.Sl,{name:"view",children:(0,A.jsx)(j.View,{step:I,length:r,regions:o,playing:c,zoom:i,speed:S,volume:C.volume,controls:C.controls,height:C.height,position:R,offset:T,leftOffset:null==(n=j.settings)?void 0:n.leftOffset,onReady:e=>null==L.onReady?void 0:L.onReady(e),onScroll:K,onResize:P,onPositionChange:N,onPlay:()=>null==L.onPlay?void 0:L.onPlay(),onPause:()=>null==L.onPause?void 0:L.onPause(),onSeek:e=>null==L.onSeek?void 0:L.onSeek(e),onToggleVisibility:(e,t)=>null==L.onToggleVisibility?void 0:L.onToggleVisibility(e,t),onAddRegion:e=>null==L.onAddRegion?void 0:L.onAddRegion(e),onDeleteRegion:e=>null==L.onDeleteRegion?void 0:L.onDeleteRegion(e),onSelectRegion:(e,t,n)=>null==L.onSelectRegion?void 0:L.onSelectRegion(e,t,n),onStartDrawing:e=>null==L.onStartDrawing?void 0:L.onStartDrawing(e),onFinishDrawing:e=>null==L.onFinishDrawing?void 0:L.onFinishDrawing(e),onSpeedChange:e=>null==L.onSpeedChange?void 0:L.onSpeedChange(e),onZoom:C.onZoom})});return(0,A.jsx)(_o,{value:z,children:(0,A.jsx)(Qe.eB,{name:"timeline",className:w,children:y?(0,A.jsxs)(A.Fragment,{children:[V,H]}):(0,A.jsxs)(A.Fragment,{children:[H,V]})})})})),Pi=(e,t)=>{const n=Number(e);return isNaN(e)?t.default:n<t.min?t.min:n>t.max?t.max:n},Mi=(0,v.PA)((({item:e})=>{const[t,n]=(0,m.useState)(!1),[o,i]=(0,m.useState)(1),[s,r]=(0,m.useState)(0),[a,l]=(0,m.useState)(Pi(e.defaultzoom,wn)),[d,c]=(0,m.useState)(Pi(e.defaultvolume,Cn)),[u,h]=(0,m.useState)(Pi(e.defaultspeed,kn)),g=(0,m.useCallback)((t=>{r(1e3*t.duration),e.onLoad(t.surfer),e.onReady()}),[]),p=(0,m.useCallback)((e=>{i(e)}),[]),f=(0,m.useCallback)((t=>{i(t),e.handleSeek()}),[]),v=(0,m.useCallback)((t=>{h(t),e.handleSpeed(t)}),[]),y=(0,m.useCallback)((({time:e,fps:t})=>{const n=Math.floor(t),o=Math.floor(1e3*e%n);return Math.floor(e>=0?o:n).toString().padStart(3,"0")}),[]),b=(0,m.useCallback)((()=>{n((t=>!!e._ws&&(!1===e._ws.isPlaying()&&e._ws.play(),!1===t?(e.triggerSyncPlay(),!0):t)))}),[e,t]),x=(0,m.useCallback)((()=>{n((t=>{if(!e._ws)return!1;var n;!0===e._ws.isPlaying()&&(null==(n=e._ws)||null==n.pause||n.pause());return!0===t?(e.triggerSyncPause(),!1):t}))}),[e,t]);return(0,A.jsx)(Kn,{item:e,children:(0,A.jsx)(Qe.eB,{mode:"wave",name:"audio",tag:Ei,framerate:1e3,hopSize:1e3,playing:t,regions:e.regions,data:e,zoom:a,speed:u,volume:d,controls:{AudioVolumeControl:e.volume,SpeedControl:e.speed,ZoomControl:e.zoom},defaultStepSize:16,length:s,position:o,allowSeek:!1,allowFullscreen:!1,allowViewCollapse:!1,controlsOnTop:!1,onReady:g,onAddRegion:e.addRegion,onSelectRegion:e.selectRegion,onPositionChange:p,onSeek:f,onPlay:b,onPause:x,onZoom:l,onVolumeChange:c,onSpeedChange:v,formatPosition:y})})}));function Di(e,t){try{return JSON.parse(e)}catch(e){return t}}function Oi(e){return JSON.stringify(e)}const Ii=(e,t)=>((e,t,n={})=>{const{decoder:o,encoder:i}=n,s=(0,m.useMemo)((()=>{var n;const i=localStorage.getItem(e);return"string"==typeof i?null!=(n=null==o?void 0:o(i,t))?n:i:t}),[]),[r,a]=(0,m.useState)(s),l=(0,m.useCallback)((t=>{a((n=>{var o;const s=t instanceof Function?t(n):t,r=null!=(o=null==i?void 0:i(s))?o:s.toString();return localStorage.setItem(e,r),s}))}),[]);return[r,l]})(e,t,{decoder:Di,encoder:Oi}),Li=!1,Ni="OffscreenCanvas"in globalThis;let zi=function(e){return e[e.timelineHeight=32]="timelineHeight",e.timelinePlacement="top",e}({});const Vi=(e="log")=>(...e)=>{Li},Hi=(Vi("log"),Vi("warn")),Bi=(Vi("error"),Vi("info")),Fi=(e,t,n)=>Math.max(t,Math.min(n,e)),Wi=(e,t=2)=>{const n=10**t;return Math.round(e*n)/n},$i=(e,t,n)=>e>=t&&e<=n,Ui=(e,t)=>Array.from({length:t}).map((()=>e)).join(""),Yi=e=>{const[t,n]=(e=>{const t=e.length;if(t>0){let n,o,i=0;for(n=o=e[0];i<t;){const t=e[i];t>n?n=t:t<o&&(o=t),i++}return[o,n]}return[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY]})(e);return[Fi(t,-1,1),Fi(n,-1,1)]},Xi=e=>e.getBoundingClientRect().left,Gi=e=>e.getBoundingClientRect().top,Zi=(e,t)=>e.clientX-Xi(t),qi=(e,t)=>e.clientY-Gi(t),Ji=(e,t,n)=>e/t*n,Qi=(e,t,n)=>{const{zoomedWidth:o,container:i}=t,s=Zi(e,i)+t.getScrollLeftPx();return Ji(s,o,n)},es=(e,t,n)=>((e,t)=>Math.abs(e-t)<1e-6)(e/n,t/n),ts=(()=>{const e=document.createElement("div");e.style.width="100px",e.style.height="100px",e.style.overflow="scroll",e.style.position="absolute",e.style.top="-9999px",document.body.appendChild(e);const t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t})();class ns{constructor(){this.destroyed=!1}get isDestroyed(){return this.destroyed}destroy(){this.destroyed=!0,this.destroy=()=>null}}class os extends ns{constructor(...e){super(...e),this.subscriptions=new Map}on(e,t){const n=this.getSubscriptions(e);!1===n.has(t)&&n.add(t)}off(e,t){const n=this.getSubscriptions(e);n.has(t)&&n.delete(t)}invoke(e,t){this.getSubscriptions(e).forEach((e=>e(...null!=t?t:[])))}removeAllListeners(){this.subscriptions.forEach((e=>e.clear())),this.subscriptions.clear()}destroy(){this.removeAllListeners(),this.on=()=>null,this.off=()=>null,this.invoke=()=>null,this.removeAllListeners=()=>null,super.destroy()}getSubscriptions(e){var t;const n=null!=(t=this.subscriptions.get(e))?t:new Set;return this.subscriptions.set(e,n),n}}class is extends os{constructor(e){super(),this.src=e,this.chunks=void 0,this.cancelled=!1,this.decodeId=0,this._dataLength=0,this._dataSize=0,this._channelCount=1,this._sampleRate=44100,this._duration=0,this.decodingResolve=void 0,this.decodingPromise=void 0,this.buffer=void 0,this.removalId=null}get channelCount(){return this._channelCount}get sampleRate(){return this._sampleRate}get duration(){return this._duration}get dataLength(){var e,t;this.chunks&&!this._dataLength&&(this._dataLength=(null!=(e=null==(t=this.chunks)?void 0:t.reduce(((e,t)=>e+t.reduce(((e,t)=>e+t.length),0)),0))?e:0)/this._channelCount);return this._dataLength}get dataSize(){var e,t;this.chunks&&!this._dataSize&&(this._dataSize=(null!=(e=null==(t=this.chunks)?void 0:t.reduce(((e,t)=>e+t.reduce(((e,t)=>e+t.byteLength),0)),0))?e:0)/this._channelCount);return this._dataSize}get sourceDecoded(){return void 0!==this.chunks}get sourceDecodeCancelled(){return this.cancelled&&0===this.decodeId}cancel(){this.cancelled||Bi("decode:cancelled",this.src),this.cancelled=!0,this.decodeId=0,this.dispose()}renew(){this.cancelled=!1}destroy(){super.removeAllListeners(),this.cancel()}cleanupResolvers(){var e;null==(e=this.decodingResolve)||e.call(this),this.decodingResolve=void 0,this.decodingPromise=void 0,Bi("decode:cleanup",this.src)}}class ss extends is{constructor(...e){super(...e),this.arraybuffer=void 0,this.context=void 0}async init(e){this.arraybuffer=e,Bi("decode:worker:ready",this.src)}async decode(e){if(this.sourceDecoded)Bi("decode:cached",this.src);else{if(this.sourceDecodeCancelled)throw new Error("WebAudioDecoder decode cancelled and contains no data, did you call decoder.renew()?");if(this.decodingPromise)return Bi("decode:inprogress",this.src),this.decodingPromise;if(!this.arraybuffer)throw new Error("WebAudioDecoder not initialized, did you call decoder.init()?");Bi("decode:start",this.src),this.decodeId=Date.now(),this.decodingPromise=new Promise((e=>this.decodingResolve=e));try{const t=await new Promise(((e,t)=>{if(this.context||(this.context=this.createOfflineAudioContext()),!this.context||!this.arraybuffer)return t(new Error("WebAudioDecoder not initialized, did you call decoder.init()?"));var n,o;"webkitAudioContext"in window?null==(n=this.context)||n.decodeAudioData(this.arraybuffer,(t=>e(t)),(e=>t(e))):null==(o=this.context)||o.decodeAudioData(this.arraybuffer).then(e).catch(t)}));this._channelCount=null!=e&&e.multiChannel?t.numberOfChannels:1,this._sampleRate=t.sampleRate,this._duration=t.duration;const n=Array.from({length:this._channelCount}).map((()=>Array.from({length:1})));return n.forEach(((e,o)=>{n[o]=[t.getChannelData(o)]})),this.chunks=n,Bi("decode:complete",this.src),null!=e&&e.captureAudioBuffer&&(this.buffer=t),t}finally{this.dispose()}}}dispose(){delete this.arraybuffer,delete this.context,this.cleanupResolvers()}createOfflineAudioContext(e){return window.WebAudioOfflineAudioContext||(window.WebAudioOfflineAudioContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,null!=e?e:this.sampleRate)),window.WebAudioOfflineAudioContext}}var rs=n(55961),as=n(14280);class ls{constructor(e){this.worker=void 0,this.worker=e}async compute(e){var t;const n=await this.sendMessage(this.worker,{data:e,type:"compute"},!0);return null==n||null==(t=n.data)||null==(t=t.result)?void 0:t.data}async precompute(e){await this.sendMessage(this.worker,{data:e,type:"precompute"})}async store(e){await this.sendMessage(this.worker,{data:e,type:"store"})}async getStorage(){var e;const t=await this.sendMessage(this.worker,{type:"getStorage"},!0);return null==t||null==(e=t.data)?void 0:e.result}destroy(){this.worker.terminate()}sendMessage(e,t,n=!1){return new Promise((o=>{const i=Math.random().toString();if(n){const t=n=>{i===n.data.eventId&&(e.removeEventListener("message",t),o(n))};e.addEventListener("message",t)}e.postMessage(Object.assign({},t,{eventId:i})),n||o(void 0)}))}}ls.Messenger={receive({compute:e,precompute:t}){const n={};self.addEventListener("message",(o=>{if(!o.data)return;const{data:i,type:s,eventId:r}=o.data;switch(s){case"compute":((t,o)=>{e(t,n,(e=>{self.postMessage({result:e,eventId:o})}))})(i,r);break;case"precompute":(e=>{null==t||t(e,n,(e=>{Object.assign(n,e)}))})(i);break;case"store":(e=>{Object.assign(n,e.data.data)})(o);break;case"getStorage":(e=>{self.postMessage({result:n,eventId:e})})(r)}}))}};class ds extends ns{constructor(e){super(),this.channelCount=1,ds.usage++,ds.worker||(ds.worker=new ls(new Worker(new URL(n.p+n.u(559),n.b)))),this.channelCount=e}destroy(){var e;(ds.usage--,0===ds.usage)&&(null==(e=ds.worker)||e.destroy(),ds.worker=void 0);super.destroy()}async split(e){if(!ds.worker)throw new Error("AudioDecoder: worker not initialized");return ds.worker.compute({value:e,channelCount:this.channelCount})}}ds.usage=0,ds.worker=void 0;class cs extends is{constructor(...e){super(...e),this.worker=void 0}getTotalChunks(){return Math.ceil(this._duration*this._channelCount/1800)}getChunkDuration(){return 1800/this._channelCount}async init(e){this.worker||(this.worker=await(0,rs.vy)(as.A,e),Bi("decode:worker:ready",this.src))}async decode(e){if(this.sourceDecoded)return void Bi("decode:cached",this.src);if(this.sourceDecodeCancelled)throw new Error("AudioDecoder: Worker decode cancelled and contains no data, did you call decoder.renew()?");if(this.decodingPromise)return Bi("decode:inprogress",this.src),this.decodingPromise;if(!this.worker)throw new Error("AudioDecoder: Worker not initialized, did you call decoder.init()?");let t;Bi("decode:start",this.src),this.decodeId=Date.now(),this.decodingPromise=new Promise((e=>this.decodingResolve=e));try{this._channelCount=null!=e&&e.multiChannel?this.worker.channelCount:1,this._sampleRate=this.worker.sampleRate,this._duration=this.worker.duration;let n=0;const o=this.getTotalChunks(),i=this.chunkDecoder(e);t=this._channelCount>1?new ds(this._channelCount):void 0;const s=Array.from({length:this._channelCount}).map((()=>Array.from({length:o})));for(Bi("decode:chunk:start",this.src,n,o),this.invoke("progress",[0,o]);n<o;){if(this.sourceDecodeCancelled)return;const e=i.next();if(!e.done){const i=await e.value;if(this.sourceDecodeCancelled)return;if(i)if(1===this._channelCount)s[0][n]=i;else{if(!t)throw new Error("AudioDecoder: splitChannels not initialized");const e=await t.split(i);if(this.sourceDecodeCancelled)return;e.forEach(((e,t)=>{s[t][n]=e}))}this.invoke("progress",[n+1,o]),Bi("decode:chunk:process",this.src,n,o),n++}if(e.done)break}this.chunks=s,Bi("decode:complete",this.src)}finally{var n;null==(n=t)||n.destroy(),this.dispose()}}dispose(){this.worker&&(this.worker.dispose(),this.worker=void 0,Bi("decode:worker:disposed",this.src)),this.cleanupResolvers()}*chunkDecoder(e){if(!this.worker||this.sourceDecodeCancelled)return null;const t=this.worker.duration;let n=-1;for(;;)yield new Promise(((o,i)=>{var s;if(!this.worker||this.sourceDecodeCancelled)return o(null);const r=Fi(t-n,0,this.getChunkDuration()),a=n;n+=r,this.worker.decodeAudioData(a,r,Object.assign({multiChannel:null!=(s=null==e?void 0:e.multiChannel)&&s},e)).then(o).catch(i)}))}}class us{getDecoder(e,t,n="ffmpeg"){const o=function(e,t,n,o="ffmpeg"){var i;const s=`${t}:${n}:${o}`,r=null!=(i=e.get(s))?i:"ffmpeg"===o?new cs(t):new ss(t);return r.renew(),e.set(s,r),new Proxy(r,{get(t,n){if(n in t){const t=e.get(s);null!=t&&t.removalId&&(clearTimeout(t.removalId),Bi("decode:renew",s),t.removalId=null,t.renew(),e.set(s,t));const o=t[n];return"destroy"===n&&"function"==typeof o?(...n)=>(t.removalId=setTimeout((()=>{Bi("decodepool:destroy",s),e.delete(s)}),5e3),e.set(s,t),o.bind(t)(...n)):o}}})}(us.cache,e,t,n);return o}}us.cache=new Map;const hs=new us;class gs extends os{constructor(e){var t,n,o;super(),this.decoder=void 0,this.decoderPromise=void 0,this.mediaPromise=void 0,this.mediaReject=void 0,this.el=void 0,this.buffer=void 0,this.splitChannels=!1,this.decoderType="ffmpeg",this.playerType="html5",this.src=void 0,this.mediaResolve=void 0,this.hasLoadedSource=!1,this.mediaError=()=>{var e,t;(0,j.VS)(j.xS)&&this.hasLoadedSource&&this.el?(this.hasLoadedSource=!1,this.invoke("resetSource")):null==(e=this.mediaReject)||e.call(this,null==(t=this.el)?void 0:t.error)},this.mediaReady=()=>{var e;this.mediaResolve&&(null==(e=this.mediaResolve)||e.call(this),this.mediaResolve=void 0);this.hasLoadedSource=!0,this.invoke("canplay")},this.splitChannels=null!=(t=e.splitChannels)&&t,this.decoderType=null!=(n=e.decoderType)?n:this.decoderType,this.playerType=null!=(o=e.playerType)?o:this.playerType,this.src=e.src,this.createAudioDecoder(),this.createMediaElement()}get channelCount(){var e;return(null==(e=this.decoder)?void 0:e.channelCount)||1}get duration(){var e,t,n,o;return this.el?null!=(e=null==(t=this.el)?void 0:t.duration)?e:0:null!=(n=null==(o=this.decoder)?void 0:o.duration)?n:0}get sampleRate(){var e;return(null==(e=this.decoder)?void 0:e.sampleRate)||44100}get dataLength(){var e;return(null==(e=this.decoder)?void 0:e.dataLength)||0}get dataSize(){var e;return(null==(e=this.decoder)?void 0:e.dataSize)||0}disconnect(){var e;try{this.el&&!this.el.paused&&this.el.pause()}catch(e){}null==(e=this.decoder)||e.cancel()}destroy(){var e,t,n,o;super.destroy(),this.disconnect(),delete this.mediaResolve,delete this.mediaReject,delete this.mediaPromise,delete this.decoderPromise,null==(e=this.decoder)||e.destroy(),delete this.decoder,null==(t=this.el)||t.removeEventListener("error",this.mediaReady),null==(n=this.el)||n.removeEventListener("canplaythrough",this.mediaReady),null==(o=this.el)||o.remove(),delete this.el,delete this.buffer}get chunks(){if(this.decoder)return this.decoder.chunks}async sourceDecoded(){if(!this.decoder)return!1;try{return this.mediaPromise&&await this.mediaPromise,this.decoderPromise&&await this.decoderPromise,"webaudio"===this.playerType&&this.decoder.buffer&&(this.buffer=this.decoder.buffer),this.decoder.sourceDecoded}catch(e){return console.error(e),!1}}async initDecoder(e){if(this.decoder)return!this.decoderPromise&&e&&(this.decoderPromise=this.decoder.init(e)),this.decoderPromise}async decodeAudioData(e={}){if(!this.decoder)return;e.captureAudioBuffer="webaudio"===this.playerType;const t=await this.decoder.decode(e);e.captureAudioBuffer&&t&&(this.buffer=t)}createMediaElement(){this.src&&!this.el&&"html5"===this.playerType&&(this.el=document.createElement("audio"),this.el.preload="auto",this.el.setAttribute("data-testid","waveform-audio"),this.el.style.display="none",(0,j.VS)(j.xS)&&(this.el.crossOrigin="anonymous"),document.body.appendChild(this.el),this.mediaPromise=new Promise(((e,t)=>{this.mediaResolve=e,this.mediaReject=t})),this.el.addEventListener("canplaythrough",this.mediaReady),this.el.addEventListener("error",this.mediaError),this.loadMedia())}loadMedia(){this.src&&this.el&&(this.el.src=this.src)}createAudioDecoder(){this.src&&!this.decoder&&(this.decoder=hs.getDecoder(this.src,this.splitChannels,this.decoderType),this.decoder.on("progress",((e,t)=>{this.invoke("decodingProgress",[e,t])})))}}class ms extends ns{constructor(e,t){super(),this.wf=void 0,this.audio=void 0,this.loaded=!1,this.options=void 0,this.cancel=void 0,this.decoderResolve=void 0,this._duration=0,this.decoderPromise=void 0,this.loadingProgressType=void 0,this.wf=e,this.options=t,this.cancel=()=>{},this.loadingProgressType="determinate"}get duration(){return this._duration}set duration(e){const t=this._duration!==e;this._duration=e,t&&this.wf.invoke("durationChanged",[e])}get sampleRate(){var e;return(null==(e=this.audio)?void 0:e.sampleRate)||0}reset(){this.cancel(),this.loaded=!1,this.loadingProgressType="determinate",this.decoderResolve=void 0,this.decoderPromise=void 0}async decodeAudioData(){return!this.audio||this.isDestroyed?null:await this.audio.decodeAudioData({multiChannel:this.wf.params.splitChannels})}async load(e){if(this.isDestroyed||this.loaded)return null;if(this.decoderPromise=new Promise((e=>{this.decoderResolve=e})),this.createAnalyzer(Object.assign({},e,{src:this.options.src,splitChannels:this.wf.params.splitChannels,decoderType:this.wf.params.decoderType,playerType:this.wf.params.playerType})),!this.audio)throw new Error("MediaLoader: Failed to allocate audio decoder");var t;if(await this.audio.sourceDecoded())return this.duration=this.audio.duration,null==(t=this.decoderResolve)||t.call(this),this.audio;const n=await this.performRequest(this.options.src).catch((e=>(console.error("An audio loading error occurred",e),null)));if(n)try{var o,i;return await this.audio.initDecoder(n),null==(o=this.decoderResolve)||o.call(this),this.audio?(this.duration=this.audio.duration,await this.decodeAudioData(),null!=(i=this.audio)?i:null):null}catch(e){this.wf.setError(`An error occurred while decoding the audio file. Please select another file or try again. ${e.message}`),console.error("An audio decoding error occurred",e)}return null}destroy(){this.isDestroyed||(super.destroy(),this.reset(),this.audio&&(this.audio.destroy(),this.audio=null))}async performRequest(e){var t=this;const n=new XMLHttpRequest;return this.cancel=()=>{null==n||n.abort(),this.cancel=()=>{}},new Promise(((o,i)=>{n.responseType="arraybuffer";const s=()=>{const e=new Error(`HTTP error status: ${n.status}`);e.name="HTTPError",this.wf.setError(`HTTP error status: ${n.status}`,e),i(n)};n.addEventListener("progress",(e=>{e.lengthComputable?(this.loadingProgressType="determinate",this.wf.setLoadingProgress(e.loaded,e.total)):(this.loadingProgressType="indeterminate",this.wf.setLoadingProgress(e.loaded,-1))})),n.addEventListener("load",(async function(){t.wf.setLoadingProgress(void 0,void 0,!0),o(n.response)})),n.addEventListener("error",(()=>{s()})),n.addEventListener("readystatechange",(()=>{4===n.readyState&&200!==n.status&&0!==n.status&&s()}));const r=new URL(e,/^https?/.exec(e)?void 0:window.location.href);["X-Goog-Signature","X-Amz-Signature","sig"].some((e=>r.searchParams.has(e)))||r.searchParams.set("lsref","1"),n.open("GET",r.toString(),!0),n.send()}))}createAnalyzer(e){return this.audio||(this.audio=new gs(e),this.audio.on("decodingProgress",((e,t)=>{this.wf.setDecodingProgress(e,t)}))),this.audio}}class ps extends ns{constructor(e){var t,n;super(),this.audio=void 0,this.wf=void 0,this.timer=void 0,this.loop=null,this.timestamp=0,this.time=0,this.connected=!1,this.bufferPromise=void 0,this.bufferResolve=void 0,this.ended=!1,this._rate=1,this._volume=1,this._savedVolume=1,this.playing=!1,this.hasPlayed=!1,this.handlePlayed=()=>{this.hasPlayed=!0},this.handlePaused=()=>{this.hasPlayed=!1},this.handleEnded=()=>{this.loop||this.updateCurrentTime(!0)},this.handleCanPlay=()=>{var e;null==(e=this.bufferResolve)||e.call(this)},this.watch=()=>{this.playing&&(this.updateCurrentTime(),this.updateLoop(this.time),this.timer=requestAnimationFrame(this.watch))},this.wf=e,this._rate=null!=(t=e.params.rate)?t:this._rate,this.volume=null!=(n=e.params.volume)?n:this._volume,this._savedVolume=this.volume,e.params.muted&&(this.muted=!0)}get currentTime(){return this.time}set currentTime(e){this.ended=!1,this.setCurrentTime(e,!0)}setCurrentTime(e,t=!1){const n=this.time!==e;this.time=e,this.updateCurrentSourceTime(n),t&&n&&this.wf.invoke("seek",[this.time])}canPause(){return this.hasPlayed}get volume(){var e;return null!=(e=this._volume)?e:1}set volume(e){this.volume!==e&&(0===e?this.muted=!0:this.muted?this.muted=!1:this._volume=e,this.adjustVolume(),this.wf.invoke("volumeChanged",[this.volume]))}get muted(){return 0===this._volume}set muted(e){this.muted!==e&&(e?this.mute():this.unmute(),this.wf.invoke("muted",[this.muted]))}mute(){this._savedVolume=this.volume||1,this._volume=0}unmute(){this._volume=this._savedVolume||1}get rate(){return this._rate}set rate(e){const t=this._rate!==e;this._rate=e,t&&this.wf.invoke("rateChanged",[e])}get duration(){var e,t;return null!=(e=null==(t=this.audio)?void 0:t.duration)?e:0}init(e){this.audio=e,this.audio.on("canplay",this.handleCanPlay)}seek(e){const t=Fi(e,0,this.duration);this.currentTime=t,this.playing&&this.updatePlayback()}seekSilent(e){const t=Fi(e,0,this.duration);this.ended=!1,this.setCurrentTime(t),this.playing&&this.updatePlayback()}play(e,t){if(this.isDestroyed||this.playing||!this.audio)return;this.ended&&(this.currentTime=null!=e?e:0);const{start:n,end:o}=this.playSelection(e,t);this.playRange(n,o)}playEnded(){this.ended=!0,this.pause(),this.wf.invoke("playend")}pause(){!this.isDestroyed&&this.playing&&this.audio&&(this.stopWatch(),this.disconnectSource(),this.playing=!1,this.loop=null,this.wf.invoke("pause"),this.wf.invoke("seek",[this.currentTime]))}stop(){this.isDestroyed||(this.stopWatch(),this.disconnectSource(),this.playing=!1,this.loop=null)}destroy(){this.stop(),this.cleanupSource(),this.bufferPromise=void 0,this.bufferResolve=void 0,super.destroy()}updatePlayback(){const{start:e,end:t}=this.playSelection();this.playSource(e,t)}playRange(e,t){e&&(this.currentTime=e),this.playSource(e,t),this.wf.invoke("play")}playSource(e,t){this.stopWatch(),this.connectSource(),this.audio&&(this.playing=!0,this.loop&&((this.currentTime<this.loop.start||this.currentTime>this.loop.end)&&(this.currentTime=this.loop.start),t=Fi(this.loop.end,0,this.duration),e=Fi(this.loop.start,0,t)),this.playAudio(e,t))}playSelection(e,t){const n=this.wf.regions.selected;if(n.length>0){const e=Math.min(...n.map((e=>e.start))),t=Math.max(...n.map((e=>e.end)));let o=this.currentTime;return(o<e||o>=t)&&(o=e),this.loop={start:e,end:t},{start:o,end:t}}const o=null!=e?e:this.currentTime;return{start:o,end:void 0!==t?t-o:void 0}}connectSource(){this.isDestroyed||!this.audio||this.connected||(this.connected=!0,this.canPause()&&this.audio.disconnect())}disconnectSource(){return!(this.isDestroyed||!this.audio||!this.connected)&&(this.connected=!1,this.canPause()&&this.audio.disconnect(),!0)}cleanupSource(){!this.isDestroyed&&this.audio&&(this.disconnectSource(),this.audio.destroy(),delete this.audio)}updateLoop(e){!this.isDestroyed&&this.loop&&e>=this.loop.end&&(this.wf.settings.loopRegion?(this.currentTime=this.loop.start,this.playing=!1,this.play()):this.pause())}updateCurrentTime(e=!1){var t,n;const o=performance.now(),i=(o-this.timestamp)/1e3*this.rate;this.timestamp=o;const s=null!=(t=null==(n=this.loop)?void 0:n.end)?t:this.duration,r=e?this.duration:Fi(this.time+i,0,s);this.time=r,!this.loop&&this.time>=this.duration-i?(this.time=this.duration,this.wf.invoke("playing",[this.duration]),this.playEnded()):this.wf.invoke("playing",[this.time])}stopWatch(){cancelAnimationFrame(this.timer)}}class fs extends ps{constructor(...e){var t;super(...e),t=this,this.handleResetSource=async function(){var e;if(null==(e=t.audio)||!e.el)return;const n=t.playing;t.stop(),t.audio.el.load(),n&&t.play()}}mute(){var e;super.mute(),null!=(e=this.audio)&&e.el&&(this.audio.el.muted=!0)}unmute(){var e;super.unmute(),null!=(e=this.audio)&&e.el&&(this.audio.el.muted=!1)}get rate(){var e;return null!=(e=this.audio)&&e.el&&this.audio.el.playbackRate!==this._rate&&(this.audio.el.playbackRate=this._rate),this._rate}set rate(e){const t=this._rate!==e;var n;(this._rate=e,t)&&(null!=(n=this.audio)&&n.el&&(this.audio.el.playbackRate=e),this.wf.invoke("rateChanged",[e]))}init(e){super.init(e),this.audio&&this.audio.el&&(this.audio.on("resetSource",this.handleResetSource),this.audio.el.addEventListener("play",this.handlePlayed),this.audio.el.addEventListener("pause",this.handlePaused))}destroy(){var e;super.destroy(),null!=(e=this.audio)&&e.el&&(this.audio.el.removeEventListener("play",this.handlePlayed),this.audio.el.removeEventListener("pause",this.handlePaused))}adjustVolume(){var e;null!=(e=this.audio)&&e.el&&(this.audio.el.volume=this.volume)}playAudio(e,t){if(!this.audio||!this.audio.el)return;this.audio.el.currentTime=this.currentTime,this.audio.el.addEventListener("ended",this.handleEnded),this.bufferPromise=new Promise((e=>{this.bufferResolve=e}));const n=this.currentTime;Promise.all([this.audio.el.play(),this.bufferPromise]).then((()=>{var e;this.timestamp=performance.now(),null!=(e=this.audio)&&e.el&&(this.setCurrentTime(n),this.audio.el.currentTime=this.currentTime,this.watch())}))}updateCurrentSourceTime(e){var t;e&&null!=(t=this.audio)&&t.el&&(this.audio.el.currentTime=this.time)}canPause(){var e;return!(null==(e=this.audio)||!e.el||this.audio.el.paused||!this.hasPlayed)}disconnectSource(){var e;return!!super.disconnectSource()&&(null==(e=this.audio)||null==(e=e.el)||e.removeEventListener("ended",this.handleEnded),!0)}}class vs extends ps{constructor(e){super(e),this.audioContext=void 0,this.audioBufferSource=void 0,this.gainNode=void 0,this.audioContext=new AudioContext,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}async init(e){super.init(e),this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume()}get rate(){var e;return null!=(e=this.audioBufferSource)&&e.playbackRate&&this._rate!==this.audioBufferSource.playbackRate.value&&(this.audioBufferSource.playbackRate.value=this._rate),this._rate}set rate(e){const t=this._rate!==e;var n;(this._rate=e,t)&&(null!=(n=this.audioBufferSource)&&n.playbackRate&&(this.audioBufferSource.playbackRate.value=this._rate),this.wf.invoke("rateChanged",[e]))}adjustVolume(){this.gainNode&&(this.gainNode.gain.value=this.volume)}destroy(){super.destroy(),this.audioContext&&this.audioContext.close().finally((()=>{delete this.audioContext}))}playAudio(e,t){if(this.audioBufferSource){try{e?this.audioBufferSource.start(0,e):this.audioBufferSource.start(0)}catch(e){if("InvalidStateError"!==e.name)throw e}this.timestamp=performance.now(),this.watch()}}connectSource(){var e;!this.isDestroyed&&this.audioContext&&null!=(e=this.audio)&&e.buffer&&this.gainNode&&!this.connected&&(this.connected=!0,this.audioBufferSource=this.audioContext.createBufferSource(),this.audioBufferSource.buffer=this.audio.buffer,this.audioBufferSource.connect(this.gainNode),this.audioBufferSource.onended=this.handleEnded)}disconnectSource(){if(this.isDestroyed||!this.connected||!this.audioBufferSource)return!1;this.connected=!1;try{this.audioBufferSource.stop()}catch(e){if("InvalidStateError"!==e.name)throw e}return this.audioBufferSource.disconnect(),this.audioBufferSource.onended=null,this.audioBufferSource=void 0,!0}playSource(e,t){this.disconnectSource(),super.playSource(e,t)}updateCurrentSourceTime(e){e&&this.audioBufferSource&&(this.disconnectSource(),this.connectSource(),this.audioBufferSource.start(0,this.time))}cleanupSource(){super.cleanupSource(),this.audioBufferSource=void 0}}const ys=e=>Number.parseInt(e.replace(/_/g,""),36),bs="1q29ehhb 1n09sgk7 1kl1ekf_ _yl4zsno 16z9eiv3 1p29lhp8 _bd9zg04 17u0____ _iw9zhe5 _to73___ _r45e31e _7l6g016 _jh8ouiv _zn3qba8 1jy4zshs 11u87k0u 1ro9yvyo 1aj3xael 1gz9zjz0 _3w8l4xo 1bf1ekf_ _ke3v___ _4rrkb__ 13j776yz _646mbhl _nrjr4__ _le6mbhl 1n37ehkb _m75f91n _qj3bzfz 1939yygw 11i5z6x8 _1k5f8xs 1509441m 15t5lwgf _ae2th1n _tg1ugcv 1lp1ugcv 16e14up_ _h55rw7n _ny9yavn _7a11xb_ 1ih442g9 _pv442g9 1mv16xof 14e6y7tu 1oo9zkds 17d1cisi _4v9y70f _y98m8kc 1019pq0v 12o9zda8 _348j4f4 1et50i2o _8epa8__ _ts6senj 1o350i2o 1mi9eiuo 1259yrp0 1ln80gnw _632xcoy 1cn9zldc _f29edu4 1n490c8q _9f9ziet 1b94vk74 _m49zkct 1kz6s73a 1eu9dtog _q58s1rz 1dy9sjiq __u89jo3 _aj5nkwg _ld89jo3 13h9z6wx _qa9z2ii _l119xgq _bs5arju 1hj4nwk9 1qt4nwk9 1ge6wau6 14j9zlcw 11p1edc_ _ms1zcxe _439shk6 _jt9y70f _754zsow 1la40eju _oq5p___ _x279qkz 1fa5r3rv _yd2d9ip _424tcku _8y1di2_ _zi2uabw _yy7rn9h 12yz980_ __39ljp6 1b59zg0x _n39zfzp 1fy9zest _b33k___ _hp9wq92 1il50hz4 _io472ub _lj9z3eo 19z9ykg0 _8t8iu3a 12b9bl4a 1ak5yw0o _896v4ku _tb8k8lv _s59zi6t _c09ze0p 1lg80oqn 1id9z8wb _238nba5 1kq6wgdi _154zssg _tn3zk49 _da9y6tc 1sg7cv4f _r12jvtt 1gq5fmkz 1cs9rvci _lp9jn1c _xw1tdnb 13f9zje6 16f6973h _vo7ir40 _bt5arjf _rc45e4t _hr4e100 10v4e100 _hc9zke2 _w91egv_ _sj2r1kk 13c87yx8 _vqpds__ _ni8ggk8 _tj9yqfb 1ia2j4r4 _7x9b10u 1fc9ld4j 1eq9zldr _5j9lhpx _ez9zl6o _md61fzm".split(" ").reduce(((e,t)=>{const n=ys(t.substring(0,3)),o=ys(t.substring(3)).toString(16);let i="";for(let e=0;e<6-o.length;e++)i+="0";return e[n]=`${i}${o}`,e}),{}),xs=new RegExp(`^#${Ui("([a-f0-9])",3)}([a-f0-9])?$`,"i"),Ss=new RegExp(`^#${Ui("([a-f0-9]{2})",3)}([a-f0-9]{2})?$`,"i"),ws=new RegExp(`^rgba?\\(\\s*(\\d+)\\s*${Ui(",\\s*(\\d+)\\s*",2)}(?:,\\s*([\\d.]+))?\\s*\\)$`,"i"),ks=/^[a-z]+$/i;class Cs{constructor(e){this.base=void 0,this.rgba=void 0,this.base=e,this.rgba=e}update(e){const t=Rs(e);return this.rgba=t.rgba,this.base=t.base,this}reset(){return this.rgba=this.base,this}clone(){return new Cs(this.rgba)}opaque(e){const t=[this.r,this.g,this.b,Fi(Wi(this.a+this.a*e,1),0,1)];return this.rgba=t,this}translucent(e){const t=[this.r,this.g,this.b,Fi(Wi(this.a-this.a*e,1),0,1)];return this.rgba=t,this}darken(e){const t=[Fi(Math.round(this.r-this.r*e),0,255),Fi(Math.round(this.g-this.g*e),0,255),Fi(Math.round(this.b-this.b*e),0,255),this.a];return this.rgba=t,this}lighten(e){const t=[Fi(Math.round(this.r+this.r*e),0,255),Fi(Math.round(this.g+this.g*e),0,255),Fi(Math.round(this.b+this.b*e),0,255),this.a];return this.rgba=t,this}get luminance(){const[e,t,n]=this.rgba.map((e=>{const t=e/255;return t<=.03928?t/12.92:((t+.055)/1.055)**2.4}));return.2126*e+.7152*t+.0722*n}get r(){return this.rgba[0]}set r(e){this.rgba[0]=e}get g(){return this.rgba[1]}set g(e){this.rgba[1]=e}get b(){return this.rgba[2]}set b(e){this.rgba[2]=e}get a(){return this.rgba[3]}set a(e){this.rgba[3]=e}toArray(){return this.rgba}toString(){return`rgba(${this.rgba.join(", ")})`}}const js=new Cs([0,0,0,0]),Rs=e=>{if("string"!=typeof e&&!(e instanceof Cs))throw new Error(`Color must be a string or an instanceof RgbaColorArray. Received ${JSON.stringify(e)}`);if(e instanceof Cs)return e;if("transparent"===(e=e.toString()).trim().toLowerCase())return js;let t=e.trim();t=ks.test(e)?(e=>{const t=e.toLowerCase().trim(),n=bs[(e=>{let t=5381,n=e.length;for(;n;)t=33*t^e.charCodeAt(--n);return(t>>>0)%2341})(t)];if(!n)throw new Error(`Unknown color: ${e}`);return`#${n}`})(e):e;const n=xs.exec(t);if(n){const e=Array.from(n).slice(1);return new Cs([...e.slice(0,3).map((e=>Number.parseInt(Ui(e,2),16))),Number.parseInt(Ui(e[3]||"f",2),16)/255])}const o=Ss.exec(t);if(o){const e=Array.from(o).slice(1);return new Cs([...e.slice(0,3).map((e=>Number.parseInt(e,16))),Number.parseInt(e[3]||"ff",16)/255])}const i=ws.exec(t);if(i){const e=Array.from(i).slice(1);return new Cs([...e.slice(0,3).map((e=>Number.parseInt(e,10))),Number.parseFloat(e[3]||"1")])}return js};class _s{constructor(e){var t,n,o,i,s;this.id="tooltip",this.visible=!1,this.color=Rs("#fff"),this.fontWeight="500",this.backgroundColor=Rs("#000"),this.fontSize=16,this.paddingInline=8,this.paddingBlock=4,this.borderRadius=4,this.id=`tooltip-${(0,_.Ak)()}`,this.color=null!=e&&e.color?Rs(e.color):this.color,this.backgroundColor=null!=e&&e.backgroundColor?Rs(e.backgroundColor):this.backgroundColor,this.paddingInline=null!=(t=null==e?void 0:e.paddingInline)?t:this.paddingInline,this.paddingBlock=null!=(n=null==e?void 0:e.paddingBlock)?n:this.paddingBlock,this.borderRadius=null!=(o=null==e?void 0:e.borderRadius)?o:this.borderRadius,this.fontSize=null!=(i=null==e?void 0:e.fontSize)?i:this.fontSize,this.fontWeight=null!=(s=null==e?void 0:e.fontWeight)?s:this.fontWeight,this.initialize()}initialize(){if(document.getElementById(this.id))return;const e=document.createElement("span"),t=document.body;e.id=this.id,e.style.display="none",e.style.position="absolute",this.apply(e),null==t||t.appendChild(e)}update(e){var t,n,o,i;const s=document.getElementById(this.id);this.color=null!=e&&e.color?Rs(e.color):this.color,this.backgroundColor=null!=e&&e.backgroundColor?Rs(e.backgroundColor):this.backgroundColor,this.paddingInline=null!=(t=null==e?void 0:e.paddingInline)?t:this.paddingInline,this.paddingBlock=null!=(n=null==e?void 0:e.paddingBlock)?n:this.paddingBlock,this.borderRadius=null!=(o=null==e?void 0:e.borderRadius)?o:this.borderRadius,this.fontSize=null!=(i=null==e?void 0:e.fontSize)?i:this.fontSize,s&&this.apply(s)}apply(e){e.style.color=this.color.toString(),e.style.backgroundColor=this.backgroundColor.toString(),e.style.paddingInline=`${this.paddingInline}px`,e.style.paddingBlock=`${this.paddingBlock}px`,e.style.borderRadius=`${this.borderRadius}px`,e.style.fontSize=`${this.fontSize}px`,e.style.fontWeight=this.fontWeight,e.style.zIndex="9999",e.style.pointerEvents="none"}show(e,t,n,o=!0){const i=document.getElementById(this.id);this.visible=!0,i&&n&&(i.style.display="block",i.style.left=o?e-i.clientWidth/2+"px":`${e}px`,i.style.top=`${t}px`,i.innerText=n)}hide(){if(!this.visible)return;const e=document.getElementById(this.id);this.visible=!1,e&&(e.style.display="none")}destroy(){var e;null==(e=document.getElementById(this.id))||e.remove()}}let Ts=function(e){return e.auto="auto",e.crosshair="crosshair",e.default="default",e.pointer="pointer",e.move="move",e.text="text",e.wait="wait",e.help="help",e.progress="progress",e.notAllowed="not-allowed",e.contextMenu="context-menu",e.cell="cell",e.verticalText="vertical-text",e.alias="alias",e.copy="copy",e.noDrop="no-drop",e.allScroll="all-scroll",e.colResize="col-resize",e.rowResize="row-resize",e.grab="grab",e.grabbing="grabbing",e.nResize="n-resize",e.neResize="ne-resize",e.nwResize="nw-resize",e.nsResize="ns-resize",e.neswResize="nesw-resize",e.nwseResize="nwse-resize",e.sResize="s-resize",e.seResize="se-resize",e.swResize="sw-resize",e.wResize="w-resize",e.ewResize="ew-resize",e.zoomIn="zoom-in",e.zoomOut="zoom-out",e}({});class As extends os{constructor(e,t){var n,o,i;super(),this.visualizer=void 0,this.symbol=Ts.default,this.focusId="",this.id="cursor",this.color="var(--color-neutral-border)",this.x=void 0,this.y=void 0,this.offsetX=0,this.offsetY=0,this.width=2,this.handleMouseMove=e=>{const{container:t}=this.visualizer;this.offsetX=Xi(t),this.offsetY=Gi(t),this.x=Zi(e,t),this.y=qi(e,t),this.invoke("mouseMove",[e,this]),this.visualizer.invoke("mouseMove",[e,this])},this.id=`cursor-${(0,_.Ak)()}`,this.visualizer=t,this.color=null!=e&&e.color?Rs(e.color):this.color,this.x=null!=(n=e.x)?n:0,this.y=null!=(o=e.y)?o:0,this.width=null!=(i=e.width)?i:this.width,this.initialize()}initialize(){if(document.getElementById(this.id))return;const e=document.createElement("span"),t=document.body;e.id=this.id,e.style.display="none",e.style.position="absolute",this.apply(e),null==t||t.appendChild(e),this.set(this.symbol),document.addEventListener("mousemove",this.handleMouseMove)}apply(e){e.style.backgroundColor=this.color.toString(),e.style.width=`${this.width}px`,e.style.top="0px",e.style.zIndex="9998",e.style.pointerEvents="none"}show(){if(!this.shouldRender)return void this.hide();const e=document.getElementById(this.id);e&&(e.style.height=`${this.visualizer.height}px`,e.style.display="block",e.style.top=`${this.offsetY}px`,e.style.left=this.x+this.offsetX-e.clientWidth/2+"px")}hide(){const e=document.getElementById(this.id);e&&(e.style.display="none")}destroy(){var e;null==(e=document.getElementById(this.id))||e.remove(),document.removeEventListener("mousemove",this.handleMouseMove),super.destroy()}isOver(e,t,n,o){return!(this.x>e+n||this.y>t+o||this.x<e||this.y<t)}isFocused(e){return this.focusId===e}hasFocus(){return""!==this.focusId}get(){return this.symbol}set(e,t=""){this.focusId=t||"",e!==this.symbol&&(this.symbol=e,this.visualizer.container.style.cursor=this.symbol,this.hasFocus()?this.visualizer.lockSeek():this.visualizer.unlockSeek())}get shouldRender(){return this.inView}get inView(){const{width:e,height:t}=this.visualizer;return this.isOver(0,0,e,t)}}const Ks=["actualBoundingBoxAscent","actualBoundingBoxDescent","actualBoundingBoxLeft","actualBoundingBoxRight","fontBoundingBoxAscent","fontBoundingBoxDescent","width"];class Es extends os{get context(){return this._context}get width(){return this.canvas.width}set width(e){this.canvas&&(this.canvas.width=e*this.pixelRatio,this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.width=`${e}px`))}get height(){return this.isVisible?this.canvas.height:0}set height(e){this.canvas&&(this.canvas.height=e*this.pixelRatio,this.canvas instanceof HTMLCanvasElement&&(this.canvas.style.height=`${e}px`))}get isGroup(){return!1}constructor(e){var t,n,o,i,s,r,a,l;super(),this.container=void 0,this.group=void 0,this.options=void 0,this._context=void 0,this._bufferContext=void 0,this._bufferCanvas=void 0,this.compositeOperation="source-over",this.compositeAsGroup=!1,this.opacity=1,this.pixelRatio=1,this.name=void 0,this.index=1,this.offscreen=!1,this.canvas=void 0,this.isVisible=!0,this.options=e,this.name=e.name,this.group=null!=(t=e.group)?t:void 0,this.container=e.container,this.offscreen=null!=(n=e.offscreen)&&n,this.pixelRatio=null!=(o=e.pixelRatio)?o:1,this.index=null!=(i=e.index)?i:this.index,this.compositeOperation=null!=(s=e.compositeOperation)?s:this.compositeOperation,this.compositeAsGroup=null!=(r=e.compositeAsGroup)?r:this.compositeAsGroup,this.opacity=null!=(a=e.opacity)?a:this.opacity,this.isVisible=null==(l=e.isVisible)||l,this.createCanvas()}setVisibility(e){this.isVisible=e,e?this.context.resetTransform():(this.clear(),this.context.setTransform(0,0,0,0,0,0)),this.save(),this.invoke("layerUpdated",[this])}show(){this.setVisibility(!0)}hide(){this.setVisibility(!1)}moveTo(e,t){var n;null==(n=this.context)||n.moveTo(e*this.pixelRatio,t*this.pixelRatio)}lineTo(e,t){var n;null==(n=this.context)||n.lineTo(e*this.pixelRatio,t*this.pixelRatio)}fillRect(e,t,n,o){var i;null==(i=this.context)||i.fillRect(e*this.pixelRatio,t*this.pixelRatio,n*this.pixelRatio,o*this.pixelRatio)}roundRect(e,t,n,o,i){var s,r,a;null==(s=this.context)||s.beginPath(),null==(r=this.context)||r.roundRect(e*this.pixelRatio,t*this.pixelRatio,n*this.pixelRatio,o*this.pixelRatio,i),null==(a=this.context)||a.fill()}fillText(e,t,n,o){var i;null==(i=this.context)||i.fillText(e,t*this.pixelRatio,n*this.pixelRatio,o)}fitText(e,t,n,o){if(!this.context)return;const i=o/this.pixelRatio,s=this.measureText("...").width;let r=this.measureText(e).width,a=e;if(r<=i||r<=s)a=e;else{let t=e.length;for(;r>=i-s&&t-- >0;)a=e.substring(0,t),r=this.measureText(a).width;a+="..."}this.fillText(a,t,n,o)}measureText(e){if(!this.context)return{width:0};const t=this.context.measureText(e),n={};return Ks.forEach((e=>{n[e]=t[e]})),n}save(){var e;null==(e=this.context)||e.save()}restore(){var e;null==(e=this.context)||e.restore()}beginPath(){var e;null==(e=this.context)||e.beginPath()}closePath(){var e;null==(e=this.context)||e.closePath()}stroke(){var e;null==(e=this.context)||e.stroke()}fill(){var e;null==(e=this.context)||e.fill()}copyToBuffer(){this.createBufferCanvas(),this._bufferContext.imageSmoothingEnabled=!1,this._bufferContext.clearRect(0,0,this._bufferCanvas.width,this._bufferCanvas.height),this._bufferContext.drawImage(this.canvas,0,0)}restoreFromBuffer(e=0,t=0){this.clear(),this.context.drawImage(this._bufferCanvas,e*this.pixelRatio,t*this.pixelRatio)}shift(e,t){this.copyToBuffer(),this.restoreFromBuffer(e,t)}set strokeStyle(e){this.context&&(this.context.strokeStyle=e)}get strokeStyle(){return this.context?this.context.strokeStyle:""}set fillStyle(e){this.context&&(this.context.fillStyle=e)}get fillStyle(){return this.context?this.context.fillStyle:""}set lineWidth(e){this.context&&(this.context.lineWidth=e*this.pixelRatio)}get lineWidth(){return this.context?this.context.lineWidth/this.pixelRatio:0}set font(e){this.context&&(this.context.font=e)}get font(){return this.context?this.context.font:""}clear(){this.context&&(this.context.globalAlpha=this.compositeAsGroup?Fi(1.5*this.opacity,0,1):this.opacity,this.context.globalCompositeOperation=this.compositeOperation,this.context.imageSmoothingEnabled=!1,this.context.clearRect(0,0,this.width,this.height))}remove(){this.canvas instanceof HTMLCanvasElement&&this.canvas.remove()}appendTo(e){this.container=e,!this.offscreen&&this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas)}transferTo(e){try{if(!this.canvas)return;let t,n=1;if(e instanceof Es?(t=e.context,n=e.opacity):t=e.getContext("2d"),!t)return;this.compositeAsGroup&&(t.globalAlpha=this.opacity),this.height>0&&this.width>0&&t.drawImage(this.canvas,0,0,this.width,this.height),this.compositeAsGroup&&(t.globalAlpha=n)}catch(e){console.error(e)}}setSize(e,t){this.width=e,this.height=t}createCanvas(){if(this.group)return this.canvas=this.group.canvas,void(this._context=this.group.context);this.offscreen?this.canvas=this.createOffscreenCanvas():this.canvas=this.createVisibleCanvas(),this.offscreen&&this.canvas instanceof HTMLCanvasElement&&document.body.appendChild(this.canvas)}createVisibleCanvas(){var e,t;const n=document.createElement("canvas"),{pixelRatio:o}=this,i=this.container.clientWidth,s=null!=(e=this.options.height)?e:100;return n.id=`waveform-layer-${null!=(t=this.options.name)?t:"default"}`,n.width=i*o,n.height=this.isVisible?s*o:0,n.style.width=`${i}px`,n.style.height=`${s}px`,n.style.visibility=this.isVisible?"visible":"hidden",this._context=n.getContext("2d"),this._context.globalAlpha=this.compositeAsGroup?Fi(1.5*this.opacity,0,1):this.opacity,this._context.globalCompositeOperation=this.compositeOperation,this._context.imageSmoothingEnabled=!1,n}createOffscreenCanvas(){let e;if(Ni){var t;const{pixelRatio:n}=this,o=this.container.clientWidth,i=null!=(t=this.options.height)?t:100;e=new OffscreenCanvas(o*n,i*n),this._context=e.getContext("2d");const s=this.compositeAsGroup?Fi(1.5*this.opacity,0,1):this.opacity;this._context.globalAlpha=s,this._context.globalCompositeOperation=this.compositeOperation,this._context.imageSmoothingEnabled=!1}else e=this.createVisibleCanvas(),Object.assign(e.style,{right:"100%",bottom:"100%",opacity:0,position:"absolute",visibility:this.isVisible?"visible":"hidden"});return e}createBufferCanvas(){if(this._bufferCanvas)return;let e;if(Ni){const{pixelRatio:t}=this,n=this.canvas.width,o=this.canvas.height;e=new OffscreenCanvas(n*t,o*t),this._bufferContext=e.getContext("2d");const i=this.compositeAsGroup?Fi(1.5*this.opacity,0,1):this.opacity;this._bufferContext.globalAlpha=i,this._bufferContext.globalCompositeOperation=this.compositeOperation,this._bufferContext.imageSmoothingEnabled=!1}else e=this.createVisibleCanvas(),Object.assign(e.style,{right:"100%",bottom:"100%",opacity:0,position:"absolute",visibility:"hidden"});this._bufferCanvas=e}}class Ps extends Es{constructor(e){super(e),this.layers=void 0,this.layers=[]}get isGroup(){return!0}get length(){return this.layers.length}addLayer(e){const t=new Es(Object.assign({group:this},e));return this.layers.push(t),this.sortLayers(),t}removeLayer(e){this.layers=this.layers.filter((t=>t!==e))}remove(){this.layers.forEach((e=>{e.remove()})),this.layers=[],super.remove()}clear(){this.layers.forEach((e=>{e.clear()})),super.clear()}setSize(e,t){this.layers.forEach((n=>{n.setSize(e,t)})),super.setSize(e,t)}sortLayers(){this.layers.sort(((e,t)=>e.index-t.index))}}class Ms extends os{constructor(e,t,n){var o,i,s,r,a,l,d;if(super(),this.id=void 0,this.color=Rs("#ccc"),this.fillColor=Rs("#eee"),this.visualizer=void 0,this.layer=void 0,this.layerName=void 0,this.wf=void 0,this.capWidth=void 0,this.hoveredStrokeMultiplier=void 0,this._x=void 0,this.capHeight=void 0,this.capPadding=void 0,this.width=void 0,this.isHovered=!1,this.isDragging=!1,this.mouseDown=e=>{if(this.isVisible&&this.isHovered){e.preventDefault(),e.stopPropagation(),this.isDragging=!0,this.wf.cursor.set(Ts.grabbing,"playhead");const t=e=>{if(this.isDragging){e.preventDefault(),e.stopPropagation();const t=this.visualizer.container.getBoundingClientRect(),n=e.clientX-t.left,o=Fi(n,0,this.visualizer.width);o!==this._x&&(this.setX(o),this.wf.currentTime=Qi(e,this.visualizer,this.wf.duration),this.render())}},n=e=>{this.isDragging&&(e.preventDefault(),e.stopPropagation(),this.isDragging=!1,document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n),this.render(),this.wf.cursor.set(Ts.default))};document.addEventListener("mousemove",t),document.addEventListener("mouseup",n),this.render()}},this.mouseEnter=()=>{this.isVisible&&!this.isDragging&&(this.wf.cursor.hasFocus()||this.wf.cursor.set(Ts.grab,"playhead"),this.isHovered=!0,this.render())},this.mouseLeave=()=>{this.isVisible&&!this.isDragging&&(this.isHovered=!1,this.render(),this.wf.cursor.isFocused("playhead")&&this.wf.cursor.set(Ts.default))},this.playing=(e,t=!0)=>{this.isDragging||this.updatePositionFromTime(e,!0,t)},this.onZoom=()=>{this.playing(this.time,!1)},this.onScroll=()=>{this.playing(this.time,!1)},this.toggleVisibility=()=>{this.isVisible?this.render():this.layer.clear()},(null!=(o=null==e?void 0:e.x)?o:0)<0)throw new Error("Playhead start must be greater than 0");this.id=(0,_.Ak)(5),this._x=null!=(i=e.x)?i:0,this.color=e.color?e.color:this.color,this.fillColor=e.fillColor?e.fillColor:this.fillColor,this.width=null!=(s=e.width)?s:1,this.visualizer=t,this.layerName="playhead",this.wf=n,this.capWidth=null!=(r=e.capWidth)?r:8,this.capHeight=null!=(a=e.capHeight)?a:5,this.capPadding=null!=(l=e.capPadding)?l:3,this.hoveredStrokeMultiplier=null!=(d=e.hoveredStrokeMultiplier)?d:2,this.initialize()}updatePositionFromTime(e,t=!1,n=!0){const o=(e/this.wf.duration-this.scroll)*this.fullWidth,i=n?Fi(o,0,this.fullWidth):o;this.setX(i),this.isVisible&&t&&this.render()}initialize(){this.on("mouseDown",this.mouseDown),this.on("mouseEnter",this.mouseEnter),this.on("mouseLeave",this.mouseLeave),this.wf.on("playing",this.playing),this.wf.on("zoom",this.onZoom),this.wf.on("scroll",this.onScroll)}removeEvents(){this.off("mouseDown",this.mouseDown),this.off("mouseEnter",this.mouseEnter),this.off("mouseLeave",this.mouseLeave),this.wf.off("playing",this.playing),this.wf.off("zoom",this.onZoom),this.wf.off("scroll",this.onScroll),this.layer.off("layerUpdated",this.toggleVisibility)}get scroll(){return this.visualizer.getScrollLeft()}get zoom(){return this.wf.zoom}get isVisible(){var e,t;return null==(e=null==(t=this.layer)?void 0:t.isVisible)||e}get time(){return this.wf.currentTime}get x(){return this._x+this.scroll}get containerWidth(){return this.visualizer.container.clientWidth}get fullWidth(){return this.visualizer.fullWidth}render(){const{color:e,fillColor:t,layer:n,_x:o,isHovered:i,width:s,hoveredStrokeMultiplier:r}=this,{reservedSpace:a}=this.visualizer;null!=n&&n.isVisible&&(n.clear(),n.save(),n.fillStyle=t.toString(),n.strokeStyle=e.toString(),n.lineWidth=i?s*r:s,n.beginPath(),this.moveTo(o,a),n.closePath(),n.stroke(),n.fill(),n.restore())}moveTo(e,t){const{layer:n,capWidth:o,capHeight:i,capPadding:s,visualizer:r}=this,{height:a}=r,l=t-i-s,d=o/2;n.moveTo(e-d,l),n.lineTo(e+d,l),n.lineTo(e+d,l+i-1),n.lineTo(e,l+i),n.lineTo(e,a),n.lineTo(e,l+i),n.lineTo(e-d,l+i-1)}setX(e){this._x=e}setLayer(e){this.layer&&this.layer.off("layerUpdated",this.toggleVisibility),this.layer=e,this.layer.on("layerUpdated",this.toggleVisibility)}toJSON(){return{x:this.x,color:this.color.toString(),layerName:this.layerName,id:this.id}}destroy(){this.isDestroyed||(this.removeEvents(),super.destroy())}}class Ds extends HTMLElement{constructor(){super(),this._loaded=void 0,this._total=void 0,this._initializing=!1,this._error="",this._loaded=0,this._total=0,this.attachShadow({mode:"open"}),this.shadowRoot&&(this.shadowRoot.innerHTML='\n      <style>\n        :host {\n          display: flex;\n          width: 100%;\n          height: var(--ls-loader-height, calc(100% - var(--ls-loader-offset, 34px)));\n          position: absolute;\n          top: var(--ls-loader-offset, 34px);\n          left: 0;\n          z-index: 9999;\n          justify-content: center;\n          align-items: center;\n          background-color: var(--color-neutral-background);\n          pointer-events: none;\n          color: var(--color-neutral-content);\n        }\n        :host([hidden]) {\n          display: none;\n        }\n        .progress {\n          width: 70%;\n        }\n        .progress-bar {\n          overflow: hidden;\n          display: block;\n          position: relative;\n          width: 100%;\n          height: 100%;\n          background-color: var(--ls-loader-color, rgba(65, 60, 74, 0.08));\n          border-radius: var(--ls-loader-progress-border-radius, 8px);\n          height: var(--ls-loader-progress-height, 8px);\n        }\n        .progress-bar::after {\n          content: \'\';\n          position: absolute;\n          top: 0;\n          height: 100%;\n          width: 100%;\n          border-radius: var(--ls-loader-progress-border-radius, 8px);\n          background-color: var(--ls-loader-progress-color, rgba(105, 192, 255, 1));\n          transition: transform 0.15s ease;\n          transform-origin: left;\n          transform: translateX(var(--ls-loader-position, -100%));\n        }\n        .progress-bar-indeterminate::after {\n          transform: translateX(0);\n          animation: shimmer 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;\n        }\n        .progress-bar-info {\n          display: flex;\n          justify-content: space-between;\n          color: var(--color-neutral-content);\n        }\n        .progress-bar-text {\n          display: flex;\n        }\n        .progress-bar-totals {\n          display: flex;\n          align-items: center;\n          gap: 4px;\n        }\n        .progress-text {\n          font-size: 9px;\n          line-height: 16px;\n          letter-spacing: 0.5px;\n          font-weight: 500;\n          margin: 0;\n        }\n        .error {\n          color: var(--ls-loader-error-color, rgba(207, 19, 34, 1));\n        }\n        @keyframes shimmer {\n          50% {\n            opacity: 0.5;\n          }\n        }\n      </style>\n      <div class="progress">\n        <div class="progress-bar-info">\n          <div class="progress-bar-text">\n            <h3 id="text" class="progress-text">Loading file...</h3>\n          </div>\n          <div class="progress-bar-totals progress-text">\n            <span id="loaded">0.0 MB</span><span id="percentage">(0)%</span><span>of</span><span id="total">?? MB</span>\n          </div>\n        </div>\n        <div class="progress-bar"></div>\n      </div>\n    ')}get error(){return this._error}set error(e){this._error=e}get loaded(){return this._loaded}set loaded(e){this._loaded=e}get total(){return this._total}set total(e){this._total=e}get value(){return Math.round(this.loaded/this.total*100)}convertBytesToMegabytes(e){return(e/1024/1024).toFixed(1)}update(){if(!this.shadowRoot)return;const e=this.shadowRoot.querySelector(".progress-bar"),t=this.shadowRoot.querySelector("#text"),n=this.shadowRoot.querySelector("#loaded"),o=this.shadowRoot.querySelector("#total"),i=this.shadowRoot.querySelector("#percentage");if(!e)return;const s=this.total;requestAnimationFrame((()=>{if(this._error)return t.classList.contains("error")||t.classList.add("error"),void(t.innerText=this._error);if(this._initializing)return n.innerText=`${this.loaded}`,o.innerText=`${this.total} chunks`,void(i.innerText=`(${this.value}%)`);if(s<0)return e.classList.contains("progress-bar-indeterminate")||e.classList.add("progress-bar-indeterminate"),void(this.loaded>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`));const r=this.value;if(100===r)return this._initializing=!0,this.total>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`,o.innerText=`${this.convertBytesToMegabytes(this.total)} MB`,i.innerText=`(${r}%)`),t.innerText="Initializing...",void e.classList.add("progress-bar-indeterminate");e.style.setProperty("--ls-loader-position",r-100+"%"),r>0&&(i.innerText=`(${r}%)`),this.loaded>0&&(n.innerText=`${this.convertBytesToMegabytes(this.loaded)} MB`),this.total>0&&(o.innerText=`${this.convertBytesToMegabytes(this.total)} MB`)}))}static get observedAttributes(){return["hidden"]}}customElements.define("loading-progress-bar",Ds);class Os extends os{constructor(e,t){var n,o,i,s,r,a,l,d,c,u,h,g,m,p,f,v;super(),n=this,this.wrapper=void 0,this.scrollFiller=void 0,this.layers=new Map,this.observer=void 0,this.currentTime=0,this.audio=void 0,this.zoom=1,this.scrollLeft=0,this.drawing=!1,this.renderId=0,this.amp=1,this.seekLocked=!1,this.wf=void 0,this.waveContainer=void 0,this.playheadPadding=4,this.zoomToCursor=!1,this.autoCenter=!1,this.splitChannels=!1,this.padding={top:0,bottom:0,left:0,right:0},this.gridWidth=1,this.gridColor=Rs("rgba(0, 0, 0, 0.1)"),this.backgroundColor=Rs("#fff"),this.waveColor=Rs("#000"),this.baseWaveHeight=96,this.originalWaveHeight=0,this.waveHeight=32,this.lastRenderedZoom=0,this.lastRenderedWidth=0,this.lastRenderedAmp=0,this.lastRenderedScrollLeftPx=0,this._container=void 0,this._loader=void 0,this.timelineHeight=zi.timelineHeight,this.timelinePlacement="top",this.maxZoom=1500,this.playhead=void 0,this.reservedSpace=0,this.samplesPerPx=0,this.invokeLayersUpdated=((e,t,{leading:n=!1}={})=>{let o;return(...i)=>{o&&clearTimeout(o),n&&e(...i),o=setTimeout((()=>e(...i)),t)}})((async function(){n.invoke("layersUpdated",[n.layers])}),150),this.playHeadMove=(e,t)=>{if(this.wf.loaded&&e.target&&this.container.contains(e.target)){const{x:n,y:o}=t,{playhead:i,playheadPadding:s,height:r}=this,a=this.reservedSpace-i.capHeight-i.capPadding;n>=i.x-s&&n<=i.x+i.width+s&&o>=a&&o<=r?(i.isHovered||i.invoke("mouseEnter",[e]),this.draw(!0)):i.isHovered&&(i.invoke("mouseLeave",[e]),this.draw(!0))}},this.handleSeek=e=>{var t;if(e.offsetY>this.height)return;const n=this.getLayer("main");if(!this.wf.loaded||this.seekLocked||!e.target||null==n||null==(t=n.canvas)||!t.contains(e.target))return;const o=this.wrapper.getBoundingClientRect().left,i=e.clientX-o,s=this.wf.duration,r=this.scrollLeft+i/this.container.clientWidth/this.zoom,a=Fi(i,0,this.width);this.playhead.setX(a),this.wf.currentTime=r*s},this.handleMouseDown=e=>{e.offsetY>this.height||this.wf.loaded&&this.playhead.invoke("mouseDown",[e])},this.handlePlaying=e=>{this.wf.loaded&&(this.currentTime=e/this.wf.duration,this.draw(1===this.zoom))},this.handleScroll=e=>{if(this.wf.loaded)if(this.isZooming(e)){const t=this.zoom-.2*e.deltaY;this.setZoom(t)}else if(this.zoom>1){const t=this.scrollWidth,n=t/this.fullWidth*this.zoom,o=(0===Math.abs(e.deltaX)?e.deltaY:e.deltaX)*this.zoom*1.25,i=t*(this.scrollLeft*this.zoom),s=Math.max(0,i+o),r=Fi(s/t,0,n)/this.zoom;r!==this.scrollLeft&&(this.wf.invoke("scroll",[r]),this.setScrollLeft(r))}},this.preventScrollX=e=>{const[t,n]=[Math.abs(e.deltaX),Math.abs(e.deltaY)];(t>=n||this.isZooming(e)&&n>=t)&&(e.preventDefault(),e.stopPropagation())},this.handleResize=()=>{this.wf.duration&&requestAnimationFrame((()=>{this.updateSize(),this.updateCursorToTime(this.wf.currentTime),this.updateScrollFiller(),this.setScrollLeft(this.scrollLeft,!1),this.wf.renderTimeline(),this.resetWaveformRender(),this.draw(!1,!0)}))};const y="Dark"===(0,Qn.j17)();this.wf=t,this.waveContainer=e.container,this.waveColor=e.waveColor?Rs(e.waveColor):this.waveColor,this.padding=Object.assign({},this.padding,e.padding),this.playheadPadding=null!=(o=null==(i=e.playhead)?void 0:i.padding)?o:this.playheadPadding,this.zoomToCursor=null!=(s=e.zoomToCursor)?s:this.zoomToCursor,this.autoCenter=null!=(r=e.autoCenter)?r:this.autoCenter,this.splitChannels=null!=(a=e.splitChannels)?a:this.splitChannels,this.baseWaveHeight=null!=(l=e.height)?l:this.baseWaveHeight,this.originalWaveHeight=this.baseWaveHeight,this.timelineHeight=null!=(d=null==(c=e.timeline)?void 0:c.height)?d:this.timelineHeight,this.waveHeight=null!=(u=e.waveHeight)?u:this.waveHeight,this.timelinePlacement=null!=(h=null==e||null==(g=e.timeline)?void 0:g.placement)?h:this.timelinePlacement,this.gridColor=e.gridColor?Rs(e.gridColor):this.gridColor,this.gridWidth=null!=(m=e.gridWidth)?m:this.gridWidth,this.backgroundColor=e.backgroundColor?Rs(e.backgroundColor):this.backgroundColor,this.zoom=null!=(p=e.zoom)?p:this.zoom,this.amp=null!=(f=e.amp)?f:this.amp,this.playhead=new Ms(Object.assign({},e.playhead,{x:0,color:Rs(y?"#fff":"#000"),fillColor:Rs(y?"#fff":"#BAE7FF"),width:null!=(v=e.cursorWidth)?v:2}),this,this.wf),this.initialRender(),this.attachEvents()}init(e){this.init=()=>Hi("Visualizer is already initialized"),this.audio=e,this.setLoading(!1),this.setContainerHeight(),this.height===this.originalWaveHeight&&this.handleResize(),this.invoke("initialized",[this])}setLoading(e){e?(this._loader=document.createElement("loading-progress-bar"),this._container.appendChild(this._loader)):this._container.removeChild(this._loader)}setLoadingProgress(e,t,n){this._loader&&(n?this._loader.total=this._loader.loaded:(void 0!==e&&(this._loader.loaded=e),void 0!==t&&(this._loader.total=t)),this._loader.update())}setDecodingProgress(e,t){this._loader&&(void 0!==e&&(this._loader.loaded=e),void 0!==t&&(this._loader.total=t),this._loader.update())}setError(e){this._loader&&(this._loader.error=e,this._loader.update())}setZoom(e){this.zoom=Fi(e,1,this.maxZoom),this.zoomToCursor?this.centerToCurrentTime():this.updatePosition(!1),this.getSamplesPerPx(),this.updateScrollFiller(),this.wf.invoke("zoom",[this.zoom]),this.draw()}getZoom(){return this.zoom}setScrollLeft(e,t=!0,n=!1){this.wrapper.scrollLeft=e*this.fullWidth}_setScrollLeft(e,t=!0,n=!1){this.scrollLeft=e,t&&this.draw(!1,n)}getScrollLeft(){return this.scrollLeft}getScrollLeftPx(){return this.scrollLeft*this.fullWidth}lockSeek(){this.seekLocked=!0}unlockSeek(){this.seekLocked=!1}draw(e=!1,t=!1){var n=this;if(!this.isDestroyed){if(this.drawing&&!t)return Hi("Concurrent render detected");this.drawing=!0,setTimeout((async function(){e||(n.drawMiddleLine(),n.wf.playing&&n.autoCenter&&n.centerToCurrentTime(),await n.renderAvailableChannels()),n.renderCursor(),n.invoke("draw",[n]),n.transferImage(),n.drawing=!1}))}}redrawCursor(){this.renderCursor(),this.transferImage()}destroy(){this.isDestroyed||(this.invoke("destroy",[this]),this.clear(),this.playhead.destroy(),this.audio=null,this.removeEvents(),this.layers.forEach((e=>e.remove())),this.wrapper.remove(),super.destroy())}clear(){var e;null==(e=this.layers.get("main"))||e.clear(),this.transferImage()}getAmp(){return this.amp}setAmp(e){this.amp=Fi(e,1,Number.POSITIVE_INFINITY),this.draw()}centerToCurrentTime(){if(1===this.zoom)return void this.setScrollLeft(0);const e=this.width/2/this.zoomedWidth;this.setScrollLeft(Fi(this.currentTime-e,0,1))}updateCursorToTime(e){this.playhead.updatePositionFromTime(e)}async renderAvailableChannels(){if(!this.audio)return;const e=this.getLayer("waveform");if(!e||!e.isVisible)return void(this.lastRenderedWidth=0);this.renderId=performance.now();const t=this.dataLength,n=this.getScrollLeftPx(),o=Fi(n*this.samplesPerPx,0,t),i=Fi(o+this.width*this.samplesPerPx,0,t),s=i-o,r=this.zoom,a=this.amp;if(this.width!==this.lastRenderedWidth||r!==this.lastRenderedZoom||a!==this.lastRenderedAmp||s<1e7)for(let t=0;t<this.audio.channelCount;t++)await this.renderWave(t,e,o,i);else await this.renderPartialWave(e,o,i)}renderWave(e,t,n,o){var i,s;const r=this.renderId,a=this.baseWaveHeight/(null!=(i=null==(s=this.audio)?void 0:s.channelCount)?i:1),l=this.getScrollLeftPx(),d=this.zoom,c=this.amp;return new Promise((i=>{if(this.isDestroyed||!this.audio)return i(!1);0===e&&t.clear();const s=this.renderSlice(t,a,n,o,e,0),u=()=>{if(this.renderId!==r)return i(!1);s.next().done?(this.lastRenderedWidth=this.width,this.lastRenderedZoom=d,this.lastRenderedAmp=c,this.lastRenderedScrollLeftPx=l,i(!0)):requestAnimationFrame(u)};u()}))}async renderPartialWave(e,t,n){var o,i;const s=this.renderId;let r=0;const a=null!=(o=null==(i=this.audio)?void 0:i.channelCount)?o:1,l=this.baseWaveHeight/a,d=this.getScrollLeftPx(),c=this.dataLength;let u=this.lastRenderedScrollLeftPx-d;if(u<1&&u>-1||!this.audio)return!1;u=Math.round(u);const h=u*this.samplesPerPx;this.lastRenderedScrollLeftPx=d,e.shift(u,0);for(let o=0;o<a;o++)await new Promise((i=>{let a=t,d=n;u>0?(d=t+h,r=0):(a=n+h,r=Fi(this.width+u-2,0,this.width)),d=Fi(d+2*this.samplesPerPx,0,c);const g=this.renderSlice(e,l,a,d,o,r),m=()=>{if(this.renderId!==s)return i(!1);g.next().done?i(!0):requestAnimationFrame(m)};m()}))}*renderSlice(e,t,n,o,i,s=0){var r,a,l,d,c;const u=null==(r=this.audio)||null==(r=r.chunks)?void 0:r[i];if(!u)return;const h=u.length,g=null!=(a=null==(l=this.padding)?void 0:l.top)?a:0,m=null!=(d=null==(c=this.padding)?void 0:c.left)?d:0,p=t*i+(zi.timelinePlacement?this.reservedSpace:0),f=p+g+t/2;let v=0;e.save();const y=this.waveColor.toString();e.strokeStyle=y,e.fillStyle=y,e.lineWidth=1,e.beginPath(),e.moveTo(s,f);const b=performance.now();for(let i=0;i<h;i++){const r=u[i],a=r.length,l=Math.floor(Fi(n-v,0,a)),d=Math.ceil(Fi(o-v,0,a));v+=a;try{const n=r.slice(l,d),o=n.length-1;let i=o+1;for(;i>0;){const r=o-i,a=n.slice(r,r+this.samplesPerPx);b-performance.now()>10&&(yield),s>=0&&a.length>0&&this.renderChunk(a,e,t,s+m,p),s+=1,i=Fi(i-this.samplesPerPx,0,o)}}catch(e){}}e.stroke(),e.restore()}renderChunk(e,t,n,o,i){t.save();Yi(e).forEach((e=>{const s=n/2,r=e*this.amp*s;t.lineTo(o+1,i+s+r)})),t.restore()}renderCursor(){this.playhead.render()}drawMiddleLine(){this.useLayer("background",(e=>{if(e.clear(),e.isVisible){e.save(),e.fillStyle=this.backgroundColor.toString(),e.fillRect(0,0,this.width,this.height),e.restore(),e.lineWidth=this.gridWidth,e.strokeStyle=this.gridColor.toString();const t=(this.height+this.reservedSpace)/2;e.beginPath(),e.moveTo(0,t),e.lineTo(this.width,t),e.closePath(),e.stroke(),e.restore()}}))}get pixelRatio(){return window.devicePixelRatio}get width(){return this.container.clientWidth}get height(){var e,t;let n=0;const o=this.getLayer("timeline"),i=this.getLayer("waveform"),s=Math.max(this.originalWaveHeight,this.waveHeight*(this.splitChannels&&null!=(e=null==(t=this.audio)?void 0:t.channelCount)?e:1)+this.timelineHeight)-this.timelineHeight;return this.baseWaveHeight!==s&&(this.baseWaveHeight=s),n+=null!=o&&o.isVisible?this.timelineHeight:0,n+=null!=i&&i.isVisible?s:0,n}get scrollWidth(){return this.zoomedWidth-this.width}get fullWidth(){return this.zoomedWidth}get zoomedWidth(){return this.width*this.zoom}get container(){if(this._container)return this._container;let e=null;if(this.waveContainer instanceof HTMLElement?e=this.waveContainer:"string"==typeof this.waveContainer&&(e=document.querySelector(this.waveContainer)),!e)throw new Error("Container element does not exist.");return e.style.position="relative",this._container=e,e}get isDrawing(){return this.drawing}initialRender(){this.container&&(this.container.style.height=`${this.baseWaveHeight}px`,this.createLayers()),this.drawMiddleLine(),this.transferImage()}createLayers(){const{container:e}=this;this.wrapper=document.createElement("div"),this.wrapper.style.height="100%";const t=this.createLayer({name:"main"});this.createLayer({name:"background",offscreen:!0,zIndex:0,isVisible:!1}),this.createLayer({name:"waveform",offscreen:!0,zIndex:100}),this.createLayerGroup({name:"regions",offscreen:!0,zIndex:101,compositeOperation:"source-over"});const n=this.createLayer({name:"controls",offscreen:!0,zIndex:1e3});this.playhead.setLayer(n),this.initScrollBar(),t.appendTo(this.wrapper),e.appendChild(this.wrapper)}initScrollBar(){this.wrapper.style.position="relative",this.wrapper.style.overflowX="scroll",this.wrapper.style.overflowY="hidden";const e=this.getLayer("main");e.canvas.style.position="sticky",e.canvas.style.top="0",e.canvas.style.left="0",e.canvas.style.zIndex="2",this.scrollFiller=document.createElement("div"),this.scrollFiller.style.position="absolute",this.scrollFiller.style.width="100%",this.scrollFiller.style.height=`${ts}px`,this.scrollFiller.style.top="100%",this.scrollFiller.style.minHeight="1px",e.canvas.style.zIndex="1",this.wrapper.appendChild(this.scrollFiller)}updateScrollFiller(){const{fullWidth:e}=this;this.scrollFiller.style.width=`${e}px`}reserveSpace({height:e}){this.reservedSpace=e}createLayer(e){const{name:t,offscreen:n=!1,zIndex:o=1,opacity:i=1,compositeOperation:s="source-over",isVisible:r}=e;if(!e.groupName&&this.layers.has(t))throw new Error(`Layer ${t} already exists.`);const a={groupName:e.groupName,name:t,container:this.container,height:this.baseWaveHeight,pixelRatio:this.pixelRatio,index:o,offscreen:n,compositeOperation:s,opacity:i,isVisible:r};let l;if(e.groupName){const t=this.layers.get(e.groupName);if(!t||!t.isGroup)throw new Error(`LayerGroup ${e.groupName} does not exist.`);l=t.addLayer(a)}else l=new Es(a),this.layers.set(t,l);return this.invoke("layerAdded",[l]),l.on("layerUpdated",(()=>{const e=this.getLayer("main");this.setContainerHeight(),e&&(e.height=this.height),this.invokeLayersUpdated()})),l}createLayerGroup(e){const{name:t,offscreen:n=!1,zIndex:o=1,opacity:i=1,compositeOperation:s="source-over",compositeAsGroup:r=!0}=e;if(this.layers.has(t))throw new Error(`LayerGroup ${t} already exists.`);const a=new Ps({name:t,container:this.container,height:this.baseWaveHeight,pixelRatio:this.pixelRatio,index:o,offscreen:n,compositeOperation:s,compositeAsGroup:r,opacity:i});return this.invoke("layerAdded",[a]),a.on("layerUpdated",(()=>{this.invokeLayersUpdated()})),this.layers.set(t,a),a}removeLayer(e){if(!this.layers.has(e))throw new Error(`Layer ${e} does not exist.`);const t=this.layers.get(e);t&&(this.invoke("layerRemoved",[t]),t.off("layerUpdated",this.invokeLayersUpdated),t.remove()),this.layers.delete(e)}getLayer(e){return this.layers.get(e)}getLayers(){return this.layers}useLayer(e,t){const n=this.layers.get(e);n&&t(n,n.context)}attachEvents(){this.observer=new ResizeObserver(this.handleResize),this.observer.observe(this.wrapper),this.wrapper.addEventListener("wheel",this.preventScrollX),this.wrapper.addEventListener("wheel",this.handleScroll,{passive:!0}),this.wrapper.addEventListener("click",this.handleSeek),this.wrapper.addEventListener("mousedown",this.handleMouseDown),this.wrapper.addEventListener("scroll",(e=>{const t=this.wrapper.scrollLeft/this.fullWidth;this.wf.invoke("scroll",[t]),this._setScrollLeft(t)})),this.on("mouseMove",this.playHeadMove),this.on("layerAdded",this.invokeLayersUpdated),this.on("layerRemoved",this.invokeLayersUpdated),this.wf.on("playing",this.handlePlaying),this.wf.on("seek",this.handlePlaying)}removeEvents(){this.observer.unobserve(this.wrapper),this.observer.disconnect(),this.wrapper.removeEventListener("wheel",this.preventScrollX),this.wrapper.removeEventListener("wheel",this.handleScroll),this.wrapper.removeEventListener("click",this.handleSeek),this.wrapper.removeEventListener("mousedown",this.handleMouseDown),this.off("mouseMove",this.playHeadMove),this.off("layerAdded",this.invokeLayersUpdated),this.off("layerRemoved",this.invokeLayersUpdated),this.wf.off("playing",this.handlePlaying),this.wf.off("seek",this.handlePlaying)}updatePosition(e=!0){if(!this.wf.loaded)return;const t=this.scrollWidth/this.fullWidth*this.zoom;this.setScrollLeft(Fi(this.scrollLeft,0,t),e)}get dataLength(){var e,t;return null!=(e=null==(t=this.audio)?void 0:t.dataLength)?e:0}getSamplesPerPx(){const e=this.dataLength/this.fullWidth;return e!==this.samplesPerPx&&(this.samplesPerPx=e),this.samplesPerPx}isZooming(e){return e.ctrlKey||e.metaKey}setContainerHeight(){this.container.style.height=`${this.height+ts}px`}updateSize(){const e=this.wrapper.clientWidth,t=this.height;this.getSamplesPerPx(),this.layers.forEach((n=>n.setSize(e,t)))}resetWaveformRender(){this.lastRenderedAmp=0,this.lastRenderedWidth=0,this.lastRenderedZoom=0,this.lastRenderedScrollLeftPx=0}transferImage(e=["background","waveform","regions","controls"]){const t=this.layers.get("main");if(t.clear(),e){Array.from(this.layers).sort(((e,t)=>e[1].index-t[1].index)).filter((([e,t])=>t.offscreen)).forEach((([e,n])=>{"main"!==e&&n.transferTo(t)}))}}}class Is extends os{constructor(e,t,n,o){var i,s,r,a,l,d;if(super(),this.id=void 0,this.start=0,this.end=0,this.color=Rs("#afafaf"),this.selected=!1,this.highlighted=!1,this.active=!1,this.updateable=!0,this.locked=!1,this.deleteable=!0,this.visible=!0,this.showInTimeline=!1,this.external=!1,this.waveform=void 0,this.visualizer=void 0,this.controller=void 0,this.layer=void 0,this.handleWidth=void 0,this.isDragging=void 0,this.draggingStartPosition=void 0,this.isGrabbingEdge=void 0,this.switchCursor=(e,t=!0)=>{this.waveform.cursor.set(e,t&&this.requiresCursorFocus(e)?this.layerName:"")},this.edgeGrabCheck=e=>{const{handleWidth:t,end:n,start:o,visualizer:i}=this,{zoomedWidth:s}=this.visualizer,{duration:r}=this.waveform,a=Qi(e,i,r),l=Ji(t,s,r);return{isRightEdge:a>n-l,isLeftEdge:a<o+l}},this.mouseOver=(e,t)=>{if(!this.controller.layerGroup.isVisible)return;const n=this.edgeGrabCheck(t);this.isDragging||(this.updateable&&(n.isRightEdge||n.isLeftEdge)?this.switchCursor(Ts.colResize):this.switchCursor(Ts.grab))},this.handleMouseUp=e=>{this.isDragging&&(this.switchCursor(Ts.grab),this.handleUpdateEnd()),this.handleSelected(),this.waveform.invoke("regionSelected",[this,e]),this.isDragging=!1,this.draggingStartPosition=null,this.updateable&&(this.isGrabbingEdge={isRightEdge:!1,isLeftEdge:!1}),document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.handleMouseUp)},this.handleDrag=e=>{if(this.updateable&&!this.locked&&this.draggingStartPosition){e.preventDefault(),e.stopPropagation(),this.isDragging=!0;const{isRightEdge:t,isLeftEdge:n}=this.isGrabbingEdge,{grabPosition:o,start:i,end:s}=this.draggingStartPosition,r=t||n,{container:a,zoomedWidth:l}=this.visualizer,{duration:d}=this.waveform,c=this.visualizer.getScrollLeft();let u=Zi(e,a)+c;u<0&&(u=0);const h=Ji(u-o,l,d),g=s-i,m=n?i+h:Fi(i+h,0,this.duration-g),p=t?i:m,f=n?s:Fi(s+h,m+(r?0:g),this.duration);t||n?this.switchCursor(Ts.colResize):this.switchCursor(Ts.grabbing),this.updatePosition(Fi(p,0,d),Fi(f,0,d))}},this.mouseDown=(e,t)=>{if(!this.controller.layerGroup.isVisible)return;if(this.controller.isOverrideKeyPressed(t)||this.controller.isLocked)return;const{container:n}=this.visualizer,o=this.visualizer.getScrollLeft(),i=Zi(t,n)+o,{start:s,end:r}=this;this.bringToFront(),this.draggingStartPosition={grabPosition:i,start:s,end:r},document.addEventListener("mouseup",this.handleMouseUp),this.updateable&&(this.isGrabbingEdge=this.edgeGrabCheck(t),document.addEventListener("mousemove",this.handleDrag))},this.handleSelected=e=>{this.isDragging&&this.selected||(this.waveform.playing&&this.waveform.player.pause(),this.selected=null!=e?e:!this.selected,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))},this.handleHighlighted=e=>{!this.updateable||this.isDragging&&this.selected||(this.highlighted=null!=e?e:!this.highlighted,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))},e.start<0)throw new Error("Segment start must be greater than 0");if(e.end<0)throw new Error("Segment end must be greater than 0");this.id=null!=(i=e.id)?i:(0,_.Ak)(5),this.start=e.start,this.end=e.end,this.selected=!!e.selected,this.updateable=null!=(s=e.updateable)?s:this.updateable,this.locked=null!=(r=e.locked)?r:this.locked,this.visible=null!=(a=e.visible)?a:this.visible,this.waveform=t,this.visualizer=n,this.controller=o,this.handleWidth=2,this.isDragging=!1,this.draggingStartPosition=null,this.isGrabbingEdge={isRightEdge:!1,isLeftEdge:!1},this.showInTimeline=null!=(l=e.showInTimeline)?l:this.showInTimeline,this.external=null!=(d=e.external)?d:this.external,this.initialize()}get isRegion(){return!1}update(e){(this.updateable||void 0===e.updateable||e.updateable)&&(void 0!==e.updateable&&(this.updateable=e.updateable),void 0!==e.deleteable&&(this.deleteable=e.deleteable),void 0!==e.locked&&(this.locked=e.locked),void 0!==e.start&&(this.start=e.start),void 0!==e.end&&(this.end=e.end),void 0!==e.selected&&(this.selected=e.selected),void 0!==e.visible&&(this.visible=e.visible),void 0!==e.color&&(this.color=Rs(e.color)),void 0!==e.showInTimeline&&(this.showInTimeline=e.showInTimeline),void 0!==e.external&&(this.external=e.external))}setVisibility(e){e!==this.visible&&(this.visible=e,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))}bringToFront(){this.controller.bringRegionToFront(this.id)}get layerName(){return`region-${this.id}`}get duration(){return this.waveform.duration}get zoom(){return this.waveform.zoom}get xStart(){const{width:e}=this.visualizer,t=this.visualizer.getScrollLeft();return(this.start/this.duration*e-e*t)*this.zoom}get xEnd(){return this.xStart+this.width}get yStart(){const{timelinePlacement:e,timelineHeight:t}=this,n=this.visualizer.getLayer("timeline"),o=e===zi.timelinePlacement;return null!=n&&n.isVisible&&o?t:0}get yEnd(){const{height:e}=this.visualizer,{timelineHeight:t}=this;return this.yStart+(e-t)}get width(){const{start:e,end:t}=this,{width:n}=this.visualizer;return(t-e)/this.waveform.duration*n*this.zoom}get hovered(){return this.controller.isHovered(this)}get timelineHeight(){return this.visualizer.timelineHeight||zi.timelineHeight}get timelinePlacement(){return this.visualizer.timelinePlacement||zi.timelinePlacement}get options(){return{start:this.start,end:this.end,id:this.id,selected:this.selected,updateable:this.updateable,locked:this.locked,deleteable:this.deleteable,visible:this.visible}}get inViewport(){const{xStart:e,xEnd:t}=this,n=this.visualizer.width;return!(e<=0&&t<=0)&&!(e>=n&&t>=n)}requiresCursorFocus(e){return![Ts.crosshair].includes(e)}initialize(){this.layer=this.visualizer.createLayer({groupName:"regions",name:this.layerName}),this.on("mouseOver",this.mouseOver),this.on("mouseDown",this.mouseDown)}render(){if(!this.visible||!this.inViewport)return;const{color:e,selected:t,highlighted:n,active:o}=this,{height:i}=this.visualizer,s=e.clone(),r=this.yStart,a=this.controller.layerGroup;(t||n||o)&&s.darken(.4),a.fillStyle=s.clone().translucent(.77).toString(),a.fillRect(this.xStart,r,this.width,i),a.fillStyle=t?s.toString():s.clone().translucent(.6).toString(),a.fillRect(this.xStart,r,this.handleWidth,i),a.fillRect(this.xEnd-this.handleWidth,r,this.handleWidth,i)}handleUpdateEnd(){this.invoke("updateEnd",[this]),this.waveform.invoke("regionUpdatedEnd",[this])}setColor(e){this.color.update(e)}setLocked(e){this.locked=e,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this])}updateColor(e){this.updateable&&(this.setColor(e),this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this]))}updatePosition(e,t){if(!this.updateable)return;let n=null!=e?e:this.start,o=null!=t?t:this.end;n>o&&([n,o]=[o,n]),this.start=n,this.end=o,this.invoke("update",[this]),this.waveform.invoke("regionUpdated",[this])}scrollToRegion(){this.waveform.scrollToRegion(this.start)}convertToRegion(e,t=!1){if(this.updateable)return this.controller.convertToRegion(this.id,e,t)}convertToSegment(e=!1){if(this.updateable)return this.controller.convertToSegment(this.id,e)}remove(){this.deleteable&&this.waveform.invoke("regionRemoved",[this])}destroy(e=!0){this.deleteable&&!this.isDestroyed&&(e&&this.remove(),super.destroy())}toJSON(){return{start:this.start,end:this.end}}}class Ls extends Is{constructor(e,t,n,o){var i;super(e,t,n,o),this.labels=void 0,this.labels=null!=(i=e.labels)?i:this.labels,this.color=e.color?Rs(e.color):this.color}get isRegion(){return!0}get options(){return Object.assign({},super.options,{labels:this.labels,color:this.color.toString()})}renderLabels(){var e;if(null!=(e=this.labels)&&e.length&&this.controller.showLabels&&this.visible){const e=this.controller.layerGroup,t=this.color,n=this.timelinePlacement,o=this.visualizer.getLayer("timeline"),i=this.timelineHeight,s=(null!=o&&o.isVisible&&n?i:0)+4,r=this.labels.map((t=>e.context.measureText(t))),a=r.reduce(((e,t)=>e+t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+2),0),l=this.xStart+this.handleWidth+2,d=r[0].width+10,c=this.xEnd-this.xStart-2*this.handleWidth,u=c<d?c:d,h=this.selected?d:u;e.fillStyle=`rgba(${t.r+t.r}, ${t.g+t.g}, ${t.b+t.b})`,this.selected&&e.roundRect(l,s,h,a+5,4),e.fillStyle=this.selected?"white":"black",e.font="12px Arial",this.labels.forEach(((t,n)=>{const o=a/r.length*(n+1)-1;e.fitText(t,l+6,s+o,h-this.handleWidth-6)}))}}render(){super.render(),this.renderLabels()}update(e){var t;super.update(e),this.labels=null!=(t=e.labels)?t:this.labels,this.color=e.color?Rs(e.color):this.color}toJSON(){return{start:this.start,end:this.end,color:this.color.toString(),labels:this.labels,layerName:this.layerName,id:this.id}}}class Ns{constructor(e,t,n){var o,i,s,r,a;this.regions=[],this.waveform=void 0,this.visualizer=void 0,this.initialRegions=void 0,this.locked=!1,this.hoveredRegions=new Set,this.defaultColor=Rs("#787878"),this.drawingColor=Rs("#787878"),this.labels=void 0,this.createable=!0,this.updateable=!0,this.deleteable=!0,this.drawableTarget=Is,this.showLabels=!1,this.layerGroup=void 0,this.handleDraw=()=>{this.waveform.loaded&&this.renderAll()},this.handleInit=()=>{this.initialRegions.length&&(this.regions=this.initialRegions.map((e=>new Ls(e,this.waveform,this.visualizer,this))),this.initialRegions=[]),this.visualizer.on("draw",this.handleDraw)},this.handleRegionUpdated=()=>{this.visualizer.draw(!0)},this.handleRegionRemoved=e=>{this.removeRegion(e.id)},this.handleDrawRegion=e=>{if(this.locked||!this.createable)return;if(this.hoveredRegions.size>0&&!this.isOverrideKeyPressed(e))return;if(!this.layerGroup.isVisible)return;let t,n;this.lock(),this.waveform.invoke("beforeRegionsDraw",[this]);const o=()=>{const{container:o,zoomedWidth:i,fullWidth:s}=this.visualizer,{settings:{autoPlayNewSegments:r},duration:a}=this.waveform,l=this.visualizer.getScrollLeftPx();n=Fi(Zi(e,o)+l,0,s);const d=Ji(n,i,a),c=Ji(n,i,a);t=this.addRegion({start:d,end:c,color:this.drawingColor.toString(),selected:!1,labels:this.labels}),r&&!t.isRegion&&this.regions.forEach((e=>e.handleSelected(e.id===t.id)))},i=e=>{const{container:i,fullWidth:s}=this.visualizer,r=this.visualizer.getScrollLeftPx(),a=Fi(Zi(e,i)+r,0,s);if(t||o(),Math.abs(a-n)>5){let e=this.pixelsToTime(n),o=this.pixelsToTime(a);o<e&&([e,o]=[o,e]),t.updatePosition(e,o),t.render()}},s=()=>{const{player:e,settings:{autoPlayNewSegments:n}}=this.waveform;document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s),t&&t.start===t.end?(t.remove(),this.unlock()):t?(this.waveform.invoke("regionCreated",[t]),n&&!t.isRegion?(e.playing&&e.pause(),setTimeout((()=>{this.unlock(),e.seek(t.start),e.play()}))):setTimeout((()=>this.unlock()),0)):this.unlock(),this.waveform.invoke("afterRegionsDraw",[this])};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)},this.handleMouseMove=e=>{const t=this.findRegionUnderCursor(e);t?(t.invoke("mouseOver",[t,e]),t.hovered||(this.hoveredRegions.clear(),this.hover(t,e))):this.hoveredRegions.size&&(this.hoveredRegions.forEach((t=>{t.invoke("mouseLeave",[t,e])})),this.hoveredRegions.clear(),this.cursorLockedByPlayhead||this.waveform.cursor.set(Ts.crosshair))},this.handleMouseLeave=e=>{this.hoveredRegions.size&&(this.hoveredRegions.forEach((t=>{t.invoke("mouseLeave",[t,e])})),this.hoveredRegions.clear())},this.handleMouseDown=e=>{if(!this.updateable)return;const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&(e.preventDefault(),e.stopPropagation(),t.invoke("mouseDown",[t,e]))},this.handleMouseUp=e=>{if(!this.updateable)return;const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&t.invoke("mouseUp",[t,e])},this.handleClick=e=>{var t;const n=this.visualizer.getLayer("main");if(e.target&&null!=n&&null!=(t=n.canvas)&&t.contains(e.target)){const t=this.findRegionUnderCursor(e);this.layerGroup.isVisible&&t&&t.invoke("click",[t,e])}},this.waveform=t,this.visualizer=n,this.initialRegions=null!=(o=null==e?void 0:e.regions)?o:[],this.defaultColor=null!=e&&e.defaultColor?Rs(e.defaultColor):this.defaultColor,this.labels=void 0,this.createable=null!=(i=null==e?void 0:e.createable)?i:this.createable,this.updateable=null!=(s=null==e?void 0:e.updateable)?s:this.updateable,this.deleteable=null!=(r=null==e?void 0:e.deleteable)?r:this.deleteable,this.layerGroup=this.visualizer.getLayer("regions"),this.showLabels=null!=(a=this.waveform.params.showLabels)&&a,this.init()}init(){this.visualizer.on("initialized",this.handleInit),this.waveform.on("regionRemoved",this.handleRegionRemoved),this.waveform.on("regionUpdated",this.handleRegionUpdated),this.visualizer.container.addEventListener("mousedown",this.handleDrawRegion);const{container:e}=this.visualizer;e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("click",this.handleClick),e.addEventListener("mouseleave",this.handleMouseLeave)}renderAll(){this.layerGroup.clear();const e=this.waveform.currentTime;this.regions.forEach((t=>{t.active=t.start<=e&&t.end>=e,t.render()}))}regionDrawableTarget(){this.drawableTarget=Ls}segmentDrawableTarget(){this.drawableTarget=Is}resetDrawableTarget(){this.segmentDrawableTarget()}clearSegments(e=!1){this.regions=this.regions.filter((t=>!!(t.isRegion||e&&!t.selected||t.external)||(t.destroy(),!1)))}addRegions(e,t=!0){e.forEach((e=>this.addRegion(e,!1))),t&&this.redraw()}addRegion(e,t=!0){var n;let o;return o=null!=(n=e.labels)&&n.length||this.drawableTarget===Ls?new Ls(e,this.waveform,this.visualizer,this):new Is(e,this.waveform,this.visualizer,this),this.regions.push(o),t&&this.redraw(),o}findRegion(e){return this.regions.find((t=>t.id===e))}convertToRegion(e,t,n=!0){let o=this.findRegion(e);const i=this.regions.findIndex((t=>t.id===e));return o=new Ls(Object.assign({},o.options,{labels:t}),this.waveform,this.visualizer,this),this.regions[i]=o,n&&this.redraw(),o}convertToSegment(e,t=!0){let n=this.findRegion(e);const o=this.regions.findIndex((t=>t.id===e));return n=new Is(n.options,this.waveform,this.visualizer,this),this.regions[o]=n,t&&this.redraw(),n}updateRegion(e,t=!0){if(!this.updateable||!e.id)return;const n=this.findRegion(e.id);return n?(n.update(e),t&&this.redraw(),n):void 0}redraw(){this.visualizer.draw(!0)}removeRegion(e,t=!0){const n=this.findRegion(e);this.deleteable&&null!=n&&n.deleteable&&(n.destroy(!1),this.regions=this.regions.filter((e=>e!==n))),t&&this.redraw()}bringRegionToFront(e){const t=this.regions.findIndex((t=>t.id===e));this.regions.push(...this.regions.splice(t,1))}destroy(){const{container:e}=this.visualizer;this.visualizer.off("initialized",this.handleInit),this.visualizer.off("draw",this.handleDraw),this.waveform.off("regionRemoved",this.handleRegionRemoved),this.waveform.off("regionUpdated",this.handleRegionUpdated),e.removeEventListener("mousemove",this.handleMouseMove),e.removeEventListener("mousedown",this.handleMouseDown),e.removeEventListener("mouseup",this.handleMouseUp),e.removeEventListener("click",this.handleClick),e.removeEventListener("mouseleave",this.handleMouseLeave),this.regions.forEach((e=>e.destroy())),this.regions=[]}setDrawingColor(e){this.drawingColor=Rs(e)}updateLabelVisibility(e){this.showLabels=e,this.redraw()}setLabels(e){e&&(this.labels=e)}resetDrawingColor(){this.drawingColor=this.defaultColor.clone()}resetLabels(){this.labels=void 0}get list(){return Array.from(this.regions)}get selected(){return this.regions.filter((e=>e.selected))}get timelineRegions(){return this.regions.filter((e=>e.showInTimeline))}get visible(){return this.regions.filter((e=>e.visible))}isOverrideKeyPressed(e){return e.shiftKey}get cursorLockedByPlayhead(){return this.waveform.cursor.hasFocus()&&this.waveform.cursor.isFocused("playhead")}findRegionUnderCursor(e){return((e,t)=>{for(let n=e.length-1;n>=0;n--)if(t(e[n]))return e[n]})(this.visible,(t=>this.cursorInRegion(e,t)))}cursorInRegion(e,t){const{xStart:n,width:o}=t,{container:i,timelinePlacement:s,timelineHeight:r=0,height:a}=this.visualizer,l=this.visualizer.getLayer("timeline"),d=s===zi.timelinePlacement&&null!=l&&l.isVisible?r:0,c=Zi(e,i),u=qi(e,i);if(!$i(c,n,n+o))return!1;return $i(u,d,d+a-r)}lock(){this.locked=!0,this.visualizer.lockSeek()}unlock(){this.locked=!1,this.visualizer.unlockSeek()}get isLocked(){return this.locked}hover(e,t){t&&(this.visualizer.lockSeek(),e.invoke("mouseEnter",[e,t])),this.hoveredRegions.add(e)}unhover(e,t){t&&(this.visualizer.unlockSeek(),e.invoke("mouseLeave",[e,t])),this.hoveredRegions.delete(e)}pixelsToTime(e){const{zoomedWidth:t}=this.visualizer,{duration:n}=this.waveform;return e/t*n}toJSON(){return this.regions.map((e=>e.toJSON()))}isHovered(e){return this.hoveredRegions.has(e)}}const zs="Dark"===(0,Qn.j17)();class Vs{constructor(e,t,n){var o,i,s,r,a,l;this.waveform=void 0,this.visualizer=void 0,this.layer=void 0,this.placement=void 0,this.padding={left:0,right:0,top:0,bottom:0},this.height=zi.timelineHeight,this.initHeight=zi.timelineHeight,this.fontSize=12,this.gridWidth=1,this.fontFamily="Arial",this.fontColor=Rs(zs?"rgba(200,200,200,0.8)":"#413C4A"),this.selectionColor=Rs(zs?"rgba(200,200,200,0.08)":"rgba(65, 60, 74, 0.08)"),this.gridColor=Rs(zs?"rgba(200,200,200,0.16)":"rgba(137,128,152,0.16)"),this.backgroundColor=Rs("#fff"),this._labeMaxWidth={true:0,false:0},this.waveform=t,this.visualizer=n,this.placement=(null==e?void 0:e.placement)||zi.timelinePlacement,this.padding=Object.assign({},this.padding,null==e?void 0:e.padding),this.fontSize=null!=(o=null==e?void 0:e.fontSize)?o:this.fontSize,this.fontFamily=null!=(i=null==e?void 0:e.fontFamily)?i:this.fontFamily,this.height=(null!=(s=null==e?void 0:e.height)?s:zi.timelinePlacement)?null!=(r=null==e?void 0:e.height)?r:zi.timelineHeight:this.height,this.initHeight=this.height,this.gridWidth=null!=(a=null==e?void 0:e.gridWidth)?a:this.gridWidth,this.fontColor=null!=e&&e.fontColor?Rs(null==e?void 0:e.fontColor):this.fontColor,this.selectionColor=null!=(l=null==e?void 0:e.selectedColor)?l:this.selectionColor,this.gridColor=null!=e&&e.gridColor?Rs(null==e?void 0:e.gridColor):this.gridColor,this.backgroundColor=null!=e&&e.backgroundColor?Rs(null==e?void 0:e.backgroundColor):this.backgroundColor,this.visualizer.reserveSpace({height:this.height}),this.layer=this.visualizer.createLayer({name:"timeline",offscreen:!0,zIndex:103}),this.visualizer.on("initialized",(()=>{this.visualizer.on("draw",(()=>this.render()))})),this.layer.on("layerUpdated",(()=>{this.height=this.layer.isVisible?this.initHeight:0,this.visualizer.reserveSpace({height:this.height}),this.render()}))}render(){var e;const{width:t}=this.visualizer,n=this.height,o=this.layer,i=this.visualizer.height-n,s=this.gridWidth,r=this.gridColor.toString(),a=this.backgroundColor.toString(),l=this.placement,d="top"===l?0:i,c="top"===l&&(null==(e=this.padding)?void 0:e.left)||0;o.clear(),this.layer.isVisible&&(o.lineWidth=s,o.strokeStyle=r,o.fillStyle=a,o.beginPath(),o.fillRect(0,d,t+c,n),this.renderTimelineRegions(),this.renderSelected(),this.renderIntervals(),o.fillStyle=r,o.fillRect(0,d+n,t+c,s),o.stroke())}renderTimelineRegions(){var e;const t=null==(e=this.waveform)?void 0:e.regions.timelineRegions;if(t.length){const{height:e}=this,{duration:n}=this.waveform,{zoomedWidth:o}=this.visualizer,i=this.visualizer.getScrollLeftPx(),s=this.waveform.currentTime;t.sort(((e,t)=>e.start-t.start)).forEach((t=>{const{end:r,start:a,selected:l,color:d}=t,c=a<=s&&r>=s,u=a*o/n-i,h=(r-a)*o/n,g=this.layer,m=d.clone();c&&m.darken(l?.3:.4),g.fillStyle=m.translucent(.8).toString(),g.fillRect(u,0,h,e)}))}}renderSelected(){var e;const t=null==(e=this.waveform)?void 0:e.regions.selected;if(t.length){const{selectionColor:e,height:n}=this,{duration:o}=this.waveform,{zoomedWidth:i}=this.visualizer,s=this.visualizer.getScrollLeftPx(),r=t.sort(((e,t)=>e.start-t.start))[0].start,a=r*i/o-s,l=(t.sort(((e,t)=>t.end-e.end))[0].end-r)*i/o,d=0,c=this.layer;c.fillStyle=e.toString(),c.fillRect(a,d,l,n)}}renderInterval(e){var t;const{pixelRatio:n,height:o}=this.visualizer,i=this.fontSize,s=this.height,r=o-s,a=this.placement,l=this.layer,d="top"===a?0:r,c="top"===a&&(null==(t=this.padding)?void 0:t.left)||0,u="top"===a?"label"===e.type?.75*s:.875*s:d,h="top"===a?"label"===e.type?.25*s:.125*s:"label"===e.type?s/2:s/3;if(l.moveTo(e.x+c,u),l.lineTo(e.x+c,u+h),"label"===e.type){var g;const t=this.formatTime(1e3*e.time,e.includeMs),o="top"===a?e.x-this.getDownscaledTextWidth(l,t)/2:e.x+((null==(g=this.padding)?void 0:g.left)||6);l.fillStyle=this.fontColor.toString(),l.font=`${i*n}px ${this.fontFamily}`,l.fillText(t,o,"top"===a?d+.75*s/2+i/2-this.gridWidth:d+s-8)}}getDownscaledTextWidth(e,t){const{pixelRatio:n}=this.visualizer;return e.measureText(t).width/n}renderIntervals(){const{width:e}=this.visualizer,t=this.visualizer.getScrollLeftPx(),n=this.mapToTime(e),[o,i]=this.getIntervals(n),s=this.mapToTime(Math.abs(t)),r=Math.floor(s/o)*o,a=r+n,l=n<60,d=10**10;for(let e=r;e<a;e+=o){const t=Wi(e,10),n=0===Math.round(t*d)%Math.round(i*d)?"label":"mark";this.renderInterval({x:this.mapToPx(e-s),time:t,type:n,includeMs:l})}}getLabelPadding(){return this.fontSize}mapToTime(e){const{duration:t}=this.waveform,{fullWidth:n}=this.visualizer;return e/n*t}mapToPx(e){const{duration:t}=this.waveform,{fullWidth:n}=this.visualizer;return e/t*n}getLabelMaxWidth(e=!1){const t=e.toString();if(this._labeMaxWidth[t])return this._labeMaxWidth[t];const n="MM:MM:MM:MM"+(e?"M":""),o=this.layer.measureText(n).width;return this._labeMaxWidth[t]=o,o}getIntervals(e){const t=this.gridWidth,n=this.mapToTime(10+t),o=Math.floor(Math.log10(n)),i=Wi(n,Math.abs(o)),s=Math.ceil(i/10**o);let r=10**o;s>6?r=10**o*7.5:s>4?r=10**o*5:s>2?r=10**o*2.5:s>1&&(r=10**o*1.25);const a=e<60,l=Math.ceil((this.getLabelMaxWidth(a)+2*this.getLabelPadding())/this.mapToPx(r))*r,d=Math.floor(Math.log10(l)),c=Math.ceil(l/10**d);let u=Wi(10,d);return c>5?u=10**d*7.5:c>3?u=10**d*5:c>2?u=10**d*2.5:c>1&&(u=10**d*1.25),[r,u]}formatTime(e,t=!1){const n=e>3600?11:14,o=t?23:19;return new Date(e).toISOString().substring(n,o)}}class Hs extends os{constructor(e){var t,n;super(),this.src=void 0,this.media=void 0,this.visualizer=void 0,this.timeline=void 0,this.focusTimeout=null,this.tooltip=void 0,this.cursor=void 0,this.player=void 0,this.params=void 0,this.regions=void 0,this.loaded=!1,this.renderedChannels=!1,this.settings={},this.handleDrawn=()=>{const e={width:this.visualizer.width,height:this.visualizer.height,zoom:this.zoom,scroll:this.visualizer.getScrollLeftPx()};this.invoke("frameDrawn",[e])},this.handleCursorMove=e=>{if(e.target&&this.visualizer.container.contains(e.target)){if(this.loaded&&this.cursor.inView){var t;this.focusTimeout&&clearTimeout(this.focusTimeout),this.focusTimeout=setTimeout((()=>{this.cursor.hasFocus()||this.cursor.set(Ts.crosshair)}),1);const n=Qi(e,this.visualizer,this.duration),o=null==(t=new Date(1e3*n).toISOString().match(/T(.*?)Z/))?void 0:t[1];this.tooltip.show(e.pageX,e.pageY+16,o)}else this.cursor.set(Ts.default);this.cursor.show()}else this.cursor.hide(),this.tooltip.hide()},null!=e&&e.timeline||(e.timeline={placement:"top"}),e.decoderType=null!=(t=e.decoderType)?t:"webaudio",e.playerType="ffmpeg"===e.decoderType?"html5":null!=(n=e.playerType)?n:"html5",this.src=e.src,this.params=e,this.init()}init(){var e,t,n,o,i,s;this.media=new ms(this,{src:this.src}),this.tooltip=new _s(null==(e=this.params)?void 0:e.tooltip),this.visualizer=new Os(this.params,this),this.cursor=new As(Object.assign({x:0,y:0,width:null!=(t=null==(n=this.params)?void 0:n.cursorWidth)?t:1},null==(o=this.params)?void 0:o.cursor),this.visualizer),this.timeline=new Vs(Object.assign({gridColor:this.params.gridColor,gridWidth:this.params.gridWidth},null==(i=this.params)?void 0:i.timeline),this,this.visualizer),this.regions=new Ns(Object.assign({},null==(s=this.params)?void 0:s.regions),this,this.visualizer),this.player="html5"===this.params.playerType?new fs(this):new vs(this),this.initEvents(),this.loadingState()}renderTimeline(){this.timeline.render()}loadingState(){this.visualizer.setLoading(!0),this.renderTimeline(),this.visualizer.draw(!0)}async load(){var e,t,n;if(this.isDestroyed)return;const o=this.media.load({muted:null!=(e=this.params.muted)&&e,volume:null!=(t=this.params.volume)?t:1,rate:null!=(n=this.params.rate)?n:1});this.media.decoderPromise&&(await this.media.decoderPromise,this.renderTimeline(),this.visualizer.draw(!0));const i=await o;this.isDestroyed||i&&("webaudio"===this.params.playerType&&(this.media.duration=i.duration,this.renderTimeline(),this.visualizer.draw(!0)),this.player.init(i),this.visualizer.init(i),this.loaded=!0,this.invoke("load"))}syncCursor(){const e=this.currentTime;this.visualizer.updateCursorToTime(e),this.visualizer.redrawCursor()}seek(e){this.player.seek(e)}seekForward(e){var t;this.seek(this.currentTime+(null!=(t=null!=e?e:this.params.seekStep)?t:1))}seekBackward(e){var t;this.seek(this.currentTime-(null!=(t=null!=e?e:this.params.seekStep)?t:1))}scrollToRegion(e){if(1===this.zoom)return;const t=this.visualizer.width/2/this.visualizer.zoomedWidth,n=Fi(e/this.duration-t,0,1);this.visualizer.setScrollLeft(n,!0,!0),this.invoke("scroll",[n])}play(e,t){this.player.play(e,t)}pause(){this.player.pause()}togglePlay(){this.playing?this.pause():this.play()}setLoadingProgress(e,t,n){this.visualizer.setLoadingProgress(e,t,n)}setDecodingProgress(e,t){this.visualizer.setDecodingProgress(e,t)}setError(e,t){this.invoke("error",[t||new Error(e)]),this.visualizer.setError(e)}stop(){this.player.stop()}destroy(){this.isDestroyed||(this.regions.destroy(),this.media.destroy(),this.player.destroy(),this.visualizer.destroy(),this.cursor.destroy(),this.tooltip.destroy(),super.destroy())}addRegions(e,t=!0){this.regions.addRegions(e,t)}addRegion(e,t=!0){return this.regions.addRegion(e,t)}updateRegion(e,t=!0){return this.regions.updateRegion(e,t)}updateLabelVisibility(e){this.regions.updateLabelVisibility(e)}removeRegion(e,t=!0){this.regions.removeRegion(e,t)}getLayers(){return this.visualizer.getLayers()}getLayer(e){return this.visualizer.getLayer(e)}get playing(){return this.player.playing}get zoom(){return this.visualizer.getZoom()}set zoom(e){this.visualizer.setZoom(e)}get volume(){return this.player.volume}set volume(e){this.player.volume=e}get muted(){return this.player.muted}set muted(e){this.player.muted=e}get scroll(){return this.duration*this.visualizer.getScrollLeft()/this.zoom*1e3}set scroll(e){const t=e/this.duration*this.zoom;this.visualizer.setScrollLeft(t),this.invoke("scroll",[t])}get rate(){return this.player.rate}set rate(e){this.player.rate=e}get currentTime(){return this.player.currentTime}set currentTime(e){this.setCurrentTime(e,!0)}setCurrentTime(e,t=!1){t?this.player.seek(e):this.player.seekSilent(e)}get amp(){return this.visualizer.getAmp()}set amp(e){this.visualizer.setAmp(e)}get duration(){return this.media.duration}get sampleRate(){return this.media.sampleRate}get isDrawing(){return this.visualizer.isDrawing}initEvents(){this.cursor.on("mouseMove",this.handleCursorMove),this.visualizer.on("layersUpdated",(()=>this.invoke("layersUpdated",[this.getLayers()]))),this.visualizer.on("draw",(()=>this.handleDrawn()))}}const Bs=["waveform"],Fs=({item:e})=>{var t;const n=(0,m.useRef)(),o="Dark"===(0,Qn.j17)(),i=((e,t)=>{var n,o,i,s;const r=(0,m.useRef)(),{showLabels:a=!0}=t,[l,d]=(0,m.useState)(1),[c,u]=(0,m.useState)(null!=(n=null==t?void 0:t.volume)?n:1),[h,g]=(0,m.useState)(!1),[p,f]=(0,m.useState)(0),[v,y]=(0,m.useState)(0),[b,x]=(0,m.useState)(null!=(o=null==t?void 0:t.amp)?o:1),[S,w]=(0,m.useState)(null!=(i=null==t?void 0:t.rate)?i:1),[k,C]=(0,m.useState)(null!=(s=null==t?void 0:t.muted)&&s),[j,R]=(0,m.useState)([]),[_,T]=(0,m.useState)(new Map),{settings:A}=(0,m.useContext)(Ro);(0,m.useEffect)((()=>{r.current&&A&&(r.current.settings=A)}),[A,r.current]);const K=(0,m.useRef)(null==t?void 0:t.onFrameChanged);K.current=null==t?void 0:t.onFrameChanged;const E=(0,m.useMemo)((()=>{let e=null,t=-1;return n=>{cancelAnimationFrame(t),t=requestAnimationFrame((()=>{e&&n.width===e.width&&n.height===e.height&&n.zoom===e.zoom&&n.scroll===e.scroll||(null==K.current||K.current(n),e=n)}))}}),[]);return(0,m.useEffect)((()=>{const n=new Hs(Object.assign({},null!=t?t:{},{container:e.current}));return(void 0===(null==t?void 0:t.autoLoad)||null!=t&&t.autoLoad)&&n.load(),n.on("load",(()=>{null==t||null==t.onLoad||t.onLoad(n)})),n.on("play",(()=>{g(!0)})),n.on("pause",(()=>{g(!1)})),n.on("error",(e=>{null==t||null==t.onError||t.onError(e)})),n.on("playing",(e=>{h&&!es(e,v,p)&&(null==t||null==t.onSeek||t.onSeek(e)),y(e)})),n.on("seek",(e=>{es(e,v,p)||(null==t||null==t.onSeek||t.onSeek(e),y(e))})),n.on("zoom",d),n.on("frameDrawn",E),n.on("muted",C),n.on("durationChanged",f),n.on("volumeChanged",u),n.on("rateChanged",(e=>{null==t||null==t.onRateChange||t.onRateChange(e),w(e)})),n.on("layersUpdated",(e=>{const t=[],n=new Map;for(const o of e.values())t.push(o),n.set(o.name,o.isVisible);R(t),T(n)})),r.current=n,()=>{var e;null==(e=r.current)||e.destroy()}}),[]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{var e;if(!r.current)return;const t=null!=(e=r.current.playing)&&e;h!==t&&(h?r.current.play():r.current.pause())}));return null==t||null==t.onPlaying||t.onPlaying(h),()=>cancelAnimationFrame(e)}),[h]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{r.current&&r.current.zoom!==l&&(r.current.zoom=l)}));return()=>cancelAnimationFrame(e)}),[l]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{r.current&&r.current.volume!==c&&(r.current.volume=c)}));return()=>cancelAnimationFrame(e)}),[c]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{r.current&&r.current.rate!==S&&(r.current.rate=S)}));return()=>cancelAnimationFrame(e)}),[S]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{r.current&&r.current.amp!==b&&(r.current.amp=b)}));return()=>cancelAnimationFrame(e)}),[b]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{r.current&&r.current.muted!==k&&(r.current.muted=k)}));return()=>cancelAnimationFrame(e)}),[k]),(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>{var e;null==(e=r.current)||e.updateLabelVisibility(a)}));return()=>cancelAnimationFrame(e)}),[a]),{waveform:r,zoom:l,setZoom:d,volume:c,setVolume:u,playing:h,setPlaying:g,duration:p,currentTime:v,setCurrentTime:y,amp:b,setAmp:x,rate:S,setRate:w,muted:k,setMuted:C,layers:j,layerVisibility:_}})(n,{src:e._value,autoLoad:!1,waveColor:"rgba(150,150,150,0.8)",gridColor:o?"rgba(150,150,150,0.8)":"rgba(150,150,150,0.9)",gridWidth:1,backgroundColor:o?"rgba(150,150,150,0.8)":"rgba(255,255,255,0.8)",autoCenter:!0,zoomToCursor:!0,height:e.height&&!isNaN(Number(e.height))?Number(e.height):96,waveHeight:e.waveheight&&!isNaN(Number(e.waveheight))?Number(e.waveheight):32,splitChannels:e.splitchannels,decoderType:e.decoder,playerType:e.player,volume:e.defaultvolume?Number(e.defaultvolume):1,amp:e.defaultscale?Number(e.defaultscale):1,zoom:e.defaultzoom?Number(e.defaultzoom):1,showLabels:e.annotationStore.store.settings.showLabels,rate:e.defaultspeed?Number(e.defaultspeed):1,muted:"true"===e.muted,onLoad:e.onLoad,onPlaying:e.onPlaying,onSeek:e.onSeek,onRateChange:e.onRateChange,onError:e.onError,regions:{createable:!e.readonly,updateable:!e.readonly,deleteable:!e.readonly},timeline:{backgroundColor:o?"rgb(38, 37, 34)":"rgba(255,255,255,0.8)"},experimental:{backgroundCompute:!0,denoize:!0},onFrameChanged:t=>{e.setWFFrame(t)}}),{waveform:s}=i,r=(0,Zn.A)(i,Bs);return(0,m.useEffect)((()=>{var t,n,o,i,r,a;const l=go("Audio","Audio Segmentation");null==(t=s.current)||t.load();return null==(n=s.current)||n.on("beforeRegionsDraw",(t=>{var n;const o=e.getRegionColor(),i=null==(n=e.activeState)?void 0:n.selectedValues();o&&i&&(t.regionDrawableTarget(),t.setDrawingColor(o),t.setLabels(i))})),null==(o=s.current)||o.on("afterRegionsDraw",(e=>{e.resetDrawableTarget(),e.resetDrawingColor(),e.resetLabels()})),null==(i=s.current)||i.on("regionSelected",((t,n)=>{const o=e.annotation,i=n.metaKey||n.ctrlKey;i&&(t.selected||t.isRegion)||e.annotation.regionStore.unselectAll();const s=e.regs.find((e=>e.id===t.id)),r=e._ws.regions.findRegion(t.id);if(o.isLinkingMode&&s)return o.addLinkedRegion(s),o.stopLinkingMode(),o.regionStore.unselectAll(),void t.handleSelected(!1);s&&e.annotation.regionStore.toggleSelection(s,t.selected),r&&r.handleSelected(t.selected),i||e._ws.regions.regions.forEach((e=>{e.id!==t.id&&e.handleSelected(!1)}))})),null==(r=s.current)||r.on("regionCreated",(t=>{e.addRegion(t)})),null==(a=s.current)||a.on("regionUpdatedEnd",(t=>{e.updateRegion(t)})),l.addNamed("region:delete",(()=>{var e;null==(e=s.current)||e.regions.clearSegments(!1)})),l.addNamed("segment:delete",(()=>{var e;null==(e=s.current)||e.regions.clearSegments(!1)})),l.addNamed("region:delete-all",(()=>{var e;null==(e=s.current)||e.regions.clearSegments()})),()=>{l.unbindAll()}}),[]),(0,A.jsxs)(Qe.eB,{name:"audio-tag",children:[null==(t=e.errors)?void 0:t.map(((e,t)=>(0,A.jsx)(Ee,{error:e},`err-${t}`))),(0,A.jsx)("div",{ref:t=>{n.current=t,e.stageRef.current=t}}),(0,A.jsx)(ni,{position:r.currentTime,playing:r.playing,volume:r.volume,speed:r.rate,zoom:r.zoom,duration:r.duration,onPlay:()=>r.setPlaying(!0),onPause:()=>r.setPlaying(!1),allowFullscreen:!1,onVolumeChange:e=>r.setVolume(e),onStepBackward:()=>{var e,t;null==(e=s.current)||e.seekBackward(.1),null==(t=s.current)||t.syncCursor()},onStepForward:()=>{var e,t;null==(e=s.current)||e.seekForward(.1),null==(t=s.current)||t.syncCursor()},onPositionChange:e=>{var t,n;null==(t=s.current)||t.seek(e),null==(n=s.current)||n.syncCursor()},onSpeedChange:e=>r.setRate(e),onZoom:e=>r.setZoom(e),amp:r.amp,onAmpChange:e=>r.setAmp(e),mediaType:"audio",toggleVisibility:(e,t)=>{if(s.current){var n;const o=null==(n=s.current)?void 0:n.getLayer(e);o&&o.setVisibility(t)}},layerVisibility:r.layerVisibility})]})},Ws=(0,v.PA)((({item:e})=>{const[t,n]=Ii("ls:audio-tag:settings",{playpauseHotkey:"audio:playpause",stepBackHotkey:"audio:step-backward",stepForwardHotkey:"audio:step-forward",loopRegion:!1,autoPlayNewSegments:!0}),o=(0,m.useCallback)(((e,t)=>{n((n=>Object.assign({},n,{[e]:t})))}),[]),i=(0,m.useMemo)((()=>({position:0,length:0,regions:[],step:10,playing:!1,visibleWidth:0,seekOffset:0,data:void 0,settings:t,changeSetting:o})),[t]);return(0,A.jsx)(_o,{value:i,children:(0,A.jsx)(Fs,{item:e})})}));let $s=Co,Us=Rn;(0,j.VS)(j.sg)&&($s=Mi),(0,j.VS)(j.vS)&&($s=Ws,Us=Tn),b.addTag("audio",Us,$s),b.addTag("audioplus",Us,$s),b.addObjectType(Us);var Ys=n(60007),Xs=n(78401);const Gs=(0,v.PA)(class extends m.Component{render(){const{item:e}=this.props,t=(n=Math.ceil(e.stageWidth/e.gridsize),o=Math.ceil(e.stageHeight/e.gridsize),i=e.gridsize,[...Array(n)].map(((e,t)=>[...Array(o)].map(((e,n)=>({col:t,row:n,x:t*i,y:n*i,fill:"#fff"}))))).reduce(((e,t)=>[...e,...t])));var n,o,i;return(0,A.jsx)(Xs.Wd,{opacity:.15,name:"ruler",children:Object.values(t).map(((t,n)=>(0,A.jsx)(Xs.rw,{x:t.x,y:t.y,width:e.gridsize,height:e.gridsize,stroke:e.gridcolor,strokeWidth:1},n)))})}}),Zs=(0,m.createContext)({expanded:!1}),qs=Zs.Provider,Js=go("SegmentationToolbar","Segmentation Tools"),Qs={plus:"+",minus:"-"},er=({active:e=!1,disabled:t=!1,smart:n=!1,extra:o=null,tool:i=null,controlsOnHover:s=!1,extraShortcuts:r={},ariaLabel:a,controls:l,icon:d,label:c,shortcut:u,onClick:h})=>{var g,p;let f=u;const v=null!=(g=null==i?void 0:i.dynamic)&&g,{expanded:y,alignment:b}=(0,m.useContext)(Zs),[S,w]=(0,m.useState)(!1),k=(0,m.useMemo)((()=>{if(!(0,x.isDefined)(u))return null;const e=u.split(",").map((e=>e.trim()));return(0,A.jsx)(Qe.Sl,{name:"shortcut",children:e.map(((e,t)=>{const n=e.split("+");return(0,A.jsx)(m.Fragment,{children:n.map((e=>{var t;return(0,A.jsx)(Qe.Sl,{name:"key",tag:"kbd",children:null!=(t=Qs[e])?t:e},e)}))},`${n.join("-")}-${t}`)}))})}),[u]);(0,m.useEffect)((()=>{const e=()=>{f&&Js.hasKey(f)&&Js.removeKey(f)};return e(),f=u,u&&!Js.hasKey(u)&&Js.addKey(u,(()=>{var e;null!=i&&i.disabled||null!=i&&null!=(e=i.annotation)&&e.isDrawing||(null!=i&&i.unselectRegionOnToolChange&&i.annotation.unselectAreas(),null==h||h())}),c),()=>{e()}}),[u,null==i?void 0:i.annotation]),(0,m.useEffect)((()=>(e&&Object.entries(r).forEach((([e,[t,n]])=>{Js.hasKey(e)||Js.overwriteKey(e,n,t)})),()=>{Object.keys(r).forEach((e=>{Js.hasKey(e)&&Js.removeKey(e)}))})),[r,e]);const C=(0,m.useMemo)((()=>n&&o?(0,A.jsx)(Qe.Sl,{name:"extra",children:o}):null),[n,o]),j=!1===v&&(null==l?void 0:l.length)&&(e||s&&S),R=null==i||null==(p=i.annotation)?void 0:p.isDrawing,_=t||R;return(0,A.jsxs)(Qe.eB,{name:"tool",tag:"button","aria-label":a,mod:{active:e,disabled:_,alignment:b,expanded:y&&!v,smart:v||n},onClick:e=>{if(!t&&!R){var n;if(e.preventDefault(),null!=i&&i.unselectRegionOnToolChange)null==i||null==(n=i.annotation)||null==n.unselectAreas||n.unselectAreas();null==h||h(e)}},onMouseEnter:()=>{w(!0)},onMouseLeave:()=>{w(!1)},children:[(0,A.jsx)(Qe.Sl,{name:"icon",children:d}),!1===v&&!1===s&&(y?(0,A.jsx)(A.Fragment,{children:(0,A.jsxs)(Qe.Sl,{name:"label",children:[C,c,k]})}):((0,x.isDefined)(c)||(0,x.isDefined)(k))&&!j&&(0,A.jsx)(Qe.Sl,{name:"tooltip",mod:{controlled:!(!n||!o)},children:(0,A.jsxs)(Qe.Sl,{name:"tooltip-body",children:[C,c,k]})})),j&&(0,A.jsx)(Qe.Sl,{name:"controls",onClickCapture:e=>e.stopPropagation(),children:(0,A.jsx)(Qe.Sl,{name:"controls-body",children:l})})]})},tr=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{ariaLabel:(0,g.toKebabCase)((0,u.Pw)(e).name),active:e.selected,icon:e.iconClass,label:e.viewTooltip,shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,tool:e,onClick:()=>{e.manager.selectTool(e,!0)}}))),nr=u.gK.model("BaseTool",{smart:!1,unselectRegionOnToolChange:!1,removeDuplicatesNamed:u.gK.maybeNull(u.gK.string)}).volatile((()=>({dynamic:!1,index:1,canInteractWithRegions:!0}))).views((e=>({get toolName(){return(0,u.Pw)(e).name},get isSeparated(){return e.control.isSeparated},get viewClass(){return()=>e.shouldRenderView?(0,A.jsx)(tr,{item:e}):null},get viewTooltip(){return null},get controls(){return null},get shouldRenderView(){return(e.isSeparated||e.smartEnabled)&&e.iconClass},get iconClass(){if(e.iconComponent){const t=e.iconComponent;return(0,A.jsx)(t,{})}return null},get iconComponent(){return null},get smartEnabled(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.smartEnabled)&&t}}))).actions((e=>({afterCreate(){var t;if(e.smart&&null!=(t=e.control)&&t.smart){const t=(0,u._$)(e),n=(0,u.Pw)(e),o=Object.assign({},(0,u.dV)(e),{smart:!1,default:!1}),i=Object.assign({},t),s=n.create(o,i);s.makeDynamic(),(0,u._$)(e).manager.addTool(`${n.name}-smart`,s,e.control.removeDuplicatesNamed)}},makeDynamic(){e.dynamic=!0}}))),or={X:3,Y:3},ir={width:30,height:30},sr={radius:30},rr={length:30},ar=nr;function lr(e){return{x:e.x+e.width/2*Math.cos(e.rotation)+e.height/2*Math.sin(-e.rotation),y:e.y+e.height/2*Math.cos(e.rotation)+e.width/2*Math.sin(e.rotation)}}function dr(e,t){return function(e,t,n){const o=n.x+(e.x-n.x)*Math.cos(t)-(e.y-n.y)*Math.sin(t),i=n.y+(e.x-n.x)*Math.sin(t)+(e.y-n.y)*Math.cos(t);return Object.assign({},e,{rotation:e.rotation+t,x:o,y:i})}(e,t,lr(e))}class cr extends Ct.A.Transformer{constructor(e){super(e),this.isMouseOver=!1,this.isMouseDown=!1,this.initialRotationDelta=0,this.origin=void 0,this.handleMouseDown=e=>{const t=this.getStage(),n=null==t?void 0:t.getPointerPosition();if(!t||!n)return;const o=this._getNodeRect(),i=lr(o),s=n.x-i.x,r=n.y-i.y,a=Math.PI/2-Math.atan2(-r,s);t.content.style.cursor=`url(${To.nad}) 16 16, pointer`,this.isMouseDown=!0,this._movingAnchorName=e.target.name().split(" ")[0],this.initialRotationDelta=a-o.rotation,this.origin=i,window&&(window.addEventListener("mousemove",this.handleMouseMove),window.addEventListener("touchmove",this.handleMouseMove),window.addEventListener("mouseup",this.handleMouseUp,!0),window.addEventListener("touchend",this.handleMouseUp,!0)),this._fire("transformstart",{evt:e,target:this.getNode()}),this._nodes.forEach((t=>{t._fire("transformstart",{evt:e,target:t})}))},this.handleMouseUp=e=>{this.isMouseDown=!1,this.origin=void 0,this.isMouseOver||(this.getStage().content.style.cursor=""),window&&(window.removeEventListener("mousemove",this.handleMouseMove),window.removeEventListener("touchmove",this.handleMouseMove),window.removeEventListener("mouseup",this.handleMouseUp,!0),window.removeEventListener("touchend",this.handleMouseUp,!0));const t=this.getNode();this._fire("transformend",{evt:e,target:t}),t&&this._nodes.forEach((t=>{t._fire("transformend",{evt:e,target:t})})),this._movingAnchorName=""},this.handleMouseMove=e=>{const t=this.getStage();if(!this.isMouseDown||!this.origin||!t)return;t.setPointersPositions(e);const n=t.getPointerPosition(),o=this._getNodeRect();if(!n)return;const i=n.x-this.origin.x,s=n.y-this.origin.y,r=Math.PI/2-Math.atan2(-s,i)-this.initialRotationDelta,a=Ct.A.getAngle(this.rotationSnapTolerance()),l=function(e,t,n){let o=t;for(let i=0;i<e.length;i++){const s=Ct.A.getAngle(e[i]),r=Math.abs(s-t)%(2*Math.PI);Math.min(r,2*Math.PI-r)<n&&(o=s)}return o}(this.rotationSnaps(),r,a),d=dr(o,l-o.rotation);this._fitNodesInto(d,e)},e.rotateEnabled&&this.createRotateButton()}createRotateButton(){const e=this.refreshRotationList();for(const t in e){const n=new Ct.A.Circle({radius:20,name:`rotate-${t}`,dragDistance:0,draggable:!0,x:e[t].x,y:e[t].y});this.add(n),n.moveToBottom(),n.on("mousedown touchstart",this.handleMouseDown),n.on("mouseover",(()=>{this.isMouseDown||(this.getStage().content.style.cursor=`url(${To.nad}) 16 16, pointer`),this.isMouseOver=!0})),n.on("mouseout",(()=>{this.isMouseOver=!1,this.isMouseDown||(this.getStage().content.style.cursor="")})),n.on("dragstart",(e=>{this.findOne(`.${this._movingAnchorName}`).stopDrag(),e.cancelBubble=!0})),n.on("dragend",(e=>{e.cancelBubble=!0}))}}refreshRotationList(){return{"top-left":{x:0,y:0},"top-right":{x:this.getWidth(),y:0},"bottom-left":{x:0,y:this.getHeight()},"bottom-right":{x:this.getWidth(),y:this.getHeight()}}}get _outerBack(){var e;return null==(e=this.getStage())?void 0:e.findOne(this.attrs.backSelector)}setNodes(e=[]){return super.setNodes(e),this._outerBack&&this._proxyDrag(this._outerBack),this}detach(){var e;null==(e=this._outerBack)||e.off(".tr-konva"),super.detach()}update(){this.refreshRotationList();const{x:e,y:t,width:n,height:o}=this._getNodeRect(),i=this.rotation(),s=this._outerBack,r=this.refreshRotationList();for(const e in r){const t=this.findOne(`.rotate-${e}`);t&&t.setAttrs({x:r[e].x,y:r[e].y}).getLayer().batchDraw()}if(super.update(),s){const r=this.getAbsoluteScale(),a=s.getAbsoluteScale(),l={x:r.x/a.x,y:r.y/a.y};s.setAttrs({x:(e-this.getStage().getAttr("x"))*l.x,y:(t-this.getStage().getAttr("y"))*l.y,width:n*l.x,height:o*l.y,rotation:i}).getLayer().batchDraw()}}}Ct.A.LSTransformer=cr;class ur extends Ct.A.Transformer{get _outerBack(){var e;return null==(e=this.getStage())?void 0:e.findOne(this.attrs.backSelector)}setNodes(e=[]){return super.setNodes(e),this._outerBack&&this._proxyDrag(this._outerBack),this}detach(){var e;null==(e=this._outerBack)||e.off(".tr-konva"),super.detach()}update(){const{x:e,y:t,width:n,height:o}=this._getNodeRect(),i=this.rotation(),s=this._outerBack;if(super.update(),s){const r=this.getAbsoluteScale(),a=s.getAbsoluteScale(),l={x:r.x/a.x,y:r.y/a.y};s.setAttrs({x:(e-this.getStage().getAttr("x"))*l.x,y:(t-this.getStage().getAttr("y"))*l.y,width:n*l.x,height:o*l.y,rotation:i}).getLayer().batchDraw()}}}Ct.A.LSTransformerOld=ur;class hr extends m.Component{constructor(...e){super(...e),this.checkNode=()=>{if(!this.transformer)return;const e=this.transformer.getStage(),{item:{selectedRegions:t}}=this.props;if(null==t||!t.length)return this.transformer.detach(),void this.transformer.getLayer().batchDraw();if(t.find((e=>!e.supportsTransform)))return;const n=[];t.forEach((t=>{const o=e.findOne((e=>e.hasName(t.id)&&e.parent));if(!o)return;if(o.hasName("_transformable")&&n.push(o),!o.find)return;const i=o.find((e=>e.hasName("_transformable")),!0);n.push(...i)}));const o=this.transformer.nodes();(null==n?void 0:n.length)===(null==o?void 0:o.length)&&!n.find(((e,t)=>e!==o[t]))||(n.length?this.transformer.nodes(n):this.transformer.nodes([]),this.transformer.getLayer().batchDraw())},this.constrainSizes=(e,t)=>{const n=void 0!==t.rotation?t.rotation:e.rotation,o=n!==e.rotation,i=this.getStageAbsoluteDimensions();if(t.width<or&&(t.width=or),t.height<or&&(t.height=or),n||o){const{x:o,y:s,width:r,height:a}=t,l=Tt({x:0,y:0,width:r,height:a},{x:o,y:s},n),d=this.fitBBoxToScaledStage(l,i);return["x","y","width","height"].some((e=>Math.abs(d[e]-l[e])>.001))?e:t}return this.fitBBoxToScaledStage(t,i)},this.dragBoundFunc=e=>{const{item:t}=this.props;return t.fixForZoomWrapper(e,(e=>{if(!this.transformer||!t)return;let{x:n,y:o}=e;const{width:i,height:s}=this.draggingAreaBBox,{stageHeight:r,stageWidth:a}=t;return n<0&&(n=0),o<0&&(o=0),n+i>a&&(n=a-i),o+s>r&&(o=r-s),{x:n,y:o}}))}}componentDidMount(){setTimeout(this.checkNode)}componentDidUpdate(){setTimeout(this.checkNode)}get freezeKey(){return`ImageTransformer_${this.props.item.id}`}freeze(){const{item:e}=this.props,{freezeKey:t}=this;e.annotation.history.freeze(t)}unfreeze(){const{item:e}=this.props,{freezeKey:t}=this;e.annotation.history.unfreeze(t)}fitBBoxToScaledStage(e,t){let{x:n,y:o,width:i,height:s}=e;const[r,a]=[e.x-t.x,e.y-t.y];return r<0?(n=(0,j.VS)(j.pG)?t.x:0,i+=r):r+e.width>t.width&&(i=t.width-r),a<0?(o=(0,j.VS)(j.pG)?t.y:0,s+=a):a+e.height>t.height&&(s=t.height-a),Object.assign({},e,{x:n,y:o,width:i,height:s})}getStageAbsoluteDimensions(){const e=this.transformer.getStage(),{stageWidth:t,stageHeight:n}=this.props.item;let[o,i]=[t*e.scaleX(),n*e.scaleY()];(0,j.VS)(j.pG)&&this.props.item.isSideways&&([o,i]=[i,o]);const[s,r]=[e.x(),e.y()];return{width:o,height:i,x:s,y:r}}renderLSTransformer(){return(0,A.jsx)(A.Fragment,{children:(0,A.jsx)("LSTransformer",{ref:e=>{this.transformer=e,this.transformer&&this.transformer.rotateEnabled(!1)},resizeEnabled:!0,ignoreStroke:!0,keepRatio:!0!==this.props.singleNodeMode,useSingleNodeRotation:this.props.useSingleNodeRotation,rotateEnabled:this.props.rotateEnabled,borderDash:[3,1],boundBoxFunc:this.constrainSizes,anchorSize:8,flipEnabled:!1,zoomedIn:this.props.item.zoomScale>1,onDragStart:e=>{const{item:{selectedRegionsBBox:t}}=this.props;this.freeze(),this.transformer&&e.target===e.currentTarget&&t&&(this.draggingAreaBBox={x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top})},dragBoundFunc:this.dragBoundFunc,onDragEnd:()=>{this.unfreeze(),setTimeout(this.checkNode)},onTransformEnd:()=>{setTimeout(this.checkNode)},backSelector:this.props.draggableBackgroundSelector})})}renderOldLSTransformer(){return(0,A.jsx)(A.Fragment,{children:(0,A.jsx)("LSTransformerOld",{ref:e=>{this.transformer=e},resizeEnabled:!0,ignoreStroke:!0,keepRatio:!0!==this.props.singleNodeMode,useSingleNodeRotation:this.props.useSingleNodeRotation,rotateEnabled:this.props.rotateEnabled,borderDash:[3,1],boundBoxFunc:this.constrainSizes,anchorSize:8,flipEnabled:!1,zoomedIn:this.props.item.zoomScale>1,onDragStart:e=>{const{item:{selectedRegionsBBox:t}}=this.props;this.freeze(),this.transformer&&e.target===e.currentTarget&&t&&(this.draggingAreaBBox={x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top})},dragBoundFunc:this.dragBoundFunc,onDragEnd:()=>{this.unfreeze(),setTimeout(this.checkNode)},onTransformEnd:()=>{setTimeout(this.checkNode)},backSelector:this.props.draggableBackgroundSelector})})}render(){return this.props.supportsTransform?(0,j.VS)(j.id)?this.renderLSTransformer():this.renderOldLSTransformer():null}}const gr={block:"block--h6e1z",divider:"divider--ucpOT",button:"button--Pugmq",wrapperComponent:"wrapperComponent--lGC5u",wrapper:"wrapper--HIxIc",loading:"loading--NbjdV","image-element":"image-element--YwHyO",image_position:"image_position--Wpu4V",image_position__top:"image_position__top--RQG6L",image_position__middle:"image_position__middle--Emb4G",image_position__center:"image_position__center--sjYuo",image_position__bottom:"image_position__bottom--Yhn9p",image_position__left:"image_position__left--zPURN",image_position__right:"image_position__right--F6wzt",container:"container--_mzc9",frame:"frame--nbBeT",frame_height:"frame_height--CVer_",filler:"filler--R3muM",overlay:"overlay--Ppw7x",withGallery:"withGallery--xrArp",withPagination:"withPagination--AmhTt",gallery:"gallery--IxYdb",active:"active--RZ3Re",pagination:"pagination--_qwcS"},mr={required:(e,t)=>({modelName:e,field:t,error:"ERR_REQUIRED"}),unknownTag:(e,t,n)=>({modelName:e,field:t,value:n,error:"ERR_UNKNOWN_TAG"}),tagNotFound:(e,t,n)=>({modelName:e,field:t,value:n,error:"ERR_TAG_NOT_FOUND"}),tagUnsupported:(e,t,n,o)=>({modelName:e,field:t,value:n,validType:o,error:"ERR_TAG_UNSUPPORTED"}),parentTagUnexpected:(e,t,n,o)=>({modelName:e,field:t,value:n,validType:o,error:"ERR_PARENT_TAG_UNEXPECTED"}),badAttributeValueType:(e,t,n,o)=>({modelName:e,field:t,value:n,validType:o,error:"ERR_BAD_TYPE"}),internalError:e=>({error:"ERR_INTERNAL",value:String(e).substr(0,1e3),field:String(e.code),modelName:""}),generalError:e=>({error:"ERR_GENERAL",value:String(e).substr(0,1e3),field:String(e.code),modelName:""}),loadingError:(e,t,n,o=et.A.ERR_LOADING_HTTP)=>(console.log("ERR",e,e.code),{error:"ERR_GENERAL",value:o({attr:n,error:String(e),url:t}),field:n,modelName:""})},pr=(e,t=null,n=["view"],o)=>{if(!e.children)return[];const i="pagedview"===e.type?e.children.slice(0,1):e.children;for(const e of i){var s;const i=[...n,...null!=t&&t.type?[null==t?void 0:t.type]:[]],r=Object.assign({},e,{parent:null!=(s=null==t?void 0:t.id)?s:null,parentTypes:i});delete r.children,o.push(r),Array.isArray(e.children)&&pr(e,e,i,o)}return o},fr=(e,t)=>{const{name:n}=t.properties;return n&&!n.optionalValues&&void 0===e.name?mr.required(t.name,"name"):null},vr=(e,t,n)=>{const{controlledTags:o}=t.properties;if(!e.toname)return null;const i=e.toname.split(",");for(const e of i){const i=n.find((t=>t.name===e));if(void 0===i)return mr.tagNotFound(t.name,"toname",e);if(o&&o.validate(i.tagName).length)return mr.tagUnsupported(t.name,"toname",i.tagName,o)}return null},yr=(e,t)=>{var n;const o=null==(n=t.properties.parentTypes)?void 0:n.value;return!o||e.parentTypes.find((e=>o.find((t=>e===t.toLowerCase()))))?null:mr.parentTagUnexpected(t.name,"parent",e.tagName,t.properties.parentTypes)},br=(e,t,n)=>{const o=[],i=Object.keys(t.properties);for(const s of i){if(!{}.hasOwnProperty.call(e,s))continue;if(n.includes(s))continue;const i=e[s],r=t.properties[s.toLowerCase()];0!==r.validate(i,r).length&&o.push(mr.badAttributeValueType(t.name,s,i,r))}return o},xr=e=>{const t=[];return e.perregion&&e.peritem&&t.push(mr.generalError("Attribute <b>perItem</b> is incompatible with attribute <b>perRegion</b>. They define two different modes. However <b>perRegion</b> works fine even with multi-item mode of object tags.")),t};var Sr=n(41984);const wr=(0,v.WQ)("store")((0,v.PA)((({store:e,tools:t,expanded:n})=>{const[o,i]=(0,m.useState)(null),s=(()=>{const[e,t]=(0,m.useState)({width:window.innerWidth,height:window.innerWidth});return(0,m.useEffect)((()=>{const e=()=>{t({width:window.innerWidth,height:window.innerWidth})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)}),[]),e})(),r=(0,m.useMemo)((()=>{if(!(0,x.isDefined)(o))return"right";const e=o.getBoundingClientRect();return e.left<200?"right":s.width-e.right<200?"left":"right"}),[o,s]),a=t.filter((e=>!e.dynamic)).reduce(((e,t)=>{var n;const o=null!=(n=e[t.group])?n:[];return o.push(t),e[t.group]=o,e}),{}),l=t.filter((e=>e.dynamic));return(0,A.jsx)(qs,{value:{expanded:n,alignment:r},children:(0,A.jsxs)(Qe.eB,{ref:e=>i(e),name:"toolbar",mod:{alignment:r,expanded:n},children:[Object.entries(a).map((([e,t],n)=>{const o=t.filter((e=>e.viewClass));return o.length?(0,A.jsx)(Qe.Sl,{name:"group",children:o.sort(((e,t)=>e.index-t.index)).map(((e,t)=>{const n=e.viewClass;return(0,A.jsx)(n,{},`${e.toolName}-${t}`)}))},`toolset-${e}-${n}`):null})),e.autoAnnotation&&(0,A.jsx)(kr,{tools:l})]})})}))),kr=(0,v.PA)((({tools:e})=>{const[t,n]=(0,m.useState)(Math.max(e.findIndex((e=>e.selected)),0)),o=(0,m.useMemo)((()=>e[t]),[t]),i=e.some((e=>e.selected));return e.length>0&&(0,A.jsx)(Qe.Sl,{name:"group",children:(0,A.jsx)(er,{smart:!0,label:"Auto-Detect",active:i,icon:o.iconClass,shortcut:"M",extra:e.length>1?(0,A.jsx)(Qe.Sl,{name:"smart",children:e.map(((e,t)=>{const o=e.viewClass;return(0,A.jsx)("div",{onClickCapture:o=>{o.preventDefault(),n(t),e.manager.selectTool(e,!0)},children:(0,A.jsx)(o,{})},`${t}`)}))}):null,controls:o.controls,onClick:o=>{var s;let r=t+1;if(null!=o&&null!=(s=o.target)&&s.closest(`.${(0,Qe.cn)("tool").elem("extra")}`))return;i?r>=e.length&&(r=0):r=0;const a=e[r];n(r),a.manager.selectTool(a,!0)}})})})),Cr=(0,m.createContext)({suggestion:!1}),jr=Cr.Provider;var Rr=n(21015);const _r=(0,m.forwardRef)((({size:e="medium",pageSizeOptions:t=[1,25,50,100],currentPage:n,pageSize:o,totalPages:i,outline:s=!0,align:r="right",noPadding:a=!1,pageSizeSelectable:l=!0,hotkey:d,disabled:c,onChange:u},h)=>{const[g,p]=(0,m.useState)(!1),f=(0,m.useMemo)((()=>t.map(((e,t)=>({value:e,label:`${e} per page`})))),[t]);return(0,A.jsxs)(Qe.eB,{name:"pagination",mod:{size:e,outline:s,align:r,noPadding:a,disabled:c},children:[(0,A.jsxs)(Qe.Sl,{name:"navigation",children:[(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Tr,{mod:["arrow-left","arrow-left-double"],onClick:()=>null==u?void 0:u(1),disabled:1===n||c}),(0,A.jsx)(Qe.Sl,{name:"divider"})]}),(0,A.jsx)(Tr,{mod:["arrow-left"],onClick:()=>null==u?void 0:u(n-1),hotkey:null==d?void 0:d.prev,disabled:1===n||c}),(0,A.jsx)(Qe.Sl,{name:"input",children:g?(0,A.jsx)("input",{type:"text",autoFocus:!0,defaultValue:n,pattern:"[0-9]",onKeyDown:e=>{const t=Number.parseFloat(e.currentTarget.value);"Escape"===e.code?p(!1):"Enter"===e.code?(t<=i&&t>=1&&(null==u||u(t)),p(!1)):null!==e.code.match(/[0-9]/)||(e=>null!==e.code.match(/arrow/i)||e.shiftKey&&null!==e.code.match(/arrow/i)||e.metaKey||e.ctrlKey||"Backspace"===e.code)(e)||(e.preventDefault(),e.stopPropagation())},onBlur:e=>{const t=Number.parseFloat(e.currentTarget.value);t<=i&&t>=1&&(null==u||u(t)),p(!1)}}):(0,A.jsxs)(Qe.Sl,{name:"page-indicator",onClick:()=>{p(!0)},children:[n," ",(0,A.jsxs)("span",{children:["of ",i]}),(0,A.jsx)("div",{onClick:()=>{}})]})}),(0,A.jsx)(Tr,{mod:["arrow-right"],onClick:()=>null==u?void 0:u(n+1),disabled:n===i||c,hotkey:null==d?void 0:d.next}),(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"divider"}),(0,A.jsx)(Tr,{mod:["arrow-right","arrow-right-double"],onClick:()=>null==u?void 0:u(i),disabled:n===i||c})]})]}),l&&(0,A.jsx)(Qe.Sl,{name:"page-size",children:(0,A.jsx)(Qn.l6P,{value:o,onChange:e=>{null==u||u(1,e.currentTarget.value)},options:f})})]})})),Tr=({mod:e,disabled:t,hotkey:n,onClick:o})=>{const i=Object.fromEntries(e.map((e=>[e,!0]))),s=(0,m.useCallback)((()=>{t||o()}),[t,o]);return i.disabled=!0===t,Ko(n,s),n?(0,A.jsx)(go.Tooltip,{name:n,children:(0,A.jsx)(Qe.Sl,{name:"btn",mod:i,onClick:s})}):(0,A.jsx)(Qe.Sl,{name:"btn",mod:i,onClick:s})},Ar=["item"];Ct.A.showWarnings=!1;const Kr=go("Image"),Er={};(0,j.VS)(j.xS)&&(Er.crossOrigin="anonymous");const Pr=e=>{const t=[],n=[],o=e.length;let i=0;for(;i<o;i++){const o=e[i];"brushregion"===o.type?t.push(o):n.push(o)}return{brushRegions:t,shapeRegions:n}},Mr=(0,m.memo)((({region:e,showSelected:t=!1})=>(0,Rr.q3)((()=>L.renderItem(e,e.annotation,!0))))),Dr=(0,m.memo)((({regions:e,name:t,useLayers:n,showSelected:o=!1})=>{const i=e.map((e=>(0,A.jsx)(Mr,{region:e,showSelected:o},`region-${e.id}`)));return!1===n?i:(0,A.jsx)(Xs.Wd,{name:t,children:i})})),Or=(0,m.memo)((({regions:e,useLayers:t=!0,chunkSize:n=15,suggestion:o=!1,showSelected:i=!1})=>(0,A.jsx)(jr,{value:{suggestion:o},children:(n?(0,x.chunks)(e,n):e).map(((e,n)=>(0,A.jsx)(Dr,{name:`chunk-${n}`,regions:e,useLayers:t,showSelected:i},`chunk-${n}`)))}))),Ir=(0,v.PA)((({item:e})=>{const{drawingRegion:t}=e;if(!t)return null;if(e.multiImage&&e.currentImage!==t.item_index)return null;const n=t&&"brushregion"===t.type?m.Fragment:Xs.Wd;return(0,A.jsx)(n,{children:t?(0,A.jsx)(Mr,{region:t},"drawing"):t})})),Lr="#40A9FF",Nr="white",zr=[3,3],Vr=(0,v.PA)((({item:e,selectionArea:t})=>{const{selectionBorders:n}=t;(0,j.VS)(j.MV)||(n.left=n.left*e.stageScale,n.right=n.right*e.stageScale,n.top=n.top*e.stageScale,n.bottom=n.bottom*e.stageScale);const o=n?[{x:n.left,y:n.top},{x:n.right,y:n.top},{x:n.left,y:n.bottom},{x:n.right,y:n.bottom}]:[],i=(0,j.VS)(j.MV)?6/e.stageScale:6;return(0,A.jsxs)(A.Fragment,{children:[n&&(0,A.jsx)(Xs.rw,{name:"regions_selection",x:n.left,y:n.top,width:n.right-n.left,height:n.bottom-n.top,stroke:Lr,strokeWidth:1,strokeScaleEnabled:!1,listening:!1}),o.map(((e,t)=>(0,A.jsx)(Xs.rw,{x:e.x-i/2,y:e.y-i/2,width:i,height:i,fill:Lr,stroke:Nr,strokeWidth:2,strokeScaleEnabled:!1,listening:!1},t)))]})})),Hr=(0,v.PA)((({item:e})=>{const{x:t,y:n,width:o,height:i}=e.onCanvasRect,s={x:t,y:n,width:o,height:i,listening:!1,strokeWidth:1};return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Xs.rw,Object.assign({},s,{stroke:Lr,dash:zr,strokeScaleEnabled:!1})),(0,A.jsx)(Xs.rw,Object.assign({},s,{stroke:Nr,dash:zr,dashOffset:zr[0],strokeScaleEnabled:!1}))]})})),Br="transformer_back",Fr=(0,v.PA)((({item:e})=>{const{selectedRegionsBBox:t}=e,n=1===e.selectedRegions.length,o=(0,m.useRef)({x:0,y:0});return(0,A.jsx)(Xs.Wd,{children:t&&!n&&(0,A.jsx)(Xs.rw,{id:Br,fill:"rgba(0,0,0,0)",draggable:!0,onClick:()=>{e.annotation.unselectAreas()},onMouseOver:t=>{e.annotation.isLinkingMode||(t.target.getStage().container().style.cursor=z.A.POINTER_CURSOR)},onMouseOut:e=>{e.target.getStage().container().style.cursor=z.A.DEFAULT_CURSOR},onDragStart:t=>{o.current={x:e.canvasToInternalX(t.target.getAttr("x")),y:e.canvasToInternalY(t.target.getAttr("y"))}},dragBoundFunc:t=>{let{x:n,y:i}=t;const{top:s,left:r,right:a,bottom:l}=e.selectedRegionsBBox,{stageHeight:d,stageWidth:c}=e,u=o.current.x-r,h=o.current.y-s;n-=u,i-=h;const g={x:n,y:i,width:a-r,height:l-s},m=At(g,c,d);return m.width!==g.width&&(n+=(m.width-g.width)*(m.x!==g.x?-1:1)),m.height!==g.height&&(i+=(m.height-g.height)*(m.y!==g.y?-1:1)),n+=u,i+=h,{x:n,y:i}}})})})),Wr=((0,v.PA)((({item:e,selectedRegions:t})=>{if(!t)return null;const{brushRegions:n=[],shapeRegions:o=[]}=Pr(t);return(0,A.jsxs)(A.Fragment,{children:[(0,j.VS)(j.q$)?null:(0,A.jsx)(Fr,{item:e}),n.length>0&&(0,A.jsx)(Or,{name:"brushes",regions:n,useLayers:!1,showSelected:!0,chankSize:0},"brushes"),o.length>0&&(0,A.jsx)(Or,{name:"shapes",regions:o,showSelected:!0,chankSize:0},"shapes")]})})),(0,v.PA)((({item:e,selectionArea:t})=>{var n,o,i,s;const r=(0,j.VS)(j.MV)?1:1/(e.zoomScale||1),[a,l]=(0,m.useState)(!1),[d,c]=(0,m.useState)(!1),u="ZoomPanTool"===(null==(n=e.getToolsManager().findSelectedTool())?void 0:n.fullName),h=e=>l(4===e.buttons),g=e=>c(e.shiftKey);(0,m.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",g),window.addEventListener("mousedown",h),window.addEventListener("mouseup",h),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",g),window.removeEventListener("mousedown",h),window.removeEventListener("mouseup",h)})),[]);const p=e.zoomScale>1&&(d||u||a);let f=!0,v=!0,y=!0;return null==(o=e.selectedRegions)||o.forEach((e=>{f=f&&!0===e.supportsTransform,v=v&&!0===e.canRotate,y=y&&!0})),f=f&&(e.selectedRegions.length>1||(e.useTransformer||(null==(i=e.selectedShape)?void 0:i.preferTransformer))&&(null==(s=e.selectedShape)?void 0:s.useTransformer)),(0,A.jsxs)(Xs.Wd,{scaleX:r,scaleY:r,children:[t.isActive?(0,A.jsx)(Hr,{item:t}):!f&&e.selectedRegions.length>1?(0,A.jsx)(Vr,{item:e,selectionArea:t}):null,(0,A.jsx)(hr,{item:e,rotateEnabled:v,supportsTransform:!p&&f,supportsScale:y,selectedShapes:e.selectedRegions,singleNodeMode:1===e.selectedRegions.length,useSingleNodeRotation:1===e.selectedRegions.length&&v,draggableBackgroundSelector:`#${Br}`})]})}))),$r=(0,v.PA)((e=>{let{item:t}=e;(0,Zn.A)(e,Ar);const{selectionArea:n}=t;return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Xs.Wd,{name:"selection-regions-layer"}),(0,A.jsx)(Wr,{item:t,selectionArea:n})]})})),Ur=(0,m.memo)((0,m.forwardRef)((({width:e,height:t},n)=>{const[o,i]=(0,m.useState)([50,0,50,t]),[s,r]=(0,m.useState)([0,100,e,100]),[a,l]=(0,m.useState)(100),[d,c]=(0,m.useState)(50),[u,h]=(0,m.useState)(!1),g=[3,3],p=!1;return n&&(n.current={updatePointer(n,o){n!==a&&(l(n),i([n,0,n,t])),o!==d&&(c(o),r([0,o,e,o]))},updateVisibility(e){h(e)}}),(0,A.jsxs)(Xs.Wd,{name:"crosshair",listening:!1,opacity:u?.6:0,children:[(0,A.jsxs)(Xs.YJ,{children:[(0,A.jsx)(Xs.N1,{name:"v-white",points:s,stroke:"#fff",strokeWidth:1,strokeScaleEnabled:p}),(0,A.jsx)(Xs.N1,{name:"v-black",points:s,stroke:"#000",strokeWidth:1,dash:g,strokeScaleEnabled:p})]}),(0,A.jsxs)(Xs.YJ,{children:[(0,A.jsx)(Xs.N1,{name:"h-white",points:o,stroke:"#fff",strokeWidth:1,strokeScaleEnabled:p}),(0,A.jsx)(Xs.N1,{name:"h-black",points:o,stroke:"#000",strokeWidth:1,dash:g,strokeScaleEnabled:p})]})]})}))),Yr=(0,v.PA)((({item:e})=>(0,A.jsx)("canvas",{className:gr.overlay,ref:t=>{e.setOverlayRef(t)},style:e.imageTransform}))),Xr=(0,v.PA)(class extends m.Component{constructor(e){super(e),this.canvasX=void 0,this.canvasY=void 0,this.lastOffsetWidth=-1,this.lastOffsetHeight=-1,this.state={imgStyle:{},pointer:[0,0]},this.imageRef=(0,m.createRef)(),this.crosshairRef=(0,m.createRef)(),this.handleDeferredMouseDown=null,this.deferredClickTimeout=[],this.skipNextMouseDown=!1,this.skipNextClick=!1,this.skipNextMouseUp=!1,this.mouseDownPoint=null,this.handleOnClick=e=>{const{item:t}=this.props;var n;(0,j.VS)(j.x0)&&(null==(n=this.handleDeferredMouseDown)||n.call(this,!0));if(this.skipNextClick)return void(this.skipNextClick=!1);const o=e.evt||e,{offsetX:i,offsetY:s}=o;if(!(0,j.VS)(j.q$)||!(!this.mouseDownPoint||Math.abs(this.mouseDownPoint.x-i)>.01||Math.abs(this.mouseDownPoint.y-s)>.01))return t.event("click",o,i,s);this.mouseDownPoint=null},this.resetDeferredClickTimeout=()=>{this.deferredClickTimeout.length>0&&(this.deferredClickTimeout=this.deferredClickTimeout.filter((e=>(clearTimeout(e),!1))))},this.handleDeferredClick=(e,t,n=!1)=>{this.handleDeferredMouseDown=o=>{o&&n&&t(),e(),this.handleDeferredMouseDown=null},this.resetDeferredClickTimeout(),this.deferredClickTimeout.push(setTimeout((()=>{var e;null==(e=this.handleDeferredMouseDown)||e.call(this,!1)}),this.props.item.annotation.isDrawing?0:100))},this.handleMouseDown=e=>{var t,n;const{item:o}=this.props,i="ZoomPanTool"===(null==(t=o.getToolsManager().findSelectedTool())?void 0:t.fullName),s="MoveTool"===(null==(n=o.getToolsManager().findSelectedTool())?void 0:n.fullName);this.skipNextMouseDown=this.skipNextMouseUp=this.skipNextClick=!1,(0,j.VS)(j.q$)&&(this.mouseDownPoint={x:e.evt.offsetX,y:e.evt.offsetY}),o.updateSkipInteractions(e);const r=e.target.getParent();if(o.annotation.isReadOnly()&&!i)return;if(r&&"Transformer"===r.className)return;const a=()=>{1===e.evt.button&&e.evt.preventDefault();if(o.getSkipInteractions()||e.target===o.stageRef||(0,x.findClosestParent)(e.target,(e=>{if("Group"===e.nodeType){var t,n;if("ruler"===(null==e||null==(t=e.attrs)?void 0:t.name))return!0;if(!s&&"segmentation"===(null==e||null==(n=e.attrs)?void 0:n.name))return!0}return!1}))){window.addEventListener("mousemove",this.handleGlobalMouseMove),window.addEventListener("mouseup",this.handleGlobalMouseUp);const{offsetX:t,offsetY:n}=e.evt,{left:i,top:s}=o.containerRef.getBoundingClientRect();return this.canvasX=i,this.canvasY=s,this.skipNextMouseDown?(this.skipNextMouseDown=!1,!0):(o.event("mousedown",e,t,n),!0)}},l=o.getToolsManager().findSelectedTool(),d=[void 0,"EllipseTool","EllipseTool-dynamic","RectangleTool","RectangleTool-dynamic","PolygonTool","PolygonTool-dynamic","Rectangle3PointTool","Rectangle3PointTool-dynamic"].includes(null==l?void 0:l.fullName);if((0,j.VS)(j.x0)&&d){const t=e.target===o.stageRef,n=o.annotation.selectedRegions.length>0,i=t&&n,s=()=>{o.annotation.unselectAll(),this.skipNextMouseDown=!0,this.skipNextMouseUp=!0,this.skipNextClick=!0};return void this.handleDeferredClick(a,s,i)}const c=a();return c||!0},this.handleGlobalMouseUp=e=>{if(window.removeEventListener("mousemove",this.handleGlobalMouseMove),window.removeEventListener("mouseup",this.handleGlobalMouseUp),e.target&&"CANVAS"===e.target.tagName)return;const{item:t}=this.props,{clientX:n,clientY:o}=e;return t.freezeHistory(),this.triggerMouseUp(e,n-this.canvasX,o-this.canvasY)},this.handleGlobalMouseMove=e=>{if(e.target&&"CANVAS"===e.target.tagName)return;const{item:t}=this.props,{clientX:n,clientY:o}=e;return t.event("mousemove",e,n-this.canvasX,o-this.canvasY)},this.handleMouseUp=e=>{const{item:t}=this.props;return(0,j.VS)(j.x0)&&this.resetDeferredClickTimeout(),t.freezeHistory(),this.triggerMouseUp(e,e.evt.offsetX,e.evt.offsetY)},this.triggerMouseUp=(e,t,n)=>{if(this.skipNextMouseUp)return void(this.skipNextMouseUp=!1);const{item:o}=this.props;return o.event("mouseup",e,t,n)},this.handleMouseMove=e=>{const{item:t}=this.props;t.freezeHistory(),this.updateCrosshair(e);const n=e.evt&&4===e.evt.buttons,o=e.evt&&1===e.evt.buttons,i=o&&e.evt.shiftKey;var s;(0,j.VS)(j.x0)&&o&&(this.resetDeferredClickTimeout(),null==(s=this.handleDeferredMouseDown)||s.call(this,!1));if((n||i)&&t.zoomScale>1){t.setSkipInteractions(!0),e.evt.preventDefault();const n={x:t.zoomingPositionX+e.evt.movementX,y:t.zoomingPositionY+e.evt.movementY};t.setZoomPosition(n.x,n.y)}else t.event("mousemove",e,e.evt.offsetX,e.evt.offsetY)},this.updateCrosshair=e=>{if(this.crosshairRef.current){const{x:t,y:n}=e.currentTarget.getPointerPosition();this.crosshairRef.current.updatePointer(...this.props.item.fixZoomedCoords([t,n]))}},this.handleError=()=>{const{item:e,store:t}=this.props,n=t.annotationStore,o=(0,u._$)(t).messages.ERR_LOADING_HTTP({attr:e.value,error:"",url:e.currentSrc});n.addErrors([mr.generalError(o)])},this.updateGridSize=e=>{const{item:t}=this.props;t.freezeHistory(),t.setGridSize(e)},this.handleZoom=e=>{if((!e.evt||e.evt.ctrlKey)&&(e.evt&&e.evt.ctrlKey&&e.evt.preventDefault(),e.evt)){const{item:t}=this.props,n=t.stageRef;t.handleZoom(e.evt.deltaY,n.getPointerPosition())}},this.onResize=G((()=>{requestAnimationFrame((()=>{var e;if(null==this||null==(e=this.props)||null==(e=e.item)||!e.containerRef)return;const{offsetWidth:t,offsetHeight:n}=this.props.item.containerRef;this.props.item.naturalWidth<=1||this.lastOffsetWidth===t&&this.lastOffsetHeight===n||(this.props.item.onResize(t,n,!0),this.lastOffsetWidth=t,this.lastOffsetHeight=n)}))}),16),this.attachObserver=e=>{this.resizeObserver&&this.detachObserver(),e&&(this.resizeObserver=new X(this.onResize),this.resizeObserver.observe(e))},this.detachObserver=()=>{this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},"boolean"==typeof e.item.smoothing&&e.store.settings.setSmoothing(e.item.smoothing)}renderRulers(){const{item:e}=this.props,t="white";return(0,A.jsxs)(Xs.YJ,{name:"ruler",onClick:e=>{e.cancelBubble=!1},children:[(0,A.jsx)(Xs.N1,{x:0,y:e.cursorPositionY,points:[0,0,e.stageWidth,0],strokeWidth:1,stroke:t,tension:0,dash:[4,4],closed:!0}),(0,A.jsx)(Xs.N1,{x:e.cursorPositionX,y:0,points:[0,0,0,e.stageHeight],strokeWidth:1,stroke:t,tension:0,dash:[1.5],closed:!0})]})}componentDidMount(){const{item:e}=this.props;window.addEventListener("resize",this.onResize),this.attachObserver(e.containerRef),this.updateReadyStatus(),Kr.addDescription("shift","Pan image")}componentWillUnmount(){this.detachObserver(),window.removeEventListener("resize",this.onResize),Kr.removeDescription("shift")}componentDidUpdate(){this.onResize(),this.updateReadyStatus()}updateReadyStatus(){const{item:e}=this.props,{imageRef:t}=this;e&&(0,u._n)(e)&&t.current&&e.isReady!==t.current.complete&&e.setReady(t.current.complete)}renderTools(){const{item:e,store:t}=this.props;if(t.annotationStore.viewingAll)return null;const n=e.getToolsManager().allTools();return(0,A.jsx)(wr,{tools:n})}render(){const{item:e,store:t}=this.props;if(!(0,u._n)(e))return null;if(!t.task||!e.currentSrc)return null;const n={},o=gr.container,i=!!e.isMultiItem;!1===(0,u.Zn)(e).settings.fullscreen&&(n.maxWidth=e.maxwidth,n.maxHeight=e.maxheight,n.width=e.width,n.height=e.height),!t.settings.enableSmoothing&&e.zoomScale>1&&(n.imageRendering="pixelated");const s=[gr.image_position,gr[`image_position__${"center"===e.verticalalignment?"middle":e.verticalalignment}`],gr[`image_position__${e.horizontalalignment}`]],r=[gr.wrapperComponent,e.images.length>1?gr.withGallery:gr.wrapper];i&&r.push(gr.withPagination);const[a,l]=(0,j.VS)(j.F2)?[!0,!1]:[e.hasTools,e.stageWidth<=1],d=e.imageIsLoaded||!(0,j.VS)(j.F2),c=t.annotationStore.viewingAll;return(0,A.jsxs)(En,{item:e,className:r.join(" "),children:[i?(0,A.jsx)("div",{className:gr.pagination,title:c?"Pagination is not supported in View All Annotations":void 0,children:(0,A.jsx)(_r,{size:"small",outline:!1,align:"left",noPadding:!0,hotkey:{prev:"image:prev",next:"image:next"},currentPage:e.currentImage+1,totalPages:e.parsedValueList.length,onChange:t=>e.setCurrentImage(t-1),pageSizeSelectable:!1,disabled:c})}):null,(0,A.jsxs)("div",{ref:t=>{e.setContainerRef(t),this.attachObserver(t)},className:o,style:n,children:[(0,A.jsx)("div",{ref:e=>{this.filler=e},className:gr.filler,style:{width:"100%",marginTop:e.fillerHeight}}),(0,j.VS)(j.F2)?(0,A.jsx)(st,{ref:t=>{e.setImageRef(t),this.imageRef.current=t},usedValue:e.usedValue,imageEntity:e.currentImageEntity,imageTransform:e.imageTransform,updateImageSize:e.updateImageSize,size:e.canvasSize,overlay:(0,A.jsx)(Yr,{item:e})}):(0,A.jsxs)("div",{className:[gr.frame,...s].join(" "),style:e.canvasSize,children:[(0,A.jsx)("img",{ref:t=>{e.setImageRef(t),this.imageRef.current=t},loading:(0,j.VS)(j.H)&&!e.lazyoff?"lazy":"false",style:e.imageTransform,src:e.currentSrc,onLoad:t=>{e.updateImageSize(t),e.currentImageEntity.setImageLoaded(!0)},onError:this.handleError,crossOrigin:e.imageCrossOrigin,alt:"LS"}),(0,A.jsx)(Yr,{item:e})]}),l||!a?(0,A.jsx)("div",{className:gr.loading,children:(0,A.jsx)(Sr.A,{})}):d?(0,A.jsx)(Gr,{item:e,crosshairRef:this.crosshairRef,onClick:this.handleOnClick,imagePositionClassnames:s,state:this.state,onMouseEnter:()=>{this.crosshairRef.current&&this.crosshairRef.current.updateVisibility(!0)},onMouseLeave:t=>{this.crosshairRef.current&&this.crosshairRef.current.updateVisibility(!1);const{width:n,height:o}=e.canvasSize,{offsetX:i,offsetY:s}=t.evt,r=Object.assign({},t);i<=0?t.offsetX=0:i>=n&&(t.offsetX=n),s<=0?t.offsetY=0:s>=o&&(t.offsetY=o),this.handleMouseMove(r)},onDragMove:this.updateCrosshair,onMouseDown:this.handleMouseDown,onMouseMove:this.handleMouseMove,onMouseUp:this.handleMouseUp,onWheel:e.zoom?this.handleZoom:()=>{}}):null]}),a&&d&&this.renderTools(),e.images.length>1&&(0,A.jsx)("div",{className:gr.gallery,children:e.images.map(((t,n)=>(0,m.createElement)("img",Object.assign({},Er,{alt:"",key:t,src:t,className:n===e.currentImage&&gr.active,height:"60",onClick:()=>e.setCurrentImage(n)}))))})]})}}),Gr=(0,v.PA)((({item:e,imagePositionClassnames:t,state:n,onClick:o,onMouseEnter:i,onMouseLeave:s,onDragMove:r,onMouseDown:a,onMouseMove:l,onMouseUp:d,onWheel:c,crosshairRef:u})=>{const{store:h}=e;let g,m;return(0,j.VS)(j.pG)?(g={width:e.containerWidth,height:e.containerHeight},m={x:e.zoomingPositionX+e.alignmentOffset.x,y:e.zoomingPositionY+e.alignmentOffset.y}):(g=Object.assign({},e.canvasSize),m={x:e.zoomingPositionX,y:e.zoomingPositionY}),(0,A.jsx)(Xs.BI,{ref:t=>{e.setStageRef(t)},className:[gr["image-element"],...t].join(" "),width:g.width,height:g.height,scaleX:e.zoomScale,scaleY:e.zoomScale,x:m.x,y:m.y,offsetX:e.stageTranslate.x,offsetY:e.stageTranslate.y,rotation:e.rotation,onClick:o,onMouseEnter:i,onMouseLeave:s,onDragMove:r,onMouseDown:a,onMouseMove:l,onMouseUp:d,onWheel:c,children:(0,A.jsx)(Zr,{item:e,store:h,state:n,crosshairRef:u})})})),Zr=(0,v.PA)((({item:e,store:t,state:n,crosshairRef:o})=>{if(!(0,u._n)(e))return null;if(!t.task||!e.currentSrc)return null;const i=e.regs,s=!!e.isMultiItem,r=[gr.wrapperComponent,e.images.length>1?gr.withGallery:gr.wrapper];s&&r.push(gr.withPagination);const{brushRegions:a,shapeRegions:l}=Pr(i),{brushRegions:d,shapeRegions:c}=Pr(e.suggestions),h=Object.entries({brush:a,shape:l,suggestedBrush:d,suggestedShape:c});return(0,A.jsxs)(A.Fragment,{children:[0===i.length&&(0,A.jsx)(Xs.Wd,{children:(0,A.jsx)(Xs.N1,{points:[0,0,0,1],stroke:"rgba(0,0,0,0)"})}),e.grid&&e.sizeUpdated&&(0,A.jsx)(Gs,{item:e}),(0,j.VS)(j.q$)?(0,A.jsx)(Fr,{item:e}):null,h.map((([e,t])=>{const n=null!==e.match(/brush/i),o=null!==e.match("suggested");return t.length>0?(0,A.jsx)(Or,{name:e,regions:t,useLayers:!1===n,suggestion:o},e):(0,A.jsx)(m.Fragment,{},e)})),(0,A.jsx)($r,{item:e,isPanning:n.isPanning}),(0,A.jsx)(Ir,{item:e}),e.crosshair&&(0,A.jsx)(Ur,{ref:o,width:(0,j.VS)(j.pG)?e.containerWidth:e.stageWidth,height:(0,j.VS)(j.pG)?e.containerHeight:e.stageHeight})]})}));var qr=n(78438);const Jr=[4,4,0,0],Qr=({x:e,y:t,text:n,score:o,showLabels:i,rotation:s=0,zoomScale:r=1,color:a,maxWidth:l,onClickLabel:d,onMouseEnterLabel:c,onMouseLeaveLabel:u,adjacent:h=!1,isTexting:g=!1})=>{var p;const f=20,v=1/r,[y,b]=(0,m.useState)(),x=o?34:0,S=Math.max(0,l*r-25-x),w=!!S,{suggestion:k}=null!=(p=(0,m.useContext)(Cr))?p:{},C=(0,m.useMemo)((()=>{if(!i||!y||!l)return null;return(n?y.measureSize(n).width:0)>S?S:null}),[y,n,l,v]),j=(0,m.useCallback)(((e,t)=>{const n=h&&w?Jr:4,o=l?Math.min(t.width()+25,w?l*r:20):t.width()+25,i=t.height();if(e.beginPath(),n){let t=0,s=0,r=0,a=0;"number"==typeof n?t=s=r=a=Math.min(n,o/2,i/2):(t=Math.min(n[0],o/2,i/2),s=Math.min(n[1],o/2,i/2),a=Math.min(n[2],o/2,i/2),r=Math.min(n[3],o/2,i/2)),e.moveTo(t,0),e.lineTo(o-s,0),e.arc(o-s,s,s,3*Math.PI/2,0,!1),e.lineTo(o,i-a),e.arc(o-a,i-a,a,0,Math.PI/2,!1),e.lineTo(r,i),e.arc(r,i-r,r,Math.PI/2,Math.PI,!1),e.lineTo(0,t),e.arc(t,t,t,Math.PI,3*Math.PI/2,!1)}else e.rect(0,0,o,i);e.closePath(),e.fillStrokeShape(t)}),[h,w,l]);return i?(0,A.jsxs)(Xs.YJ,{strokeScaleEnabled:!1,x:e,y:t,rotation:s,children:[!!o&&(0,A.jsxs)(Xs.JU,{y:-20*v,scaleX:v,scaleY:v,onClick:()=>!1,children:[(0,A.jsx)(Xs.vw,{fill:sn.Colors.getScaleGradient(o),cornerRadius:2}),(0,A.jsx)(Xs.EY,{text:o.toFixed(2),fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif",fontSize:13,fill:"white",padding:0,lineHeight:1/13*f})]}),(0,A.jsxs)(Xs.JU,{x:20*v+x*v,y:-20*v,scaleX:v,scaleY:v,onClick:d,onMouseEnter:d?c:null,onMouseLeave:d?u:null,listening:!k,children:[(0,A.jsx)(Xs.vw,{fill:a,cornerRadius:4,sceneFunc:j,offsetX:20}),(0,A.jsx)(Xs.EY,{ref:b,text:n,fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif",fontSize:13,lineHeight:1/13*f,height:f,width:C,wrap:"none",ellipsis:"true",fill:z.A.SHOW_LABEL_FILL,padding:0})]}),(0,A.jsx)(Xs.wA,{x:2*v+x*v,y:2*v-f*v,scaleX:v,scaleY:v,fill:z.A.SHOW_LABEL_FILL,data:g?"M13,1v2H6C4.11,3,3.17,3,2.59,3.59C2,4.17,2,5.11,2,7v2c0,1.89,0,2.83,0.59,3.41C3.17,13,4.11,13,6,13h7v2h1V1H13z M6,9.5C5.17,9.5,4.5,8.83,4.5,8S5.17,6.5,6,6.5S7.5,7.17,7.5,8S6.83,9.5,6,9.5z M11,9.5c-0.83,0-1.5-0.67-1.5-1.5s0.67-1.5,1.5-1.5s1.5,0.67,1.5,1.5S11.83,9.5,11,9.5z":"M13.47,2.52c-0.27-0.27-0.71-0.27-1.59-0.27h-0.64c-1.51,0-2.26,0-2.95,0.29C7.61,2.82,7.07,3.35,6,4.43L3.65,6.78c-0.93,0.93-1.4,1.4-1.4,1.97c0,0.58,0.46,1.04,1.39,1.97l1.63,1.63c0.93,0.93,1.39,1.39,1.97,1.39s1.04-0.46,1.97-1.39L11.57,10c1.07-1.07,1.61-1.61,1.89-2.29c0.28-0.68,0.28-1.44,0.28-2.96V4.11C13.74,3.23,13.74,2.8,13.47,2.52z M10.5,6.9c-0.77,0-1.4-0.63-1.4-1.4s0.63-1.39,1.4-1.39s1.39,0.63,1.39,1.4S11.27,6.9,10.5,6.9z"})]}):null},ea=(0,v.PA)((({item:e,color:t,strokewidth:n})=>{if(!e.parent)return null;const o=!!e.texting,i=e.getLabelText(","),s=e.parent,r=e.parent.zoomScale||1;return(0,A.jsx)(Qr,{x:s.internalToCanvasX(e.x-e.radiusX)-n/2/r,y:s.internalToCanvasY(e.y-e.radiusY)-n/2/r,isTexting:o,text:i,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})})),ta=(0,v.PA)((({item:e,color:t,strokewidth:n})=>{if(!e.parent)return null;const o=!!e.texting,i=e.getLabelText(","),s=e.parent,r=e.parent.zoomScale||1;return(0,A.jsx)(Qr,{x:s.internalToCanvasX(e.x)-n/2/r,y:s.internalToCanvasY(e.y)-n/2/r,isTexting:o,text:i,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,rotation:e.rotation,color:t,maxWidth:s.internalToCanvasX(e.width)+n,adjacent:!0,onClickLabel:e.onClickLabel})})),na=(0,v.PA)((({item:e,color:t})=>{var n;if(!e.parent)return null;const o=!!e.texting,i=e.getLabelText(","),s=e.bboxCoordsCanvas;if(!s)return null;const r=(0,u.Zn)(e).settings;return(0,A.jsxs)(m.Fragment,{children:[r.showLabels&&(0,A.jsx)(Xs.rw,{x:s.left,y:s.top,fillEnabled:!1,width:s.right-s.left,height:s.bottom-s.top,stroke:null==(n=e.style)?void 0:n.strokecolor,strokeWidth:1,strokeScaleEnabled:!1,shadowBlur:0}),(0,A.jsx)(Qr,{x:s.left,y:s.top+2/e.parent.zoomScale,isTexting:o,text:i,score:e.score,showLabels:r.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})]})})),oa=(0,v.PA)((({item:e,color:t})=>{var n;if(!e.parent)return null;const o=(0,u.Zn)(e).settings;if(!o.showLabels)return null;const i=!!e.texting,s=e.getLabelText(","),r=e.bboxCoordsCanvas;return r?(0,A.jsxs)(Xs.YJ,{name:"region-label",children:[(0,A.jsx)(Xs.rw,{x:r.left,y:r.top,fillEnabled:!1,width:r.right-r.left,height:r.bottom-r.top,stroke:null==(n=e.style)?void 0:n.strokecolor,strokeWidth:1,strokeScaleEnabled:!1,shadowBlur:0}),(0,A.jsx)(Qr,{x:r.left,y:r.top+2/e.parent.zoomScale,isTexting:i,text:s,score:e.score,showLabels:o.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})]}):null})),ia=(0,v.PA)((({item:e,color:t})=>{if(!e.parent)return null;const n=!!e.texting,o=e.getLabelText(",");return(0,A.jsx)(Qr,{x:e.canvasX+(e.canvasWidth+2)/e.parent.zoomScale,y:e.canvasY+(e.canvasWidth+2)/e.parent.zoomScale,isTexting:n,text:o,score:e.score,showLabels:(0,u.Zn)(e).settings.showLabels,zoomScale:e.parent.zoomScale,color:t,onClickLabel:e.onClickLabel})})),sa=(0,v.PA)((({reg:e,box:t,color:n,scale:o,strokeWidth:i,adjacent:s=!1})=>{const r=!!e.texting,a=e.getLabelText(",");return(0,A.jsx)(Qr,{x:t.x,y:t.y,rotation:t.rotation,isTexting:r,text:a,score:e.score,showLabels:e.store.settings.showLabels,zoomScale:o,color:n,maxWidth:t.width+i,adjacent:s,onClickLabel:e.onClickRegion})})),ra=u.gK.model({}).views((e=>({get bboxCoords(){return console.warn("KonvaRegionMixin needs to implement bboxCoords getter in regions"),null},get bboxCoordsCanvas(){const t=e.bboxCoords;return(0,j.VS)(j.MV)?e.parent?{left:e.parent.internalToCanvasX(t.left),top:e.parent.internalToCanvasY(t.top),right:e.parent.internalToCanvasX(t.right),bottom:e.parent.internalToCanvasY(t.bottom)}:null:t},get inViewPort(){return!(0,j.VS)(j.pG)||!!e&&!!e.bboxCoordsCanvas&&!!e.object&&e.bboxCoordsCanvas.right>=e.object.viewPortBBoxCoords.left&&e.bboxCoordsCanvas.bottom>=e.object.viewPortBBoxCoords.top&&e.bboxCoordsCanvas.left<=e.object.viewPortBBoxCoords.right&&e.bboxCoordsCanvas.top<=e.object.viewPortBBoxCoords.bottom},get control(){var t;return null==(t=e.results.find((e=>e.from_name.tools)))?void 0:t.from_name},get canRotate(){var t;return(null==(t=e.control)?void 0:t.canrotate)&&e.supportsRotate},get supportsTransform(){return!e.isReadOnly()&&(this._supportsTransform&&!this.hidden)}}))).actions((e=>({updateCursor(t=!1){var n,o;const i=null==(n=e.parent)?void 0:n.stageRef;if(!i)return;const s=i.container().style;if(t)return void(e.annotation.isLinkingMode?s.cursor=z.A.LINKING_MODE_CURSOR:"brushregion"!==e.type&&(s.cursor=z.A.POINTER_CURSOR));const r=null==(o=e.parent)?void 0:o.getToolsManager().findSelectedTool();r&&r.updateCursor?r.updateCursor():s.cursor=z.A.DEFAULT_CURSOR},checkSizes(){const{naturalWidth:t,naturalHeight:n,stageWidth:o,stageHeight:i}=e.parent;o>1&&i>1&&(null==e.updateImageSize||e.updateImageSize(o/t,i/n,o,i))},selectRegion(){e.scrollToRegion()},scrollToRegion(){var t;const n=e.object.zoomScale>1,o=null==(t=e.shapeRef)||null==(t=t.parent)||null==(t=t.canvas)?void 0:t._canvas;let i=o;for(;i&&!i.scrollTop&&!i.className.includes("main-content");)i=i.parentElement;if(!i)return;const s=i.getBoundingClientRect(),r=o.getBoundingClientRect(),a=n?{top:0,bottom:r.height}:e.bboxCoordsCanvas,l=a.bottom-a.top,d=a.top-(s.top-r.top),c=o.clientHeight-a.bottom-(r.bottom-s.bottom)-36,u=n&&o.clientHeight>i.clientHeight;if(!(d<0&&c<0))if(d<0&&-d/l>.4){if(n&&(r.bottom-s.top)/i.clientHeight>.4)return;i.scrollBy({top:u?-c:d,left:0,behavior:"smooth"})}else if(c<0&&-c/l>.4){if(n&&(s.bottom-r.top)/i.clientHeight>.4)return;i.scrollBy({top:u?d:-c,left:0,behavior:"smooth"})}},onClickRegion(t){const n=e.annotation,o=(null==t?void 0:t.evt)||t,i=(null==o?void 0:o.ctrlKey)||(null==o?void 0:o.metaKey);t&&(t.cancelBubble=!0);if(2===o.detail)return void e.onDoubleClickRegion();!n.isReadOnly()&&n.isLinkingMode?(n.addLinkedRegion(e),n.stopLinkingMode(),n.regionStore.unselectAll()):e._selectArea(i)},onDoubleClickRegion(){e.requestPerRegionFocus(),e.annotation.selectAreas([e])}})));var aa=n(87261);const la=["item"],da=(e,t)=>{const n=(0,v.PA)(e);return(0,v.PA)((e=>{let{item:o}=e,i=(0,Zn.A)(e,la);const s=(null==t?void 0:t.renderHidden)||!o.hidden,r=null==t?void 0:t.shouldNotUsePortal,a=r?m.Fragment:aa.ZL,l=r?{}:{selector:".selection-regions-layer",enabled:o.inSelection},d=!!o.annotation,c=(0,m.useCallback)((e=>{(0,u._n)(o)&&o.setShapeRef(e)}),[o]);return d&&(0,u._n)(o)&&s?(0,A.jsx)(a,Object.assign({},l,{children:(0,A.jsx)(n,Object.assign({item:o},i,{setShapeRef:c}))})):null}))},ca=(0,v.PA)((({item:e,useLayer:t})=>{const n=(e=>{const{shapeRef:t,bboxCoordsCanvas:n}=e;let o,i,s,r;if((0,x.isDefined)(n))[o,i,s,r]=[n.right-n.left,n.bottom-n.top,n.left,n.top];else{if(!(0,x.isDefined)(t))return null;var a,l;[o,i]=[null!=(a=null==t?void 0:t.width())?a:0,null!=(l=null==t?void 0:t.height())?l:0],[s,r]=[e.x+o/2-32,e.x+o/2-32]}return{x:s+o/2-32,y:r+i+10}})(e),[o,i]=(0,m.useState)(!1),s=1/e.parent.zoomScale;if(n){const r={width:64,height:32},a=t?{x:0,y:0,scaleX:1,scaleY:1}:{x:n.x,y:n.y,scaleX:s,scaleY:s},l=t?{x:n.x,y:n.y,scaleX:s,scaleY:s}:{},d=(0,A.jsxs)(Xs.YJ,Object.assign({},r,a,{opacity:e.highlighted||o?1:.5,onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),children:[(0,A.jsx)(Xs.rw,{x:0,y:0,width:64,height:32,fill:"#000",cornerRadius:16}),(0,A.jsx)(ua,{onClick:()=>e.annotation.rejectSuggestion(e.id),fill:"#DD0000",iconColor:"#fff",icon:To.kLH}),(0,A.jsx)(ua,{x:32,onClick:()=>e.annotation.acceptSuggestion(e.id),fill:"#98C84E",iconColor:"#fff",icon:To.iWP})]}));return t?(0,A.jsx)(Xs.Wd,Object.assign({},r,l,{children:d})):d}return null})),ua=({x:e=0,fill:t,iconColor:n,onClick:o,icon:i})=>{const[s,r]=(0,m.useState)(new window.Image),a=St()(null!=n?n:"#fff"),[l,d]=(0,m.useState)(!1);(0,m.useEffect)((()=>{const e=new window.Image;e.onload=()=>{r(e)},e.width=12,e.height=12,e.src=i}),[i]);const c=(0,m.useCallback)((e=>{if(e){const[t,n,o,i]=a.rgba();e.cache(),e.setAttrs({red:t,green:n,blue:o,alpha:i})}}),[]);return(0,A.jsxs)(Xs.YJ,{x:e,width:32,height:32,onClick:o,onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:[(0,A.jsx)(Xs.jl,{x:16,y:16,radius:14,opacity:l?1:.2,fill:l?t:"#fff"}),(0,A.jsx)(Xs._V,{ref:e=>c(e),x:8,y:8,width:16,height:16,image:s,filters:[Ct.A.Filters.RGB]})]})},ha=(0,v.PA)((({item:e,children:t})=>{var n;const{suggestion:o}=null!=(n=(0,m.useContext)(Cr))?n:{};return(0,A.jsxs)(m.Fragment,{children:[t,o&&(0,A.jsx)(ca,{item:e,useLayer:"brushregion"===e.type})]})})),ga={shadowColor:"red",shadowBlur:1,shadowOffsetY:2,shadowOffsetX:2,shadowOpacity:1},ma=u.gK.model("Points",{id:u.gK.optional(u.gK.identifier,T),type:u.gK.optional(u.gK.enumeration(["add","eraser"]),"add"),points:u.gK.array(u.gK.number),relativePoints:u.gK.array(u.gK.number),strokeWidth:u.gK.optional(u.gK.number,25),relativeStrokeWidth:u.gK.optional(u.gK.number,25),eraserSize:u.gK.optional(u.gK.number,25)}).views((e=>({get store(){return(0,u.Zn)(e)},get parent(){return(0,u.p7)(e,2)?(0,u.PA)(e,2):null},get stage(){var t;return null==(t=e.parent)?void 0:t.parent},get compositeOperation(){return"add"===e.type?"source-over":"destination-out"}}))).actions((e=>({updateImageSize(t,n,o,i){e.points=e.relativePoints.map(((e,t)=>e*(!(t%2)?o:i)/100)),e.strokeWidth=e.relativeStrokeWidth*o/100},setType(t){e.type=t},addPoint(t,n){t/=e.parent.scaleX,n/=e.parent.scaleY,e.points.push(t),e.points.push(n)},setPoints(t){e.points=t.map(((t,n)=>t/(n%2==0?e.parent.scaleX:e.parent.scaleY))),e.relativePoints=t.map(((t,n)=>t/(n%2==0?e.stage.stageWidth:e.stage.stageHeight)*100)),e.relativeStrokeWidth=e.strokeWidth/e.stage.stageWidth*100},rescale(t,n,o){const i=o/t;return e.points.map((e=>e*i))},scaledStrokeWidth:(t,n,o)=>o/t*e.strokeWidth}))),pa=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"brushregion",object:u.gK.late((()=>u.gK.reference(yd))),coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc"),rle:u.gK.frozen(),maskDataURL:u.gK.frozen(),touches:u.gK.array(ma),currentTouch:u.gK.maybeNull(u.gK.reference(ma))}).volatile((()=>({tension:0,opacity:.6,scaleX:1,scaleY:1,mode:"brush",needsUpdate:1,hideable:!0,layerRef:void 0,imageData:null}))).views((e=>({get parent(){return(0,u._n)(e)?e.object:null},get colorParts(){const t=e.style||e.tag||z.l;return(0,bt.colorToRGBAArray)(t.strokecolor)},get strokeColor(){return(0,bt.rgbArrayToHex)(e.colorParts)},get touchesLength(){return e.touches.length},get bboxCoordsCanvas(){if(!e.imageData){const a={x:[],y:[]};for(let l=0;l in(null!=(t=null==(n=e.touches)||null==(n=n[0])?void 0:n.points)?t:[]);l+=2){var t,n,o,i,s,r;const d=(null!=(o=null==(i=e.touches)||null==(i=i[0])?void 0:i.points)?o:[])[l],c=(null!=(s=null==(r=e.touches)||null==(r=r[0])?void 0:r.points)?s:[])[l+1];a.x.push(d),a.y.push(c)}return{left:Math.min(...a.x),top:Math.min(...a.y),right:Math.max(...a.x),bottom:Math.max(...a.y)}}const a=Z.getImageDataBBox(e.imageData.data,e.imageData.width,e.imageData.height);if(!a)return null;const{stageScale:l=1,zoomingPositionX:d=0,zoomingPositionY:c=0}=e.parent||{};return a.x=a.x/l-d/l,a.y=a.y/l-c/l,a.width=a.width/l,a.height=a.height/l,{left:a.x,top:a.y,right:a.x+a.width,bottom:a.y+a.height}},get bboxCoords(){const t=e.bboxCoordsCanvas;return t?(0,j.VS)(j.MV)?{left:e.parent.canvasToInternalX(t.left),top:e.parent.canvasToInternalY(t.top),right:e.parent.canvasToInternalX(t.right),bottom:e.parent.canvasToInternalY(t.bottom)}:t:null}}))).actions((e=>{let t,n,o,i=-1,s=-1;return{afterCreate(){e.updateMaskImage()},updateMaskImage(){e.maskDataURL&&(o||(o=new window.Image),o.src=e.maskDataURL)},getMaskImage:()=>o,setLayerRef(t){t&&(t.canvas._canvas.style.opacity=e.opacity,e.layerRef=t)},cacheImageData(){if(e.layerRef){const t=e.layerRef.toCanvas().getContext("2d");e.imageData=t.getImageData(0,0,e.layerRef.canvas.width,e.layerRef.canvas.height)}else e.imageData=null},prepareCoords:([t,n])=>e.parent.zoomOriginalCoords([t,n]),preDraw(o,r){if(!e.layerRef)return;const a=e.layerRef.canvas.context;if(a.save(),(0,j.VS)(j.pG)&&(a.beginPath(),a.rect(e.parent.alignmentOffset.x,e.parent.alignmentOffset.y,e.parent.stageWidth*e.parent.stageScale,e.parent.stageHeight*e.parent.stageScale),a.clip()),a.beginPath(),n.length/2>3)a.moveTo(...e.prepareCoords([i,s]));else if(0===n.length)a.moveTo(...e.prepareCoords([o,r]));else{a.moveTo(...e.prepareCoords([n[0],n[1]]));for(let t=0;t<n.length/2;t++)a.lineTo(...e.prepareCoords([n[2*t],n[2*t+1]]))}a.lineTo(...e.prepareCoords([o,r])),a.lineCap="round",a.lineJoin="round",a.lineWidth=t.strokeWidth*e.scaleX*e.parent.stageScale,a.strokeStyle=e.strokeColor,a.globalCompositeOperation=t.compositeOperation,a.stroke(),a.restore(),i=o,s=r},beginPath:({type:o,strokeWidth:i,opacity:s=e.opacity})=>(e.object.annotation.pauseAutosave(),t=ma.create({id:T(),type:o,strokeWidth:i,opacity:s}),n=[],t),addPoint(t,o){e.preDraw(t,o),n.push(t),n.push(o)},endPath(){const{annotation:o}=e.object;o.startAutosave(),2===n.length&&(n.push(n[0]),n.push(n[1])),e.touches.push(t),e.currentTouch=t,t.setPoints(n),i=s=-1,t=null,n=[],e.notifyDrawingFinished(),o.autosave&&setTimeout((()=>o.autosave()))},endUpdatedMaskDataURL(t){const{annotation:n}=e.object;n.startAutosave(),e.maskDataURL=t,e.updateMaskImage(),e.notifyDrawingFinished(),n.autosave&&setTimeout((()=>n.autosave()))},convertPointsToMask(){},setScale(t,n){e.scaleX=t,e.scaleY=n},updateImageSize(t,n,o,i){e.parent.stageWidth>1&&e.parent.stageHeight>1&&(e.touches.forEach((e=>e.updateImageSize(t,n,o,i))),e.needsUpdate=e.needsUpdate+1)},addState(t){e.states.push(t)},convertToImage(){if(e.touches.length){const t=e.object,n=qr.A.Region2RLE(e,t,{color:e.strokeColor});e.touches=[],e.rle=Array.from(n)}},serialize(t){const n=e.object,o={format:"rle"};if(null!=t&&t.fast)o.rle=e.rle,e.touches.length&&(o.touches=e.touches),e.maskDataURL&&(o.maskDataURL=e.maskDataURL);else{const t=qr.A.Region2RLE(e,n);if(!t||!t.length)return null;o.rle=Array.from(t)}return e.parent.createSerializedResult(e,o)}}})),fa=u.gK.compose("BrushRegionModel",ut,Ze,yt,ra,Ve,pa),va=(0,v.PA)((({item:e,setShapeRef:t,pointsList:n})=>{const o=(0,m.useCallback)(((e,{points:t,strokeWidth:n,strokeColor:o,compositeOperation:i})=>{e.save(),e.beginPath(),e.moveTo(t[0],t[1]);for(let n=0;n<t.length/2;n++)e.lineTo(t[2*n],t[2*n+1]);e.lineCap="round",e.lineJoin="round",e.lineWidth=n,e.strokeStyle=o,e.globalCompositeOperation=i,e.stroke(),e.restore()})),i=(0,m.useCallback)((t=>{n.forEach((n=>{o(t,{points:n.points,strokeWidth:n.strokeWidth,strokeColor:e.strokeColor,compositeOperation:n.compositeOperation})}))}),[n,n.length,e.strokeColor]),s=(0,m.useCallback)(((e,t)=>{n.forEach((n=>{o(e,{points:n.points,strokeWidth:n.strokeWidth,strokeColor:"eraser"===n.type?"#ffffff":t.colorKey,compositeOperation:"source-over"})}))}),[n,n.length]);return(0,A.jsx)(Xs.yp,{ref:e=>t(e),sceneFunc:i,hitFunc:s})})),ya=da((({item:e,setShapeRef:t})=>{var n,o,i,s,r,a,l,d,c,h,g,p;const[f,v]=(0,m.useState)(),{suggestion:y}=null!=(n=(0,m.useContext)(Cr))?n:{};(0,m.useEffect)((()=>{(async()=>{if(!e.rle&&!e.maskDataURL)return;if(!e.parent||e.parent.naturalWidth<=1||e.parent.naturalHeight<=1)return;let t;e.maskDataURL?t=await qr.A.maskDataURL2Image(e.maskDataURL,{color:e.strokeColor}):e.rle&&(t=qr.A.RLE2Region(e,{color:e.strokeColor})),t&&(t.onload=()=>{v(t),e.setReady(!0)})})()}),[e.rle,e.maskDataURL,e.maskBoundsMinX,e.maskBoundsMinY,e.maskBoundsMaxX,e.maskBoundsMaxY,e.parent,null==(o=e.parent)?void 0:o.naturalWidth,null==(i=e.parent)?void 0:i.naturalHeight,e.strokeColor,e.opacity]);const b=(0,m.useMemo)((()=>{let t;return(n,o)=>{if(f){if(!t){n.drawImage(f,0,0,e.parent.stageWidth,e.parent.stageHeight),t=(0,j.VS)(j.pG)?n.getImageData(e.parent.alignmentOffset.x,e.parent.alignmentOffset.y,e.parent.stageWidth,e.parent.stageHeight):n.getImageData(0,0,e.parent.stageWidth,e.parent.stageHeight);const i=(0,bt.colorToRGBAArray)(o.colorKey);for(let e=t.data.length/4-1;e>=0;e--)if(t.data[4*e+3]>0)for(let n=0;n<3;n++)t.data[4*e+n]=i[n]}n.putImageData(t,0,0)}}}),[f,null==(s=e.parent)?void 0:s.stageWidth,null==(r=e.parent)?void 0:r.stageHeight]),{store:x}=e,S=(0,m.useRef)(new window.Image),w=(0,m.useRef)(),k=(0,m.useRef)({});k.current.highlighted=e.highlighted,k.current.highlight=k.current.highlighted?ga:{shadowOpacity:0};const C=(0,m.useMemo)((()=>{let t=!1;return async()=>{var n;const{highlighted:o}=k.current,i=w.current;if((null==(n=e.parent)?void 0:n.drawingRegion)===e||!i||t)return;let s;o&&(s=i.findOne(".highlight"),s.hide()),i.draw();const r=i.canvas.toDataURL();e.cacheImageData(),o&&(s.show(),i.draw()),S.current.src=r,t=!0}}),[e.touches.length,e.strokeColor,null==(a=e.parent)?void 0:a.stageScale,null==(l=x.annotationStore.selected)?void 0:l.id,null==(d=e.parent)?void 0:d.zoomingPositionX,null==(c=e.parent)?void 0:c.zoomingPositionY,null==(h=e.parent)?void 0:h.stageWidth,null==(g=e.parent)?void 0:g.stageHeight,e.maskDataURL,e.rle,f]),R=(0,m.useCallback)((t=>{(0,u._n)(e)&&e.setLayerRef(t)}),[e]);if(!e.parent)return null;const _=null==(p=e.parent)?void 0:p.stageRef,T=(0,j.VS)(j.pG)?{scaleX:1/e.parent.zoomScale,scaleY:1/e.parent.zoomScale,x:-(e.parent.zoomingPositionX+e.parent.alignmentOffset.x)/e.parent.zoomScale,y:-(e.parent.zoomingPositionY+e.parent.alignmentOffset.y)/e.parent.zoomScale,width:e.containerWidth,height:e.containerHeight}:{scaleX:1/e.parent.stageScale,scaleY:1/e.parent.stageScale,x:-e.parent.zoomingPositionX/e.parent.stageScale,y:-e.parent.zoomingPositionY/e.parent.stageScale,width:e.parent.canvasSize.width,height:e.parent.canvasSize.height},K=(0,j.VS)(j.pG)?{x:0,y:0,width:e.parent.stageWidth,height:e.parent.stageHeight}:null;return(0,A.jsxs)(ha,{item:e,children:[(0,A.jsx)(Xs.Wd,{id:e.cleanId,ref:e=>{R(e),w.current=e},onDraw:()=>{setTimeout(C)},clearBeforeDraw:!e.isDrawing,visible:!e.hidden,clip:K,children:(0,A.jsxs)(Xs.YJ,{attrMy:e.needsUpdate,name:"segmentation",onMouseDown:e=>{x.annotationStore.selected.isLinkingMode&&(e.cancelBubble=!0)},onMouseOver:()=>{x.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{x.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{if(!e.parent.getSkipInteractions())if(x.annotationStore.selected.isLinkingMode)e.onClickRegion(t);else{if(!(0,j.VS)(j.pG)){const t=e.parent.getToolsManager().findSelectedTool(),n=t&&"MoveTool"===(0,u.Pw)(t).name;if(t&&!n)return}x.annotationStore.selected.isLinkingMode&&(_.container().style.cursor="default"),e.setHighlight(!1),e.onClickRegion(t)}},listening:!y,children:[(0,A.jsx)(Xs._V,{image:f,hitFunc:b,width:e.parent.stageWidth,height:e.parent.stageHeight}),(0,A.jsx)(Xs.YJ,{children:(0,A.jsx)(va,{store:x,item:e,pointsList:e.touches,setShapeRef:t})}),(0,A.jsx)(Xs._V,Object.assign({name:"highlight",image:S.current,sceneFunc:k.current.highlighted?null:()=>{},hitFunc:()=>{}},k.current.highlight,T,{listening:!1}))]})}),(0,A.jsx)(Xs.Wd,{id:`${e.cleanId}_labels`,ref:t=>{t&&(t.canvas._canvas.style.opacity=e.opacity)},children:(0,A.jsx)(Xs.YJ,{children:(0,A.jsx)(oa,{item:e,color:e.strokeColor})})})]})}),{renderHidden:!0,shouldNotUsePortal:!0});b.addTag("brushregion",fa,ya),b.addRegionType(fa,"image",(e=>e.rle||e.touches||e.maskDataURL));const ba={defaultOpacity:z.l.opacity,defaultFillColor:z.l.fillcolor,defaultStrokeColor:z.l.strokecolor,defaultStrokeColorHighlighted:z.A.HIGHLIGHTED_STROKE_COLOR,defaultStrokeWidth:z.l.strokewidth,defaultStrokeWidthHighlighted:z.A.HIGHLIGHTED_STROKE_WIDTH,defaultSuggestionWidth:z.A.SUGGESTION_STROKE_WIDTH},xa=(e,t={})=>{var n,o;const{suggestion:i}=null!=(n=(0,m.useContext)(Cr))?n:{},[s,r]=(0,m.useState)(e.highlighted),[a,l]=(0,m.useState)(null!=(o=e.fill)?o:t.useStrokeAsFill||t.includeFill),d=(0,m.useMemo)((()=>(({region:e,highlighted:t=!1,shouldFill:n=!1,useStrokeAsFill:o=!1,sameStrokeWidthForSelected:i=!1,suggestion:s=!1,defaultOpacity:r=z.l.opacity,defaultFillColor:a=z.l.fillcolor,defaultStrokeColor:l=z.l.strokecolor,defaultStrokeColorHighlighted:d=z.A.HIGHLIGHTED_STROKE_COLOR,defaultStrokeWidth:c=z.l.strokewidth,defaultStrokeWidthHighlighted:u=z.A.HIGHLIGHTED_STROKE_WIDTH,defaultSuggestionWidth:h=z.A.SUGGESTION_STROKE_WIDTH})=>{var g,m,p;const f=e.style||e.tag,v=e.inSelection||t,y=null==f?void 0:f.fillopacity,b=(0,x.isDefined)(y)?y:null==f?void 0:f.opacity,S=n?St()(null!=(g=o?null==f?void 0:f.strokecolor:null==f?void 0:f.fillcolor)?g:a).darken(.3).alpha(+(null!=(m=null!=b?b:r)?m:.5)).css():null;var w;return{strokeColor:v?d:St()(null!=(p=null==f?void 0:f.strokecolor)?p:l).css(),fillColor:S,strokeWidth:s?h:v&&!i?u:+(null!=(w=null==f?void 0:f.strokewidth)?w:c)}})(Object.assign({},ba,null!=t?t:{},{highlighted:s,shouldFill:a,region:e,suggestion:i}))),[e,i,t,s,a]);return(0,m.useEffect)((()=>{const t=["highlighted","fill"].map((t=>{try{return(0,c.lB)(e,t,(({newValue:e})=>{switch(t){case"highlighted":return r(e);case"fill":return l(e)}}),!0)}catch(e){return()=>{}}}));return()=>{t.forEach((e=>e()))}}),[e]),d};function Sa(e,t,n={x:e.left,y:e.top},o=1){if(!e)return e;const i=t*Math.PI/180,s=Math.cos(i),r=Math.sin(i),a=[{x:e.left-n.x,y:e.top-n.y},{x:e.right-n.x,y:e.top-n.y},{x:e.left-n.x,y:e.bottom-n.y},{x:e.right-n.x,y:e.bottom-n.y}].map((e=>({x:e.x*s-e.y*r/o,y:e.x*r*o+e.y*s}))),[l,d]=(0,x.minMax)(a.map((e=>e.x))),[c,u]=(0,x.minMax)(a.map((e=>e.y)));return{left:l+n.x,right:d+n.x,top:c+n.y,bottom:u+n.y}}const wa=u.gK.model({coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc")}).volatile((()=>({relativeX:0,relativeY:0,relativeWidth:0,relativeHeight:0,relativeRadiusX:0,relativeRadiusY:0}))).actions((e=>({afterCreate(){switch(e.startX=e.x,e.startY=e.y,e.coordstype){case"perc":e.relativeX=e.x,e.relativeY=e.y,e.relativeRadiusX=e.radiusX,e.relativeRadiusY=e.radiusY,e.relativeWidth=e.width,e.relativeHeight=e.height;break;case"px":{const{stageWidth:t,stageHeight:n}=e.parent;t&&n&&e.setPosition(e.x,e.y,e.radiusX,e.radiusY,e.rotation);break}}e.checkSizes(),e.updateAppearenceFromState()},setPosition(t,n,o,i,s){var r,a,l,d;e.x=t,e.y=n,e.radiusX=o,e.radiusY=i,e.relativeX=t/(null==(r=e.parent)?void 0:r.stageWidth)*tt,e.relativeY=n/(null==(a=e.parent)?void 0:a.stageHeight)*nt,e.relativeRadiusX=o/(null==(l=e.parent)?void 0:l.stageWidth)*tt,e.relativeRadiusY=i/(null==(d=e.parent)?void 0:d.stageHeight)*nt,e.rotation=(s+360)%360},setPositionInternal:(t,n,o,i,s)=>e.setPosition(t,n,o,i,s),updateImageSize(t,n,o,i){e.sw=o,e.sh=i,"px"===e.coordstype?(e.x=o*e.relativeX/tt,e.y=i*e.relativeY/nt,e.radiusX=o*e.relativeRadiusX/tt,e.radiusY=i*e.relativeRadiusY/nt):"perc"===e.coordstype&&(e.x=o*e.x/tt,e.y=i*e.y/nt,e.radiusX=o*e.radiusX/tt,e.radiusY=i*e.radiusY/nt,e.coordstype="px")}}))),ka=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"ellipseregion",object:u.gK.late((()=>u.gK.reference(yd))),x:u.gK.number,y:u.gK.number,radiusX:u.gK.number,radiusY:u.gK.number,rotation:0}).volatile((()=>({startX:0,startY:0,scaleX:1,scaleY:1,opacity:u.gK.number,fill:!0,fillColor:z.A.FILL_COLOR,fillOpacity:.2,strokeColor:z.A.STROKE_COLOR,strokeWidth:z.A.STROKE_WIDTH,_supportsTransform:!0,hideable:!0,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"},{property:"radiusX",label:"Rx"},{property:"radiusY",label:"Ry"},{property:"rotation",label:"icon:angle"}]}))).volatile((()=>({useTransformer:!0,preferTransformer:!0,supportsRotate:!0,supportsScale:!0}))).views((e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){const t={left:e.x-e.radiusX,top:e.y-e.radiusY,right:e.x+e.radiusX,bottom:e.y+e.radiusY};return 0===e.rotation?t:Sa(t,e.rotation,{x:e.x,y:e.y},e.parent.whRatio)},get canvasX(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.x):e.x},get canvasY(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasY(e.y):e.y},get canvasRadiusX(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.radiusX):e.radiusX},get canvasRadiusY(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasY(e.radiusY):e.radiusY}}))).actions((e=>({afterCreate(){e.startX=e.x,e.startY=e.y},coordsInside(t,n){const o=e.radiusX,i=e.radiusY;let s=t-e.x,r=n-e.y;const a=e.rotation;return s=s*Math.cos(Math.unit(a,"deg"))-r*Math.sin(Math.unit(a,"deg")),r=s*Math.sin(Math.unit(a,"deg"))+r*Math.cos(Math.unit(a,"deg")),Math.abs(s)<o&&(r**2<i**2*(1-s**2/o**2)||void 0)},setPositionInternal(t,n,o,i,s){e.x=t,e.y=n,e.radiusX=o,e.radiusY=i,e.rotation=(s+360)%360},setPosition(t,n,o,i,s){e.setPositionInternal(e.parent.canvasToInternalX(t),e.parent.canvasToInternalY(n),e.parent.canvasToInternalX(o),e.parent.canvasToInternalY(i),s)},setScale(t,n){e.scaleX=t,e.scaleY=n},setFill(t){e.fill=t},updateImageSize(){},serialize(){const t={x:(0,j.VS)(j.MV)?e.x:e.convertXToPerc(e.x),y:(0,j.VS)(j.MV)?e.y:e.convertYToPerc(e.y),radiusX:(0,j.VS)(j.MV)?e.radiusX:e.convertHDimensionToPerc(e.radiusX),radiusY:(0,j.VS)(j.MV)?e.radiusY:e.convertVDimensionToPerc(e.radiusY),rotation:e.rotation};return e.parent.createSerializedResult(e,t)}}))),Ca=u.gK.compose("EllipseRegionModel",ut,yt,Ze,ra,ln,ka,...(0,j.VS)(j.MV)?[]:[wa]),ja=da((({item:e,setShapeRef:t})=>{var n,o;const{store:i}=e,s=xa(e),r=null==(n=e.parent)?void 0:n.stageRef,{suggestion:a}=null!=(o=(0,m.useContext)(Cr))?o:{};return e.parent&&e.inViewPort?(0,A.jsxs)(m.Fragment,{children:[(0,A.jsx)(Xs.Pp,{x:e.canvasX,y:e.canvasY,ref:e=>t(e),radiusX:e.canvasRadiusX,radiusY:e.canvasRadiusY,fill:s.fillColor,stroke:s.strokeColor,strokeWidth:s.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,shadowBlur:0,scaleX:e.scaleX,scaleY:e.scaleY,opacity:1,rotation:e.rotation,name:`${e.id} _transformable`,onTransform:({target:e})=>{e.setAttr("skewX",0),e.setAttr("skewY",0)},onTransformEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("radiusX")*n.getAttr("scaleX"),n.getAttr("radiusY")*n.getAttr("scaleY"),n.getAttr("rotation")),n.setAttr("scaleX",1),n.setAttr("scaleY",1),e.notifyDrawingFinished()},onDragStart:t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},onDragEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("radiusX"),n.getAttr("radiusY"),n.getAttr("rotation")),e.setScale(n.getAttr("scaleX"),n.getAttr("scaleY")),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},dragBoundFunc:Kt(e,{x:e.x-e.bboxCoords.left,y:e.y-e.bboxCoords.top}),onMouseOver:()=>{i.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{i.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(i.annotationStore.selected.isLinkingMode&&(r.container().style.cursor=z.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))},draggable:!e.isReadOnly(),listening:!a}),(0,A.jsx)(ea,{item:e,color:s.strokeColor,strokewidth:s.strokeWidth})]}):null}));b.addTag("ellipseregion",Ca,ja),b.addRegionType(Ca,"image");const Ra=u.gK.model({coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc")}).volatile((()=>({relativeX:0,relativeY:0}))).actions((e=>({afterCreate(){if("perc"===e.coordstype)e.relativeX=e.x,e.relativeY=e.y,e.checkSizes();else{const{stageWidth:t,stageHeight:n}=e.parent;t&&n&&(e.relativeX=e.x/t*tt,e.relativeY=e.y/n*nt)}},setPosition(t,n){var o;const i=null==(o=e.control)?void 0:o.getSnappedPoint({x:e.parent.canvasToInternalX(t),y:e.parent.canvasToInternalY(n)});e.x=i.x,e.y=i.y,e.relativeX=i.x/e.parent.stageWidth*tt,e.relativeY=i.y/e.parent.stageHeight*nt},updateImageSize(t,n,o,i){"px"===e.coordstype&&(e.x=o*e.relativeX/tt,e.y=i*e.relativeY/nt),"perc"===e.coordstype&&(e.x=o*e.x/tt,e.y=i*e.y/nt,e.width=o*e.width/tt,e.coordstype="px")}}))),_a=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"keypointregion",object:u.gK.late((()=>u.gK.reference(yd))),x:u.gK.number,y:u.gK.number,width:u.gK.number,negative:!1}).volatile((()=>({hideable:!0,_supportsTransform:!0,useTransformer:!1,supportsRotate:!1,supportsScale:!1,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"}]}))).views((e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){return{left:e.x-e.width,top:e.y-e.width,right:e.x+e.width,bottom:e.y+e.width}},get canvasX(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.x):e.x},get canvasY(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasY(e.y):e.y},get canvasWidth(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.width):e.width}}))).actions((e=>({setPosition(t,n){var o;const i=null==(o=e.control)?void 0:o.getSnappedPoint({x:e.parent.canvasToInternalX(t),y:e.parent.canvasToInternalY(n)});e.x=i.x,e.y=i.y},updateImageSize(){},serialize(){const t={x:(0,j.VS)(j.MV)?e.x:e.convertXToPerc(e.x),y:(0,j.VS)(j.MV)?e.y:e.convertYToPerc(e.y),width:(0,j.VS)(j.MV)?e.width:e.convertHDimensionToPerc(e.width)},n=e.parent.createSerializedResult(e,t);return e.dynamic&&(n.is_positive=!e.negative,n.value.labels=e.labels),n}}))),Ta=u.gK.compose("KeyPointRegionModel",ut,yt,Ze,ra,ln,_a,...(0,j.VS)(j.MV)?[]:[Ra]),Aa=da((({item:e,setShapeRef:t})=>{var n,o,i,s;const{store:r}=e,{suggestion:a}=null!=(n=(0,m.useContext)(Cr))?n:{},l=xa(e,{includeFill:!0,defaultFillColor:"#000",defaultStrokeColor:"#fff",defaultOpacity:(null!=(o=e.style)?o:e.tag)?.6:1,sameStrokeWidthForSelected:!0}),d={opacity:1,fill:l.fillColor,stroke:l.strokeColor,strokeWidth:Math.max(1,l.strokeWidth),strokeScaleEnabled:!1,shadowBlur:0},c=null==(i=e.parent)?void 0:i.stageRef;return e.parent&&e.inViewPort?(0,A.jsxs)(m.Fragment,{children:[(0,A.jsx)(Xs.jl,Object.assign({x:e.canvasX,y:e.canvasY,ref:e=>t(e),radius:Math.max(e.canvasWidth,2)/(null==(s=e.parent)?void 0:s.zoomScale),perfectDrawEnabled:!1,name:`${e.id} _transformable`,onDragStart:t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},onDragEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y")),n.setAttr("x",e.canvasX),n.setAttr("y",e.canvasY),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},dragBoundFunc:Kt(e),transformsEnabled:"position",onTransformEnd:t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y")),n.setAttr("scaleX",1),n.setAttr("scaleY",1)},onMouseOver:()=>{r.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{r.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(r.annotationStore.selected.isLinkingMode&&(c.container().style.cursor=z.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))}},d,{draggable:!e.isReadOnly(),listening:!a})),(0,A.jsx)(ia,{item:e,color:l.strokeColor})]}):null}));b.addTag("keypointregion",Ta,Aa),b.addRegionType(Ta,"image",(e=>"x"in e&&"y"in e&&"width"in e&&!("height"in e)));const Ka=u.gK.model().volatile((()=>({relativeX:0,relativeY:0,initX:0,initY:0}))).actions((e=>({afterCreate(){e.initX=e.x,e.initY=e.y,"perc"===e.parent.coordstype?(e.relativeX=e.x,e.relativeY=e.y):(e.relativeX=e.x/e.stage.stageWidth*tt,e.relativeY=e.y/e.stage.stageHeight*nt)},movePoint(t,n){e.initX=e.initX+t,e.initY=e.initY+n,e.x=e.x+t,e.y=e.y+n,e.relativeX=e.x/e.stage.stageWidth*tt,e.relativeY=e.y/e.stage.stageHeight*nt},_setPos(t,n){e.initX=t,e.initY=n,e.relativeX=t/e.stage.stageWidth*tt,e.relativeY=n/e.stage.stageHeight*nt,e.x=t,e.y=n},_movePoint(t,n){var o;const i=null==(o=e.parent.control)?void 0:o.getSnappedPoint({x:e.stage.canvasToInternalX(t),y:e.stage.canvasToInternalY(n)});e._setPos(i.x,i.y)}}))),Ea=u.gK.model("PolygonPoint",{id:u.gK.optional(u.gK.identifier,T),x:u.gK.number,y:u.gK.number,index:u.gK.number,style:"circle",size:"small"}).volatile((()=>({selected:!1}))).views((e=>({get parent(){return(0,u.p7)(e,2)?(0,u.PA)(e,2):null},get stage(){var t;return null==(t=e.parent)?void 0:t.parent},get canvasX(){var t;return(0,j.VS)(j.MV)?null==(t=e.stage)?void 0:t.internalToCanvasX(e.x):e.x},get canvasY(){var t;return(0,j.VS)(j.MV)?null==(t=e.stage)?void 0:t.internalToCanvasY(e.y):e.y}}))).actions((e=>({movePoint(t,n){const o=e.stage.canvasToInternalX(t),i=e.stage.canvasToInternalY(n);e.x=e.x+o,e.y=e.y+i},_setPos(t,n){e.x=t,e.y=n},_movePoint(t,n){var o;const i=null==(o=e.parent.control)?void 0:o.getSnappedPoint({x:e.stage.canvasToInternalX(t),y:e.stage.canvasToInternalY(n)});e._setPos(i.x,i.y)},closeStartPoint(){e.annotation.isReadOnly()||e.parent.closed||e.parent.mouseOverStartPoint&&e.parent.closePoly()},handleMouseOverStartPoint(t){var n;t.cancelBubble=!0;const o=null==(n=e.stage)?void 0:n.stageRef;if(!o)return;if(o.container().style.cursor="crosshair",e.parent.closed||e.parent.points.length<3)return;const i=t.target;"rectangle"===e.style&&(i.setX(i.x()-i.width()/2),i.setY(i.y()-i.height()/2));const s={small:2,medium:3,large:4}[e.size];i.scale({x:s/e.stage.zoomScale,y:s/e.stage.zoomScale}),e.parent.setMouseOverStartPoint(!0)},handleMouseOutStartPoint(t){var n;const o=t.target,i=null==(n=e.stage)?void 0:n.stageRef;i&&(i.container().style.cursor="default","rectangle"===e.style&&(o.setX(o.x()+o.width()/2),o.setY(o.y()+o.height()/2)),o.scale({x:1/e.stage.zoomScale,y:1/e.stage.zoomScale}),e.parent.setMouseOverStartPoint(!1))},getSkipInteractions:()=>e.parent.control.obj.getSkipInteractions()}))),Pa=(0,j.VS)(j.MV)?Ea:u.gK.compose("PolygonPoint",Ea,Ka),Ma=u.gK.compose("PolygonPoint",Ne,Pa),Da=(0,v.PA)((({item:e,name:t})=>{if(!e.parent)return;const[n,o]=(0,m.useState)(!0),i=xa(e.parent),s={small:1,medium:2,large:3},r={small:4,medium:8,large:12}[e.size],a=0===e.index?{hitStrokeWidth:12,fill:i.strokeColor||e.primary,onMouseOver:e.handleMouseOverStartPoint,onMouseOut:e.handleMouseOutStartPoint}:null,l={onDragMove:t=>{if(e.getSkipInteractions())return!1;if(t.target!==t.currentTarget)return;const n=t.target;let{x:o,y:i}=n.attrs;o<0&&(o=0),i<0&&(i=0),o>e.stage.stageWidth&&(o=e.stage.stageWidth),i>e.stage.stageHeight&&(i=e.stage.stageHeight),e._movePoint(o,i),n.setAttr("x",e.canvasX),n.setAttr("y",e.canvasY)},onDragStart:()=>{if(e.getSkipInteractions())return o(!1),!1;e.annotation.history.freeze()},onDragEnd:t=>{o(!0),e.annotation.history.unfreeze(),t.cancelBubble=!0},onMouseOver:t=>{var n;t.cancelBubble=!0;const o=null==(n=e.stage)?void 0:n.stageRef;o&&(o.container().style.cursor="crosshair")},onMouseOut:()=>{var t;const n=null==(t=e.stage)?void 0:t.stageRef;n&&(n.container().style.cursor="default")},onTransformEnd(e){if(e.target!==e.currentTarget)return;const t=e.target;t.setAttr("x",0),t.setAttr("y",0),t.setAttr("scaleX",1),t.setAttr("scaleY",1)}},d=e.selected?"green":"white";return"circle"===e.style?(0,A.jsx)(Xs.jl,Object.assign({name:t,x:e.canvasX,y:e.canvasY,radius:r,fill:d,stroke:"black",strokeWidth:s[e.size],dragOnTop:!1,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,scaleX:1/(e.stage.zoomScale||1),scaleY:1/(e.stage.zoomScale||1),onDblClick:()=>{e.parent.deletePoint(e)},onClick:t=>{if(t.evt.altKey)return e.parent.deletePoint(e);e.parent.isDrawing&&1===e.parent.points.length||(t.evt.preventDefault(),t.cancelBubble=!0,e.parent.mouseOverStartPoint?(e.closeStartPoint(),e.parent.notifyDrawingFinished()):e.parent.setSelectedPoint(e))}},l,a,{draggable:!e.parent.isReadOnly()&&n}),t):(0,A.jsx)(Xs.rw,Object.assign({name:t,x:e.x-r/2,y:e.y-r/2,width:r,height:r,fill:d,stroke:"black",strokeWidth:s[e.size],strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,dragOnTop:!1},l,a,{draggable:!e.parent.isReadOnly()}),t)}));var Oa=n(67695);const Ia=u.gK.model({coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc")}).actions((e=>({updateImageSize(t,n,o,i){"px"===e.coordstype&&e.points.forEach((e=>{const t=o*e.relativeX/tt,n=i*e.relativeY/nt;e._setPos(t,n)})),e.annotation.sentUserGenerate||"perc"!==e.coordstype||e.points.forEach((t=>{const n=o*t.x/tt,s=i*t.y/nt;e.coordstype="px",t._setPos(n,s)}))}}))),La=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"polygonregion",object:u.gK.late((()=>u.gK.reference(yd))),points:u.gK.array(u.gK.union(Ma,u.gK.array(u.gK.number)),[]),closed:!0}).volatile((()=>({mouseOverStartPoint:!1,selectedPoint:null,hideable:!0,_supportsTransform:!0,useTransformer:!0,preferTransformer:!1,supportsRotate:!1,supportsScale:!0}))).views((e=>({get store(){return(0,u.Zn)(e)},get bboxCoords(){var t;if(null==(t=e.points)||!t.length||!(0,u._n)(e))return{};const n=e.points.reduce(((e,t)=>({left:Math.min(e.left,t.x),top:Math.min(e.top,t.y),right:Math.max(e.right,t.x),bottom:Math.max(e.bottom,t.y)})),{left:e.points[0].x,top:e.points[0].y,right:e.points[0].x,bottom:e.points[0].y});return(0,j.VS)(j.MV)||(0,x.fixMobxObserve)(e.parent.stageWidth,e.parent.stageHeight),n},get flattenedPoints(){return this.points.map((e=>[e.canvasX,e.canvasY])).reduce(((e,t)=>e.concat(t)),[])}}))).actions((e=>({afterCreate(){e.points.length&&(e.points[0].id||(e.points=e.points.map((([t,n],o)=>({id:T(),x:t,y:n,size:e.pointSize,style:e.pointStyle,index:o})))),e.checkSizes())},setMouseOverStartPoint(t){e.mouseOverStartPoint=t},setSelectedPoint(t){e.selectedPoint&&(e.selectedPoint.selected=!1),t.selected=!0,e.selectedPoint=t},handleMouseMove({e:t,flattenedPoints:n}){const{offsetX:o,offsetY:i}=t.evt,[s,r]=e.parent.fixZoomedCoords([o,i]),[a,l]=za({flattenedPoints:n,cursorX:s,cursorY:r});!function({point:e,group:t,layer:n,zoom:o}){const i=Va({layer:n})||function({point:e,group:t,layer:n,zoom:o}){const i=new Ct.A.Circle({name:"hoverAnchor",x:e[0],y:e[1],stroke:Oa.green.primary,fill:Oa.green[0],scaleX:1/(o||1),scaleY:1/(o||1),strokeWidth:2,radius:5});return t.add(i),n.draw(),i}({point:e,group:t,layer:n,zoom:o});i.to({x:e[0],y:e[1],duration:0})}({point:[a,l],group:t.currentTarget,layer:t.currentTarget.getLayer(),zoom:e.parent.zoomScale})},handleMouseLeave({e}){Ha({layer:e.currentTarget.getLayer()})},handleLineClick({e:t,flattenedPoints:n,insertIdx:o}){if(!e.closed||!e.selected)return;t.cancelBubble=!0,Ha({layer:t.currentTarget.getLayer()});const{offsetX:i,offsetY:s}=t.evt,[r,a]=e.parent.fixZoomedCoords([i,s]),l=za({flattenedPoints:n,cursorX:r,cursorY:a});e.insertPoint(o,l[0],l[1])},deletePoint(t){const n=e.points.length<=3&&t.parent.closed,o=1===e.points.length,i=e.selectedPoint===t;n||o||(i&&(e.selectedPoint=null),(0,u.zr)(t))},addPoint(t,n){var o;if(e.closed)return;const i=null==(o=e.control)?void 0:o.getSnappedPoint({x:t,y:n});e._addPoint(i.x,i.y)},setPoints(t){e.points.forEach(((e,n)=>{e.x=t[2*n],e.y=t[2*n+1]}))},insertPoint(t,n,o){var i;const s=null==(i=e.control)?void 0:i.getSnappedPoint({x:e.parent.canvasToInternalX(n),y:e.parent.canvasToInternalY(o)}),r=e.points[t-1]&&e.parent.isSamePixel(s,e.points[t-1]),a=e.points[t]&&e.parent.isSamePixel(s,e.points[t]);if(r||a)return;const l={id:T(),x:s.x,y:s.y,size:e.pointSize,style:e.pointStyle,index:e.points.length};return e.points.splice(t,0,l),e.points[t]},_addPoint(t,n){const o=e.points[0];e.parent.isSamePixel(o,{x:t,y:n})?e.closePoly():e.points.push({id:T(),x:t,y:n,size:e.pointSize,style:e.pointStyle,index:e.points.length})},closePoly(){e.closed||e.points.length<3||(e.closed=!0)},canClose(t,n){if(e.points.length<2)return!1;const o=e.points[0],i=t,s=n;return(o.x-i)**2+(o.y-s)**2<50},destroyRegion(){(0,u.Yo)(e.points),(0,u.zr)(e.points)},afterUnselectRegion(){e.selectedPoint&&(e.selectedPoint.selected=!1)},setScale(t,n){e.scaleX=t,e.scaleY=n},updateImageSize(){},serialize(){const t={points:(0,j.VS)(j.MV)?e.points.map((e=>[e.x,e.y])):e.points.map((t=>[e.convertXToPerc(t.x),e.convertYToPerc(t.y)])),closed:e.closed};return e.parent.createSerializedResult(e,t)}}))),Na=u.gK.compose("PolygonRegionModel",ut,yt,Ze,ra,La,...(0,j.VS)(j.MV)?[]:[Ia]);function za({flattenedPoints:e,cursorX:t,cursorY:n}){const[o,i,s,r]=e;return[t-(r-i)*(s*i-o*r+t*(r-i)-n*(s-o))/((r-i)*(r-i)+(s-o)*(s-o)),((s-o)*(s*i-o*r)+(s-o)*(r-i)*t+(r-i)*(r-i)*n)/((r-i)*(r-i)+(s-o)*(s-o))]}function Va({layer:e}){return e.findOne(".hoverAnchor")}function Ha({layer:e}){const t=Va({layer:e});t&&(t.destroy(),e.draw())}const Ba=(0,m.memo)((0,v.PA)((({item:e,colors:t,dragProps:n,draggable:o})=>{const{flattenedPoints:i}=e,s="poly";return(0,A.jsx)(Xs.YJ,{name:s,children:(0,A.jsx)(Xs.N1,Object.assign({name:"_transformable",lineJoin:"round",lineCap:"square",stroke:t.strokeColor,strokeWidth:t.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,points:i,fill:t.fillColor,closed:!0},n,{onTransformEnd:t=>{if(t.target!==t.currentTarget)return;const n=t.target,o=[n.getAttr("x",0),n.getAttr("y",0)],i=[n.getAttr("scaleX",1),n.getAttr("scaleY",1)],s=n.getAttr("points");e.setPoints(s.reduce(((t,n,r)=>{if(r%2==0){var a;const l=null==(a=e.control)?void 0:a.getSnappedPoint({x:e.parent.canvasToInternalX(n*i[0]+o[0]),y:e.parent.canvasToInternalY(s[r+1]*i[1]+o[1])});t.push(l.x,l.y)}return t}),[])),n.setAttr("x",0),n.setAttr("y",0),n.setAttr("scaleX",1),n.setAttr("scaleY",1)},draggable:o}))},s)}))),Fa=(0,v.PA)((({name:e,item:t,idx:n,p1:o,p2:i,closed:s,regionStyles:r})=>{const a=n+1,l=[o.canvasX,o.canvasY,i.canvasX,i.canvasY],d=s?{stroke:"transparent",strokeWidth:r.strokeWidth,strokeScaleEnabled:!1}:{stroke:r.strokeColor,strokeWidth:r.strokeWidth,strokeScaleEnabled:!1};return(0,A.jsx)(Xs.YJ,{name:e,onClick:e=>t.handleLineClick({e,flattenedPoints:l,insertIdx:a}),onMouseMove:e=>{t.closed&&t.selected&&!t.isReadOnly()&&t.handleMouseMove({e,flattenedPoints:l})},onMouseLeave:e=>t.handleMouseLeave({e}),children:(0,A.jsx)(Xs.N1,Object.assign({lineJoin:"round",opacity:1,points:l,hitStrokeWidth:20,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1},d))},e)})),Wa=(0,m.memo)((0,v.PA)((({item:e,regionStyles:t})=>{const{points:n,closed:o}=e,i="borders";return!e.closed||!e.parent.useTransformer&&e.selected?(0,A.jsx)(Xs.YJ,{name:i,children:n.map(((i,s)=>{const r=s,a=s===n.length-1?0:s+1;return o||0!==a?(0,A.jsx)(Fa,{name:`border_${r}_${a}`,item:e,idx:r,p1:n[s],p2:n[a],closed:o,regionStyles:t},`border_${r}_${a}`):null}))},i):null}))),$a=da((({item:e,setShapeRef:t})=>{var n,o,i,s;const{store:r}=e,{suggestion:a}=null!=(n=(0,m.useContext)(Cr))?n:{},l=xa(e,{useStrokeAsFill:!0});const d=(0,m.useMemo)((()=>{let t=!1;return{onDragStart:n=>{n.target===n.currentTarget&&(e.parent.getSkipInteractions()?n.currentTarget.stopDrag(n.evt):(t=!0,e.annotation.setDragMode(!0),e.annotation.history.freeze(e.id)))},dragBoundFunc:Kt(e,{x:-e.bboxCoords.left,y:-e.bboxCoords.top}),onDragEnd:n=>{if(!t)return;const o=n.target;if(n.target===n.currentTarget){var i,s,r,a,l;e.annotation.setDragMode(!1);const t=null==(i=e.control)?void 0:i.getSnappedPoint({x:null==(s=e.parent)?void 0:s.canvasToInternalX(o.getAttr("x")),y:null==(r=e.parent)?void 0:r.canvasToInternalY(o.getAttr("y"))});t.x=null==(a=e.parent)?void 0:a.internalToCanvasX(t.x),t.y=null==(l=e.parent)?void 0:l.internalToCanvasY(t.y),e.points.forEach((e=>e.movePoint(t.x,t.y))),e.annotation.history.unfreeze(e.id)}o.setAttr("x",0),o.setAttr("y",0),t=!1}}}),[e.bboxCoords.left,e.bboxCoords.top]);if((0,m.useEffect)((()=>{e.closed||e.control.tools.Polygon.resumeUnfinishedRegion(e)}),[e.closed]),!e.parent)return null;if(!e.inViewPort)return null;const c=null==(o=e.parent)?void 0:o.stageRef;return(0,A.jsxs)(Xs.YJ,Object.assign({name:e.id,ref:e=>t(e),onMouseOver:()=>{r.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{r.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||e.isDrawing||(t.cancelBubble=!0,e.closed&&(r.annotationStore.selected.isLinkingMode&&(c.container().style.cursor=z.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t)))}},d,{draggable:!(e.isReadOnly()||e.inSelection&&1!==(null==(i=e.parent)||null==(i=i.selectedRegions)?void 0:i.length)),listening:!a,children:[(0,A.jsx)(na,{item:e,color:l.strokeColor}),e.mouseOverStartPoint,e.points&&e.closed?(0,A.jsx)(Ba,{item:e,colors:l,dragProps:d,draggable:!e.isReadOnly()&&e.inSelection&&(null==(s=e.parent)||null==(s=s.selectedRegions)?void 0:s.length)>1}):null,e.points&&!e.isReadOnly()?(0,A.jsx)(Wa,{item:e,regionStyles:l}):null,e.points&&!e.isReadOnly()?function(t){const n="anchors";return!e.closed||!e.parent.useTransformer&&e.selected?(0,A.jsx)(Xs.YJ,{name:n,children:t.map(((n,o)=>function({points:t,idx:n}){const o=`anchor_${t.length}_${n}`,i=t[n];if(!e.closed||e.closed&&e.selected)return(0,A.jsx)(Da,{item:i,name:o},o)}({points:t,idx:o})))},n):null}(e.points):null]}),e.id?e.id:T(5))}));b.addTag("polygonregion",Na,$a),b.addRegionType(Na,"image",(e=>!!e.points));const Ua=u.gK.model({coordstype:u.gK.optional(u.gK.enumeration(["px","perc"]),"perc")}).volatile((()=>({relativeX:0,relativeY:0,relativeWidth:0,relativeHeight:0}))).actions((e=>({afterCreate(){switch(e.coordstype){case"perc":e.relativeX=e.x,e.relativeY=e.y,e.relativeWidth=e.width,e.relativeHeight=e.height;break;case"px":{const{stageWidth:t,stageHeight:n}=e.parent;t&&n&&e.setPosition(e.x,e.y,e.width,e.height,e.rotation);break}}e.checkSizes(),e.updateAppearenceFromState()},setPosition(t,n,o,i,s){var r,a,l,d;e.x=t,e.y=n,e.width=o,e.height=i,e.relativeX=t/(null==(r=e.parent)?void 0:r.stageWidth)*tt,e.relativeY=n/(null==(a=e.parent)?void 0:a.stageHeight)*nt,e.relativeWidth=o/(null==(l=e.parent)?void 0:l.stageWidth)*tt,e.relativeHeight=i/(null==(d=e.parent)?void 0:d.stageHeight)*nt,e.rotation=(s+360)%360},setPositionInternal:(t,n,o,i,s)=>e.setPosition(t,n,o,i,s),updateImageSize(t,n,o,i){"px"===e.coordstype?(e.x=o*e.relativeX/tt,e.y=i*e.relativeY/nt,e.width=o*e.relativeWidth/tt,e.height=i*e.relativeHeight/nt):"perc"===e.coordstype&&(e.x=o*e.x/tt,e.y=i*e.y/nt,e.width=o*e.width/tt,e.height=i*e.height/nt,e.coordstype="px")},draw(t,n,o){const i=e.height;if(1===o.length)e.width=e.getDistanceBetweenPoints({x:t,y:n},e),e.rotation=e.rotationAtCreation=Math.atan2(n-e.y,t-e.x)*(180/Math.PI);else if(2===o.length){const{y:i,x:s}=o[0],{y:r,x:a}=o[1];e.isAboveTheLine(o[0],o[1],{x:t,y:n})?(e.x=a,e.y=r,e.rotation=e.rotationAtCreation+180):(e.x=s,e.y=i,e.rotation=e.rotationAtCreation),e.height=e.getHeightOnPerpendicular(o[0],o[1],{x:t,y:n})}e.setPosition(e.x,e.y,e.width,e.height,e.rotation);const s=null==e?void 0:e.bboxCoords;((null==s?void 0:s.left)<0||(null==s?void 0:s.top)<0||(null==s?void 0:s.right)>e.parent.stageWidth||(null==s?void 0:s.bottom)>e.parent.stageHeight)&&(e.height=i)},getHeightOnPerpendicular(e,t,n){const o=t.x-e.x,i=t.y-e.y,s=t.y-n.y,r=s/o*i,a=n.x-t.x-r,l=Math.sqrt(r*r+s*s),d=l+a/l*r;return Math.abs(d)}}))),Ya=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"rectangleregion",object:u.gK.late((()=>u.gK.reference(yd))),x:u.gK.number,y:u.gK.number,width:u.gK.number,height:u.gK.number,rotation:0,rotationAtCreation:0}).volatile((()=>({startX:0,startY:0,scaleX:1,scaleY:1,opacity:1,fill:!0,fillColor:"#ff8800",fillOpacity:.2,strokeColor:z.A.STROKE_COLOR,strokeWidth:z.A.STROKE_WIDTH,_supportsTransform:!0,hideable:!0,editableFields:[{property:"x",label:"X"},{property:"y",label:"Y"},{property:"width",label:"W"},{property:"height",label:"H"},{property:"rotation",label:"icon:angle"}]}))).volatile((()=>({useTransformer:!0,preferTransformer:!0,supportsRotate:!0,supportsScale:!0}))).views((e=>({get store(){return(0,u.Zn)(e)},get parent(){return(0,u._n)(e)?e.object:null},get bboxCoords(){const t={left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height};return 0!==e.rotation&&e.parent?Sa(t,e.rotation,{x:e.x,y:e.y},e.parent.whRatio):t},get canvasX(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.x):e.x},get canvasY(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasY(e.y):e.y},get canvasWidth(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasX(e.width):e.width},get canvasHeight(){var t;return(0,j.VS)(j.MV)?null==(t=e.parent)?void 0:t.internalToCanvasY(e.height):e.height}}))).actions((e=>({afterCreate(){e.startX=e.x,e.startY=e.y},getDistanceBetweenPoints(e,t){const{x:n,y:o}=e,{x:i,y:s}=t,r=n-i,a=o-s;return Math.sqrt(r**2+a**2)},getHeightOnPerpendicular(e,t,n){const o=t.x-e.x,i=t.y-e.y;return Math.abs(i*n.x-o*n.y+t.x*e.y-t.y*e.x)/Math.sqrt(i*i+o*o)},isAboveTheLine:(e,t,n)=>(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)<0,draw(t,n,o){const i=e.height,s=e.parent.internalToCanvasX(t),r=e.parent.internalToCanvasY(n);if(1===o.length){const t=e.getDistanceBetweenPoints({x:s,y:r},{x:e.canvasX,y:e.canvasY});e.width=e.parent.canvasToInternalX(t),e.rotation=e.rotationAtCreation=Math.atan2(r-e.canvasY,s-e.canvasX)*(180/Math.PI)}else if(2===o.length){const t=o.map((({x:t,y:n})=>({x:e.parent.internalToCanvasX(t),y:e.parent.internalToCanvasY(n)}))),{y:n,x:i}=o[0],{y:a,x:l}=o[1];e.isAboveTheLine(t[0],t[1],{x:s,y:r})?(e.x=l,e.y=a,e.rotation=e.rotationAtCreation+180):(e.x=i,e.y=n,e.rotation=e.rotationAtCreation);const d=e.getHeightOnPerpendicular(t[0],t[1],{x:s,y:r});e.height=e.parent.canvasToInternalY(d)}e.setPositionInternal(e.x,e.y,e.width,e.height,e.rotation);const a=null==e?void 0:e.bboxCoords;((null==a?void 0:a.left)<0||(null==a?void 0:a.top)<0||(null==a?void 0:a.right)>tt||(null==a?void 0:a.bottom)>nt)&&(e.height=i)},coordsInside(t,n){const o=e.x,i=e.y,s=e.width*(e.scaleX||1),r=e.height*(e.scaleY||1);return t>o&&t<o+s&&n>i&&n<i+r},setPositionInternal(t,n,o,i,s){e.x=t,e.y=n,e.width=o,e.height=i,e.rotation=(s+360)%360},setPosition(t,n,o,i,s){e.setPositionInternal(e.parent.canvasToInternalX(t),e.parent.canvasToInternalY(n),e.parent.canvasToInternalX(o),e.parent.canvasToInternalY(i),s)},setScale(t,n){e.scaleX=t,e.scaleY=n},addState(t){e.states.push(t)},setFill(t){e.fill=t},updateImageSize(){},serialize(){const t={x:e.parent.stageWidth>1&&!(0,j.VS)(j.MV)?e.convertXToPerc(e.x):e.x,y:e.parent.stageWidth>1&&!(0,j.VS)(j.MV)?e.convertYToPerc(e.y):e.y,width:e.parent.stageWidth>1&&!(0,j.VS)(j.MV)?e.convertHDimensionToPerc(e.width):e.width,height:e.parent.stageWidth>1&&!(0,j.VS)(j.MV)?e.convertVDimensionToPerc(e.height):e.height,rotation:e.rotation};return e.parent.createSerializedResult(e,t)}}))),Xa=u.gK.compose("RectRegionModel",ut,Ze,yt,ra,ln,Ya,...(0,j.VS)(j.MV)?[]:[Ua]),Ga=da((({item:e,setShapeRef:t})=>{var n,o,i;const{store:s}=e,{suggestion:r}=null!=(n=(0,m.useContext)(Cr))?n:{},a=xa(e,{suggestion:r}),l=null==(o=e.parent)?void 0:o.stageRef,d={};return e.parent&&e.inViewPort?(r||e.isReadOnly()||(d.onTransform=({target:e})=>{e.setAttr("skewX",0),e.setAttr("skewY",0)},d.onTransformEnd=t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("width")*n.getAttr("scaleX"),n.getAttr("height")*n.getAttr("scaleY"),n.getAttr("rotation")),n.setAttr("scaleX",1),n.setAttr("scaleY",1),e.notifyDrawingFinished()},d.onDragStart=t=>{e.parent.getSkipInteractions()?t.currentTarget.stopDrag(t.evt):e.annotation.history.freeze(e.id)},d.onDragEnd=t=>{const n=t.target;e.setPosition(n.getAttr("x"),n.getAttr("y"),n.getAttr("width"),n.getAttr("height"),n.getAttr("rotation")),e.setScale(n.getAttr("scaleX"),n.getAttr("scaleY")),e.annotation.history.unfreeze(e.id),e.notifyDrawingFinished()},d.dragBoundFunc=Kt(e,{x:e.x-e.bboxCoords.left,y:e.y-e.bboxCoords.top})),(0,A.jsxs)(ha,{item:e,children:[(0,A.jsx)(Xs.rw,Object.assign({x:e.canvasX,y:e.canvasY,ref:e=>t(e),width:e.canvasWidth,height:e.canvasHeight,fill:a.fillColor,stroke:a.strokeColor,strokeWidth:a.strokeWidth,strokeScaleEnabled:!1,perfectDrawEnabled:!1,shadowForStrokeEnabled:!1,shadowBlur:0,dash:r?[10,10]:null,scaleX:e.scaleX,scaleY:e.scaleY,opacity:1,rotation:e.rotation,draggable:!e.isReadOnly(),name:`${e.id} _transformable`},d,{onMouseOver:()=>{s.annotationStore.selected.isLinkingMode&&e.setHighlight(!0),e.updateCursor(!0)},onMouseOut:()=>{s.annotationStore.selected.isLinkingMode&&e.setHighlight(!1),e.updateCursor()},onClick:t=>{e.parent.getSkipInteractions()||(s.annotationStore.selected.isLinkingMode&&(l.container().style.cursor=z.A.DEFAULT_CURSOR),e.setHighlight(!1),e.onClickRegion(t))},listening:!(r||null!=(i=e.annotation)&&i.isDrawing)})),(0,A.jsx)(ta,{item:e,color:a.strokeColor,strokewidth:a.strokeWidth})]})):null}));function Za(e){const t=(0,u.dV)(e);return(0,u.Pw)(e).create(Object.assign({},t,{id:T()}))}b.addTag("rectangleregion",Xa,Ga),b.addRegionType(Xa,"image");const qa=u.gK.model({selected:u.gK.optional(u.gK.boolean,!1),group:u.gK.optional(u.gK.string,"default"),shortcut:u.gK.optional(u.gK.maybeNull(u.gK.string),null)}).views((e=>({get obj(){var t,n;if(Ys.ff.isActive(j.cE)){var o;const t=null==(o=e.manager)?void 0:o.root;var i;if(null!=t&&t.annotationStore.selected)return t.annotationStore.selected.names.get(null==(i=e.manager)?void 0:i.name)}return null!=(t=null==(n=e.manager)?void 0:n.obj)?t:(0,u._$)(e).object},get manager(){return(0,u._$)(e).manager},get control(){if(Ys.ff.isActive(j.cE)){var t;const n=(0,u._$)(e).control,{name:o}=n,i=null==(t=e.manager)?void 0:t.root;return null!=i&&i.annotationStore.selected?i.annotationStore.selected.names.get(o):n}return(0,u._$)(e).control},get viewClass(){return()=>null},get fullName(){return e.toolName+(e.dynamic?"-dynamic":"")},get clonedStates(){const t=[e.control],n=t?t.filter((e=>e.isSelected)):null;return n?n.map((e=>Za(e))):null},get getActiveShape(){const t=e.obj;return t.regs[t.regs.length-1]},get getSelectedShape(){return e.control.annotation.highlightedNode},get extraShortcuts(){return{}},get shouldPreserveSelectedState(){if(!e.obj)return!1;return(0,u.Zn)(e.obj).settings.preserveSelectedTool},get isPreserved(){var t;return window.localStorage.getItem(`selected-tool:${null==(t=e.obj)?void 0:t.name}`)===e.fullName}}))).actions((e=>({setSelected(t,n){if(e.selected=t,e.afterUpdateSelected(),!n&&t&&e.obj){const t=`selected-tool:${e.obj.name}`;e.shouldPreserveSelectedState&&window.localStorage.setItem(t,e.fullName)}},afterUpdateSelected(){},event(t,n,o){const i=`${t}Ev`;void 0!==e[i]&&e[i].call(e,n,o)},shouldSkipInteractions(t){const n=t.evt&&(t.evt.metaKey||t.evt.ctrlKey),o=e.control.annotation.hasSelection;return!!n&&!o}}))),Ja=u.gK.compose(qa,Ne),Qa=u.gK.model("DrawingTool",{default:!0,mode:u.gK.optional(u.gK.enumeration(["drawing","viewing"]),"viewing"),unselectRegionOnToolChange:!0,isDrawingTool:!0}).volatile((()=>({currentArea:null}))).views((e=>({createRegionOptions:e=>Object.assign({},e,{coordstype:"px"}),get tagTypes(){return console.error("Drawing tool model needs to implement tagTypes getter in views"),{}},isIncorrectControl:()=>e.tagTypes.stateTypes===e.control.type&&!e.control.isSelected,isIncorrectLabel:()=>!e.obj.checkLabels(),get isDrawing(){return"drawing"===e.mode},get getActiveShape(){return e.currentArea},getCurrentArea:()=>e.currentArea,current:()=>e.currentArea,canStart:()=>!e.isDrawing&&!e.annotation.isReadOnly(),get defaultDimensions(){return console.warn("Drawing tool model needs to implement defaultDimentions getter in views"),{}},get MIN_SIZE(){return(0,j.VS)(j.MV)?{X:or.X/e.obj.stageScale/e.obj.stageWidth*tt,Y:or.Y/e.obj.stageScale/e.obj.stageHeight*nt}:{X:or.X/e.obj.stageScale,Y:or.Y/e.obj.stageScale}},isAllowedInteraction:t=>"segmentation"!==e.group||!(t.offsetX>e.obj.canvasSize.width)&&!(t.offsetY>e.obj.canvasSize.height)}))).actions((e=>{let t={ts:0,x:0,y:0};return{event(n,o,[i,s,r,a]){if(o.button>0||o.shiftKey)return;let l=`${n}Ev`;if(void 0!==e[l]&&e[l].call(e,o,[i,s],[r,a]),"click"===n){const n=o.timeStamp;n-t.ts<300&&e.comparePointsWithThreshold(t,{x:i,y:s})&&(l=`dbl${l}`,void 0!==e[l]&&e[l].call(e,o,[i,s],[r,a])),t={ts:n,x:i,y:s}}},comparePointsWithThreshold(t,n,o={x:e.MIN_SIZE.X,y:e.MIN_SIZE.Y}){if(t&&n)return"number"==typeof o&&(o={x:o,y:o}),Math.abs(t.x-n.x)<o.x&&Math.abs(t.y-n.y)<o.y}}})).actions((e=>({createDrawingRegion(t){const n=e.control,o=n.getResultValue();return e.currentArea=e.obj.createDrawingRegion(t,o,n,!1),e.currentArea.setDrawing(!0),e.applyActiveStates(e.currentArea),e.annotation.setIsDrawing(!0),e.currentArea},resumeUnfinishedRegion(t){e.currentArea=t,e.currentArea.setDrawing(!0),e.annotation.regionStore.selection._updateResultsFromRegions([e.currentArea]),e.mode="drawing",e.annotation.setIsDrawing(!0),e.annotation.regionStore.selection.drawingSelect(e.currentArea),null==e.listenForClose||e.listenForClose()},commitDrawingRegion(){const{currentArea:t,control:n,obj:o}=e;if(!t)return;const i=t.toJSON(),s=Object.keys(t.serialize().value).reduce(((e,t)=>(e[t]=i[t],e)),{coordstype:"px",dynamic:e.dynamic}),[r,...a]=t.results,l=e.annotation.createResult(s,r.value.toJSON(),n,o);return a.forEach((e=>l.addResult(e.toJSON()))),t.setDrawing(!1),e.deleteRegion(),l.notifyDrawingFinished(),l},createRegion(t,n=!1){const o=e.control,i=o.getResultValue();return e.currentArea=e.annotation.createResult(t,i,o,e.obj,n),e.applyActiveStates(e.currentArea),e.currentArea},deleteRegion(){e.currentArea=null,e.obj.deleteDrawingRegion()},applyActiveStates(t){e.obj.activeStates().forEach((e=>{t.setValue(e)}))},beforeCommitDrawing:()=>!0,canStartDrawing:()=>!e.isIncorrectControl()&&!e.isIncorrectLabel()&&e.canStart()&&!e.annotation.isDrawing,startDrawing(t,n){e.annotation.history.freeze(),e.mode="drawing",e.currentArea=e.createDrawingRegion(e.createRegionOptions({x:t,y:n}))},finishDrawing(){e.beforeCommitDrawing()?e._finishDrawing():(e.deleteRegion(),e.control.type===e.tagTypes.stateTypes&&e.annotation.unselectAll(!0),e._resetState())},_finishDrawing(){e.commitDrawingRegion(),e._resetState()},_resetState(){e.annotation.setIsDrawing(!1),e.annotation.history.unfreeze(),e.mode="viewing"}}))),el=Qa.named("TwoPointsDrawingTool").views((e=>({get defaultDimensions(){return{width:e.MIN_SIZE.X,height:e.MIN_SIZE.Y}}}))).actions((e=>{const t=1,n=2;let o=0,i=0,s=null,r={x:0,y:0};const a={finishDrawing:e.finishDrawing};return{updateDraw:On()(((t,n)=>{0!==o&&e.draw(t,n)}),48),draw(t,n){const o=e.getCurrentArea();if(!o)return;const i=o.type.includes("ellipse"),s=(0,j.VS)(j.MV)?tt:e.obj.stageWidth,r=(0,j.VS)(j.MV)?nt:e.obj.stageHeight;let{x1:a,y1:l,x2:d,y2:c}=i?{x1:o.startX,y1:o.startY,x2:t,y2:n}:sn.Image.reverseCoordinates({x:o.startX,y:o.startY},{x:t,y:n});a=Math.max(0,a),l=Math.max(0,l),d=Math.min(s,d),c=Math.min(r,c);let[u,h]=[d-a,c-l].map(Math.abs);i&&(u=Math.min(u,Math.min(a,s-a)),h=Math.min(h,Math.min(l,r-l))),o.setPositionInternal(a,l,u,h,o.rotation)},finishDrawing(e,t){s=null,a.finishDrawing(e,t),o=0,i=0},mousedownEv(n,[r,a]){e.canStartDrawing()&&e.isAllowedInteraction(n)&&(s={x:r,y:a},0===o&&(i=t))},mousemoveEv(r,[a,l]){0!==o||!s||e.comparePointsWithThreshold(s,{x:a,y:l})||(o=i,![t,n].includes(o)||(e.startDrawing(s.x,s.y),e.isDrawing))?e.isDrawing&&[t,n].includes(o)&&e.updateDraw(a,l):o=0},mouseupEv(n,[i,s]){o===t&&(r={x:i,y:s},e.isDrawing&&(e.draw(i,s),e.finishDrawing(i,s)))},clickEv(t,[a,l]){e.canStartDrawing()&&e.isAllowedInteraction(t)&&(s&&r&&!e.comparePointsWithThreshold(s,r)||(0===o?i=n:e.isDrawing&&o===n&&(e.draw(a,l),e.finishDrawing(a,l),o=0)))},dblclickEv(t,[n,i]){if(!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;let s=e.defaultDimensions.width,r=e.defaultDimensions.height;if((0,j.VS)(j.MV)&&(s=e.obj.canvasToInternalX(s),r=e.obj.canvasToInternalY(r)),0===o){if(e.startDrawing(n,i),!e.isDrawing)return;n+=s,i+=r,e.draw(n,i),e.finishDrawing(n,i)}}}})),tl=Qa.named("MultipleClicksMixin").views((()=>({canStart(){return!this.current()}}))).actions((e=>{let t={x:0,y:0},n=0,o={x:-1,y:-1},i=0;let s=0;const r={canStartDrawing:e.canStartDrawing};return{canStartDrawing:()=>r.canStartDrawing()&&!e.annotation.regionStore.hasSelection,nextPoint(t,o){const i=e.getCurrentArea(),s=e.obj;i&&s&&s.multiImage&&i.item_index!==s.currentImage||(e.getCurrentArea().addPoint(t,o),n++)},listenForClose(){console.error("MultipleClicksMixin model needs to implement listenForClose method in actions")},closeCurrent(){console.error("MultipleClicksMixin model needs to implement closeCurrent method in actions")},finishDrawing(){e.isDrawing&&(e.annotation.regionStore.selection.drawingUnselect(),n=0,e.closeCurrent(),setTimeout((()=>{e._finishDrawing()})))},cleanupUncloseableShape(){e.deleteRegion(),e.control.type===e.tagTypes.stateTypes&&e.annotation.unselectAll(!0),e._resetState()},mousedownEv(t,[n,s]){e.isAllowedInteraction(t)&&(o={x:n,y:s},i=1)},mouseupEv(t,[n,s]){1===i&&e.comparePointsWithThreshold(o,{x:n,y:s})&&(e._clickEv(t,[n,s]),i=2),o={x:-1,y:-1}},clickEv(t,[n,s]){2!==i&&e._clickEv(t,[n,s]),i=3,o={x:-1,y:-1}},_clickEv(o,[i,r]){if(e.isAllowedInteraction(o))if(e.current())1===n&&e.comparePointsWithThreshold(t,{x:i,y:r})&&o.timeStamp-s<350?e.drawDefault():e.comparePointsWithThreshold(t,{x:i,y:r})?n>2&&e.finishDrawing():e.nextPoint(i,r);else{if(!e.canStartDrawing())return;t={x:i,y:r},n=1,s=o.timeStamp,e.startDrawing(i,r),e.listenForClose()}},drawDefault(){const{x:n,y:o}=t;let i=e.defaultDimensions.length,s=e.defaultDimensions.length;(0,j.VS)(j.MV)&&(i=e.obj.canvasToInternalX(i),s=e.obj.canvasToInternalY(s)),e.nextPoint(n+i,o),e.nextPoint(n+i/2,o+Math.sin(Math.PI/3)*s),e.finishDrawing()}}})),nl=Qa.named("ThreePointsDrawingTool").views((e=>({canStart(){return!this.current()},get defaultDimensions(){return{width:e.MIN_SIZE.X,height:e.MIN_SIZE.Y}}}))).actions((e=>{let t=[],n=0;let o=0,i=null;const s={finishDrawing:e.finishDrawing};return{canStartDrawing:()=>!e.isIncorrectControl(),updateDraw:(n,i)=>{var s;0===o?null==(s=e.getCurrentArea())||s.draw(n,i,t):4===o&&e.draw(n,i)},nextPoint(n,o){t.push({x:n,y:o}),e.getCurrentArea().draw(n,o,t)},draw(t,n){const o=e.getCurrentArea();if(!o)return;const i=(0,j.VS)(j.MV)?tt:e.obj.stageWidth,s=(0,j.VS)(j.MV)?nt:e.obj.stageHeight;let{x1:r,y1:a,x2:l,y2:d}=sn.Image.reverseCoordinates({x:o.startX,y:o.startY},{x:t,y:n});r=Math.max(0,r),a=Math.max(0,a),l=Math.min(i,l),d=Math.min(s,d),o.setPositionInternal(r,a,l-r,d-a,o.rotation)},finishDrawing(n,r){e.isDrawing&&(t=[],i=null,o=0,s.finishDrawing(n,r),setTimeout((()=>{e._finishDrawing()})))},mousemoveEv(t,[s,r]){e.isDrawing&&(1===n&&(o=4),4===o&&i?(e.startDrawing(i.x,i.y),e.updateDraw(s,r)):0===o&&e.updateDraw(s,r))},mousedownEv(t,[o,s]){e.canStartDrawing()&&!e.annotation.isDrawing&&e.isAllowedInteraction(t)&&(n=1,i={x:o,y:s},e.mode="drawing")},mouseupEv(t,[i,s]){e.canStartDrawing()&&e.isDrawing&&(4===o&&(e.draw(i,s),e.finishDrawing(i,s)),n=2)},clickEv(t,[i,s]){e.canStartDrawing()&&e.isAllowedInteraction(t)&&(0===o&&e._clickEv(t,[i,s]),n=3)},_clickEv(n,[o,i]){t.length>=2?e.finishDrawing(o,i):0===t.length?(t=[{x:o,y:i}],e.startDrawing(o,i)):e.nextPoint(o,i)},dblclickEv(t,[i,s]){if(n=5,!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;let r=e.defaultDimensions.width,a=e.defaultDimensions.height;if((0,j.VS)(j.MV)&&(r=e.obj.canvasToInternalX(r),a=e.obj.canvasToInternalY(a)),0===o){if(e.startDrawing(i,s),!e.isDrawing)return;i+=r,s+=a,e.draw(i,s),e.finishDrawing(i,s)}}}}));var ol=n(18229),il=n(51366),sl=n(20963),rl=n(15311);const al=({name:e,icon:t,altIcon:n=null,getContent:o=()=>null,fullContent:i=()=>null})=>(n instanceof Function&&([o,n]=[n,null]),{name:e,icon:t,altIcon:n,getContent:o,fullContent:i}),ll=["node"],dl={LabelModel:{icon:()=>null},RichTextRegionModel:{name:"HTML",icon:To.hfJ,getContent:e=>(0,A.jsx)("span",{style:{color:"#5a5a5a"},children:e.text}),fullContent:e=>(0,A.jsxs)("div",{children:[(0,A.jsx)("div",{children:e.start}),(0,A.jsx)("div",{children:e.startOffset}),(0,A.jsx)("div",{children:JSON.stringify(e.globalOffsets,null,2)})]})},ParagraphsRegionModel:al({name:"Paragraphs",icon:To.hfJ,getContent:e=>(0,A.jsx)("span",{style:{color:"#5a5a5a"},children:e.text})}),AudioRegionModel:al({name:"Audio",icon:ol.A}),TimeSeriesRegionModel:al({name:"TimeSeries",icon:il.A}),TextAreaRegionModel:al({name:"Input",icon:sl.A,getContent:e=>(0,A.jsx)("span",{style:{color:"#5a5a5a"},children:e._value})}),RectRegionModel:al({name:"Rect",icon:To.x1y,altIcon:To.kT6}),Rect3PointRegionModel:al({name:"Rect3Point",icon:To.WxS,altIcon:To.x$C}),VideoRectangleRegionModel:al({name:"Video Rect",icon:To.x1y,altIcon:To.kT6,getContent:e=>{var t;return(0,A.jsxs)("span",{style:{color:"#5a5a5a"},children:["from ",null==(t=e.sequence[0])?void 0:t.frame," frame"]})}}),PolygonRegionModel:al({name:"Polygon",icon:To.aqQ,altIcon:To.jhL}),EllipseRegionModel:al({name:"Ellipse",icon:To.cu2,altIcon:To.FBt}),KeyPointRegionModel:al({name:"KeyPoint",icon:To.OxY,altIcon:To.pFx}),BrushRegionModel:al({name:"Brush",icon:To._3l,altIcon:To.HkR}),ChoicesModel:al({name:"Classification",icon:rl.A}),TextAreaModel:al({name:"Input",icon:sl.A}),TimelineRegionModel:al({name:"Timeline Span",icon:To.hpC})},cl=(0,v.PA)((e=>{let{node:t}=e,n=(0,Zn.A)(e,ll);const o=ul(t);if(!(o in dl))return console.error(`No ${o} in NodeView`),null;const{icon:i}=dl[o];return(0,A.jsx)(i,Object.assign({},n))})),ul=e=>e.$treenode?(0,u.Pw)(e).name:null,hl=({size:e})=>(0,A.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),gl=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{label:"Brush",ariaLabel:"brush-tool",active:e.selected,shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,icon:e.iconClass,tool:e,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},controls:e.controls}))),ml=u.gK.model("BrushTool",{strokeWidth:u.gK.optional(u.gK.number,15),group:"segmentation",shortcut:"B",smart:!0,unselectRegionOnToolChange:!1}).volatile((()=>({canInteractWithRegions:!1}))).views((e=>({get viewClass(){return()=>(0,A.jsx)(gl,{item:e})},get iconComponent(){return e.dynamic?dl.BrushRegionModel.altIcon:dl.BrushRegionModel.icon},get tagTypes(){return{stateTypes:"brushlabels",controlTagTypes:["brushlabels","brush"]}},get controls(){return[(0,A.jsx)(Vo,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,A.jsx)(hl,{size:8}),maxIcon:(0,A.jsx)(hl,{size:16}),onChange:t=>{e.setStroke(t)}},"brush-size")]},get extraShortcuts(){return{"[":["Decrease size",()=>{e.setStroke((0,x.clamp)(e.strokeWidth-5,1,50))}],"]":["Increase size",()=>{e.setStroke((0,x.clamp)(e.strokeWidth+5,1,50))}]}}}))).actions((e=>{let t,n;return{commitDrawingRegion(){const{currentArea:t,control:n,obj:o}=e,i=t.toJSON(),s={coordstype:"px",touches:i.touches,dynamic:i.dynamic},r=e.annotation.createResult(s,t.results[0].value.toJSON(),n,o);return t.setDrawing(!1),e.applyActiveStates(r),e.deleteRegion(),r.notifyDrawingFinished(),r},setStroke(t){e.strokeWidth=t,e.updateCursor()},afterUpdateSelected(){e.updateCursor()},addPoint(e,n){t.addPoint(Math.floor(e),Math.floor(n))},mouseupEv(o,i,[s,r]){"drawing"===e.mode&&(e.addPoint(s,r),e.mode="viewing",t.setDrawing(!1),t.endPath(),n?setTimeout((()=>{const t=e.commitDrawingRegion();e.obj.annotation.selectArea(t),e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)})):(e.annotation.history.unfreeze(),e.obj.annotation.setIsDrawing(!1)))},mousemoveEv(t,n,[o,i]){e.isAllowedInteraction(t)&&"drawing"===e.mode&&(0,x.findClosestParent)(t.target,(t=>t===e.obj.stageRef.content),(e=>e.parentElement))&&e.addPoint(o,i)},mousedownEv(o,i,[s,r]){if(!e.isAllowedInteraction(o))return;if(!(0,x.findClosestParent)(o.target,(t=>t===e.obj.stageRef.content),(e=>e.parentElement)))return;const a=e.control,l=e.obj;if(t=e.getSelectedShape,!(l&&t&&l.multiImage&&l.currentImage!==t.item_index))if(t&&"brushregion"===t.type)e.annotation.history.freeze(),e.mode="drawing",t.setDrawing(!0),e.obj.annotation.setIsDrawing(!0),n=!1,t.beginPath({type:"add",strokeWidth:e.strokeWidth||a.strokeWidth}),e.addPoint(s,r);else{if(!e.canStartDrawing())return;if(e.tagTypes.stateTypes===e.control.type&&!e.control.isSelected)return;e.annotation.history.freeze(),e.mode="drawing",n=!0,e.obj.annotation.setIsDrawing(!0),t=e.createDrawingRegion({touches:[],coordstype:"px"}),t.beginPath({type:"add",strokeWidth:e.strokeWidth||a.strokeWidth}),e.addPoint(s,r)}}}})),pl=u.gK.model("BrushCursorMixin").views((e=>({get cursorStyleRule(){const t=e.strokeWidth;return qr.A.createBrushSizeCircleCursor(t)}}))).actions((e=>({updateCursor(){var t;if(!e.selected||null==(t=e.obj)||!t.stageRef)return;e.obj.stageRef.container().style.cursor=e.cursorStyleRule}}))),fl=u.gK.compose(ml.name,Ja,ar,Qa,pl,ml),vl=({size:e})=>(0,A.jsx)("span",{style:{display:"block",width:e,height:e,background:"rgba(0, 0, 0, 0.25)",borderRadius:"100%"}}),yl=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{label:"Eraser",ariaLabel:"eraser",shortcut:"E",active:e.selected,extraShortcuts:e.extraShortcuts,tool:e,disabled:!e.getSelectedShape,onClick:()=>{e.selected||e.manager.selectTool(e,!0)},icon:e.iconClass,controls:e.controls}))),bl=u.gK.model("EraserTool",{strokeWidth:u.gK.optional(u.gK.number,10),group:"segmentation",unselectRegionOnToolChange:!1}).volatile((()=>({index:9999,canInteractWithRegions:!1}))).views((e=>({get viewClass(){return()=>(0,A.jsx)(yl,{item:e})},get iconComponent(){return To.IIu},get controls(){return[(0,A.jsx)(Vo,{value:e.strokeWidth,min:1,max:50,reverse:!0,align:"vertical",minIcon:(0,A.jsx)(vl,{size:8}),maxIcon:(0,A.jsx)(vl,{size:16}),onChange:t=>{e.setStroke(t)}},"eraser-size")]},get extraShortcuts(){return{"[":["Decrease size",()=>{e.setStroke((0,x.clamp)(e.strokeWidth-5,1,50))}],"]":["Increase size",()=>{e.setStroke((0,x.clamp)(e.strokeWidth+5,1,50))}]}}}))).actions((e=>{let t;return{afterUpdateSelected(){e.updateCursor()},addPoint(e,n){t.addPoint(Math.floor(e),Math.floor(n))},setStroke(t){e.strokeWidth=t,e.updateCursor()},mouseupEv(){"drawing"===e.mode&&(e.mode="viewing",t.endPath())},mousemoveEv(n,o,[i,s]){var r;"drawing"===e.mode&&(0,x.findClosestParent)(n.target,(t=>t===e.obj.stageRef.content),(e=>e.parentElement))&&"brushregion"===(null==(r=t)?void 0:r.type)&&e.addPoint(i,s)},mousedownEv(n,o,[i,s]){e.isAllowedInteraction(n)&&(0,x.findClosestParent)(n.target,(t=>t===e.obj.stageRef.content),(e=>e.parentElement))&&(t=e.getSelectedShape,t&&t&&"brushregion"===t.type&&(e.mode="drawing",t.beginPath({type:"eraser",opacity:1,strokeWidth:e.strokeWidth}),e.addPoint(i,s)))}}})),xl=u.gK.compose(bl.name,Ja,ar,Qa,pl,bl),Sl=u.gK.model("KeyPointTool",{default:u.gK.optional(u.gK.boolean,!0),group:"segmentation",shortcut:"K",smart:!0}).views((()=>({get tagTypes(){return{stateTypes:"keypointlabels",controlTagTypes:["keypointlabels","keypoint"]}},get viewTooltip(){return"Key Point"},get iconComponent(){return self.dynamic?dl.KeyPointRegionModel.altIcon:dl.KeyPointRegionModel.icon}}))).actions((e=>({clickEv(t,[n,o]){var i;if(!e.canStartDrawing())return;if(!e.isAllowedInteraction(t))return;const s=e.control;if("keypointlabels"===s.type&&!s.isSelected)return;if(e.annotation.isReadOnly())return;const r=e.createRegion(Object.assign({},null==(i=e.control)?void 0:i.getSnappedPoint({x:n,y:o}),(0,j.VS)(j.MV)?{width:e.obj.canvasToInternalX(Number(s.strokewidth))}:{width:Number(s.strokewidth),coordstype:"px"},{dynamic:e.dynamic,negative:e.dynamic&&t.altKey}));r.setDrawing(!1),r.notifyDrawingFinished()}}))),wl=u.gK.compose(Sl.name,Ja,ar,Qa,Sl),kl=u.gK.model("PolygonTool",{group:"segmentation",shortcut:"P"}).views((e=>{const t={createRegionOptions:e.createRegionOptions,isIncorrectControl:e.isIncorrectControl,isIncorrectLabel:e.isIncorrectLabel};return{get getActivePolygon(){const t=e.currentArea;return t&&!(0,u._n)(t)||t&&t.closed||void 0===t||t&&"polygonregion"!==t.type?null:t},get tagTypes(){return{stateTypes:"polygonlabels",controlTagTypes:["polygonlabels","polygon"]}},get viewTooltip(){return"Polygon region"},get iconComponent(){return e.dynamic?dl.PolygonRegionModel.altIcon:dl.PolygonRegionModel.icon},get defaultDimensions(){return rr},createRegionOptions:({x:e,y:n})=>t.createRegionOptions({points:[[e,n]],width:10,closed:!1}),isIncorrectControl:()=>t.isIncorrectControl()&&null===e.current(),isIncorrectLabel:()=>!e.current()&&t.isIncorrectLabel(),canStart:()=>null===e.current(),current:()=>e.getActivePolygon}})).actions((e=>{e.startDrawing,e._finishDrawing,e.deleteRegion;let t,n;return{handleToolSwitch(t){var n;if(e.stopListening(),null!=(n=e.getCurrentArea())&&n.isDrawing&&"ZoomPanTool"!==t.toolName){var o,i;const t=null==(o=e.getCurrentArea())?void 0:o.toJSON();(null==t||null==(i=t.points)?void 0:i.length)>2?e.finishDrawing():e.cleanupUncloseableShape()}},listenForClose(){n=!1,t=(0,c.lB)(e.getCurrentArea(),"closed",(()=>{var t;null!=(t=e.getCurrentArea())&&t.closed&&!n&&e.finishDrawing()}),!0)},stopListening(){t&&t()},closeCurrent(){e.stopListening(),n||(n=!0,e.getCurrentArea().closePoly())},startDrawing(t,n){var o;const i=null==(o=e.control)?void 0:o.getSnappedPoint({x:t,y:n});e.mode="drawing",e.currentArea=e.createRegion(e.createRegionOptions({x:i.x,y:i.y}),!0),e.setDrawing(!0),e.applyActiveStates(e.currentArea)},_finishDrawing(){const{currentArea:t,control:n}=e;e.currentArea.notifyDrawingFinished(),e.setDrawing(!1),e.currentArea=null,e.mode="viewing",e.annotation.afterCreateResult(t,n)},setDrawing(t){var n;null==(n=e.currentArea)||n.setDrawing(t),e.annotation.setIsDrawing(t)},deleteRegion(){const{currentArea:t}=e;e.setDrawing(!1),e.currentArea=null,t&&t.deleteRegion()}}})),Cl=u.gK.compose(kl.name,Ja,ar,tl,kl),jl=u.gK.model("BaseNTool",{group:"segmentation",smart:!0,shortcut:"R"}).views((e=>{const t={createRegionOptions:e.createRegionOptions,isIncorrectControl:e.isIncorrectControl,isIncorrectLabel:e.isIncorrectLabel};return{get getActivePolygon(){const t=e.currentArea;return t&&t.closed||void 0===t||t&&"rectangleregion"!==t.type?null:t},get tagTypes(){return{stateTypes:"rectanglelabels",controlTagTypes:["rectanglelabels","rectangle"]}},get defaultDimensions(){return ir},createRegionOptions:({x:n,y:o})=>t.createRegionOptions({x:n,y:o,height:(0,j.VS)(j.MV)?e.obj.canvasToInternalY(1):1,width:(0,j.VS)(j.MV)?e.obj.canvasToInternalX(1):1}),isIncorrectControl:()=>t.isIncorrectControl()&&null===e.current(),isIncorrectLabel:()=>!e.current()&&t.isIncorrectLabel(),canStart:()=>null===e.current()&&!e.annotation.isReadOnly(),current:()=>e.getActivePolygon}})).actions((e=>({beforeCommitDrawing(){const t=e.getActiveShape;return t.width>e.MIN_SIZE.X&&t.height*e.MIN_SIZE.Y}}))),Rl=u.gK.model("RectangleTool",{shortcut:"R"}).views((e=>({get viewTooltip(){return"Rectangle"},get iconComponent(){return e.dynamic?dl.RectRegionModel.altIcon:dl.RectRegionModel.icon}}))),_l=u.gK.model("Rectangle3PointTool",{shortcut:"shift+R"}).views((e=>({get viewTooltip(){return"3 Point Rectangle"},get iconComponent(){return e.dynamic?dl.Rect3PointRegionModel.altIcon:dl.Rect3PointRegionModel.icon}}))),Tl=u.gK.compose(Rl.name,Ja,ar,el,jl,Rl,Ne),Al=u.gK.compose(_l.name,Ja,ar,nl,jl,_l,Ne),Kl=u.gK.model("EllipseTool",{group:"segmentation",shortcut:"O"}).views((e=>{const t={createRegionOptions:e.createRegionOptions};return{get tagTypes(){return{stateTypes:"ellipselabels",controlTagTypes:["ellipselabels","ellipse"]}},get viewTooltip(){return"Ellipse region"},get iconComponent(){return e.dynamic?dl.EllipseRegionModel.altIcon:dl.EllipseRegionModel.icon},get defaultDimensions(){const{radius:e}=sr;return{width:e,height:e}},createRegionOptions:({x:e,y:n})=>t.createRegionOptions({x:e,y:n,radiusX:1,radiusY:1})}})).actions((e=>({beforeCommitDrawing(){const t=e.getActiveShape;return t.radiusX>e.MIN_SIZE.X&&t.radiusY>e.MIN_SIZE.Y}}))),El=u.gK.compose(Kl.name,Ja,ar,el,Kl),Pl=go("SegmentationToolbar","Segmentation Tools"),Ml={plus:"+",minus:"-"},Dl=e=>{if(!e)return null;const t=e.split(",").map((e=>e.trim()));return(0,A.jsx)(Qe.Sl,{name:"shortcut",children:t.map(((e,t)=>{const n=e.split("+");return(0,A.jsx)(m.Fragment,{children:n.map((e=>{var t;return(0,A.jsx)(Qe.Sl,{name:"key",tag:"kbd",children:null!=(t=Ml[e])?t:e},e)}))},`${n.join("-")}-${t}`)}))})},Ol=({items:e,icon:t})=>{const[n,o]=(0,m.useState)(!1);return(0,m.useEffect)((()=>{const t=()=>{e.forEach((e=>{const t=e.shortcut;t&&Pl.hasKey(t)&&Pl.removeKey(t)}))};return t(),e.forEach((e=>{const t=e.shortcut;t&&!Pl.hasKey(t)&&Pl.addKey(t,(()=>{null==e||null==e.onClick||e.onClick(),o(!1)}),e.label)})),()=>{t()}}),[e]),(0,m.useEffect)((()=>{const e=()=>{n&&o(!1)};return window.addEventListener("click",e),()=>{window.removeEventListener("click",e)}})),(0,A.jsxs)(Qe.eB,{name:"flyoutmenu",tag:"div",className:""+(n?"hovered":""),onClick:e=>{e.stopPropagation(),o(!n)},children:[(0,A.jsx)(Qe.Sl,{name:"icon",className:""+(n?"isClicked":""),title:"Zoom presets (click to see options)",children:t}),(0,A.jsx)(Qe.eB,{name:"tooltips",tag:"div",children:e.map(((e,t)=>(0,A.jsx)(Qe.Sl,{name:"tooltip",onClick:t=>{t.stopPropagation(),null==e||null==e.onClick||e.onClick(),o(!1)},children:(0,A.jsxs)(Qe.Sl,{name:"tooltip-body",children:[(0,A.jsx)(Qe.Sl,{name:"label",children:e.label}),Dl(e.shortcut)]})},t)))})]})},Il=(0,v.PA)((({item:e})=>(0,A.jsxs)(m.Fragment,{children:[(0,A.jsx)(er,{active:e.selected,icon:(0,A.jsx)(To.ZbW,{}),ariaLabel:"pan",label:"Pan Image",shortcut:"H",onClick:()=>{const t=e.selected;e.manager.selectTool(e,!t)}}),(0,A.jsx)(er,{icon:(0,A.jsx)(To.mc3,{}),ariaLabel:"zoom-in",label:"Zoom In",shortcut:"ctrl+plus",onClick:()=>{e.handleZoom(1)}}),(0,A.jsx)(Ol,{icon:(0,A.jsx)(To.u79,{}),items:[{label:"Zoom to fit",shortcut:"shift+1",onClick:()=>{e.sizeToFit()}},{label:"Zoom to actual size",shortcut:"shift+2",onClick:()=>{e.sizeToOriginal()}}]}),(0,A.jsx)(er,{icon:(0,A.jsx)(To.Nin,{}),ariaLabel:"zoom-out",label:"Zoom Out",shortcut:"ctrl+minus",onClick:()=>{e.handleZoom(-1)}})]}))),Ll=u.gK.model("ZoomPanTool",{group:"control"}).volatile((()=>({canInteractWithRegions:!1}))).views((e=>({get viewClass(){return()=>(0,A.jsx)(Il,{item:e})},get stageContainer(){return e.obj.stageRef.container()}}))).actions((e=>({shouldSkipInteractions:()=>!0,mouseupEv(){e.mode="viewing",e.stageContainer.style.cursor="grab"},updateCursor(){var t;e.selected&&null!=(t=e.obj)&&t.stageRef&&(e.stageContainer.style.cursor="grab")},afterUpdateSelected(){e.updateCursor()},handleDrag(t){const n=e.obj,o=n.zoomingPositionX+t.movementX,i=n.zoomingPositionY+t.movementY;n.setZoomPosition(o,i)},mousemoveEv(t){e.obj.zoomScale<=1||"moving"===e.mode&&(e.handleDrag(t),e.stageContainer.style.cursor="grabbing")},mousedownEv(t){2!==t.button&&(e.mode="moving",e.stageContainer.style.cursor="grabbing")},handleZoom(t){e.obj.handleZoom(t)},sizeToFit(){e.obj.sizeToFit()},sizeToAuto(){e.obj.sizeToAuto()},sizeToOriginal(){e.obj.sizeToOriginal()}}))),Nl=u.gK.compose(Ll.name,Ja,ar,Ll),zl=(0,v.PA)((({item:e})=>(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(er,{active:e.selected,icon:(0,A.jsx)(To.CwI,{}),ariaLabel:"rotate-left",label:"Rotate Left",shortcut:"alt+left",onClick:()=>{e.rotate(-90)}}),(0,A.jsx)(er,{active:e.selected,icon:(0,A.jsx)(To.$V1,{}),ariaLabel:"rotate-right",label:"Rotate Right",shortcut:"alt+right",onClick:()=>{e.rotate(90)}})]}))),Vl=u.gK.model("RotateTool",{group:"control"}).views((e=>({get viewClass(){return()=>(0,A.jsx)(zl,{item:e})}}))).actions((e=>({rotate(t){e.obj.rotate(t)}}))),Hl=u.gK.compose(Vl.name,Ja,ar,Vl),Bl=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{active:e.selected,ariaLabel:"brightness",label:"Brightness",controlsOnHover:!0,controls:[(0,A.jsx)(Vo,{align:"vertical",reverse:!0,continuous:!0,minIcon:(0,A.jsx)(To.Xdc,{style:{width:22,height:22,opacity:.2}}),maxIcon:(0,A.jsx)(To.Xdc,{style:{width:22,height:22,opacity:.8}}),value:e.brightness,max:z.A.BRIGHTNESS_MAX,onChange:t=>{e.setStroke(t)}},"brightness")],icon:(0,A.jsx)(To.Xdc,{})}))),Fl=u.gK.model({brightness:u.gK.optional(u.gK.number,z.A.BRIGHTNESS_VALUE)}).views((e=>({get viewClass(){return()=>(0,A.jsx)(Bl,{item:e})}}))).actions((e=>({setStroke(t){e.brightness=t,e.obj.setBrightnessGrade(t)}}))),Wl=u.gK.compose(Fl.name,Ja,ar,Fl),$l=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{active:e.selected,ariaLabel:"contrast",label:"Contrast",controlsOnHover:!0,controls:[(0,A.jsx)(Vo,{align:"vertical",reverse:!0,continuous:!0,minIcon:(0,A.jsx)(To.cZy,{style:{width:22,height:22,opacity:.2}}),maxIcon:(0,A.jsx)(To.cZy,{style:{width:22,height:22,opacity:.8}}),value:e.contrast,max:z.A.CONTRAST_MAX,onChange:t=>{e.setStroke(t)}},"contrast")],icon:(0,A.jsx)(To.cZy,{})}))),Ul=u.gK.model("ContrastTool",{contrast:u.gK.optional(u.gK.number,z.A.CONTRAST_VALUE)}).views((e=>({get viewClass(){return()=>(0,A.jsx)($l,{item:e})}}))).actions((e=>({setStroke(t){e.contrast=t,e.obj.setContrastGrade(t)}}))),Yl=u.gK.compose(Ul.name,Ja,ar,Ul),Xl=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{label:"Magic Wand",ariaLabel:"magicwand",shortcut:"W",active:e.selected,icon:e.iconClass,tool:e,onClick:()=>{e.selected||e.manager.selectTool(e,!0)}}))),Gl=u.gK.model("MagicWandTool",{group:"segmentation",shortcut:"W",smart:!0,unselectRegionOnToolChange:!1}).volatile((()=>({canInteractWithRegions:!1,currentThreshold:null,mask:null,anchorScreenX:null,anchorScreenY:null,anchorImgX:null,anchorImgY:null,overlay:null,overlayCtx:null,overlayOrigStyle:null,transformedData:null,transformedCanvas:null,currentRegion:null,isFirstWand:!0,cachedRegionId:null,cachedLabel:null,cachedNaturalCanvas:null,naturalWidth:null,naturalHeight:null,imageDisplayedInBrowserWidth:null,imageDisplayedInBrowserHeight:null,viewportWidth:null,viewportHeight:null,zoomScale:null,zoomingPositionX:null,zoomingPositionY:null,negativezoom:null,rotation:null,timeTravellerListener:null}))).views((e=>({get viewClass(){return()=>(0,A.jsx)(Xl,{item:e})},get tagTypes(){return{stateTypes:"brushlabels",controlTagTypes:["brushlabels","magicwand"]}},get iconComponent(){return To.fCL},get defaultthreshold(){return Number.parseInt(e.control.defaultthreshold,10)},get opacity(){return Number.parseFloat(e.control.opacity)},get fillcolor(){const t=St()(z.l.fillcolor).hex();let n=t;const o=e.obj.states();if(!o.length)return n;const i=o.find((e=>void 0!==e.selectedColor));return n=i?i.selectedColor:t,St()(n).hex()},get selectedLabel(){const t=e.obj.states();if(!t.length)return null;return t.find((e=>typeof e.isSelected)).selectedValues()[0]},get blurradius(){return Number.parseInt(e.control.blurradius,10)},get existingRegion(){return e.getSelectedShape&&e.getSelectedShape.type&&e.getSelectedShape.maskDataURL?e.getSelectedShape:null},shouldInvalidateCache:()=>e.existingRegion&&e.existingRegion.id!==e.cachedRegionId}))).actions((e=>({mousedownEv(t){e.timeTravellerListener||(e.timeTravellerListener=e.annotation.history.onUpdate((()=>{e.invalidateCache()}))),e.annotation.history.freeze(),e.mode="drawing",e.currentThreshold=e.defaultthreshold,e.currentRegion=null;const n=e.obj,o=n.imageRef;if(e.naturalWidth=o.naturalWidth,e.naturalHeight=o.naturalHeight,e.imageDisplayedInBrowserWidth=o.width,e.imageDisplayedInBrowserHeight=o.height,e.viewportWidth=Math.round(n.canvasSize.width),e.viewportHeight=Math.round(n.canvasSize.height),e.zoomScale=n.zoomScale,e.zoomingPositionX=n.zoomingPositionX,e.zoomingPositionY=n.zoomingPositionY,e.negativezoom=e.zoomScale<1,e.rotation=n.rotation,e.rotation||n.crosshair){let t;throw e.mode="viewing",e.annotation.history.unfreeze(),t=e.rotation?"The Magic Wand is not supported on rotated images":"The Magic Wand is not supported if the crosshair is turned on",alert(t),t}window.addEventListener("keydown",e.keydownEv,!0),[e.anchorImgX,e.anchorImgY,e.anchorScreenX,e.anchorScreenY]=e.getEventCoords(t),e.initCache(),e.initCanvas(),e.initCurrentRegion()},mousemoveEv(t){if("drawing"!==e.mode)return;const[n,o,i,s]=e.getEventCoords(t);e.threshold(i,s,e.fillcolor,e.opacity)},mouseupEv:(0,u.L3)((function*(){"viewing"!==e.mode&&(e.mode="viewing",window.removeEventListener("keydown",e.keydownEv,!0),yield e.setupFinalMask())})),keydownEv(t){const{key:n}=t;"Escape"===n&&(t.preventDefault(),t.stopPropagation(),e.mode="viewing",window.removeEventListener("keydown",e.keydownEv,!0),e.overlayCtx.clearRect(0,0,e.overlay.width,e.overlay.height))},getEventCoords:e=>[e.offsetX,e.offsetY,e.screenX,e.screenY],initCache(){e.isFirstWand=null===e.existingRegion||e.existingRegion.id!==e.cachedRegionId,e.isFirstWand?(e.cachedNaturalCanvas=document.createElement("canvas"),e.cachedNaturalCanvas.width=e.naturalWidth,e.cachedNaturalCanvas.height=e.naturalHeight,e.cachedLabel=e.selectedLabel):e.shouldInvalidateCache()&&e.invalidateCache()},invalidateCache(){e.cachedNaturalCanvas=document.createElement("canvas"),e.cachedNaturalCanvas.width=e.naturalWidth,e.cachedNaturalCanvas.height=e.naturalHeight,e.isFirstWand=!0,e.cachedRegionId=null,e.cachedLabel=e.selectedLabel},initCanvas(){const t=e.obj,n=t.imageRef;[e.transformedData,e.transformedCanvas]=Et(n,e.naturalWidth,e.naturalHeight,e.imageDisplayedInBrowserWidth,e.imageDisplayedInBrowserHeight,e.viewportWidth,e.viewportHeight,e.zoomScale,e.zoomingPositionX,e.zoomingPositionY,e.negativezoom,e.rotation),e.overlay=t.overlayRef,e.overlayOrigStyle=e.overlay.style,e.overlay.style="",e.overlay.width=e.transformedCanvas.width,e.overlay.height=e.transformedCanvas.height,e.overlayCtx=e.overlay.getContext("2d"),e.mask=kt(e.transformedData,e.overlayCtx,e.transformedCanvas.width,e.transformedCanvas.height,e.anchorImgX,e.anchorImgY,e.currentThreshold,e.fillcolor,e.opacity,e.blurradius,!0)},initCurrentRegion(){if(e.isFirstWand){const t={id:T(),strokewidth:1,object:e.obj,points:[],fillcolor:e.fillcolor,strokecolor:e.fillcolor,opacity:e.opacity};e.currentRegion=e.createDrawingRegion(t)}else e.currentRegion=e.existingRegion},threshold(t,n){if(t!==e.anchorScreenX||n!==e.anchorScreenY){const o=Math.abs(t-e.anchorScreenX),i=Math.abs(n-e.anchorScreenY),s=Math.sqrt(o*o+i*i),r=Math.abs(o),a=Math.abs(i);let l=r>a?o/r:i/a;l=l<0?l/5:l/3;const d=Math.min(Math.max(e.defaultthreshold+Math.floor(l*s),1),255);d!==e.currentThreshold&&(e.currentThreshold=d,e.mask=kt(e.transformedData,e.overlayCtx,e.transformedCanvas.width,e.transformedCanvas.height,e.anchorImgX,e.anchorImgY,e.currentThreshold,e.fillcolor,e.opacity,e.blurradius,!0))}},setupFinalMask:(0,u.L3)((function*(){const t=e.mask;let n,o;e.negativezoom?(n=Math.min(e.viewportWidth,e.imageDisplayedInBrowserWidth),o=Math.min(e.viewportHeight,e.imageDisplayedInBrowserHeight)):(n=e.viewportWidth,o=e.viewportHeight);const i=qr.A.mask2DataURL(t.data,n,o,"#FFFFFF"),s=document.createElement("img");s.src=i,yield s.decode();const r=e.copyTransformedMaskToNaturalSize(s);e.finalMaskToRegion(r)})),copyTransformedMaskToNaturalSize(t){const n=e.cachedNaturalCanvas.getContext("2d"),[o,i]=Pt(e.naturalWidth,e.naturalHeight,e.imageDisplayedInBrowserWidth,e.imageDisplayedInBrowserHeight,e.zoomingPositionX,e.zoomingPositionY),s=Math.ceil(e.transformedCanvas.width/e.imageDisplayedInBrowserWidth*e.naturalWidth),r=Math.ceil(e.transformedCanvas.height/e.imageDisplayedInBrowserHeight*e.naturalHeight),a=e.transformedCanvas.width,l=e.transformedCanvas.height,d=o,c=i,u=s,h=r;n.drawImage(t,0,0,a,l,d,c,u,h);return e.cachedNaturalCanvas.toDataURL()},finalMaskToRegion(t){if(e.isFirstWand){const n=e.commitDrawingRegion(t);e.cachedRegionId=n.id,e.obj.annotation.selectArea(n)}else e.currentRegion.endUpdatedMaskDataURL(t);e.annotation.history.unfreeze(),e.annotation.setIsDrawing(!1),e.overlay.style=e.origStyle,setTimeout((()=>{e.overlayCtx.clearRect(0,0,e.overlay.width,e.overlay.height)}))},commitDrawingRegion(t){const n={maskDataURL:t,coordstype:"px",dynamic:!1},o=e.annotation.createResult(n,e.currentRegion.results[0].value.toJSON(),e.control,e.obj);return e.applyActiveStates(o),e.deleteRegion(),o.notifyDrawingFinished(),o}}))),Zl=u.gK.compose(Gl.name,Ja,ar,Qa,Gl),ql=(0,v.PA)((({item:e})=>(0,A.jsx)(er,{ariaLabel:"move-tool",active:e.selected,icon:(0,A.jsx)(To.v0T,{}),label:"Move",shortcut:e.shortcut,extraShortcuts:e.extraShortcuts,onClick:()=>{e.manager.selectTool(e,!e.selected)}}))),Jl=u.gK.model("SelectionTool",{shortcut:"V",group:"control"}).views((e=>({get viewClass(){return()=>(0,A.jsx)(ql,{item:e})},get useTransformer(){return!0}}))).actions((e=>{let t=!1;return{shouldSkipInteractions:()=>!1,mousedownEv(n,[o,i]){t=!0,e.obj.setSelectionStart({x:o,y:i})},mousemoveEv(n,[o,i]){t&&e.obj.setSelectionEnd({x:o,y:i})},mouseupEv(n,[o,i]){if(!t)return;e.obj.setSelectionEnd({x:o,y:i});const{regionsInSelectionArea:s}=e.obj;e.obj.resetSelection(),n.ctrlKey||n.metaKey?e.annotation.extendSelectionWith(s):e.annotation.selectAreas(s),t=!1},clickEv(n){(0,j.VS)(j.q$)&&(t=!1,e.obj.resetSelection(),n.ctrlKey||n.metaKey||e.annotation.unselectAreas())}}})),Ql=u.gK.compose("MoveTool",Ja,ar,Ne,Jl),ed=new Map;let td=null;class nd{static getInstance({name:e}={}){if(!e)return;if(ed.has(e))return ed.get(e);const t=new nd({name:e});return ed.set(e,t),t}static allInstances(){return Array.from(ed.values())}static setRoot(e){td=e}static removeAllTools(){ed.forEach((e=>e.removeAllTools())),ed.clear()}constructor({name:e}={}){this.name=e,this.tools={},this._default_tool=null,this._prefix=T()}get preservedTool(){return window.localStorage.getItem(`selected-tool:${this.name}`)}get root(){return td}get obj(){var e;return Ys.ff.isActive(j.cE)?null==(e=td.annotationStore.selected)?void 0:e.names.get(this.name):td.annotationStore.names.get(this.name)}addTool(e,t,n=null,o=T()){var i,s;if(t.smart&&null!=(i=t.control)&&i.smartonly)return;const r=null!=(s=t.toolName)?s:e,a=`${null!=o?o:this._prefix}#${r}`;if(n&&e===n){const e=new RegExp(`^.*?#${r}.*$`);if(Object.keys(this.tools).some((t=>e.test(t))))return void console.log(`Ignoring duplicate tool ${r} because it matches removeDuplicatesNamed ${n}`)}if(this.tools[a]=t,t.default&&!this._default_tool&&(this._default_tool=t),this.preservedTool&&t.shouldPreserveSelectedState&&t.fullName===this.preservedTool&&t.setSelected)return this.unselectAll(),void this.selectTool(t,!0,!0);this._default_tool&&!this.hasSelected&&this.selectTool(this._default_tool,!0,!0)}unselectAll(){var e;Object.values(this.tools).forEach((e=>{void 0!==e.selected&&e.setSelected(!1)}));const t=null==(e=this.obj)?void 0:e.stageRef;t&&(t.container().style.cursor="default")}selectTool(e,t,n=!1){const o=this.findSelectedTool(),i=null==e?void 0:e.group;if(o&&"segmentation"===i){const t=e.control.type.replace(/labels$/,""),n=e.obj.activeStates().filter((e=>{const n=e.type.replace(/labels$/,"");return"labels"!==e.type&&n!==t}));n.forEach((e=>e.unselectAll()))}if(null==o||null==o.handleToolSwitch||o.handleToolSwitch(e),t)this.unselectAll(),null==e.setSelected||e.setSelected(!0,n);else{const e=this.findDrawingTool();this.selectTool(null!=e?e:this._default_tool,!0)}}selectDefault(){const e=this.findSelectedTool();this._default_tool&&!0===(null==e?void 0:e.dynamic)&&(this.unselectAll(),this._default_tool.setSelected(!0))}allTools(){return Object.values(this.tools)}addToolsFromControl(e){if(e.tools){const t=e.tools;Object.keys(t).forEach((n=>{this.addTool(n,t[n],e.removeDuplicatesNamed,e.name||e.id)}))}}findSelectedTool(){return Object.values(this.tools).find((e=>e.selected))}findDrawingTool(){return Object.values(this.tools).find((e=>e.isDrawing))}event(e,t,...n){const o=this.findSelectedTool();o&&o.event(e,t,n)}reload({name:e}={}){ed.delete(this.name),ed.set(e,this),this.removeAllTools(),this.name=e}removeAllTools(){Object.values(this.tools).forEach((e=>(0,u.zr)(e))),this.tools={},this._default_tool=null}get hasSelected(){return Object.values(this.tools).some((e=>e.selected))}}window.ToolManager=nd;const od=nd,id=u.gK.union({dispatcher(e){if(!e)return u.gK.null;const t=e.object.name||e.object,n=window.Htx.annotationStore.names.get(t),o=b.getAvailableAreas(n.type,e);return u.gK.union(...o,u.gK.null)}});const sd=new class{constructor(){this.fileCache=new Map,this.errorCache=new Map}download(e,t){var n=this;if(!e)throw new Error("No URL provided for download");return new Promise(((o,i)=>{if(this.fileCache.has(e))return void o(this.fileCache.get(e));if(this.errorCache.has(e))return void i(this.errorCache.get(e));const s=new XMLHttpRequest;s.responseType="blob",s.addEventListener("load",(async function(){if(4===s.readyState&&200===s.status){var t;const r=n.createDataURL(s.response);if(n.fileCache.set(e,r),null!=(t=s.getResponseHeader("content-type"))&&t.match(/image/))try{await n.cacheImage(r)}catch(e){return void i(e)}o(r)}})),s.addEventListener("progress",(e=>{const{total:n,loaded:o}=e;null==t||t(n,o,o/n)})),s.addEventListener("error",(()=>{const t=new Error("Network error");i(t),this.errorCache.set(e,t)})),s.open("GET",e),s.send()}))}isPreloaded(e){return this.fileCache.has(e)}isError(e){return this.errorCache.has(e)}getPreloadedURL(e){return this.fileCache.get(e)}getError(e){return this.errorCache.get(e)}createDataURL(e){return URL.createObjectURL(e)}cacheImage(e){return new Promise(((t,n)=>{const o=new Image;o.onload=()=>{t()},o.onerror=()=>{n()},o.src=e}))}},rd=u.gK.model({id:u.gK.identifier,src:u.gK.string,index:u.gK.number,rotation:u.gK.optional(u.gK.number,0),naturalWidth:u.gK.optional(u.gK.integer,1),naturalHeight:u.gK.optional(u.gK.integer,1),stageWidth:u.gK.optional(u.gK.number,1),stageHeight:u.gK.optional(u.gK.number,1),zoomScale:u.gK.optional(u.gK.number,1),zoomingPositionX:u.gK.optional(u.gK.number,0),zoomingPositionY:u.gK.optional(u.gK.number,0),brightnessGrade:u.gK.optional(u.gK.number,100),contrastGrade:u.gK.optional(u.gK.number,100)}).volatile((()=>({stageRatio:1,containerWidth:1,containerHeight:1,stageZoom:1,stageZoomX:1,stageZoomY:1,currentZoom:1,downloaded:!1,downloading:!1,error:!1,progress:0,currentSrc:void 0,imageLoaded:!1}))).views((e=>({get parent(){return(0,u.PA)(e,2)},get imageCrossOrigin(){var t,n;return null!=(t=null==(n=e.parent)?void 0:n.imageCrossOrigin)?t:"anonymous"}}))).actions((e=>({preload(){if(!e.ensurePreloaded()&&e.src){if((0,j.VS)(j.JZ))return e.setDownloading(!0),void new Promise((t=>{const n=new Image,o=e.imageCrossOrigin;o&&(n.crossOrigin=o),n.onload=()=>{e.setCurrentSrc(e.src),e.setDownloaded(!0),e.setProgress(1),e.setDownloading(!1),e.setImageLoaded(!0),t()},n.onerror=()=>{e.setError(!0),e.setDownloading(!1),t()},n.src=e.src}));e.setDownloading(!0),sd.download(e.src,((t,n,o)=>{e.setProgress(o)})).then((t=>{e.setDownloaded(!0),e.setDownloading(!1),e.setCurrentSrc(t)})).catch((()=>{e.setDownloading(!1),e.setError(!0)}))}},ensurePreloaded:()=>(0,j.VS)(j.JZ)?void 0!==e.currentSrc:sd.isError(e.src)?(e.setDownloading(!1),e.setError(!0),!0):!!sd.isPreloaded(e.src)&&(e.setDownloading(!1),e.setDownloaded(!0),e.setProgress(1),e.setCurrentSrc(sd.getPreloadedURL(e.src)),!0),setImageLoaded(t){e.imageLoaded=t},setProgress(t){e.progress=(0,x.clamp)(t,0,100)},setDownloading(t){e.downloading=t},setDownloaded(t){e.downloaded=t},setCurrentSrc(t){e.currentSrc=t},setError(){e.error=!0}}))).actions((e=>({setRotation(t){e.rotation=t},setNaturalWidth(t){e.naturalWidth=t},setNaturalHeight(t){e.naturalHeight=t},setStageWidth(t){e.stageWidth=t},setStageHeight(t){e.stageHeight=t},setStageRatio(t){e.stageRatio=t},setContainerWidth(t){e.containerWidth=t},setContainerHeight(t){e.containerHeight=t},setStageZoom(t){e.stageZoom=t},setStageZoomX(t){e.stageZoomX=t},setStageZoomY(t){e.stageZoomY=t},setCurrentZoom(t){e.currentZoom=t},setZoomScale(t){e.zoomScale=t},setZoomingPositionX(t){e.zoomingPositionX=t},setZoomingPositionY(t){e.zoomingPositionY=t},setBrightnessGrade(t){e.brightnessGrade=t},setContrastGrade(t){e.contrastGrade=t}}))),ad=u.gK.model({currentImageEntity:u.gK.maybeNull(u.gK.reference(rd)),imageEntities:u.gK.optional(u.gK.array(rd),[])}).actions((e=>({beforeDestroy(){e.currentImageEntity=null}}))).views((e=>({get maxItemIndex(){return e.imageEntities.length-1},get imageIsLoaded(){const t=e.currentImageEntity;return!t.downloading&&!t.error&&t.downloaded&&t.imageLoaded},get rotation(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.rotation},set rotation(t){var n;null==(n=e.currentImageEntity)||n.setRotation(t)},get naturalWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.naturalWidth},set naturalWidth(t){var n;null==(n=e.currentImageEntity)||n.setNaturalWidth(t)},get naturalHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.naturalHeight},set naturalHeight(t){var n;null==(n=e.currentImageEntity)||n.setNaturalHeight(t)},get stageWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageWidth},set stageWidth(t){var n;null==(n=e.currentImageEntity)||n.setStageWidth(t)},get stageHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageHeight},set stageHeight(t){var n;null==(n=e.currentImageEntity)||n.setStageHeight(t)},get stageRatio(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageRatio},set stageRatio(t){var n;null==(n=e.currentImageEntity)||n.setStageRatio(t)},get containerWidth(){var t;return null==(t=e.currentImageEntity)?void 0:t.containerWidth},set containerWidth(t){var n;null==(n=e.currentImageEntity)||n.setContainerWidth(t)},get containerHeight(){var t;return null==(t=e.currentImageEntity)?void 0:t.containerHeight},set containerHeight(t){var n;null==(n=e.currentImageEntity)||n.setContainerHeight(t)},get stageZoom(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoom},set stageZoom(t){var n;null==(n=e.currentImageEntity)||n.setStageZoom(t)},get stageZoomX(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoomX},set stageZoomX(t){var n;null==(n=e.currentImageEntity)||n.setStageZoomX(t)},get stageZoomY(){var t;return null==(t=e.currentImageEntity)?void 0:t.stageZoomY},set stageZoomY(t){var n;null==(n=e.currentImageEntity)||n.setStageZoomY(t)},get currentZoom(){var t;return null==(t=e.currentImageEntity)?void 0:t.currentZoom},set currentZoom(t){var n;null==(n=e.currentImageEntity)||n.setCurrentZoom(t)},get zoomScale(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.zoomScale},set zoomScale(t){var n;null==(n=e.currentImageEntity)||n.setZoomScale(t)},get zoomingPositionX(){var t;if((0,u._n)(e))return null==(t=e.currentImageEntity)?void 0:t.zoomingPositionX},set zoomingPositionX(t){var n;null==(n=e.currentImageEntity)||n.setZoomingPositionX(t)},get zoomingPositionY(){var t;return(0,u._n)(e)?null==(t=e.currentImageEntity)?void 0:t.zoomingPositionY:null},set zoomingPositionY(t){var n;null==(n=e.currentImageEntity)||n.setZoomingPositionY(t)},get brightnessGrade(){var t;return null==(t=e.currentImageEntity)?void 0:t.brightnessGrade},set brightnessGrade(t){var n;null==(n=e.currentImageEntity)||n.setBrightnessGrade(t)},get contrastGrade(){var t;return null==(t=e.currentImageEntity)?void 0:t.contrastGrade},set contrastGrade(t){var n;null==(n=e.currentImageEntity)||n.setContrastGrade(t)},findImageEntity(t){var n;return t=null!=(n=t)?n:0,e.imageEntities.find((e=>e.index===t))}}))),ld=u.gK.model({x:u.gK.number,y:u.gK.number}),dd=u.gK.model({start:u.gK.maybeNull(ld),end:u.gK.maybeNull(ld)}).views((e=>({get obj(){return(0,u.PA)(e)},get annotation(){return e.obj.annotation},get highlightedNodeExists(){return!!e.annotation.highlightedNode},get isActive(){return e.start&&e.end},get x(){return Math.min(e.start.x*e.scale,e.end.x*e.scale)},get y(){return Math.min(e.start.y*e.scale,e.end.y*e.scale)},get width(){return Math.abs(e.end.x*e.scale-e.start.x*e.scale)},get height(){return Math.abs(e.end.y*e.scale-e.start.y*e.scale)},get scale(){return e.obj.zoomScale},get bbox(){const{start:t,end:n}=e;return e.isActive?{left:Math.min(t.x,n.x),top:Math.min(t.y,n.y),right:Math.max(t.x,n.x),bottom:Math.max(t.y,n.y)}:null},get onCanvasBbox(){if(!e.isActive)return null;const{start:t,end:n}=e;return{left:e.obj.internalToCanvasX(Math.min(t.x,n.x)),top:e.obj.internalToCanvasY(Math.min(t.y,n.y)),right:e.obj.internalToCanvasX(Math.max(t.x,n.x)),bottom:e.obj.internalToCanvasY(Math.max(t.y,n.y))}},get onCanvasRect(){if(!(0,j.VS)(j.MV))return e;if(!e.isActive)return null;const t=e.onCanvasBbox;return{x:t.left,y:t.top,width:t.right-t.left,height:t.bottom-t.top}},includesBbox(t){if(!e.isActive||!t)return!1;const n=e.bbox.left<=t.left,o=e.bbox.top<=t.top,i=e.bbox.right>=t.right,s=e.bbox.bottom>=t.bottom;return n&&o&&i&&s},intersectsBbox(t){if(!e.isActive||!t)return!1;const n=(e.bbox.left+e.bbox.right)/2,o=(e.bbox.top+e.bbox.bottom)/2,i=e.bbox.right-e.bbox.left,s=e.bbox.bottom-e.bbox.top,r=(t.left+t.right)/2,a=(t.top+t.bottom)/2,l=t.right-t.left,d=t.bottom-t.top;return 2*Math.abs(n-r)<i+l&&2*Math.abs(o-a)<s+d},get selectionBorders(){if(e.isActive||!e.obj.selectedRegions.length)return null;const t=(0,j.VS)(j.MV)?{left:tt,top:nt,right:0,bottom:0}:{left:e.obj.stageWidth,top:e.obj.stageHeight,right:0,bottom:0},n=e.obj.selectedRegions.reduce(((e,t)=>t.bboxCoords?{left:Math.min(e.left,t.bboxCoords.left),top:Math.min(e.top,t.bboxCoords.top),right:Math.max(e.right,t.bboxCoords.right),bottom:Math.max(e.bottom,t.bboxCoords.bottom)}:e),t);return(0,j.VS)(j.MV)?{left:e.obj.internalToCanvasX(n.left),top:e.obj.internalToCanvasY(n.top),right:e.obj.internalToCanvasX(n.right),bottom:e.obj.internalToCanvasY(n.bottom)}:n}}))).actions((e=>({setStart(t){e.start=t},setEnd(t){e.end=t}}))),cd=u.gK.model({valuelist:u.gK.maybeNull(u.gK.string)}).extend((e=>{if(!0!==e.isObjectTag)throw new Error("The MultiItemObjectBase mixin should be used only for object-tags");return{}})).views((e=>({get isMultiItem(){return(0,x.isDefined)(e.valuelist)},get maxItemIndex(){throw new Error("MultiItemMixin needs to implement maxItemIndex getter in views")},get currentItemIndex(){throw new Error("MultiItemMixin needs to implement currentItemIndex getter in views")},get regs(){return e.isMultiItem?e.allRegs.filter((t=>{var n;return(null!=(n=t.item_index)?n:0)===e.currentItemIndex})):e.allRegs}}))),ud=u.gK.model({value:u.gK.maybeNull(u.gK.string),valuelist:u.gK.maybeNull(u.gK.string),resize:u.gK.maybeNull(u.gK.number),width:u.gK.optional(u.gK.string,"100%"),height:u.gK.maybeNull(u.gK.string),maxwidth:u.gK.optional(u.gK.string,"100%"),maxheight:u.gK.optional(u.gK.string,"calc(100vh - 194px)"),smoothing:u.gK.maybeNull(u.gK.boolean),grid:u.gK.optional(u.gK.boolean,!1),gridsize:u.gK.optional(u.gK.string,"30"),gridcolor:u.gK.optional(Me.color,"#EEEEF4"),zoom:u.gK.optional(u.gK.boolean,!0),negativezoom:u.gK.optional(u.gK.boolean,!1),zoomby:u.gK.optional(u.gK.string,"1.1"),showlabels:u.gK.optional(u.gK.boolean,!1),zoomcontrol:u.gK.optional(u.gK.boolean,!0),brightnesscontrol:u.gK.optional(u.gK.boolean,!1),contrastcontrol:u.gK.optional(u.gK.boolean,!1),rotatecontrol:u.gK.optional(u.gK.boolean,!1),crosshair:u.gK.optional(u.gK.boolean,!1),selectioncontrol:u.gK.optional(u.gK.boolean,!0),lazyoff:u.gK.optional(u.gK.boolean,!1),horizontalalignment:u.gK.optional(u.gK.enumeration(["left","center","right"]),"left"),verticalalignment:u.gK.optional(u.gK.enumeration(["top","center","bottom"]),"top"),defaultzoom:u.gK.optional(u.gK.enumeration(["auto","original","fit"]),"fit"),crossorigin:u.gK.optional(u.gK.enumeration(["none","anonymous","use-credentials"]),"none")}),hd="rectanglelabels",gd="brushlabels",md="ellipselabels",pd=u.gK.model({type:"image",sizeUpdated:u.gK.optional(u.gK.boolean,!1),cursorPositionX:u.gK.optional(u.gK.number,0),cursorPositionY:u.gK.optional(u.gK.number,0),brushControl:u.gK.optional(u.gK.string,"brush"),brushStrokeWidth:u.gK.optional(u.gK.number,15),mode:u.gK.optional(u.gK.enumeration(["drawing","viewing","brush","eraser"]),"viewing"),regions:u.gK.array(u.gK.union(fa,Xa,Ca,Na,Ta),[]),drawingRegion:u.gK.optional(id,null),selectionArea:u.gK.optional(dd,{start:null,end:null})}).volatile((()=>({currentImage:void 0,supportSuggestions:!0}))).views((e=>({get store(){return(0,u.Zn)(e)},get multiImage(){return!!e.isMultiItem},get currentItemIndex(){return e.currentImage},get parsedValue(){return k(e.value,e.store.task.dataObj)},get parsedValueList(){return k(e.valuelist,e.store.task.dataObj)},get currentSrc(){return e.currentImageEntity.src},get usedValue(){return e.multiImage?e.valuelist:e.value},get images(){const t=e.parsedValue;return t?Array.isArray(t)?t:[t]:[]},get hasStates(){const t=e.states();return t&&t.length>0},get selectedRegions(){return e.regs.filter((e=>e.inSelection))},get selectedRegionsBBox(){let t;return e.selectedRegions.forEach((e=>{const n=e.bboxCoords;n&&(t=t?{left:Math.min(null==n?void 0:n.left,t.left),top:Math.min(null==n?void 0:n.top,t.top),right:Math.max(null==n?void 0:n.right,t.right),bottom:Math.max(null==n?void 0:n.bottom,t.bottom)}:n)})),t},get regionsInSelectionArea(){return e.regs.filter((e=>e.isInSelectionArea))},get selectedShape(){return e.regs.find((e=>e.selected))},get suggestions(){var t;return(null==(t=e.annotation)?void 0:t.regionStore.suggestions.filter((t=>t.object===e)))||[]},get useTransformer(){var t;return!0===(null==(t=e.getToolsManager().findSelectedTool())?void 0:t.useTransformer)},get stageTranslate(){const{stageWidth:t,stageHeight:n}=e;return{0:{x:0,y:0},90:{x:0,y:n},180:{x:t,y:n},270:{x:t,y:0}}[e.rotation]},get stageScale(){return e.zoomScale},get hasTools(){var t;return!(null==(t=e.getToolsManager().allTools())||!t.length)},get imageCrossOrigin(){const t=e.crossorigin.toLowerCase();return!(0,j.VS)(j.xS)||t&&"none"!==t?t&&"none"!==t?t:null:"anonymous"},get fillerHeight(){const{naturalWidth:t,naturalHeight:n}=e;return e.isSideways?t/n*100+"%":n/t*100+"%"},get zoomedPixelSize(){const{naturalWidth:t,naturalHeight:n}=e;return(0,j.VS)(j.MV)?{x:100/t,y:100/n}:{x:e.stageWidth/t,y:e.stageHeight/n}},isSamePixel({x:t,y:n},{x:o,y:i}){const s=e.zoomedPixelSize.x,r=e.zoomedPixelSize.y;return Math.abs(t-o)<s/2&&Math.abs(n-i)<r/2},snapPointToPixel({x:t,y:n},o=ot){const i=e.zoomedPixelSize.x,s=e.zoomedPixelSize.y;switch(o){case ot:return{x:Math.round(t/i)*i,y:Math.round(n/s)*s};case it:return{x:Math.floor(t/i)*i+i/2,y:Math.floor(n/s)*s+s/2}}},createSerializedResult(t,n){var o;const i=null!=(o=t.item_index)?o:0,s=e.findImageEntity(i),r={original_width:s.naturalWidth,original_height:s.naturalHeight,image_rotation:s.rotation};e.multiImage&&(0,x.isDefined)(i)&&(r.item_index=i);return!s.imageLoaded&&(0,x.isDefined)(t._rawResult)?structuredClone(t._rawResult):Object.assign({},r,{value:n})},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t&&t.filter((e=>e.isSelected&&e.type.includes("labels")))},controlButton(){const t=e.states();if(!t||0===t.length)return;let n=t[0];return t.forEach((e=>{e.type!==hd&&e.type!==gd&&e.type!==md||(n=e)})),n},get controlButtonType(){const t=e.controlButton();return(0,u.Pw)(t).name},get isSideways(){return(e.rotation+360)%180==90},get stageComponentSize(){return e.isSideways?{width:e.stageHeight,height:e.stageWidth}:{width:e.stageWidth,height:e.stageHeight}},get canvasSize(){return e.isSideways?{width:(0,j.VS)(j.aT)?e.naturalHeight*e.stageZoomX:Math.round(e.naturalHeight*e.stageZoomX),height:(0,j.VS)(j.aT)?e.naturalWidth*e.stageZoomY:Math.round(e.naturalWidth*e.stageZoomY)}:{width:(0,j.VS)(j.aT)?e.naturalWidth*e.stageZoomX:Math.round(e.naturalWidth*e.stageZoomX),height:(0,j.VS)(j.aT)?e.naturalHeight*e.stageZoomY:Math.round(e.naturalHeight*e.stageZoomY)}},get alignmentOffset(){const t={x:0,y:0};if((0,j.VS)(j.pG)){switch(e.horizontalalignment){case"center":t.x=(e.containerWidth-e.canvasSize.width)/2;break;case"right":t.x=e.containerWidth-e.canvasSize.width}switch(e.verticalalignment){case"center":t.y=(e.containerHeight-e.canvasSize.height)/2;break;case"bottom":t.y=e.containerHeight-e.canvasSize.height}}return t},get zoomBy(){return Number.parseFloat(e.zoomby)},get isDrawing(){return!!e.drawingRegion},get imageTransform(){const t={width:e.stageWidth*e.zoomScale+"px",height:e.stageHeight*e.zoomScale+"px",transformOrigin:"left top",transform:"translate3d(0,0,0)",filter:`brightness(${e.brightnessGrade}%) contrast(${e.contrastGrade}%)`},n=[];if(1!==e.zoomScale){const{zoomingPositionX:t=0,zoomingPositionY:o=0}=e;n.push(`translate3d(${t}px,${o}px, 0)`)}if(e.rotation){const t={90:"0, -100%",180:"-100%, -100%",270:"-100%, 0"};n.push(`rotate(${e.rotation}deg)`),n.push(`translate(${t[e.rotation]||"0, 0"})`)}return(null==n?void 0:n.length)>0&&(t.transform=n.join(" ")),t},get maxScale(){return e.isSideways?Math.min(e.containerWidth/e.naturalHeight,e.containerHeight/e.naturalWidth):Math.min(e.containerWidth/e.naturalWidth,e.containerHeight/e.naturalHeight)},get coverScale(){return e.isSideways?Math.max(e.containerWidth/e.naturalHeight,e.containerHeight/e.naturalWidth):Math.max(e.containerWidth/e.naturalWidth,e.containerHeight/e.naturalHeight)},get viewPortBBoxCoords(){let t=e.canvasSize.width/e.zoomScale,n=e.canvasSize.height/e.zoomScale;const o=-e.zoomingPositionX/e.zoomScale,i=-e.zoomingPositionY/e.zoomScale,s=[o,i,e.stageComponentSize.width-(o+t),e.stageComponentSize.height-(i+n)];if(e.isSideways&&([t,n]=[n,t]),e.rotation){const t=e.rotation/90%4;for(let e=0;e<t;e++)s.push(s.shift())}const r=s[0],a=s[1];return{left:r,top:a,right:r+t,bottom:a+n,width:t,height:n}}}))).volatile((e=>({manager:null}))).actions((e=>{const t=od.getInstance({name:e.name}),n={manager:t,control:e,object:e};return{afterAttach:function(){Ys.ff.isActive(j.cE)&&!e.annotation||(e.selectioncontrol&&t.addTool("MoveTool",Ql.create({},n),"MoveTool"),e.zoomcontrol&&t.addTool("ZoomPanTool",Nl.create({},n),"ZoomPanTool"),e.brightnesscontrol&&t.addTool("BrightnessTool",Wl.create({},n),"BrightnessTool"),e.contrastcontrol&&t.addTool("ContrastTool",Yl.create({},n),"ContrastTool"),e.rotatecontrol&&t.addTool("RotateTool",Hl.create({},n),"RotateTool"),function(){if(!e.store.task)return;const t=e.multiImage?e.parsedValueList:e.parsedValue,n=e.annotation?`@${e.annotation.id}`:"";Array.isArray(t)?t.forEach(((t,o)=>{e.imageEntities.push({id:`${e.name}#${o}${n}`,src:t,index:o})})):e.imageEntities.push({id:`${e.name}#0${n}`,src:t,index:0}),e.setCurrentImage(0)}())},getToolsManager:function(){return t},afterResultCreated:function(t){t&&(t.classification||e.multiImage&&(null==t.setItemIndex||t.setItemIndex(e.currentImage)))}}})).extend((e=>{let t=!1;return{views:{getSkipInteractions(){var n;if((0,j.VS)(j.pG)){if(t)return!0;if(e.annotation.isLinkingMode)return!1;const n=e.getToolsManager().findSelectedTool();return!(null==n?void 0:n.canInteractWithRegions)}const o="ZoomPanTool"===(null==(n=e.getToolsManager().findSelectedTool())?void 0:n.toolName);return t||o}},actions:{setSkipInteractions(e){t=e},updateSkipInteractions(t){const n=e.getToolsManager().findSelectedTool();if(null!=n&&n.shouldSkipInteractions)return e.setSkipInteractions(n.shouldSkipInteractions(t));e.setSkipInteractions(t.evt&&(t.evt.metaKey||t.evt.ctrlKey))}}}})).actions((e=>({freezeHistory(){},afterRegionSelected(t){e.multiImage&&e.setCurrentImage(t.item_index)},createDrawingRegion(t,n,o,i){const s={from_name:e.annotation.names.get(o.name),to_name:e,type:o.resultType,value:n},r=Object.assign({id:T(),object:e},t,{results:[s],dynamic:i,item_index:e.currentImage});return e.drawingRegion=r,e.drawingRegion},deleteDrawingRegion(){const{drawingRegion:t}=e;t&&(e.drawingRegion=null,(0,u.zr)(t))},setSelectionStart(t){e.selectionArea.setStart(t)},setSelectionEnd(t){e.selectionArea.setEnd(t)},resetSelection(){e.selectionArea.setStart(null),e.selectionArea.setEnd(null)},updateBrushControl(t){e.brushControl=t},updateBrushStrokeWidth(t){e.brushStrokeWidth=t},setBrightnessGrade(t){e.brightnessGrade=t},setContrastGrade(t){e.contrastGrade=t},setGridSize(t){e.gridsize=String(t)},setCurrentItem(t=0){e.setCurrentImage(t)},setCurrentImage(t=0){var n;(t=null!=(n=t)?n:0)!==e.currentImage&&(e.currentImage=t,e.currentImageEntity=e.findImageEntity(t),(0,j.VS)(j.F2)&&e.preloadImages())},preloadImages(){if(e.currentImageEntity.setImageLoaded(!1),e.currentImageEntity.preload(),e.multiImage){const[t,n]=[e.currentImage,e.imageEntities.length],o=(0,x.clamp)(t-3,0,t),i=(0,x.clamp)(t+1+3,t,n-1);[...e.imageEntities.slice(o,t),...e.imageEntities.slice(t+1,i)].forEach((e=>{e.preload()}))}},setPointerPosition({x:t,y:n}){e.freezeHistory(),e.cursorPositionX=t,e.cursorPositionY=n},setZoom(t){t=(0,x.clamp)(t,1,Number.POSITIVE_INFINITY),e.currentZoom=t;const n=e.maxScale,o=e.coverScale;if(n>1?t<n?(e.stageZoom=t,e.zoomScale=1):(e.stageZoom=n,e.zoomScale=t/n):t>n?(e.stageZoom=n,e.zoomScale=t):(e.stageZoom=t,e.zoomScale=1),e.zoomScale>1){const t=Math.min(n*e.zoomScale,o);e.containerWidth/e.naturalWidth>e.containerHeight/e.naturalHeight?(e.stageZoomX=t,e.stageZoomY=e.stageZoom):(e.stageZoomX=e.stageZoom,e.stageZoomY=t)}else e.stageZoomX=e.stageZoom,e.stageZoomY=e.stageZoom},updateImageAfterZoom(){const{stageWidth:t,stageHeight:n}=e;e._recalculateImageParams(),t===e.stageWidth&&n===e.stageHeight||e._updateRegionsSizes({width:e.stageWidth,height:e.stageHeight,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight})},setZoomPosition(t,n){const[o,i]=(0,j.VS)(j.aT)?[e.canvasSize.width,e.canvasSize.height]:[e.containerWidth,e.containerHeight],[s,r]=[o-e.stageComponentSize.width*e.zoomScale,i-e.stageComponentSize.height*e.zoomScale];e.zoomingPositionX=(0,x.clamp)(t,s,0),e.zoomingPositionY=(0,x.clamp)(n,r,0)},resetZoomPositionToCenter(){const{stageComponentSize:t,zoomScale:n}=e,{width:o,height:i}=t,[s,r]=(0,j.VS)(j.aT)?[e.canvasSize.width,e.canvasSize.height]:[e.containerWidth,e.containerHeight];e.setZoomPosition((s-o*n)/2,(r-i*n)/2)},sizeToFit(){const{maxScale:t}=e;e.defaultzoom="fit",e.setZoom(t),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},sizeToOriginal(){const{maxScale:t}=e;e.defaultzoom="original",e.setZoom(t>1?1:1/t),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},sizeToAuto(){e.defaultzoom="auto",e.setZoom(1),e.updateImageAfterZoom(),e.resetZoomPositionToCenter()},handleZoom(t,n={x:e.canvasSize.width/2,y:e.canvasSize.height/2}){if(t){let o=e.currentZoom;if(o=t>0?o*e.zoomBy:o/e.zoomBy,!0!==e.negativezoom&&o<=1)return e.setZoom(1),e.setZoomPosition(0,0),void e.updateImageAfterZoom();if(o<=1)return e.setZoom(o),e.setZoomPosition(0,0),void e.updateImageAfterZoom();let i=e.zoomScale;const s={x:(n.x-e.zoomingPositionX)/i,y:(n.y-e.zoomingPositionY)/i};e.setZoom(o),i=e.zoomScale;const r={x:-(s.x-n.x/i)*i,y:-(s.y-n.y/i)*i};e.setZoomPosition(r.x,r.y),e.updateImageAfterZoom()}},setMode(t){e.mode=t},setImageRef(t){e.imageRef=t},setContainerRef(t){e.containerRef=t},setStageRef(t){e.stageRef=t;const n=e.getToolsManager().findSelectedTool();null==n||null==n.updateCursor||n.updateCursor()},setOverlayRef(t){e.overlayRef=t},setSelected(){},rotate(t=-90){e.rotation=(e.rotation+t+360)%360;let n=1/e.stageRatio;e.isSideways?e.stageRatio=e.naturalWidth/e.naturalHeight:e.stageRatio=1,n*=e.stageRatio,e.setZoom(e.currentZoom),-90===t&&this.setZoomPosition(e.zoomingPositionY*n,e.stageComponentSize.height-e.zoomingPositionX*n-e.stageComponentSize.height*e.zoomScale),90===t&&this.setZoomPosition(e.stageComponentSize.width-e.zoomingPositionY*n-e.stageComponentSize.width*e.zoomScale,e.zoomingPositionX*n),e.updateImageAfterZoom()},_recalculateImageParams(){e.stageWidth=(0,j.VS)(j.aT)?e.naturalWidth*e.stageZoom:Math.round(e.naturalWidth*e.stageZoom),e.stageHeight=(0,j.VS)(j.aT)?e.naturalHeight*e.stageZoom:Math.round(e.naturalHeight*e.stageZoom)},_updateImageSize({width:t,height:n,userResize:o}){if(void 0!==e.naturalWidth){if(t>1&&n>1){const o=e.canvasSize.width,i=e.canvasSize.height,s=e.stageZoom,r=e.zoomScale;e.containerWidth=t,e.containerHeight=n,e.setZoom(e.currentZoom),e._recalculateImageParams();const a=e.stageZoom/s*(e.zoomScale/r);e.setZoomPosition(e.zoomingPositionX*a+(e.canvasSize.width/2-o/2*a),e.zoomingPositionY*a+(e.canvasSize.height/2-i/2*a))}e.sizeUpdated=!0,e._updateRegionsSizes({width:e.stageWidth,height:e.stageHeight,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight,userResize:o})}},_updateRegionsSizes({width:t,height:n,naturalWidth:o,naturalHeight:i,userResize:s}){var r,a;const l=null==(r=e.annotation)||null==(r=r.history)||null==(r=r.history)?void 0:r.length;e.annotation.history.freeze(),e.regions.forEach((e=>{e.updateImageSize(t/o,n/i,t,n,s)})),e.regs.forEach((e=>{e.updateImageSize(t/o,n/i,t,n,s)})),null==(a=e.drawingRegion)||a.updateImageSize(t/o,n/i,t,n,s),setTimeout(e.annotation.history.unfreeze,0),l<=1&&setTimeout((()=>{var t;return null==(t=e.annotation)?void 0:t.reinitHistory(!1)}),0)},updateImageSize(t){var n;const{naturalWidth:o,naturalHeight:i}=null!=(n=e.imageRef)?n:t.target,{offsetWidth:s,offsetHeight:r}=e.containerRef;e.naturalWidth=o,e.naturalHeight=i,e._updateImageSize({width:s,height:r}),e.setReady(!0),"fit"===e.defaultzoom?e.sizeToFit():e.sizeToAuto(),setTimeout((()=>{var t;return null==(t=e.annotation)?void 0:t.reinitHistory(!1)}),0)},checkLabels(){const t=e.activeStates()||[];return 0!==e.getAvailableStates().length||0===t.length},addShape(t){e.regions.push(t),e.annotation.addRegion(t),e.setSelected(t.id),t.selectRegion()},onResize(t,n,o){e._updateImageSize({width:t,height:n,userResize:o})},event(t,n,o,i){const[s,r]=e.fixZoomedCoords([o,i]),a=e.canvasToInternalX(s),l=e.canvasToInternalY(r);e.getToolsManager().event(t,n.evt||n,a,l,s,r)}}))),fd=u.gK.model().actions((e=>({fixZoomedCoords([t,n]){if(!e.stageRef)return[t,n];const o=e.stageRef.getAbsoluteTransform().copy().invert().point({x:t,y:n});return[o.x,o.y]},zoomOriginalCoords([t,n]){const o=e.stageRef.getAbsoluteTransform().point({x:t,y:n});return[o.x,o.y]},fixForZoom(e){return t=>this.fixForZoomWrapper(t,e)},fixForZoomWrapper(t,n){const o=void 0===t.x,[i,s]=e.fixZoomedCoords(o?t:[t.x,t.y]),r=n(o?[i,s]:{x:i,y:s}),a=e.zoomOriginalCoords(o?r:[r.x,r.y]);return o?a:{x:a[0],y:a[1]}}}))).views((e=>({get whRatio(){return(0,j.VS)(j.MV)?e.stageWidth/e.stageHeight:1},canvasToInternalX:t=>t/e.stageWidth*tt,canvasToInternalY:t=>t/e.stageHeight*nt,internalToCanvasX:t=>t/tt*e.stageWidth,internalToCanvasY:t=>t/nt*e.stageHeight}))),vd=fd.views((()=>({canvasToInternalX:e=>e,canvasToInternalY:e=>e,internalToCanvasX:e=>e,internalToCanvasY:e=>e}))),yd=u.gK.compose("ImageModel",ud,Sn,...(0,j.VS)(j.gF)?[cd]:[],Ne,He,ad,pd,(0,j.VS)(j.MV)?fd:vd),bd=(0,v.WQ)("store")(Xr);b.addTag("image",yd,bd),b.addObjectType(yd);var xd=n(7976),Sd=n.n(xd);const wd=u.gK.model().views((()=>({}))).actions((e=>({updateSpansColor(t,n){e._spans&&e._spans.forEach((e=>{t&&(e.style.backgroundColor=t),n&&(e.style.backgroundColor=sn.Colors.rgbaChangeAlpha(e.style.backgroundColor,n))}))},updateAppearenceFromState(){const t=e.getLabelColor();e.updateSpansColor(t,e.selected?.8:.3),e.applyCSSClass(e._lastSpan)},createSpans(){const t=e.getLabelColor(),n=(0,Ke.highlightRange)(e,"htx-highlight",{backgroundColor:t}),o=n[n.length-1];if(o)return e.applyCSSClass(o),e._lastSpan=o,e._spans=n,n},getLabelColor(){let t=e.parent.highlightcolor||(e.style||e.tag||z.l).fillcolor;return t&&(t=sn.Colors.convertToRGBA(t,.3)),t},applyCSSClass(t){if(!t)return;const n=["htx-highlight","htx-highlight-last"],o=(0,u.Zn)(e).settings;if(e.parent.showlabels||null!=o&&o.showLabels){var i;const o=null==(i=e.labeling)?void 0:i.mainValue,s=sn.HTML.labelWithCSS(t,{index:e.region_index,labels:o,score:e.score});n.push(s)}else n.push("htx-no-label");t.className=n.filter(Boolean).join(" ")},addEventsToSpans(t){const n=t=>(t.onmouseover=n=>{e.hidden||(e.annotation.isLinkingMode?(e.toggleHighlight(),t.style.cursor=z.A.LINKING_MODE_CURSOR,n.stopPropagation()):t.style.cursor=z.A.POINTER_CURSOR)},t.onmouseout=()=>{e.hidden||e.setHighlight(!1)},t.onmousedown=function(t){e.hidden||e.parent._currentSpan!==this&&(t.stopPropagation(),e.parent._currentSpan=this)},t.onclick=function(){e.hidden||e.parent._currentSpan===this&&(t.style.cursor=z.A.POINTER_CURSOR,e.onClickRegion())},!1);t&&t.forEach((e=>n(e)))},selectRegion(){e.updateSpansColor(null,.8);const t=e._spans[0];t&&(t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView({block:"center",behavior:"smooth"}))},afterUnselectRegion(){e.updateSpansColor(null,.3)},setHighlight(t){if(e._highlighted=t,e._spans){const t=e._spans.length,n=e._spans[0],o=e._spans[t-1],i=e._spans.slice(1,t-1),s=(e,t,{top:n=!0,bottom:o=!0,right:i=!0,left:s=!0}={})=>{i&&(e.style.borderRight=t),s&&(e.style.borderLeft=t),n&&(e.style.borderTop=t),o&&(e.style.borderBottom=t)};if(e.highlighted&&!e.hidden){const e=z.A.HIGHLIGHTED_CSS_BORDER;s(n,e,{right:!1}),s(o,e,{left:!1}),i.length&&i.forEach((t=>s(t,e,{left:!1,right:!1})))}else{const e="0px";s(n,e),s(o,e),i.length&&i.forEach((t=>s(t,e,{left:!1,right:!1})))}}},toggleHidden(t){e.hidden=!e.hidden,e.setHighlight(e.highlighted),e.hidden?(e.updateSpansColor("transparent",0),e._spans&&e._spans.forEach((e=>{e.style.cursor=z.A.DEFAULT_CURSOR}))):e.updateAppearenceFromState(),null==t||t.stopPropagation()},find:t=>e._spans&&e._spans.indexOf(t)>=0?e:void 0}))),kd=u.gK.model("LabelMixin"),Cd=u.gK.model().volatile((()=>({isSeparated:!1}))).views((e=>({get tiedChildren(){return L.filterChildrenOfType(e,e._child)},get selectedLabels(){return e.tiedChildren.filter((e=>!0===e.selected))},getSelectedColor(){const t=e.tiedChildren.find((e=>!0===e.selected));return t&&t.background},get selectedColor(){const t=e.tiedChildren.find((e=>!0===e.selected));return t&&t.background},get isSelected(){return e.selectedLabels.length>0},get holdsState(){return e.selectedLabels.length>0},selectedValues:()=>e.selectedLabels.map((e=>e.alias?e.alias:e.value)).filter((e=>(0,x.isDefined)(e))),getResultValue:()=>({[e.valueType]:e.selectedValues()}),get selectedAliases(){return e.selectedLabels.filter((e=>e.alias)).map((e=>e.alias))},getSelectedString:(t=" ")=>e.selectedValues().join(t),findLabel:t=>e.tiedChildren.find((e=>e.alias===t&&(0,x.isDefined)(t)||e.value===t||!(0,x.isDefined)(e.value)&&!(0,x.isDefined)(t))),get emptyLabel(){return e.allowempty?e.findLabel(null):null}}))).actions((e=>({unselectAll(){e.tiedChildren.forEach((e=>e.setSelected(!1)))},checkMaxUsages:()=>e.tiedChildren.filter((e=>!e.canBeUsed())),selectFirstVisible(){const t=e.tiedChildren.find((e=>e.visible));return t&&t.toggleSelected(),t},updateFromResult(t){e.unselectAll();const n=Array.isArray(t)?t.length?t:[null]:[t];if(n.length)n.map((t=>e.findLabel(t))).forEach((e=>null==e?void 0:e.setSelected(!0)));else if(e.allowempty){var o;null==(o=e.findLabel(null))||o.setSelected(!0)}}}))),jd=u.gK.model({}).views((()=>({get defaultChildType(){console.error("DynamicChildrenMixin needs to implement defaultChildType getter in views")}}))).actions((e=>{const t=(n,o,i)=>{if((!Ys.ff.isActive(j.cE)||!o.annotationStore.initialized)&&n&&n.length)for(const r of n){var s;const n=null!=(s=r.id)?s:T();i.children.push(Object.assign({type:e.defaultChildType},r,{id:n,children:[]}));const a=i.children[i.children.length-1];null==a.updateValue||a.updateValue(o),t(r.children,o,a)}},n=(e,t)=>{null==e||e.forEach((e=>{n(e.children,t),null==e.updateValue||e.updateValue(t)}))};return{updateWithDynamicChildren(n,o){var i;const s=(0,u.Zn)(e);e.children=null!=(i=e.children)?i:[],(0,u.Ze)(s),t(n,o,e),(0,u.yQ)(s)},updateValue(t){Ys.ff.isActive(j.cE)?e.updateDynamicChildren(t):setTimeout((()=>{e.updateDynamicChildren(t)}))},updateDynamicChildren(t){if(!0!==e.locked){var n;const o=k(e.value,null==(n=t.task)?void 0:n.dataObj);if(!o)return;e.updateWithDynamicChildren(o,t),e.annotation&&(e.annotation.setupHotKeys(),null==e.needsUpdate||e.needsUpdate())}},generateDynamicChildren(t,o){if(e.children){const i=e.children,s=i.length,r=s-t.length,a=i.slice(r,s);n(a,o)}}}})),Rd=u.gK.compose(Ue,jd),_d=u.gK.model(Object.assign({},(0,j.VS)(j.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{smart:!0,smartonly:!1,isControlTag:!0})).volatile((()=>({snapMode:ot}))).views((e=>({get resultType(){return e.type},get valueType(){return e.type},get toNameTag(){return e.annotation.names.get(e.toname)},selectedValues(){throw new Error("Control tag needs to implement selectedValues method in views")},get result(){return e.annotation.results.find((t=>t.from_name===e))},getSnappedPoint:t=>"pixel"===e.snap?e.toNameTag.snapPointToPixel(t,e.snapMode):t,get smartEnabled(){var t,n,o;const i=null!=(t=e.smart)&&t;return null!=(n=null==(o=(0,u.Zn)(e))?void 0:o.autoAnnotation)&&n&&i||e.smartonly||!1}}))),Td=u.gK.compose(_d,bn),Ad=["className","style","color","empty","hidden","selected","margins","onClick","children","hotkey"],Kd=m.forwardRef(((e,t)=>{let{className:n,style:o,color:i,empty:s=!1,hidden:r=!1,selected:a=!1,margins:l=!1,onClick:d,children:c,hotkey:u}=e,h=(0,Zn.A)(e,Ad);const g=(0,m.useMemo)((()=>{if(!i)return null;const e=St()(i).alpha(.15);return Object.assign({},null!=o?o:{},(t={color:i,background:e})?Object.entries(t).reduce(((e,[t,n])=>(e[`--${t}`]=n,e)),{}):null);var t}),[i]);return(0,A.jsxs)(Qe.eB,Object.assign({tag:"span",ref:t,name:"label",mod:{empty:s,hidden:r,selected:a,clickable:!!d,margins:l},mix:n,style:g,onClick:d},h,{children:[(0,A.jsx)(Qe.Sl,{tag:"span",name:"text",children:c}),u?(0,A.jsx)(Qe.Sl,{tag:"span",name:"hotkey",children:u}):null]}))})),Ed=u.gK.model("AnnotationMixin",{parentTypes:Le.tagsTypes([])}).views((e=>({get parent(){return Le.getParentTagOfTypeString(e,e.parentTypes)}}))),Pd=u.gK.model({value:u.gK.maybeNull(u.gK.string),selected:u.gK.optional(u.gK.boolean,!1),maxusages:u.gK.maybeNull(u.gK.string),alias:u.gK.maybeNull(u.gK.string),hint:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),showalias:u.gK.optional(u.gK.boolean,!1),aliasstyle:u.gK.optional(u.gK.string,"opacity: 0.6"),size:u.gK.optional(u.gK.string,"medium"),background:u.gK.optional(Me.color,z.A.LABEL_BACKGROUND),selectedcolor:u.gK.optional(Me.color,"#ffffff"),granularity:u.gK.maybeNull(u.gK.enumeration(["symbol","word","sentence","paragraph"])),groupcancontain:u.gK.maybeNull(u.gK.string),html:u.gK.maybeNull(u.gK.string)}),Md=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"label",visible:u.gK.optional(u.gK.boolean,!0),_value:u.gK.optional(u.gK.string,""),parentTypes:Le.tagsTypes(["Labels","EllipseLabels","RectangleLabels","PolygonLabels","KeyPointLabels","BrushLabels","HyperTextLabels","TimelineLabels","TimeSeriesLabels","ParagraphLabels"])}).volatile((e=>({initiallySelected:e.selected,isEmpty:!1}))).views((e=>({get maxUsages(){var t;return Number(e.maxusages||(null==(t=e.parent)?void 0:t.maxusages))},usedAlready:()=>e.annotation.regionStore.regions.reduce(((t,n)=>t+n.hasLabel(e.value)),0),canBeUsed:(t=1)=>!e.maxUsages||e.usedAlready()+t<=e.maxUsages}))).actions((e=>({setEmpty(){e.isEmpty=!0},toggleSelected(){let t=[];e.annotation.selectedDrawingRegions.length>0?t=e.annotation.selectedDrawingRegions.filter((t=>{var n,o;return(null==(n=t.parent)?void 0:n.name)===(null==(o=e.parent)?void 0:o.toname)})):e.annotation.selectedRegions.length>0&&(t=e.annotation.selectedRegions.filter((t=>{var n,o;return(null==(n=t.parent)?void 0:n.name)===(null==(o=e.parent)?void 0:o.toname)})));const n=t.filter((e=>!e.isReadOnly()));if(e.annotation.isReadOnly())return;if(t.length>0&&0===n.length)return;if(n.length&&!e.selected&&!e.canBeUsed(n.filter((e=>e.results)).length))return void yn.warning(`You can't use ${e.value} more than ${e.maxUsages} time(s)`);const o=e.parent,i=n.filter((t=>!(1===o.selectedLabels.length&&e.selected&&1===t.labelings.length&&(null==o||!o.allowempty||e.isEmpty))&&(!!e.selected||("labels"===o.type||(!!o.type.includes(t.type.replace(/region$/,""))||!!o.type.includes(t.results[0].type))))));if(!(t.length>0&&0===i.length)){if(!o.selectedLabels.length&&!e.selected){var s,r,a;const t=od.getInstance({name:e.parent.toname}),n=Object.values((null==(s=e.parent)?void 0:s.tools)||{})[0],o=t.findSelectedTool(),i=!(!n||!o)&&(0,u.Pw)(o).name===(0,u.Pw)(n).name,l=!!o&&(null==n||null==(r=n.control)?void 0:r.name)===(null==o||null==(a=o.control)?void 0:a.name);!n||!(o&&(!i||!l))&&o||t.selectTool(n,!0)}if(e.isEmpty){const t=e.selected;o.unselectAll(),e.setSelected(!t)}else o.shouldBeUnselected||e.setSelected(!e.selected),o.shouldBeUnselected&&(e.selected?o.unselectAll():(o.unselectAll(),e.setSelected(!e.selected)));var l;if(o.allowempty&&!e.isEmpty)if(i.length)o.findLabel().setSelected(!(null!=(l=o.selectedValues())&&l.length));else e.selected&&o.findLabel().setSelected(!1);i.forEach((t=>{t&&(t.setValue(e.parent),t.notifyDrawingFinished(),null==t.updateSpans||t.updateSpans())}))}},setVisible(t){e.visible=t},setSelected(t){e.selected=t},onHotKey:()=>e.onLabelInteract(),onClick:()=>(e.onLabelInteract(),!1),onLabelInteract:()=>e.toggleSelected(),_updateBackgroundColor(t){e.background===z.A.LABEL_BACKGROUND&&(e.background=Sd().make_color({seed:t})[0])},afterCreate(){e._updateBackgroundColor(e._value||e.value)},updateValue(t){e._value=k(e.value,t.task.dataObj)||z.A.EMPTY_LABEL}}))),Dd=u.gK.compose("LabelModel",Ed,Pd,Ue,Md,Ne),Od=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{const n=(t.settings.enableTooltips||t.settings.enableLabelTooltips)&&t.settings.enableHotkeys&&e.hotkey,o=(0,A.jsxs)(Kd,{color:e.background,margins:!0,empty:e.isEmpty,hotkey:n,hidden:!e.visible,selected:e.selected,onClick:e.onClick,children:[e.html?(0,A.jsx)("div",{title:e._value,dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(e.html)}}):e._value,!0===e.showalias&&e.alias&&(0,A.jsxs)("span",{style:sn.styleToProp(e.aliasstyle),children:["",e.alias]})]});return e.hint?(0,A.jsx)(Qn.m_M,{title:e.hint,children:o}):o})));b.addTag("label",Dd,Od);const Id=u.gK.model({toname:u.gK.maybeNull(u.gK.string),choice:u.gK.optional(u.gK.enumeration(["single","multiple"]),"single"),maxusages:u.gK.maybeNull(u.gK.string),showinline:u.gK.optional(u.gK.boolean,!0),groupdepth:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.2"),fillcolor:u.gK.optional(Me.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Me.color,"#f48a42"),fillopacity:u.gK.maybeNull(Me.range()),allowempty:u.gK.optional(u.gK.boolean,!1),value:u.gK.optional(u.gK.string,"")}),Ld=u.gK.model({pid:u.gK.optional(u.gK.string,T),type:"labels",children:Le.unionArray(["label","header","view","text","hypertext","richtext"]),visible:u.gK.optional(u.gK.boolean,!0)}),Nd=kd.views((e=>({get shouldBeUnselected(){return"single"===e.choice},get defaultChildType(){return"label"},get isLabeling(){return!0}}))).actions((e=>({afterCreate(){if(e.allowempty){let t=e.findLabel(null);if(!t){const n={value:null,type:"label",background:z.l.fillcolor};e.children?e.children.unshift(n):e.children=(0,u.wg)([n]),t=e.children[0]}t.setEmpty()}}}))),zd=u.gK.compose("LabelsModel",Td,Ld,Id,Ne,Rd,Nd,Cd.props({_child:"LabelModel"})),Vd=(0,v.PA)((({item:e})=>(0,A.jsx)(Qe.eB,{name:"labels",mod:{hidden:!e.visible,inline:e.showinline},children:L.renderChildren(e,e.annotation)})));b.addTag("labels",zd,Vd);const Hd=u.gK.model("ParagraphLabelsModel",{pid:u.gK.optional(u.gK.string,T),type:"paragraphlabels",children:Le.unionArray(["label","header","view","hypertext"])}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},get serializableValue(){const t={};return t.paragraphlabels=e.selectedValues(),t}}))),Bd=kd.props({_type:"paragraphlabels"}),Fd=u.gK.compose(Td,zd,Hd,Bd,Cd.props({_child:"LabelModel"})),Wd=u.gK.compose("ParagraphLabelsModel",Fd),$d=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("paragraphlabels",Wd,$d);var Ud=n(92806),Yd=n(47956),Xd=n(33250),Gd=function(e){return e[e.inertial=0]="inertial",e[e.instant=1]="instant",e}(Gd||{});const Zd=500,qd=u.gK.model({leadTime:0}).volatile((()=>({leadTimeLogic:Gd.inertial,lastRecordedTime:0,debouncedTime:0}))).actions((e=>({_countTimeInertial(){const t=Date.now();e.debouncedTime<t?e.leadTime+=Zd:e.leadTime+=Zd-(e.debouncedTime-t),e.debouncedTime=t+Zd},_countTimeInstant(){const t=Date.now();e.debouncedTime<t?(e.leadTime+=Zd,e.lastRecordedTime=t+Zd):t>e.lastRecordedTime&&(e.leadTime+=t-e.lastRecordedTime,e.lastRecordedTime=t),e.debouncedTime=t+Zd}}))).actions((e=>({countTime(){e.leadTimeLogic===Gd.inertial?e._countTimeInertial():e.leadTimeLogic===Gd.instant&&e._countTimeInstant()},resetLeadTimeCounters(){e.lastRecordedTime=0,e.debouncedTime=0}}))),Jd=u.gK.model({peritem:u.gK.optional(u.gK.boolean,!1)}).extend((e=>{if(!0!==e.isClassificationTag)throw new Error("The PerItemMixin mixin should be used only for classification control-tags");return{}})).views((e=>({get _perItemResult(){return e.annotation.results.find((t=>t.from_name===e&&t.area.item_index===e.toNameTag.currentItemIndex))}}))).actions((e=>({_validatePerItem(){const t=e.toNameTag;return e.annotation.regions.every((n=>{const o=n.results.find((t=>t.from_name===e));if(null==o||!o.hasValue)return!0;const i=o.mainValue;return!!e.validateValue(i)||(t.setCurrentItem(n.item_index),!1)}))},createPerItemResult(){e.createPerObjectResult({item_index:e.toNameTag.currentItemIndex})}}))),Qd=Jd,ec=u.gK.model({required:u.gK.optional(u.gK.boolean,!1),requiredmessage:u.gK.maybeNull(u.gK.string)}).actions((e=>{const t={validate:e.validate};return{validate(){if(!t.validate())return!1;if(!e.required)return!0;if(e.perregion){const t=e.toNameTag;for(const o of t.allRegs){const t=o.results.find((t=>t.from_name===e));if("region-selected"===e.visiblewhen&&e.whentagname){var n;const t=null==(n=o.labeling)||null==(n=n.from_name)?void 0:n.name;if(t&&t!==e.whentagname)continue}if((!e.whenlabelvalue||o.hasLabel(e.whenlabelvalue))&&(null==t||!t.hasValue))return e.annotation.selectArea(o),e.requiredModal(),!1}}else if((0,j.VS)(j.gF)&&e.peritem){const t=e.toNameTag,n=t.maxItemIndex,o=e.annotation.regions.reduce(((t,n)=>{const o=n.results.find((t=>t.from_name===e));return null!=o&&o.hasValue&&t.add(n.item_index),t}),new Set);for(let i=0;i<=n;i++)if(!o.has(i))return t.setCurrentItem(i),e.requiredModal(),!1}else{var o;if(!e.holdsState&&!1!==e.isVisible&&!1!==(null==(o=(0,u.PA)(e,2))?void 0:o.isVisible))return e.requiredModal(),!1}return!0}}})),tc=ec,nc="lsf-mark",oc="lsf-selected",ic="lsf-highlighted",sc="lsf-relation";var rc=n(6757),ac=n(39984);const lc={input:"input--GGvVi",editing:"editing--TQ89C",enter:"enter--FWKNX",delete:"delete--hGoXe"},dc=["className","rows","onlyEdit","name","onFocus","onChange","onDelete","isEditable","isDeleteable","ignoreShortcuts"],cc=["onChange","onDelete","isEditable","isDeleteable","text","ignoreShortcuts","onlyEdit"],{Paragraph:uc}=rc.A;class hc extends m.Component{constructor(...e){super(...e),this.state={editing:!1,height:0,value:this.props.text},this.textRef=m.createRef(),this.inputRef=m.createRef(),this.handleGlobalClick=e=>{var t;const n=null==e?void 0:e.target,o=null==n||null==(t=n.dataset)?void 0:t.shortcut;!this.state.editing||this.props.ignoreShortcuts&&o||n===this.inputRef.current||this.setEditing(!1)},this.startEditing=()=>{var e,t,n;const o=(null==(e=this.textRef.current)?void 0:e.parentNode.offsetHeight)||0;this.setState({editing:!0,height:o}),null==(t=(n=this.props).onStartEditing)||t.call(n),setTimeout(this.focus)},this.focus=()=>{const e=this.inputRef.current;e&&(e.selectionStart=this.state.value.length)},this.setEditing=e=>{this.setState({editing:e})},this.setValue=e=>{this.setState({value:e})},this.cancel=()=>{this.setValue(this.props.text),this.setEditing(!1)},this.save=()=>{this.props.onChange(this.state.value),this.setEditing(!1)},this.updateHeight=On()((()=>{var e,t;const n=null!=(e=null==(t=this.inputRef.current)?void 0:t.scrollHeight)?e:0,o=n+2;n&&o!==this.state.height&&this.setState({height:o})}),100)}static getDerivedStateFromProps(e,t){return e.text!==t.prevPropsText?{value:e.text,prevPropsText:e.text}:null}componentDidMount(){window.addEventListener("click",this.handleGlobalClick,{capture:!0})}componentWillUnmount(){window.removeEventListener("click",this.handleGlobalClick,{capture:!0})}renderEdit(){const e=this.props,{className:t="",rows:n=1,onlyEdit:o,name:i,onFocus:s,onChange:r}=e,a=(0,Zn.A)(e,dc),{height:l,value:d}=this.state,c={name:i,className:`ant-input ${lc.input}`,style:l?{height:l,borderWidth:1}:null,autoFocus:!0,ref:this.inputRef,value:d,onBlur:()=>{r(this.state.value)},onFocus:s,onChange:e=>{this.setValue(e.target.value),this.updateHeight()},onKeyDown:e=>{const{key:t,shiftKey:o}=e;"Enter"===t?(1==+n||o)&&(e.preventDefault(),e.stopPropagation(),this.save()):"Escape"===t?this.cancel():"Tab"===t&&this.setEditing(!1)}};return this.updateHeight(),(0,A.jsxs)(uc,Object.assign({},a,{className:`${t} ant-typography-edit-content ${lc.editing}`,children:[n>1?(0,A.jsx)("textarea",Object.assign({},c)):(0,A.jsx)("input",Object.assign({},c)),!o&&(0,A.jsx)(Qn.m_M,{title:"Save: [shift+enter]",children:(0,A.jsx)(ac.A,{className:`ant-typography-edit-content-confirm ${lc.enter}`,onClick:this.save})})]}))}renderView(){const e=this.props,{onChange:t,onDelete:n,isEditable:o,isDeleteable:i,text:s}=e,r=(0,Zn.A)(e,cc);return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(uc,Object.assign({},r,{children:(0,A.jsx)("span",{ref:this.textRef,children:s})})),o&&t&&(0,A.jsx)(Po,{type:"text",className:lc.button,tooltip:"Edit",tooltipTheme:"Dark",style:{padding:0},icon:(0,A.jsx)(To.GI1,{}),"aria-label":"Edit Region",onClick:this.startEditing}),i&&n&&(0,A.jsx)(Po,{type:"text",look:"danger",className:lc.button,tooltip:"Delete",tooltipTheme:"Dark",style:{padding:0},icon:(0,A.jsx)(To.HVA,{}),"aria-label":"Delete Region",onClick:n})]})}render(){return(this.state.editing||this.props.onlyEdit)&&this.props.isEditable?this.renderEdit():this.renderView()}}const gc=u.gK.model("TextAreaRegionModel",{id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"textarearegion",_value:u.gK.string}).volatile((()=>({classification:!0,perRegionTags:[],results:[],selected:!1}))).views((e=>({get parent(){return(0,u.k2)(e,Cc)},getRegionElement:()=>document.querySelector(`#TextAreaRegion-${e.id}`),getOneColor:()=>null}))).actions((e=>({setValue(t){e._value!==t&&e.parent.validateText(t)&&(e._value=t,e.parent.onChange())},deleteRegion(){e.parent.remove(e)},selectRegion(){e.selected=!0},afterUnselectRegion(){e.selected=!1}}))),mc=u.gK.compose("TextAreaRegionModel",ut,Ze,gc),pc=(0,v.PA)((({item:e,onFocus:t})=>{var n;const o=[nc],i={onFocus:n=>t(n,e)},{parent:s}=e,{relationMode:r}=e.annotation,a=s.isEditable&&!e.isReadOnly(),l=s.isDeleteable&&!e.isReadOnly();r&&o.push(sc),e.selected?o.push(oc):e.highlighted&&o.push(ic),(a||s.transcription)&&(i.onChange=t=>{e.setValue(t),e.parent.updateLeadTime()},i.onInput=()=>{e.parent.countTime()}),i.onDelete=e.deleteRegion;let d={};s.perregion||(d={onMouseOver:()=>{r&&e.setHighlight(!0)},onMouseOut:()=>{r&&e.setHighlight(!1)}});const c=`${null!=(n=null==s?void 0:s.name)?n:""}:${e.id}`;return(0,A.jsx)("div",Object.assign({},d,{className:(0,Qe.cn)("row").toString(),"data-testid":"textarea-region",children:(0,A.jsx)(hc,Object.assign({isEditable:a,isDeleteable:l,onlyEdit:s.transcription,id:`TextAreaRegion-${e.id}`,name:c,className:o.join(" "),rows:s.rows,text:e._value},i,{ignoreShortcuts:!0}))}))}));b.addTag("textarearegion",mc,pc);const fc=u.gK.model("ClassificationBase",{isClassificationTag:!0}).extend((e=>{if(!0!==e.isControlTag)throw new Error("The ClassificationBase mixin should be used only for ControlTags");const t=["toname"].filter((t=>!e.$treenode.type.propertyNames.includes(t)));for(const e of t)throw new Error(`The property "${e}" should be defined for ClassificationBase mixin model needs`);return{}})).volatile((()=>({elementRef:m.createRef()}))).views((e=>({selectedValues(){throw new Error("ClassificationBase mixin model needs to implement selectedValues method in views")},get result(){return e.perregion?e._perRegionResult:e.peritem?e._perItemResult:e.annotation.results.find((t=>t.from_name===e))},getRegionElement:()=>e.elementRef.current,get isIndependent(){return e.isClassificationTag&&!e.perregion&&!e.peritem&&!e.value}}))).actions((e=>({validate:()=>e.perregion?e._validatePerRegion():e.peritem&&(0,j.VS)(j.gF)?e._validatePerItem():e._validatePerObject(),validateValue:e=>!0,_validatePerObject:()=>e.validateValue(e.selectedValues()),createPerObjectResult(t={}){e.annotation.createResult(t,{[e.valueType]:e.selectedValues()},e,e.toname)},updateResult(){e.result?(e.result.area.updateOriginOnEdit(),e.result.area.setValue(e)):e.perregion?null==e.createPerRegionResult||e.createPerRegionResult():e.peritem?e.createPerItemResult():e.createPerObjectResult()}}))),{TextArea:vc}=Xd.A,yc=(0,m.forwardRef)((({idx:e,value:t,readOnly:n,onChange:o,onDelete:i,onFocus:s,validate:r,control:a,collapsed:l,canDelete:d=!0},c)=>{const u=Number.parseInt(a.rows)>1,[h,g]=(0,m.useState)(null!=t?t:"");(0,m.useEffect)((()=>{t!==h&&g(t)}),[t]);const p=(0,m.useMemo)((()=>{var e;return l?null!=(e=(null!=t?t:"").split(/\n/)[0])?e:"":h}),[t,l,h]),f=(0,m.useCallback)((e=>{g(e.target.value)}),[]),v=(0,m.useCallback)((n=>{t===n.target.value||l||(r&&!r(n.target.value)?g(t):null==o||o(e,n.target.value))}),[e,t,o,r,l]),y={className:`ant-input ${lc.input}`,value:p,autoSize:u?{minRows:1}:null,onChange:f,readOnly:n||l,onFocus:s};return y.onBlur=v,y.onKeyDown=e=>{var t;("Enter"===e.key&&!e.shiftKey||"Escape"===e.key)&&(e.preventDefault(),e.stopPropagation(),null==(t=e.target)||null==t.blur||t.blur())},(0,A.jsxs)(Qe.Sl,{name:"item",children:[(0,A.jsx)(Qe.Sl,Object.assign({name:"input",tag:u?vc:Xd.A},y,{ref:c})),d&&!l&&!n&&(0,A.jsx)(Qe.Sl,{name:"action","aria-label":"Delete Region",tag:Ud.default,icon:(0,A.jsx)(To.Eau,{}),size:"small",type:"text",onClick:()=>{i(e)}})]})})),bc=(0,v.PA)((({item:e,control:t,firstResultInputRef:n,onFocus:o,collapsed:i,canDelete:s=!0})=>{const r=e.mainValue,a=!e.isReadOnly()&&e.from_name.editable&&!e.area.isReadOnly(),l=(0,m.useCallback)(((t,n)=>{if(e.from_name.isReadOnly())return;const o=r.toJSON();o.splice(t,1,n),e.setValue(o)}),[r]),d=(0,m.useCallback)((t=>{if(!e.from_name.isDeleteable)return;const n=r.toJSON();n.splice(t,1),e.setValue(n)}),[r]);return r.map(((r,c)=>(0,A.jsx)(yc,{idx:c,value:r,readOnly:!a,onChange:l,onDelete:d,control:t,ref:0===c?n:null,onFocus:o,collapsed:i,validate:e.from_name.validateText,canDelete:e.from_name.isDeleteable&&s},c)))})),xc=(0,v.PA)((({item:e,area:t,collapsed:n,setCollapsed:o,outliner:i,color:s,canDelete:r=!0})=>{var a,l;const d=Number.parseInt(e.rows),c=d>1,h=e.perRegionArea===t,g=t.isCompleted&&t.perRegionFocusTarget===e&&t.perRegionFocusRequest,p=h?e._value:"",f=t.results.find((t=>t.from_name===e)),v=(0,m.useCallback)((()=>{n&&(o(!1),t.isSelected||t.annotation.selectArea(t))}),[n]),y=(0,m.useCallback)((()=>{f?(e.addTextToResult(e._value,f),e.setValue("")):(e.addText(e._value),e.setValue(""))}),[e,f]),b=(0,m.useRef)(),x=(0,m.useRef)(),S=(0,m.useRef)(0),w=(0,m.useMemo)((()=>s?{"--border-color":s}:{}),[s]);(0,m.useEffect)((()=>{var e;h&&g&&S.current<t.perRegionFocusRequest&&(null==(e=b.current||x.current)||e.focus({cursor:"end"}),S.current=t.perRegionFocusRequest)}),[h,g]),(0,m.useEffect)((()=>{n&&e._value&&y()}),[n]);const k={ref:b,value:p,rows:e.rows,className:"is-search",label:e.label,placeholder:e.placeholder,autoSize:c?{minRows:1}:null,onChange:t=>{if(n)return;const{value:o}=t.target;e.setValue(o)},onFocus:e=>{e.stopPropagation(),e.preventDefault(),t.isSelected||t.annotation.selectArea(t)}};c&&(k.onKeyDown=t=>{var n;("Enter"!==t.key||t.shiftKey)&&"Escape"!==t.key||e.annotation.isReadOnly()||(t.preventDefault(),t.stopPropagation(),e.allowsubmit&&e._value?y():null==(n=t.target)||null==n.blur||n.blur())}),e.annotation.isReadOnly()&&(k.disabled=!0);!e.annotation.isReadOnly()&&(a=e.showsubmitbutton);const C=(!f||!(null!=f&&null!=(l=f.mainValue)&&l.length)||e.maxsubmissions&&f.mainValue.length<Number.parseInt(e.maxsubmissions))&&!t.isReadOnly();return(0,u._n)(e)&&(0,u._n)(t)?(f||C)&&(0,A.jsxs)(Qe.eB,{name:"textarea-tag",mod:{mode:e.mode,outliner:i},style:w,children:[f?(0,A.jsx)(bc,{control:e,item:f,collapsed:n,firstResultInputRef:x,onFocus:v,canDelete:r}):null,C&&(0,A.jsx)(Qe.Sl,{name:"form",tag:Yd.A,onFinish:()=>(e.allowsubmit&&e._value&&!e.annotation.isReadOnly()&&y(),!1),onClick:e=>{e.stopPropagation()},children:(0,A.jsx)(Qe.Sl,Object.assign({name:"input",tag:c?vc:Xd.A},k,{onClick:e=>{e.stopPropagation()}}))})]}):null}));b.addPerRegionView("textarea",mt.REGION_LIST,xc);const{TextArea:Sc}=Xd.A,wc=u.gK.model({toname:u.gK.maybeNull(u.gK.string),allowsubmit:u.gK.optional(u.gK.boolean,!0),label:u.gK.optional(u.gK.string,""),value:u.gK.maybeNull(u.gK.string),rows:u.gK.optional(u.gK.string,"1"),showsubmitbutton:u.gK.maybeNull(u.gK.boolean),placeholder:u.gK.maybeNull(u.gK.string),maxsubmissions:u.gK.maybeNull(u.gK.string),editable:u.gK.optional(u.gK.boolean,!1),transcription:!1,skipduplicates:u.gK.optional(u.gK.boolean,!1)}),kc=u.gK.model({type:"textarea",regions:u.gK.array(mc),_value:u.gK.optional(u.gK.string,""),children:Le.unionArray(["shortcut"])}).volatile((()=>({focusable:!0,textareaRef:(0,m.createRef)()}))).views((e=>({get isEditable(){return e.editable&&e.annotation.editable},get isDeleteable(){return!e.isReadOnly()},get valueType(){return"text"},get holdsState(){return e.regions.length>0},get submissionsNum(){return e.regions.length},get showSubmit(){if(e.maxsubmissions){const t=Number.parseInt(e.maxsubmissions);return e.submissionsNum<t}return!0},get serializableValue(){return e.regions.length?{text:e.selectedValues()}:null},selectedValues:()=>e.regions.map((e=>e._value)),hasResult(t){if(!e.result)return!1;let n=e.result.mainValue;return Array.isArray(n)||(n=[n]),t=t.toLowerCase(),n.some((e=>e.toLowerCase()===t))}}))).actions((()=>(0,j.VS)(j.y8)?{}:{countTime:()=>{}})).actions((e=>{let t=null,n=null;const o=(t,n)=>!!(t&&n&&(0,u._n)(n))&&(!(e===n&&!e.showSubmit)&&!!t.parentElement);return{getSerializableValue(){const t=e.regions.map((e=>e._value));if(0!==t.length)return{text:t}},needsUpdate(){var t;e.updateFromResult(null==(t=e.result)?void 0:t.mainValue)},requiredModal(){yn.warning(e.requiredmessage||`Input for the textarea "${e.name}" is required.`)},uniqueModal(){yn.warning("There is already an entry with that text. Please enter unique text.")},setResult(t){(Array.isArray(t)?t:[t]).forEach((t=>e.createRegion(t)))},updateFromResult(t){e.regions=[],t&&e.setResult(t)},setValue(t){e._value=t},remove(t){const n=e.regions.indexOf(t);n<0||(e.regions.splice(n,1),(0,u.zr)(t),e.onChange(t))},perRegionCleanup(){e.regions=[]},createRegion(t,n,o){const i=mc.create({pid:n,leadTime:o,_value:t});return e.regions.push(i),i},onChange(t){var n;e.updateResult();const o=null!=t?t:null==(n=e.result)?void 0:n.area;null==o||o.notifyDrawingFinished()},validateText:t=>!e.skipduplicates||!e.hasResult(t)||(e.uniqueModal(),!1),addText(t,n){e.validateText(t)&&(e.createRegion(t,n,e.leadTime),e.onChange(),e.updateLeadTime())},updateLeadTime(){var t,n;if(!(0,j.VS)(j.y8))return;const o=e.result;o&&(o.setMetaValue("lead_time",(null!=(t=null==(n=o.meta)?void 0:n.lead_time)?t:0)+e.leadTime/1e3),e.leadTime=0,e.resetLeadTimeCounters())},addTextToResult(t,n){if(!e.validateText(t))return;const o=n.mainValue.toJSON();o.push(t),n.setValue(o)},beforeSend(){e._value&&e._value.length&&(e.addText(e._value),e._value="")},submitChanges(){e.beforeSend()},deleteText(e){(0,u.zr)(e)},onShortcut(i){if(!o(t,n)){var s,r;const i=(null==(s=e.textareaRef.current)?void 0:s.input)||(null==(r=e.textareaRef.current)||null==(r=r.resizableTextArea)?void 0:r.textArea);if(!o(i,e))return;t=i,n=e}t.setRangeText(i,t.selectionStart,t.selectionEnd,"end"),n.setValue(t.value)},setLastFocusedElement(o,i=e){t=o,n=i},returnFocus(){var e;null==(e=t)||null==e.focus||e.focus()}}})),Cc=u.gK.compose("TextAreaModel",Td,fc,wc,...(0,j.VS)(j.y8)?[qd]:[],Ue,tc,pt,...(0,j.VS)(j.gF)?[Qd]:[],Ne,qe,kc),jc=(0,v.PA)((({item:e})=>{var t;const n=Number.parseInt(e.rows),o=(0,m.useCallback)(((t,n)=>{e.setLastFocusedElement(t.target,n)}),[e]),i={name:e.name,value:e._value,rows:e.rows,className:"is-search",label:e.label,placeholder:e.placeholder,disabled:e.isReadOnly(),readOnly:e.isReadOnly(),onChange:t=>{if(e.annotation.isReadOnly())return;const{value:n}=t.target;e.setValue(n)},onFocus:o,ref:e.textareaRef,onKeyPress:e.countTime,onKeyDown:e.countTime,onKeyUp:e.countTime,onMouseDown:e.countTime,onMouseUp:e.countTime,onMouseMove:t=>(t.button||t.buttons)&&e.countTime()};n>1&&(i.onKeyDown=t=>{"Enter"===t.key&&t.shiftKey&&e.allowsubmit&&e._value&&!e.annotation.isReadOnly()?(t.preventDefault(),t.stopPropagation(),e.addText(e._value),e.setValue("")):e.countTime()});const s=e.perRegionVisible()?{}:{display:"none"},r=!e.isReadOnly()&&(null!=(t=e.showsubmitbutton)?t:1!==n),a={},l=(0,Qe.cn)("text-area").toClassName();return r&&(a.marginBottom=0),s.marginTop="4px",e.displaymode===mt.TAG?(0,A.jsxs)("div",{className:l,style:s,ref:e.elementRef,children:[L.renderChildren(e,e.annotation),e.showSubmit&&(0,A.jsx)(Yd.A,{onFinish:()=>(e.allowsubmit&&e._value&&!e.annotation.isReadOnly()&&(e.addText(e._value),e.setValue("")),!1),children:(0,A.jsxs)(Yd.A.Item,{style:a,children:[1===n?(0,A.jsx)(Xd.A,Object.assign({},i,{"aria-label":"TextArea Input"})):(0,A.jsx)(Sc,Object.assign({},i,{"aria-label":"TextArea Input"})),r&&(0,A.jsx)(Yd.A.Item,{children:(0,A.jsx)(Ud.default,{style:{marginTop:"10px"},type:"primary",htmlType:"submit",children:"Add"})})]})}),e.regions.length>0&&(0,A.jsx)("div",{style:{marginBottom:"1em"},children:e.regions.map((e=>(0,A.jsx)(pc,{item:e,onFocus:o},e.id)))})]}):null}));b.addTag("textarea",Cc,jc);const Rc=u.gK.model({visiblewhen:u.gK.maybeNull(u.gK.string),whentagname:u.gK.maybeNull(u.gK.string),whenchoicevalue:u.gK.maybeNull(u.gK.string),whenlabelvalue:u.gK.maybeNull(u.gK.string)}).views((e=>({get isVisible(){var t;if(!1===(null==(t=(0,u.PA)(e,2))?void 0:t.isVisible))return!1;if(e.visiblewhen){const t={"region-selected":({tagName:t,labelValue:n})=>{var o;const i=e.annotation.highlightedNode;return!(!i||t&&(null==(o=i.labeling)?void 0:o.from_name.name)!==t)&&(!n||n.split(",").some((e=>i.hasLabel(e))))},"choice-selected":({tagName:t,choiceValue:n})=>{if(!t){for(const t of e.annotation.names.values())if("choices"===t.type&&t.selectedValues&&t.selectedValues().length)return!0;return!1}const o=e.annotation.names.get(t);return!!(null!=o&&o.hasChoiceSelection||null!=n&&n.length)&&(!1!==o.isVisible&&o.hasChoiceSelection(null==n?void 0:n.split(","),o.selectedValues()))},"no-region-selected":()=>!e.annotation.highlightedNode,"choice-unselected":e=>!t["choice-selected"](e)};if(Object.keys(t).includes(e.visiblewhen)){return!1!==t[e.visiblewhen]({tagName:e.whentagname,choiceValue:e.whenchoicevalue,labelValue:e.whenlabelvalue})}}else if(e.whenchoicevalue){for(const t of e.annotation.names.values()){const n=null==t||null==t.selectedValues?void 0:t.selectedValues();if(null!=n&&n.length)for(const t of n)if(t===e.whenchoicevalue)return!0}return!1}return!0}}))),_c=Rc;var Tc=n(51129),Ac=n(84779);var Kc=n(94714),Ec=n(42197);const Pc=(e=!1)=>{const[t,n]=(0,m.useState)(e),[o,i,s]=(0,m.useMemo)((()=>[n.bind(null,!0),n.bind(null,!1),()=>n((e=>!e))]),[]);return[t,o,i,s]};var Mc=n(84392);const Dc=e=>{let t=0,n=e.length;for(;n--;){t++;const o=e[n].children;o&&(t+=Dc(o))}return t},Oc=(e,t)=>({label:"",depth:t,path:e,isOpen:!0});let Ic={};const Lc=({items:e,rowComponent:t,flatten:n,rowHeight:o,maxHeightPercentage:i,minWidth:s,maxWidth:r,transformationCallback:a,defaultExpanded:l,isEditable:d})=>{var c;const u=document.body.clientHeight,[h,g]=(0,m.useState)(),[p,f]=(0,m.useState)({}),[v,y]=(0,m.useState)(0),[b,x]=(0,m.useState)(s),S=(0,m.useRef)(),w=(0,m.useRef)(),k=null==(c=w.current)?void 0:c.firstChild;k&&(k.style.overflowX="hidden");const C=()=>{y((()=>{var e;S.current.resetAfterIndex(0);const t=null==(e=S.current)||null==(e=e._outerRef.firstChild)?void 0:e.offsetHeight,n=.01*i*u;return t>n?n:t})())},j=t=>{const n=l?{[t]:2!==p[t]?2:1}:{[t]:1!==p[t]?1:2};f(Object.assign({},p,n)),g(T({items:e,toggleItem:n})),y(.01*i*u),Ic={},S.current.resetAfterIndex(0)},R=t=>{d&&(g(T(t?{items:e,addInsideId:t}:{items:e})),C())},_=({data:e,index:t,rowStyle:n,rowComponent:i})=>{const s=e(t),a=(0,m.useCallback)((e=>{const n=`${t}`,i=(null==k?void 0:k.offsetWidth)-(null==k?void 0:k.clientWidth)||0,s=e.scrollWidth+i+5,a=e.scrollHeight;b<s?r<s?(Ic[n]=a,x(r)):(Ic[n]=o,x(s)):Ic[n]=o,C()}),[b]);return(0,A.jsx)(i,{isEditable:d,item:s,style:n,dimensionCallback:a,maxWidth:r})},T=({items:e,depth:t,toggleItem:o,addInsideId:i})=>{const s=[];for(let r=0;r<e.length;r++){const{children:d,label:c}=e[r],u=t||0,h=`${c}-${u}`,g=i===h,m=o&&o[h]||p[h]||g||(l?1:2),v=a({node:e[r],nestingLevel:u,isFiltering:n,isLeaf:!d,childCount:d&&Dc(d),isOpen:1===m});g&&f(Object.assign({},p,{[h]:1})),d&&1===m||g||n?(s.push(Object.assign({},v)),g&&s.push(...T({items:[Oc(e[r].path,u+1)],depth:u+1})),d&&s.push(...T({items:d,depth:u+1,toggleItem:o,addInsideId:i}))):s.push(Object.assign({},v))}return s};return(0,m.useEffect)((()=>{g(T({items:e}))}),[e]),(0,m.useEffect)((()=>{0===(null==h?void 0:h.length)&&C()}),[h]),(0,A.jsx)("div",{ref:w,children:(0,A.jsx)(Mc._m,{ref:S,height:v+4,itemCount:(null==h?void 0:h.length)||0,itemSize:e=>Ic[`${e}`]||o,width:b,itemData:e=>({row:h&&h[e],toggle:j,addInside:R}),children:({data:e,index:n,style:o})=>(0,A.jsx)(_,{data:e,rowStyle:o,index:n,rowComponent:t})})})},Nc={taxonomy:"taxonomy--sbNxo",taxonomy_open:"taxonomy_open--InD7j",taxonomy__selected:"taxonomy__selected--VOtIN",taxonomy__dropdown:"taxonomy__dropdown--Qi8yg",taxonomy__search:"taxonomy__search--qkTHD",taxonomy__item:"taxonomy__item--I4JB1",taxonomy__measure:"taxonomy__measure--ialoK",taxonomy__item_user:"taxonomy__item_user--JBwBu",taxonomy__item_session:"taxonomy__item_session--jWm5B",taxonomy__grouping:"taxonomy__grouping--iZK7b",taxonomy__extra:"taxonomy__extra--GgvBt",taxonomy__extra_actions:"taxonomy__extra_actions--tQuLD",taxonomy__extra_count:"taxonomy__extra_count--MtR7B",taxonomy__action:"taxonomy__action--rpruy",taxonomy__add__container:"taxonomy__add__container--rbs2W",taxonomy__add:"taxonomy__add--dOQt_",taxonomy__newitem:"taxonomy__newitem--amueo",taxonomy__collapsable:"taxonomy__collapsable--hc4oZ"},zc=["title","wrapper","children"],Vc=m.createContext([[],()=>{}]),Hc=m.createContext({}),Bc=({onAddLabel:e,onFinish:t,path:n})=>{const o=(0,m.useRef)(null),i=i=>{if(!o.current)return;const s=o.current.value,r="key"in i&&"Escape"===i.key,a="key"in i&&"Enter"===i.key,l="blur"===i.type;r&&i.stopPropagation(),a&&!s||((l||a)&&s&&e([...n,s]),(l||a||r)&&(o.current.value="",null==t||t()))};return(0,m.useEffect)((()=>{var e;return null==(e=o.current)?void 0:e.focus()}),[]),(0,A.jsx)("div",{className:Nc.taxonomy__newitem,children:(0,A.jsx)("input",{name:"taxonomy__add",onKeyDownCapture:i,onBlur:i,ref:o})})},Fc=({isEditable:e,flatItems:t})=>{const[n,o]=(0,m.useContext)(Vc),{showFullPath:i,pathSeparator:s=" / "}=(0,m.useContext)(Hc),r=n.map((e=>e.map((e=>{var n;const o=null==(n=t.find((t=>t.path[t.path.length-1]===e)))?void 0:n.label;return null!=o?o:e}))));return(0,A.jsx)("div",{className:["htx-taxonomy-selected",Nc.taxonomy__selected].join(" "),children:r.map(((t,r)=>(0,A.jsxs)("div",{children:[(0,A.jsx)("span",{children:i?t.join(s):t[t.length-1]}),e?(0,A.jsx)("input",{type:"button",onClick:()=>o(n[r],!1),value:""}):null]},t.join("|"))))})};const Wc=e=>{let{title:t,wrapper:n,children:o}=e,i=(0,Zn.A)(e,zc);const s=n?(0,A.jsx)(n,{children:o}):o;return t?(0,A.jsx)(Qn.m_M,Object.assign({title:t},i,{children:s})):s},$c=({style:e,item:t,dimensionCallback:n,maxWidth:o,isEditable:i})=>{var s;const{row:{id:r,isOpen:a,childCount:l,isFiltering:d,name:c,path:u,padding:h,isLeaf:g,hint:p},toggle:f,addInside:v}=t,[y,b]=(0,m.useContext)(Vc),{leafsOnly:S,maxUsages:w,maxUsagesReached:k,onAddLabel:C,onDeleteLabel:j}=(0,m.useContext)(Hc),R=y.some((e=>(0,x.isArraysEqual)(e,u))),_=y.some((e=>function(e,t){return!(e.length<=t.length)&&t.every(((t,n)=>e[n]===t))}(e,u))),T=S&&!g,K=k&&!R,E=T||K||!i,P=g?{display:"none"}:{transform:a?"rotate(180deg)":"rotate(90deg)"},M=T?"Only leaf nodes allowed":K?`Maximum ${w} items already selected`:void 0,D=(0,m.useCallback)((e=>{e&&(e.indeterminate=!R&&_)}),[R,_]),O=(0,m.useCallback)((()=>{null==j||j(u),v()}),[t,j]),I="session"===t.row.origin?Nc.taxonomy__item_session:"user"===t.row.origin?Nc.taxonomy__item_user:"",L=""===c&&C,N=(0,m.useRef)();null==(s=N.current)||s.parentElement.offsetWidth;return(0,m.useEffect)((()=>{const e=null==N?void 0:N.current;e&&(e.toggle=f,n(e))}),[]),(0,A.jsx)("div",{ref:N,style:Object.assign({paddingLeft:h,maxWidth:o},e,{width:"fit-content"}),children:L?(0,A.jsx)(Bc,{onAddLabel:C,onFinish:()=>v(),path:u},""):(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)("div",{className:Nc.taxonomy__measure,children:[(0,A.jsx)("label",{children:c}),!d&&(0,A.jsx)("div",{className:Nc.taxonomy__extra,children:(0,A.jsx)("span",{className:Nc.taxonomy__extra_count,children:l})})]}),(0,A.jsx)(Wc,{title:p,children:(0,A.jsxs)("div",{className:[Nc.taxonomy__item,I].join(" "),children:[(0,A.jsx)("div",{className:Nc.taxonomy__grouping,onClick:()=>f(r),children:(0,A.jsx)(To.Vh6,{stroke:"#09f",style:P})}),(0,A.jsx)("input",{className:"item",id:r,name:r,type:"checkbox",disabled:E,checked:R,ref:D,onChange:e=>{i&&b(u,e.currentTarget.checked)}}),(0,A.jsx)("label",{htmlFor:r,onClick:i?()=>T&&f(r):void 0,title:M,className:E?Nc.taxonomy__collapsable:void 0,children:c}),!d&&(0,A.jsxs)("div",{className:Nc.taxonomy__extra,children:[(0,A.jsx)("span",{className:Nc.taxonomy__extra_count,children:l}),i&&C&&(0,A.jsx)("div",{className:Nc.taxonomy__extra_actions,children:(0,A.jsx)(Kc.A,{destroyPopupOnHide:!0,trigger:["click"],overlay:(0,A.jsxs)(Ec.A,{children:[(0,A.jsx)(Ec.A.Item,{className:Nc.taxonomy__action,onClick:()=>{v(r)},children:"Add Inside"},"add-inside"),"session"===t.row.origin&&(0,A.jsx)(Ec.A.Item,{className:Nc.taxonomy__action,onClick:O,children:"Delete"},"delete")]}),children:(0,A.jsx)("div",{children:"..."})})})]})]})})]})})},Uc=({show:e,flatten:t,items:n,dropdownRef:o,isEditable:i})=>{const s=(0,m.useRef)(null),[r,a]=(0,m.useState)(""),{onAddLabel:l,minWidth:d,maxWidth:c}=(0,m.useContext)(Hc),[u,h,g]=Pc(!1),p=r?((e,t)=>{const n=[],o=[];let i=-1;for(let r=e.length;r--;){const a=e[r];if(a.depth!==i){if(t(a)){const e=Object.assign({},a,{children:[]});0===a.depth?n.unshift(e):(i=a.depth-1,o[i]||(o[i]=[]),o[i].unshift(e))}}else{var s;const e=Object.assign({},a,{children:null!=(s=o[i])?s:[]});o[i]=[],i?(o[i-1]||(o[i-1]=[]),o[i-1].unshift(e)):n.unshift(e),i--}}return n})(t,(e=>e.label.toLocaleLowerCase().includes(r))):n;(0,m.useEffect)((()=>{const t=s.current;e&&t&&(t.value="",t.focus(),a(""))}),[e]);return(0,A.jsxs)("div",{className:Nc.taxonomy__dropdown,ref:o,style:{display:e?"block":"none"},children:[(0,A.jsx)("input",{autoComplete:"off",className:Nc.taxonomy__search,name:"taxonomy__search",placeholder:"Search...",onInput:e=>a(e.currentTarget.value.toLocaleLowerCase()),ref:s}),(0,A.jsx)(Lc,{items:p,isEditable:i,rowComponent:$c,flatten:""!==r,rowHeight:30,defaultExpanded:!1,maxHeightPercentage:50,minWidth:Number(d)||200,maxWidth:Number(c)||600,transformationCallback:({node:{children:e,depth:t,label:n,origin:o,path:i,hint:s},nestingLevel:r,isFiltering:a,isOpen:l,childCount:d})=>({childCount:d,id:`${n}-${t}`,isFiltering:a,isLeaf:!(null!=e&&e.length),isOpen:l,isOpenByDefault:!0,name:n,nestingLevel:r,origin:o,padding:10*r+10,path:i,hint:s})}),l&&""===r&&(0,A.jsx)("div",{className:Nc.taxonomy__add__container,children:u?(0,A.jsx)(Bc,{path:[],onAddLabel:l,onFinish:g}):i?(0,A.jsx)("div",{className:Nc.taxonomy__add,children:(0,A.jsx)("button",{type:"button",onClick:h,children:"Add"})}):null})]})},Yc=({items:e,selected:t,onChange:n,onAddLabel:o,onDeleteLabel:i,options:s={},isEditable:r=!0})=>{const a=(0,m.useRef)(null),l=(0,m.useRef)(null),[d,c]=(0,m.useState)(!1),u=(0,m.useCallback)((()=>c(!1)),[]),h=(0,m.useCallback)((e=>{var t;const n=Nc.taxonomy__action;[e.target,e.target.parentNode].some((e=>{var t;return null==e||null==(t=e.classList)?void 0:t.contains(n)}))||null!=(t=l.current)&&t.contains(e.target)||u()}),[]),g=d?Nc.taxonomy_open:"",p=(0,m.useMemo)((()=>{const t=[],n=e=>{var o;t.push(e),null==(o=e.children)||o.forEach(n)};return e.forEach(n),t}),[e]),[f,v]=(0,m.useState)(t),y=(0,m.useMemo)((()=>[f,(e,t)=>{const o=t?[...f,e]:f.filter((t=>!(0,x.isArraysEqual)(t,e)));(!1!==s.canRemoveItems||o.length)&&(v(o),n&&n(null,o))}]),[f]),b=(0,m.useMemo)((()=>{const e=!!s.maxUsages&&f.length>=s.maxUsages;return Object.assign({},s,{maxUsagesReached:e,onAddLabel:o,onDeleteLabel:i})}),[s,s.maxUsages,s.maxUsages?f:0]),S=(0,m.useCallback)((e=>{var t,n,o;const i=null==(t=l.current)?void 0:t.querySelectorAll(".item"),s=null==(n=l.current)?void 0:n.querySelector("input"),r=document.activeElement||void 0,a=i&&i.length>0,d=i&&r?Array.from(i).findIndex((e=>e.id===r.id)):-1,h=(e,t)=>a&&i[e+t].focus(),g=e=>{["text","checkbox"].includes(e.target.type)&&e.preventDefault()};switch(e.key){case"Escape":u(),e.stopPropagation();break;case"ArrowDown":g(e),e.shiftKey&&(c(!0),s&&s.focus()),d>=0&&h(d,1),s===r&&h(0,0);break;case"ArrowUp":g(e),d>0?h(d,-1):0===d&&s&&s.focus();break;case"ArrowRight":d>=0&&(null==(o=r.parentNode)||null==(o=o.parentNode)||o.toggle(r.id)),s&&s.focus()}}),[]);return(0,m.useEffect)((()=>{v(t)}),[t]),(0,m.useEffect)((()=>(document.body.addEventListener("click",h,!0),document.body.addEventListener("keydown",S),()=>{document.body.removeEventListener("click",h),document.body.removeEventListener("keydown",S)})),[]),(0,A.jsx)(Vc.Provider,{value:y,children:(0,A.jsxs)(Hc.Provider,{value:b,children:[(0,A.jsx)(Fc,{isEditable:r,flatItems:p}),(0,A.jsxs)("div",{className:["htx-taxonomy",Nc.taxonomy,g].join(" "),ref:l,children:[(0,A.jsxs)("span",{onClick:()=>c((e=>!e)),children:[s.placeholder||"Click to add...",(0,A.jsx)(To.Vh6,{stroke:"#09f"})]}),(0,A.jsx)(Uc,{show:d,isEditable:r,items:e,flatten:p,dropdownRef:a})]})]})})},Xc=u.gK.model(Object.assign({},(0,j.VS)(j.cE)?{id:u.gK.identifier}:{},{selected:u.gK.optional(u.gK.boolean,!1),alias:u.gK.maybeNull(u.gK.string),value:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),style:u.gK.maybeNull(u.gK.string),html:u.gK.maybeNull(u.gK.string),color:u.gK.maybeNull(u.gK.string),hint:u.gK.maybeNull(u.gK.string)})),Gc=u.gK.model({type:"choice",visible:u.gK.optional(u.gK.boolean,!0),_value:u.gK.optional(u.gK.string,""),children:Le.unionArray(["choice"]),parentTypes:Le.tagsTypes(["Choices","Taxonomy"]),readonly:u.gK.optional(u.gK.boolean,!1)}).views((e=>({get isCheckbox(){var t;const n=null==(t=e.parent)?void 0:t.choice;return"multiple"===n||"single"===n},get isSelect(){var t;return"select"===(null==(t=e.parent)?void 0:t.layout)},canBeUsed:()=>!0,get isLeaf(){var t;return!e.nestedResults||!(null!=(t=e.children)&&t.length)},get sel(){return e.isLeaf?e._sel:e.children.every((e=>!0===e.sel))},get indeterminate(){return!e.isLeaf&&(!e.sel&&e.children.some((e=>!0===e.sel)))},get parentChoice(){return Le.getParentTagOfTypeString(e,"choice")},get isSkipped(){return!e.nestedResults&&!!e.parentChoice},get nestedResults(){var t;return!1!==(null==(t=e.parent)?void 0:t.allownested)},get _resultValue(){var t;return null!=(t=e.alias)?t:e._value},get resultValue(){if(e.nestedResults){const t=[];let n=e;for(;n;)t.unshift(n._resultValue),n=n.parentChoice;return t}return e._resultValue},isReadOnly(){var t;return e.readonly||(null==(t=e.parent)?void 0:t.isReadOnly())},get isIndependent(){return!0}}))).volatile((()=>({_sel:!1}))).actions((e=>({toggleSelected(){var t,n;if(null!=(t=e.parent)&&t.readonly||null!=(n=e.annotation)&&n.isReadOnly())return;const o=e.parent,i=e.sel;o.shouldBeUnselected&&(null==o.resetSelected||o.resetSelected()),e.setSelected(!i),null==o.updateResult||o.updateResult()},setVisible(t){e.visible=t},setSelected(t){e._sel=t,e.isLeaf||e.children.forEach((e=>{e.setSelected(t)}))}}))).actions((e=>{var t;return"choices"===(null==(t=e.parent)?void 0:t.type)?{onHotKey:()=>e.toggleSelected()}:{}})),Zc=u.gK.compose("ChoiceModel",Ed,Xc,Ue,Gc,Ne),qc=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{var n;let o={};e.style&&(o=L.cssConverter(e.style));const i=(t.settings.enableTooltips||t.settings.enableLabelTooltips)&&t.settings.enableHotkeys&&e.hotkey,s=(0,m.useCallback)((t=>{e.isReadOnly()||(e.toggleSelected(),t.nativeEvent.target.blur())}),[]),[r,a]=(0,m.useState)(!1),l=(0,m.useCallback)((()=>a((e=>!e))),[]);return(0,A.jsxs)(Qe.eB,{name:"choice",mod:{layout:e.parent.layout,leaf:e.isLeaf,notLeaf:!e.isLeaf,hidden:!e.visible},children:[(0,A.jsxs)(Qe.Sl,{name:"item",mod:{notLeaf:!e.isLeaf},style:o,children:[(0,A.jsx)(Qe.Sl,{name:"checkbox",component:(d=e.isCheckbox?Ac.A:Tc.Ay,c=e._value,e=>(0,A.jsx)(d,Object.assign({},e,{name:c}))),mod:{notLeaf:!e.isLeaf},checked:e.sel,indeterminate:!e.sel&&e.indeterminate,disabled:e.isReadOnly(),onChange:s,children:(0,A.jsxs)(Wc,{title:e.hint,wrapper:"span",children:[e.html?(0,A.jsx)("span",{dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(e.html)}}):e._value,i&&(0,A.jsxs)(eo,{children:["[",e.hotkey,"]"]})]})}),!e.isLeaf&&(0,A.jsx)(Qe.Sl,{name:"toggle",mod:{collapsed:r},component:Ud.default,type:"text",onClick:l,children:(0,A.jsx)(Qn.Vh6,{})})]}),e.nestedResults&&null!=(n=e.children)&&n.length?(0,A.jsx)(Qe.Sl,{name:"children",mod:{collapsed:r},children:L.renderChildren(e,e.annotation)}):null]});var d,c})));b.addTag("choice",Zc,qc);const Jc=u.gK.model().views((e=>({findSelectedChoice(t){var n,o;let i;return e.findLabel?i=e.findLabel(t):e.findItemByValueOrAlias&&(i=e.findItemByValueOrAlias(t)),(null==(n=i)?void 0:n.alias)||(null==(o=i)?void 0:o.value)},selectedChoicesMatch(t,n){const o=e.findSelectedChoice(t),i=e.findSelectedChoice(n);return(0,x.isDefined)(o)&&(0,x.isDefined)(i)&&o===i},hasChoiceSelectionSimple(t){if(null!=t&&t.length){const n=e.selectedValues().map((e=>Array.isArray(e)?e.at(-1):e));return t.some((e=>n.includes(e)))}return e.isSelected},hasChoiceSelection(t,n=[]){if(null!=t&&t.length){if(e.findLabel&&"taxonomy"!==e.type)return t.map((t=>e.findLabel(t))).some((e=>e&&e.sel));if(n.length){const o=t=>{if(e.findItemByValueOrAlias){const n=e.findItemByValueOrAlias(t);t=(null==n?void 0:n.alias)||(null==n?void 0:n.value)||t}return n.map((e=>Array.isArray(e)?e.at(-1):e)).includes(t)};return t.some(o)}return!1}return e.isSelected}}))),Qc=u.gK.model({toname:u.gK.maybeNull(u.gK.string),showinline:u.gK.maybeNull(u.gK.boolean),choice:u.gK.optional(u.gK.enumeration(["single","single-radio","multiple"]),"single"),layout:u.gK.optional(u.gK.enumeration(["select","inline","vertical"]),"vertical"),value:u.gK.optional(u.gK.string,""),allownested:u.gK.optional(u.gK.boolean,!1)}),eu=u.gK.model({pid:u.gK.optional(u.gK.string,T),visible:u.gK.optional(u.gK.boolean,!0),type:"choices",children:Le.unionArray(["choice","view","header","hypertext"])}).views((e=>({get shouldBeUnselected(){return"single"===e.choice||"single-radio"===e.choice},states:()=>e.annotation.toNames.get(e.name),get serializableValue(){const t=e.selectedValues();return t&&t.length?{choices:t}:null},get preselectedValues(){return e.tiedChildren.filter((e=>!0===e.selected&&!e.isSkipped)).map((e=>e.resultValue))},get selectedLabels(){return e.tiedChildren.filter((e=>!0===e.sel&&!e.isSkipped))},selectedValues:()=>e.selectedLabels.map((e=>e.resultValue)),get defaultChildType(){return"choice"}}))).actions((e=>({afterCreate(){!0===e.showinline&&(e.layout="inline"),!1===e.showinline&&(e.layout="vertical")},needsUpdate(){e.result?e.setResult(e.result.mainValue):e.setResult([])},requiredModal(){yn.warning(e.requiredmessage||`Checkbox "${e.name}" is required.`)},unselectAll(){},updateFromResult(t){e.setResult(Array.isArray(t)?t:[t])},resetSelected(){e.selectedLabels.forEach((e=>e.setSelected(!1)))},setResult(t){e.tiedChildren.forEach((e=>{let n=!1;e.isSkipped||(n=null==t||null==t.some?void 0:t.some((t=>Array.isArray(t)&&Array.isArray(e.resultValue)?t.length===e.resultValue.length&&(null==t.every?void 0:t.every(((t,n)=>{var o;return t===(null==(o=e.resultValue)?void 0:o[n])}))):t===e.resultValue))),e.setSelected(n)}))}}))).actions((e=>{const t={validate:e.validate};return{validate(){if(!t.validate()||"multiple"!==e.choice&&e.checkResultLength()>1)return!1},checkResultLength:()=>e.children.filter((e=>e._sel)).length,beforeSend(){"multiple"!==e.choice&&e.checkResultLength()>1&&yn.warning(`The number of options selected (${e.checkResultLength()}) exceed the maximum allowed (1). To proceed, first unselect excess options for:\r\n  Choices (${e.name})`)}}})),tu=u.gK.compose("ChoicesModel",Td,fc,Cd.props({_child:"ChoiceModel"}),tc,pt,...(0,j.VS)(j.gF)?[Qd]:[],qe,Jc,_c,Rd,Ne,Qc,eu),nu=(0,v.PA)((({item:e})=>{const t=(0,m.useMemo)((()=>e.tiedChildren.map((e=>({value:e._value,label:(0,A.jsx)(Qn.m_M,{title:e.hint,children:(0,A.jsx)("span",{"data-testid":"choiceOptionText",className:"w-full",children:e._value})})})))),[e.tiedChildren]);return(0,A.jsx)(Qn.l6P,{style:{width:"100%"},value:e.selectedLabels.map((e=>e._value)),multiple:"multiple"===e.choice,disabled:e.isReadOnly(),onChange:t=>{if(Array.isArray(t))e.resetSelected(),t.forEach((t=>e.findLabel(t).setSelected(!0))),e.updateResult();else{const n=e.findLabel(t);n&&n.toggleSelected()}},options:t})})),ou=(0,v.PA)((({item:e})=>(0,A.jsx)(Qe.eB,{name:"choices",mod:{hidden:!e.isVisible||!e.perRegionVisible(),layout:e.layout},ref:e.elementRef,children:"select"===e.layout?(0,A.jsx)(nu,{item:e}):L.renderChildren(e,e.annotation)})));b.addTag("choices",tu,ou);var iu=n(55454),su=n(99811);const ru=u.gK.model({toname:u.gK.maybeNull(u.gK.string),maxrating:u.gK.optional(u.gK.string,"5"),icon:u.gK.optional(u.gK.string,"star"),size:u.gK.optional(u.gK.string,"medium"),defaultvalue:u.gK.optional(u.gK.string,"0"),hotkey:u.gK.maybeNull(u.gK.string)}),au=u.gK.model({pid:u.gK.optional(u.gK.string,T),type:"rating",rating:u.gK.maybeNull(u.gK.number)}).views((e=>({selectedValues:()=>e.rating,get serializableValue(){const t=e.selectedValues();return t?{rating:t}:null},get holdsState(){return e.rating>0}}))).actions((e=>({getSelectedString:()=>`${e.rating} star`,needsUpdate(){e.result?e.rating=e.result.mainValue:e.rating=null},unselectAll(){},setRating(t){e.rating=t,e.updateResult()},updateFromResult(t){e.rating=t},requiredModal(){yn.warning(e.requiredmessage||`Rating "${e.name}" is required.`)},increaseValue(){e.rating>=Number(e.maxrating)?e.setRating(0):e.rating>0?e.setRating(e.rating+1):e.setRating(1)},onHotKey:()=>e.increaseValue()}))),lu=u.gK.compose("RatingModel",Td,fc,tc,qe,pt,...(0,j.VS)(j.gF)?[Qd]:[],Ne,ru,au),du=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{let n;"small"===e.size?n=15:"medium"===e.size?n=25:"large"===e.size&&(n=40);const o=e.perRegionVisible()?{}:{display:"none"};return(0,A.jsxs)("div",{style:o,onKeyDownCapture:e=>{if(e.ctrlKey||e.metaKey||e.altKey||e.shiftKey){const t=document.activeElement;e.currentTarget.contains(t)&&t.blur()}},ref:e.elementRef,children:[(0,A.jsx)(iu.A,{character:(0,A.jsx)(su.A,{style:{fontSize:n}}),value:e.rating,count:Number(e.maxrating),defaultValue:Number(e.defaultvalue),onChange:e.setRating,disabled:e.isReadOnly()}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,A.jsxs)("sup",{style:{fontSize:"9px"},children:["[",e.hotkey,"]"]})]})})));b.addTag("rating",lu,du);const cu=u.gK.model("ParagraphsRegionModel",{type:"textrange",object:u.gK.late((()=>u.gK.reference(yu))),startOffset:u.gK.integer,start:u.gK.string,endOffset:u.gK.integer,end:u.gK.string,states:u.gK.maybeNull(u.gK.array(u.gK.union(Wd,Cc,tu,lu)))}).volatile((()=>({text:"",hideable:!0}))).views((e=>({get parent(){return(0,u._n)(e)?e.object:null},getRegionElement(){var t;return null==(t=e._spans)?void 0:t[0]}}))).actions((e=>({beforeDestroy(){sn.HTML.removeSpans(e._spans)},setText(t){e.text=t},fixOffsets(t,n){e.startOffset=t,e.endOffset=n},serialize(){const{start:t,end:n}=e,o={value:{start:t,end:n,startOffset:e.startOffset,endOffset:e.endOffset}};return"yes"===e.object.savetextresult&&(o.value.text=e.text),o}}))),uu=u.gK.compose("ParagraphsRegionModel",ut,yt,Ze,cu,wd);b.addRegionType(uu,"paragraphs");const hu={phrase:"phrase--qv9_O",numbered:"numbered--a9bkk",name:"name--PZvdb",text:"text--Ou0FP",dialoguename:"dialoguename--Z1bwn",dialoguetext:"dialoguetext--fQTLz",scroll_container:"scroll_container--zjNwB",wrapper_header:"wrapper_header--EZcmN",wrapper_header__buttons:"wrapper_header__buttons--V_YdW",container:"container--mYuCT",withAudio:"withAudio--toh21",collapsed:"collapsed--JuuM7",authorFilter:"authorFilter--koQOu",authorFilter__showall:"authorFilter__showall--iRWAc",authorFilter__placeholder:"authorFilter__placeholder--OnkZm",authorFilter__search:"authorFilter__search--CKZQK",authorFilter__search__input:"authorFilter__search__input--Z6sUA",authorFilter__select:"authorFilter__select--_OLb1",authorFilter__select__item:"authorFilter__select__item--q_yG2",audio:"audio--Fq_ZD",playNewUi:"playNewUi--oUID4",play:"play--q_72j",newUI:"newUI--hohwV",titleWrapper:"titleWrapper--guGg3",time:"time--JzGDH",wrapperText:"wrapperText--Rj0j9",readingLine:"readingLine--UoCCW"},gu=u.gK.model("ParagraphsModel",{value:u.gK.maybeNull(u.gK.string),valuetype:u.gK.optional(u.gK.enumeration(["json","url"]),(()=>window.LS_SECURE_MODE?"url":"json")),audiourl:u.gK.maybeNull(u.gK.string),showplayer:!1,highlightcolor:u.gK.maybeNull(u.gK.string),showlabels:u.gK.optional(u.gK.boolean,!1),layout:u.gK.optional(u.gK.enumeration(["none","dialogue"]),"none"),savetextresult:u.gK.optional(u.gK.enumeration(["none","no","yes"]),(()=>window.LS_SECURE_MODE?"no":"yes")),namekey:u.gK.optional(u.gK.string,"author"),textkey:u.gK.optional(u.gK.string,"text"),contextscroll:u.gK.optional(u.gK.boolean,!1)}),mu=u.gK.model("ParagraphsModel",{type:"paragraphs",_update:u.gK.optional(u.gK.number,1)}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},get store(){return(0,u.Zn)(e)},get audio(){if(!e.audiourl)return null;if("$"===e.audiourl[0]){const t=(0,u.Zn)(e),n=e.audiourl.substr(1);return t.task.dataObj[n]}return e.audiourl},layoutStyles(t){if("dialogue"===e.layout){const n=t[e.namekey],o=Sd().make_color({seed:n})[0];return(0,j.VS)(j.LG)?{phrase:{"--highlight-color":o,"--background-color":"#FFF"},name:{color:o},inactive:{phrase:{"--highlight-color":sn.Colors.convertToRGBA(o,.4),"--background-color":"#FAFAFA"},name:{color:sn.Colors.convertToRGBA(o,.9)}}}:{phrase:{backgroundColor:sn.Colors.convertToRGBA(o,.25)}}}return{}},get layoutClasses(){return"dialogue"===e.layout?{phrase:hu.phrase,name:hu.dialoguename,text:hu.dialoguetext}:{phrase:hu.phrase,name:hu.name,text:hu.text}},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t&&t.filter((e=>e.isSelected&&"paragraphlabels"===e._type))},isVisibleForAuthorFilter:t=>!(0,j.VS)(j.fw)||(!e.filterByAuthor.length||e.filterByAuthor.includes(t[e.namekey]))}))),pu=u.gK.model().volatile((()=>({_value:null,filterByAuthor:[],searchAuthor:"",playingId:-1,playing:!1,audioRef:(0,m.createRef)(),audioDuration:null,audioFrameHandler:null}))).views((e=>({regionIndicesByTime(t){var n;const o=[];return null==(n=e._value)||n.forEach((({start:e,duration:n,end:i},s)=>void 0!==e&&(!(e>t)&&void((void 0===n&&void 0===i||(null!=i?i:e+n)>t)&&o.push(s))))),o},get regionsStartEnd(){var t;return e.audioDuration?null==(t=e._value)?void 0:t.map((t=>{var n,o;if(void 0===t.start)return{};const i=(0,x.clamp)(null!=(n=t.start)?n:0,0,e.audioDuration),s=t.duration?i+t.duration:null!=(o=t.end)?o:e.audioDuration;return{start:i,end:(0,x.clamp)(s,i,e.audioDuration)}})):[]},get regionsValues(){return Object.values(e.regionsStartEnd)}}))).actions((e=>({triggerSync(t,n){const o=e.audioRef.current;o&&e.syncSend(Object.assign({playing:!o.paused,time:o.currentTime},n),t)},registerSyncHandlers(){e.syncHandlers.set("pause",e.stopNow),e.syncHandlers.set("play",e.handleSyncPlay),e.syncHandlers.set("seek",e.handleSyncPlay),e.syncHandlers.set("speed",e.handleSyncSpeed)},handleSyncPlay({time:t,playing:n}){const o=e.audioRef.current;o&&(o.currentTime=t,o.paused&&n?e.play():e.trackPlayingId())},handleSyncSpeed({speed:t}){const n=e.audioRef.current;n&&(n.playbackRate=t)},syncMuted(t){const n=e.audioRef.current;n&&(n.muted=t)}}))).actions((e=>({handleAudioLoaded(t){const n=t.target;e.audioDuration=n.duration},reset(){e.playingId=-1,e.audioFrameHandler&&(cancelAnimationFrame(e.audioFrameHandler),e.audioFrameHandler=null)},stopNow(){const t=e.audioRef.current;t&&(t.paused||(t.pause(),e.playing=!1,e.triggerSync("pause")))},stopAtTheEnd(){var t;const n=e.audioRef.current;if(!n)return;if(n.paused)return;const{end:o}=null!=(t=e.regionsStartEnd[e.playingId])?t:{};n.currentTime<o?e.audioFrameHandler=requestAnimationFrame(e.stopAtTheEnd):(e.stopNow(),e.reset())},trackPlayingId(){e.audioFrameHandler&&cancelAnimationFrame(e.audioFrameHandler);const t=e.audioRef.current,n=null==t?void 0:t.currentTime,o=null==t?void 0:t.duration;if(!(0,x.isDefined)(n)||!(0,x.isDefined)(o)||n>=o)return void e.reset();const i=e.regionsValues;e.playingId=i.findIndex((({start:e,end:t})=>n>=e&&n<t)),t.paused||(e.audioFrameHandler=requestAnimationFrame(e.trackPlayingId))},playAny(){var t;const n=null==(t=e.audioRef)?void 0:t.current;if(!(0,x.isDefined)(n))return;n.paused&&(n.play(),e.triggerSync("play")),e.playing=!0,e.trackPlayingId()},play(t){var n,o;if(!(0,x.isDefined)(t))return void e.playAny();const{start:i,end:s}=null!=(n=e.regionsStartEnd[t])?n:{},r=null==(o=e.audioRef)?void 0:o.current;if(!(0,x.isDefined)(r)||!(0,x.isDefined)(i)||!(0,x.isDefined)(s))return;const a=!r.paused,l=e.playingId;a&&l===t?e.stopNow():(t!==l&&(r.currentTime=i),r.play(),e.playing=!0,e.playingId=t,e.triggerSync("play"),e.trackPlayingId())}}))).actions((e=>({setAuthorSearch(t){e.searchAuthor=t},setAuthorFilter(t){e.filterByAuthor=t}}))),fu=u.gK.model().actions((e=>({needsUpdate(){e._update=e._update+1},updateValue(t){const n=k(e.value,t.task.dataObj);if("url"===e.valuetype){const o=n;if(!(0,x.isValidObjectURL)(o,!0)){const i=[];return o?(i.push(`URL (${o}) is not valid.`),i.push('You should not put data directly into your task if you use valuetype="url".')):i.push(`URL is empty, check ${n} in data JSON.`),window.LS_SECURE_MODE&&i.unshift('In SECURE MODE valuetype set to "url" by default.'),t.annotationStore.addErrors([mr.generalError(i.join("\n"))]),void e.setRemoteValue("")}fetch(o).then((e=>{if(!e.ok)throw new Error(`${e.status} ${e.statusText}`);return e.json()})).then(e.setRemoteValue).catch((n=>{const i=et.A.ERR_LOADING_HTTP({attr:e.value,error:String(n),url:o});t.annotationStore.addErrors([mr.generalError(i)]),e.setRemoteValue("")}))}else e.setRemoteValue(n)},setRemoteValue(t){const n=[];if(Array.isArray(t)?(e.namekey in t[0]||n.push(`"${e.namekey}" field not found in task data; check your <b>nameKey</b> parameter`),e.textkey in t[0]||n.push(`"${e.textkey}" field not found in task data; check your <b>textKey</b> parameter`)):n.push("Provided data is not an array"),n.length){const t=[`Task data (provided as <b>${e.value}</b>) has wrong format.<br/>`,"It should be an array of objects with fields,",'defined by <b>nameKey</b> ("author" by default)','and <b>textKey</b> ("text" by default)'].join(" ");return void e.store.annotationStore.addErrors([mr.generalError(`${t}<ul>${n.map((e=>`<li>${e}</li>`)).join("")}</ul>`)])}const o=(0,j.VS)(j.LG)&&e.contextscroll?t.sort(((e,t)=>{if(!e.start)return 1;if(!t.start)return-1;const n=e.end?e.end:e.start+e.duration||0,o=t.end?t.end:t.start+t.duration||0;return e.start===t.start?n-o:e.start-t.start})):t;e._value=o,e.needsUpdate()},createRegion(t){const n=uu.create(Object.assign({pid:t.id},t));return n._range=t._range,e.regions.push(n),e.annotation.addRegion(n),n},addRegions(t){const n=[],o=e.getAvailableStates();if(0===o.length)return;const i=o[0],s={[i.valueType]:i.selectedValues()};for(const o of t){const t=e.annotation.createResult(o,s,i,e);t.setText(o.text),t.notifyDrawingFinished(),t._range=o._range,n.push(t)}return n},addRegion(t){if((0,j.VS)(j.Gd))return e.addRegions([t])[0];const n=e.getAvailableStates();if(0===n.length)return;const o=n[0],i={[o.valueType]:o.selectedValues()},s=e.annotation.createResult(t,i,o,e);return s.setText(t.text),s.notifyDrawingFinished(),s._range=t._range,s}}))),vu=[ut,gu,Ge,Sn,Ne,mu,pu,fu].filter(Boolean),yu=u.gK.compose("ParagraphsModel",...vu),bu=({name:e,selected:t})=>{const n={border:`2px solid ${sn.Colors.convertToRGBA(Sd().make_color({seed:e})[0])}`};return"all"===e?(0,A.jsx)(A.Fragment,{children:"Show all authors"}):(0,A.jsx)("span",{className:[hu.authorFilter__select__item,t&&hu.authorFilter__select__item_selected].join(" "),style:n,children:e})},xu=(0,v.PA)((({item:e,onChange:t})=>{const n=(0,m.useMemo)((()=>(0,A.jsx)("span",{className:hu.authorFilter__placeholder,children:"Show all authors"})),[]),o="all",i=(0,m.useMemo)((()=>{const t=e._value.reduce(((t,n)=>t.includes(n[e.namekey])?t:[...t,n[e.namekey]]),[]).sort().map((e=>({value:e,label:(0,A.jsx)(bu,{name:e})})));return[{value:o,label:(0,A.jsx)(bu,{name:o}),children:t}]}),[e._value,e.namekey,o]),s=(0,m.useCallback)((n=>{var o;const i=null!=(o=null==n?void 0:n.value)?o:n;!i||null!=i&&i.includes("all")?e.setAuthorFilter([]):i&&e.setAuthorFilter(i),null==t||t()}),[e.setAuthorFilter]);return(0,A.jsx)("div",{className:hu.authorFilter,children:(0,A.jsx)(Qn.l6P,{placeholder:n,options:i,onChange:s,size:"compact",multiple:!0,searchable:!0})})})),Su=e=>{if(isNaN(e))return"";const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.round(e%60);return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")}`},wu=(0,v.PA)((({item:e,playingId:t,activeRef:n,setIsInViewport:o})=>{const[i,s]=(0,m.useState)(null),[r,a]=(0,m.useState)(0),[l,d]=(0,m.useState)(null),c=e.layoutClasses,h=!!e.audio;let g;const p=(0,m.useCallback)(((t,n,o,i=!0)=>{if(!t||!(0,j.VS)(j.LG)||!e.contextscroll)return;const r=t.animate([{top:`${n}%`},{top:"100%"}],{easing:"linear",duration:1e3*o});i?r.play():r.pause(),s(r)}),[i,s]),f=(0,m.useCallback)((o=>{var i,s,a,l,c,u,h,g;if(!(0,j.VS)(j.LG)||!e.contextscroll)return;const m=(null==(i=e._value[t])?void 0:i.duration)||(null==(s=e._value[t])?void 0:s.end)-(null==(a=e._value[t])?void 0:a.start),f=(null!=(l=e._value[t])&&l.end?null==(h=e._value[t])?void 0:h.end:(null==(c=e._value[t])?void 0:c.start)+(null==(u=e._value[t])?void 0:u.duration))-r.time,v=100-100*f/m;v>0&&v<100?p(null==(g=n.current)?void 0:g.querySelector(".reading-line"),v,f,r.playing):d(o)}),[r,t]),v=(0,m.useCallback)((n=>{if(g&&g.disconnect(),null!==n){var i,s,r;const a=(null==(i=e._value[t])?void 0:i.duration)||(null==(s=e._value[t])?void 0:s.end)-(null==(r=e._value[t])?void 0:r.start);isNaN(a)||p(n,0,a,e.playing),g=new IntersectionObserver((e=>{o(e[0].isIntersecting)}),{rootMargin:"0px"}),g.observe(n)}}),[t]);if((0,m.useEffect)((()=>{var t;if((0,j.VS)(j.LG)&&e.contextscroll)return null==(t=e.syncHandlers)||t.set("seek",(t=>{e.handleSyncPlay(t),a(t),o(!0)})),()=>{var e;null==(e=g)||e.disconnect()}}),[]),(0,m.useEffect)((()=>{f(!0)}),[r]),(0,m.useEffect)((()=>{l&&f(!1)}),[t]),(0,m.useEffect)((()=>{(0,j.VS)(j.LG)&&e.contextscroll&&(e.playing?null==i||i.play():null==i||i.pause())}),[e.playing]),!e._value)return null;return e._value.map(((i,s)=>{const r=t===s,a=r&&e.playing,l=(0,j.VS)(j.LG)&&!r?e.layoutStyles(i).inactive:e.layoutStyles(i),d=[c.phrase],g=e.isVisibleForAuthorFilter(i);return h&&d.push(hu.withAudio),g||d.push(hu.collapsed),(0,u.Zn)(e).settings.showLineNumbers&&d.push(hu.numbered),(0,A.jsxs)("div",{ref:r?n:null,"data-testid":`phrase:${s}`,className:`${d.join(" ")} ${(0,j.VS)(j.LG)&&hu.newUI}`,style:null==l?void 0:l.phrase,children:[g&&h&&!isNaN(i.start)&&(0,A.jsx)(xo.A,{type:"text",className:(0,j.VS)(j.LG)?hu.playNewUi:hu.play,"aria-label":a?"pause":"play",icon:a?(0,j.VS)(j.LG)?(0,A.jsx)(To._Zj,{}):(0,A.jsx)(So.A,{}):(0,j.VS)(j.LG)?(0,A.jsx)(To.AYg,{}):(0,A.jsx)(wo.A,{}),onClick:()=>{o(!0),e.play(s)}}),(0,j.VS)(j.LG)?(0,A.jsxs)("span",{className:hu.titleWrapper,"data-skip-node":"true",children:[(0,A.jsx)("span",{className:null==c?void 0:c.name,style:null==l?void 0:l.name,children:i[e.namekey]}),(0,A.jsx)("span",{className:hu.time,children:(e=>{var t,n,o,i,r;return`${Su(null==(t=e._value[s])?void 0:t.start)} - ${Su(null!=(n=e._value[s])&&n.end?null==(r=e._value[s])?void 0:r.end:(null==(o=e._value[s])?void 0:o.start)+(null==(i=e._value[s])?void 0:i.duration))}`})(e)})]}):(0,A.jsx)("span",{className:null==c?void 0:c.name,"data-skip-node":"true",style:null==l?void 0:l.name,children:i[e.namekey]}),(0,j.VS)(j.LG)?(0,A.jsxs)("span",{className:hu.wrapperText,children:[r&&(0,A.jsx)("span",{ref:v,className:`${hu.readingLine} reading-line`,"data-skip-node":"true"}),(0,A.jsx)("span",{className:`${null==c?void 0:c.text}`,children:i[e.textkey]})]}):(0,A.jsx)("span",{className:`${null==c?void 0:c.text}`,children:i[e.textkey]})]},`${e.name}-${s}`)}))})),ku={};(0,j.VS)(j.xS)&&(ku.crossOrigin="anonymous");class Cu extends m.Component{constructor(e){super(e),this._regionSpanSelector=".htx-highlight",this.mainContentSelector=`.${(0,Qe.cn)("main-content").toClassName()}`,this.mainViewAnnotationSelector=`.${(0,Qe.cn)("main-view").elem("annotation").toClassName()}`,this._selectRegions=e=>{const{item:t}=this.props,n=this.myRef.current,o=window.getSelection(),i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),s=[];for(;i.nextNode();){const e=i.currentNode;if("SPAN"===e.nodeName&&e.matches(this._regionSpanSelector)&&on(e)){const t=this._determineRegion(e);s.push(t)}}s.length&&(e?t.annotation.extendSelectionWith(s):t.annotation.selectAreas(s),o.removeAllRanges())},this._handleScrollContainerHeight=()=>{requestAnimationFrame((()=>{var e,t;const n=this.myRef.current,o=document.querySelector(this.mainContentSelector),i=o.getBoundingClientRect(),s=document.documentElement.clientHeight-i.top,r=document.querySelector(this.mainViewAnnotationSelector),a=Math.floor(s<i.height?s:(null==o?void 0:o.offsetHeight)||0)-(((null==r?void 0:r.offsetHeight)||(null==(e=o.firstChild)?void 0:e.offsetHeight)||0)-((null==n?void 0:n.offsetHeight)||0))-(Number.parseInt(null==(t=window.getComputedStyle(o))?void 0:t.getPropertyValue("padding-bottom"))||0);n&&(this.myRef.current.style.maxHeight=`${a<100?100:a}px`)}))},this._resizeObserver=new ResizeObserver(this._handleScrollContainerHeight),this.myRef=m.createRef(),this.activeRef=m.createRef(),this.lastPlayingId=-1,this.scrollTimeout=[],this.isPlaying=!1,this.state={canScroll:!0,inViewport:!0}}getSelectionText(e){return e.toString()}getPhraseElement(e){const t=this.props.item.layoutClasses;for(;e&&(!e.classList||!e.classList.contains(t.text));)e=e.parentNode;return e}get phraseElements(){return[...this.myRef.current.getElementsByClassName(this.props.item.layoutClasses.text)]}getOffsetInPhraseElement(e,t,n=!0){const o=this.getPhraseElement(e),i=document.createRange();i.setStart(o,0),i.setEnd(e,t);const s=i.toString().length,r=this.phraseElements.indexOf(o);let a=o;return n&&s===a.textContent.length?[0,a,r+1,r]:n||0!==s?[s,a,r,r]:(a=this.phraseElements[r-1],[a.textContent.length,a,r-1,r])}removeSurroundingNewlines(e){return e.replace(/^\n+/,"").replace(/\n+$/,"")}captureDocumentSelection(){const e=this.props.item,t=e.layoutClasses,n=[...this.myRef.current.getElementsByClassName(t.name)];let o;n.forEach((e=>{e.style.visibility="hidden"}));const i=[],s=window.getSelection();if(s.isCollapsed)return n.forEach((e=>{e.style.visibility="unset"})),[];for(o=0;o<s.rangeCount;o++){const t=s.getRangeAt(o);if(t.endContainer.nodeType!==Node.TEXT_NODE){let e=this.getPhraseElement(t.endContainer.lastChild);for(;e&&e.nodeType!==Node.TEXT_NODE;)e=e.firstChild;if(!e)continue;t.setEnd(e,0)}if(!t.collapsed&&!/^\s*$/.test(t.toString()))try{(0,Ke.splitBoundaries)(t);const[n,,o,r]=this.getOffsetInPhraseElement(t.startContainer,t.startOffset),[a,,l,d]=this.getOffsetInPhraseElement(t.endContainer,t.endOffset,!1),c=Math.min(l,d);if((0,j.VS)(j.Gd)){const d=e._value.reduce(((t,n,o)=>(e.isVisibleForAuthorFilter(n)&&r<=o&&c>=o&&t.push(o),t)),[]);if(d.length!==c-r+1){const e=this.phraseElements;let c=r;for(let u=0;u<d.length;u++){const h=d[u];if(u===d.length-1||d[u+1]!==h+1){let g,m;const p=t.cloneRange();if(c===r)c=o,g=n;else{g=0;const t=e[c].ownerDocument.createTreeWalker(e[c],NodeFilter.SHOW_ALL);for(;t.firstChild(););p.setStart(t.currentNode,g)}if(h===l)m=a;else{const t=document.createRange();t.selectNode(e[h]),m=t.toString().length;const n=e[h].ownerDocument.createTreeWalker(e[h],NodeFilter.SHOW_ALL);for(;n.lastChild(););p.setEnd(n.currentNode,n.currentNode.length)}s.removeAllRanges(),s.addRange(p);const f=this.removeSurroundingNewlines(s.toString());f&&i.push({startOffset:g,start:String(c),endOffset:m,end:String(h),_range:p,text:f}),d.length-1>u&&(c=d[u+1])}}}else i.push({startOffset:n,start:String(o),endOffset:a,end:String(l),_range:t,text:this.removeSurroundingNewlines(s.toString())})}else i.push({startOffset:n,start:String(o),endOffset:a,end:String(l),_range:t,text:this.removeSurroundingNewlines(s.toString())})}catch(e){console.error("Can not get selection",e)}}return n.forEach((e=>{e.style.visibility="unset"})),s.removeAllRanges(),i}_determineRegion(e){if((0,Ke.matchesSelector)(e,this._regionSpanSelector)){const t="SPAN"===e.tagName?e:e.closest(this._regionSpanSelector),{item:n}=this.props;return n.regs.find((e=>e.find(t)))}}_disposeTimeout(){this.scrollTimeout.length>0&&(this.scrollTimeout.forEach((e=>clearTimeout(e))),this.scrollTimeout=[])}onMouseUp(e){const t=this.props.item,n=t.activeStates();if(!n||0===n.length||e.ctrlKey||e.metaKey)return this._selectRegions(e.ctrlKey||e.metaKey);const o=this.captureDocumentSelection();if(0!==o.length)if(t._currentSpan=null,(0,j.VS)(j.Gd)){const e=t.addRegions(o);for(const t of e){const e=t.createSpans();t.addEventsToSpans(e)}}else{const e=t.addRegion(o[0]);if(e){const t=e.createSpans();e.addEventsToSpans(t)}}}_getResultText(e,t,n,o){const i=this.phraseElements;return e===t?i[e].innerText.slice(n,o):[i[e].innerText.slice(n),i.slice(e+1,t).map((e=>e.innerText)),i[t].innerText.slice(0,o)].flat().join("")}_handleUpdate(){const e=this.myRef.current,{item:t}=this.props;if(t._value&&(t.regs.forEach(((n,o)=>{var i;if(null==(i=n._spans)||null==(i=i[0])||!i.isConnected)try{const i=e.children,s=document.createRange(),r=i[n.start].getElementsByClassName(t.layoutClasses.text)[0],a=i[n.end].getElementsByClassName(t.layoutClasses.text)[0];let{startOffset:l,endOffset:d}=n;if(s.setStart(...(0,Ke.findNodeAt)(r,l)),s.setEnd(...(0,Ke.findNodeAt)(a,d)),n.text&&s.toString().replace(/\s+/g,"")!==n.text.replace(/\s+/g,"")){if(console.info("Restore broken position",o,s.toString(),"->",n.text,n),t.regs.slice(0,o).some((e=>n.start===e.end))&&n.start===n.end){const e=r.textContent.match(new RegExp(n.text.replace(/\s+/g,"\\s+")));e||console.warn("Can't find the text",n);const{index:t=0}=e||{};n.endOffset-n.startOffset!==n.text.length&&console.warn("Text length differs from region length; possible regions overlap"),l=t,d=l+n.text.length,s.setStart(...(0,Ke.findNodeAt)(r,l)),s.setEnd(...(0,Ke.findNodeAt)(a,d)),n.fixOffsets(l,d)}}else!n.text&&s.toString()&&n.setText(this._getResultText(+n.start,+n.end,l,d));(0,Ke.splitBoundaries)(s),n._range=s;const c=n.createSpans();n.addEventsToSpans(c)}catch(e){console.log(e,n)}})),Array.from(this.myRef.current.getElementsByTagName("a")).forEach((e=>{e.addEventListener("click",(e=>(e.preventDefault(),!1)))})),(0,j.VS)(j.LG)&&this.props.item.contextscroll&&t.playingId>=0&&this.lastPlayingId!==t.playingId&&this.state.canScroll)){var n,o,i,s,r;const a=Number.parseInt(null==(n=window.getComputedStyle(this.myRef.current))?void 0:n.getPropertyValue("padding-top"))||0,l=this.props.item._value[t.playingId],d=l.start,c=l.end,u=(null==(o=this.activeRef.current)?void 0:o.offsetHeight)||0,h=this.props.item._value[t.playingId].duration||c-d,g=e.offsetHeight,m=(null==(i=this.activeRef.current)?void 0:i.offsetTop)-a,p=Math.ceil((null==(s=this.activeRef.current)?void 0:s.offsetHeight)/(null==(r=this.myRef.current)?void 0:r.offsetHeight))+1;if(this._disposeTimeout(),u>g)for(let t=0;t<p;t++)this.scrollTimeout.push(setTimeout((()=>{const n=m+u*(t*(1/p));this.state.inViewPort&&this.state.canScroll&&e.scrollTo({top:n,behavior:"smooth"})}),h/p*t*1e3));else this.state.inViewPort&&e.scrollTo({top:m,behavior:"smooth"});this.lastPlayingId=t.playingId}}_handleScrollToPhrase(){var e,t;const n=Number.parseInt(null==(e=window.getComputedStyle(this.myRef.current))?void 0:e.getPropertyValue("padding-top"))||0,o=(null==(t=this.activeRef.current)?void 0:t.offsetTop)-n;this.myRef.current.scrollTo({top:o,behavior:"smooth"})}componentDidUpdate(){this._handleUpdate()}componentDidMount(){(0,j.VS)(j.LG)&&this.props.item.contextscroll&&this._resizeObserver.observe(document.querySelector(this.mainContentSelector)),this._handleUpdate()}componentWillUnmount(){var e,t;const n=document.querySelector(this.mainContentSelector);n&&(null==(e=this._resizeObserver)||e.unobserve(n)),null==(t=this._resizeObserver)||t.disconnect()}setIsInViewPort(e){this.setState({inViewPort:e})}renderWrapperHeader(){const{item:e}=this.props;return(0,A.jsxs)("div",{className:hu.wrapper_header,children:[(0,j.VS)(j.fw)&&(0,A.jsx)(xu,{item:e,onChange:()=>{if(!this.activeRef.current)return;const e=1e3*Number.parseFloat(window.getComputedStyle(this.activeRef.current).transitionDuration);setTimeout((()=>{this._handleScrollToPhrase()}),e)}}),e.contextscroll&&(0,A.jsxs)("div",{className:hu.wrapper_header__buttons,children:[(0,A.jsx)(Qn.lMk,{"data-testid":"auto-scroll-toggle",checked:this.state.canScroll,onChange:()=>{this.state.canScroll||this._handleScrollToPhrase(),this.setState({canScroll:!this.state.canScroll})},label:"Auto-scroll"}),(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Automatically sync transcript scrolling with audio playback",children:(0,A.jsx)(To.Lwz,{})})]})]})}render(){const{item:e}=this.props,t=!!e.audio,n=(0,j.VS)(j.LG)&&this.props.item.contextscroll;return!e.playing&&(0,j.VS)(j.LG)&&this._disposeTimeout(),(0,j.VS)(j.fw)&&!e._value?null:(0,A.jsxs)(En,{item:e,className:(0,Qe.cn)("paragraphs").toClassName(),children:[t&&(0,A.jsx)("audio",Object.assign({},ku,{controls:e.showplayer&&!e.syncedAudio,className:hu.audio,src:e.audio,ref:e.audioRef,onLoadedMetadata:e.handleAudioLoaded,onEnded:e.reset,onError:e.handleError,onCanPlay:e.handleCanPlay})),(0,j.VS)(j.LG)?this.renderWrapperHeader():(0,j.VS)(j.fw)&&(0,A.jsx)(xu,{item:e}),(0,A.jsx)("div",{ref:this.myRef,"data-testid":"phrases-wrapper","data-update":e._update,className:n?hu.scroll_container:hu.container,onMouseUp:this.onMouseUp.bind(this),children:(0,A.jsx)(wu,Object.assign({setIsInViewport:this.setIsInViewPort.bind(this),item:e,playingId:e.playingId},(0,j.VS)(j.LG)?{activeRef:this.activeRef}:{}))})]})}}const ju=(0,v.WQ)("store")((0,v.PA)(Cu));b.addTag("paragraphs",yu,ju),b.addObjectType(yu);const Ru=u.gK.model({type:"pdf",value:u.gK.maybeNull(u.gK.string),_url:u.gK.maybeNull(u.gK.string)}).actions((e=>({updateValue(t){e._url=k(e.value,t.task.dataObj)}}))),_u=u.gK.compose("PdfModel",Sn,Ue,Ne,Ru),Tu=(0,v.WQ)("store")((0,v.PA)((({item:e})=>e._url?(0,A.jsx)("embed",{src:e._url,style:{width:"100%",height:"600px",border:"none"},type:"application/pdf"}):null)));b.addTag("pdf",_u,Tu),b.addObjectType(_u);var Au=n(6847);const Ku="htx-highlight",Eu="htx-no-label",Pu=u.gK.model().volatile((()=>({_spans:null}))).views((e=>({get _hasSpans(){return!!e._spans&&e._spans.every((e=>e.isConnected))},get identifier(){return`${e.id.split("#")[0]}-${e.ouid}`},get className(){return`${Ku}-${e.identifier}`},get classNames(){var t;const n=[Ku,e.className];return(null!=(t=e.parent.showlabels)?t:e.store.settings.showLabels)||n.push(Eu),e.selected&&n.push(Mu.active),(0,x.isDefined)(e.parent.showlabels)&&n.push("htx-manual-label"),n},generateStyles:(e,t,n=!1)=>`\n        .${e} {\n          background-color: ${t.background} !important;\n          border: 1px dashed transparent;\n        }\n        .${e}.${Mu.active}:not(.${Mu.hidden}) {\n          color: ${t.activeText} !important;\n          background-color: ${n?t.resizeBackground:t.activeBackground} !important;\n        }\n      `,get styles(){return this.generateStyles(e.className,e.getColors())},get resizeStyles(){return this.generateStyles(e.className,e.getColors(),!0)}}))).actions((e=>({applyHighlight(t=!1){var n;e._hasSpans||(e._spans=e.parent.createSpansByGlobalOffsets(e.globalOffsets),null==(n=e._spans)||n.forEach((t=>t.className=e.classNames.join(" "))),e.updateSpans(),t||e.parent.setStyles({[e.identifier]:e.styles}))},updateHighlightedText({force:t=!1}={}){e.text&&!t||(e.text=e.parent.getTextFromGlobalOffsets(e.globalOffsets))},updateSpans(){var t;if(e._hasSpans||null!=(t=e._spans)&&t.length){const t=e._spans[0],n=e._spans.at(-1),o=e.globalOffsets;sn.Selection.applySpanStyles(n,{index:e.region_index,label:e.getLabels()}),t.setAttribute("data-start",o.start),n.setAttribute("data-end",o.end)}},clearSpans(){e._spans=null},removeHighlight(){var t,n;e.globalOffsets&&(null==(n=e.parent)||n.removeSpansInGlobalOffsets(e._spans,e.globalOffsets));null==(t=e.parent)||t.removeStyles([e.identifier]),e._spans=null},updateAppearenceFromState(){var t,n;if(null!=(t=e._spans)&&t.length)if(null!=(n=e.parent)&&n.canResizeSpans){const t=e._spans[0].getAttribute("data-start"),n=e._spans.at(-1).getAttribute("data-end"),o=e.globalOffsets;!(0,x.isDefined)(t)||+t===o.start&&+n===o.end?(null==e.parent.setStyles||e.parent.setStyles({[e.identifier]:e.styles}),e.updateSpans()):(e.removeHighlight(),e.applyHighlight())}else null==e.parent.setStyles||e.parent.setStyles({[e.identifier]:e.styles}),e.updateSpans()},attachHandles(){const t=[Mu.leftHandle,Mu.rightHandle],n=e._spans[0],o=e._spans.at(-1);t.forEach(((e,t)=>{const i=document.createElement("area");i.classList.add(e),0===t?n.prepend(i):o.append(i)}))},detachHandles(){var t;null==(t=e._spans)||t.forEach((e=>e.querySelectorAll("area").forEach((e=>e.remove()))))},selectRegion(){var t,n;e.annotation.setHighlightedNode(e),e.addClass(Mu.active);const o=null==(t=e._spans)?void 0:t[0];o&&(null!=(n=e.parent)&&n.canResizeSpans&&e.attachHandles(),o.scrollIntoViewIfNeeded?o.scrollIntoViewIfNeeded():o.scrollIntoView({block:"center",behavior:"smooth"}))},afterUnselectRegion(){var t;e.removeClass(Mu.active),null!=(t=e.parent)&&t.canResizeSpans&&e.detachHandles()},beforeDestroy(){var t;null==(t=e.parent)||t.removeStyles([e.identifier])},setHighlight(t){e._spans&&(e._highlighted=t,e.highlighted?e.addClass(Mu.highlighted):e.removeClass(Mu.highlighted))},getLabels(){var t,n;return[e.region_index,(null!=(t=null==(n=e.labeling)?void 0:n.selectedLabels)?t:[]).map((e=>e.value)).join(",")].filter(Boolean).join(":")},getColors(){const t=e.parent.highlightcolor||(e.style||e.tag||z.l).fillcolor,n=sn.Colors.convertToRGBA(null!=t?t:"#DA935D",.3),o=sn.Colors.convertToRGBA(null!=t?t:"#DA935D",.8);return{background:n,activeBackground:o,resizeBackground:sn.Colors.convertToRGBA(null!=t?t:"#DA935D",1.6-1),activeText:sn.Colors.contrastColor(o)}},find:t=>e._spans&&e._spans.indexOf(t)>=0?e:void 0,addClass(t){if(!t||!e._spans)return;const n=[].concat(t);e._spans.forEach((e=>e.classList.add(...n)))},removeClass(t){if(!t||!e._spans)return;const n=[].concat(t);e._spans.forEach((e=>e.classList.remove(...n)))},toggleHidden(t){e.hidden=!e.hidden,e.hidden?e.addClass("__hidden"):e.removeClass("__hidden"),null==t||t.stopPropagation()}}))),Mu={active:"__active",highlighted:"__highlighted",collapsed:"__collapsed",hidden:"__hidden",rightHandle:"__resize_right",leftHandle:"__resize_left",noLabel:Eu};class Du{constructor(e,t,n,o,i){this.node=void 0,this.start=void 0,this.end=void 0,this.content=void 0,this.path=void 0,this.node=e,this.start=t,this.end=n,this.content=o,this.path=i}getContent(e,t){return this.content.slice(Math.max(e-this.start,0),Math.min(t-this.start,this.end))}get text(){return this.content.join("")}getText(e,t){return this.getContent(e,t).join("")}createSubtext(e,t){e=Math.max(this.start,e),t=Math.min(this.end,t);const{node:n}=this,o=n.cloneNode(),i=this.getContent(e,t);return o.textContent&&(o.textContent=[...o.textContent].slice(e-this.start,t-this.start).join("")),new Du(o,e,t,i)}wrapWithSpan(){const{node:e,start:t,end:n}=this,o=e.ownerDocument,i=e.parentNode,s=o.createTextNode(""),r=o.createElement("span");null==i||i.replaceChild(s,e),r.appendChild(e),null==i||i.replaceChild(r,s);const a=new Iu(r,t,n);return a.children.push(this),a}createSpanElements(e,t){const{node:n}=this,o=n.ownerDocument,i=n.parentNode,s=o.createDocumentFragment(),r=o.createTextNode(""),a=[];e>this.start&&a.push(this.createSubtext(this.start,e));const l=this.createSubtext(e,t).wrapWithSpan();return a.push(l),t<this.end&&a.push(this.createSubtext(t,this.end)),a.forEach((e=>{s.appendChild(e.node)})),i.replaceChild(r,n),i.replaceChild(s,r),a}removeNode(){const{node:e}=this;e.parentNode.removeChild(e)}mergeWith(e){this.node.data+=e.map((e=>e.node.data)).join(""),this.end=e[e.length-1].end,this.content.push(...e.flatMap((e=>e.content)))}}class Ou{constructor(e,t=e){this.start=void 0,this.end=void 0,this.children=[],this.start=e,this.end=t}findTextElement(e,t="start"){const n=this.children.find((n=>n.start<=e&&n.end>=e&&n[t]!==e));return n instanceof Iu?n.findTextElement(e,t):n instanceof Du?n:void 0}findElementByNode(e){for(const t of this.children){if(t.node===e)return t;if(t instanceof Iu){const n=t.findElementByNode(e);if(n)return n}}}getText(e,t){const n=[];return this.children.forEach((o=>{o.end>e&&o.start<t&&n.push(o.getText(e,t))})),n.join("")}wrapElementsWithSpan(e){const t=e[0],n=e[e.length-1],{node:o}=t,i=o.ownerDocument,s=o.parentNode,r=i.createTextNode(""),a=i.createElement("span");s.replaceChild(r,t.node),e.forEach((e=>{a.appendChild(e.node)})),s.replaceChild(a,r);const l=new Iu(a,t.start,n.end);return l.children.push(...e),l}createSpans(e,t){const n=[],o=[];let i=[];for(const s of this.children){const r=s instanceof Du;if(s.start>=e&&s.end<=t)i.push(s);else{if(i.length){const e=this.wrapElementsWithSpan(i);o.push(e),n.push(e.node),i=[]}if(e>=s.start&&e<s.end||t>s.start&&t<=s.end)if(r){const i=s.createSpanElements(e,t);o.push(...i),n.push(...i.filter((e=>e instanceof Iu)).map((e=>e.node)))}else o.push(s),n.push(...s.createSpans(e,t));else o.push(s)}}if(i.length){const e=this.wrapElementsWithSpan(i);o.push(e),n.push(e.node)}return this.children=o,n}removeSpans(e){for(let t=this.children.length-1;t>=0;t--){const n=this.children[t];n instanceof Iu&&(e.includes(n.node)?(n.removeNode(),this.children.splice(t,1,...n.children)):n.removeSpans(e))}let t=[];const n=[],o=()=>{if(t.length>0){const e=t[0];if(t.length>1){const n=t.slice(1);e.mergeWith(n),n.forEach((e=>e.removeNode()))}n.push(e),t=[]}};for(const e of this.children)e instanceof Du&&(0===t.length||t[t.length-1].node.nextSibling===e.node)?t.push(e):(o(),n.push(e));o(),this.children=n}}class Iu extends Ou{constructor(e,t,n){super(t,n),this.node=void 0,this.node=e}removeNode(){const{node:e}=this,t=e.ownerDocument,n=e.parentNode,o=t.createDocumentFragment();for(;e.firstChild;)o.appendChild(e.firstChild);n.replaceChild(o,e)}}class Lu extends Ou{constructor(e,t){super(e),this.path=void 0,this.content=[],this.path=t}addTextNode(e,t,n,o,i){this.content=o,this.children.push(new Du(e,t,n,o,i)),this.end=n}getRelativeOffsetByGlobal(e){return this.content.slice(0,e-this.start).map((e=>""===e?" ":e)).join("").length}getGlobalOffsetByRelative(e){let t=e;const n=0===e?0:1+this.content.findIndex((e=>(""===e?t--:t-=e.length,t<=0)));return this.start+n}}class Nu{constructor(e,t,n){this.node=void 0,this.start=void 0,this.path=void 0,this.node=e,this.start=t,this.path=n}getText(){return""}}class zu{constructor(){this.elements=[],this.endPos=void 0,this.displayedText="",this.displayedTextPos=0,this.endPos=0}createDynamicBlock(e){const{endPos:t}=this,n=new Lu(t,e);return this.elements.push(n),n}setDisplayedText(e){this.displayedText=e}addStaticElement(e,t){this.elements.push(new Nu(e,this.endPos,t.toString()))}addExtraText(e){let t=this.elements.length-1;for(;!(this.elements[t]instanceof Lu)&&t>-1;)--t;this.elements.splice(t+1,0,function(e){return e.replace(/[\n\r]/g,"\\n")}(e))}findProjectionOnDisplayedText(e){const{displayedText:t}=this;let n=this.displayedTextPos;const o=[];for(;"\n"===t[n]||"\r"===t[n];)n++;let i=n;for(const n of e){const e=t.substring(i,i+n.length);e===n||" "===e&&"\n"===n?(o.push(e),i+=n.length):o.push("")}return{fromIdx:n,toIdx:i,content:o.flatMap((e=>e?[...e]:e))}}addTextElement(e,t){const{displayedText:n}=this,o=e.textContent;let i=n.indexOf(o,this.displayedTextPos),s=[...o];const r=s.length;let a=o.length;if(-1===i||i-this.displayedTextPos>1){const{fromIdx:e,toIdx:t,content:n}=this.findProjectionOnDisplayedText(o);i=e,a=t-e,s=n}i!==this.displayedTextPos&&(this.addExtraText(this.displayedText.substring(this.displayedTextPos,i)),this.displayedTextPos=i);this.createDynamicBlock(t.toString()).addTextNode(e,this.endPos,this.endPos+r,s,t.toString()),this.endPos+=r,this.displayedTextPos+=a}addBR(){this.endPos+=1}findTextElement(e,t="start"){var n;return null==(n=this.findTextBlock(e,t))?void 0:n.findTextElement(e,t)}findElementByPath(e){for(const t of this.elements)if("string"!=typeof t&&t.path===e)return t}getNextElement(e){let t=this.elements.indexOf(e);for(;!(this.elements[t+1]instanceof Nu||this.elements[t+1]instanceof Lu);)if(t++,t>=this.elements.length-1)return;return this.elements[t+1]}getEndOf(e){if(e instanceof Iu||e instanceof Du)return e.end;const t=this.getNextElement(e);return t?t.start:this.endPos}findElementByNode(e){for(const t of this.elements)if(t instanceof Nu){if(t.node===e)return t}else if(t instanceof Lu){const n=t.findElementByNode(e);if(n)return n}}findTextBlock(e,t="start"){const n=this.elements.find((n=>n instanceof Lu&&n.start<=e&&n.end>=e&&n[t]!==e));return(0,x.isDefined)(n),n}indexOfTextBlock(e,t="start"){return this.elements.findIndex((n=>n instanceof Lu&&n.start<=e&&n.end>=e&&n[t]!==e))}getText(e,t){const n=this.indexOfTextBlock(e,"end"),o=this.indexOfTextBlock(t,"start");return this.elements.slice(n,o+1).map((n=>"string"!=typeof n?n.getText(e,t):n)).join("")}collectBlocks(e,t){const n=this.indexOfTextBlock(e,"end"),o=Math.max(this.indexOfTextBlock(t,"start"),n);return this.elements.slice(n,o+1).filter((e=>e instanceof Lu))}createSpans(e,t){t<e&&(t=e);const n=this.collectBlocks(e,t);return(0,x.flatten)(n.map((n=>n.createSpans(e,t))))}removeSpans(e,t,n){const o=this.collectBlocks(t,n);for(const t of o)t.removeSpans(e)}destroy(){this.elements=[]}}class Vu{constructor(){this.segments=[],this.counters=[]}get currentSegment(){return this.segments[this.segments.length-1]}get currentCounters(){return this.counters[this.counters.length-1]}getSegmentName(e){return e.nodeType===Node.TEXT_NODE?"text()":e.nodeName.toLowerCase()}into(e){const t=this.getSegmentName(e);this.segments.push([t,1]),this.counters.push({[t]:1})}next(e){const t=this.getSegmentName(e);this.currentCounters[t]||(this.currentCounters[t]=0),this.currentSegment[0]=t,this.currentSegment[1]=++this.currentCounters[t]}outOf(){this.segments.pop(),this.counters.pop()}toString(){return`/${this.segments.map((e=>`${e[0]}[${e[1]}]`)).join("/")}`}}class Hu{constructor(e){if(this.container=void 0,this.root=void 0,this.doc=void 0,this.view=void 0,this.domData=void 0,this.fragment=void 0,this.styleTags=void 0,this.walker=null,this.currentPath=new Vu,this.container=e,e instanceof HTMLIFrameElement){const e=this.container.contentDocument;this.root=e.body}else this.root=e;this.doc=this.root.ownerDocument,this.view=this.doc.defaultView,this.domData=new zu,this.fragment=document.createDocumentFragment(),this.styleTags={},this.initDataMap()}nextStep(e=!1){const t=this.walker,n=this.currentPath;let o;return!e&&(o=t.firstChild(),o)?(n.into(o),o):(o=t.nextSibling(),o?(n.next(o),o):(o=t.parentNode(),n.outOf(),o?this.nextStep(!0):o))}initDataMap(){const{doc:e,root:t,domData:n}=this,o=this.walker=e.createTreeWalker(t,NodeFilter.SHOW_ALL);let i;for(this.currentPath=new Vu,i=o.currentNode,n.setDisplayedText(this.collectText());i;){const e=i.nodeType===Node.TEXT_NODE,t="BR"===i.nodeName;e?n.addTextElement(i,this.currentPath):t?n.addBR():n.addStaticElement(i,this.currentPath),i=this.nextStep()}this.walker=null}collectText(){const{root:e,view:t}=this,n=t.getSelection(),o=new Range,i=[];for(let e=0;e<n.rangeCount;e++)i.push(n.getRangeAt(e));o.setStartBefore(e),o.setEndAfter(e),n.removeAllRanges(),n.addRange(o);const s=String(n);n.removeAllRanges();for(const e of i)n.addRange(e);if(document.activeElement){const e=document.activeElement;null==e.blur||e.blur(),null==e.focus||e.focus()}return s}createRange(e,t){const n=this.domData.findTextElement(e,"end"),o=this.domData.findTextElement(t,"start");if(n&&o){const{doc:i}=this,s=i.createRange();return s.setStart(n.node,e-n.start),s.setEnd(o.node,t-o.start),s}}relativeOffsetsToGlobalOffsets(e,t,n,o){let i=this.domData.findElementByPath(e),s=this.domData.findElementByPath(n);if(i&&s)return i instanceof Lu||(i=this.domData.findTextBlock(i.start,"end")),s instanceof Lu||(s=this.domData.findTextBlock(s.start,"end")),[i.getGlobalOffsetByRelative(t),s.getGlobalOffsetByRelative(o)]}globalOffsetsToRelativeOffsets(e,t){const n=this.domData.findTextBlock(e,"end"),o=this.domData.findTextBlock(t,"start");if(n&&o)return{start:n.path,startOffset:n.getRelativeOffsetByGlobal(e),end:o.path,endOffset:o.getRelativeOffsetByGlobal(t)}}rangeToGlobalOffset(e){const t=this.domData.findElementByNode(e.startContainer),n=this.domData.findElementByNode(e.endContainer);if(!t||!n)return;const o=this.domData.findTextBlock(t.start,"end"),i=this.domData.findTextBlock(n.start,"end");return[o.getGlobalOffsetByRelative(e.startOffset),i.getGlobalOffsetByRelative(e.endOffset)]}getText(e,t){return this.domData.getText(e,t)}createSpans(e,t){return this.domData.createSpans(e,t)}removeSpans(e,t,n){return this.domData.removeSpans(e,t,n)}setStyles(e){const{styleTags:t}=this;for(const[n,o]of Object.entries(e)){let e=t[n];e||(t[n]=e=this.doc.createElement("style"),e.id=`highlight-${n}`,this.doc.head.appendChild(e)),e.textContent=o}}removeStyles(e){const{styleTags:t}=this;Array.isArray(e)||(e=[e]);for(const n of e){const e=t[n];e&&(this.doc.head.removeChild(e),delete t[n])}}destroy(){this.removeStyles(Object.keys(this.styleTags)),this.domData.destroy(),this.domData=new zu}}const Bu=()=>"Do not put text directly in task data if you use valueType=url.",Fu=e=>`URL (${(0,x.escapeHtml)(e)}) is not valid.`,Wu=()=>'In SECURE MODE valueType is set to "url" by default.',$u=u.gK.model("RichTextModel",{value:u.gK.maybeNull(u.gK.string),valuetype:u.gK.optional(u.gK.enumeration(["text","url"]),(()=>window.LS_SECURE_MODE?"url":"text")),inline:!1,savetextresult:u.gK.optional(u.gK.enumeration(["none","no","yes"]),(()=>window.LS_SECURE_MODE?"no":"none")),selectionenabled:u.gK.optional(u.gK.boolean,!0),clickablelinks:!1,highlightcolor:u.gK.maybeNull(Me.color),showlabels:u.gK.maybeNull(u.gK.boolean),encoding:u.gK.optional(u.gK.enumeration(["none","base64","base64unicode"]),"none"),granularity:u.gK.optional(u.gK.enumeration(["symbol","word","sentence","paragraph"]),"symbol")}),Uu=u.gK.model("RichTextModel",{type:"richtext",_value:u.gK.optional(u.gK.maybeNull(u.gK.string),null)}).views((e=>({get canResizeSpans(){return Au.isActive(Au.FF_ADJUSTABLE_SPANS)&&"text"===e.type&&!e.isReadOnly()},get hasStates(){const t=e.states();return t&&t.length>0},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter((e=>e.isLabeling&&e.isSelected)):null},get isLoaded(){var t;return e._isLoaded&&e._loadedForAnnotation===(null==(t=e.annotation)?void 0:t.id)},get isReady(){return e.isLoaded&&e._isReady},get styles(){return`\n      .htx-highlight {\n        cursor: pointer;\n        border: 1px dashed transparent;\n      }\n      .htx-highlight[data-index]::after,\n      .htx-highlight[data-label]::after {\n        padding: 2px 2px;\n        font-size: 9.5px;\n        font-weight: bold;\n        font-family: var(--font-mono);\n        vertical-align: super;\n        content: attr(data-label);\n        line-height: 0;\n      }\n      .htx-highlight[data-index]:not([data-label])::after {\n        content: attr(data-index);\n      }\n      .htx-highlight.${Mu.highlighted} {\n        position: relative;\n        cursor: ${z.A.LINKING_MODE_CURSOR};\n        border-color: rgb(0, 174, 255);\n      }\n      .htx-highlight.${Mu.hidden} {\n        border: none;\n        padding: 0;\n        background: transparent !important;\n        cursor: inherit;\n        // pointer-events: none;\n      }\n      .htx-highlight.${Mu.hidden}::before,\n      .htx-highlight.${Mu.hidden}::after,\n      .htx-highlight.${Mu.noLabel}::after {\n        display: none;\n      }\n      `},getIframeBodyNode(){var t;const n=e.mountNodeRef.current;return null==n||null==(t=n.contentDocument)?void 0:t.body},getRootNode(){var t;return null!=(t=e.getIframeBodyNode())?t:e.mountNodeRef.current}}))).volatile((()=>({mountNodeRef:(0,m.createRef)(),_isReady:!1,_isLoaded:!1,_loadedForAnnotation:null}))).actions((e=>{let t;return{setLoaded(t=!0){var n;t&&e.onLoaded(),e._isLoaded=t,e._loadedForAnnotation=null==(n=e.annotation)?void 0:n.id},onLoaded(){e.mountNodeRef.current&&(t=new Hu(e.mountNodeRef.current))},onDispose(){e.regs.forEach((e=>{e.clearSpans()}))},updateValue:(0,u.L3)((function*(t){const n=k(e.value,t.task.dataObj),o=yield e.resolveValue(n);if("url"===e.valuetype){const t=o;if(!(0,x.isValidObjectURL)(t,!0)){const n=[Fu(t),Bu()];return window.LS_SECURE_MODE&&n.unshift(Wu()),e.annotationStore.addErrors([mr.generalError(n.join("<br/>\n"))]),void e.setRemoteValue("")}try{const n=yield fetch(t),{ok:o,status:i,statusText:s}=n;if(!o)throw new Error(`${i} ${s}`);e.setRemoteValue(yield n.text())}catch(n){const o=et.A.ERR_LOADING_HTTP({attr:e.value,error:String(n),url:t});e.annotationStore.addErrors([mr.generalError(o)]),e.setRemoteValue("")}}else e.setRemoteValue(o)})),setRemoteValue(t){e.loaded=!0,"base64"===e.encoding&&(t=atob(t)),"base64unicode"===e.encoding&&(t=sn.Checkers.atobUnicode(t)),(0,j.VS)(j.pN)&&"text"===e.type?e._value=String(t):e._value=(0,Ke.sanitizeHtml)(String(t)),e._regionsCache.forEach((({region:t,annotation:n})=>{t.setText(e._value.substring(t.startOffset,t.endOffset)),e.regions.push(t),n.addRegion(t)})),e._regionsCache=[]},afterCreate(){e._regionsCache=[],"text"===e.type&&(e.inline=!0),"none"===e.savetextresult&&("url"===e.valuetype?e.savetextresult="no":"text"===e.valuetype&&(e.savetextresult="yes"))},beforeDestroy(){var n,o;null==(n=t)||n.removeStyles(e.name),null==(o=t)||o.destroy(),t=null},needsUpdate(){if(!1===e.isLoaded)return;e.setReady(!1);const t={[e.name]:e.styles};e.regs.forEach((e=>{try{e.initRangeAndOffsets(),e.applyHighlight(!0),e.updateHighlightedText(),t[e.identifier]=e.styles}catch(e){console.error(e)}})),e.setStyles(t),e.setReady(!0)},setStyles(e){var n;null==(n=t)||n.setStyles(e)},removeStyles(e){var n;null==(n=t)||n.removeStyles(e)},globalOffsetsToRelativeOffsets:({start:e,end:n})=>t.globalOffsetsToRelativeOffsets(e,n),relativeOffsetsToGlobalOffsets:(e,n,o,i)=>t.relativeOffsetsToGlobalOffsets(e,n,o,i),rangeToGlobalOffset:e=>t.rangeToGlobalOffset(e),createSpansByGlobalOffsets:({start:e,end:n})=>t.createSpans(e,n),removeSpansInGlobalOffsets(e,{start:n,end:o}){var i;return null==(i=t)?void 0:i.removeSpans(e,n,o)},getTextFromGlobalOffsets:({start:e,end:n})=>t.getText(e,n),setHighlight(t){e.regs.forEach((e=>e.setHighlight(!1))),t&&t.annotation.isLinkingMode&&t.setHighlight(!0)},addRegion(t,n){var o;const i=e.getAvailableStates();if(0===i.length)return;const[s,...r]=i,a=null!=(o=null==n?void 0:n.value)?o:s.selectedValues(),l={[s.valueType]:a},d=r.map((e=>Za(e))),c=e.annotation.createResult(t,l,s,e),h=e.getRootNode();d.forEach((e=>{c.setValue(e),(0,u.zr)(e)})),c._range=t._range;const[g,m]=tn(t._range,h);return c.updateGlobalOffsets(g,m),t.isText?c.updateTextOffsets(g,m):c.updateXPathsFromGlobalOffsets(),c.applyHighlight(),c.notifyDrawingFinished(),c}}})),Yu=u.gK.compose("RichTextModel",Ue,Sn,ut,Ne,Ve,$u,Uu);var Xu=n(71161);class Gu extends m.Component{constructor(...e){super(...e),this._regionSpanSelector=".htx-highlight",this._regionVisibleSpanSelector=".htx-highlight:not(.__hidden)",this.loadingRef=m.createRef(),this.doubleClickSelection=void 0,this._selectRegions=e=>{const{item:t}=this.props,n=t.mountNodeRef.current,o=window.getSelection(),i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT),s=[];for(;i.nextNode();){const e=i.currentNode;if("SPAN"===e.nodeName&&e.matches(this._regionVisibleSpanSelector)&&o.containsNode(e)){const t=this._determineRegion(e);s.push(t)}}s.length&&(t.annotation.extendSelectionWith(s),e?t.annotation.extendSelectionWith(s):t.annotation.selectAreas(s),o.removeAllRanges())},this._setSelectionStyle=(e,t)=>{var n,o;const i=e.getColors(),s=[`background: ${i.resizeBackground};`,`color: ${i.activeText};`];this.selectionStyle||(this.selectionStyle=t.createElement("style"),t.head.appendChild(this.selectionStyle)),this.selectionStyle.innerText=[`::selection {${s.join(" ")}}`,`::-moz-selection {${s.join(" ")}}`,"body * { cursor: col-resize !important; }"].join("\n"),null==(n=(o=this.props.item).setStyles)||n.call(o,{[e.identifier]:e.resizeStyles})},this._removeSelectionStyle=e=>{var t,n;this.selectionStyle&&(this.selectionStyle.innerText=""),e&&(null==(t=(n=this.props.item).setStyles)||t.call(n,{[e.identifier]:e.styles}))},this._checkHandlesAndStartDragging=e=>{const{item:t}=this.props,n=e.target,o=this._determineRegion(n),i=[Mu.leftHandle,Mu.rightHandle],s=n.classList.contains(i[0])||n.classList.contains(i[1]);if(1===e.buttons&&null!=o&&o.selected&&s){var r,a;const e=t.mountNodeRef.current,s=null!=(r=null!=(a=null==e?void 0:e.contentDocument)?a:null==e?void 0:e.ownerDocument)?r:e;this.draggableRegion=o,this.dragBackwards=n.classList.contains(i[0]),this._setSelectionStyle(o,s)}else this.draggableRegion=void 0},this._hightlightRegion=(e,t)=>{const n=t._spans[0],o=t._spans.at(-1),i=window.getSelection();this.dragBackwards?(i.selectAllChildren(o),i.collapseToEnd(),i.extend(n,0)):(i.selectAllChildren(n),i.extend(o,o.childNodes.length-1))},this._checkDragAndAdjustRegion=e=>{const{item:t}=this.props;if(this._removeSelectionStyle(this.draggableRegion),t.initializedDrag){const n=this.draggableRegion,o=window.getSelection();if(o.isCollapsed)return!1;if(!n)return!1;let i=o.getRangeAt(0);if(!e.contains(i.startContainer)||!e.contains(i.endContainer))return o.removeAllRanges(),!1;n.detachHandles(),"symbol"!==t.granularity&&Ht(o),Wt(o,t.granularity),i=o.getRangeAt(0),o.removeAllRanges(),n._range=i;const[s,r]=tn(i,e);return n.removeHighlight(),t.annotation.history.freeze("richtext:resize"),n.updateGlobalOffsets(s,r),"text"===t.type?n.updateTextOffsets(s,r):n.updateXPathsFromGlobalOffsets(),n.applyHighlight(),n.attachHandles(),n.notifyDrawingFinished(),n.updateHighlightedText({force:!0}),t.annotation.history.unfreeze("richtext:resize"),!0}return!1},this._onMouseDown=e=>{this.props.item.canResizeSpans&&(this._resetDragParams(),this._removeSelectionStyle(),this._checkHandlesAndStartDragging(e))},this._onMouseMove=e=>{if(this.draggableRegion){e.preventDefault();const{item:o}=this.props;if(o.initializedDrag){if(!this.currentSelection){var t,n;const e=o.mountNodeRef.current,i=null!=(t=null!=(n=null==e?void 0:e.contentDocument)?n:null==e?void 0:e.ownerDocument)?t:e;this.currentSelection=window.getSelection(),this._hightlightRegion(i,this.draggableRegion),document.addEventListener("mouseup",this._onMouseUpGlobal,{once:!0})}}else o.initializedDrag=!0}},this._onMouseUpGlobal=()=>{var e,t;const{item:n}=this.props,o=n.mountNodeRef.current,i=null!=(e=null==o||null==(t=o.contentDocument)?void 0:t.body)?e:o;this._checkDragAndAdjustRegion(i),this.draggableRegion&&this._resetDragParams()},this._onMouseUp=e=>{var t,n,o,i,s,r;const{item:a}=this.props;if(a.initializedDrag)return;const l=a.activeStates(),d=a.mountNodeRef.current,c=null!=(t=null==d||null==(n=d.contentDocument)?void 0:n.body)?t:d;if(!l||0===l.length||e.ctrlKey||e.metaKey)return this._selectRegions(e.ctrlKey||e.metaKey);if(!1===a.selectionenabled||a.annotation.isReadOnly())return;const u=null==(o=l[0])||null==(o=o.selectedLabels)?void 0:o[0],h=null==(i=l[0])||null==i.selectedValues?void 0:i.selectedValues();sn.Selection.captureSelection((({selectionText:t,range:n})=>{if(!n||n.collapsed||!c.contains(n.startContainer)||!c.contains(n.endContainer))return;en(n);const o=Xu.fromRange(n,c);o&&(this.doubleClickSelection&&(Date.now()-this.doubleClickSelection.time>450||Math.abs(e.pageX-this.doubleClickSelection.x)>5||Math.abs(e.pageY-this.doubleClickSelection.y)>5)&&(this.doubleClickSelection=void 0),o._range=n,o.text=t,o.isText="text"===a.type,a.addRegion(o,this.doubleClickSelection))}),{window:null!=(s=null==d?void 0:d.contentWindow)?s:window,granularity:null!=(r=null==u?void 0:u.granularity)?r:a.granularity,beforeCleanup:()=>{this.doubleClickSelection=void 0,this._selectionMode=!0}}),this.doubleClickSelection={time:Date.now(),value:null!=h&&h.length?h:void 0,x:e.pageX,y:e.pageY}},this._onRegionClick=e=>{if(this._selectionMode)return void(this._selectionMode=!1);if(!this.props.item.clickablelinks&&(0,Ke.matchesSelector)(e.target,"a[href]"))return void e.preventDefault();const t=this._determineRegion(e.target);t&&(t&&t.onClickRegion(e),e.stopPropagation())},this._onRegionMouseOver=e=>{const t=this._determineRegion(e.target),{item:n}=this.props;n.setHighlight(t)},this.updateLoadingVisibility=()=>{const{item:e}=this.props,t=this.loadingRef.current;t&&(e&&(0,u._n)(e)&&e.isLoaded&&e.isReady?t.setAttribute("style","display: none"):t.removeAttribute("style"))},this._passHotkeys=e=>{const t="key code keyCode location ctrlKey shiftKey altKey metaKey".split(" "),n={};for(const o of t)n[o]=e[o];const o=new KeyboardEvent(e.type,n);document.dispatchEvent(o)},this.onIFrameLoad=()=>{const{item:e}=this.props,t=e.mountNodeRef.current,n=null==t?void 0:t.contentDocument,o=null==n?void 0:n.body,i=null==o?void 0:o.parentElement,s={click:[this._onRegionClick,!0],keydown:[this._passHotkeys,!1],keyup:[this._passHotkeys,!1],keypress:[this._passHotkeys,!1],mouseup:[this._onMouseUp,!1],mouseover:[this._onRegionMouseOver,!0]};if(!o)return;for(const e in s)o.addEventListener(e,...s[e]);const r=n.createElement("style");r.textContent="body a[href] { pointer-events: all; }",n.head.appendChild(r),o.scrollHeight&&(t.style.height=`${Math.max(o.scrollHeight,i.offsetHeight)}px`),this.markObjectAsLoaded()}}_resetDragParams(){const{item:e}=this.props;e.initializedDrag=!1,this.draggableRegion=void 0,this.currentSelection=void 0,this.dragBackwards=!1}_handleUpdate(e=!1){const{item:t}=this.props,n=t.getRootNode();if(t.inline||n&&"IFRAME"!==n.tagName&&n.childNodes.length&&!1!==t.isLoaded)if(e&&t.annotation){const{history:e,pauseAutosave:n,startAutosave:o}=t.annotation;n(),e.freeze("richtext:init"),t.needsUpdate(),e.setReplaceNextUndoState(!0),e.unfreeze("richtext:init"),o()}else t.needsUpdate()}_determineRegion(e){const t=this._regionVisibleSpanSelector;if((0,Ke.matchesSelector)(e,t)){const n="SPAN"===e.tagName&&e.matches(t)?e:e.closest(t),{item:o}=this.props;return o.regs.find((e=>e.find(n)))}}componentDidMount(){const{item:e}=this.props;e.inline||(this.dispose=(0,c.lB)(e,"_isReady",this.updateLoadingVisibility,!0))}componentWillUnmount(){var e;const{item:t}=this.props;t&&(0,u._n)(t)&&(null==(e=this.dispose)||e.call(this),t.setLoaded(!1),t.setReady(!1),t.onDispose())}markObjectAsLoaded(){const{item:e}=this.props;e&&(0,u._n)(e)&&(e.setLoaded(!0),this.updateLoadingVisibility(),setTimeout((()=>this._handleUpdate(!0))))}render(){const{item:e}=this.props;if(!(0,x.isDefined)(e._value))return null;let t=e._value||"";const n=this.props.store.settings,o="text"===e.type;if(o){const e=(0,Qe.cn)("richtext",{elem:"line"});t=(0,Ke.htmlEscape)(t).split(/\n|\r/g).map((t=>`<span class="${e}">${t}</span>`)).join("<br/>")}if(e.inline){const i={onClickCapture:this._onRegionClick,onMouseDown:this._onMouseDown,onMouseMove:this._onMouseMove,onMouseUp:this._onMouseUp,onMouseOverCapture:this._onRegionMouseOver};return(0,A.jsx)(Qe.eB,{name:"richtext",tag:En,item:e,children:(0,A.jsx)(Qe.Sl,Object.assign({name:"container",mod:{canResizeSpans:Au.isActive(Au.FF_ADJUSTABLE_SPANS)},ref:t=>{e.mountNodeRef.current=t,t&&this.markObjectAsLoaded()},"data-linenumbers":o&&n.showLineNumbers?"enabled":"disabled",className:"htx-richtext",dangerouslySetInnerHTML:{__html:t}},i),"root")})}return(0,A.jsxs)(Qe.eB,{name:"richtext",tag:En,item:e,children:[(0,A.jsx)(Qe.Sl,{name:"loading",ref:this.loadingRef,children:(0,A.jsx)(Sr.A,{})}),(0,A.jsx)(Qe.Sl,{name:"iframe",tag:"iframe",referrerPolicy:"no-referrer",sandbox:"allow-same-origin allow-scripts",ref:t=>{e.setReady(!1),e.mountNodeRef.current=t},className:"htx-richtext",srcDoc:t,onLoad:this.onIFrameLoad},"root")]})}}const Zu=(0,v.WQ)("store"),qu=Zu((0,v.PA)(Gu)),Ju=({isText:e=!1}={})=>Zu((0,v.PA)((t=>(0,A.jsx)(qu,Object.assign({},t,{isText:e})))));b.addTag("text",Yu,Ju({isText:!0})),b.addTag("hypertext",Yu,Ju({isText:!1})),b.addObjectType(Yu);var Qu=n(45315);const eh=u.gK.model({type:"table",value:u.gK.maybeNull(u.gK.string),_value:u.gK.frozen([]),valuetype:u.gK.optional(u.gK.string,"json")}).views((e=>({get dataSource(){const{type:t}=C(e.valuetype);return"json"===t?Object.keys(e._value).sort(((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()))).map((t=>{let n=e._value[t];return"object"==typeof n&&(n=JSON.stringify(n)),{type:t,value:n}})):e._value},get columns(){return"json"!==e.valuetype&&e._value[0]?Object.keys(e._value[0]).map((e=>({title:e,dataIndex:e}))):[{title:"Name",dataIndex:"type"},{title:"Value",dataIndex:"value"}]}}))).actions((e=>({updateValue:(0,u.L3)((function*(t){const{type:n,options:o}=C(e.valuetype);let i=k(e.value,t.task.dataObj);if(o.url)try{const e=yield fetch(i),{ok:t,status:n,statusText:o}=e;if(!t)throw new Error(`${n} ${o}`);i=yield e.text()}catch(t){const n=(0,u._$)(e).messages.ERR_LOADING_HTTP({attr:e.value,error:String(t),url:i});e.annotationStore.addErrors([mr.generalError(n)])}if("csv"===n)Fe().parse(i,{delimiter:o.separator,header:!o.headless,download:!1,complete:({data:t})=>{e._value=t}});else e._value="string"==typeof i?JSON.parse(i):i}))}))),th=u.gK.compose("TableModel",Sn,Ue,Ne,eh),nh=(0,v.WQ)("store")((0,v.PA)((({item:e})=>(0,A.jsx)(Qu.A,{bordered:!0,dataSource:e.dataSource,columns:e.columns,pagination:{hideOnSinglePage:!0}}))));b.addTag("table",th,nh),b.addObjectType(th);var oh=n(46288);const ih=()=>(window.screen&&window.screen.width||1440)*(window.devicePixelRatio||2),sh=(e,t=1e6)=>{if(e.length<=t)return e;let n=0;const o=(e.length-1)/(t-1);return e.filter(((e,t)=>!(t<n)&&(n+=o,!0)))},rh=(e,t=1)=>{const n=(e.style||z.l).fillcolor;return sn.Colors.convertToRGBA(n,t)},ah=e=>!oh.f0J.sourceEvent||(e?oh.f0J.sourceEvent.type===e:["start","brush","end"].includes(oh.f0J.sourceEvent.type)),lh=e=>new Date(e).toUTCString(),dh=u.gK.model({}).views((()=>({get persistentValuesKey(){return"labelStudio:storedValues"},get persistentValues(){return{}}}))).actions((e=>({afterCreate(){setTimeout(e.restoreValues)},beforeDestroy(){e.storeValues()},storeValues(){var t;const n=e.persistentValuesKey,o={task:null==(t=(0,u.Zn)(e).task)?void 0:t.id,values:e.persistentValues};localStorage.setItem(n,JSON.stringify(o))},restoreValues(){var t;const n=JSON.parse(localStorage.getItem(e.persistentValuesKey)||"{}");if(!n||n.task!==(null==(t=(0,u.Zn)(e).task)?void 0:t.id))return;const o=n.values||{};for(const t of Object.keys(o))e[t]=o[t]}}))),ch=u.gK.model({legend:"",units:"",displayformat:u.gK.optional(u.gK.string,".1f"),interpolation:u.gK.optional(u.gK.enumeration(Object.values({curvebasis:"curvebasis",curvebasisopen:"curveBasisOpen",curvebundle:"curveBundle",curvecardinal:"curveCardinal",curvecardinalopen:"curveCardinalOpen",curvecatmullrom:"curveCatmullRom",curvecatmullromopen:"curveCatmullRomOpen",curvelinear:"curveLinear",curvemonotonex:"curveMonotoneX",curvemonotoney:"curveMonotoneY",curvenatural:"curveNatural",curveradial:"curveRadial",curvestep:"curveStep",curvestepafter:"curveStepAfter",curvestepbefore:"curveStepBefore"})),"curveStep"),height:u.gK.optional(u.gK.string,"200"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(u.gK.string,"#1f77b4"),markersize:u.gK.optional(u.gK.string,"0"),markercolor:u.gK.optional(u.gK.string,"#1f77b4"),markersymbol:u.gK.optional(u.gK.string,"circle"),datarange:u.gK.maybe(u.gK.string),timerange:u.gK.maybe(u.gK.string),showaxis:u.gK.optional(u.gK.boolean,!0),fixedscale:u.gK.maybe(u.gK.boolean),column:u.gK.string}),uh=u.gK.model("ChannelModel",Object.assign({},(0,j.VS)(j.cE)?{id:u.gK.identifier}:{id:u.gK.optional(u.gK.identifier,T)},{type:"channel",children:Le.unionArray(["channel","view"]),parentTypes:Le.tagsTypes(["TimeSeries"])})).views((e=>({get columnName(){let t=e.column;var n;/^\d+$/.test(t)&&(t=(null==(n=e.parent)?void 0:n.headers[t])||t);return t=t.toLowerCase(),t}}))),hh=u.gK.compose("ChannelModel",Ed,uh,ch);class gh extends m.Component{constructor(...e){super(...e),this.ref=m.createRef(),this.gCreator=void 0,this.brushCreator=void 0,this.gBrushes=void 0,this.tracker=void 0,this.trackerX=0,this.trackerPoint=void 0,this.trackerTime=void 0,this.trackerValue=void 0,this.extent=[0,0],this.useOptimizedData=!1,this.optimizedSeries=null,this.zoomStep=10,this.line=void 0,this.lineSlice=void 0,this.height=+this.props.item.height,this.state={width:840},this.changeWidth=()=>{const e=this.ref.current.offsetWidth,{margin:t}=this.props.item.parent;if(e){const n=e-t.left-t.right;this.setState({width:n})}},this.getRegion=(e,t)=>{const[n,o]=e.map((e=>+this.stick(e)[0]));return{start:n,end:t?n:o}},this.createBrushMovedHandler=e=>()=>{if(ah("end")||!oh.f0J.selection)return;const{ranges:t}=this.props,{parent:n}=this.props.item,o=t.findIndex((t=>t.id===e));if(o<0)return void console.error(`REGION ${e} was not found`);const i=t[o],s=this.getRegion(oh.f0J.selection,i.instant);s.start===i.start&&s.end===i.end?(null==n||n.annotation.unselectAreas(),i.onClickRegion(oh.f0J.sourceEvent)):null==n||n.regionChanged(s,o)},this.newRegion=void 0,this.newRegionTimer=void 0,this.newBrushHandler=()=>{var e;const{ranges:t,item:{parent:n}}=this.props,o=null==n?void 0:n.activeStates(),i=o&&o.length,s=null==n||null==(e=n.annotation)?void 0:e.isReadOnly();if(ah("end"))return;if(!oh.f0J.selection){const e=oh.grR(oh.f0J.sourceEvent.target)[0],s=this.newRegion;s&&Math.abs(s.x-e)<4?(clearTimeout(this.newRegionTimer),null==n||n.regionChanged(s.range,t.length,s.states),this.newRegion=null,this.newRegionTimer=null):i&&(this.newRegion={range:this.getRegion([e,e]),states:o.map((e=>Za(e))),x:e},this.newRegionTimer=setTimeout((()=>{this.newRegion=null,this.newRegionTimer=null}),300));const r=this.x.invert(e),a=t.filter((e=>e.start<=r&&e.end>=r)),l=a.findIndex((e=>e.selected))+1,d=a[l];return void(d?d.onClickRegion(oh.f0J.sourceEvent):null==n||n.annotation.unselectAreas())}const r=this.getRegion(oh.f0J.selection);this.brushCreator.move(this.gCreator,null);const a=oh.f0J.sourceEvent.ctrlKey||oh.f0J.sourceEvent.metaKey;if(a||!i||s){const e=t.filter((e=>e.start>=r.start&&e.end<=r.end));a?null==n||n.annotation.extendSelectionWith(e):null==n||n.annotation.selectAreas(e)}else null==n||n.addRegion(r.start,r.end)},this.updateTracker=(e,t=0)=>{const{width:n}=this.state;if(e<0||e>n)return;const[o,i]=this.stick(e);this.trackerX=o,this.tracker.attr("transform",`translate(${this.x(o)+.5},0)`),this.trackerTime.text(`${this.formatTime(o)}${0===t?"":` [${this.formatDuration(t)}]`}`),this.trackerValue.text(`${this.formatValue(i)} ${this.props.item.units}`),this.trackerPoint.attr("cy",this.y(i)),this.tracker.attr("text-anchor",e>n-100?"end":"start")},this.renderTracker=()=>{const e=this.updateTracker;this.tracker=this.main.append("g").style("pointer-events","none"),this.trackerValue=this.tracker.append("text").attr("font-size",10).attr("fill","#666"),this.trackerTime=this.tracker.append("text").attr("y",this.height-1).attr("font-size",10).attr("fill","#666"),this.trackerPoint=this.tracker.append("circle").attr("cx",0).attr("r",3).attr("stroke","red").attr("fill","none"),this.tracker.append("line").attr("y1",this.height).attr("y2",0).attr("stroke","#666"),this.main.on("mousemove",(function(){e(oh.grR(this)[0])}))},this.renderXAxis=()=>{const{item:e}=this.props;if(!e.showaxis)return;const{width:t}=this.state,{margin:n}=e.parent,o=this.height+n.top,i=-n.top;let s=this.main.select(".xaxis");s.size()||(s=this.main.append("g").attr("class","xaxis")),s.attr("transform",`translate(0,${i})`).call(oh.l78(this.x).ticks(t/80).tickSize(o+4)).call((e=>e.selectAll(".domain").remove())).call((e=>e.selectAll(".tick").attr("stroke-opacity",.2).selectAll(".bottom").data([0]).enter().append("line").attr("class","bottom").attr("stroke","currentColor").attr("y1",o+16).attr("y2",o+n.bottom)))},this.renderYAxis=()=>{const{item:e}=this.props;if(!e.showaxis)return;let t=this.main.select(".yaxis");t.size()||(t=this.main.append("g").attr("class","yaxis")),t.call(oh.V4s(this.y).tickFormat(this.formatValue).tickSize(3)).call((e=>e.select(".domain").remove())).call((e=>e.append("text").attr("class","title").attr("font-size",8).attr("x",-6).attr("y",0).attr("fill","currentColor").attr("text-anchor","end").text(this.props.item.units)))}}renderBrushes(e,t=!1){const{width:n}=this.state,o=this.height,{item:i}=this.props,s=[[0,0],[n,o]],r=oh.n55().extent(s),a=this.x;t&&this.gBrushes.selectAll(".brush").remove();const l=this.gBrushes.selectAll(".brush").data(e,(e=>e.id)),d=this.createBrushMovedHandler,c=this.updateTracker,u=this.getRegion;l.enter().append("g").attr("class","brush").attr("id",(e=>`brush_${i.id}_${e.id}`)).each((function(e){const t=oh.Ltv(this),n=oh.n55().extent(s);n.on("brush",(function(){if(ah("brush"))return;const n=u(oh.f0J.selection,e.instant);r.move(t,[a(n.start),a(n.end)+.5*e.instant]),c(oh.grR(this)[0])})),n.on("end",d(e.id)),n(t),e.instant?t.selectAll(".handle").style("pointer-events","none"):t.selectAll(".selection").style("pointer-events","none"),t.selectAll(".overlay").style("pointer-events","none"),e.isReadOnly()&&t.selectAll(".handle").remove(),void 0!==e._brushRef&&e._brushRef.isConnected||(e._brushRef=t.select(".selection").node())})).merge(l).each((function(e){const t=oh.Ltv(this),n=t.selectAll(".selection");t.style("display",e.hidden?"none":"block");const o=rh(e);if(e.instant){n.attr("stroke-opacity",e.inSelection||e.highlighted?.6:.2).attr("fill-opacity",e.inSelection||e.highlighted?1:.6).attr("stroke-width",3).attr("stroke",o).attr("fill",o);const i=a(e.start);r.move(t,[i,i+1])}else n.attr("stroke-opacity",e.inSelection||e.highlighted?.8:.5).attr("fill-opacity",e.inSelection||e.highlighted?.6:.3).attr("stroke",o).attr("fill",o),r.move(t,[e.start,e.end].map(a))})),l.exit().remove()}renderBrushCreator(){this.gCreator?this.gCreator.selectAll("*").remove():this.gCreator=this.main.append("g").attr("class","new_brush");const e=this.updateTracker,t=this.gCreator,n=this.getRegion,o=this.x,i=this.brushCreator=oh.n55().extent([[0,0],[this.state.width,this.height]]).on("brush",(function(){if(ah("brush")||!oh.f0J.selection)return;const s=n(oh.f0J.selection);i.move(t,[o(s.start),o(s.end)]),e(oh.grR(this)[0],s.end-s.start)})).on("end",this.newBrushHandler).filter((()=>!oh.f0J.button));this.gCreator.call(this.brushCreator)}initZoom(){var e;const{data:t,item:n,time:o}=this.props,i=t[o],s=null==(e=n.parent)?void 0:e.throttledRangeUpdate();this.main.on("wheel",(()=>{const e=oh.f0J;if(!e.ctrlKey&&!e.metaKey)return;e.preventDefault();const{range:t}=this.props,n=t.map((e=>oh.Jjl(i,e))),[o]=oh.grR(oh.f0J.target),r=this.x.range()[1],a=Math.min(.3,-e.deltaY/this.height);if(n[1]-n[0]<10&&a>0)return;const l=t[1]-t[0],d=[Math.max(+this.extent[0],+t[0]+l*a*o/r),Math.min(+this.extent[1],t[1]-l*a*(1-o/r))];s(d,a)}))}componentDidMount(){var e;if(!this.ref.current)return;const t="Dark"===(0,Qn.j17)(),{data:n,item:o,range:i,time:s,column:r}=this.props,{isDate:a,formatTime:l,formatDuration:d,margin:c,slicesCount:h}=o.parent,g=this.height;this.zoomStep=h;const m=`marker_${o.id}`,p=`clip_${o.id}`;let{series:f}=this.props;const v=ih()*this.zoomStep;this.useOptimizedData=f.length>v;const y=f.filter((e=>null!==e[r])),b=y.map((e=>e[s]));this.useOptimizedData&&(this.optimizedSeries=sh(f,v),f=this.optimizedSeries),f=f.filter((e=>null!==e[r])),this.optimizedSeries&&(this.optimizedSeries=f);const x=f.map((e=>e[s])),S=f.map((e=>e[r]));if(!S){const e=Object.keys(n).filter((e=>e!==s)),t=`\`${r}\` not found in data. Available columns: ${e.join(", ")}. For headless csv you can use column index`;return void(0,u.Zn)(o).annotationStore.addErrors([mr.generalError(t)])}this.slices=null==(e=o.parent)?void 0:e.dataSlices;const w=oh.GPZ(o.displayformat);this.formatValue=w,this.formatTime=l,this.formatDuration=d;const k=this.ref.current.offsetWidth,C=k?k-c.left-c.right:this.state.width;this.state.width=C,this.extent=oh.Xxv(x);const j=(a?oh.Pps():oh.m4Y()).domain(this.extent).range([0,C]),R=oh.m4Y().domain(oh.Xxv(S)).range([g-c.max,c.min]);this.x=j,this.y=R,this.plotX=j.copy(),this.stick=e=>{const t=j.invert(e),n=b;let o=oh.Jjl(n,t,0,n.length-1);return n[o]-t>t-n[o-1]&&o--,[n[o],y[o][r]]},this.line=oh.n8j().y((e=>this.y(e[r]))).x((e=>this.plotX(e[s]))),this.lineSlice=oh.n8j().defined((e=>e[s]>=i[0]&&e[s]<=i[1])).y((e=>this.y(e[r]))).x((e=>this.x(e[s])));const _=oh.Ltv(this.ref.current).append("svg").attr("viewBox",[0,0,C+c.left+c.right,g+c.top+c.bottom]).style("display","block").append("g").attr("transform",`translate(${c.left},${c.top})`);((e,t,n,o)=>{switch(t){case"circle":e.append("path").attr("d",oh.HRO().type(oh.hKN).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",o);break;case"square":e.append("path").attr("d",oh.HRO().type(oh.yDW).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",o);break;case"triangle":case"triangleUp":e.append("path").attr("d",oh.HRO().type(oh.ZKi).size(2*n)).attr("transform",`translate(${n/2}, ${n/2})`).attr("stroke","none").attr("fill",o);break;case"triangleDown":e.append("path").attr("d",oh.HRO().type(oh.ZKi).size(2*n)).attr("transform",`translate(${n/2}, ${n/2}) rotate(180 0 0)`).attr("stroke","none").attr("fill",o)}})(_.append("defs").append("marker").attr("id",m).attr("markerWidth",o.markersize).attr("markerHeight",o.markersize).attr("refX",o.markersize/2).attr("refY",o.markersize/2),o.markersymbol,o.markersize,o.markercolor),_.append("clipPath").attr("id",p).append("rect").attr("x",0).attr("y",0).attr("height",g).attr("width",C),_.append("text").text(o.legend).attr("fill",t?"red":"black").attr("dx","1em").attr("dy","1em").attr("font-weight","bold").attr("font-size","1.4em").attr("dy","1em").attr("opacity",.1),this.main=_;const T=_.append("g").attr("clip-path",`url("#${p}")`);this.path=T.append("path").datum(f).attr("d",this.line),this.path2=T.append("path"),T.selectAll("path").attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("stroke-width",o.strokewidth||1).attr("stroke",o.strokecolor||"steelblue").attr("marker-start",o.markersize>0?`url(#${m})`:"").attr("marker-mid",o.markersize>0?`url(#${m})`:"").attr("marker-end",o.markersize>0?`url(#${m})`:""),this.renderTracker(),this.updateTracker(0),this.renderYAxis(),this.setRangeWithScaling(i),this.renderBrushCreator(),this.initZoom(),this.gBrushes=_.append("g").attr("class","brushes").attr("clip-path",`url("#${p}")`),this.renderBrushes(this.props.ranges),window.addEventListener("resize",this.changeWidth)}componentWillUnmount(){window.removeEventListener("resize",this.changeWidth)}setRangeWithScaling(e){var t;this.x.domain(e);const n=this.x.range(),o=this.plotX.domain().map(this.x),i=(o[1]-o[0])/(n[1]-n[0]),s=Math.max(0,Math.floor(this.zoomStep*(n[0]-o[0])/(o[1]-o[0]))),r=Math.max(0,Math.floor(this.zoomStep*(n[1]-o[0])/(o[1]-o[0]))),a=o[0]-n[0];let l=0,d=1;const c=this.y.range()[0],{item:u}=this.props,h=void 0===u.fixedscale?null==(t=u.parent)?void 0:t.fixedscale:u.fixedscale;if(u.timerange){const e=u.timerange.split(",").map(Number);this.x.domain(e)}if(!h){const{data:t,time:n,column:o}=this.props,i=t[o];let s=oh.Jjl(t[n],e[0]);const r=oh.Jjl(t[n],e[1]);let a=i[s],c=i[s];for(;s<r;s++)a>i[s]&&(a=i[s]),c<i[s]&&(c=i[s]);if(u.datarange){const e=u.datarange.split(",");""!==e[0]&&(a=new Number(e[0])),""!==e[1]&&(c=new Number(e[1]))}const h=oh.Xxv(i).reduce(((e,t)=>t-e));d=h/(c-a),l=a/h,this.y.domain([a,c])}const g=i>this.zoomStep===this.useOptimizedData;this.optimizedSeries&&g&&(this.useOptimizedData=!this.useOptimizedData,this.useOptimizedData?(this.path.datum(this.optimizedSeries),this.path.attr("d",this.line)):this.path.attr("transform","")),this.useOptimizedData?(this.path.attr("transform",`translate(${a} ${l}) scale(${i} ${d})`),this.path.attr("transform-origin",`left ${c}`),this.path2.attr("d","")):this.optimizedSeries?(this.path.datum(this.slices[s]),this.path.attr("d",this.lineSlice),s!==r&&this.slices[r]?(this.path2.datum(this.slices[r]),this.path2.attr("d",this.lineSlice)):this.path2.attr("d","")):(this.path.attr("d",this.lineSlice),this.path2.attr("d","")),this.renderXAxis(),this.renderYAxis(),this.updateTracker(this.x(this.trackerX))}componentDidUpdate(e,t){const{range:n}=this.props,{width:o}=this.state;let i=!1;if(o!==t.width){const{item:e,range:t}=this.props,{margin:n}=e.parent,s=this.height,r=oh.Ltv(this.ref.current).selectAll("svg");r.attr("viewBox",[0,0,o+n.left+n.right,s+n.top+n.bottom]),this.x.range([0,o]),this.renderBrushCreator(),r.selectAll("clipPath rect").attr("width",o),this.setRangeWithScaling(t),this.renderBrushCreator(),i=!0}else{const e=this.x.domain();+e[0]==+n[0]&&+e[1]==+n[1]||this.setRangeWithScaling(n)}this.renderBrushes(this.props.ranges,i)}render(){return this.props.ranges.map((e=>{var t;return(0,x.fixMobxObserve)(e.start,e.end,e.selected,e.inSelection,e.highlighted,e.hidden,null==(t=e.style)?void 0:t.fillcolor)})),(0,x.fixMobxObserve)(this.props.range.map(Number)),(0,A.jsx)("div",{className:"htx-timeseries-channel",ref:this.ref})}}const mh=(0,v.PA)(gh),ph=(0,v.PA)((({item:e})=>{var t,n,o,i,s,r;return null!=(t=e.parent)&&t.dataObj?(0,A.jsx)(mh,{time:null==(n=e.parent)?void 0:n.keyColumn,column:e.columnName,item:e,data:null==(o=e.parent)?void 0:o.dataObj,series:null==(i=e.parent)?void 0:i.dataHash,range:null==(s=e.parent)?void 0:s.brushRange,ranges:null==(r=e.parent)?void 0:r.regs}):null}));b.addTag("channel",hh,ph);const fh=u.gK.model({value:u.gK.string,valuetype:u.gK.optional(u.gK.enumeration(["url","json"]),"url"),timecolumn:"",sep:",",timeformat:"",timedisplayformat:"",durationdisplayformat:".0f",overviewchannels:"",overviewwidth:"25%",fixedscale:!1,multiaxis:u.gK.optional(u.gK.boolean,!1),hotkey:u.gK.maybeNull(u.gK.string)}),vh=u.gK.model("TimeSeriesModel",{type:"timeseries",children:Le.unionArray(["channel","timeseriesoverview","view","hypertext"]),width:840,margin:u.gK.frozen({top:20,right:20,bottom:30,left:50,min:10,max:10}),brushRange:u.gK.array(u.gK.number),_needsUpdate:u.gK.optional(u.gK.number,0)}).volatile((()=>({data:null,valueLoaded:!1,zoomedRange:0,scale:1,headers:[]}))).views((e=>({get regionsTimeRanges(){return e.regs.map((e=>[e.start,e.end]))},get defaultOverviewWidth(){var t,n;return[0,Math.min(null!=(t=null==(n=e.overviewwidth.match(/(\d+)%$/))?void 0:n[1])?t:25,100)/100]},get store(){return(0,u.Zn)(e)},get isDate(){return Boolean(e.timeformat)||e.timedisplayformat&&/[a-zA-Z]/.test(e.timedisplayformat[0])},get keyColumn(){return(e.timecolumn||"#@$").toLowerCase()},get parseTimeFn(){return e.timeformat&&e.timecolumn?oh.GYh(e.timeformat):Number},parseTime(t){const n=(0,e.parseTimeFn)(t);return n instanceof Date?n.getTime():n},get dataObj(){if(!e.valueLoaded||!e.data)return null;let t=e.data;if(e.timecolumn){if(!e.timeformat&&isNaN(t[e.keyColumn][0])){const n=[`Looks like your <b>timeColumn</b> (${e.timecolumn}) contains non-numbers.`,"You have to use <b>timeFormat</b> parameter if your values are datetimes.",`First wrong values: ${t[e.keyColumn].slice(0,3).join(", ")}`,`<a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html#Parameters" target="_blank">Read Documentation</a> for details.`];throw new Error(n.join("<br/>"))}{let n=0,o=Number.NEGATIVE_INFINITY;const i=t[e.keyColumn].length,s=Array.from({length:i});for(let r=0;r<i;r++){const i=t[e.keyColumn][r];if(n=e.timeformat?e.parseTime(i):i,s[r]=n,n<o){const n=[`seq: ${r-1}, value: ${t[e.keyColumn][r-1]}`,`seq: ${r}, value: ${i}`];throw new Error([`<b>timeColumn</b> (${e.timecolumn}) must be incremental and sequentially ordered.`,`First wrong values: ${n.join(", ")}`,`<br/><a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html" target="_blank">Read Documentation</a> for details.`].join("<br/>"))}o=n}if(0===s[0]&&0===s[1]&&0===s[2]){const n=[`<b>timeColumn</b> (${e.timecolumn}) cannot be parsed.`,`First wrong values: ${t[e.keyColumn].slice(0,3).join(", ")}`];throw e.timeformat?n.push(`Your <b>timeFormat</b>: ${e.timeformat}. It should be compatible with these values.`):n.push("You have to use <b>timeFormat</b> parameter if your values are datetimes."),n.push(`<br/><a href="${(0,u._$)(e).messages.URL_TAGS_DOCS}/timeseries.html#Parameters" target="_blank">Read Documentation</a> for details.`),new Error(n.join("<br/>"))}t=Object.assign({},t,{[e.keyColumn]:s})}}else{const n=Object.values(t)[0],o=Array.from({length:n.length},((e,t)=>t));t=Object.assign({},t,{[e.keyColumn]:o})}return t},get dataHash(){const t=e.dataObj,{keyColumn:n}=e;if(!t)return null;const o=Object.keys(t),i=[];for(const s of o)for(let o=0;o<t[s].length;o++)i[o]?i[o][s]=t[s][o]:i[o]={[s]:t[s][o]},e.timecolumn||(i[o][n]=o);return i},get slicesCount(){return 10},get dataSlices(){if(e.slices)return e.slices;const t=e.slicesCount,n=e.dataHash,o=Math.floor(n.length/t),i=[];for(let e=0;e<t-1;e++)i[e]=n.slice(o*e,o*e+o+1);return i.push(n.slice(o*(t-1))),e.slices=i,i},get keysRange(){var t;const n=null==(t=e.dataObj)?void 0:t[e.keyColumn];return null!=n&&n.length?[n[0],n[n.length-1]]:[]},get persistentValues(){return{brushRange:e.brushRange,initialRange:e.initialRange,scale:e.scale+1e-4}},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter((e=>e.isSelected&&"TimeSeriesLabelsModel"===(0,u.Pw)(e).name)):null},formatTime(t){if(!e._format){const{timedisplayformat:t,isDate:n}=e;e._format="date"===t?lh:t?n?oh.aLc(t):oh.GPZ(t):String}return e._format(t)},formatDuration(t){if(!e._formatDuration){const{durationdisplayformat:t,isDate:n}=e;e._formatDuration=t?n?oh.aLc(t):oh.GPZ(t):String}return e._formatDuration(t)}}))).actions((e=>({setData(t){e.data=t,e.valueLoaded=!0},setColumnNames(t){e.headers=t},setZoomedRange(t){e.zoomedRange=t},setScale(t){e.scale=t},updateView(){e._needsUpdate=e._needsUpdate+1},scrollToRegion(t){const n=[...e.brushRange];if(t.start>=n[0]&&t.end<=n[1])return;const o=n[1]-n[0],i=t.end-t.start,s=1.5*i,r=(s-i)/2;if(o<s){const e=(s-o)/2;n[0]-=e,n[1]+=e}t.start<n[0]&&(n[1]-=n[0]-(t.start-r),n[0]=t.start-r),t.end>n[1]&&(n[0]+=t.end+r-n[1],n[1]=t.end+r),n[0]=Math.max(e.keysRange[0],n[0]),n[1]=Math.min(e.keysRange[1],n[1]),e.updateTR(n,e.scale+1e-4)},updateTR(t,n=1){null!==t&&(e.initialRange=t,e.brushRange=t,e.setZoomedRange(t[1]-t[0]),e.setScale(n),e.updateView())},throttledRangeUpdate:()=>On()(e.updateTR,100),addRegion(t,n){const o=e.getAvailableStates();if(0===o.length)return;const i=o[0],s={[i.valueType]:i.selectedValues()};return e.annotation.createResult({start:t,end:n,instant:t===n},s,i,e)},regionChanged(t,n,o){const i=e.regs[n];let s=!1;if(i)s=i.start!==t.start||i.end!==t.end,i.updateRegion(t.start,t.end);else{s=!0,e.addRegion(t.start,t.end,o).notifyDrawingFinished()}s&&e.updateView()},async preloadValue(t){const n=t.task.dataObj;if("url"!==e.valuetype)return void(e.value?e.setData(k(e.value,n)):e.setData(n));if(!e.value){const n=`Attribute <b>value</b> for <b>${e.name}</b> should be provided when <b>valuetype="url"</b>`;return void t.annotationStore.addErrors([mr.generalError(n)])}const o=k(e.value,n);if(!o||"string"!=typeof o){const n=`Cannot find url in <b>${i=e.value,i.substr(1)}</b> field of your task`;return void t.annotationStore.addErrors([mr.generalError(n)])}var i;let s,r="",a=!1;try{if(s=await fetch(o),!s.ok){if(400===s.status)return void t.annotationStore.addErrors([mr.loadingError(`${s.status} ${s.statusText}`,o,e.value,(0,u._$)(t).messages.ERR_LOADING_S3)]);throw new Error(`${s.status} ${s.statusText}`)}r=await s.text()}catch(n){let i=n;if(!s)try{s=await fetch(o,{mode:"no-cors"}),s.ok||0!==s.status||(a=!0)}catch(e){i=e}return void t.annotationStore.addErrors([mr.loadingError(i,o,e.value,a?(0,u._$)(t).messages.ERR_LOADING_CORS:void 0)])}try{let n=(e=>{if((0,x.isString)(e)&&"{"===e[0])try{return JSON.parse(e)}catch(e){}return!1})(r),o=[];if(!n){var l;let t=e.sep;if((null==(l=t)?void 0:l.length)>1){t={tab:"\t","\\t":"\t",space:" ",auto:"auto",comma:",",dot:"."}[t]||t[0]}[n,o]=((e,t="auto")=>{const n=e.split("\n");let o;if("auto"!==t&&!n[0].includes(t))throw new Error([`Cannot find provided separator "${t}".`,`Row 1: ${n[0]}`].join("\n"));if("auto"===t&&n.length>1){const e=n[1].trim().match(/[,;\s\t]/g);if(!e.length)throw new Error("No separators found");if(e.some((t=>t!==e[0]))){const t=Array.from(new Set(e)).map(x.escapeHtml).map((e=>`"${e}"`)).join(", ");throw new Error([`More than one possible separator found: ${t}`,'You can provide correct one with <Timeseries sep=",">'].join("\n"))}if(t=e[0],n[0].split(t).length!==n[1].split(t).length)throw new Error(["Different amount of elements in rows.",`Row 1: ${n[0]}`,`Row 2: ${n[1]}`,`Guessed separator: ${t}`,'You can provide correct one with <Timeseries sep=",">'].join("\n"))}const i=new RegExp(['"(?:""|[^"])*"',`[^"${t}]+`,`(?=${t}(?:${t}|$))`,`^(?=${t})`].join("|"),"g"),s=e=>e.trim().match(i);o=s(n[0]);const r=s(n[1]);o.every(((e,t)=>isNaN(e)===isNaN(r[t])))?o=o.map(((e,t)=>String(t))):(n.shift(),o=o.map((e=>e.toLowerCase())));const a={};for(const e of o)a[e]=[];if(o.length!==s(n[0]).length)throw new Error(["Column names count differs from data columns count.",`Columns: ${o.join(", ")};`,`Data: ${n[0]};`,`Separator: "${t}".`].join("\n"));let l,d;for(const e of n)if(e.trim())for(l=s(e),d=0;d<l.length;d++){const e=+l[d];a[o[d]].push(isNaN(e)?l[d]:e)}return[a,o]})(r,t)}if(!(0,u._n)(e))return;e.setData(n),e.setColumnNames(o),e.updateValue(t)}catch(e){const n=`Problems with parsing CSV: ${(null==e?void 0:e.message)||e}<br>URL: ${o}`;t.annotationStore.addErrors([mr.generalError(n)])}},async updateValue(t){var n;let o;try{e.dataObj||await e.preloadValue(t),o=e.dataObj}catch(e){return void t.annotationStore.addErrors([mr.generalError(e.message)])}if(!o)return;const i=o[e.keyColumn];if(!i){const n=[`<b>${e.keyColumn}</b> not found in data.`,'Use <b>valueType="url"</b> for data loading or column index for headless csv'].join(" ");return void t.annotationStore.addErrors([mr.generalError(n)])}if(null!=(n=e.brushRange)&&n.length)return;const s=e.defaultOverviewWidth.map((e=>i[Math.round((i.length-1)*e)]));e.updateTR(s)},onHotKey(){}})));const yh=(0,v.PA)((({item:e,data:t,series:n})=>{const o=e.regs,[i,s,r]=function(){const[e,t]=m.useState(840),[n,o]=m.useState(null),i=m.useCallback((e=>{o(e)}),[]);return m.useLayoutEffect((()=>{if(n){const e=()=>t(n.offsetWidth);return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}}),[n]),[i,e,n]}(),a=60,{margin:l,keyColumn:d}=e,c=Math.max(s-l.left-l.right,0);let u=e.children.map((e=>e.columnName));if(e.overviewchannels){const t=e.overviewchannels.toLowerCase().split(",").map((t=>/^\d+$/.test(t)?e.headers[t]:t)).filter((e=>u.includes(e)));t.length&&(u=t)}const h=m.useRef(),g=m.useRef(),p=m.useRef(),f=m.useRef(),v=m.useRef(),y=(e.isDate?oh.w7C():oh.m4Y()).domain(oh.Xxv(t[d])).range([0,c]),b=m.useCallback(e.throttledRangeUpdate(),[]),S=[0,c>>2],w=m.useRef(S),k=10;let C;const j=oh.n55().extent([[0,0],[c,a]]).on("start",(function(){const[e,t]=oh.f0J.selection;C=e===t?e:null})).on("brush",(function(){if(oh.f0J.selection&&!ah("brush")&&!ah("wheel")){let[t,n]=oh.f0J.selection;const o=w.current,i=n-t;let s=+y.invert(t),r=+y.invert(n);if(o[0]===t&&o[1]===n);else if(o[0]!==t&&o[1]!==n&&Math.abs(i-k)<.001){const t=(s+r)/2;s=t-e.zoomedRange/2,r=t+e.zoomedRange/2}else i<k&&(o[0]!==t&&o[1]!==n&&(o[0]===n||o[1]===t?[o[0],o[1]]=[o[1],o[0]]:t===C?(n=Math.min(c,t+k),t=Math.max(0,n-k)):(t=Math.max(0,n-k),n=Math.min(c,t+k))),o[0]===t?(n=Math.min(c,t+k),t=Math.max(0,n-k)):o[1]===n&&(t=Math.max(0,n-k),n=Math.min(c,t+k)),s=+y.invert(t),r=+y.invert(n),v.current.call(j.move,[t,n]));w.current=[t,n],b([s,r])}})).on("end",(function(){if(!oh.f0J.selection){const t=oh.grR(this)[0],n=e.brushRange.map(y),o=n[1]-n[0]>>1;let i=[t-o,t+o];i[0]<0&&(i=[0,2*o]),i[1]>c&&(i=[c-2*o,c]),v.current.call(j.move,i)}})),R=o=>{const i=e.children.find((e=>e.columnName===o)),s=i?i.strokecolor:"steelblue",r=oh.m4Y().domain([oh.jkA(t[o]),oh.T9B(t[o])]).range([a-l.max,l.min]);p.current.append("path").datum(sh(n,ih())).attr("class","channel").attr("fill","none").attr("stroke",s).attr("d",oh.n8j().y((e=>r(e[o]))).defined((e=>e[d])).x((e=>y(e[d]))))};return m.useEffect((()=>{r&&(h.current=oh.Ltv(r).append("svg").attr("viewBox",[0,0,c+l.left+l.right,a+l.bottom]).style("display","block").append("g").attr("transform",`translate(${l.left},0)`),f.current=h.current.append("g").attr("transform","translate(0,60)"),p.current=h.current.append("g").attr("class","channels"),g.current=h.current.append("g").attr("class","regions"),v.current=h.current.append("g").call(j).call(j.move,S),v.current.select(".handle--w").style("transform","translate(-1px, 0)"),v.current.select(".handle--e").style("transform","translate(1px, 0)"))}),[r]),m.useEffect((()=>{if(r){oh.Ltv(r).selectAll("svg").attr("viewBox",[0,0,c+l.left+l.right,a+l.bottom]),p.current.selectAll("path").remove();for(const e of u)R(e);f.current.call(oh.l78(y).ticks(c/80).tickSizeOuter(0)),v.current.call(j).call(j.move,e.brushRange.map(y))}}),[c,r]),m.useEffect((()=>{if(!v.current)return;const t=e.brushRange.map(y);if(t[1]-t[0]<k){const e=(t[1]+t[0])/2;t[0]=Math.max(0,e-5),t[1]=Math.min(c,e+5)}w.current=t,v.current.call(j.move,t)}),[e.scale]),m.useEffect((()=>{r&&(e=>{const t=g.current.selectAll(".region").data(e);t.enter().append("rect").attr("class","region").merge(t).attr("y",0).attr("height",a).attr("x",(e=>y(e.start))).attr("width",(e=>Math.max(2,y(e.end)-y(e.start)))).attr("fill",(e=>rh(e,e.selected?.8:.3))).style("display",(e=>e.hidden?"none":"block")),t.exit().remove()})(o)})),e.regs.map((e=>{var t;return(0,x.fixMobxObserve)(e.start,e.end,e.selected,e.hidden,null==(t=e.style)?void 0:t.fillcolor)})),(0,A.jsx)("div",{className:"htx-timeseries-overview",ref:i})})),bh=u.gK.compose("TimeSeriesModel",Sn,dh,Ne,fh,vh),xh=(0,v.WQ)("store")((0,v.PA)((({item:e})=>{var t;const n=m.createRef();return m.useEffect((()=>{var t;null!=e&&null!=(t=e.brushRange)&&t.length&&(e._nodeReference=n.current)}),[e,n]),null!=e&&null!=(t=e.brushRange)&&t.length&&e.data?(0,A.jsx)("div",{ref:n,className:"htx-timeseries",children:(0,A.jsxs)(En,{item:e,children:[L.renderChildren(e,e.annotation),(0,A.jsx)(yh,{data:e.dataObj,series:e.dataHash,item:e,range:e.brushRange})]})}):(0,A.jsx)("div",{style:{textAlign:"center",height:100},children:(0,A.jsx)(f.A,{size:"large",delay:300})})})));b.addTag("timeseries",bh,xh),b.addObjectType(bh);const Sh=u.gK.model({id:u.gK.identifier,type:"pagedview",children:Le.unionArray(["view","header","labels","label","table","taxonomy","choices","choice","collapse","datetime","number","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","magicwand","rectanglelabels","ellipselabels","polygonlabels","keypointlabels","brushlabels","hypertextlabels","timeserieslabels","text","audio","image","hypertext","richtext","timeseries","audioplus","list","dialog","textarea","pairwise","style","label","relations","filter","timeseries","timeserieslabels","pagedview","paragraphs","paragraphlabels","video","videorectangle"])}),wh=u.gK.compose("PagedViewModel",Sh,Ne),kh="view_page",Ch=go("Repeater"),jh=`.${(0,Qe.cn)("sidepanels").elem("content").toClassName()}`,Rh=[1,5,10,25,50,100],_h=()=>{const e=new URLSearchParams(window.location.search).get(kh);return e?Number.parseInt(e):1};let Th=null;const Ah=(e,t=null)=>{const n=new URLSearchParams(window.location.search),o=Th&&t!==Th;Th=t,o?n.delete(kh):1!==e?n.set(kh,e.toString()):n.delete(kh),window.history.replaceState(void 0,void 0,`${window.location.pathname}?${n}`)},Kh=(0,v.PA)((({item:e})=>{const[t,n]=(0,m.useState)(_h),[o,i]=(0,m.useState)(1),s=(0,m.useCallback)((t=>{var o;n(t),Ah(t,null==(o=e.annotationStore)||null==(o=o.store)?void 0:o.task.id)}),[]),r=Math.ceil(e.children.length/o);(0,m.useEffect)((()=>{i(((e,t)=>{const n=localStorage.getItem(`pages:${e}`);return n?Number.parseInt(n):null!=t?t:void 0})("repeater",1))}),[]),(0,m.useEffect)((()=>{const t=e.annotation.lastSelectedRegion;if(t){const e=Number.parseFloat(t.object.name.split("_")[1])+1;s(Math.ceil(e/o))}}),[e.annotation.lastSelectedRegion]),(0,m.useEffect)((()=>{var e;return null==(e=document.querySelector(jh))||e.scrollTo(0,0),setTimeout((()=>{Ch.addNamed("repeater:next-page",(()=>{t<r&&s(t+1)})),Ch.addNamed("repeater:previous-page",(()=>{t>1&&s(t-1)}))})),()=>{Ch.removeNamed("repeater:next-page"),Ch.removeNamed("repeater:previous-page")}}),[t]),(0,m.useEffect)((()=>{var t;return Ah(_h(),null==(t=e.annotationStore)||null==(t=t.store)?void 0:t.task.id),()=>{var t;Ah(1,null==(t=e.annotationStore)||null==(t=t.store)?void 0:t.task.id)}}),[]);const a=(0,m.useCallback)((()=>{const n=[];for(let i=0;i<o;i++)n.push(L.renderChildren(e.children[i+o*(t-1)],e.annotation));return n}),[t,o]);return(0,A.jsxs)("div",{children:[a(),(0,A.jsx)(_r,{currentPage:t,totalPages:r,pageSize:o,pageSizeOptions:Rh,pageSizeSelectable:!1,size:"medium",onChange:(t,n=o)=>{e.annotation.unselectAll(),s(t),n!==o&&(((e,t)=>{localStorage.setItem(`pages:${e}`,t.toString())})("repeater",n),i(n))}})]})}));b.addTag("pagedview",wh,Kh);const Eh=e=>{"webkitRequestFullscreen"in e?e.webkitRequestFullscreen():e.requestFullscreen()},Ph=()=>{"webkitCancelFullScreen"in document?document.webkitCancelFullScreen():document.exitFullscreen()},Mh=()=>{var e;return null!=(e=document.webkitCurrentFullScreenElement)?e:document.fullscreenElement},Dh=(e={},t)=>{const n=(0,m.useRef)(e);return(0,m.useEffect)((()=>{n.current=e}),[e,...null!=t?t:[]]),(0,m.useEffect)((()=>{const e=()=>{Mh()?null==n.current.onEnterFullscreen||n.current.onEnterFullscreen():null==n.current.onExitFullscreen||n.current.onExitFullscreen()},t="onwebkitfullscreenchange"in document?"webkitfullscreenchange":"fullscreenchange";return document.addEventListener(t,e),()=>{document.removeEventListener(t,e)}}),[]),{getElement:Mh,enter:Eh,exit:Ph,setHandlers(e={}){n.current=e}}};var Oh=n(93784),Ih=n(6901);const Lh=m.createContext(null),Nh=["animated","visible"];let zh=1;const Vh=(0,m.forwardRef)(((e,t)=>{var n;let{animated:o=!0,visible:i=!1}=e,s=(0,Zn.A)(e,Nh);const r=(0,Qe.cn)("dropdown"),a=(0,m.useRef)(),{triggerRef:l,minIndex:d}=null!=(n=(0,m.useContext)(Lh))?n:{},c=void 0===l,{children:u}=s,[g,p]=(0,m.useState)(i),[f,v]=(0,m.useState)({}),[y,b]=(0,m.useState)(i?"visible":null),x=(0,m.useCallback)((()=>{var e;const t=a.current,n=null!=(e=null==l?void 0:l.current)?e:t.parentNode,{left:o,top:i}=(0,Oh.N)(n,t,s.alignment||"bottom-left");v({left:o,top:i})}),[l,d]),S=(0,m.useMemo)((()=>zh++),[]),w=(0,m.useCallback)((async(e=!1,t)=>{if(!1!==s.enabled||!0!==e)return new Promise((n=>{const i=a.current;if(!1===o||!0===t)return b(e?"visible":null),void n();(0,Ih.P)(i,{transition:()=>{b(e?"appear":"disappear")},beforeTransition:()=>{b(e?"before-appear":"before-disappear")},afterTransition:()=>{b(e?"visible":null),n()}})}))}),[o]),k=(0,m.useCallback)((async(e,t)=>{const n=null!=e?e:!g;g!==n&&(null==s.onToggle||s.onToggle(n),await w(n,t),p(n))}),[g,w,s.onToggle]),C=(0,m.useCallback)((async e=>{await k(!1,e)}),[k]),R=(0,m.useCallback)((async e=>{await k(!0,e)}),[k]);Dh({onEnterFullscreen:()=>C(!0),onExitFullscreen:()=>C(!0)},[]),(0,m.useEffect)((()=>{k(!1)}),[c]),(0,m.useEffect)((()=>{if(!t)return;const e={dropdown:a.current,visible:null!==y,toggle:k,open:R,close:C};t instanceof Function?t(e):t.current=e}),[C,R,t,k,a,y]),(0,m.useEffect)((()=>{p(i)}),[i]),(0,m.useEffect)((()=>{c||"before-appear"!==y||x()}),[y,x,c]),(0,m.useEffect)((()=>{!1===s.enabled&&w(!1)}),[s.enabled]),(0,m.useEffect)((()=>{i?R():C()}),[i]);const _=(0,m.useMemo)((()=>{const e=u;return e.props&&"Menu"===e.props.type?(0,m.cloneElement)(e,Object.assign({},e.props,{className:r.elem("menu").mix(e.props.className)})):u}),[u]),T=(0,m.useMemo)((()=>{switch(y){case"before-appear":return"before-appear";case"appear":return"appear before-appear";case"before-disappear":return"before-disappear";case"disappear":return"disappear before-disappear";case"visible":return"visible";default:return i?"visible":null}}),[y,i]),K=(0,m.useMemo)((()=>{var e;return Object.assign({},null!=(e=s.style)?e:{},null!=f?f:{},{zIndex:(null!=d?d:1e3)+S})}),[s.style,S,d,f]),E=(0,A.jsx)(Qe.eB,{ref:a,name:"dropdown","data-testid":s.dataTestId,mix:[s.className,T],style:Object.assign({},K,{borderRadius:(0,j.VS)(j.bA)&&4}),onClick:e=>e.stopPropagation(),children:_});return!0===s.inline?E:(0,h.createPortal)(E,document.body)}));Vh.displayName="Dropdown";const Hh=["tag","children","content","toggle","closeOnClickOutside","disabled"],Bh=(0,m.forwardRef)(((e,t)=>{var n;let{tag:o,children:i,content:s,toggle:r,closeOnClickOutside:a=!0,disabled:l=!1}=e,d=(0,Zn.A)(e,Hh);const c=null!=t?t:(0,m.useRef)(),u=m.Children.only(i),h=(0,m.useRef)(new Set),[g,p]=(0,m.useState)(1e3),f=(0,m.useRef)(null==u||null==(n=u.props)||null==(n=n.ref)?void 0:n.current),v=(0,m.useContext)(Lh),y=(0,m.useCallback)((e=>{var t,n;const o=null==(t=f.current)||null==t.contains?void 0:t.contains(e),i=null==(n=c.current)||null==(n=n.dropdown)||null==n.contains?void 0:n.contains(e),s=Array.from(h.current).reduce(((t,n)=>t||n.hasTarget(e)),!1);return o||i||s}),[f,c]),b=(0,m.useCallback)((e=>{var t;a&&(y(e.target)||null==(t=c.current)||null==t.close||t.close())}),[a,y]),x=(0,m.useCallback)((e=>{var t,n,o;if(l)return;return(null==(t=c.current)||null==(t=t.dropdown)||null==t.contains?void 0:t.contains(e.target))?e.stopPropagation():!1===r?null==c||null==(n=c.current)?void 0:n.open():void(null==c||null==(o=c.current)||o.toggle())}),[c,l]),S=(0,m.useMemo)((()=>Object.assign({},u.props,{tag:o,key:"dd-trigger",ref:e=>{var t;f.current=null!=(t=f.current)?t:e,f.current&&p(Math.max(g,(e=>{let t=1e3;if(e){let i=e.parentElement;for(;i;){var n,o;const e=Number.parseInt(getComputedStyle(i).zIndex);isNaN(e)||(t=Math.max(t,e)),i=null!=(n=null==(o=i)?void 0:o.parentElement)?n:null}}return t})(f.current)))},className:(0,Qe.cn)("dropdown").elem("trigger").mix(d.className),onClickCapture:x})),[u,f,d.className,x]),w=(0,m.useMemo)((()=>(0,m.cloneElement)(u,S)),[u,S]),k=s?(0,A.jsx)(Vh,Object.assign({},d,{ref:c,children:s})):null;(0,m.useEffect)((()=>(document.addEventListener("click",b,{capture:!0}),()=>document.removeEventListener("click",b,{capture:!0}))),[b]);const C=(0,m.useMemo)((()=>({minIndex:g,triggerRef:f,dropdown:c,hasTarget:y,addChild:e=>h.current.add(e),removeChild:e=>h.current.delete(e),open:()=>{var e;return null==c||null==(e=c.current)||null==e.open?void 0:e.open()},close:()=>{var e;return null==c||null==(e=c.current)||null==e.close?void 0:e.close()}})),[f,c,g]);return(0,m.useEffect)((()=>{if(v)return v.addChild(C),()=>v.removeChild(C)}),[]),(0,A.jsxs)(Lh.Provider,{value:C,children:[w,k]})})),Fh=()=>(0,m.useContext)(Lh),Wh=Object.assign(Vh,{Trigger:Bh}),$h=m.createContext(),Uh=["name","children","label","icon","to","className","href","danger","exact","forceReload","active","onClick"],Yh=(0,m.forwardRef)((({children:e,className:t,style:n,size:o,selectedKeys:i,closeDropdownOnItemClick:s,allowClickSelected:r},a)=>{const l=Fh(),d=(0,m.useMemo)((()=>new Set(null!=i?i:[])),[i]),c=(0,m.useCallback)((e=>{const t=(0,Qe.cn)("menu").elem("item").closest(e.target);l&&t&&!1!==s&&l.close()}),[l]),u=(0,m.useMemo)((()=>!!l),[l]),h=(0,m.useMemo)((()=>({selected:d,allowClickSelected:r})),[d,r]);return(0,A.jsx)($h.Provider,{value:h,children:(0,A.jsx)(Qe.eB,{ref:a,tag:"ul",name:"menu",mod:{size:o,collapsed:u},mix:t,style:n,onClick:c,children:e})})}));Yh.Item=e=>{let{name:t,children:n,label:o,icon:i,to:s,className:r,href:a,danger:l,exact:d=!1,forceReload:c=!1,active:u=!1,onClick:h}=e,g=(0,Zn.A)(e,Uh);const{selected:p,allowClickSelected:f}=m.useContext($h),v=(0,Qe.cn)("menu",{elem:"item"}),y=(()=>{const e=window.location.pathname.replace(/\/$/,""),n=null!=s?s:a;return!!p.has(t)||(d?e===n:e.includes(n))})(),b=(0,m.useMemo)((()=>(0,A.jsxs)(A.Fragment,{children:[i&&(0,A.jsx)("span",{className:v.elem("item-icon"),children:i}),null!=n?n:o]})),[n,o,i]),x=Object.assign({className:v.mod({active:y||u,look:l&&"danger",clickable:f}).mix(r),onClick:h},g);return c&&(x.onClick=()=>window.location.href=null!=s?s:a),(0,A.jsx)("li",{children:a?(0,A.jsx)("a",Object.assign({href:null!=a?a:"#"},x,{children:b})):(0,A.jsx)("div",Object.assign({},x,{children:b}))})},Yh.Spacer=()=>(0,A.jsx)("li",{className:(0,Qe.cn)("menu",{elem:"spacer"})}),Yh.Divider=()=>(0,A.jsx)("li",{className:(0,Qe.cn)("menu",{elem:"divider"})}),Yh.Builder=(e,t)=>(null!=t?t:[]).map(((t,n)=>{if("SPACER"===t)return(0,A.jsx)(Yh.Spacer,{},n);if("DIVIDER"===t)return(0,A.jsx)(Yh.Divider,{},n);const[o,i]=t,s=`${e}${o}`.replace(/([/]+)/g,"/");return(0,A.jsx)(Yh.Item,{to:s,exact:!0,children:i},n)})),Yh.Group=({children:e,title:t,className:n,style:o})=>{const i=(0,Qe.cn)("menu-group");return(0,A.jsxs)("li",{className:i.mix(n),style:o,children:[(0,A.jsx)("div",{className:i.elem("title"),children:t}),(0,A.jsx)("ul",{className:i.elem("list"),children:e})]})};const Xh=(0,m.forwardRef)(((e,t)=>{const n=(0,m.useRef)(),o=(0,m.useRef)(null),i=e=>{t instanceof Function?t(e):t&&(t.current=e)};return(0,m.useEffect)((()=>{var t;const s=document.createElement("canvas");s.width=e.width,s.height=e.height,s.style.background="transparent",o.current=s,null==(t=n.current)||t.appendChild(s),i(o.current)}),[]),(0,m.useEffect)((()=>{o.current&&(o.current.width=e.width,o.current.height=e.height)}),[e.width,e.height]),(0,m.useEffect)((()=>()=>{const e=o.current,t=e.getContext("2d");null==t||t.clearRect(0,0,e.width,e.height),e.remove(),o.current=null,i(null)}),[]),(0,A.jsx)("div",{ref:n})})),Gh={mp4:"video/mp4",mp4v:"video/mp4",mpg4:"video/mp4",ogg:"video/ogg",ogv:"video/ogg",ogm:"video/ogg",ogx:"video/ogg",webm:"video/webm",avi:"video/avi",mov:"video/quicktime",qt:"video/quicktime"},Zh=(0,m.forwardRef)(((e,t)=>{const n=(0,m.useRef)(null),o=(0,m.useRef)(null),i=(0,m.useRef)([]),s=(0,m.useCallback)((async t=>{let n=!1;return t&&(n=await(async e=>{var t;const n=document.createElement("video"),o=null!=(t=new URL(e,/^https?/.exec(e)?void 0:window.location.href).pathname.split(".").pop())?t:"";let i=Gh[o];i||(i=(await fetch(e,{method:"GET",headers:{Range:"bytes=0-0"}})).headers.get("content-type"));const s=!!(r=i)&&r.includes("octet-stream")||!!i&&""!==n.canPlayType(i);var r;const a=document.querySelector(".ant-modal");return s||a||yn.error("There has been an error rendering your video, please check the format is supported"),s})(t)),e.canPlayType&&e.canPlayType(n),n}),[e.canPlayType]),r=(0,m.useCallback)((()=>{const t=document.createElement("video");t.muted=!!e.muted,t.controls=!1,t.preload="auto",(0,j.VS)(j.xS)&&(t.crossOrigin="anonymous"),Object.assign(t.style,{top:"-9999px",width:0,height:0,position:"absolute"}),n.current=t}),[]),a=(0,m.useCallback)((e=>{t instanceof Function?t(e):t&&(t.current=e)}),[]),l=()=>{const t=Object.entries(e).filter((([e])=>e.startsWith("on"))).map((([e,t])=>[e.toLowerCase(),t])),o=[];t.forEach((([e,t])=>{var i;const s=e.replace(/^on/,"");null==(i=n.current)||i.addEventListener(s,t),o.push([s,t])})),i.current=o},d=()=>{var e;n.current&&((null!=(e=i.current)?e:[]).forEach((([e,t])=>{var o;null==(o=n.current)||o.removeEventListener(e,t)})),i.current=[])},c=()=>{var e,t,i;o&&n&&(null==(e=n.current)||e.pause(),null==(t=o.current)||t.setAttribute("src",""),null==(i=n.current)||i.load())},u=(0,m.useCallback)((()=>{var t,i,s;if(!n.current)return;null==(t=n.current)||t.pause(),o.current&&c();const r=document.createElement("source");r.setAttribute("src",null!=(i=e.src)?i:""),null==(s=n.current)||s.appendChild(r),o.current=r}),[e.src]);return(0,m.useEffect)((()=>{d(),l()})),(0,m.useEffect)((()=>{var t;return r(),l(),s(null!=(t=e.src)?t:"").then((e=>{e&&n.current&&(u(),a(n.current),document.body.append(n.current))})),()=>{var e;d(),c(),a(null),null==(e=n.current)||e.remove(),n.current=null}}),[]),(0,m.useEffect)((()=>{n.current&&void 0!==e.muted&&(n.current.muted=e.muted)}),[e.muted]),null})),qh=e=>(0,x.clamp)(e,.1,10),Jh=(e,t,n,o)=>Math.min(1,Math.min(e/n,t/o)),Qh=.002,eg=(0,m.memo)((0,m.forwardRef)(((e,t)=>{var n,o,i,s,r;const a=(0,m.useRef)(),l=(0,m.useRef)(),d=(0,m.useRef)(),c=(0,m.useRef)(),u=(0,m.useRef)(),h=(0,m.useRef)(null),g=(0,m.useRef)(!1),p=(0,m.useMemo)((()=>{var t;return null!=(t=e.width)?t:600}),[e.width]),f=(0,m.useMemo)((()=>{var t;return null!=(t=e.height)?t:600}),[e.height]),v=null!=(n=e.framerate)?n:29.97,[y,b]=(0,m.useState)(!0),[S,w]=(0,m.useState)(0),[k,C]=(0,m.useState)(null!=(o=e.position)?o:1),[R,_]=(0,m.useState)(!1),[T,K]=(0,m.useState)(!1),[E,P]=(0,m.useState)(null!=(i=e.zoom)?i:1),[M,D]=(0,m.useState)(null!=(s=e.pan)?s:{x:0,y:0}),[O,I]=(0,m.useState)({width:0,height:0,ratio:1}),[L,N]=(0,m.useState)(1),[z,V]=(0,m.useState)(1),[H,B]=(0,m.useState)(1),F=(0,m.useMemo)((()=>{const e=[];return 1!==L&&e.push(`contrast(${L})`),1!==z&&e.push(`brightness(${z})`),1!==H&&e.push(`saturate(${H})`),e.join(" ")}),[z,L,H]),W=(0,m.useCallback)((t=>{const{width:n,height:o}=O,i=n*E,s=o*E,r=(0,x.clamp)((i-p)/2,0,Number.POSITIVE_INFINITY),a=(0,x.clamp)((s-f)/2,0,Number.POSITIVE_INFINITY);return{x:e.allowPanOffscreen?t.x:(0,x.clamp)(t.x,-r,r),y:e.allowPanOffscreen?t.y:(0,x.clamp)(t.y,-a,a)}}),[e.allowPanOffscreen,p,f,E]),$=(0,m.useCallback)((()=>{try{if(c.current&&u.current){const e=c.current,{width:t,height:n}=O;if(0===t&&0===n)return;const o=t*E,i=n*E,s=(p-o)/2+M.x,r=(f-i)/2+M.y;e.clearRect(0,0,p,f),e.filter=F,e.drawImage(u.current,0,0,t,n,s,r,o,i)}}catch(e){console.log("Error rendering video",e)}}),[O,E,M,F,p,f]),U=(0,m.useCallback)(((t=!1)=>{var n,o,i;if(!c.current)return;const s=null!=(n=null==(o=u.current)?void 0:o.currentTime)?n:0,r=(0,j.VS)(j.Tm)?Math.ceil(s*v):Math.round(s*v),a=(0,x.clamp)(r,1,S||1),l=null!=(i=e.onFrameChange)?i:()=>{};a===k&&!0!==t||(C(a),$(),l(a,S))}),[v,k,$,e.onFrameChange,S]),Y=(0,m.useCallback)((()=>{if(!u.current)return;if(!c.current)return;const e=u.current;e&&(R||U(!0),e.networkState===e.NETWORK_IDLE?(g.current=!0,K(!1)):K(!0))}),[R,U]),X=(0,m.useCallback)((()=>{_(!0),K(!1),null==e.onPlay||e.onPlay()}),[e.onPlay]),G=(0,m.useCallback)((()=>{_(!1),K(!1),null==e.onPause||e.onPause()}),[e.onPause]),Z=(0,m.useCallback)((()=>{K(!1),Y()}),[Y]),q=(0,m.useCallback)((()=>{K(!0)}),[]),J=(0,m.useCallback)((()=>{_(!1),K(!1),null==e.onSeeked||e.onSeeked(),null==e.onEnded||e.onEnded(),null==e.onPause||e.onPause()}),[e.onEnded]),Q=(0,m.useCallback)((()=>{if(!(0,j.VS)(j.xS))return;const t=u.current;null!=t&&t.error&&g.current?(g.current=!1,t.load()):t&&(null==e.onError||e.onError(t.error))}),[e.onError]),ee=()=>{U(),R?a.current=requestAnimationFrame(ee):cancelAnimationFrame(a.current)};(0,m.useEffect)((()=>{R||$()}),[$,R]),(0,m.useEffect)((()=>(R&&(a.current=requestAnimationFrame(ee)),()=>{cancelAnimationFrame(a.current)})),[R]),(0,m.useEffect)((()=>{u.current&&e.speed&&(u.current.playbackRate=e.speed)}),[e.speed]),(0,m.useEffect)((()=>{u.current&&e.position&&(u.current.currentTime=e.position/v)}),[v,e.position]),(0,m.useEffect)((()=>{u.current&&e.currentTime&&(u.current.currentTime=e.currentTime)}),[e.currentTime]),(0,m.useEffect)((()=>{u.current&&(e.playing&&!R?u.current.play():!1===e.playing&&R&&u.current.pause())}),[R,e.playing]),(0,m.useEffect)((()=>{var t;e.allowInteractions&&(null==(t=l.current)||t.addEventListener("wheel",(e=>{e.preventDefault()})))}),[]),(0,m.useEffect)((()=>{(0,x.isDefined)(e.zoom)&&P(qh(e.zoom))}),[e.zoom]),(0,m.useEffect)((()=>{(0,x.isDefined)(e.pan)&&D(W(e.pan))}),[e.pan,W]),(0,m.useEffect)((()=>{(0,x.isDefined)(e.brightness)&&V(e.brightness)}),[e.brightness]),(0,m.useEffect)((()=>{(0,x.isDefined)(e.contrast)&&N(e.contrast)}),[e.contrast]),(0,m.useEffect)((()=>{(0,x.isDefined)(e.saturation)&&B(e.saturation)}),[e.saturation]),(0,m.useEffect)((()=>{$()}),[F,E,M,p,f]),(0,m.useEffect)((()=>{const t=new ResizeObserver((()=>{null==e.onResize||e.onResize(O)}));return t.observe(l.current),()=>t.disconnect()}),[O]);const te={currentFrame:k,length:S,playing:R,zoom:E,pan:M,videoDimensions:O,width:p,height:f,set currentTime(e){const t=u.current;t&&e!==this.currentTime&&(t.currentTime=e)},get currentTime(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.currentTime)?e:0},get duration(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.duration)?e:0},get volume(){var e,t;return null!=(e=null==(t=u.current)?void 0:t.volume)?e:1},set volume(e){const t=u.current;t&&(t.currentTime=e)},adjustPan:(e,t)=>W({x:e,y:t}),setZoom(e){P(qh(e))},setPan(e,t){const n=this.adjustPan(e,t);D(n)},setContrast(e){N(e)},setBrightness(e){V(e)},setSaturation(e){B(e)},play(){var e;null==(e=u.current)||e.play()},pause(){var e;null==(e=u.current)||e.pause(),(0,j.VS)(j.Tm)&&(this.currentTime=(0,x.clamp)(this.frameSteppedTime(),0,this.duration))},seek(e){this.currentTime=(0,x.clamp)(e,0,this.duration),requestAnimationFrame((()=>$()))},frameSteppedTime(e){return(0,j.VS)(j.Tm)?Math.round((null!=e?e:this.currentTime)/Qh)*Qh+Qh:null!=e?e:this.currentTime},goToFrame(e){const t=((0,x.clamp)(e,1,S)-1)/v;this.currentTime=this.frameSteppedTime(t)}};return t instanceof Function?t(te):t&&(t.current=te),(0,m.useEffect)((()=>{const{width:t,height:n}=O,o=Jh(p,f,t,n);if(O.ratio!==o){const t=Object.assign({},O,{ratio:o});I(t),e.zoom!==O.ratio&&(null==e.onResize||e.onResize(t))}}),[E,p,f,O]),(0,m.useEffect)((()=>{let t,n,o=!1;const i=()=>{var s;if(!o)if(!1!==h.current)if(4!==(null==(s=u.current)?void 0:s.readyState))n=setTimeout(i,10);else{o=!0;const n=u.current;t=setTimeout((()=>{const t=(0,j.VS)(j.Tm)?Math.round(n.duration*v):Math.ceil(n.duration*v),[o,i]=[n.videoWidth,n.videoHeight],s={width:o,height:i,ratio:Jh(p,f,o,i)};I(s),w(t),b(!1),U(!0),null==e.onLoad||e.onLoad(Object.assign({},te,{videoDimensions:s,length:t}))}),200)}else b(!1)};return i(),()=>{n&&clearTimeout(n),t&&clearTimeout(t)}}),[]),(0,m.useEffect)((()=>()=>{const e=c.current;e&&e.clearRect(0,0,e.canvas.width,e.canvas.height),c.current=void 0,d.current=void 0,u.current=void 0,l.current=void 0}),[]),(0,A.jsxs)(Qe.eB,{ref:l,name:"video-canvas",children:[y&&(0,A.jsx)(Qe.Sl,{name:"loading",children:(0,A.jsx)(Qe.eB,{name:"spinner"})}),(0,A.jsxs)(Qe.Sl,{name:"view",onClick:e.onClick,style:{width:p,height:f},children:[(0,A.jsx)(Xh,{ref:e=>{e&&d.current!==e&&(d.current=e,c.current=e.getContext("2d"))},width:p,height:f}),!y&&T&&(0,A.jsx)(Qe.Sl,{name:"buffering"})]}),(0,A.jsx)(Zh,{ref:u,controls:!1,preload:"auto",src:e.src,muted:null!=(r=e.muted)&&r,canPlayType:e=>h.current=e,onPlay:X,onPause:G,onLoadedData:Y,onCanPlay:Y,onSeeked:t=>{Y(),null==e.onSeeked||e.onSeeked(t)},onSeeking:t=>{Y(),null==e.onSeeked||e.onSeeked(t)},onTimeUpdate:t=>{Y(),null==e.onTimeUpdate||e.onTimeUpdate(t)},onProgress:Y,onPlaying:Z,onWaiting:q,onEnded:J,onError:Q})]})})));eg.displayName="VideoCanvas";const tg=u.gK.model("TimeTraveller",{undoIdx:0,targetPath:"",skipNextUndoState:u.gK.optional(u.gK.boolean,!1),lastAdditionTime:u.gK.optional(u.gK.Date,new Date),createdIdx:0}).volatile((()=>({history:[],isFrozen:!1}))).views((e=>({get canUndo(){return e.undoIdx>0},get canRedo(){return e.undoIdx<e.history.length-1},get hasChanges(){return e.history.length>1}}))).actions((e=>{let t,n;const o=new Set,i=new Set;let s=!1,r=!1;function a(e=!0){o.forEach((t=>t(e)))}return{freeze(t){i.add(t),e.isFrozen||(s=!1,e.isFrozen=!0)},safeUnfreeze(t){i.delete(t),e.isFrozen=i.size>0},unfreeze(t){e.safeUnfreeze(t),e.isFrozen||(s&&e.recordNow(),e.setReplaceNextUndoState(!1))},setSkipNextUndoState(t=!0){e.skipNextUndoState=t},setReplaceNextUndoState(e=!0){r=e},recordNow(){t&&e.addUndoState((0,u.dV)(t))},onUpdate:e=>(o.add(e),()=>{o.delete(e)}),addUndoState(t){e.isFrozen?s=!0:e.skipNextUndoState?e.skipNextUndoState=!1:(e.history=e.history.slice(0,e.undoIdx+!r).concat(t),e.undoIdx=e.history.length-1,r=!1,s=!1,e.lastAdditionTime=new Date)},reinit(n=!0){e.history=[(0,u.dV)(t)],e.undoIdx=0,e.createdIdx=0,a(n)},afterCreate(){if(t=e.targetPath?(0,u.o1)(e,e.targetPath):(0,u._$)(e).targetStore,!t)throw new Error("Failed to find target store for TimeTraveller. Please provide `targetPath` property, or a `targetStore` in the environment");n=(0,u.aQ)(t,(e=>this.addUndoState(e))),0===e.history.length&&e.recordNow(),e.createdIdx=e.undoIdx},beforeDestroy(){n(),t=null,n=null,o.clear(),i.clear()},undo(){e.set(e.undoIdx-1)},redo(){e.set(e.undoIdx+1)},set(n){e.undoIdx=n,e.skipNextUndoState=!0,(0,u.Nh)(t,e.history[n]),a(),(0,j.VS)(j.$b)&&setTimeout((()=>{e.setSkipNextUndoState(!1)}))},reset(){(0,u.Nh)(t,e.history[e.createdIdx]),a()}}})),ng=u.gK.model("GlobalOffset",{start:u.gK.number,end:u.gK.number,calculated:!1}).views((e=>({get serialized(){return{start:e.start,end:e.end}}}))),og=u.gK.model("RichTextRegionModel",{type:"richtextregion",object:u.gK.late((()=>u.gK.reference(Yu))),startOffset:u.gK.integer,endOffset:u.gK.integer,start:u.gK.string,end:u.gK.string,text:u.gK.maybeNull(u.gK.string),isText:u.gK.optional(u.gK.boolean,!1),globalOffsets:u.gK.maybeNull(ng)}).volatile((()=>({hideable:!0}))).views((e=>({get parent(){return(0,u.$Q)((()=>e.object))},getRegionElement(){var t;return null==(t=e._spans)?void 0:t[0]},get displayValue(){return e.text}}))).actions((e=>({beforeDestroy(){try{e.removeHighlight()}catch(e){console.warn(e)}},applyAdditionalDataFromResult(t){var n,o;const i=null==t||null==(n=t.type)?void 0:n.endsWith("labels"),s=(0,x.isDefined)(null==t||null==(o=t.value)?void 0:o.text);i&&s&&(e.text=t.value.text)},serialize(){const t={value:{}};if(e.isText)Object.assign(t.value,{start:e.startOffset,end:e.endOffset});else try{const n=e.parent.globalOffsetsToRelativeOffsets(e.globalOffsets);Object.assign(t.value,Object.assign({},n,{globalOffsets:e.globalOffsets.serialized}))}catch(n){const{start:o,end:i,startOffset:s,endOffset:r}=e;Object.assign(t.value,{start:o,end:i,startOffset:s,endOffset:r}),e.globalOffsets&&Object.assign(t.value,{globalOffsets:e.globalOffsets.serialized})}return"yes"===e.object.savetextresult&&(0,x.isDefined)(e.text)&&(t.value.text=e.text),t},updateTextOffsets(t,n){Object.assign(e,{startOffset:t,endOffset:n})},updateGlobalOffsets(t,n){e.globalOffsets=ng.create({start:t,end:n,calculated:!0})},updateXPathsFromGlobalOffsets(){const t=e.parent.globalOffsetsToRelativeOffsets(e.globalOffsets);t&&e._setXPaths(t)},initRangeAndOffsets(){var t;if(null!=(t=e.globalOffsets)&&t.calculated)return;if(e.isText){const{startOffset:t,endOffset:n}=e;return void(e.globalOffsets={start:t,end:n,calculated:!0})}const n=e.parent.relativeOffsetsToGlobalOffsets(e.start,e.startOffset,e.end,e.endOffset);if(n){const[t,o]=n;e.globalOffsets={start:t,end:o,calculated:!0}}else e.globalOffsets&&e.updateXPathsFromGlobalOffsets()},_setXPaths(t){e.start=t.start,e.end=t.end,e.startOffset=t.startOffset,e.endOffset=t.endOffset}}))),ig=u.gK.compose("RichTextRegionModel",ut,yt,Ze,og,Pu);b.addRegionType(ig,"text"),b.addRegionType(ig,"hypertext"),b.addRegionType(ig,"richtext");const sg=u.gK.model({value:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string),framerate:u.gK.optional(u.gK.string,"24"),height:u.gK.optional(u.gK.string,"600"),timelineheight:u.gK.maybeNull(u.gK.string),muted:!1}),rg=u.gK.model({type:"video",_value:u.gK.optional(u.gK.string,""),mergeLabelsAndResults:!0}).volatile((()=>({errors:[],speed:1,ref:m.createRef(),frame:1,length:1,drawingRegion:null}))).views((e=>({get store(){return(0,u.Zn)(e)},get currentFrame(){var t,n;return null!=(t=null==(n=e.ref.current)?void 0:n.position)?t:1},get timelineControl(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.find((e=>e.type.includes("timeline")))},get videoControl(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.find((e=>e.type.includes("video")))},states(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.filter((e=>e.type.endsWith("labels")))},activeStates(){const t=e.states();return t?t.filter((e=>!0===e.isSelected)):null},get hasStates(){const t=e.states();return t&&t.length>0}}))).actions((e=>({afterCreate(){var t;const n=Number(k(e.framerate,null==(t=e.store.task)?void 0:t.dataObj));!n||isNaN(n)?e.framerate="24":e.framerate=String(n<1?1/n:n)}}))).actions((e=>({triggerSync(t,n){e.ref.current&&e.syncSend(Object.assign({playing:e.ref.current.playing,time:e.ref.current.frameSteppedTime()},n),t)},triggerSyncPlay(){e.triggerSync("play",{playing:!0})},triggerSyncPause(){e.triggerSync("pause",{playing:!1})},registerSyncHandlers(){["play","pause","seek"].forEach((t=>{e.syncHandlers.set(t,e.handleSync)})),e.syncHandlers.set("speed",e.handleSyncSpeed)},handleSync(t){if(!e.ref.current)return;const n=e.ref.current;t.playing?n.playing||n.play():n.playing&&n.pause(),t.speed&&(e.speed=t.speed),n.currentTime=t.time},handleSyncSpeed({speed:t}){e.speed=t},handleSeek(){e.triggerSync("seek")},syncMuted(t){e.muted=t}}))).actions((e=>({setLength(t){e.length=t},setOnlyFrame(t){e.frame!==t&&(e.frame=t)},setFrame(t){e.frame!==t&&e.framerate&&(e.frame=t,(0,j.VS)(j.Tm)?e.ref.current.goToFrame(t):e.ref.current.currentTime=t/e.framerate)},addVideoRegion(t){const n=e.videoControl;if(!n)return void console.error("No video control is found");const o=[Object.assign({frame:e.frame,enabled:!0,rotation:0},t)],i=e.annotation.createResult({sequence:o},{},n,e);return e.activeStates().forEach((e=>{i.setValue(e)})),i},addTimelineRegion(t){var n,o;const i=e.timelineControl;if(!i)return void console.error("No video timeline control is found");const s=null!=(n=t.frame)?n:e.frame,r={ranges:[{start:s,end:s}]},a=null==(o=e.activeStates())?void 0:o[0],l={[a.valueType]:a.selectedValues()};return e.annotation.createResult(r,l,i,e)},deleteRegion(t){var n;null==(n=e.findRegion(t))||n.deleteRegion()},findRegion:t=>e.regs.find((e=>e.cleanId===t)),startDrawing({frame:t,region:n}){var o;if(n){var i;const o=e.annotation.regions.find((e=>e.cleanId===n)),s=null==o||null==(i=o.ranges)?void 0:i[0];return s&&[s.start,s.end].includes(t)?o:null}const s=e.timelineControl;return null!=s&&null!=(o=s.selectedLabels)&&o.length||null!=s&&s.allowempty?(e.drawingRegion=e.addTimelineRegion({frame:t,enabled:!1}),e.drawingRegion):null},finishDrawing({mode:t}){e.drawingRegion=null,"edit"===t&&e.annotation.history.recordNow()}}))),ag=u.gK.compose("VideoModel",Ge,sg,Ue,Sn,Ne,rg,Ve),lg=u.gK.model("TimelineRange",{start:u.gK.maybeNull(u.gK.integer),end:u.gK.maybeNull(u.gK.integer)});function dg(e){const{start:t,end:n}=e;return(0,x.isDefined)(t)?(0,x.isDefined)(n)?t===n?{frame:t,enabled:!1}:[{frame:t,enabled:!0},{frame:n,enabled:!1}]:{frame:t,enabled:!0}:(0,x.isDefined)(n)?{frame:n,enabled:!1}:[]}const cg=u.gK.model("TimelineRegionModel",{type:"timelineregion",object:u.gK.late((()=>u.gK.reference(ag))),ranges:u.gK.array(lg)}).volatile((()=>({hideable:!0,editableFields:[{property:"start",label:"Start frame"},{property:"end",label:"End frame"}]}))).views((e=>({get parent(){return(0,u._n)(e)?e.object:null},get sequence(){return e.ranges.flatMap(dg)},getShape:()=>null}))).actions((e=>({onSelectInOutliner(){e.object.setFrame(e.ranges[0].start)},serialize:()=>({value:{ranges:e.ranges}}),isInLifespan:e=>!0,setRange([t,n],{mode:o}={}){"new"===o?e.parent.annotation.history.setReplaceNextUndoState():"edit"===o&&e.parent.annotation.history.setSkipNextUndoState(),e.ranges=[{start:t,end:n}]}}))),ug=u.gK.compose("TimelineRegionModel",ut,yt,Ze,ln,cg);b.addRegionType(ug,"video");const hg=go("TimeSeries","Time Series Segmentation"),gg=u.gK.model("TimeSeriesRegionModel",{id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"timeseriesregion",object:u.gK.late((()=>u.gK.reference(bh))),start:u.gK.union(u.gK.number,u.gK.string),end:u.gK.union(u.gK.number,u.gK.string),instant:!1}).volatile((()=>({hideable:!0}))).views((e=>({get parent(){return e.object},getRegionElement:()=>e._brushRef}))).actions((e=>({growRight(t){e.end=e.end+t},growLeft(t){e.start=e.start-t},shrinkRight(t){e.end=e.end-t},shrinkLeft(t){e.start=e.start+t},selectRegion(){const t=1e3,n=1e4;hg.addNamed("ts:grow-left",(()=>e.growLeft(t))),hg.addNamed("ts:grow-right",(()=>e.growRight(t))),hg.addNamed("ts:shrink-left",(()=>e.shrinkLeft(t))),hg.addNamed("ts:shrink-right",(()=>e.shrinkRight(t))),hg.addNamed("ts:grow-left-largre",(()=>e.growLeft(n))),hg.addNamed("ts:grow-right-largre",(()=>e.growRight(n))),hg.addNamed("ts:shrink-left-largre",(()=>e.shrinkLeft(n))),hg.addNamed("ts:shrink-right-largre",(()=>e.shrinkRight(n))),e.parent.scrollToRegion(e)},updateAppearenceFromState(){e.labelsState&&e.parent.updateView()},afterUnselectRegion(){hg.unbindAll(),e.parent.updateView()},updateRegion(t,n){e.start=t,e.end=n,e.notifyDrawingFinished()},afterCreate(){"string"==typeof e.start&&(e.start=e.parent.parseTime(e.start),e.end=e.parent.parseTime(e.end))},serialize(){const t=e.parent.timeformat?oh.aLc(e.parent.timeformat):Number;return{value:{start:t(e.start),end:t(e.end),instant:e.instant}}}}))),mg=u.gK.compose("TimeSeriesRegionModel",ut,yt,Ze,Ne,gg);b.addTag("timeseriesregion",mg,(()=>{})),b.addRegionType(mg,"timeseries");const pg=(e,t)=>Object.fromEntries(e.map((e=>[e,t[e]]))),fg=u.gK.model("VideoRegionModel",{id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),object:u.gK.late((()=>u.gK.reference(ag))),sequence:u.gK.frozen([])}).preProcessSnapshot((e=>Object.assign({},e,{sequence:e.sequence||e.value.sequence}))).volatile((()=>({hideable:!0}))).views((e=>({get parent(){return e.object},getShape(){throw new Error("Method getShape be implemented on a shape level")},getVisibility:()=>!0}))).actions((e=>({updateShape(){throw new Error("Method updateShape must be implemented on a shape level")},onSelectInOutliner(){e.object.setFrame(e.sequence[0].frame)},serialize(){var t,n;const{framerate:o,length:i}=e.object;return{value:{framesCount:i,duration:null!=(t=null==(n=e.object)||null==(n=n.ref)||null==(n=n.current)?void 0:n.duration)?t:0,sequence:e.sequence.map((e=>Object.assign({},e,{time:e.frame/o})))}}},toggleLifespan(t){const n=e.closestKeypoint(t,!0);if(n){const t=e.sequence.indexOf(n);e.sequence=[...e.sequence.slice(0,t),Object.assign({},n,{enabled:!n.enabled}),...e.sequence.slice(t+1)]}},addKeypoint(t){var n,o,i;const s=Array.from(e.sequence),r=e.closestKeypoint(t),a=Object.assign({},null!=(n=null!=(o=e.getShape(t))?o:r)?n:{x:0,y:0},{enabled:null==(i=null==r?void 0:r.enabled)||i,frame:t});s.push(a),s.sort(((e,t)=>e.frame-t.frame)),e.sequence=s,e.updateShape(Object.assign({},a),a.frame)},removeKeypoint(t){e.sequence=e.sequence.filter((e=>e.frame!==t))},isInLifespan(t){const n=e.closestKeypoint(t);if(n){const{enabled:e,frame:o}=n;return o===t&&!e||e}return!1},closestKeypoint(t,n=!1){const o=e.sequence;let i;const s=o.filter((({frame:e})=>e<=t));return i=s[s.length-1],i||!0===n||(i=o.find((({frame:e})=>e>=t))),i}}))),vg=u.gK.compose("VideoRegionModel",ut,yt,Ne,Ze,fg);function yg(e){let t=e;for(;t>0;)t-=360;return(t-180)%360+180}const bg=(e,t,n,o)=>{const i=(n-e.frame)/(t.frame-e.frame);if("rotation"===o){const n=yg(t[o]-e[o]);return yg(e[o]+n*i)}return e[o]+(t[o]-e[o])*i},xg=u.gK.model("VideoRectangleRegionModel",{type:"videorectangleregion"}).volatile((()=>({props:["x","y","width","height","rotation"]}))).views((e=>({getShape(t){let n,o;for(const i of e.sequence){if(i.frame===t)return pg(e.props,i);if(i.frame>t){o=i;break}n=i}return n?o?Object.fromEntries(e.props.map((e=>[e,bg(n,o,t,e)]))):pg(e.props,n):null},getVisibility:()=>!0}))).actions((e=>({updateShape(t,n){const o=Object.assign({},t,{frame:n,enabled:!0}),i=e.closestKeypoint(n),s=e.sequence.findIndex((e=>e.frame>=n));if(s<0)e.sequence=[...e.sequence,o];else{var r,a;const o=Object.assign({},null!=(r=e.sequence[s])?r:{},t,{enabled:null==(a=null==i?void 0:i.enabled)||a,frame:n});e.sequence=[...e.sequence.slice(0,s),o,...e.sequence.slice(s+(e.sequence[s].frame===n))]}}}))),Sg=u.gK.compose("VideoRectangleRegionModel",ut,vg,yt,Ze,xg);b.addRegionType(Sg,"video");const wg=u.gK.compose("ClassificationArea",ut,Ze,yt,u.gK.model({object:u.gK.late((()=>u.gK.reference(u.gK.union(...b.objectTypes())))),classification:!0}).views((e=>({get supportSuggestions(){return!1},get type(){return""}}))).actions((()=>({serialize:()=>({})})))),kg=u.gK.union({dispatcher(e){if(e.$treenode)return e.$treenode.type;if(!e.points&&!e.sequence&&!e.ranges&&e.value&&Object.values(e.value).length<=1)return wg;const t=L.cleanUpId(e.object.name||e.object),n=window.Htx.annotationStore.names.get(t),o=b.getAvailableAreas(n.type,e);var i;return"video"===n.type?e.sequence||null!=(i=e.value)&&i.sequence?Sg:ug:o.length?u.gK.union(...o,wg):wg}},gn,uu,ug,mg,Xa,ig,Ta,Ca,Na,fa,Sg,wg),Cg=kg;var jg=n(87835),Rg=n.n(jg);const _g=e=>e?e.map((e=>e.map((e=>({label:e,value:e}))))):[],Tg={pathSeparator:"/",showFullPath:!0},Ag=u.gK.model("UserExtended",{id:u.gK.identifierNumber,firstName:u.gK.maybeNull(u.gK.string),lastName:u.gK.maybeNull(u.gK.string),username:u.gK.maybeNull(u.gK.string),email:u.gK.maybeNull(u.gK.string),lastActivity:u.gK.maybeNull(u.gK.string),avatar:u.gK.maybeNull(u.gK.string),initials:u.gK.maybeNull(u.gK.string),phone:u.gK.maybeNull(u.gK.string)}).preProcessSnapshot((e=>(0,x.camelizeKeys)(null!=e?e:{}))),Kg=(u.gK.model("UserStore",{id:u.gK.maybeNull(u.gK.integer),pk:u.gK.maybeNull(u.gK.integer),firstName:u.gK.maybeNull(u.gK.string),lastName:u.gK.maybeNull(u.gK.string)}).views((e=>({get displayName(){return e.firstName||e.lastName?`${e.firstName} ${e.lastName}`:""}}))),["id"]),Eg=u.gK.model({regionId:u.gK.maybe(u.gK.string),controlName:u.gK.maybe(u.gK.string)}).views((e=>({get comment(){return(0,u.PA)(e)},get annotation(){return e.comment.annotation},get region(){return e.annotation.regions.find((t=>t.cleanId===e.regionId))},get result(){return e.controlName&&e.region?e.region.results.find((t=>t.from_name.name===e.controlName)):null},get overlayNode(){var t,n;const{result:o,region:i}=e;if(e.comment.isResolved||e.comment.isDeleted)return null;if(!i||i.hidden)return null;if(!((null!=(t=i.item_index)?t:0)===(null!=(n=i.object.currentItemIndex)?n:0)))return null;if(o){const e=o.from_name,t=e.isClassificationTag,n=!1!==e.isVisible,i=e.result;if(t&&n&&i===o)return o}return e.region},get targetKey(){const t=[e.regionId];return(0,x.isDefined)(e.controlName)&&t.push(e.controlName),t.join("-")}}))).actions((e=>({serialize(){const t=e.toJSON();return(0,Zn.A)(t,Kg)},setRegion(t){e.regionId=t.cleanId}}))),Pg=u.gK.model("CommentBase",Object.assign({text:u.gK.string},isFF(j.v1)?{regionRef:u.gK.optional(u.gK.maybeNull(Eg),null),classifications:u.gK.optional(u.gK.frozen({}),null)}:{})).views((e=>({get commentsStore(){try{return Le.getParentOfTypeString(e,"CommentStore")}catch(e){return null}},get annotation(){const t=(0,u._$)(e);if(null!=t&&t.annotationStore)return t.annotationStore.selected;const n=e.commentsStore;return null==n?void 0:n.annotation},get isHighlighted(){var t,n;const o=null==(t=e.commentsStore)||null==(t=t.highlightedComment)||null==(t=t.regionRef)?void 0:t.targetKey,i=null==(n=e.regionRef)?void 0:n.targetKey;return!!o&&o===i}}))).actions((e=>({setText(t){e.text=t},unsetLink(){e.regionRef=null},setRegionLink(t){e.regionRef={regionId:t.cleanId}},setClassifications(t){e.classifications=t},setResultLink(t){e.regionRef={regionId:t.area.cleanId,controlName:t.from_name.name}},setHighlighted(t=!0){const n=e.commentsStore;n&&(t?n.setHighlightedComment(e):e.isHighlighted&&n.setHighlightedComment(void 0))}}))),Mg=Pg.named("Comment").props({id:u.gK.identifierNumber,text:u.gK.string,createdAt:u.gK.optional(u.gK.string,sn.UDate.currentISODate()),updatedAt:u.gK.optional(u.gK.string,sn.UDate.currentISODate()),resolvedAt:u.gK.optional(u.gK.maybeNull(u.gK.string),null),createdBy:u.gK.optional(u.gK.maybeNull(u.gK.safeReference(Ag)),null),isResolved:!1,isEditMode:u.gK.optional(u.gK.boolean,!1),isDeleted:u.gK.optional(u.gK.boolean,!1),isConfirmDelete:u.gK.optional(u.gK.boolean,!1),isUpdating:u.gK.optional(u.gK.boolean,!1)}).preProcessSnapshot((e=>(0,x.camelizeKeys)(null!=e?e:{}))).volatile((e=>({_commentRef:(0,m.createRef)()}))).views((e=>({get sdk(){return(0,u._$)(e).events},get isPersisted(){return e.id>0&&!e.isUpdating},get canResolveAny(){return(0,u.Zn)(e).interfaces.includes("comments:resolve-any")}}))).actions((e=>{const t=(0,u.L3)((function*(){if(e.isPersisted&&!e.isDeleted){e.isResolved=!e.isResolved;try{yield e.sdk.invoke("comments:update",{id:e.id,is_resolved:e.isResolved})}catch(t){throw e.isResolved=!e.isResolved,t}}}));const n=(0,u.L3)((function*(t,n=void 0){if(e.isPersisted&&!e.isDeleted){const o={id:e.id,text:t};void 0!==n&&(o.classifications=n),yield e.sdk.invoke("comments:update",o)}e.setEditMode(!1)})),o=(0,u.L3)((function*(t){if(e.isPersisted&&!e.isDeleted&&!e.isUpdating){e.isUpdating=!0;const[n]=yield e.sdk.invoke("comments:update",Object.assign({id:e.id},(0,x.snakeizeKeys)(t)));if(n.error)return void(e.isUpdating=!1);const o=(0,x.camelizeKeys)(n);(0,u.Nh)(e,o),e.isUpdating=!1}}));return{toggleResolve:t,setEditMode:function(t){e.isEditMode=t},setDeleted:function(t){e.isDeleted=t},setConfirmMode:function(t){e.isConfirmDelete=t},updateComment:n,update:o,deleteComment:(0,u.L3)((function*(){e.isPersisted&&!e.isDeleted&&e.isConfirmDelete&&(yield e.sdk.invoke("comments:delete",{id:e.id})),e.setDeleted(!0),e.setConfirmMode(!1)})),setRegionLink:function(t){const n={regionId:t.cleanId};e.update({regionRef:n})},setResultLink:function(t){const n={regionId:t.area.cleanId,controlName:t.from_name.name};e.update({regionRef:n})},unsetLink:function(){e.update({regionRef:null})},scrollIntoView:()=>{const t=e._commentRef.current;t&&(t.scrollIntoViewIfNeeded?t.scrollIntoViewIfNeeded():t.scrollIntoView({block:"center",behavior:"smooth"}))}}})),Dg=u.gK.model("CommentStore",{loading:u.gK.optional(u.gK.maybeNull(u.gK.string),"list"),comments:u.gK.optional(u.gK.array(Mg),[]),highlightedComment:u.gK.safeReference(Mg)}).volatile((()=>({addedCommentThisSession:!1,commentFormSubmit:()=>{},currentComment:{},inputRef:{},tooltipMessage:"",commentsKey:null}))).views((e=>({get store(){return(0,u.PA)(e)},get task(){return(0,u.PA)(e).task},get annotationStore(){return(0,u.PA)(e).annotationStore},get annotation(){return e.annotationStore.selected},get annotationId(){var t;return isNaN(null==(t=e.annotation)?void 0:t.pk)?void 0:e.annotation.pk},get draftId(){var t;return null!=(t=e.annotation)&&t.draftId?e.annotation.draftId:null},get currentUser(){return(0,u.Zn)(e).user},get commentClassificationsItems(){return(e=>{if(!e)return[];const t=(new DOMParser).parseFromString(e,"application/xml"),n=[],o=(e,t=0,n=[])=>{const i=e.getAttribute("value")||"",s=[...n,i],r=[];return e.querySelectorAll(":scope > TaxonomyItem").forEach((e=>{r.push(o(e,t+1,s))})),{label:i,children:r.length?r:void 0,depth:t,path:s}},i=t.querySelector("Taxonomy");return i&&i.querySelectorAll(":scope > TaxonomyItem").forEach((e=>{n.push(o(e))})),n})((0,u.Zn)(e).commentClassificationConfig)},get sdk(){return(0,u._$)(e).events},get isListLoading(){return"list"===e.loading},get taskId(){var t;return null==(t=e.task)?void 0:t.id},get canPersist(){return(0,j.VS)(j.K3)?null!==e.taskId&&void 0!==e.taskId:null!==e.annotationId&&void 0!==e.annotationId},get isCommentable(){return!e.annotation||["annotation"].includes(e.annotation.type)},get queuedComments(){return e.comments.filter((e=>!e.isPersisted)).sort(((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()))},get hasUnsaved(){return e.queuedComments.length>0},get commentInProgress(){if(e.annotation)return e.currentComment[e.annotation.id]},get overlayComments(){const t=new Set;return e.comments.filter((e=>{const{regionRef:n}=e;return!!n&&(!t.has(n.targetKey)&&(t.add(n.targetKey),!0))}))},get isHighlighting(){return!!e.highlightedComment},get targetCommentsKey(){return e.annotationId?{annotation:e.annotationId}:e.draftId?{draft:e.draftId}:null},get isRelevantList(){return!(!e.commentsKey||!e.targetCommentsKey)&&(Object.keys(e.commentsKey).length===Object.keys(e.targetCommentsKey).length&&Object.keys(e.commentsKey).every((t=>e.commentsKey[t]===e.targetCommentsKey[t])))}}))).actions((e=>{const t=(0,u.L3)((function*(t){if("addComment"===e.loading)return;"string"==typeof t&&(t={text:t}),e.setLoading("addComment");const n=-1*Date.now(),o=Object.assign({},(0,x.snakeizeKeys)(t),{id:n,task:e.taskId,created_by:e.currentUser.id,created_at:sn.UDate.currentISODate()});let i=!1;const{annotation:s}=e;if(!(0,j.VS)(j.K3)||e.annotationId||e.draftId||(s.history.hasChanges&&!s.draftSaved?(s.saveDraftImmediately(),yield(0,c.z7)((()=>s.draftSaved))):(s.versions.draft=s.versions.result,s.setDraftSelected(),s.setDraftSaving(!0),yield e.store.submitDraft(e.annotation),s.onDraftSaved()),i=!0),e.annotationId&&(o.annotation=e.annotationId),e.draftId&&(o.draft=e.draftId),e.comments.unshift(o),e.setAddedCommentThisSession(!0),e.canPersist)try{const[t]=yield e.sdk.invoke("comments:create",o);t&&(e.replaceId(n,t),e.setCurrentComment(void 0),i&&e.listComments())}catch(t){throw e.removeCommentById(n),t}finally{e.setLoading(null)}else e.setLoading(null)})),n=(0,u.L3)((function*(){e.currentComment&&(yield t(e.currentComment))}));const o=(0,u.L3)((function*({mounted:t={current:!0},suppressClearComments:n}={}){if(n||e.setComments([]),e.draftId||e.annotationId)try{t.current&&e.setLoading("list");const n=e.annotationId,o=e.targetCommentsKey,[i]=yield e.sdk.invoke("comments:list",{annotation:n,draft:e.draftId});t.current&&n===e.annotationId&&e.setComments(i,o)}catch(e){console.error(e)}finally{t.current&&e.setLoading(null)}}));return{serialize:function({commentsFilter:t,queueComments:n}={commentsFilter:"all",queueComments:!1}){const o=(0,u.dV)("queued"===t?e.queuedComments:e.comments);return{comments:n?o.map((e=>Object.assign({id:e.id>0?-1*e.id:e.id},e))):o}},hasCache:function(e){localStorage.getItem(`commentStore.${e}`)},removeCache:function(e){localStorage.removeItem(`commentStore.${e}`)},toCache:function(t,n={commentsFilter:"all",queueComments:!0}){localStorage.setItem(`commentStore.${t}`,JSON.stringify(e.serialize(n)))},fromCache:function(t,{merge:n=!0,queueRestored:o=!1}={}){const i=localStorage.getItem(`commentStore.${t}`);if(i){const t=JSON.parse(i);if(Array.isArray(null==t?void 0:t.comments)){let i=[];o&&(i=t.comments.map((e=>e.id))),n&&(t.comments=Rg()([...t.comments,...(0,u.dV)(e.comments)],"id").sort(((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()))),i.length&&(t.comments=t.comments.map((e=>i.includes(e.id)?Object.assign({id:e.id>0?-1*e.id:e.id},e):e))),e.setComments(t.comments)}}},restoreCommentsFromCache:async function(t){e.fromCache(t,{merge:!0,queueRestored:!0})},setAddedCommentThisSession:function(t=!1){e.addedCommentThisSession=t},setCommentFormSubmit:function(t){e.commentFormSubmit=t},setInputRef:function(t){e.inputRef=t},setLoading:function(t=null){e.loading=t},setTooltipMessage:function(t){e.tooltipMessage=t},replaceId:function(t,n){const o=e.comments,i=o.findIndex((e=>e.id===t));if(i>-1){const e=(0,u.dV)(o[i]);o[i]=Object.assign({},e,{id:n.id||e.id})}},removeCommentById:function(t){const n=e.comments,o=n.findIndex((e=>e.id===t));o>-1&&n.splice(o,1)},persistQueuedComments:async function(){const t=e.queuedComments;if(e.canPersist&&t.length){!(0,j.VS)(j.K3)||e.annotationId||e.draftId||await e.store.submitDraft(e.annotation);try{e.setLoading("persistQueuedComments");for(const n of t){e.annotationId?n.annotation=e.annotationId:e.draftId?n.draft=e.draftId:n.task=e.taskId;const[t]=await e.sdk.invoke("comments:create",n);t&&e.replaceId(n.id,t)}}catch(e){console.error(e)}finally{e.setLoading(null)}}},setCurrentComment:function(t){e.currentComment=Object.assign({},e.currentComment,{[e.annotation.id]:t})},addCurrentComment:n,addComment:t,setComments:function(t,n=null){t&&(e.comments.replace(t),e.commentsKey=n)},listComments:o,setHighlightedComment:function(t){e.highlightedComment=t}}})),Og=u.gK.union(gn,fa,Ca,mg,Ta,Na,Xa,mc,ig,mg,ug,uu,Sg);var Ig,Lg,Ng;const zg=go("RegionStore"),Vg="outliner:sort",Hg="outliner:sort-direction",Bg="outliner:group",Fg="regionstore:view",Wg=u.gK.model({selected:u.gK.optional(u.gK.map(u.gK.safeReference(Og)),{}),drawingSelected:u.gK.optional(u.gK.map(u.gK.safeReference(Og)),{})}).views((e=>({get keys(){return Array.from(e.selected.keys())},get annotation(){return(0,u.PA)(e).annotation},get highlighted(){return 1===e.selected.size?e.selected.values().next().value:null},get size(){return e.selected.size},get list(){return Array.from(e.selected.values())},isSelected:t=>e.selected.has(t.id)}))).actions((e=>{const t=G((()=>{e._updateResultsFromSelection()}),0);return{beforeUnselect(e){e.perRegionTags.forEach((e=>null==e.submitChanges?void 0:e.submitChanges()))},afterUnselect(e){null==e.afterUnselectRegion||e.afterUnselectRegion()},drawingSelect(t){e.drawingSelected.put(t)},drawingUnselect(){Array.from(e.drawingSelected.values()).forEach((t=>{e.drawingSelected.delete(t.id)}))},select(n){var o;e.selected.put(n),n.selectRegion&&n.selectRegion(),e.highlighted?(e.highlighted.perRegionTags.forEach((e=>null==e.updateFromResult?void 0:e.updateFromResult(void 0))),e.highlighted.labelingTags.forEach((e=>null==e.updateFromResult?void 0:e.updateFromResult(void 0))),t()):t(),null==(o=n.object)||null==o.afterRegionSelected||o.afterRegionSelected(n)},_updateResultsFromSelection(){e._updateResultsFromRegions(e.selected.values())},_updateResultsFromRegions(t){const n={},o={};Array.from(t).map((e=>{e.results.forEach((e=>{const t=e.from_name.name,i=n[t];void 0!==i?n[t]=e.mergeMainValue(i):(o[t]=e.from_name,n[t]=e.mainValue)}))})),e.annotation.unselectStates();for(const[e,t]of Object.entries(n)){const n=o[e];null==n.updateFromResult||n.updateFromResult(t)}},unselect(t){e.beforeUnselect(t),e.selected.delete(t.id),e.afterUnselect(t)},clear(){const t=[...e.selected.values()];for(const n of t)e.beforeUnselect(n);e.selected.clear();for(const n of t)e.afterUnselect(n)},highlight(t){e.clear(),e.select(t)}}})),$g=u.gK.model("RegionStore",{sort:u.gK.optional(u.gK.enumeration(["date","score"]),null!=(Ig=window.localStorage.getItem(Vg))?Ig:"date"),sortOrder:u.gK.optional(u.gK.enumeration(["asc","desc"]),null!=(Lg=window.localStorage.getItem(Hg))?Lg:"asc"),group:u.gK.optional(u.gK.enumeration(["type","label","manual"]),(()=>{var e;return null!=(e=window.localStorage.getItem(Bg))?e:"manual"})),filter:u.gK.maybeNull(u.gK.array(u.gK.safeReference(Og)),null),view:u.gK.optional(u.gK.enumeration(["regions","labels"]),null!=(Ng=window.localStorage.getItem(Fg))?Ng:"regions"),selection:u.gK.optional(Wg,{})}).views((e=>{let t;const n=n=>(o,i)=>{if(o.shiftKey){const o=((e,n)=>{const o=[];let i=0;return L.traverseTree({children:n},(n=>{if(n.isArea)return n.item!==t&&n.item!==e&&1!==i||(n.item&&o.push(n.item),n.item===t&&++i,n.item===e&&++i),i>=2?E:void 0})),o})(i,n);return o.forEach((t=>{e.selection.select(t)})),void(t=null)}t=i,o.metaKey||o.ctrlKey?e.toggleSelection(i):e.selection.highlighted!==i?e.highlight(i):e.clearSelection()};return{get annotation(){return(0,u.PA)(e)},get classifications(){const t=Array.from(e.annotation.names.values()).filter((e=>(0,x.isDefined)(e))).filter((e=>"textarea"===e.type&&!e.perregion)).map((e=>e.regions));return[].concat(...t)},get regions(){return Array.from(e.annotation.areas.values()).filter((e=>!e.classification))},get filteredRegions(){return e.filter||e.regions},get suggestions(){return Array.from(e.annotation.suggestions.values()).filter((e=>!e.classification))},get isAllHidden(){return!e.regions.find((e=>!e.hidden))},get sortedRegions(){return{date:t=>[...e.filteredRegions].sort(t?(e,t)=>t.ouid-e.ouid:(e,t)=>e.ouid-t.ouid),score:t=>[...e.filteredRegions].sort(t?(e,t)=>t.score-e.score:(e,t)=>e.score-t.score)}[e.sort]("desc"===e.sortOrder)},get regionIndexMap(){const t={};return e.sortedRegions.forEach(((e,n)=>{t[e.id]=n+1})),t},getRegionsTree:t=>null===e.group||"manual"===e.group?e.asTree(t):"label"===e.group?e.asLabelsTree(t):"type"===e.group?e.asTypeTree(t):void console.error(`Grouping by ${e.group} is not implemented`),asTree(t){const o=e.sortedRegions,i=[],s=new Map,r=n(i);return o.forEach(((e,n)=>{const o=t(e,n,r);Object.assign(o,{item:e,children:[],isArea:!0}),s.set(e.cleanId,o)})),s.forEach((e=>{var t;const n=e.item.parentID,o=n?null!=(t=s.get(n))?t:s.get(n.replace(/#(.+)/i,"")):null;if(o)return o.children.push(e);i.push(e)})),i},asLabelsTree(t){const o={},i=[],s=n(i);let r=0;const a=(e,n,i)=>{var a;const l=((e,n)=>{const i=o[n];return i||(o[n]=Object.assign({},t(e,r,!0),{id:n,isGroup:!0,isNotLabel:!0,children:[]}))})(n,e),d=l.id,c=null==(a=(e=>{var t;return(null==(t=e.labeling)?void 0:t.selectedLabels)||e.emptyLabel&&[e.emptyLabel]})(i))||null==(a=a[0])?void 0:a.hotkey;(0,j.VS)(j.TU)&&(l.hotkey=c,l.pos=d.slice(0,d.indexOf("#"))),l.children.push(Object.assign({},t(i,r,!1,null,s,d),{item:i,isArea:!0}))},l=(e,t)=>{if(e)for(const n of e)a(`${n.value}#${n.id}`,n,t);else a("no-label",void 0,t)};for(const t of e.regions){var d;l(null==(d=t.labeling)?void 0:d.selectedLabels,t),r++}const c=Object.values(o);return(0,j.VS)(j.TU)&&c.sort(((e,t)=>e.hotkey>t.hotkey?1:e.hotkey<t.hotkey?-1:0)),i.push(...c),i},asTypeTree(t){const o={},i=[],s=n(i);let r=0;const a=e=>{const n=((e,n)=>{const i=o[n];if(i)return i;const s={type:"tool",value:n.replace("region",""),background:"#000"};return o[n]=Object.assign({},t(s,r,!0),{id:n,key:n,isArea:!1,children:[],isGroup:!0,entity:e})})(e,e.type);n.children.push(Object.assign({},t(e,r,!1,null,s),{item:e,isArea:!0}))};for(const t of e.regions)a(t),r++;return i.push(...Object.values(o)),i},get hasSelection(){return!!e.selection.size},isSelected:t=>e.selection.isSelected(t),get selectedIds(){return Array.from(e.selection.selected.values()).map((e=>e.id))},get persistantView(){var t;return null!=(t=window.localStorage.getItem(Fg))?t:e.view}}})).actions((e=>({addRegion(t){e.regions.push(t),(0,u._$)(e).events.invoke("entityCreate",t)},toggleSortOrder(){"asc"===e.sortOrder?e.sortOrder="desc":e.sortOrder="asc"},setView(t){(0,j.VS)(j.TU)&&window.localStorage.setItem(Fg,t),e.view=t},setSort(t){e.sort===t?e.toggleSortOrder():(e.sortOrder="asc",e.sort=t),window.localStorage.setItem(Vg,e.sort),window.localStorage.setItem(Hg,e.sortOrder),e.initHotkeys(),e.annotation.updateAppearenceFromState()},setGrouping(t){e.group=t,window.localStorage.setItem(Bg,e.group)},setFilteredRegions(t){if(e.regions.length===t.length)e.filter=null,e.regions.forEach((e=>e.filtered&&e.toggleFiltered()));else{const n=t.map((e=>e.id));e.filter=t,e.regions.forEach((e=>{!e.hideable||e.hidden&&!e.filtered||(n.includes(e.id)?e.hidden&&e.toggleFiltered():e.hidden||e.toggleFiltered())}))}e.annotation.updateAppearenceFromState()},deleteRegion(t){(0,u.Yo)(t);const n=e.filterByParentID(t.id);n&&n.forEach((e=>e.setParentID(t.parentID))),(0,u._$)(e).events.invoke("entityDelete",t),(0,u.zr)(t),e.initHotkeys()},findRegionID:t=>t?e.regions.find((e=>e.id===t)):null,findRegion:t=>e.findRegionID(t),filterByParentID:t=>e.regions.filter((e=>e.parentID===t)),normalizeRegionID:t=>t?(t.includes("#")||(t=`${t}#${e.annotation.id}`),t):"",afterCreate(){var t;(0,u.k4)(e,(t=>{"add"!==t.op&&"delete"!==t.op||-1===t.path.indexOf("/regions/")||e.initHotkeys()})),e.view=null!=(t=window.localStorage.getItem(Fg))?t:e.annotation.store.settings.displayLabelsByDefault?"labels":"regions"},initHotkeys(){zg.unbindAll(),e.sortedRegions.forEach(((t,n)=>{zg.addKey("alt+shift+"+(n+1),(()=>{e.unselectAll(),t.selectRegion()}))})),zg.addKey("alt+shift+$n",(()=>{}),"Select a region")},unselectAll(){e.annotation.unselectAll()},unhighlightAll(){e.regions.forEach((e=>e.setHighlight(!1)))},selectNext(){const{regions:t}=e,n=e.regions.findIndex((e=>e.selected));if(n<0){const n=t[0];n&&e.annotation.selectArea(n)}else{const o=(0,x.isDefined)(t[n+1])?t[n+1]:t[0];o&&e.annotation.selectArea(o)}},toggleVisibility(){const t=!e.isAllHidden;e.regions.forEach((e=>{e.hidden!==t&&e.toggleHidden()}))},selectRegionByID(t){const n=e.normalizeRegionID(t),o=e.findRegionID(n);o&&e.toggleSelection(o,!0)},setRegionVisible(t){const n=e.normalizeRegionID(t),o=e.findRegionID(n);o&&(e.regions.forEach((e=>{e.hidden||e.toggleHidden()})),o.toggleHidden())},setHiddenByTool(t,n){e.regions.forEach((e=>{e.hidden!==t&&e.type===n.type&&e.toggleHidden()}))},setHiddenByLabel(t,n){e.regions.forEach((e=>{if(e.hidden!==t){const t=e.labeling;if(t){t.selectedLabels.includes(n)&&e.toggleHidden()}}}))},highlight(t){e.selection.highlight(t)},clearSelection(){e.selection.clear()},selectRegionsByIds(t){e.regions.map((n=>{-1!==t.indexOf(n.id)&&e.toggleSelection(n,!0)}))},toggleSelection(t,n){(0,x.isDefined)(n)||(n=!e.selection.isSelected(t)),n?e.selection.select(t):e.selection.unselect(t)}})));var Ug;const Yg="relations:order",Xg=u.gK.model("Relation",{id:u.gK.optional(u.gK.identifier,T),node1:u.gK.reference(Cg),node2:u.gK.reference(Cg),direction:u.gK.optional(u.gK.enumeration(["left","right","bi"]),"right"),labels:u.gK.maybeNull(u.gK.array(u.gK.string))}).volatile((()=>({showMeta:!1,visible:!0}))).views((e=>({get parent(){return(0,u.k2)(e,Gg)},get control(){return e.parent.control},get selectedValues(){var t;return null==(t=e.labels)?void 0:t.filter((t=>{var n;return null==(n=e.control)?void 0:n.values.includes(t)}))},get hasRelations(){var t;return(null==(t=e.control)||null==(t=t.children)?void 0:t.length)>0},get shouldRender(){if(!(0,u._n)(e))return!1;const{node1:t,node2:n}=e,[o,i]=[t.item_index,n.item_index];return(!(0,x.isDefined)(o)||!t.object.multiImage||o===t.object.currentImage)&&(!(0,x.isDefined)(i)||!n.object.multiImage||i===n.object.currentImage)}}))).actions((e=>({rotateDirection(){const t=["left","right","bi"];let n=t.findIndex((t=>t===e.direction));n+=1,n>=t.length&&(n=0),e.direction=t[n]},toggleHighlight(){e.node1===e.node2?e.node1.toggleHighlight():(e.node1.toggleHighlight(),e.node2.toggleHighlight())},toggleMeta(){e.showMeta=!e.showMeta},setSelfHighlight(t=!1){t?e.parent.setHighlight(e):e.parent.removeHighlight()},toggleVisibility(){e.visible=!e.visible},setRelations(t){e.labels=t}}))),Gg=u.gK.model("RelationStore",{relations:u.gK.array(Xg),order:u.gK.optional(u.gK.enumeration(["asc","desc"]),null!=(Ug=window.localStorage.getItem(Yg))?Ug:"asc")}).volatile((()=>({showConnections:!0,_highlighted:null,control:null}))).views((e=>({get highlighted(){return e.relations.find((t=>t.id===e._highlighted))},get size(){return e.relations.length},get orderedRelations(){return e.relations?"asc"===e.order?e.relations.slice():e.relations.slice().reverse():[]},get isAllHidden(){return!e.relations.find((e=>!e.visible))},get values(){var t,n;return null!=(t=null==(n=e.control)?void 0:n.values)?t:[]}}))).actions((e=>({afterAttach(){const t=(0,u.Zn)(e);let n=null;L.traverseTree(t.annotationStore.root,(e=>{if("relations"===e.type)return n=e,K})),e.setControl(n)},setControl(t){e.control=t},findRelations(t,n){const o=t.id||t,i=(null==n?void 0:n.id)||n;return i?e.relations.filter((e=>e.node1.id===o&&e.node2.id===i)):e.relations.filter((e=>e.node1.id===o||e.node2.id===o))},nodesRelated:(t,n)=>e.findRelations(t,n).length>0,addRelation(t,n){if(e.nodesRelated(t,n))return;const o=Xg.create({node1:t,node2:n});return e.relations.push(o),o},deleteRelation(t){e.relations=e.relations.filter((e=>e.id!==t.id)),(0,u.zr)(t)},deleteNodeRelation(t){const n=e.findRelations(t);n.length&&n.forEach(e.deleteRelation)},deleteAllRelations(){e.relations.forEach((e=>(0,u.zr)(e))),e.relations=[]},serialize:()=>e.relations.map((e=>{const t={from_id:e.node1.cleanId,to_id:e.node2.cleanId,type:"relation",direction:e.direction};return e.selectedValues&&(t.labels=e.selectedValues),t})),deserializeRelation(t,n,o,i){const s=e.addRelation(t,n);s&&(s.direction=o,s.labels=i)},toggleConnections(){e.showConnections=!e.showConnections},toggleOrder(){e.order="asc"===e.order?"desc":"asc",window.localStorage.setItem(Yg,e.order)},toggleAllVisibility(){const t=!e.isAllHidden;e.relations.forEach((e=>{e.visible!==t&&e.toggleVisibility()}))},setHighlight(t){e._highlighted=t.id},removeHighlight(){e._highlighted=null}}))),Zg=Gg,qg=["id","value","type"],Jg=go("Annotations","Annotations");const Qg=u.gK.model("TrackedState",{areas:u.gK.map(Cg),relationStore:u.gK.optional(Zg,{})}),em=u.gK.model("AnnotationBase",Object.assign({id:u.gK.identifier,pk:u.gK.maybeNull(u.gK.string),selected:u.gK.optional(u.gK.boolean,!1),type:u.gK.enumeration(["annotation","prediction","history"]),createdDate:u.gK.optional(u.gK.string,sn.UDate.currentISODate()),createdAgo:u.gK.maybeNull(u.gK.string),createdBy:u.gK.optional(u.gK.string,"Admin"),user:u.gK.optional(u.gK.maybeNull(u.gK.safeReference(Ag)),null),score:u.gK.maybeNull(u.gK.number),parent_prediction:u.gK.maybeNull(u.gK.integer),parent_annotation:u.gK.maybeNull(u.gK.integer),last_annotation_history:u.gK.maybeNull(u.gK.integer),comment_count:u.gK.maybeNull(u.gK.integer),unresolved_comment_count:u.gK.maybeNull(u.gK.integer),loadedDate:u.gK.optional(u.gK.Date,(()=>new Date)),leadTime:u.gK.maybeNull(u.gK.number),draftSaved:u.gK.maybe(u.gK.string),userGenerate:u.gK.optional(u.gK.boolean,!0),sentUserGenerate:u.gK.optional(u.gK.boolean,!1),localUpdate:u.gK.optional(u.gK.boolean,!1),ground_truth:u.gK.optional(u.gK.boolean,!1),skipped:!1,trackedState:u.gK.optional(Qg,{}),history:u.gK.optional(tg,{targetPath:"../trackedState"}),dragMode:u.gK.optional(u.gK.boolean,!1),editable:u.gK.optional(u.gK.boolean,!0),readonly:u.gK.optional(u.gK.boolean,!1),suggestions:u.gK.map(Cg),regionStore:u.gK.optional($g,{regions:[]}),isDrawing:u.gK.optional(u.gK.boolean,!1),commentStore:u.gK.optional(Dg,{comments:[]})},(0,j.VS)(j.cE)?{root:Le.allModelsTypes()}:{})).views((e=>({get areas(){return e.trackedState.areas},get relationStore(){return e.trackedState.relationStore}}))).preProcessSnapshot((e=>{var t,n,o,i,s,r,a;let l,d=null!=(t=null!=(n=e.user)?n:e.completed_by)?t:void 0;const c=t=>{var n,o,i;const s=null==(n=t.children)?void 0:n.map(c),r=null==(o=t.imageEntities)?void 0:o.map(c);return s&&(t=Object.assign({},t,{children:s})),r&&(t=Object.assign({},t,{imageEntities:r})),t.id&&(t=Object.assign({},t,{id:`${null!=(i=t.name)?i:t.id}@${e.id}`})),t};return(0,j.VS)(j.cE)&&(l=c(e.root.toJSON())),d&&"number"!=typeof d&&(d=d.id),Object.assign({},e,(0,j.VS)(j.cE)?{root:l}:{},{user:d,editable:null!=(o=e.editable)?o:"annotation"===e.type,ground_truth:null!=(i=null!=(s=e.honeypot)?s:e.ground_truth)&&i,skipped:e.skipped||e.was_cancelled,acceptedState:null!=(r=null!=(a=e.accepted_state)?a:e.acceptedState)?r:null})})).views((e=>(0,j.VS)(j.cE)?{}:{get root(){return e.list.root},get names(){return e.list.names},get toNames(){return e.list.toNames}})).views((e=>({get store(){return(0,u.Zn)(e)},get list(){return(0,u.PA)(e,2)},get objects(){return Array.from(e.names.values()).filter((e=>e.isObjectTag))},get regions(){return Array.from(e.areas.values())},get lastSelectedRegion(){return e.selectedRegions[e.selectedRegions.length-1]},get results(){const t=[];return(0,u._n)(e)&&e.areas.forEach((e=>e.results.forEach((e=>t.push(e))))),t},get serialized(){return e.areas.toJSON(),e.results.map((e=>e.serialize())).filter(Boolean).concat(e.relationStore.serialize())},get serializedSelection(){e.areas.toJSON();const t=[];return e.areas.forEach((e=>{e.inSelection&&e.results.forEach((e=>{t.push(e)}))})),t.map((e=>e.serialize())).filter(Boolean)},get highlightedNode(){return e.regionStore.selection.highlighted},get hasSelection(){return e.regionStore.hasSelection},get selectionSize(){return e.regionStore.selection.size},get selectedRegions(){return Array.from(e.regionStore.selection.selected.values())},get selectedDrawingRegions(){return Array.from(e.regionStore.selection.drawingSelected.values())},get exists(){const t=e.userGenerate&&e.sentUserGenerate||(0,x.isDefined)(e.versions.result),n=(0,x.isDefined)(e.pk);return t&&n},get hasSuggestionsSupport(){return e.objects.some((e=>e.supportSuggestions))},get isNonEditableDraft(){if(!(!!e.user&&!!e.store.user))return!1;const t=null===e.pk,n=e.user.id!==e.store.user.id;return t&&n},isReadOnly:()=>e.isNonEditableDraft||e.readonly||!e.editable}))).volatile((()=>({hidden:!1,draftId:0,draftSelected:!1,autosaveDelay:5e3,isDraftSaving:!1,isSuggestionsAccepting:!1,submissionStarted:0,versions:{},resultSnapshot:""}))).volatile((()=>(0,j.VS)(j.cE)?{names:new Map,toNames:new Map,ids:new Map}:{})).views((e=>({get canBeReviewed(){var t,n,o;const i=e.store;return(0,j.VS)(j.I8)&&(null==(t=e.user)?void 0:t.email)&&(null==(n=i.user)?void 0:n.email)!==(null==(o=e.user)?void 0:o.email)&&(0,u._$)(e).events.hasEvent("acceptAnnotation")&&i.hasInterface("annotations:view-all")&&!e.skipped&&!isNaN(e.pk)}}))).actions((e=>({reinitHistory(t=!0){e.history.reinit(t),e.autosave&&e.autosave.cancel(),"annotation"===e.type&&e.setInitialValues()},setEditable(t){e.editable=t},setReadonly(t){e.readonly=t},setIsDrawing(t){e.isDrawing=t},setUnresolvedCommentCount(t){e.unresolved_comment_count=t},setCommentCount(t){e.comment_count=t},setGroundTruth(t,n=!0){const o=(0,u.Zn)(e);if(o&&o!==e&&n){const t=o.annotationStore,n=t=>{e!==t&&t.setGroundTruth(!1,!1)};t.predictions.forEach(n),t.annotations.forEach(n)}e.ground_truth=t,n&&(0,u._$)(e).events.invoke("groundTruth",e.store,e,t)},sendUserGenerate(){e.sentUserGenerate=!0},setLocalUpdate(t){e.localUpdate=t},setDragMode(t){e.dragMode=t},updatePersonalKey(t){var n,o;e.pk=t,null==(n=(o=(0,u.Zn)(e)).addAnnotationToTaskHistory)||n.call(o,e.pk)},toggleVisibility(t){e.hidden=void 0===t?!e.hidden:!t},setHighlightedNode(){},selectArea(t){e.highlightedNode!==t&&e.regionStore.highlight(t)},toggleRegionSelection(t,n){e.regionStore.toggleSelection(t,n)},selectAreas(t){e.unselectAreas(),e.extendSelectionWith(t)},extendSelectionWith(t){for(const n of Array.isArray(t)?t:[t])e.regionStore.toggleSelection(n,!0)},unselectArea(t){e.highlightedNode===t&&e.regionStore.toggleSelection(t,!1)},unselectAreas(){e.selectionSize&&e.regionStore.clearSelection()},hideSelectedRegions(){e.selectedRegions.forEach((e=>{e.toggleHidden()}))},deleteSelectedRegions(){e.selectedRegions.forEach((e=>{e.deleteRegion()}))},unselectStates(){e.names.forEach((e=>e.unselectAll&&e.unselectAll()))},unselectAll(t=!1){const n=t&&e.store.settings.continuousLabeling;e.unselectAreas(),n||e.unselectStates()},removeArea(e){(0,u.zr)(e)},deleteAllRegions({deleteReadOnly:t=!1}={}){let n=Array.from(e.areas.values());if(t)return e.unselectAll(!0),e.setIsDrawing(!1),e.relationStore.deleteAllRelations(),n.forEach((e=>{null==e.destroyRegion||e.destroyRegion(),(0,u.zr)(e)})),void e.updateObjects();!1===t&&(n=n.filter((e=>!1===e.readonly))),n.forEach((e=>e.deleteRegion())),e.updateObjects()},addRegion(t){e.regionStore.unselectAll(!0),e.isLinkingMode&&(e.addLinkedRegion(t),e.stopLinkingMode())},unloadRegionState(t){t.states&&t.states.forEach((t=>{const n=e.names.get(t.name);n.unselectAll&&n.unselectAll(),n.perRegionCleanup&&n.perRegionCleanup()}))},validate(){var t;let n=!0;return e.traverseTree((e=>{if(n=null==e.validate?void 0:e.validate(),!1===n)return E})),null==(t=n)||t},traverseTree:t=>L.traverseTree(e.root,t),beforeSend(){e.traverseTree((e=>{e&&e.beforeSend&&e.beforeSend()})),e.stopLinkingMode(),e.unselectAll()},deleteRegion(t){if(t.isReadOnly())return;const{regions:n}=e.regionStore,o=n.filter((e=>e.parentID===t.id));o&&o.forEach((e=>e.setParentID(t.parentID))),t.classification||(0,u._$)(e).events.invoke("entityDelete",t),e.relationStore.deleteNodeRelation(t),"polygonregion"===t.type&&(0,u.Yo)(t),(0,u.zr)(t),e.setIsDrawing(!1)},deleteArea(e){(0,u.zr)(e)},undo(){const{history:t,regionStore:n}=e;if(t&&t.canUndo){var o,i;let a=!1;const l=n.selectedIds,d=n.findRegion(null!=(o=l[l.length-1])?o:null==(i=n.regions[n.regions.length-1])?void 0:i.id);if("polygonregion"===(null==d?void 0:d.type)){var s,r;a=(null!=(s=null==d||null==(r=d.points)?void 0:r.length)?s:0)<=1}t.undo(),n.selectRegionsByIds(l),a&&(d.setDrawing(!1),e.setIsDrawing(!1))}},redo(){const{history:t,regionStore:n}=e;if(t&&t.canRedo){const e=n.selectedIds;t.redo(),n.selectRegionsByIds(e)}},updateObjects(t=!0){t&&e.unselectAll(),e.names.forEach((e=>e.needsUpdate&&e.needsUpdate())),e.updateAppearenceFromState();const n=Array.from(e.areas.values()).filter((e=>e.isDrawing));n.length&&e.regionStore.selection._updateResultsFromRegions(n)},updateAppearenceFromState(){e.areas.forEach((e=>null==e.updateAppearenceFromState?void 0:e.updateAppearenceFromState()))},setInitialValues(){e.names.forEach((e=>{if(e.type.endsWith("labels")){var t;const n=null==(t=e.children)?void 0:t.find((e=>e.initiallySelected));n&&n.setSelected(!0)}}))},setDefaultValues(){e.names.forEach((t=>{var n;["choices","taxonomy"].includes(null==t?void 0:t.type)&&null!=(n=t.preselectedValues)&&n.length&&e.createResult({},{[null==t?void 0:t.type]:t.preselectedValues},t,t.toname)}))},addVersions(t){e.versions=Object.assign({},e.versions,t),t.draft&&e.setDraftSelected()},toggleDraft(t){const n=e.draftSelected,o=null!=t?t:!n;o!==n&&(o&&!e.versions.draft||(e.autosave.flush(),e.pauseAutosave(),e.deleteAllRegions({deleteReadOnly:!0}),o?e.deserializeResults(e.versions.draft):e.deserializeResults(e.versions.result),e.draftSelected=o,e.updateObjects(),e.startAutosave()))},startAutosave:(0,u.L3)((function*(){if((0,u._$)(e).events.hasEvent("submitDraft")&&!e.isReadOnly()){if(yield(0,x.delay)(0),e.autosave)return e.autosave.cancel(),void(e.autosave.paused=!1);e.autosave=On()((()=>{e.autosave.paused||e.saveDraft()}),e.autosaveDelay,{leading:!1}),(0,u.aQ)(e.areas,e.autosave)}})),async saveDraft(t){if(e.submissionStarted)return;if(!e.editable)return;const n=e.serializeAnnotation({fast:!0});return(0,j.VS)(j.yP)||e.pk||n.length?(e.setDraftSelected(),e.versions.draft=n,e.setDraftSaving(!0),e.store.submitDraft(e,t).then((t=>(e.onDraftSaved(t),t)))):void 0},submissionInProgress(){e.submissionStarted=Date.now()},saveDraftImmediately(){e.autosave&&e.autosave.flush()},async saveDraftImmediatelyWithResults(t){if(e.submissionStarted||e.isDraftSaving)return{};e.setDraftSaving(!0);return await e.saveDraft(t)},pauseAutosave(){e.autosave&&(e.autosave.paused=!0,e.autosave.cancel())},beforeDestroy(){e.autosave&&e.autosave.cancel&&e.autosave.cancel()},setDraftId(t){e.draftId=t},setDraftSelected(t=!0){e.draftSelected=t},onDraftSaved(){e.setDraftSaved(sn.UDate.currentISODate()),e.setDraftSaving(!1)},dropDraft(){e.autosave&&(e.autosave.cancel(),e.draftId=0,e.draftSelected=!1,e.draftSaved=void 0,e.versions.draft=void 0)},setDraftSaving(t=!1){e.isDraftSaving=t},setDraftSaved(t){e.draftSaved=t},afterAttach(){e.traverseTree((e=>{e.annotationAttached&&e.annotationAttached()})),e.history.onUpdate(e.updateObjects),e.startAutosave()},afterCreate(){if((0,j.VS)(j.cE)){const{names:t,toNames:n}=L.extractNames(e.root);t.forEach(((t,n)=>e.names.set(n,t))),n.forEach(((t,n)=>e.toNames.set(n,t))),L.traverseTree(e.root,(t=>{var n;const o=null!=(n=t.id)?n:t.name;o&&e.ids.set(L.cleanUpId(o),t),e.store.task&&t.updateValue&&t.updateValue(e.store)}))}e.userGenerate&&!e.sentUserGenerate&&(e.loadedDate=new Date)},setupHotKeys(){Jg.unbindAll();let t=0,n=null;const o="shift+space";let i=o;e.traverseTree((e=>{e&&e.onHotKey&&e.hotkey&&Jg.addKey(e.hotkey,e.onHotKey,void 0,e.hotkeyScope)})),e.traverseTree((e=>{!e||e.hotkey||"audio"!==e.type&&"audioplus"!==e.type||(t>0?i=`${o}+${t+1}`:n=e,e.hotkey=i,Jg.addKey(i,e.onHotKey,"Play an audio",go.ALL_SCOPES),t++)})),e.traverseTree((e=>{if(e&&e.onHotKey&&!e.hotkey){const t=Jg.makeComb();if(!t)return;e.hotkey=t,Jg.addKey(e.hotkey,e.onHotKey)}})),n&&t>1&&(n.hotkey=`${o}+1`,Jg.addKey(n.hotkey,n.onHotKey),Jg.removeKey(o)),go.setScope(go.DEFAULT_SCOPE)},createResult(t,n,o,i,s=!1){var r,a;i||"textarea"!==o.type||(i=e.objects[0]);const l=e.names.get(null!=(r=i.name)?r:i),d={from_name:e.names.get(o.name),to_name:l,type:o.resultType,value:n,readonly:e.readonly},c=Object.assign({id:T(),object:l},t,{value:t,results:[d]}),h=null==e||null==(a=e.areas)?void 0:a.put(c);if(null==l||null==l.afterResultCreated||l.afterResultCreated(h),h)return e.updateAppearenceFromState(),h.classification||(0,u._$)(e).events.invoke("entityCreate",h),s||e.afterCreateResult(h,o),h},afterCreateResult(t,n){e.store.settings.selectAfterCreate?t.classification||setTimeout((()=>(0,u._n)(t)&&e.selectArea(t))):n.isLabeling&&e.unselectAll(!0)},appendResults(t){if(!e.editable||e.readonly)return;const n={},o=e.regionStore.regions.length;return t.forEach((e=>{const t=e.id;n[t]||(n[t]=T()),e.id=n[t]})),e.deserializeResults(t),e.updateObjects(),e.regionStore.regions.slice(o)},serializeAnnotation(t){document.body.style.cursor="wait";const n=e.results.map((e=>e.serialize(t))).filter(Boolean).concat(e.relationStore.serialize(t));return document.body.style.cursor="default",n},fixBrokenAnnotation:t=>(null!=t?t:[]).reduce(((t,n)=>{var o;const i=null!=(o=structuredClone(n))?o:{};if("relation"===i.type)return t.push(n),t;"htmllabels"===i.type&&(i.type="hypertextlabels"),i.normalization&&(i.meta=Object.assign({},i.meta,{text:[i.normalization]}));const s=e.names;if(i.type.endsWith("labels")){const t=Object.keys(i.value);for(const n of t)if(n.endsWith("labels")&&(!s.has(i.from_name)||!i.value[n].length&&!s.get(i.from_name).allowempty)&&(delete i.value[n],s.has(i.to_name))){const t=s.get(i.to_name),n=e.toNames.get(t.name);if(null!=n&&n.length){const e=i.type.replace(/labels$/,""),t=i.type,o="labels";for(const s of[e,t,o]){const e=n.find((e=>e.type===s));if(e){i.type=s,i.from_name=e.name;break}}}}}return s.has(i.from_name)&&s.has(i.to_name)&&t.push(i),(e=>{if(!(0,x.isDefined)(i.original_width))return;if(!s.has(i.to_name))return;const t=s.get(i.to_name);if("image"!==t.type)return;const n=t.findImageEntity(null!=(e=i.item_index)?e:0);n&&!n.imageLoaded&&(n.setNaturalWidth(i.original_width),n.setNaturalHeight(i.original_height))})(),t}),[]),setSuggestions(t){const{history:n}=e;e.suggestions.clear(),t&&(e.deserializeResults(t,{suggestions:!0}),e.isSuggestionsAccepting=!0,(0,u.Zn)(e).autoAcceptSuggestions?((0,j.VS)(j.$b)&&e.history.setReplaceNextUndoState(!0),e.acceptAllSuggestions()):e.suggestions.forEach((t=>{t.supportSuggestions||(e.acceptSuggestion(t.id),(0,j.VS)(j.$b)&&n.setReplaceNextUndoState(!0))})),e.isSuggestionsAccepting=!1,(0,j.VS)(j.$b)||n.freeze("richtext:suggestions"),e.names.forEach((e=>null==e.needsUpdate?void 0:e.needsUpdate({suggestions:!0}))),(0,j.VS)(j.$b)||(n.setReplaceNextUndoState(!0),n.unfreeze("richtext:suggestions")))},cleanClassificationAreas(){const t={},n=[];e.areas.forEach((e=>{const o=e.results[0].from_name.name,i=e.item_index;var s;e.classification&&(null!=(s=t[o])&&s[i]&&n.push(t[o][i]),t[o]=t[o]||{},t[o][i]=e.id)})),n.forEach((t=>e.areas.delete(t)))},deserializeResults(t,{suggestions:n=!1,hidden:o=!1}={}){try{const i=e.prepareAnnotation(t),s=n?e.suggestions:e.areas;e._initialAnnotationObj=i,i.forEach((t=>{e.deserializeSingleResult(t,(e=>s.get(e)),(e=>s.put(e)))})),e.cleanClassificationAreas(),!o&&e.results.filter((e=>e.area.classification)).forEach((e=>null==e.from_name.updateFromResult?void 0:e.from_name.updateFromResult(e.mainValue))),i.forEach((t=>{"relation"===t.type&&e.relationStore.deserializeRelation(`${t.from_id}#${e.id}`,`${t.to_id}#${e.id}`,t.direction,t.labels)}))}catch(t){console.error(t),e.list.addErrors([mr.generalError(t)])}},deserializeAnnotation:(...t)=>(console.warn("deserializeAnnotation() is deprecated. Use deserializeResults() instead"),e.deserializeResults(...t)),prepareAnnotation(t){var n;let o=t;return"object"!=typeof o&&(o=JSON.parse(o)),o=e.fixBrokenAnnotation(null!=(n=o)?n:[]),o},deserializeSingleResult(t,n,o){if("relation"!==t.type){var i;const{id:r,value:a,type:l}=t,d=(0,Zn.A)(t,qg);let{from_name:c,to_name:u}=d;const h=null!=(i=e.names.get(d.to_name))?i:{},g=h.type,m=`${r||T()}#${e.id}`,p=`${d.from_name}@${m}`,f=e.prepareValue(a,g);(0,j.VS)(j.cE)&&(u=`${u}@${e.id}`,c=`${c}@${e.id}`);let v=n(m);if(!v){v=o(Object.assign({id:m,object:u},d,function(e){const t=Object.assign({},e);return gt.properties.value.propertyNames.forEach((e=>{delete t[e]})),t}(f),{value:f})),(0,j.VS)(j.gF)&&Object.defineProperty(v,"_rawResult",{value:Object.freeze(structuredClone(t))})}const y=Object.assign({},d,{id:p,type:l,value:f,from_name:c,to_name:u});if(v.addResult(y),null==v.applyAdditionalDataFromResult||v.applyAdditionalDataFromResult(y),!l.endsWith("labels")&&f.labels&&h.mergeLabelsAndResults){const t=f.labels,n=e.toNames.get(h.name).filter((e=>e.type.endsWith("labels"))).find((e=>null==e?void 0:e.findLabel(t[0])));var s;if(n)v.setValue(n),null==(s=v.results.find((e=>e.type.endsWith("labels"))))||s.setValue(t)}}},prepareValue(e,t){switch(t){case"text":case"hypertext":case"richtext":{const t=(0,x.isDefined)(e.start)&&(0,x.isDefined)(e.end),n=!(0,x.isDefined)(e.startOffset)&&!(0,x.isDefined)(e.endOffset);if(t&&n)return Object.assign({},e,{start:"",end:"",startOffset:Number(e.start),endOffset:Number(e.end),isText:!0});break}default:return e}return e},acceptAllSuggestions(){Array.from(e.suggestions.keys()).forEach((t=>{e.acceptSuggestion(t)})),e.deleteAllDynamicregions((0,j.VS)(j.$b))},rejectAllSuggestions(){Array.from(e.suggestions.keys()).forEach((t=>{e.suggestions.delete(t)})),e.deleteAllDynamicregions((0,j.VS)(j.$b))},deleteAllDynamicregions(t=!1){e.regions.forEach((e=>{e.dynamic&&(t&&e.setDrawing(!0),e.deleteRegion())}))},acceptSuggestion(t){const n=e.suggestions.get(t);let o=t;const i=n.classification;if((0,j.VS)(j.jS))if(i){const t=n.results[0],i=e.areas.values();for(const e of i){const n=e.results[0];if(n.from_name===t.from_name&&n.to_name===t.to_name&&n.item_index===t.item_index){o=e.id;break}}}else{const t=e.areas.get(n.cleanId);t&&(o=t.id)}e.areas.set(o,Object.assign({},n.toJSON(),{id:o,fromSuggestion:!0}));const s=e.areas.get(o);s.object.activeStates().forEach((e=>{s.setValue(e)})),e.suggestions.delete(t)},rejectSuggestion(t){e.suggestions.delete(t)},resetReady(){e.objects.forEach((e=>e.setReady&&e.setReady(!1))),e.areas.forEach((e=>e.setReady&&e.setReady(!1)))}}))),tm=u.gK.compose("Annotation",U,em),nm=["reg","box","frame","workingArea","selected","draggable","listening","onDragMove"],om=(0,v.PA)((e=>{var t;let{reg:n,box:o,frame:i,workingArea:s,selected:r,draggable:a,listening:l,onDragMove:d}=e,c=(0,Zn.A)(e,nm);const u=xa(n,{includeFill:!0}),{realWidth:h,realHeight:g,scale:p}=s,f=(0,m.useMemo)((()=>({x:o.x*h/100,y:o.y*g/100,width:o.width*h/100,height:o.height*g/100,rotation:o.rotation})),[o,h,g]),v=e=>{const t=e.target;"dragmove"===e.type&&d(e),n.updateShape(((e,t)=>{const{realWidth:n,realHeight:o}=t;return{x:e.x()/n*100,y:e.y()/o*100,width:e.width()/n*100,height:e.height()/o*100,rotation:e.rotation()}})(t,s),i)};return(0,A.jsxs)(Xs.YJ,{children:[(0,A.jsx)(sa,{reg:n,box:f,scale:p,color:u.strokeColor,strokeWidth:u.strokeWidth,adjacent:!0}),(0,A.jsx)(Xs.rw,Object.assign({},f,{fill:null!=(t=u.fillColor)?t:"#fff",stroke:u.strokeColor,strokeScaleEnabled:!1,selected:r,draggable:a,listening:l,opacity:n.hidden?0:1,onTransform:e=>{((e,t)=>{const n=e.scaleX(),o=e.scaleY();"rect"===t&&(e.width(Math.max(or.X,e.width()*n)),e.height(Math.max(or.Y,e.height()*o)));e.scaleX(1),e.scaleY(1)})(e.target,"rect")},onTransformEnd:v,onDragMove:v,onDragEnd:v},c))]})})),im=(e,t,n,o,i)=>{const s=Math.sqrt(n*n+o*o);i+=Math.atan2(o,n);return{x:e+s*Math.cos(i),y:t+s*Math.sin(i)}},sm=(e,t=!0)=>(n,o)=>{if(!t)return o;const i=(e=>{const{x:t,y:n,width:o,height:i}=e,s=e.rotation,r=im(t,n,0,0,s),a=im(t,n,o,0,s),l=im(t,n,o,i,s),d=im(t,n,0,i,s),c=Math.min(r.x,a.x,l.x,d.x),u=Math.min(r.y,a.y,l.y,d.y);return{x:c,y:u,width:Math.max(r.x,a.x,l.x,d.x)-c,height:Math.max(r.y,a.y,l.y,d.y)-u}})(o),s=Object.assign({},o);return[i.x<=e.x,i.y<=e.y,i.x+i.width>=e.x+e.width,i.y+i.height>=e.y+e.height].some(Boolean)?n:s},rm=(e,t=!0)=>function(n){if(!t)return;const o=null!=this&&this.nodes?this.nodes():[n.target],i=(e=>{let t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;return e.forEach((e=>{t=Math.min(t,e.x),n=Math.min(n,e.y),o=Math.max(o,e.x+e.width),i=Math.max(i,e.y+e.height)})),{x:t,y:n,width:o-t,height:i-n}})(o.map((e=>e.getClientRect())));o.forEach((t=>{const n=t.getAbsolutePosition(),o=i.x-e.x-n.x,s=i.y-e.y-n.y,r=Object.assign({},n);i.x-e.x<0&&(r.x=-o),i.y-e.y<0&&(r.y=-s),i.x-e.x+i.width>e.width&&(r.x=e.width-i.width-o),i.y-e.y+i.height>e.height&&(r.y=e.height-i.height-s),t.setAbsolutePosition(r)}))},am=["reg","frame","stageRef"],lm=e=>(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Xs.rw,Object.assign({},e,{strokeWidth:2,stroke:"#fff"})),(0,A.jsx)(Xs.rw,Object.assign({},e,{fill:St()("#617ADA").alpha(.1).css(),strokeWidth:2,stroke:"#617ADA",dash:[2,2]}))]}),dm=(0,v.PA)((({regions:e,item:t,locked:n,isDrawing:o,workinAreaCoordinates:i,stageRef:s,onDragMove:r})=>(0,A.jsx)(A.Fragment,{children:e.map((e=>(0,A.jsx)(cm,{id:e.id,reg:e,frame:t.frame,workingArea:i,draggable:!e.isReadOnly()&&!o&&!n,selected:e.selected||e.inSelection,listening:!e.locked&&!e.hidden,stageRef:s,onDragMove:r},e.id)))}))),cm=(0,v.PA)((e=>{let{reg:t,frame:n,stageRef:o}=e,i=(0,Zn.A)(e,am);const s=t.getShape(n);return t.isInLifespan(n)&&s&&(0,A.jsx)(om,Object.assign({reg:t,box:s,frame:n,onClick:e=>{const n=(0,u.k2)(t,tm);n&&n.isLinkingMode&&(o.current.container().style.cursor=z.A.DEFAULT_CURSOR),t.setHighlight(!1),t.onClickRegion(e)}},i))})),um=(0,v.PA)((({item:e,regions:t,width:n,height:o,zoom:i,workingArea:s,locked:r=!1,allowRegionsOutsideWorkingArea:a=!0,pan:l={x:0,y:0},stageRef:d})=>{var c,u;const[h,g]=(0,m.useState)(),[p,f]=(0,m.useState)(!1),v=t.filter((t=>(t.selected||t.inSelection)&&!t.hidden&&!t.isReadOnly()&&t.isInLifespan(e.frame))),y=!r;t.map((e=>(0,x.fixMobxObserve)(e.sequence)));const b=(0,m.useMemo)((()=>{const e=s.width*i,t=s.height*i,r=Math.abs(l.x)>=Math.abs((n-e)/2),a=Math.abs(l.y)>=Math.abs((o-t)/2),d=l.x>0?1:-1,c=l.y>0?1:-1,u=(Math.abs(l.x)-Math.abs((n-e)/2))*d,h=(Math.abs(l.y)-Math.abs((o-t)/2))*c,g=r?u:0,m=a?h:0;return{width:e,height:t,x:(n-e)/2+l.x-g,y:(o-t)/2+l.y-m,scale:i,realWidth:s.width,realHeight:s.height}}),[l.x,l.y,i,s,n,o]),S=(0,m.useMemo)((()=>({width:b.width,height:b.height,scaleX:i,scaleY:i,position:{x:b.x,y:b.y}})),[b,i]),w=(0,m.useCallback)(((e,t)=>{const{x:n,y:o}=b;return{x:(e-n)/i,y:(t-o)/i}}),[b,i]);(0,m.useEffect)((()=>{if(!p&&h){const{width:t,height:n}=s;let o=h.x/t*100,i=h.y/n*100,r=h.width/t*100,a=h.height/n*100;r<0&&(r*=-1,o-=r),a<0&&(a*=-1,i-=a);const l={x:o,y:i,width:r,height:a};e.addVideoRegion(l),g(null)}}),[p,b,s]);const k=({x:e,y:t})=>a?{x:e,y:t}:{x:(0,li.clamp)(e,0,b.realWidth),y:(0,li.clamp)(t,0,b.realHeight)},C=y?{onMouseDown:t=>{var n;if(t.target!==d.current||null!=(n=e.annotation)&&n.isReadOnly())return;const{x:o,y:i}=k(w(t.evt.offsetX,t.evt.offsetY)),s=((e,t)=>!!a||e>0&&t>0&&e<b.realWidth&&t<b.realHeight)(o,i);s&&(e.annotation.unselectAreas(),g({x:o,y:i,width:0,height:0}),f(!0))},onMouseMove:t=>{var n;if(!p||null!=(n=e.annotation)&&n.isReadOnly())return!1;const{x:o,y:i}=k(w(t.evt.offsetX,t.evt.offsetY));g((e=>Object.assign({},e,{width:o-e.x,height:i-e.y})))},onMouseUp:t=>{var n;if(!p||null!=(n=e.annotation)&&n.isReadOnly())return!1;const{x:o,y:i}=k(w(t.evt.offsetX,t.evt.offsetY));Math.abs(h.x-o)<5&&Math.abs(h.y-i)<5?g(null):g((e=>Object.assign({},e,{width:o-e.x,height:i-e.y}))),f(!1)}}:{};return(0,A.jsxs)(Xs.BI,Object.assign({ref:d,width:n,height:o,style:{position:"absolute",zIndex:1},listening:y},C,{children:[(0,A.jsx)(Xs.Wd,Object.assign({},S,{children:(0,A.jsx)(dm,{regions:t,item:e,layerProps:S,locked:r,isDrawing:p,workinAreaCoordinates:b,onDragMove:rm(b,!a),stageRef:d})})),null!=(c=e.annotation)&&c.isReadOnly()||!p?null:(0,A.jsx)(Xs.Wd,Object.assign({},S,{children:(0,A.jsx)(lm,Object.assign({},h))})),(null==(u=e.annotation)||!u.isReadOnly())&&(null==v?void 0:v.length)>0?(0,A.jsx)(Xs.Wd,{children:(0,A.jsx)(Xs.Ge,{ref:e=>{if(!e)return;const t=e.getStage(),n=v.map((e=>t.findOne(`#${e.id}`))).filter(Boolean);e.nodes(n),e.getLayer().batchDraw()},keepRatio:!1,ignoreStroke:!0,flipEnabled:!1,boundBoxFunc:sm(b,!a),onDragMove:rm(b,!a)})}):null]}))})),hm=(0,j.VS)(j.vS);const gm=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{var n,o;if(!e._value)return null;const i=!t.settings.videoDrawOutside,s=(0,m.useRef)(),r=(0,m.useRef)(),a=(0,m.useRef)(),l=(0,m.useRef)(),[d,c]=(0,m.useState)(!1),[u,h]=(0,m.useState)(0),[g,p]=(0,m.useState)(!1),[f,v]=(0,m.useState)(1),[y,b]=(0,m.useState)(null),[S,w]=(0,m.useState)({width:0,height:0,ratio:1}),[{zoom:k,pan:C},{setZoomAndPan:j,setZoom:R,setPan:_}]=function(e,t,n){const[o,i]=(0,m.useState)({zoom:1,pan:{x:0,y:0}}),s=(0,m.useRef)({});s.current.video=e,s.current.canvas=t,s.current.shouldClampPan=n;const r=(0,m.useCallback)(((e,t)=>{if(!n)return e;const o=(0,x.clamp)((s.current.video.width*t-s.current.canvas.width)/2,0,Number.POSITIVE_INFINITY),i=(0,x.clamp)((s.current.video.height*t-s.current.canvas.height)/2,0,Number.POSITIVE_INFINITY);return{x:(0,x.clamp)(e.x,-o,o),y:(0,x.clamp)(e.y,-i,i)}}),[]);return[o,{setZoomAndPan:(0,m.useCallback)((e=>i((t=>{const n=e instanceof Function?e(t):e,{zoom:o,pan:i}=t,s=qh(n.zoom);if(s===o)return t;if(s===n.zoom)return{zoom:n.zoom,pan:r(n.pan,n.zoom)};const a=(s-o)/(n.zoom-o),l={x:i.x+(n.pan.x-i.x)*a,y:i.y+(n.pan.y-i.y)*a};return{pan:r(l,s),zoom:s}}))),[]),setZoom:(0,m.useCallback)((e=>i((({zoom:t,pan:n})=>{const o=qh(e instanceof Function?e(t):e);return{zoom:o,pan:{x:n.x/t*o,y:n.y/t*o}}}))),[]),setPan:(0,m.useCallback)((e=>i((t=>(e=e instanceof Function?e(t.pan):e,Object.assign({},t,{pan:e}))))),[])}]}(S,e.ref.current?{width:e.ref.current.width,height:e.ref.current.height}:{width:0,height:0},i),[T,K]=(0,m.useState)(!1),[E,P,M,D]=Pc(!1),O=Dh({onEnterFullscreen(){P()},onExitFullscreen(){M()}}),I=(0,m.useCallback)((e=>{if(e!==f&&u){const t=(0,x.clamp)(e,1,u);v(t)}}),[f,u]),L=(0,m.useCallback)((e=>{e!==u&&h(e)}),[u]),N=(0,m.useMemo)((()=>(0,x.isDefined)(null==e?void 0:e.videoControl)),[e]),V=(0,m.useMemo)((()=>(0,x.isDefined)(null==e?void 0:e.timelineControl)),[e]);(0,m.useEffect)((()=>{const e=a.current,t=e=>{e.shiftKey&&e.preventDefault()};return e.addEventListener("wheel",t),()=>e.removeEventListener("wheel",t)}),[]),(0,m.useEffect)((()=>{const e=e=>{if(e.code.startsWith("Shift")&&(e.preventDefault(),!T)){K(!0);const e=t=>{t.code.startsWith("Shift")&&(K(!1),document.removeEventListener("keyup",e))};document.addEventListener("keyup",e)}};document.addEventListener("keydown",e);const t=new X((()=>(()=>{const e=a.current;e&&b([e.clientWidth,e.clientHeight])})())),[n,o]=[a.current,s.current];return t.observe(n),t.observe(o),()=>{document.removeEventListener("keydown",e),t.unobserve(n),t.unobserve(o),t.disconnect()}}),[]),(0,m.useEffect)((()=>{const e=O.getElement();E&&!e?O.enter(l.current):!E&&e&&O.exit()}),[E]);const H=(0,m.useCallback)((t=>{if(!t.shiftKey||!r.current)return;const n=0===Math.abs(t.deltaY)?t.deltaX:t.deltaY,o=n>0?1:-1,i=Math.abs(25e-5*n),s=o*(0,x.clamp)(i,.05,.5);requestAnimationFrame((()=>{j((({zoom:t,pan:n})=>{const o=t+s,i=o/t,a=r.current.pointerPos.x-e.ref.current.width/2,l=r.current.pointerPos.y-e.ref.current.height/2;return{zoom:o,pan:{x:n.x*i+a*(1-i),y:n.y*i+l*(1-i)}}}))}))}),[]),B=(0,m.useCallback)((t=>{if(!T)return;const n=t.pageX,o=t.pageY,i=t=>{const i=e.ref.current.adjustPan(C.x+(t.pageX-n),C.y+(t.pageY-o));requestAnimationFrame((()=>{_(i)}))},s=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)}),[T,C]),F=(0,m.useCallback)((()=>{R((e=>e+.1))}),[]),W=(0,m.useCallback)((()=>{R((e=>e-.1))}),[]),$=(0,m.useCallback)((()=>{j({zoom:e.ref.current.videoDimensions.ratio,pan:{x:0,y:0}})}),[]),U=(0,m.useCallback)((()=>{j({zoom:1,pan:{x:0,y:0}})}),[]),Y=(0,m.useCallback)(((t,n)=>{I(t),L(n),e.setOnlyFrame(t)}),[e,I,L]),G=(0,m.useCallback)((({length:t,videoDimensions:n})=>{c(!0),R(n.ratio),w(n),L(t),e.setOnlyFrame(1),e.setLength(t),e.setReady(!0)}),[e,L]),Z=(0,m.useCallback)((e=>{w(e)}),[]),q=(0,m.useCallback)((()=>{p(!1),I(u)}),[u,I,p]),J=(0,m.useCallback)((()=>{p((t=>hm?(e.ref.current.playing||(e.ref.current.play(),e.triggerSyncPlay()),!0):!1===t?(e.ref.current.play(),e.triggerSyncPlay(),!0):t))}),[]),Q=(0,m.useCallback)((()=>{p((t=>hm?(e.ref.current.playing&&(e.ref.current.pause(),e.triggerSyncPause()),!1):!0===t?(e.ref.current.pause(),e.triggerSyncPause(),!1):t))}),[]),ee=(0,m.useCallback)(((t,n,o)=>{const i=e.findRegion(n),s=(null==i?void 0:i.selected)||(null==i?void 0:i.inSelection);!i||(0,x.isDefined)(o)&&s===o||i.onClickRegion()}),[e]),te=(0,m.useCallback)(((t,n,o)=>{e.regs.filter((e=>e.selected||e.inSelection)).forEach((e=>{switch(n){case"lifespan_add":case"lifespan_remove":e.toggleLifespan(o.frame);break;case"keypoint_add":e.addKeypoint(o.frame);break;case"keypoint_remove":e.removeKeypoint(o.frame);break;default:console.warn("unknown action")}}))}),[e.regs]),ne=(0,m.useCallback)((t=>{f!==t&&(e.setFrame(t),I(t))}),[e,f]);(0,m.useEffect)((()=>()=>{e.ref.current=null}),[]);const oe=e.regs.map((e=>{var t,n,o,i;const s=null!=(t=null!=(n=null==(o=e.style)?void 0:o.fillcolor)?n:null==(i=e.tag)?void 0:i.fillcolor)?t:z.l.fillcolor,r=e.labels.join(", ")||"Empty",a=e.type.includes("timeline"),l=e.sequence;return{id:e.cleanId,index:e.region_index,label:r,color:s,visible:!e.hidden,selected:e.selected||e.inSelection,sequence:l,timeline:a}}));if(e.timelineControl&&oe.reverse(),null!=(n=e.timelineControl)&&null!=(n=n.selectedLabels)&&n.length&&!e.annotation.selectionSize&&!e.drawingRegion){const t=e.timelineControl.selectedLabels[0];oe.unshift({id:"new",label:t.value,color:t.background,visible:!0,selected:!0,sequence:[],timeline:!0})}return(0,A.jsx)(En,{item:e,children:(0,A.jsxs)(Qe.eB,{name:"video-segmentation",ref:l,mod:{fullscreen:E},children:[null==(o=e.errors)?void 0:o.map(((e,t)=>(0,A.jsx)(Ee,{error:e},`err-${t}`))),(0,A.jsx)(Qe.eB,{name:"video",mod:{fullscreen:E},ref:s,children:(0,A.jsx)(Qe.Sl,{name:"main",ref:a,style:{height:Number(e.height)},onMouseDown:B,onWheel:H,children:y&&(0,A.jsxs)(A.Fragment,{children:[d&&N&&(0,A.jsx)(um,{item:e,zoom:k,pan:C,locked:T,regions:e.regs,width:y[0],height:y[1],workingArea:S,allowRegionsOutsideWorkingArea:!i,stageRef:r}),(0,A.jsx)(eg,{ref:e.ref,src:e._value,width:y[0],height:y[1],muted:e.muted,zoom:k,pan:C,speed:e.speed,framerate:e.framerate,allowInteractions:!1,allowPanOffscreen:!i,onFrameChange:Y,onLoad:G,onResize:Z,onEnded:q,onPlay:J,onPause:Q,onSeeked:e.handleSeek})]})})}),d&&(0,A.jsx)(Qe.Sl,{name:"timeline",tag:Ei,playing:g,length:u,position:f,regions:oe,height:e.timelineheight,altHopSize:t.settings.videoHopSize,allowFullscreen:!1,fullscreen:E,defaultStepSize:16,disableView:!V&&!N,framerate:e.framerate,controls:{FramesControl:!0},customControls:[{position:"left",component:()=>(0,A.jsx)(Wh.Trigger,{inline:E,content:(0,A.jsxs)(Yh,{size:"auto",closeDropdownOnItemClick:!1,children:[(0,A.jsx)(Yh.Item,{onClick:F,children:"Zoom In"}),(0,A.jsx)(Yh.Item,{onClick:W,children:"Zoom Out"}),(0,A.jsx)(Yh.Item,{onClick:$,children:"Zoom To Fit"}),(0,A.jsx)(Yh.Item,{onClick:U,children:"Zoom 100%"})]}),children:(0,A.jsx)(Po,{size:"small",nopadding:!0,children:(0,A.jsx)(To.mc3,{})})},"dd")}],onPositionChange:ne,onPlay:J,onPause:Q,onFullscreenToggle:D,onSelectRegion:ee,onStartDrawing:e.startDrawing,onFinishDrawing:e.finishDrawing,onAction:te})]})})})));b.addTag("video",ag,gm),b.addObjectType(ag);var mm=n(76694);const pm={board:"board--RCWAA",column:"column--gZT9f",columnTitle:"columnTitle--D1Oix",expanded:"expanded--IxfAA",collapsed:"collapsed--wo2M4",item:"item--SAih8",itemLine:"itemLine--J7fhn",itemTitle:"itemTitle--cZnga",dropArea:"dropArea--OHu8G"},fm=e=>{var t;const{item:n,index:o,readonly:i}=e,s=(0,m.useMemo)((()=>n.html?(0,Ke.sanitizeHtml)(n.html):""),[n.html]),[r,a,l]=(0,m.useContext)(Sm),d=null!=(t=a[n.id])&&t,c=r?()=>l(n.id,!d):void 0,u=[pm.item,"htx-ranker-item"];return r&&u.push(d?pm.collapsed:pm.expanded),(0,A.jsx)(mm.sx,{draggableId:n.id,index:o,isDragDisabled:i,children:e=>(0,A.jsxs)("div",Object.assign({},e.draggableProps,e.dragHandleProps,{style:Object.assign({},e.draggableProps.style),className:u.join(" "),ref:e.innerRef,"data-ranker-id":n.id,children:[n.title&&(0,A.jsx)("h3",{className:pm.itemTitle,onClick:c,children:n.title}),n.body&&(0,A.jsx)("p",{className:pm.itemLine,children:n.body}),n.html&&(0,A.jsx)("p",{className:pm.itemLine,dangerouslySetInnerHTML:{__html:s}}),(0,A.jsx)("p",{className:pm.itemLine,children:n.id})]}))})},vm=["children"],ym=e=>{let{children:t}=e,n=(0,Zn.A)(e,vm);const[o,i]=(0,m.useState)(!1);return(0,m.useEffect)((()=>{const e=requestAnimationFrame((()=>i(!0)));return()=>{cancelAnimationFrame(e)}}),[]),o?(0,A.jsx)(mm.gL,Object.assign({},n,{children:t})):null},bm=({items:e,title:t})=>{const[,n,o]=(0,m.useContext)(Sm),i=e.every((e=>n[e.id]));return(0,A.jsxs)("h1",{className:[pm.columnTitle,i?pm.collapsed:pm.expanded].join(" "),children:[t,(0,A.jsx)("button",{type:"button",onClick:()=>o(e.map((e=>e.id)),!i),children:(0,A.jsx)("span",{})})]})},xm=e=>{const{column:t,items:n,readonly:o}=e,[i]=(0,m.useContext)(Sm),s=i?(0,A.jsx)(bm,{items:n,title:t.title}):(0,A.jsx)("h1",{className:pm.columnTitle,children:t.title});return(0,A.jsxs)("div",{className:[pm.column,"htx-ranker-column"].join(" "),children:[s,(0,A.jsx)(ym,{droppableId:t.id,children:e=>(0,A.jsxs)("div",Object.assign({ref:e.innerRef},e.droppableProps,{className:pm.dropArea,children:[n.map(((e,t)=>(0,A.jsx)(fm,{item:e,index:t,readonly:o},e.id))),e.placeholder]}))})]})},Sm=(0,m.createContext)([!0,{},(e,t)=>{}]),wm=({inputData:e,handleChange:t,readonly:n,collapsible:o=!0})=>{const[i,s]=(0,m.useState)(e),[r,a]=(0,m.useState)({}),l=(0,m.useCallback)(((e,t)=>{const n=(Array.isArray(e)?e:[e]).reduce(((e,n)=>Object.assign({},e,{[n]:t})),{});a((e=>Object.assign({},e,n)))}),[]);(0,m.useEffect)((()=>{s(e)}),[e]);return(0,A.jsx)(Sm.Provider,{value:[o,r,l],children:(0,A.jsx)(mm.JY,{onDragEnd:e=>{var n;const{destination:o,source:r,draggableId:a}=e;if(!o||o.droppableId===r.droppableId&&o.index===r.index)return;const l=i.columns.find((e=>e.id===r.droppableId)),d=i.columns.find((e=>e.id===o.droppableId));if(l===d){const e=[...i.itemIds[r.droppableId]];e.splice(r.index,1),e.splice(o.index,0,a);const n=Object.assign({},i.itemIds,{[r.droppableId]:e}),l=Object.assign({},i,{itemIds:n});return s(l),void(t&&t(n))}const c=[...i.itemIds[r.droppableId]];c.splice(r.index,1);const u=[...null!=(n=i.itemIds[o.droppableId])?n:[]];u.splice(o.index,0,a);const h=Object.assign({},i.itemIds,{[r.droppableId]:c,[o.droppableId]:u}),g=Object.assign({},i,{itemIds:h});t&&t(h),s(g)},children:(0,A.jsx)("div",{className:pm.board,children:(0,A.jsx)(A.Fragment,{children:i.columns.map((e=>{var t,o;const s=null!=(t=null==(o=i.itemIds[e.id])?void 0:o.map((e=>i.items[e])))?t:[];return(0,A.jsx)(xm,{column:e,items:s,readonly:n},e.id)}))})})})})},km=u.gK.model({type:"list",value:u.gK.maybeNull(u.gK.string),_value:u.gK.frozen([]),title:u.gK.optional(u.gK.string,"")}).views((e=>({get ranker(){var t;return null==(t=e.annotation.toNames.get(e.name))?void 0:t.filter((e=>"ranker"===e.type))},get items(){return Object.fromEntries(e._value.map((e=>[e.id,e])))}}))).views((e=>({get dataSource(){return{items:e.items,columns:[{id:e.name,title:e.title}],itemIds:{[e.name]:Object.keys(e.items)}}},get result(){var t;return null==(t=e.annotation)?void 0:t.results.find((t=>t.from_name===e))}}))).actions((e=>({updateValue(t){const n=k(e.value,t.task.dataObj);Array.isArray(n)&&(e._value=n.map((e=>Object.assign({},e,{id:String(e.id)}))))}}))),Cm=u.gK.compose("ListModel",Sn,Ue,Ne,km),jm=(0,v.WQ)("store")((0,v.PA)((({item:e})=>{const t=e.dataSource;return t?e.ranker?null:(0,A.jsx)(m.StrictMode,{children:(0,A.jsx)(wm,{inputData:t,readonly:!0})}):null})));b.addTag("list",Cm,jm),b.addObjectType(Cm);const Rm=e=>(e<10?"0":"")+e,_m=u.gK.model({toname:u.gK.maybeNull(u.gK.string),format:u.gK.maybeNull(u.gK.string),only:u.gK.maybeNull(u.gK.string),min:u.gK.maybeNull(u.gK.string),max:u.gK.maybeNull(u.gK.string),step:u.gK.maybeNull(u.gK.string),defaultvalue:u.gK.maybeNull(u.gK.string),hotkey:u.gK.maybeNull(u.gK.string)}),Tm=u.gK.model({pid:u.gK.optional(u.gK.string,T),type:"datetime"}).views((e=>({selectedValues:()=>e.datetime,get holdsState(){return!(e.onlyTime&&!(0,x.isDefined)(e.time))&&((0,x.isDefined)(e.month)||(0,x.isDefined)(e.year))},get showDate(){return!e.only||e.only.includes("date")},get showTime(){return!e.only||e.only.includes("time")},get onlyTime(){return"time"===e.only},get showMonth(){var t,n;return(null==(t=e.only)?void 0:t.includes("month"))&&!(null!=(n=e.only)&&n.includes("date"))},get showYear(){var t;return null==(t=e.only)?void 0:t.includes("year")},getISODate(t){if(e.onlyYear)return t;if(e.onlyTime)return;const n=e.parseDateTime(t);return[n.getFullYear(),Rm(n.getMonth()+1),Rm(n.getDate())].join("-")},get date(){var t;return null!=(t=e.only)&&t.includes("year")?e.year:e.month&&e.year?[e.year,Rm(e.month),Rm(e.day)].join("-"):void 0},get datetime(){const t=e.time||"00:00";if(e.onlyTime)return t;if(!e.date)return e.year?e.year:void 0;const n=new Date(e.date+"T"+t);return e.formatDateTime(n)},get isValid(){return!(e.min&&e.date<e.min)&&!(e.max&&e.date>e.max)}}))).volatile((()=>({updateValue:!1,day:void 0,month:void 0,year:void 0,time:void 0}))).volatile((e=>{let t;return t=e.onlyTime?String:e.format?e.format:e.showTime?"%Y-%m-%dT%H:%M":"%Y-%m-%d",{formatTime:oh.DCK("%H:%M"),formatDateTime:oh.DCK(t),parseDateTime:oh.T6w(t)}})).volatile((e=>{var t,n;const o=[],i=[],s=oh.DCK("%B"),r=new Date,a=t=>{var n;return"current"===t?r.getFullYear():4===t.length?Number.parseInt(t):null==(n=e.parseDateTime(t))?void 0:n.getFullYear()},l=a(null!=(t=e.min)?t:"2000");for(let t=a(null!=(n=e.max)?n:"current");t>=l;t--)o.push(t);r.setDate(1);for(let e=0;e<12;e++)r.setMonth(e),i[e]=s(r);return{months:i,years:o}})).actions((e=>({setNeedsUpdate(t){e.updateValue=t},needsUpdate(){e.setNeedsUpdate(!0),e.result?e.setDateTime(e.result.mainValue):e.resetDateTime()},unselectAll(){},resetDate(){e.day=void 0,e.month=void 0,e.year=void 0},resetDateTime(){e.resetDate(),e.time=void 0},validDateFormat(e){const t=e.split("-").map((e=>Number.parseInt(e,10))),n=t[0];return!(isNaN(new Date(e))||!(n<=9999&&n>=1e3))&&t},setDateTime(t){if(e.onlyTime)return void(e.time=t);const n=e.parseDateTime(t);if(!n)return e.resetDateTime();e.day=n.getDate(),e.month=n.getMonth()+1,e.year=n.getFullYear(),e.showTime&&(e.time=e.formatTime(n))},onMonthChange(t){e.month=+t||void 0,e.updateResult()},onYearChange(t){e.year=+t||void 0,e.updateResult()},setDate(t){t?(e.day=t[2],e.month=t[1],e.year=t[0]):(e.day=void 0,e.month=void 0,e.year=void 0),e.updateResult()},onTimeChange(t){e.time=t.target.value||void 0,e.updateResult()},updateFromResult(){this.needsUpdate()},requiredModal(){yn.warning(e.requiredmessage||`DateTime "${e.name}" is required.`)}}))).actions((e=>{const t={validateValue:e.validateValue};return{validateValue(n){var o;if(!t.validateValue(n))return!1;const i=[];if(!n)return!0;let s=e.getISODate(n);null!=(o=e.only)&&o.includes("year")&&(s=s.slice(0,4));const{min:r,max:a}=e;return r&&s<r&&i.push(`min date is ${r}`),a&&s>a&&i.push(`max date is ${a}`),!i.length||(yn.warning(`Date "${s}" is not valid: ${i.join(", ")}.`),!1)}}})),Am=u.gK.compose("DateTimeModel",Td,fc,tc,qe,pt,...(0,j.VS)(j.gF)?[Qd]:[],Ne,_m,Tm),Km=(0,v.WQ)("store")((0,v.PA)((({item:e})=>{var t;const n=e.isReadOnly(),o=e.perRegionVisible()?{margin:"0 0 1em"}:{display:"none"},i={style:{width:"auto",marginRight:"4px",borderColor:e.isValid?void 0:"red"}},[s,r]=[e.min,e.max].map((e=>{var t;return null==e||null==(t=e.match(/\d?\d:\d\d/))?void 0:t[0]})),[a,l]=(0,m.useState)("");e.updateValue&&(!e.showDate||void 0!==e.date&&e.date===a||l(e.date||""),e.setNeedsUpdate(!1));return(0,A.jsxs)("div",{className:"htx-datetime",style:o,ref:e.elementRef,children:[e.showMonth&&(0,A.jsx)(Qn.l6P,Object.assign({},i,{name:`${e.name}-date`,disabled:n,value:e.month,placeholder:"Month...",onChange:t=>n?void 0:e.onMonthChange(t),options:e.months.map(((e,t)=>({value:t+1,label:e}))),isInline:!0})),e.showYear&&(0,A.jsx)(Qn.l6P,Object.assign({},i,{name:`${e.name}-year`,disabled:n,value:e.year||"",placeholder:"Year...",onChange:t=>n?void 0:e.onYearChange(t),options:e.years,isInline:!0})),e.showDate&&(0,A.jsx)("input",Object.assign({},i,{type:"date",readOnly:n,name:`${e.name}-date`,value:a,min:e.min,max:e.max,onChange:n?void 0:t=>{const n=t.target.value,o=e.validDateFormat(n);l(n),n&&!o||e.setDate(o)},onBlur:n?void 0:()=>{a!==e.date&&l(e.date||"")}})),e.showTime&&(0,A.jsx)("input",Object.assign({},i,{type:"time",readOnly:n,name:`${e.name}-time`,value:null!=(t=e.time)?t:"",min:s,max:r,onChange:n?void 0:e.onTimeChange}))]})})));b.addTag("datetime",Am,Km);const Em=u.gK.model({toname:u.gK.maybeNull(u.gK.string),min:u.gK.maybeNull(u.gK.string),max:u.gK.maybeNull(u.gK.string),step:u.gK.maybeNull(u.gK.string),defaultvalue:u.gK.maybeNull(u.gK.string),slider:u.gK.optional(u.gK.boolean,!1),hotkey:u.gK.maybeNull(u.gK.string)}),Pm=u.gK.model({pid:u.gK.optional(u.gK.string,T),type:"number",number:u.gK.maybeNull(u.gK.number)}).views((e=>({selectedValues:()=>e.number,get holdsState(){return(0,x.isDefined)(e.number)}}))).actions((e=>{const t={validateValue:e.validateValue};return{validateValue(n){if(!t.validateValue(n))return!1;if(!(0,x.isDefined)(n))return!0;const o=[];if((0,x.isDefined)(e.min)&&n<e.min&&o.push(`Value must be greater than or equal to ${e.min}`),(0,x.isDefined)(e.max)&&n>e.max&&o.push(`Value must be less than or equal to ${e.max}`),(0,x.isDefined)(e.step)){const t=Number.parseFloat(e.step),i=(n-((0,x.isDefined)(e.min)?+e.min:0))%t;0!==i&&o.push(`The two nearest valid values are ${n-i} and ${n-i+t}`)}return!o.length||(yn.warning(`Number "${n}" is not valid: ${o.join(", ")}.`),!1)},getSelectedString:()=>`${e.number} star`,needsUpdate(){e.result?e.number=e.result.mainValue:e.number=null},beforeSend(){if((0,x.isDefined)(e.defaultvalue))if(e.perregion&&e.required){const n=e.toNameTag;for(const o of null!=(t=null==n?void 0:n.allRegs)?t:[]){var t;o.results.some((t=>t.from_name===e))||o.results.push({area:o,from_name:e,to_name:n,type:e.resultType,value:{[e.valueType]:+e.defaultvalue}})}}else(0,x.isDefined)(e.number)||e.setNumber(+e.defaultvalue)},unselectAll(){},setNumber(t){e.number=t,e.updateResult()},onChange(t){const n=+t.target.value;isNaN(n)||(e.setNumber(n),t.target.value=(0,x.isDefined)(e.number)?e.number:"")},updateFromResult(){this.needsUpdate()},requiredModal(){yn.warning(e.requiredmessage||`Number "${e.name}" is required.`)},increaseValue(){e.number>=Number(e.max)?e.setNumber(0):e.number>0?e.setNumber(e.number+1):e.setNumber(1)},onHotKey:()=>e.increaseValue()}})),Mm=u.gK.compose("NumberModel",Td,fc,tc,qe,pt,...(0,j.VS)(j.gF)?[Qd]:[],Ne,Em,Pm),Dm=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{var n,o,i,s,r;const a=e.perRegionVisible()?{display:"flex",alignItems:"center"}:{display:"none"},l=e.slider?{padding:"9px 0px",border:0}:{},d=e.isReadOnly(),c=(0,Qe.cn)("number").toClassName();return(0,A.jsxs)("div",{className:c,style:a,ref:e.elementRef,children:[(0,A.jsx)("input",{disabled:d,style:l,type:e.slider?"range":"number",name:e.name,value:null!=(n=null!=(o=e.number)?o:e.defaultvalue)?n:"",step:null!=(i=e.step)?i:1,min:(0,x.isDefined)(e.min)?Number(e.min):void 0,max:(0,x.isDefined)(e.max)?Number(e.max):void 0,onChange:d?void 0:e.onChange}),e.slider&&(0,A.jsx)("output",{style:{marginLeft:"5px"},children:null!=(s=null!=(r=e.number)?r:e.defaultvalue)?s:""}),t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,A.jsxs)("sup",{style:{fontSize:"9px"},children:["[",e.hotkey,"]"]})]})})));b.addTag("number",Mm,Dm);const Om=u.gK.model({toname:u.gK.maybeNull(u.gK.string),selectionstyle:u.gK.maybeNull(u.gK.string),leftclass:u.gK.maybeNull(u.gK.string),rightclass:u.gK.maybeNull(u.gK.string)}),Im=u.gK.model({type:"pairwise",selected:u.gK.maybeNull(u.gK.enumeration(["left","right","none"]))}).views((e=>({get names(){return e.toname.split(",")},get left(){return e.annotation.names.get(e.names[0])},get right(){return e.annotation.names.get(e.names[1])},get valueType(){return"selected"}}))).actions((e=>({updateResult(){const{result:t,selected:n}=e;"none"===n?t&&t.area.removeResult(t):t?t.setValue(n):e.annotation.createResult({},{selected:n},e,e.name)},setResult(t="none"){e.selected=t,e.left.addProp("style","left"===t?e._selection:{}),e.right.addProp("style","right"===t?e._selection:{})},selectLeft(){e.setResult("left"===e.selected?"none":"left"),e.updateResult()},selectRight(){e.setResult("right"===e.selected?"none":"right"),e.updateResult()},afterCreate(){2===e.names.length&&e.names[0]!==e.names[1]||yn.error("Incorrect toName parameter on Pairwise, must be two names separated by a comma: name1,name2");let t={};if(e.selectionstyle){const n=L.cssConverter(e.selectionstyle);for(const e in n)t[e]=n[e]}else t={backgroundColor:"#f6ffed",border:"1px solid #b7eb8f"};e._selection=t},needsUpdate(){e.result?e.setResult(e.result.value.selected):e.setResult()},annotationAttached(){setTimeout((()=>{var t;e.left.addProp("onClick",e.selectLeft),e.right.addProp("onClick",e.selectRight),e.setResult(null==(t=e.result)?void 0:t.value.selected)}))}}))),Lm=u.gK.compose("PairwiseModel",Td,Om,Im,Ne);b.addTag("pairwise",Lm,(()=>null)),b.addObjectType(Lm);const Nm="_",zm=u.gK.model({type:"ranker",toname:u.gK.maybeNull(u.gK.string),collapsible:u.gK.optional(u.gK.boolean,!0),children:Le.unionArray(["bucket"])}).views((e=>({get list(){const t=e.annotation.names.get(e.toname);return"list"===t.type?t:null},get buckets(){return L.filterChildrenOfType(e,"BucketModel")},get defaultBucket(){var t;return e.buckets.length>0?null==(t=e.buckets.find((e=>e.default)))?void 0:t.name:e.name},get rankOnly(){return!e.buckets.length},get columns(){if(!e.list)return[];if(e.rankOnly)return[{id:e.name,title:e.list.title}];const t=e.buckets.map((e=>{var t;return{id:e.name,title:null!=(t=e.title)?t:""}}));return e.defaultBucket||t.unshift({id:Nm,title:e.list.title}),t}}))).views((e=>({get dataSource(){var t,n,o;const i=null==(t=e.list)?void 0:t._value,s=null==(n=e.list)?void 0:n.items,r=Object.keys(s),a=e.columns,l=Object.fromEntries(e.columns.map((e=>[e.id,[]]))),d=null==(o=e.result)?void 0:o.value.ranker;let c={};if(!i)return[];var u;if(d){if(c=Object.assign({},l,d),!e.defaultBucket){const t=e.columns.map((e=>e.id)),n=Object.entries(d).filter((([e])=>t.includes(e))).flatMap((([e,t])=>t)),o=r.filter((e=>!n.includes(e)));var h;if(o.length)c[Nm]=[...null!=(h=c[Nm])?h:[],...o]}}else c=Object.assign({},l,{[null!=(u=e.defaultBucket)?u:Nm]:r});return{items:s,columns:a,itemIds:c}},get result(){var t;return null==(t=e.annotation)?void 0:t.results.find((t=>t.from_name===e))}}))).actions((e=>({createResult(t){e.annotation.createResult({},{ranker:t},e,e.list)},updateResult(t){e.result?e.result.setValue(t):e.createResult(t)},beforeSend(){var t,n;if(!e.list)return;if(e.result)return;const o=Object.keys(null==(t=e.list)?void 0:t.items),i=Object.fromEntries(e.columns.map((e=>[e.id,[]])));i[null!=(n=e.defaultBucket)?n:Nm]=o,e.createResult(i)}}))),Vm=u.gK.compose("RankerModel",Td,Ne,zm,qe),Hm=(0,v.WQ)("store")((0,v.PA)((({item:e})=>{const t=e.dataSource;return t?(0,A.jsx)(wm,{inputData:t,handleChange:e.updateResult,readonly:e.isReadOnly(),collapsible:e.collapsible}):null}))),Bm=u.gK.model("BucketModel",{id:u.gK.optional(u.gK.identifier,T),type:"bucket",name:u.gK.string,title:u.gK.maybeNull(u.gK.string),default:u.gK.optional(u.gK.boolean,!1)}),Fm=(0,v.WQ)("store")((0,v.PA)((({item:e})=>(0,A.jsx)("h1",{children:e.name}))));b.addTag("ranker",Vm,Hm),b.addTag("bucket",Bm,Fm),b.addObjectType(Vm);var Wm=n(97141);const $m=u.gK.model({value:u.gK.maybeNull(u.gK.string),alias:u.gK.maybeNull(u.gK.string),background:u.gK.optional(Me.color,"#333333"),hotkey:u.gK.maybeNull(u.gK.string)}),Um=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"shortcut",_value:u.gK.optional(u.gK.string,"")}).volatile((()=>({hotkeyScope:go.INPUT_SCOPE}))).actions((e=>({onClick(){const t=(0,u.PA)(e,2);t.onShortcut&&(t.onShortcut(e.value),null==t.returnFocus||t.returnFocus())},onHotKey(t){const n=(0,u.PA)(e,2),o=(t.target||t.srcElement).name;if(n.name===o||o.startsWith(`${n.name}:`))return t.preventDefault(),e.onClick()}}))),Ym=u.gK.compose("ShortcutModel",$m,Um,Ue),Xm=(0,v.WQ)("store")((0,v.PA)((({item:e,store:t})=>{const n={background:St()(e.background).alpha(.15),color:"#333333",cursor:"pointer",margin:"5px"};return(0,A.jsxs)(Wm.A,{"data-shortcut":!0,onClick:t=>(t.preventDefault(),t.stopPropagation(),e.onClick(),!1),style:n,children:[e.alias?e.alias:e._value,t.settings.enableTooltips&&t.settings.enableHotkeys&&e.hotkey&&(0,A.jsxs)(eo,{children:["[",e.hotkey,"]"]})]})})));b.addTag("shortcut",Ym,Xm);var Gm=n(44318);const Zm=m.forwardRef((({treeData:e,onChange:t},n)=>{(0,m.useImperativeHandle)(n,(()=>({resetValue(){s(""),t(e,[])},focus(){var e;return null==(e=o.current)?void 0:e.focus()}})));const o=(0,m.useRef)(),[i,s]=(0,m.useState)("");(0,m.useEffect)((()=>{const n=l(e,i);t(n.filteredDataTree,null)}),[e]);const r=(0,m.useCallback)((e=>"string"==typeof e?e:"object"==typeof e.props.children?r(e.props.children):e.props.children),[]),a=(0,m.useCallback)(((e,t)=>{const n=String(e).toLowerCase(),o=r(t.title);return!!n&&String(o).toLowerCase().includes(n)}),[]),l=(0,m.useCallback)(((e,t)=>{const n=[];if(!t)return{filteredDataTree:e,expandedKeys:n};const o=(e,i=!1)=>e.reduce(((e,s)=>{const r=s.children,l=i||a(t,s),d=null!=r&&r.length?o(r,l):void 0;var c;(l||null!=d&&d.length)&&(!i&&null!=(c=s.children)&&c.length&&n.push(s.key),e.push(Object.assign({},s,{isLeaf:!(null!=d&&d.length),children:d})));return e}),[]);return{filteredDataTree:o(e),expandedKeys:n}}),[]),d=(0,m.useCallback)((0,li.debounce)((async n=>{const o=l(e,n.target.value);t(o.filteredDataTree,o.expandedKeys)}),300),[e]);return(0,A.jsx)(Qe.eB,{ref:o,value:i,tag:"input",onChange:e=>{s(e.target.value),d(e)},onKeyDown:e=>{"Backspace"!==e.key&&"Delete"!==e.key||e.stopPropagation()},placeholder:"Search","data-testid":"taxonomy-search",name:"taxonomy-search-input"})})),qm=({items:e,selected:t,onChange:n,onLoadData:o,defaultSearch:i=!0,options:s,isEditable:r=!0})=>{var a;const l=(0,m.useRef)(null),[d,c]=(0,m.useState)([]),[u,h]=(0,m.useState)([]),[g,p]=(0,m.useState)([]),f=s.pathSeparator,v={minWidth:null!=(a=s.minWidth)?a:200,maxWidth:s.maxWidth},y=void 0===s.dropdownWidth||+s.dropdownWidth,b=!!s.maxUsages&&t.length>=s.maxUsages,x=t.map((e=>e.map((e=>e.value)).join(f))),S=t.map((e=>({value:e.map((e=>e.value)).join(f),label:s.showFullPath?e.map((e=>e.label)).join(f):e.at(-1).label})));(0,m.useEffect)((()=>{c(((e,t,n)=>{const o=e=>{const t=e=>(0,A.jsx)("span",{className:"htx-taxonomy-item-color",style:{background:e.color},children:e.label});return e.hint?(0,A.jsx)(Qn.m_M,{title:e.hint,children:e.color?t(e):(0,A.jsx)("span",{children:e.label})}):e.color?t(e):e.label},i=e=>{var s;const r=e.path.join(t.pathSeparator),a=t.leafsOnly&&(!1===e.isLeaf||!!e.children),l=t.maxUsagesReached&&!n.includes(r);return{title:o(e),value:r,key:r,isLeaf:!1!==e.isLeaf&&!e.children,disableCheckbox:a||l,children:null==(s=e.children)?void 0:s.map(i)}};return e.map(i)})(e,Object.assign({},s,{maxUsagesReached:b}),x))}),[e,b]);const w=(0,m.useCallback)((async e=>null==o?void 0:o(e.value.split(f))),[]),k=(0,m.useCallback)(((e,t)=>{h(e),null!=t&&t.length?p(t):p(void 0)}),[]),C=(0,m.useCallback)((e=>(0,A.jsxs)(A.Fragment,{children:[!i&&(0,A.jsx)(Zm,{ref:l,treeData:d,onChange:k}),e]})),[d]),j=(0,m.useCallback)((e=>{var t;e?setTimeout((()=>{var e;null==(e=l.current)||e.focus()}),200):null==(t=l.current)||t.resetValue()}),[l]);return(0,A.jsx)(Gm.A,{treeData:i?d:u,value:S,labelInValue:!0,onChange:e=>n(null,e.map((e=>e.value.split(f)))),loadData:w,treeCheckable:!0,showSearch:i,showArrow:!i,dropdownRender:C,onDropdownVisibleChange:j,treeExpandedKeys:i?void 0:g,onTreeExpand:e=>{p(e)},treeCheckStrictly:!0,showCheckedStrategy:Gm.A.SHOW_ALL,treeExpandAction:!1,dropdownMatchSelectWidth:y,placeholder:s.placeholder||"Click to add...",style:v,className:"htx-taxonomy",disabled:!r})},Jm=u.gK.model("SharedStoreModel",{id:u.gK.identifier,locked:!1,children:Le.unionArray(["choice"])}).actions((e=>({setChildren(t){e.children=t},clear(){e.children=[]},lock(){e.locked=!0},unlock(){e.locked=!1},destroy(){e.clear(),(0,u.Yo)(e)}}))),Qm=new Map,ep=new Set,tp=u.gK.optional(u.gK.maybeNull(u.gK.string),null),np=u.gK.optional(u.gK.maybeNull(u.gK.late((()=>u.gK.reference(Jm)))),null),op=u.gK.model("SharedStoreMixin",{sharedstore:tp,store:np}).views((e=>({get children(){return e.sharedChildren},get locked(){var t,n;return null!=(t=null==(n=e.store)?void 0:n.locked)&&t},set children(t){var n;null==(n=e.store)||n.lock(),e.store.setChildren(t)},get sharedChildren(){var t;return null!=(t=e.store.children)?t:[]},get storeId(){var t;return null!=(t=e.sharedstore)?t:e.name}}))).actions((e=>({afterCreate(){if(!e.store){const t=Qm.get(e.storeId);Le.getParentOfTypeString(e,"AnnotationStore").addSharedStore(t),ep.add(e.storeId),e.store=e.storeId}}}))).preProcessSnapshot((e=>{var t;const n=null!=(t=e.sharedstore)?t:e.name;var o,i;ep.has(n)?e.store=n:Qm.set(n,Jm.create({id:n,children:null!=(o=null!=(i=e._children)?i:e.children)?o:[]}));return e})),ip=()=>{Qm.clear(),ep.clear()},sp={taxonomy:"lsf-taxonomy",taxonomy__loading:"lsf-taxonomy__loading",taxonomy__new:"lsf-taxonomy__new"},rp=["alias","children","isLeaf","value"],ap=u.gK.model({toname:u.gK.maybeNull(u.gK.string),labeling:u.gK.optional(u.gK.boolean,!1),leafsonly:u.gK.optional(u.gK.boolean,!1),showfullpath:u.gK.optional(u.gK.boolean,!1),legacy:u.gK.optional(u.gK.boolean,!1),pathseparator:u.gK.optional(u.gK.string," / "),apiurl:u.gK.maybeNull(u.gK.string),placeholder:"",minwidth:u.gK.maybeNull(u.gK.string),maxwidth:u.gK.maybeNull(u.gK.string),dropdownwidth:u.gK.maybeNull(u.gK.string),maxusages:u.gK.maybeNull(u.gK.string),value:u.gK.optional(u.gK.string,"")});const lp=new Map,dp=u.gK.model({}).views((e=>({get result(){if(!e.isLabeling&&!e.perregion)return e.peritem?e._perItemResult:e.annotation.results.find((t=>t.from_name===e));const t=e.annotation.highlightedNode;return t?e.annotation.results.find((n=>n.from_name===e&&n.area===t)):null},get canRemoveItems(){return!e.isLabeling||!e.result}}))).actions((e=>{const t={updateResult:e.updateResult};return{updateResult(){if(!e.isLabeling)return t.updateResult();e.result&&e.result.area.setValue(e)},findLabel(t){let n,o="",i=e.items;for(const r of t){var s;if(n=null==(s=i)?void 0:s.find((e=>e.path.at(-1)===r)),!n)return null;i=n.children,o=e.showfullpath&&o?o+e.pathseparator+n.label:n.label}const r={value:o,id:t.join(e.pathseparator)};return n.color&&(r.background=n.color,r.parent={}),r}}})),cp=u.gK.model({pid:u.gK.optional(u.gK.string,T),type:"taxonomy",_children:Le.unionArray(["choice"])}).volatile((()=>({maxUsagesReached:!1,selected:[],loading:!0,_api:"",_items:[]}))).views((e=>({get children(){return e._children},set children(t){e._children=t},get isLabeling(){return(0,j.VS)(j.um)&&e.labeling},get userLabels(){return e.annotation.store.userLabels},get holdsState(){return e.selected.length>0},get isSelected(){return e.holdsState},get hasValue(){return e.holdsState},get valueType(){return"taxonomy"},get tiedChildren(){return L.filterChildrenOfType(e,"ChoiceModel")},get preselectedValues(){return e.tiedChildren.filter((e=>!0===e.selected&&!e.isSkipped)).map((e=>e.resultValue))},get isLoadedByApi(){return(0,j.VS)(j.yD)&&!!e.apiurl},get items(){var t,n;if(e.isLoadedByApi)return e._items;const o=function(e){const t=(e,t=[])=>{const o=new Set,i=[];for(const s of e)o.has(s.value)||(o.add(s.value),i.push(n(s,t)));return i},n=(e,n=[])=>{var o;const i=e.value,s=e.hint,r=[...n,null!=(o=e.alias)?o:i],a={label:i,path:r,depth:n.length,hint:s};return e.color&&(a.color=e.color),e.children&&(a.children=t(e.children,r)),a};return e?Array.isArray(e)?t(e):t([e]):[]}(e.children),i=null!=(t=null==(n=e.userLabels)?void 0:n.controls[e.name])?t:[];for(const e of i){let t={children:o};const{origin:n,path:i}=e,r=i.length-1;for(let e=0;e<r;e++){var s;if(t=null==(s=t.children)?void 0:s.find((t=>t.label===i[e])),!t)break}t&&(t.children||(t.children=[]),t.children.push({label:i[r],path:i,depth:r,origin:n}))}return o},get selectedItems(){return e.selected.map((t=>{let n=e.items;const o=[];for(const e of t){var i,s;const t=n.find((t=>t.path.at(-1)===e));o.push({label:null!=(i=null==t?void 0:t.label)?i:e,value:e}),n=null!=(s=null==t?void 0:t.children)?s:[]}return o}))},get defaultChildType(){return"choice"},selectedValues:()=>e.selected,findItemByValueOrAlias(t){const n=e=>{for(const o of e){const e=o.label,i=o.path[o.path.length-1];if(o.value=e,i!==e&&(o.alias=i),o.value===t||o.alias===t)return o;if(o.children){const e=n(o.children,t);if(e)return e}}};return n(e.items)}}))).actions((e=>({afterAttach(){var t;if(e.isLoadedByApi)return;const n=null!=(t=lp.get(e.name))?t:[];e.store&&n.length!==e.children.length?e.updateChildren():e.loading=!1},loadItems:(0,u.L3)((function*(t){if(!e._api)return;let n,o={};if(t){n={children:e.items};for(const e of t){var i;if(n=null==(i=n.children)?void 0:i.find((t=>t.path.at(-1)===e)),!n)return}}if(t&&(!1!==n.isLeaf||n.children))return;e.loading=!0;const s=new URL(e._api);null==t||t.forEach((e=>s.searchParams.append("path",e))),s.username&&s.password&&(o={headers:new Headers({Authorization:`Basic ${btoa(`${s.username}:${s.password}`)}`})},s.username="",s.password="");try{var r;const i=yield fetch(s,o),{ok:a,status:l,statusText:d}=i;if(!a)throw new Error(`${l} ${d}`);const c=yield i.json(),u=null!=(r=c.items)?r:c,h=(e,t)=>e.map((e=>{let{alias:n,children:o,isLeaf:i,value:s}=e,r=(0,Zn.A)(e,rp);const a=Object.assign({label:s,path:[...t,null!=n?n:s],depth:t.length,isLeaf:i},r);return o&&(a.children=h(o,a.path)),a})),g=h(u,null!=t?t:[]);t?(n.children=g,e._items=[...e._items]):e._items=g}catch(t){const n=et.A.ERR_LOADING_HTTP({attr:"apiUrl",error:String(t),url:e.apiurl});e.annotationStore.addErrors([mr.generalError(n)]),console.error(t)}e.loading=!1})),beforeDestroy(){lp.delete(e.name)},updateChildren(){var t;const n=null!=(t=lp.get(e.name))?t:[];if(n.length){const t=(0,u.Zn)(e),o=e=>{null==e||e.map((e=>{null==e.updateValue||e.updateValue(t),o(e.children)}))};e._children=n,e.children=[...n],e.store.unlock(),lp.delete(e.name),o(e.children)}e.loading=!1},requiredModal(){yn.warning(e.requiredmessage||`Taxonomy "${e.name}" is required.`)},needsUpdate(){e.result?e.selected=e.result.mainValue:e.selected=[],e.maxUsagesReached=e.selected.length>=e.maxusages},updateFromResult(){e.needsUpdate()},onChange(t,n){(!1!==e.canRemoveItems||n.length)&&(e.selected=n.map((e=>{var t;return null!=(t=e.path)?t:e})),e.maxUsagesReached=e.selected.length>=e.maxusages,e.updateResult())},unselectAll(){(0,j.VS)(j.um)&&e.isLabeling&&(e.selected=[])},onAddLabel(t){var n;null==(n=e.userLabels)||n.addLabel(e.name,t)},onDeleteLabel(t){var n;null==(n=e.userLabels)||n.deleteLabel(e.name,t)}}))).actions((e=>{const t={validate:e.validate};return{validate(){if(!t.validate()||e.maxusages&&e.selected.length>e.maxusages)return!1},beforeSend(){e.maxusages&&e.selected.length>e.maxusages&&yn.warning(`The number of options selected (${e.selected.length}) exceed the maximum allowed (${e.maxusages}). To proceed, first unselect excess options for:\r\n  Taxonomy (${e.name})`)}}})).actions((e=>{const t={updateValue:e.updateValue};return{updateValue:(0,u.L3)((function*(n){var o;if(!e.isLoadedByApi)return null==t.updateValue?void 0:t.updateValue(n);e._api=k(e.apiurl,n.task.dataObj),e._api=null!=(o=yield n.presignUrlForProject(e._api))?o:e._api,yield e.loadItems()}))}})).preProcessSnapshot((e=>{var t;const n=null!=(t=e._children)?t:e.children;return n&&!lp.has(e.name)&&lp.set(e.name,n),delete e._children,delete e.children,e})),up=u.gK.compose("TaxonomyModel",Td,fc,ap,Rd,Ne,tc,cp,op,pt,...(0,j.VS)(j.gF)?[Qd]:[],...(0,j.VS)(j.um)?[dp]:[],qe,Jc,_c),hp=(0,v.PA)((({item:e})=>{const t=[sp.taxonomy,"taxonomy",(0,j.VS)(j.yD)?sp.taxonomy__new:""].filter(Boolean).join(" "),n=e.perRegionVisible()&&e.isVisible?{}:{display:"none"},o={showFullPath:e.showfullpath,leafsOnly:e.leafsonly,pathSeparator:e.pathseparator,maxUsages:e.maxusages,maxWidth:e.maxwidth,minWidth:e.minwidth,dropdownWidth:e.dropdownwidth,placeholder:e.placeholder,canRemoveItems:e.canRemoveItems},i=!e.isLoadedByApi||!e.items.length;return e.loading&&(0,j.VS)(j.yD)&&i?(0,A.jsx)("div",{className:t,style:n,children:(0,A.jsx)("div",{className:sp.taxonomy__loading,children:(0,A.jsx)(f.A,{size:"small"})})}):(0,A.jsx)("div",{className:t,style:n,ref:e.elementRef,children:(0,j.VS)(j.yD)&&!e.legacy?(0,A.jsx)(qm,{items:e.items,selected:e.selectedItems,onChange:e.onChange,onLoadData:e.loadItems,onAddLabel:e.userLabels&&e.onAddLabel,onDeleteLabel:e.userLabels&&e.onDeleteLabel,options:o,defaultSearch:!(0,j.VS)(j._m),isEditable:!e.isReadOnly()}):(0,A.jsx)(Yc,{items:e.items,selected:e.selected,onChange:e.onChange,onAddLabel:e.userLabels&&e.onAddLabel,onDeleteLabel:e.userLabels&&e.onDeleteLabel,options:o,isEditable:!e.isReadOnly()})})}));b.addTag("taxonomy",up,hp);const gp=u.gK.model({controlledTags:Le.unionTag(["HyperText"])}),mp=u.gK.model("HyperTextLabelsModel",{type:"hypertextlabels",children:Le.unionArray(["label","header","view","hypertext"])}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},get serializableValue(){const t={};return t[e.resultType]=e.selectedValues(),t},get resultType(){return"hypertextlabels"},get valueType(){return"hypertextlabels"}}))),pp=u.gK.compose(Td,zd,mp,gp,kd,Cd.props({_child:"LabelModel"})),fp=u.gK.compose("HyperTextLabelsModel",pp),vp=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("hypertextlabels",fp,vp);const yp=u.gK.model({opacity:u.gK.optional(u.gK.string,"0.9"),fillcolor:u.gK.maybeNull(u.gK.string),strokeWidth:u.gK.optional(u.gK.number,1),strokeColor:u.gK.optional(u.gK.string,"#f48a42")}),bp=u.gK.model("TimeSeriesLabelesModel",{pid:u.gK.optional(u.gK.string,T),type:"timeserieslabels",children:Le.unionArray(["labels","label","choice"])}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0},states:()=>e.annotation.toNames.get(e.name),activeStates(){const t=e.states();return t?t.filter((e=>!0===e.isSelected)):null}}))),xp=kd.props({_type:"timeserieslabels"}).views((e=>({get shouldBeUnselected(){return"single"===e.choice}}))),Sp=u.gK.compose(Td,zd,bp,yp,xp,Cd.props({_child:"LabelModel"})),wp=u.gK.compose("TimeSeriesLabelsModel",Sp),kp=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("timeserieslabels",wp,kp);const Cp=u.gK.model({toname:u.gK.maybeNull(u.gK.string)}),jp=u.gK.model("TimelineLabelsModel",{pid:u.gK.optional(u.gK.string,T),type:"timelinelabels"}),Rp=u.gK.compose("TimelineLabelsModel",Td,zd,jp,Cp,Cd.props({_child:"LabelModel"})),_p=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("timelinelabels",Rp,_p);const Tp=u.gK.model({toname:u.gK.maybeNull(u.gK.string)}),Ap=u.gK.model("VideoRectangleModel",{pid:u.gK.optional(u.gK.string,T),type:"videorectangle"}),Kp=u.gK.compose("VideoRectangleModel",Td,Ap,Tp),Ep=(0,v.PA)((()=>null));b.addTag("videorectangle",Kp,Ep);const Pp=u.gK.model().volatile((()=>({isSeparated:!0}))).views((e=>({get obj(){var t;return null==(t=e.annotation)?void 0:t.names.get(e.toname)},get selectedLabels(){return[]},selectedValues:()=>[],getResultValue:()=>({})}))),Mp=u.gK.model().actions((e=>({afterAttach(){var t;if(Ys.ff.isActive(j.cE)&&e.annotationStore.initialized)return void(e.tools=e.annotationStore.names.get(e.name).tools);const n=null!=(t=e.toolNames)?t:[],o=od.getInstance({name:e.toname}),i={manager:o,control:e},s={};n.forEach((e=>{if(e in l){const t=l[e].create({},i);s[e]=t}})),e.tools=s,o.addToolsFromControl(e)}}))),Dp=u.gK.model({toname:u.gK.maybeNull(u.gK.string),strokewidth:u.gK.optional(u.gK.string,"15")}),Op=u.gK.model({type:"brush",removeDuplicatesNamed:"Erase"}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0}}))).volatile((()=>({toolNames:["Brush","Erase"]}))),Ip=u.gK.compose("BrushModel",Td,Ne,Pp,Dp,Op,Mp);b.addTag("brush",Ip,(()=>null));const Lp=u.gK.model({controlledTags:Le.unionTag(["Image"])}),Np=u.gK.model("BrushLabelsModel",{type:"brushlabels",children:Le.unionArray(["label","header","view","hypertext"])}),zp=u.gK.compose("BrushLabelsModel",Td,zd,Np,Ip,Lp,kd,Cd.props({_child:"LabelModel"})),Vp=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("brushlabels",zp,Vp);const Hp=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.2"),fillcolor:u.gK.optional(Me.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Me.color,"#f48a42"),fillopacity:u.gK.maybeNull(Me.range()),canrotate:u.gK.optional(u.gK.boolean,!0)}),Bp=u.gK.model({type:"ellipse"}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0}}))).volatile((()=>({toolNames:["Ellipse"]}))),Fp=u.gK.compose("EllipseModel",Td,Ne,Pp,Hp,Bp,Mp);b.addTag("ellipse",Fp,(()=>null));const Wp=u.gK.model("EllipseLabelsModel",{type:"ellipselabels",children:Le.unionArray(["label","header","view","hypertext"])}),$p=u.gK.compose(Td,zd,Wp,Fp,kd,Cd.props({_child:"LabelModel"})),Up=u.gK.compose("EllipseLabelsModel",$p),Yp=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("ellipselabels",Up,Yp);const Xp=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.9"),fillcolor:u.gK.optional(Me.color,"#8bad00"),snap:u.gK.optional(u.gK.string,"none"),strokecolor:u.gK.optional(Me.color,"#8bad00"),strokewidth:u.gK.optional(u.gK.string,"2")}),Gp=u.gK.model({type:"keypoint"}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0}}))).volatile((()=>({toolNames:["KeyPoint"],snapMode:it}))),Zp=u.gK.compose("KeyPointModel",Td,Ne,Pp,Xp,Gp,Mp);b.addTag("keypoint",Zp,(()=>null));const qp=u.gK.model({controlledTags:Le.unionTag(["Image"])}),Jp=u.gK.model("KeyPointLabelsModel",{type:"keypointlabels",children:Le.unionArray(["label","header","view","hypertext"])}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0}}))),Qp=u.gK.compose(Td,zd,Jp,Zp,qp,kd,Cd.props({_child:"LabelModel"})),ef=u.gK.compose("KeyPointLabelsModel",Qp),tf=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("keypointlabels",ef,tf);const nf=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.6"),blurradius:u.gK.optional(u.gK.string,"5"),defaultthreshold:u.gK.optional(u.gK.string,"15")}),of=u.gK.model({type:"magicwand",removeDuplicatesNamed:"Erase"}).views((e=>({get hasStates(){const t=e.states();return t&&t.length>0}}))).volatile((()=>({toolNames:["MagicWand","Erase"]}))),sf=u.gK.compose("MagicWandModel",Td,Ne,Pp,nf,of,Mp);b.addTag("magicwand",sf,(()=>null));const rf=go("Polygons"),af=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.2"),fillcolor:u.gK.optional(Me.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"2"),strokecolor:u.gK.optional(Me.color,"#f48a42"),snap:u.gK.optional(u.gK.string,"none"),pointsize:u.gK.optional(u.gK.string,"small"),pointstyle:u.gK.optional(u.gK.string,"circle")}),lf=u.gK.model({controlledTags:Le.unionTag(["Image"])}),df=u.gK.model({type:"polygon",_value:u.gK.optional(u.gK.string,"")}).volatile((()=>({toolNames:["Polygon"]}))).actions((e=>({initializeHotkeys(){rf.addNamed("polygon:undo",(()=>{e.annotation.isDrawing&&e.annotation.undo()})),rf.addNamed("polygon:redo",(()=>{e.annotation.isDrawing&&e.annotation.redo()}))},disposeHotkeys(){rf.removeNamed("polygon:undo"),rf.removeNamed("polygon:redo")},afterCreate(){e.initializeHotkeys()},beforeDestroy(){e.disposeHotkeys()}}))),cf=u.gK.compose("PolygonModel",Td,Ne,Pp,af,lf,Mp,df);b.addTag("polygon",cf,(()=>null));const uf=u.gK.model({controlledTags:Le.unionTag(["Image"])}),hf=u.gK.model("PolygonLabelsModel",{type:"polygonlabels",children:Le.unionArray(["label","header","view","hypertext"])}),gf=u.gK.compose(Td,zd,hf,cf,uf,kd,Cd.props({_child:"LabelModel"})),mf=u.gK.compose("PolygonLabelsModel",gf),pf=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("polygonlabels",mf,pf);const ff=u.gK.model({toname:u.gK.maybeNull(u.gK.string),opacity:u.gK.optional(Me.range(),"0.2"),fillcolor:u.gK.optional(Me.color,"#f48a42"),strokewidth:u.gK.optional(u.gK.string,"1"),strokecolor:u.gK.optional(Me.color,"#f48a42"),fillopacity:u.gK.maybeNull(Me.range()),canrotate:u.gK.optional(u.gK.boolean,!0)}),vf=u.gK.model({type:"rectangle"}).volatile((()=>({toolNames:["Rect","Rect3Point"]}))),yf=u.gK.compose("RectangleModel",Td,Ne,Pp,ff,vf,Mp);b.addTag("rectangle",yf,(()=>null));const bf=u.gK.model({controlledTags:Le.unionTag(["Image"])}),xf=u.gK.model("RectangleLabelsModel",{pid:u.gK.optional(u.gK.string,T),type:"rectanglelabels",children:Le.unionArray(["label","header","view","hypertext"])}),Sf=u.gK.compose(Td,zd,xf,yf,bf,kd,Cd.props({_child:"LabelModel"})),wf=u.gK.compose("RectangleLabelsModel",Sf),kf=(0,v.PA)((({item:e})=>(0,A.jsx)(Vd,{item:e})));b.addTag("rectanglelabels",wf,kf);const Cf=u.gK.model({choice:u.gK.optional(u.gK.enumeration(["single","multiple"]),"multiple")}),jf=u.gK.model({id:u.gK.optional(u.gK.identifier,T),pid:u.gK.optional(u.gK.string,T),type:"relations",children:Le.unionArray(["relation"])}).views((e=>({get values(){return e.children.map((e=>e.value))},findRelation:t=>e.children.find((e=>e.value===t))}))).actions((()=>({}))),Rf=u.gK.compose("RelationsModel",jf,Cf);b.addTag("relations",Rf,(()=>null));const _f=u.gK.model({value:u.gK.maybeNull(u.gK.string),background:u.gK.optional(Me.color,z.A.RELATION_BACKGROUND)}),Tf=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"relation"}).actions((()=>({}))),Af=u.gK.compose("RelationModel",_f,Tf);b.addTag("relation",Af,(()=>null));var Kf=n(68703);const{Panel:Ef}=Kf.A,Pf=u.gK.model({type:"panel",_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),children:Le.unionArray(["view","header","labels","label","table","taxonomy","choices","choice","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","rectanglelabels","ellipselabels","polygonlabels","keypointlabels","brushlabels","hypertextlabels","text","audio","image","hypertext","audioplus","list","dialog","textarea","pairwise","style","label","relations","filter","timeseries","timeserieslabels","paragraphs","paragraphlabels"])}).views((e=>({get isIndependent(){var t;return!(null==(t=e.children)||!t.some((e=>!0===e.isIndependent)))}}))),Mf=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"collapse",size:u.gK.optional(u.gK.string,"4"),style:u.gK.maybeNull(u.gK.string),_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),bordered:u.gK.optional(u.gK.boolean,!1),accordion:u.gK.optional(u.gK.boolean,!0),children:Le.unionArray(["panel"])}).views((e=>({get store(){return(0,u.Zn)(e)},get isIndependent(){var t;return!(null==(t=e.children)||!t.some((e=>!0===e.isIndependent)))}}))),Df=u.gK.compose("CollapseModel",Mf,Ue),Of=(0,v.PA)((({item:e})=>{const t=(0,j.VS)(j.U2)&&!R()&&e.store.hasInterface("annotation:bulk");return(0,A.jsx)(Kf.A,{bordered:e.bordered,accordion:e.accordion,children:e.children.filter((e=>"panel"===e.type&&(!t||e.isIndependent))).map((t=>(0,A.jsx)(Ef,{header:t._value,children:L.renderChildren(t,e.annotation)},t._value)))})}));b.addTag("panel",u.gK.compose("PanelModel",Pf,Ue),(()=>{})),b.addTag("collapse",Df,Of);var If=n(70821),Lf=n(92132);const Nf={block:"block--fqozC",block_selected:"block_selected--BXxdo",name:"name--sC49k",tag:"tag--efLdj",date:"date--h1U4a"};class zf extends m.Component{render(){let e,t,n,o=`${Nf.block}`;return this.props.hint&&(e=(0,A.jsx)(Wm.A,{color:"blue",children:this.props.hint})),this.props.bg&&(t=this.props.bg),this.props.selected&&(o=`${o} ${Nf.block_selected}`,e=(0,A.jsx)("div",{children:(0,A.jsx)(Wm.A,{color:"magenta",children:"Selected Message"})}),this.props.hint&&(e=(0,A.jsx)("div",{className:Nf.tag,children:(0,A.jsx)(Wm.A,{color:"magenta",children:this.props.hint})}))),this.props.date&&(n=(0,A.jsx)("span",{className:Nf.date,children:this.props.date})),(0,A.jsxs)("div",{className:o,style:{background:t,width:"max-content",maxWidth:"100%"},children:[(0,A.jsxs)("span",{className:Nf.name,children:[this.props.name,":"]}),(0,A.jsx)("p",{className:Nf.text,children:this.props.text}),n,e]})}}zf.propTypes={name:Te.PropTypes.string.isRequired,text:Te.PropTypes.string.isRequired,selected:Te.PropTypes.bool,date:Te.PropTypes.string,hint:Te.PropTypes.string};const Vf=u.gK.model({name:u.gK.string,text:u.gK.string,selected:u.gK.optional(u.gK.boolean,!1),date:u.gK.optional(u.gK.string,""),hint:u.gK.optional(u.gK.string,"")}),Hf=u.gK.model({value:u.gK.maybeNull(u.gK.string),name:u.gK.maybeNull(u.gK.string)}),Bf=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"Dialog",data:u.gK.map(Vf)}),Ff=u.gK.compose("DialogModel",Hf,Bf,Ne),Wf=(0,v.WQ)("store")((0,v.PA)((({store:e,item:t})=>{if(!e.task||!e.task.dataObj)return(0,A.jsx)(If.A,{});const n=[];let o=t.value;return"$"===o.charAt(0)&&(o=o.substr(1)),e.task.dataObj[o].forEach(((e,t)=>{let o;e.name&&(o=(0,bt.convertToRGBA)((0,bt.stringToColor)(e.name),.1)),n.push((0,A.jsx)(zf,{name:e.name,hint:e.hint,text:e.text,selected:e.selected,date:e.date,id:e.id,bg:o},t))})),(0,A.jsxs)("div",{children:[(0,A.jsx)("div",{style:{display:"flex",flexFlow:"column",maxHeight:"500px",overflowY:"scroll",paddingRight:"10px",marginTop:"10px"},children:n}),(0,A.jsx)(Lf.A,{dashed:!0})]})})));b.addTag("dialog",Ff,Wf);const $f=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"header",size:u.gK.optional(u.gK.string,"4"),style:u.gK.maybeNull(u.gK.string),_value:u.gK.optional(u.gK.string,""),value:u.gK.optional(u.gK.string,""),underline:u.gK.optional(u.gK.boolean,!1)}),Uf=u.gK.compose("HeaderModel",$f,Ue),Yf=(0,v.PA)((({item:e})=>{const t=(0,x.clamp)(Number.parseInt(e.size),1,5),n=e.style?L.cssConverter(e.style):{margin:"10px 0"};return!n.fontSize&&t>4&&(n.fontSize=5===t?"1.2em":"1.1em"),(0,A.jsx)(rc.A.Title,{underline:e.underline,level:t,style:n,children:e._value})}));b.addTag("header",Uf,Yf);const Xf=u.gK.model({classname:u.gK.optional(u.gK.string,""),display:u.gK.optional(u.gK.string,"block"),style:u.gK.maybeNull(u.gK.string),idattr:u.gK.optional(u.gK.string,"")}),Gf=u.gK.model({id:u.gK.identifier,type:"view",children:Le.unionArray(["view","header","labels","label","table","taxonomy","choices","choice","collapse","datetime","number","rating","ranker","rectangle","ellipse","polygon","keypoint","brush","magicwand","rectanglelabels","ellipselabels","polygonlabels","keypointlabels","brushlabels","hypertextlabels","timeserieslabels","text","audio","image","hypertext","richtext","timeseries","audioplus","list","dialog","textarea","pairwise","style","relations","filter","pagedview","paragraphs","paragraphlabels","pdf","video","videorectangle","timelinelabels"])}).views((e=>({get isIndependent(){return!0}}))),Zf=u.gK.compose("ViewModel",Xf,Gf,_c,Ne),qf=(0,v.PA)((({item:e})=>{let t={};return"inline"===e.display&&(t={display:"inline-block",marginRight:"15px"}),e.style&&(t=L.cssConverter(e.style)),!1===e.isVisible&&(t.display="none"),(0,A.jsx)("div",{id:e.idattr,className:e.classname,style:t,children:L.renderChildren(e,e.annotation)})}));b.addTag("view",Zf,qf);const Jf=u.gK.model({id:u.gK.optional(u.gK.identifier,T),type:"style",value:u.gK.optional(u.gK.string,"")}).views((e=>({get isIndependent(){return!0}}))),Qf=u.gK.compose("StyleModel",Jf),ev=(0,v.PA)((({item:e})=>(0,A.jsx)("style",{dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(e.value)}})));b.addTag("style",Qf,ev);var tv=n(6973);const nv=u.gK.model({casesensetive:u.gK.optional(u.gK.boolean,!1),cleanup:u.gK.optional(u.gK.boolean,!0),placeholder:u.gK.optional(u.gK.string,"Quick Filter"),minlength:u.gK.optional(u.gK.string,"3"),hotkey:u.gK.maybeNull(u.gK.string)}),ov=u.gK.model(Object.assign({type:"filter",_value:u.gK.maybeNull(u.gK.string)},(0,j.VS)(j.cE)?{id:u.gK.identifier,name:u.gK.string}:{name:u.gK.identifier},{toname:u.gK.maybeNull(u.gK.string)})).views((e=>({get toTag(){return e.annotation.names.get(e.toname)},get isIndependent(){var t,n;return null!=(t=null==(n=e.toTag)?void 0:n.isIndependent)&&t}}))).actions((e=>({applyFilter(){let t=e._value;const n=e.toTag.tiedChildren;Number(e.minlength)>t.length?n.filter((e=>!e.visible)).forEach((e=>e.setVisible(!0))):(e.casesensetive||(t=t.toLowerCase()),n.forEach((n=>{let o=n._value;e.casesensetive||(o=o.toLowerCase()),-1!==o.indexOf(t)?n.setVisible(!0):n.setVisible(!1)})))},applyFilterEv(t){const{value:n}=t.target;e._value=n,e.applyFilter()},onHotKey:()=>(e._ref&&e._ref.focus(),!1),setInputRef(t){e._ref=t},selectFirstElement(){e.toTag.selectFirstVisible()&&e.cleanup&&(e._value="",e.applyFilter())}}))),iv=u.gK.compose("FilterModel",ov,nv,Ue,Ne),sv=(0,v.PA)((({item:e})=>{const t=e.toTag;return-1===t.type.indexOf("labels")&&-1===t.type.indexOf("choices")?null:(0,A.jsx)(tv.A,{ref:t=>{e.setInputRef(t)},value:e._value,size:"small",onChange:e.applyFilterEv,onPressEnter:e.selectFirstElement,placeholder:e.placeholder})}));function rv(e){const t=[e];let n;for(;n=t.pop();){const e=Object.keys(n),o=Object.getOwnPropertyDescriptors(n);if(!("svg"===n.elementType))for(const i of e){const e=n[i],s=o[i].writable;e&&s&&("_debugOwner"!==i&&"object"==typeof e&&{}.hasOwnProperty.call(e,"stateNode")&&t.push(n[i]),"object"!=typeof e&&"function"!=typeof e||(n[i]=null))}}}function av(e){const t=Object.keys(e);for(const e of t){const t=RegExp(/^__reactProps(\$[^$]+)$/).exec(e);if(t)return t[1]}return""}function lv(e,t){for(const n of e){if(n.isConnected)return;if("svg"===n.tagName)return;const e=Object.keys(n).filter((e=>e.startsWith("__react")&&(!RegExp(/^(?:__reactProps|__reactFiber)/).exec(e)||RegExp(new RegExp(`\\${t}$`)).exec(e))));if(e.length){for(const t of e)rv(n[t]),n[t]=null;n.childNodes&&lv(n.childNodes,t)}}}b.addTag("filter",iv,sv);const dv=new WeakMap;function cv(e,t="default"){dv.has(e)||dv.set(e,new Map);const n=dv.get(e);return n.has(t)||n.set(t,function(){let e=null;return t=>{if(t)e=t;else if(e){const t=e,n=av(t);e=null,setTimeout((()=>{lv([t],n)}))}}}()),n.get(t)}var uv=n(12407);function hv({annotation:e,root:t}){return(0,m.useLayoutEffect)((()=>()=>{e&&(0,u._n)(e)&&e.resetReady()}),[e.pk,e.id]),t?L.renderItem(t,e):null}const gv=(0,v.PA)((({entity:e})=>{const{history:t}=e;return(0,A.jsxs)(Qe.eB,{name:"history-buttons",children:[(0,A.jsx)(Qn.m_M,{title:"Undo",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",type:"text","aria-label":"Undo",disabled:!(null!=t&&t.canUndo),onClick:()=>e.undo(),icon:(0,A.jsx)(To.GFc,{})})}),(0,A.jsx)(Qn.m_M,{title:"Redo",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",type:"text","aria-label":"Redo",disabled:!(null!=t&&t.canRedo),onClick:()=>e.redo(),icon:(0,A.jsx)(To.cHj,{})})}),(0,A.jsx)(Qn.m_M,{title:"Reset",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",type:"text","aria-label":"Reset",disabled:!(null!=t&&t.canUndo),onClick:()=>null==t?void 0:t.reset(),icon:(0,A.jsx)(To.CA7,{})})})]})})),mv=(0,v.WQ)("store")((0,v.PA)((({store:e})=>{const t=e.hasInterface("auto-annotation")&&!e.forceAutoAnnotation;return(0,m.useEffect)((()=>{t||e.setAutoAnnotation(!1)}),[t]),t?(0,A.jsx)(Qe.eB,{name:"dynamic-preannotations",children:(0,A.jsx)(Qe.Sl,{name:"wrapper",children:(0,A.jsx)(Oo,{spread:!0,children:(0,A.jsx)(Qn.lMk,{checked:e.autoAnnotation,onChange:t=>{const n=t.target.checked;e.setAutoAnnotation(n),n||od.allInstances().forEach((e=>e.selectDefault()))},label:"Auto-Annotation"})})})}):null}))),pv=(0,v.WQ)((({store:e})=>{var t;const n=null==(t=e.annotationStore)?void 0:t.selected;return{store:e,annotation:n,suggestions:null==n?void 0:n.suggestions}})),fv=pv((0,v.PA)((({store:e,annotation:t,suggestions:n})=>{if(!e.autoAnnotation)return null;const o=t.hasSuggestionsSupport&&!e.forceAutoAcceptSuggestions,i=e.awaitingSuggestions;return(0,A.jsxs)(Qe.eB,{name:"auto-accept",children:[o&&(0,A.jsx)(Qe.Sl,{name:"wrapper",mod:{loading:i},children:(0,A.jsx)(Oo,{spread:!0,children:n.size>0?(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsxs)(Qe.Sl,{name:"info",children:[n.size," suggestion",n.size>0&&"s"]}),(0,A.jsx)(Qe.Sl,{name:"action",tag:Po,mod:{type:"reject"},onClick:()=>t.rejectAllSuggestions(),children:(0,A.jsx)(To.kLH,{})}),(0,A.jsx)(Qe.Sl,{name:"action",tag:Po,mod:{type:"accept"},onClick:()=>t.acceptAllSuggestions(),children:(0,A.jsx)(To.iWP,{})})]}):(0,A.jsx)(Qn.lMk,{checked:e.autoAcceptSuggestions,onChange:t=>e.setAutoAcceptSuggestions(t.target.checked),label:"Auto-Accept Suggestions"})})}),i&&(0,A.jsx)(Qe.Sl,{name:"spinner"})]})}))),{Block:vv,Elem:yv}=(0,Qe.JE)(),bv=(0,v.PA)((({entity:e,disabled:t=!1,size:n="md"})=>{const o=e.ground_truth?"Unset this result as a ground truth":"Set this result as a ground truth";return!e.skipped&&!e.userGenerate&&"prediction"!==e.type&&(0,A.jsx)(vv,{name:"ground-truth",mod:{disabled:t,size:n},children:(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:o,children:(0,A.jsx)(yv,{tag:Po,name:"toggle",size:"small",type:"link",onClick:t=>{t.preventDefault(),e.setGroundTruth(!e.ground_truth)},children:(0,A.jsx)(yv,{name:"indicator",tag:(0,j.VS)(j.bA)&&!e.ground_truth?To.gkI:To.aGI,mod:{active:e.ground_truth,dark:(0,j.VS)(j.bA)}})})})})})),xv=({store:e})=>{const t=e.annotationStore,n=t.selected,o="prediction"===(null==n?void 0:n.type),i=!0===t.viewingAll,s=isFF(j.U2)&&!R()&&e.hasInterface("annotation:bulk");return(0,A.jsxs)(Qe.Sl,{name:"section",children:[!o&&!i&&e.hasInterface("edit-history")&&(0,A.jsx)(gv,{entity:n}),e.description&&e.hasInterface("instruction")&&(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Show instructions",children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.mJl,{style:{width:20,height:20}}),type:"text","aria-label":"Instructions",onClick:()=>e.toggleDescription(),style:{height:36,width:36,padding:0}})}),(0,A.jsx)(Qn.m_M,{alignment:"top-left",title:"Settings",children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.Ni9,{}),type:"text","aria-label":"Settings",onClick:()=>e.toggleSettings(),style:{height:36,width:36,padding:0}})}),e.hasInterface("ground-truth")&&!s&&(0,A.jsx)(bv,{entity:n}),!i&&(0,A.jsxs)(Qe.Sl,{name:"section",children:[(0,A.jsx)(mv,{}),(0,A.jsx)(fv,{})]})]})};function Sv(e){const t=(0,v.WQ)((({store:e})=>{var t;return{store:e,history:null==e||null==(t=e.annotationStore)||null==(t=t.selected)?void 0:t.history}}))(e);return t}const wv=Sv((0,v.PA)((({store:e,title:t,children:n})=>(0,A.jsx)(Qn.m_M,{title:t,disabled:!e.settings.enableTooltips,children:n})))),kv=(0,m.memo)((0,v.PA)((({disabled:e,history:t,store:n})=>(0,A.jsx)(wv,{title:"Accept annotation: [ Ctrl+Enter ]",children:(0,A.jsx)(Po,{"aria-label":"accept-annotation",disabled:e,look:"primary",onClick:async()=>{var e;const t=null==(e=n.annotationStore)?void 0:e.selected;null==t||t.submissionInProgress(),await n.commentStore.commentFormSubmit(),n.acceptAnnotation()},children:t.canUndo?"Fix + Accept":"Accept"})},"accept")))),Cv={id:"reject",name:"reject",title:"Reject",look:void 0,ariaLabel:"reject-annotation",tooltip:"Reject annotation: [ Ctrl+Space ]",disabled:!1},jv=(0,m.memo)((0,v.PA)((({disabled:e,store:t,onSkipWithComment:n})=>(0,A.jsx)(wv,{title:"Cancel (skip) task: [ Ctrl+Space ]",children:(0,A.jsx)(Po,{"aria-label":"skip-task",disabled:e,onClick:async e=>{var o,i;const s=()=>t.skipTask({}),r=null==(o=t.annotationStore)?void 0:o.selected;null==(i=t.hasInterface("comments:skip"))||i?n(e,s):(null==r||r.submissionInProgress(),await t.commentStore.commentFormSubmit(),t.skipTask({}))},children:"Skip"})},"skip")))),Rv=(0,m.memo)((0,v.PA)((({disabled:e,store:t})=>(0,A.jsx)(wv,{title:"Cancel skip: []",children:(0,A.jsx)(Po,{"aria-label":"cancel-skip",disabled:e,look:"primary",onClick:async()=>{var e;const n=null==(e=t.annotationStore)?void 0:e.selected;null==n||n.submissionInProgress(),await t.commentStore.commentFormSubmit(),t.unskipTask()},children:"Cancel skip"})},"cancel-skip")))),_v=(0,v.PA)((({button:e,disabled:t,onClick:n})=>{const o=e.disabled||t?"disabled":e.look,i=(0,A.jsx)(Po,Object.assign({},e.props,{"aria-label":e.ariaLabel,disabled:e.disabled||t,look:o,onClick:n,children:e.title}));return e.tooltip?(0,A.jsx)(wv,{title:e.tooltip,children:(0,A.jsx)(Qe.Sl,{name:"tooltip-wrapper",children:i})}):i})),Tv=Sv((0,v.PA)((({store:e,history:t,annotation:n})=>{const o=e.hasInterface("review")||n.canBeReviewed,i=e.hasInterface("topbar:prevnext"),s=(0,x.isDefined)(e.annotationStore.selectedHistory),{userGenerate:r,sentUserGenerate:a,versions:l,results:d,editable:c}=n,u=(0,Qe.cn)("dropdown").elem("trigger").toClassName(),h=e.customButtons,g=[],[p,f]=(0,m.useState)(!1),v=!c||e.isSubmitting||s||p,y=e.hasInterface("annotations:deny-empty")&&0===d.length,b=(0,m.useCallback)((async(t,o,i)=>{var s,r,a;const{addedCommentThisSession:l,currentComment:d,commentFormSubmit:c}=e.commentStore,u=d[n.id],h=null==(s=null!=(r=null==u?void 0:u.text)?r:u)?void 0:s.trim();if(p)return;f(!0);const g=null==(a=e.annotationStore)?void 0:a.selected;l?(null==g||g.submissionInProgress(),o()):h?(t.preventDefault(),null==g||g.submissionInProgress(),await c(),o()):e.commentStore.setTooltipMessage(i),f(!1)}),[e.rejectAnnotation,e.skipTask,e.commentStore.currentComment,e.commentStore.commentFormSubmit,e.commentStore.addedCommentThisSession,p]);if(n.isNonEditableDraft)return null;const S=h.get("_before"),w=h.get("_replace"),k=null!=w?w:S;if(k){const n=(0,x.toArray)(k);for(const o of n)"string"==typeof o?"accept"===o&&g.push((0,A.jsx)(kv,{disabled:v,history:t,store:e},o)):g.push((0,A.jsx)(_v,{disabled:v,button:o,onClick:()=>null==e.handleCustomButton?void 0:e.handleCustomButton(o)},o.name))}if(w);else if(o){const n=(0,x.toArray)(h.get("reject")),o=n.length>0,i=Cv;(o?n.filter((e=>"string"!=typeof e)):[i]).forEach((t=>{const n=o?()=>null==e.handleCustomButton?void 0:e.handleCustomButton(t):()=>e.rejectAnnotation({});g.push((0,A.jsx)(_v,{button:t,disabled:v,onClick:async t=>{var o;const i=null==(o=e.annotationStore)?void 0:o.selected;e.hasInterface("comments:reject")?b(t,n,"Please enter a comment before rejecting"):(null==i||i.submissionInProgress(),await e.commentStore.commentFormSubmit(),n())}},t.name))})),g.push((0,A.jsx)(kv,{disabled:v,history:t,store:e},"review-accept"))}else if(n.skipped)g.push((0,A.jsxs)(Qe.Sl,{name:"skipped-info",children:[(0,A.jsx)(Qn.r7P,{color:"#d00"})," Was skipped"]},"skipped")),g.push((0,A.jsx)(Rv,{disabled:v,store:e},"unskip"));else{if(e.hasInterface("skip")){const t=(e,t)=>{b(e,t,"Please enter a comment before skipping")};g.push((0,A.jsx)(jv,{disabled:v,store:e,onSkipWithComment:t},"skip"))}const o=v||y,s=o?"disabled":"primary",d=!o&&i,c=({isUpdate:t,onClickMethod:n})=>(0,A.jsx)(Po,{name:"submit-option",look:"primary",onClick:async t=>{var o;t.preventDefault();const i=null==(o=e.annotationStore)?void 0:o.selected;if(null==i||i.submissionInProgress(),"URLSearchParams"in window){const e=new URLSearchParams(window.location.search);e.set("exitStream","true");const t=`${window.location.pathname}?${e.toString()}`;window.history.pushState(null,"",t)}await e.commentStore.commentFormSubmit(),n()},children:(t?"Update":"Submit")+" and exit"});if(r||e.explore&&!r&&e.hasInterface("submit")){const t=y?"Empty annotations denied in this project":"Save results: [ Ctrl+Enter ]";g.push((0,A.jsx)(wv,{title:t,children:(0,A.jsx)(Qe.Sl,{name:"tooltip-wrapper",children:(0,A.jsx)(Po,{"aria-label":"submit",name:"submit",disabled:o,look:s,mod:{has_icon:d,disabled:o},onClick:async t=>{var n;if(t.target.classList.contains(u))return;const o=null==(n=e.annotationStore)?void 0:n.selected;null==o||o.submissionInProgress(),await e.commentStore.commentFormSubmit(),e.submitAnnotation()},icon:d?(0,A.jsx)(Wh.Trigger,{alignment:"top-right",content:(0,A.jsx)(c,{onClickMethod:e.submitAnnotation,isUpdate:!1}),children:(0,A.jsx)("div",{children:(0,A.jsx)(Qn.Vh6,{})})}):void 0,children:"Submit"})})},"submit"))}if(r&&a||!r&&e.hasInterface("update")){const i=Boolean((0,j.VS)(j.I8)||a||l.result),r=(0,j.VS)(j.I8)&&!t.canUndo&&!n.draftId,h=o||r,m=(0,A.jsx)(wv,{title:r?"No changes were made":"Update this task: [ Ctrl+Enter ]",children:(0,A.jsx)(Po,{"aria-label":"submit",name:"submit",disabled:h,look:s,mod:{has_icon:d,disabled:h},onClick:async t=>{var n;if(t.target.classList.contains(u))return;const o=null==(n=e.annotationStore)?void 0:n.selected;null==o||o.submissionInProgress(),await e.commentStore.commentFormSubmit(),e.updateAnnotation()},icon:d?(0,A.jsx)(Wh.Trigger,{alignment:"top-right",content:(0,A.jsx)(c,{onClickMethod:e.updateAnnotation,isUpdate:i}),children:(0,A.jsx)("div",{children:(0,A.jsx)(Qn.Vh6,{})})}):void 0,children:i?"Update":"Submit"})},"update");g.push(m)}}return(0,A.jsx)(Qe.eB,{name:"controls",children:g})}))),Av=(0,v.PA)((({store:e})=>{const t=e.annotationStore,n=null==t?void 0:t.selected,o="prediction"===(null==n?void 0:n.type),i=!0===(null==t?void 0:t.viewingAll);return e&&!i?(0,A.jsxs)(Qe.eB,{name:"bottombar",style:{borderTop:(0,j.VS)(j.bA)&&"1px solid rgba(0,0,0,0.1)"},children:[(0,A.jsx)(Qe.Sl,{name:"group",children:(0,A.jsx)(xv,{store:e})}),(0,A.jsx)(Qe.Sl,{name:"group",children:e.hasInterface("controls")&&(e.hasInterface("review")||!o)&&(0,A.jsx)(Qe.Sl,{name:"section",mod:{flat:!0},children:(0,A.jsx)(Tv,{annotation:n})})})]}):null}));var Kv=n(54200);const Ev=e=>{const t=e.pk||e.id,n=e.serializeAnnotation(),o=e.versions.draft,i={id:t,result:n};return o&&(i.draft=o),i},Pv=(0,v.PA)((({store:e})=>{const t=(0,m.useRef)(),n=(0,m.useRef)(),o=(0,m.useRef)(),i=(0,m.useCallback)((()=>{var i,s,r;const a=null==(i=t.current)?void 0:i.value,l=JSON.parse((null==(s=o.current)?void 0:s.value)||'[{ "result": [] }]'),d=JSON.parse(null==(r=n.current)?void 0:r.value);e.resetState(),e.assignConfig(a),e.assignTask({data:d}),e.initializeStore({annotations:l,predictions:[]});const c=e.annotationStore;c.annotations.length&&c.selectAnnotation(c.annotations[0].id)}),[]),s=(0,m.useCallback)((()=>{const t=o.current;if(!t)return;const n=e.annotationStore.selected,i=[Ev(n)];t.value=JSON.stringify(i,null,2)}),[]),r=(0,m.useCallback)((()=>{const t=o.current;if(!t)return;const{annotations:n,predictions:i}=e.annotationStore,s=[...n,...i].map(Ev);t.value=JSON.stringify(s,null,2)}),[]);return(0,A.jsxs)("div",{style:{width:"100%"},children:[(0,A.jsx)("br",{}),(0,A.jsx)("h2",{children:"Debug"}),(0,A.jsxs)("div",{children:[(0,A.jsx)(xo.A,{onClick:r,children:" Serialize All Annotations"}),(0,A.jsx)(xo.A,{onClick:s,children:" Serialize Current Annotation"}),(0,A.jsx)(xo.A,{onClick:i,children:" Simulate Loading Task"})]}),(0,A.jsx)(Kv.A,{children:(0,A.jsxs)("div",{style:{display:"flex"},children:[(0,A.jsxs)("div",{style:{flexBasis:"50%"},children:[(0,A.jsx)("p",{children:"Data"}),(0,A.jsx)("textarea",{style:{width:"100%"},ref:n,rows:4,defaultValue:e.task.data,className:"is-search"}),(0,A.jsx)("p",{children:"Config"}),(0,A.jsx)("textarea",{style:{width:"100%"},ref:t,rows:16,defaultValue:e.config,className:"is-search"})]}),(0,A.jsxs)("div",{style:{flexBasis:"50%"},children:[(0,A.jsx)("p",{children:"Annotations"}),(0,A.jsx)("textarea",{style:{width:"100%"},ref:o,rows:22,className:"is-search"})]})]})})]})}));var Mv=n(18869),Dv=n(83764);const Ov="grid--e4IWo",Iv="container--CXRH5",Lv="left--_1fAk",Nv="right--LGT3p",zv=(0,v.PA)((0,m.forwardRef)((({entity:e,selected:t,style:n,onClick:o,bordered:i=!0,prediction:s=!1,displayGroundTruth:r=!1},a)=>{var l,d;const c=e.userGenerate&&!e.sentUserGenerate||e.draftSelected,u=e.store.hasInterface("annotations:hide-info");return(0,A.jsx)(Qe.eB,{name:"entity-tab",ref:a,mod:{selected:t,bordered:i},style:n,onClick:t=>{t.preventDefault(),t.stopPropagation(),null==o||o(e,s)},children:(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsx)(Qe.Sl,{name:"userpic",tag:Qn.an1,showUsername:!0,username:s?e.createdBy:null,user:u?{}:null!=(l=e.user)?l:{email:e.createdBy},mod:{prediction:s},children:s&&(0,A.jsx)(To.ccx,{style:{width:16,height:16}})}),!u&&(0,A.jsxs)(Qe.Sl,{name:"identifier",children:["ID ",null!=(d=e.pk)?d:e.id," ",c&&"*"]}),r&&e.ground_truth&&(0,A.jsx)(Qe.Sl,{name:"ground-truth",tag:To.aGI}),e.skipped&&(0,A.jsx)(Qe.Sl,{name:"skipped",tag:To.r7P})]})})})));class Vv extends m.Component{componentDidMount(){Promise.all(this.props.annotation.objects.map((e=>"image"===e.type?Promise.resolve():e.isReady?Promise.resolve(e.isReady):new Promise((t=>{const n=(0,c.lB)(e,"isReady",(()=>{n(),t()}))}))))).then((()=>{setTimeout(this.props.onFinish,32)}))}render(){return(0,A.jsx)(hv,{root:this.props.root,annotation:this.props.annotation})}}class Hv extends m.Component{constructor(...e){super(...e),this.state={item:0,loaded:new Set},this.container=m.createRef(),this.onFinish=()=>{const e=this.container.current;if(!e)return;const t=e.children[e.children.length-1],n=t.children[t.children.length-1],o=n.cloneNode(!0);e.children[this.state.item].appendChild(o),Ct.A.stages.map((e=>e.draw()));const i=n.querySelectorAll("canvas");o.querySelectorAll("canvas").forEach(((e,t)=>{e.getContext("2d").drawImage(i[t],0,0)}));const s=n.querySelectorAll("iframe");o.querySelectorAll("iframe").forEach(((e,t)=>{e.contentWindow.document.open(),e.contentWindow.document.write(s[t].contentDocument.documentElement.outerHTML),(0,Ke.moveStylesBetweenHeadTags)(s[t].contentDocument.head,e.contentDocument.head)})),this.setState((e=>Object.assign({},e,{loaded:new Set([...e.loaded,this.props.store.selected.id])}))),this.renderNext()},this.shift=e=>{const t=this.container.current,n=t.children,o=Array.from(n).findIndex((e=>t.scrollLeft<=e.offsetLeft));if(!t)return;const i=this.props.annotations.length,s=o+e;if(s<0||s>i-1)return;const r=n[s].offsetLeft;t.scrollTo({left:r,top:0,behavior:"smooth"})},this.left=()=>{this.shift(-1)},this.right=()=>{this.shift(1)},this.select=e=>{const{store:t}=this.props;"annotation"===e.type?t.selectAnnotation(e.id):t.selectPrediction(e.id)}}shouldComponentUpdate(e,t){return!e.store.selected.selected||t.item>=e.annotations.length||e.annotations[t.item]===e.store.selected}componentDidMount(){(0,j.VS)(j.cE)||this.props.annotations[0]===this.props.store.selected||this.startRenderCycle()}startRenderCycle(){this.renderNext(0)}renderNext(e){this.setState({item:(0,x.isDefined)(e)?e:this.state.item+1},(()=>{this.state.item<this.props.annotations.length?this.props.store._selectItem(this.props.annotations[this.state.item]):this.props.store._unselectAll()}))}render(){const e=this.state.item,{annotations:t}=this.props,n=(0,j.VS)(j.cE)?null:this.props.store.selected,o=e<t.length&&t[e]===n;return(0,A.jsxs)("div",{className:Iv,children:[(0,A.jsxs)("div",{ref:this.container,className:Ov,children:[t.filter((e=>!e.hidden)).map((e=>(0,A.jsxs)("div",{id:`c-${e.id}`,style:{position:"relative"},children:[(0,A.jsx)(zv,{entity:e,onClick:()=>this.select(e),prediction:"prediction"===e.type,bordered:!1,style:{height:44}}),(0,j.VS)(j.cE)?(0,A.jsx)(hv,{root:this.props.root,annotation:e}):!this.state.loaded.has(e.id)&&(0,A.jsx)("div",{style:{top:0,left:0,position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,A.jsx)(f.A,{size:"large"})})]},`anno-${e.id}`))),o&&(0,A.jsxs)("div",{id:"c-tmp",style:{opacity:0,position:"relative",right:99999},children:[(0,A.jsx)(zv,{entity:n,prediction:"prediction"===n.type,bordered:!1,style:{height:44}}),(0,A.jsx)(Vv,{root:this.props.root,onFinish:this.onFinish,annotation:n},e)]},"anno-tmp")]}),(0,A.jsx)(xo.A,{type:"text",onClick:this.left,className:Lv,icon:(0,A.jsx)(Mv.A,{})}),(0,A.jsx)(xo.A,{type:"text",onClick:this.right,className:Nv,icon:(0,A.jsx)(Dv.A,{})})]})}}const Bv=({title:e,children:t,visible:n,onCancel:o})=>{const i={padding:"0 24px 24px",whiteSpace:"pre-wrap"};return(0,A.jsx)(A.Fragment,{children:(0,A.jsxs)(fn.A,{title:"",open:n,maskClosable:!0,footer:null,closable:!0,onCancel:()=>o(),width:"70%",style:{maxHeight:"calc(100vh - 250px)",minWidth:"400px",maxWidth:"800px",borderRadius:"8px",overflow:"hidden",padding:"0"},bodyStyle:{overflow:"auto",maxHeight:"calc(100vh - 250px)",padding:"0px"},children:[(0,A.jsx)("h2",{style:{position:"sticky",top:"0px",background:"white",padding:"24px 24px 20px",margin:"0px",fontWeight:"400",fontSize:"24"},children:e}),"string"==typeof t?(0,A.jsx)("p",{style:i,dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(t)}}):(0,A.jsx)("p",{style:i,children:t})]})})};var Fv=n(19686);const Wv="container--pU5HK",$v="relationItem--MyZ3F",Uv="_highlighting--YEDwO",Yv="_highlighted--fZddy",Xv=["relation","startNode","endNode","visible"],Gv=["tags","taskData"],Zv=({id:e,color:t})=>(0,A.jsx)("marker",{id:`arrow-${e}`,viewBox:"0 0 10 10",refX:8,refY:5,markerWidth:4,markerHeight:4,orient:"auto-start-reverse",children:(0,A.jsx)("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:t})}),qv=({x:e,y:t,width:n,height:o})=>(0,A.jsx)("rect",{x:e,y:t,width:n,height:o,fill:"none"}),Jv=({id:e,command:t,color:n,direction:o,highlight:i})=>{const s=i?"#fa541c":n,r={d:t,stroke:s,fill:"none",strokeLinecap:"round"},a={};return"bi"!==o&&"right"!==o||(a.markerEnd=`url(#arrow-${e})`),"bi"!==o&&"left"!==o||(a.markerStart=`url(#arrow-${e})`),(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)("defs",{children:(0,A.jsx)(Zv,{id:e,color:s})}),i&&(0,A.jsx)("path",Object.assign({},r,{stroke:n,opacity:.1,strokeWidth:6})),(0,A.jsx)("path",Object.assign({},r,{opacity:i?1:.6,strokeWidth:2},a))]})},Qv=({label:e,position:t})=>{const[n,o]=t,i=(0,m.useRef)(),[s,r]=(0,m.useState)({width:0,height:0,x:0,y:0}),a={transform:`translate(${n}, ${o})`,textAnchor:"middle",dominantBaseline:"middle"};return(0,m.useEffect)((()=>{const e=i.current.getBBox();r({x:e.x-5,y:e.y-3,width:e.width+10,height:e.height+6})}),[e]),(0,A.jsxs)("g",Object.assign({},a,{children:[(0,A.jsx)("rect",Object.assign({},s,{stroke:"#fff",strokeWidth:2,fill:"#a0a",rx:"3"})),(0,A.jsx)("text",Object.assign({ref:i},{fill:"white",style:{fontSize:12,fontFamily:"arial"}},{children:e}))]}))},ey=({id:e,startNode:t,endNode:n,direction:o,rootRef:i,highlight:s,dimm:r,labels:a,visible:l})=>{const d=i.current,c=!0===t.hidden||!0===n.hidden||!l,[,u]=(0,m.useState)(),h=ce({id:e,startNode:t,endNode:n,direction:o,labels:a},d),{start:g,end:p}=ue(Object.assign({root:d},h)),[f,v]=he(g,p);if((0,m.useEffect)((()=>(h.onChange((()=>u({}))),()=>h.destroy())),[]),g.width<1||g.height<1||p.width<1||p.height<1)return null;const y=[$v];return s&&y.push(Yv),(0,A.jsxs)("g",{id:e,className:y.join(" "),visibility:c?"hidden":"visible",children:[(0,A.jsx)(qv,Object.assign({},g)),(0,A.jsx)(qv,Object.assign({},p)),(0,A.jsx)(Jv,{id:h.id,command:f,color:h.color,direction:h.direction,highlight:s}),h.label&&(0,A.jsx)(Qv,{label:h.label,position:v})]})},ty=(0,v.PA)((e=>{let{relation:t,startNode:n,endNode:o,visible:i}=e,s=(0,Zn.A)(e,Xv);const r=[n.getRegionElement?n.getRegionElement():n,o.getRegionElement?o.getRegionElement():o],[a,l]=(0,m.useState)(r[0]&&r[1]);(0,m.useEffect)((()=>{let e;const t=()=>{const n=(0,x.isDefined)(r[0])&&(0,x.isDefined)(r[1]);a!==n?l(n):!1===a&&(e=setTimeout(t,30))};return e=setTimeout(t,30),()=>clearTimeout(e)}),[r,a]);const d=i&&t.visible;return a&&t.shouldRender?(0,A.jsx)(ey,Object.assign({id:t.id,startNode:n,endNode:o,direction:t.direction,visible:d,labels:t.selectedValues},s)):null}));class ny extends m.PureComponent{constructor(...e){super(...e),this.rootNode=(0,m.createRef)(),this.timer=null,this.state={shouldRender:!1,shouldRenderConnections:Math.random()},this.onResize=()=>{this.setState({shouldRenderConnections:Math.random()})}}componentDidUpdate(){this.rootNode.current&&!this.state.shouldRender&&this.setState({shouldRender:!0})}render(){const{relations:e,visible:t,highlighted:n}=this.props,o=!!n,i={top:0,left:0,width:"100%",height:"100%",position:"absolute",pointerEvents:"none",zIndex:100},s=["relations-overlay",Wv];return o&&s.push(Uv),(0,A.jsx)(Fv.Ay,{onResize:this.onResize,children:()=>(0,A.jsxs)("svg",{className:s.join(" "),ref:this.rootNode,xmlns:"http://www.w3.org/2000/svg",style:i,children:[(0,A.jsx)("title",{children:this.state.shouldRender?"Arrow Marker":""}),this.state.shouldRender&&this.renderRelations(e,t,o,n),n?(0,A.jsx)("use",{xlinkHref:`#${n.id}`}):null]})})}renderRelations(e,t,n,o){return e.map((e=>{const i=o===e;return(0,A.jsx)(ty,{relation:e,rootRef:this.rootNode,startNode:e.node1,endNode:e.node2,dimm:n&&!i,highlight:i,visible:i||t,shouldUpdate:this.state.shouldRenderConnections},e.id)}))}}const oy=(0,v.PA)(ny),iy=(0,v.PA)((0,m.forwardRef)((({store:e,tags:t},n)=>{var o;const{relations:i,showConnections:s,highlighted:r}=e;return(0,A.jsx)(oy,{ref:n,relations:Array.from(i),visible:s,highlighted:r,tags:Array.from(null!=(o=null==t||null==t.values?void 0:t.values())?o:[])})})));let sy=null;const ry=(e,t)=>{if(clearTimeout(sy),(0,j.VS)(j.cE)){if(![...e.values()].every(u._n))return!1}else if(!(0,u._n)(e))return;const n=Array.from(e.values()).reduce(((e,t)=>{var n;return e&&(null==(n=null==t?void 0:t.isReady)||n)}),!0);t(n),n||(sy=setTimeout((()=>{ry(e,t)}),100))},ay=(0,v.PA)((0,m.forwardRef)(((e,t)=>{let{tags:n,taskData:o}=e,i=(0,Zn.A)(e,Gv);const[s,r]=(0,m.useState)(!1);return(0,m.useEffect)((()=>(ry(n,(e=>{r(e)})),()=>clearTimeout(sy))),[o,n]),s&&(0,A.jsx)(iy,Object.assign({ref:t},i))}))),ly="block--sSl0y";class dy extends m.Component{componentDidMount(){const{annotation:e}=this.props;e&&e.updateObjects()}render(){let e=ly;return this.props.className&&(e=`${e} ${this.props.className}`),(0,A.jsx)("div",{className:e,children:this.props.children})}}dy.propTypes={children:Te.PropTypes.array.isRequired};var cy=n(46644);const uy={enableHotkeys:{newUI:{title:"Labeling hotkeys",description:"Enables quick selection of labels using hotkeys"},description:"Enable labeling hotkeys",onChangeEvent:"toggleHotkeys",defaultValue:!0},enableTooltips:{newUI:{title:"Show hotkeys on tooltips",description:"Displays keybindings on tools and actions tooltips"},description:"Show hotkey tooltips",onChangeEvent:"toggleTooltips",checked:"",defaultValue:!1},enableLabelTooltips:{newUI:{title:"Show hotkeys on labels",description:"Displays keybindings on labels"},description:"Show labels hotkey tooltips",onChangeEvent:"toggleLabelTooltips",defaultValue:!0},showLabels:{newUI:{title:"Show region labels",description:"Display region label names"},description:"Show labels inside the regions",onChangeEvent:"toggleShowLabels",defaultValue:!1},continuousLabeling:{newUI:{title:"Keep label selected after creating a region",description:"Allows continuous region creation using the selected label"},description:"Keep label selected after creating a region",onChangeEvent:"toggleContinuousLabeling",defaultValue:!1},selectAfterCreate:{newUI:{title:"Select region after creating it",description:"Automatically selects newly created regions"},description:"Select regions after creating",onChangeEvent:"toggleSelectAfterCreate",defaultValue:!1},showLineNumbers:{newUI:{tags:"Text Tag",title:"Show line numbers",description:"Identify and reference specific lines of text in your document"},description:"Show line numbers for Text",onChangeEvent:"toggleShowLineNumbers",defaultValue:!1},preserveSelectedTool:{newUI:{tags:"Image Tag",title:"Keep selected tool",description:"Persists the selected tool across tasks"},description:"Remember Selected Tool",onChangeEvent:"togglepreserveSelectedTool",defaultValue:!0},enableSmoothing:{newUI:{tags:"Image Tag",title:"Pixel smoothing on zoom",description:"Smooth image pixels when zoomed in"},description:"Enable image smoothing when zoom",onChangeEvent:"toggleSmoothing",defaultValue:!0}},hy={videoDrawOutside:{description:"Allow drawing outside of video boundaries",defaultValue:!1,type:"boolean"},videoHopSize:{description:"Video hop size",defaultValue:10,type:"number"}},gy=(0,v.PA)((({store:e,name:t,value:n})=>{const o={onChange:o=>{if(n.onChangeEvent)n.onChangeEvent(o);else if("boolean"===n.type)e.settings.toggleProperty(t);else{const i="number"===n.type?Number(o.target.value):o.target.value;e.settings.setProperty(t,i)}}};return"boolean"===n.type&&(o.checked=e.settings[t]),"boolean"!==n.type&&(o.type=n.type,o.value=e.settings[t],o.placeholder=n.description),"number"===n.type&&(o.step=n.step,o.min=n.min,o.max=n.max),(0,A.jsx)(Qe.Sl,{name:"field",children:"boolean"===n.type?(0,A.jsx)(Qn.Sc0,Object.assign({},o,{children:n.description})):(0,A.jsxs)("label",{children:[n.description,(0,A.jsx)(tv.A,Object.assign({},o))]})},t)})),my=(0,v.PA)((({store:e,settings:t})=>(0,A.jsx)(Qe.eB,{name:"settings",children:Object.entries(t).map((([t,n])=>n.ff&&!(0,j.VS)(n.ff)?null:(0,A.jsx)(gy,{name:t,store:e,value:n},t)))}))),py=({store:e})=>(0,A.jsx)(my,{store:e,settings:hy});py.displayName="VideoSettings",py.tagName="Video",py.title="Video";const fy=(0,Rr.PA)(py),vy=(0,j.VS)(j.bA)?{newUI:!0}:{},yy=Object.keys(uy);if((0,j.VS)(j.bA)){const e=yy.findIndex((e=>"enableTooltips"===e)),t=yy.findIndex((e=>"enableLabelTooltips"===e)),n=yy[e];yy[e]=yy[t],yy[t]=n}const by=({children:e})=>(0,A.jsx)(Qe.eB,{name:"settings-tag",children:e}),xy=(0,v.PA)((({store:e})=>(0,A.jsx)(Qe.eB,{name:"settings",mod:vy,children:yy.map(((t,n)=>{var o;return(0,A.jsx)(Qe.Sl,{name:"field",tag:"label",children:(0,j.VS)(j.bA)?(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(Qe.eB,{name:"settings__label",children:[(0,A.jsxs)(Qe.Sl,{name:"title",children:[uy[t].newUI.title,null==(o=uy[t].newUI.tags)?void 0:o.split(",").map((e=>(0,A.jsx)(by,{children:e},e)))]}),(0,A.jsx)(Qe.eB,{name:"description",children:uy[t].newUI.description})]}),(0,A.jsx)(Qn.lMk,{checked:e.settings[t],onChange:e.settings[uy[t].onChangeEvent],description:uy[t].description},n)]}):(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qn.Sc0,{checked:e.settings[t],onChange:e.settings[uy[t].onChangeEvent],children:uy[t].description},n),(0,A.jsx)("br",{})]})},n)}))}))),Sy=(0,v.PA)((({store:e})=>(0,A.jsxs)(Qe.eB,{name:"settings",mod:vy,children:[(0,A.jsx)(Qe.Sl,{name:"field",children:(0,A.jsx)(Qn.Sc0,{checked:e.settings.bottomSidePanel,onChange:()=>{e.settings.toggleBottomSP(),setTimeout(x.triggerResizeEvent)},children:"Move sidepanel to the bottom"})}),(0,A.jsx)(Qe.Sl,{name:"field",children:(0,A.jsx)(Qn.Sc0,{checked:e.settings.displayLabelsByDefault,onChange:e.settings.toggleSidepanelModel,children:"Display Labels by default in Results panel"})}),(0,A.jsx)(Qe.Sl,{name:"field",children:(0,A.jsx)(Qn.Sc0,{value:"Show Annotations panel",defaultChecked:e.settings.showAnnotationsPanel,onChange:()=>{e.settings.toggleAnnotationsPanel()},children:"Show Annotations panel"})}),(0,A.jsx)(Qe.Sl,{name:"field",children:(0,A.jsx)(Qn.Sc0,{value:"Show Predictions panel",defaultChecked:e.settings.showPredictionsPanel,onChange:()=>{e.settings.togglePredictionsPanel()},children:"Show Predictions panel"})})]}))),wy={General:{name:"General",component:xy},Hotkeys:{name:"Hotkeys",component:()=>{const e=[{title:"Shortcut",dataIndex:"combo",key:"combo"},{title:"Description",dataIndex:"descr",key:"descr"}],t=go.namespaces();return(0,A.jsx)(Qe.eB,{name:"keys",children:(0,A.jsx)(cy.A,{size:"small",children:Object.entries(t).map((([t,n])=>{var o,i;return 0===Object.keys(n.descriptions).length?null:(0,A.jsx)(cy.A.TabPane,{tab:null!=(o=n.description)?o:t,children:(0,A.jsx)(Qu.A,{columns:e,dataSource:(i=n.descriptions,Object.keys(i).filter((e=>i[e])).map((e=>({key:e,combo:e.split(",").map((e=>(0,A.jsx)(Qe.Sl,{name:"key-group",children:e.trim().split("+").map((e=>(0,A.jsx)(Qe.Sl,{tag:"kbd",name:"key",children:e},e)))},e))),descr:i[e]})))),size:"small"})},t)}))})})}}};(0,j.VS)(j.bA)||(wy.Layout={name:"Layout",component:Sy});const ky=Object.keys(wy)[0],Cy=(0,j.VS)(j.bA)?{name:"settings-modal",title:"Labeling Interface Settings",closeIcon:(0,A.jsx)(To.gzW,{})}:{name:"settings-modal-old",title:"Settings",bodyStyle:{paddingTop:"0"}},jy=(0,v.PA)((({store:e})=>{const t=(0,m.useMemo)((()=>{const t=Object.values(e.annotationStore.names.toJSON()),n=Object.values(d);return t.reduce(((t,o)=>{const i=e.annotationStore.names.get(o).type,s=n.find((({tagName:e})=>e.toLowerCase()===i.toLowerCase()));return s&&t.push(s),t}),[])}),[]);return(0,A.jsx)(Qe.eB,Object.assign({tag:fn.A,open:e.showingSettings,onCancel:e.toggleSettings,footer:""},Cy,{children:(0,A.jsxs)(cy.A,{defaultActiveKey:ky,children:[Object.entries(wy).map((([t,{name:n,component:o}])=>(0,A.jsx)(cy.A.TabPane,{tab:n,children:m.createElement(o,{store:e})},t))),t.map((t=>(0,A.jsx)(cy.A.TabPane,{tab:t.title,children:(0,A.jsx)(t,{store:e})},t.tagName)))]})}))}));function Ry(...e){const t=e.filter(Boolean);return t.length<=1?t[0]:e=>{t.forEach((t=>{"function"==typeof t?t(e):t.current=e}))}}const _y=["ref","actionRef","onChange","onInput","onSubmit","value","autoSize","rows","maxRows","className"],Ty=e=>{let{ref:t,actionRef:n,onChange:o,onInput:i,onSubmit:s,value:r,autoSize:a=!0,rows:l=1,maxRows:d=4,className:c}=e,u=(0,Zn.A)(e,_y);const h=!!s,g=[(0,Qe.cn)("textarea").mod({inline:h,autosize:a}),c].join(" ").trim(),p=(0,m.useRef)({rows:l,maxRows:Math.max(d-1,1),lineHeight:24,maxHeight:Number.POSITIVE_INFINITY}),f=(0,m.useRef)(null),v=(0,m.useCallback)((0,li.debounce)((()=>{const e=f.current;if(!e||!p.current||!f.current)return;if(p.current.maxHeight===Number.POSITIVE_INFINITY){e.style.height="auto";const t=f.current.value;f.current.value="",p.current.lineHeight=f.current.scrollHeight/p.current.rows,p.current.maxHeight=p.current.lineHeight*p.current.maxRows,f.current.value=t}let t;e.scrollHeight>p.current.maxHeight?(e.style.overflowY="scroll",t=p.current.maxHeight):(e.style.overflowY="hidden",e.style.height="auto",t=e.scrollHeight);const n=e.value.length,o=e.selectionStart;requestAnimationFrame((()=>{e.style.height=`${t}px`,n===o&&(e.scrollTop=e.scrollHeight)}))}),10,{leading:!0}),[]);n&&(n.current={update:(e="")=>{f.current&&(f.current.value=e,v())},el:f});const y=(0,m.useCallback)((e=>{null==i||i(e.target.value),v()}),[i]),b=(0,m.useCallback)((e=>{null==o||o(e.target.value),v()}),[o]);return(0,m.useEffect)((()=>{const e=new ResizeObserver(v);return e.observe(f.current),()=>{f.current&&e.unobserve(f.current)}}),[]),(0,m.useEffect)((()=>{f.current&&(f.current.value=r||"",v())}),[r]),(0,m.useEffect)((()=>{if(!s)return;const e=e=>{f.current&&"Enter"===e.key&&(e.ctrlKey||(0,x.isMacOS)()&&e.metaKey)&&s(f.current.value)};return f.current&&f.current.addEventListener("keydown",e),()=>{f.current&&f.current.removeEventListener("keydown",e)}}),[s]),(0,A.jsx)("textarea",Object.assign({ref:Ry(f,t),className:g,rows:p.current.rows,onChange:b,onInput:y},u))},Ay=(0,v.PA)((({commentStore:e,annotationStore:t,inline:n=!0,onChange:o,rows:i=1,maxRows:s=4})=>{const r=(0,m.useRef)(null),a=(0,m.useRef)({}),l=()=>e.setTooltipMessage(""),d=(0,m.useCallback)((async t=>{if(null==t||null==t.preventDefault||t.preventDefault(),!r.current||"addComment"===e.loading)return;const n=new FormData(r.current).get("comment");if(n.trim())try{null==a.current.update||a.current.update(""),await e.addComment(n)}catch(e){null==a.current.update||a.current.update(n||""),console.error(e)}}),[e]),c=(0,m.useCallback)((t=>{e.setCurrentComment(t||"")}),[e]);(0,m.useEffect)((()=>((0,j.VS)(j.bA)||(e.setAddedCommentThisSession(!1),l()),()=>l())),[]),(0,m.useEffect)((()=>{var t;(0,j.VS)(j.bA)&&(e.tooltipMessage&&(null==(t=a.current)||null==(t=t.el)||null==(t=t.current)||t.focus({preventScroll:!0})))}),[e.tooltipMessage]),(0,m.useEffect)((()=>{e.setInputRef(a.current.el),e.setCommentFormSubmit((()=>d()))}),[a,e]);const u=e.currentComment[t.selected.id]||"";return(0,A.jsxs)(Qe.eB,{ref:r,tag:"form",name:"comment-form",mod:{inline:n},onSubmit:d,children:[(0,A.jsx)(Ty,{actionRef:a,name:"comment",placeholder:"Add a comment",value:u,rows:i,maxRows:s,onChange:o,onInput:c,onSubmit:n?d:void 0,onBlur:l}),(0,A.jsx)(Qe.Sl,{tag:"div",name:"primary-action",children:(0,A.jsx)("button",{type:"submit",children:(0,A.jsx)(To.mDt,{})})}),e.tooltipMessage&&(0,A.jsx)(Qe.Sl,{name:"tooltipMessage",children:e.tooltipMessage})]})})),Ky=(0,v.PA)((({item:e})=>{const{type:t}=null!=e?e:{};if(!t)return"No Label";if(t.includes("label"))return e.value;if(t.includes("region")||t.includes("range")){const t=e.labelings.map((e=>e.selectedLabels||[])),n=[].concat(...t);return(0,A.jsx)(Qe.eB,{name:"labels-list",children:n.map(((e,t)=>{const n=e.background||"#000000";return[t?", ":null,(0,A.jsx)(Qe.Sl,{style:{color:n},children:e.value||"No label"},e.id)]}))})}return t.includes("tool")?e.value:void 0})),Ey=({linking:e,region:t,result:n,onUnlink:o,interactive:i})=>{const s=e||t,r=(0,m.useMemo)((()=>e?{action:!0}:t?{display:!0}:void 0),[e,t]);return s?(0,A.jsxs)(Qe.eB,{tag:"div",name:"link-state",mod:r,children:[(0,A.jsx)(Qe.Sl,{tag:"div",name:"prefix",children:(0,A.jsx)(To.uUV,{})}),(null==r?void 0:r.action)&&"Select an object to link it to this comment.",(null==r?void 0:r.display)&&(0,A.jsx)(Py,{region:t,result:n,onUnlink:o,interactive:i})]}):null},Py=(0,v.PA)((({region:e,result:t,interactive:n,onUnlink:o})=>{var i;const s=null!=(i=null==e?void 0:e.background)?i:null==e||null==e.getOneColor?void 0:e.getOneColor(),r=e.classification,{mouseEnterHandler:a,mouseLeaveHandler:l,clickHandler:d}=(0,m.useMemo)((()=>{if(!n)return{};return{mouseEnterHandler:()=>{null==e||null==e.setHighlight||e.setHighlight(!0)},mouseLeaveHandler:()=>{null==e||null==e.setHighlight||e.setHighlight(!1)},clickHandler:()=>{if(e.classification)return null;e.annotation.selectArea(e)}}}),[n,e]),c=(0,m.useMemo)((()=>{const e=St()(null!=s?s:"#666").alpha(1);return{"--icon-color":e.css(),"--text-color":e.css()}}),[s]);return(0,A.jsxs)(Qe.eB,{name:"link-state-region",mod:{interactive:n},style:c,onMouseEnter:a,onMouseLeave:l,onClick:d,children:[!r&&(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"icon",children:(0,A.jsx)(cl,{node:e})}),(0,A.jsx)(Qe.Sl,{name:"index",children:e.region_index})]}),t?(0,A.jsx)(Qe.Sl,{name:"title",children:(0,A.jsx)(My,{result:t})}):(0,A.jsxs)(Qe.Sl,{name:"title",children:[(0,A.jsx)(Qe.Sl,{name:"label",children:(0,A.jsx)(Ky,{item:e})}),(null==e?void 0:e.text)&&(0,A.jsx)(Qe.Sl,{name:"text",children:e.text.replace(/\\n/g,"\n")})]}),o&&(0,A.jsx)(Qe.Sl,{name:"close",children:(0,A.jsx)(xo.A,{size:"small",type:"text",icon:(0,A.jsx)(To.gzW,{}),onClick:o})})]})})),My=(0,v.PA)((({result:e})=>{const{from_name:t,type:n,mainValue:o}=e,{name:i}=t;if("textarea"===n)return[i,o.join(" | ")].join(": ");if("choices"===n)return[i,o.join(", ")].join(": ");if("taxonomy"===n){return[i,o.map((e=>e.join("/"))).join(", ")].join(": ")}return[i,String(o)].join(": ")})),Dy=({region:e,linking:t,onLinkTo:n})=>(0,A.jsx)(Qe.eB,{name:"comment-form-buttons",children:(0,A.jsxs)(Qe.Sl,{name:"buttons",children:[n&&!e&&(0,A.jsx)(Qn.m_M,{title:"Link to...",children:(0,A.jsx)(Qe.Sl,{name:"action",tag:"button",mod:{highlight:t},onClick:n,children:(0,A.jsx)(To.uUV,{})})}),(0,A.jsx)(Qe.Sl,{name:"action",tag:"button",type:"submit",children:(0,A.jsx)(To.mDt,{})})]})}),Oy=(0,v.PA)((({commentStore:e,annotationStore:t,inline:n=!0})=>{var o;const i=(0,m.useRef)(null),s=(0,m.useRef)({}),r=()=>e.setTooltipMessage(""),a=t.selected&&t.selected.linkingMode===W,[l,d]=(0,m.useState)(),c=(0,m.useCallback)(((t=!0)=>{let n=e.commentInProgress;return!n&&t&&(n=Pg.create({text:""},{annotationStore:e.annotationStore}),e.setCurrentComment(n)),n}),[e]),u=(0,m.useCallback)((e=>{c().setText(e)}),[e,t]),h=(0,m.useCallback)((e=>{null==e||null==e.preventDefault||e.preventDefault();if(t.selected&&t.selected.linkingMode===W)return void t.selected.stopLinkingMode();const n=c();d(n),t.selected.startLinkingMode(W,n)}),[e,t]),g=(0,m.useCallback)((async t=>{if(null==t||null==t.preventDefault||t.preventDefault(),!i.current||"addComment"===e.loading)return;const n=c(!1),o=null==n?void 0:n.text,s=null==n?void 0:n.regionRef,r=null==n?void 0:n.classifications;if(o.trim()||r)try{e.setCurrentComment(void 0);const t={text:o,regionRef:s,classifications:r};await e.addComment(t)}catch(t){e.setCurrentComment(n),console.error(t)}}),[e,t]);(0,m.useEffect)((()=>((0,j.VS)(j.bA)||(e.setAddedCommentThisSession(!1),r()),()=>r())),[]),(0,m.useEffect)((()=>{var t;(0,j.VS)(j.bA)&&(e.tooltipMessage&&(null==(t=s.current)||null==(t=t.el)||null==(t=t.current)||t.focus({preventScroll:!0})))}),[e.tooltipMessage]),(0,m.useEffect)((()=>{var t;e.setInputRef(null==(t=s.current)?void 0:t.el),e.setCommentFormSubmit((()=>g()))}),[s,e]);const p=null==(o=t.selected.currentLinkingMode)?void 0:o.comment,f=c(),{text:v="",regionRef:y,classifications:b}=f||{},{region:x,result:S}=y||{},w=!!l&&p===l&&a,k=w||x,C=(0,m.useMemo)((()=>{var e;return _g(null==b||null==(e=b.default)?void 0:e.values)}),[b]),R=e.commentClassificationsItems,_=(0,m.useCallback)((e=>{c().setClassifications(e)}),[c]),T=(0,m.useCallback)((async(e,t)=>{const n=t.length>0?{default:{type:"taxonomy",values:t}}:null;_(n)}),[_]);return(0,A.jsxs)(Qe.eB,{ref:i,tag:"form",name:"comment-form-new",mod:{inline:n,linked:!!x},onSubmit:g,children:[(0,A.jsxs)(Qe.Sl,{name:"text-row",children:[(0,A.jsx)(Ty,{actionRef:s,name:"comment",placeholder:"Add a comment",value:v,rows:1,maxRows:4,onInput:u,onSubmit:n?g:void 0,onBlur:r}),0===R.length&&(0,A.jsx)(Dy,{region:x,linking:w,onLinkTo:h})]}),R.length>0&&(0,A.jsxs)(Qe.Sl,{name:"classifications-row",children:[(0,A.jsx)(Qe.Sl,{name:"category-selector",children:(0,A.jsx)(qm,{selected:C,items:R,onChange:T,options:Tg,defaultSearch:!1})}),(0,A.jsx)(Dy,{region:x,linking:w,onLinkTo:h})]}),k&&(0,A.jsx)(Qe.Sl,{name:"link-state",children:(0,A.jsx)(Ey,{linking:w,region:x,result:S,onUnlink:null==f?void 0:f.unsetLink})}),e.tooltipMessage&&(0,A.jsx)(Qe.Sl,{name:"tooltipMessage",children:e.tooltipMessage})]})})),Iy=(0,v.PA)((({value:e="",inline:t=!0,onChange:n,onSubmit:o,onBlur:i,rows:s=1,maxRows:r=4,classifications:a})=>{const l=(0,m.useRef)(null),d=(0,m.useRef)({}),c=(0,m.useCallback)((async e=>{var t;if(null==e||null==e.preventDefault||e.preventDefault(),!l.current)return;const n=null==(t=new FormData(l.current).get("comment"))?void 0:t.trim();(n||a)&&(null==o||o(n))}),[o]),u=(0,m.useCallback)((e=>{null==n||n(e||"")}),[n]);return(0,A.jsxs)(Qe.eB,{ref:l,tag:"form",name:"comment-form",mod:{inline:t},onSubmit:c,children:[(0,A.jsx)(Ty,{actionRef:d,name:"comment",placeholder:"Add a comment",value:e,rows:s,maxRows:r,onChange:n,onInput:u,onSubmit:e=>{t&&(e=e.trim())&&(null==o||o(e))},onBlur:e=>null==i?void 0:i(e)}),(0,A.jsx)(Qe.Sl,{tag:"div",name:"primary-action",children:(0,A.jsx)("button",{type:"submit",children:(0,A.jsx)(To.mDt,{})})})]})})),Ly=(0,v.PA)((({comment:{updatedAt:e,isEditMode:t,isConfirmDelete:n,createdAt:o,isPersisted:i,isDeleted:s,createdBy:r,text:a,isResolved:l,updateComment:d,deleteComment:c,setConfirmMode:u,setEditMode:h,toggleResolve:g,canResolveAny:p},listComments:f})=>{var v;const y=null==(v=window.APP_SETTINGS)?void 0:v.user,b=(null==y?void 0:y.id)===r.id,[S,w]=(0,m.useState)(a);if(s)return null;const k=()=>{const t=new Date(e),n=new Date(o);t.setMilliseconds(0),n.setMilliseconds(0);const s=t>n,r=s?e:o;return i&&r?(0,A.jsx)(Qe.Sl,{name:"date",children:(0,A.jsx)(Qn.m_M,{alignment:"top-right",title:new Date(r).toLocaleString(),children:(0,A.jsx)(A.Fragment,{children:`${s?"updated":""} ${(0,x.humanDateDiff)(r)}`})})}):null};return(0,A.jsxs)(Qe.eB,{name:"comment-item",mod:{resolved:l},children:[(0,A.jsxs)(Oo,{spread:!0,size:"medium",truncated:!0,children:[(0,A.jsxs)(Oo,{size:"small",truncated:!0,children:[(0,A.jsx)(Qe.Sl,{tag:Qn.an1,user:r,name:"userpic",showUsername:!0,username:r}),(0,A.jsx)(Qe.Sl,{name:"name",tag:"span",children:(0,x.userDisplayName)(r)})]}),(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsx)(Qe.Sl,{name:"resolved",component:To.iWP}),(0,A.jsx)(Qe.Sl,{name:"saving",mod:{hide:i},children:(0,A.jsx)(Qe.Sl,{name:"dot"})}),(0,A.jsx)(k,{})]})]}),(0,A.jsxs)(Qe.Sl,{name:"content",children:[(0,A.jsx)(Qe.Sl,{name:"text",children:t?(0,A.jsx)(Iy,{value:S,onSubmit:async e=>{await d(e),w(e),await f({suppressClearComments:!0})}}):n?(0,A.jsxs)(Qe.Sl,{name:"confirmForm",children:[(0,A.jsx)(Qe.Sl,{name:"question",children:"Are you sure?"}),(0,A.jsxs)(Qe.Sl,{name:"controls",children:[(0,A.jsx)(Po,{onClick:()=>c(),size:"compact",look:"danger",autoFocus:!0,children:"Yes"}),(0,A.jsx)(Po,{onClick:()=>u(!1),size:"compact",children:"No"})]})]}):(0,A.jsx)(A.Fragment,{children:S})}),(0,A.jsx)(Qe.Sl,{name:"actions",onClick:e=>{e.stopPropagation(),e.preventDefault()},children:i&&(b||p)&&(0,A.jsx)(Wh.Trigger,{content:(0,A.jsxs)(Yh,{size:"auto",children:[(0,A.jsx)(Yh.Item,{onClick:g,children:l?"Unresolve":"Resolve"}),b&&(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Yh.Item,{onClick:()=>{const e=!t;h(e),e||w(a)},children:t?"Cancel edit":"Edit"}),!n&&(0,A.jsx)(Yh.Item,{onClick:()=>{u(!0)},children:"Delete"})]})]}),children:(0,A.jsx)(Po,{size:"small",type:"text",icon:(0,A.jsx)(To.dbp,{})})})})]})]})})),Ny=(0,v.PA)((({commentStore:e})=>(0,A.jsx)(Qe.eB,{name:"comments-list",children:e.comments.map((t=>(0,A.jsx)(Ly,{comment:t,listComments:e.listComments},t.id)))}))),zy=(0,v.PA)((({comment:e,listComments:t,classificationsItems:n})=>{var o,i,s,r;const{classifications:a,updatedAt:l,isEditMode:d,isConfirmDelete:c,createdAt:u,isPersisted:h,isDeleted:g,createdBy:p,text:f,regionRef:v,isResolved:y,updateComment:b,deleteComment:S,setConfirmMode:w,setClassifications:k,setEditMode:C,toggleResolve:j,canResolveAny:R,isHighlighted:_,setHighlighted:T,_commentRef:K}=e,{startLinkingMode:E,currentComment:P,globalLinking:M}=(0,m.useContext)(Vy),D=null==(o=window.APP_SETTINGS)?void 0:o.user,O=(null==D?void 0:D.id)===p.id,I=null==(i=e.commentsStore)||null==(i=i.store)?void 0:i.hasInterface("annotations:hide-info"),L=I?{email:O?"Me":"User"}:null,[N,z]=(0,m.useState)(f),[V,H]=(0,m.useState)(),B=null==v?void 0:v.region,F=null==v?void 0:v.result,W=!(!V||P!==V||!M),$=W||B,U=(0,m.useCallback)((e=>{H(e),E(e)}),[E]),Y=(0,m.useCallback)((()=>{null!=v&&v.region?e.unsetLink():U(e)}),[e,U,null==v?void 0:v.region]),X=(0,m.useCallback)((async(e,t)=>{const n=t.length>0?{default:{type:"taxonomy",values:t}}:null;k(n)}),[k]),G=(0,m.useMemo)((()=>{var e;return _g(null==a||null==(e=a.default)?void 0:e.values)}),[a]),Z=(0,m.useCallback)((async e=>{await b(e,a),z(e),await t({suppressClearComments:!0})}),[b,t,a]);if(g)return null;const q=()=>{const e=new Date(l),t=new Date(u);e.setMilliseconds(0),t.setMilliseconds(0);const n=e>t,o=n?l:u;return h&&o?(0,A.jsx)(Qe.Sl,{name:"date",children:(0,A.jsx)(Qn.m_M,{alignment:"top-right",title:new Date(o).toLocaleString(),children:(0,A.jsx)(A.Fragment,{children:`${n?"updated":""} ${(0,x.humanDateDiff)(o)}`})})}):null};return(0,A.jsxs)(Qe.eB,{name:"comment-item",mod:{resolved:y,highlighted:_},onMouseEnter:()=>{T(!0)},onMouseLeave:()=>{T(!1)},ref:K,children:[(0,A.jsxs)(Oo,{spread:!0,size:"medium",truncated:!0,children:[(0,A.jsxs)(Oo,{size:"small",truncated:!0,children:[(0,A.jsx)(Qe.Sl,{tag:Qn.an1,user:null!=L?L:p,name:"userpic",showUsername:!0,username:p}),(0,A.jsx)(Qe.Sl,{name:"name",tag:"span",children:(0,x.userDisplayName)(null!=L?L:p)})]}),(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsx)(Qe.Sl,{name:"resolved",component:To.iWP}),(0,A.jsx)(Qe.Sl,{name:"saving",mod:{hide:h},children:(0,A.jsx)(Qe.Sl,{name:"dot"})}),!I&&(0,A.jsx)(q,{})]})]}),(0,A.jsxs)(Qe.Sl,{name:"content",children:[(0,A.jsx)(Qe.Sl,{name:"text",children:d?(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Iy,{value:N,onSubmit:Z,classifications:a}),n.length>0&&(0,A.jsx)(Qe.Sl,{name:"classifications-row",children:(0,A.jsx)(qm,{selected:G,items:n,onChange:X,options:Tg,defaultSearch:!1})})]}):c?(0,A.jsxs)(Qe.Sl,{name:"confirmForm",children:[(0,A.jsx)(Qe.Sl,{name:"question",children:"Are you sure?"}),(0,A.jsxs)(Qe.Sl,{name:"controls",children:[(0,A.jsx)(Po,{onClick:()=>S(),size:"compact",look:"danger",autoFocus:!0,children:"Yes"}),(0,A.jsx)(Po,{onClick:()=>w(!1),size:"compact",children:"No"})]})]}):(0,A.jsxs)(A.Fragment,{children:[(null==a||null==(s=a.default)||null==(s=s.values)?void 0:s.length)>0&&(0,A.jsx)(Qe.Sl,{name:"classifications",tag:"ul",children:null==a||null==(r=a.default)||null==(r=r.values)?void 0:r.map(((e,t)=>(0,A.jsx)("li",{children:e.join("/")},t)))}),N,$&&(0,A.jsx)(Qe.Sl,{name:"linkState",children:(0,A.jsx)(Ey,{linking:W,region:B,result:F,interactive:!0})})]})}),(0,A.jsx)(Qe.Sl,{name:"actions",onClick:e=>{e.stopPropagation(),e.preventDefault()},children:h&&(O||R)&&(0,A.jsx)(Wh.Trigger,{content:(0,A.jsxs)(Yh,{size:"auto",children:[(0,A.jsx)(Yh.Item,{onClick:j,children:y?"Unresolve":"Resolve"}),O&&(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Yh.Item,{onClick:()=>{const e=!d;C(e),e||z(f)},children:d?"Cancel edit":"Edit"}),(0,A.jsx)(Yh.Item,{onClick:Y,children:null!=v&&v.region?"Unlink":"Link to..."}),!c&&(0,A.jsx)(Yh.Item,{onClick:()=>{w(!0)},children:"Delete"})]})]}),children:(0,A.jsx)(Po,{size:"small",type:"text",icon:(0,A.jsx)(To.dbp,{width:20,height:20})})})})]})]})})),Vy=(0,m.createContext)({startLinkingMode:()=>{},globalLinking:!1,currentComment:null}),Hy=(0,v.PA)((({commentStore:e})=>{var t,n;const o=(0,m.useCallback)((t=>{e.annotation.startLinkingMode(W,t)}),[e]),i=(null==(t=e.annotation)?void 0:t.linkingMode)===W,s=null==(n=e.annotation.currentLinkingMode)?void 0:n.comment,r=(0,m.useMemo)((()=>({startLinkingMode:o,currentComment:s,globalLinking:i})),[o,s,i]);return(0,A.jsx)(Vy.Provider,{value:r,children:(0,A.jsx)(By,{commentStore:e})})})),By=(0,v.PA)((({commentStore:e})=>(0,A.jsx)(Qe.eB,{name:"comments-list",children:e.comments.map((t=>(0,A.jsx)(zy,{comment:t,listComments:e.listComments,classificationsItems:e.commentClassificationsItems},t.id)))}))),Fy=(0,j.VS)(j.v1),Wy=Fy?Oy:Ay,$y=Fy?Hy:Ny,Uy=(0,v.PA)((({annotationStore:e,commentStore:t,cacheKey:n})=>{const o=N();return(0,m.useEffect)((()=>{(async()=>{const e={mounted:o};Fy&&(e.suppressClearComments=t.isRelevantList),await t.listComments(e),(0,j.VS)(j.K3)||t.restoreCommentsFromCache(n)})()}),[t.annotation.id]),(0,m.useEffect)((()=>{const e=e=>(t.hasUnsaved&&(e.returnValue="You have unpersisted comments which will be lost if continuing."),e);return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}}),[t.hasUnsaved]),(0,A.jsxs)(Qe.eB,{name:"comments",children:[(0,A.jsx)(Wy,{commentStore:t,annotationStore:e,inline:!0}),(0,A.jsx)($y,{commentStore:t})]})})),Yy=(0,v.WQ)((({store:e})=>{var t;const n=e.annotationStore,o=null==n?void 0:n.selected;return{annotationStore:n,selected:null==n?void 0:n.selected,createdBy:null!=(t=null==o?void 0:o.user)?t:{email:null==o?void 0:o.createdBy},createdDate:null==o?void 0:o.createdDate,history:null==n?void 0:n.history,selectedHistory:null==n?void 0:n.selectedHistory}})),Xy=(0,v.PA)((({annotation:e,inline:t,isSelected:n})=>{var o;const i=e.history.hasChanges,s=e.list,r=s.store.hasInterface("annotations:hide-info"),a=r?{email:"Me"}:null,[l,d]=(0,m.useState)(!1);return(0,m.useEffect)((()=>{d(!0)}),[e.history.history.length]),(0,m.useEffect)((()=>{d(!1)}),[e.draftSaved]),i||e.versions.draft?(0,A.jsx)(qy,{user:null!=(o=null!=a?a:e.user)?o:{email:e.createdBy},date:e.draftSaved,extra:e.isDraftSaving?(0,A.jsx)(Qe.Sl,{name:"saving",children:(0,A.jsx)(Qe.Sl,{name:"spin"})}):l?(0,A.jsx)(Qe.Sl,{name:"saving",children:(0,A.jsx)(Qe.Sl,{name:"dot"})}):i?(0,A.jsx)(Qe.Sl,{name:"saving",children:(0,A.jsx)(Qe.Sl,{name:"saved",component:To.iWP})}):null,inline:t,comment:"",acceptedState:"draft_created",selected:n,hideInfo:r,onClick:()=>{s.selectHistory(null),e.toggleDraft(!0)}},"draft"):null})),Gy=({reason:e,comment:t})=>{const[n,o]=(0,m.useState)(!1),[i,s]=(0,m.useState)(!1),r=(0,m.useRef)();return(0,m.useLayoutEffect)((()=>{if(r.current){const{clientHeight:e}=r.current,t=e>66;s(t),o(t)}}),[]),(0,A.jsxs)(Qe.Sl,{name:"comment",ref:r,mod:{collapsed:n},children:[(0,A.jsx)(Qe.Sl,{name:"comment-content","data-reason":`${e}${t?": ":""}`,children:t}),i&&(0,A.jsx)(Qe.Sl,{name:"collapse-comment",mod:{collapsed:n},onClick:e=>{e.stopPropagation(),o((e=>!e))},children:n?"Show more":"Show less"})]})},Zy=({type:e})=>{const t=(0,m.useMemo)((()=>{switch(e){case"submitted":case"updated":return(0,A.jsx)(To.eBz,{style:{color:"#617ADA"}});case"draft_created":return(0,A.jsx)(To.lgA,{style:{color:"#617ADA"}});case"accepted":return(0,A.jsx)(To.eYs,{style:{color:"#2AA000"}});case"rejected":return(0,A.jsx)(To.RVl,{style:{color:"#dd0000"}});case"fixed_and_accepted":return(0,A.jsx)(To.eYs,{style:{color:"#FA8C16"}});case"prediction":return(0,A.jsx)(To.Ufx,{style:{color:"#944BFF"}});case"imported":return(0,A.jsx)(To.L$Q,{style:{color:"#2AA000"}});case"skipped":return(0,A.jsx)(To.rU4,{style:{color:"#dd0000"}});case"deleted_review":return(0,A.jsx)(To.r6U,{style:{color:"#dd0000"}});case"propagated_annotation":return(0,A.jsx)(To.kLp,{style:{color:"#2AA000"}});default:return null}}),[e]);return t&&(0,A.jsx)(Qe.Sl,{name:"history-icon",children:t})},qy=(0,v.PA)((({entity:e,user:t,date:n,extra:o,comment:i,acceptedState:s,selected:r=!1,disabled:a=!1,inline:l=!1,hideInfo:d,onClick:c})=>{const u="prediction"===(null==e?void 0:e.type),h=(0,m.useMemo)((()=>{switch(s){case"accepted":return"Accepted";case"rejected":return"Rejected";case"fixed_and_accepted":return"Fixed";case"updated":return"Updated";case"submitted":return"Submitted";case"prediction":return"From prediction";case"imported":return"Imported";case"skipped":return"Skipped";case"draft_created":return"Draft";case"deleted_review":return"Review deleted";case"propagated_annotation":return"Propagated";default:return null}}),[]),g=(0,m.useCallback)((e=>{a||c(e)}),[c,a]);return(0,A.jsxs)(Qe.eB,{name:"history-item",mod:{inline:l,selected:r,disabled:a},onClick:g,children:[(0,A.jsxs)(Oo,{spread:!0,size:"medium",truncated:!0,children:[(0,A.jsxs)(Oo,{size:"small",truncated:!0,children:[(0,A.jsx)(Qe.Sl,{tag:Qn.an1,user:t,name:"userpic",showUsername:!0,username:u?e.createdBy:null,mod:{prediction:u},children:u&&(0,A.jsx)(To.ccx,{style:{width:16,height:16}})}),(0,A.jsx)(Qe.Sl,{name:"name",tag:"span",children:u?e.createdBy:(0,x.userDisplayName)(t)})]}),!d&&(0,A.jsxs)(Oo,{size:"small",children:[o&&(0,A.jsx)(Qe.Sl,{name:"date",children:o}),n&&(0,A.jsx)(Qe.Sl,{name:"date",children:(0,A.jsx)(Qn.m_M,{alignment:"top-right",title:new Date(n).toLocaleString(),children:(0,A.jsx)(A.Fragment,{children:(0,x.humanDateDiff)(n)})})})]})]}),(h||i)&&(0,A.jsxs)(Qe.Sl,{name:"action",tag:Oo,size:"small",children:[s&&(0,A.jsx)(Zy,{type:s}),(0,A.jsx)(Gy,{comment:i,reason:h})]})]})}));qy.displayName="HistoryItem";const Jy=Yy((0,v.PA)((({annotationStore:e,selectedHistory:t,history:n,enabled:o=!0,inline:i=!1})=>{var s;const r=e.selected,a=null!=n&&n.length?n[0]:null,l=r.history.hasChanges,d=e.store.hasInterface("annotations:hide-info"),u=null==(s=window.APP_SETTINGS)?void 0:s.user,h=!e.selectedHistory&&(r.draftSelected||!r.versions.draft&&l);return(0,A.jsxs)(Qe.eB,{name:"annotation-history",mod:{inline:i},children:[(0,A.jsx)(Xy,{annotation:r,isSelected:h,inline:i}),o&&n.length>0&&n.map((n=>{var o;const{id:s,user:g,createdDate:m}=n,p=(null==a?void 0:a.id)===n.id,f=p&&!t?!h:(null==t?void 0:t.id)===n.id,v=d?{email:(null==u?void 0:u.id)===g.id?"Me":"User"}:null;return(0,A.jsx)(qy,{inline:i,user:null!=(o=null!=v?v:g)?o:{email:null==n?void 0:n.createdBy},date:m,comment:n.comment,acceptedState:n.actionType,selected:f,disabled:0===n.results.length,hideInfo:d,onClick:async()=>{l&&(r.saveDraftImmediately(),await(0,c.z7)((()=>!r.isDraftSaving))),p||f?(e.selectHistory(null),r.toggleDraft(f)):e.selectHistory(n)}},s)}))]})})));Jy.displayName="AnnotationHistory";const Qy=(e,t=[])=>{(0,m.useEffect)((()=>{const t={capture:e.capture,passive:e.passive},n=e.elementRef.current,o=n=>{if(e.disabled)return;if(n.defaultPrevented)return;const o=null==e.onMouseDown?void 0:e.onMouseDown(n),i=t=>{null==e.onMouseMove||e.onMouseMove(t,o)},s=n=>{document.removeEventListener("mousemove",i,t),document.removeEventListener("mouseup",s),null==e.onMouseUp||e.onMouseUp(n,o)};document.addEventListener("mousemove",i,t),document.addEventListener("mouseup",s)};return null==n||n.addEventListener("mousedown",o),()=>{null==e.onUnmount||e.onUnmount(),null==n||n.removeEventListener("mousedown",o)}}),t)},eb=320,tb=300,nb=500,ob=24,ib=["top-left","top-right","bottom-left","bottom-right","top","bottom","right","left"],sb=({name:e,mix:t,root:n,title:o,width:i,maxWidth:s,height:r,visible:a,detached:l,alignment:d,expanded:c,top:u,left:h,relativeTop:g,relativeLeft:p,zIndex:f,tooltip:v,locked:y=!1,positioning:b=!1,onSnap:S,onResize:w,onResizeStart:k,onResizeEnd:C,onVisibilityChange:j,onPositionChange:R,onPositionChangeBegin:_,children:T})=>{const K=(0,m.useRef)(),E=(0,m.useRef)(),P=(0,m.useRef)(),M=(0,m.useRef)({onResize:w,onResizeStart:k,onResizeEnd:C,onPositionChange:R,onPositionChangeBegin:_,onVisibilityChange:j,onSnap:S}),[D,O]=(0,m.useState)(),I=(0,m.useCallback)((t=>{t.stopPropagation(),t.preventDefault(),null==j||j(e,!1)}),[j]),L=(0,m.useCallback)((()=>{null==j||j(e,!0)}),[j]),N=(0,m.useMemo)((()=>{const e=a?{height:l&&null!=r?r:"100%",width:c?"100%":null!=i?i:eb}:{width:l?null!=i?i:eb:"100%",height:l?26:void 0};return Object.assign({},e,{zIndex:f})}),[i,r,a,l,c,f]),z=(0,m.useMemo)((()=>l&&!y?{top:`${g}%`,left:`${p}%`}:{}),[l,g,p,y]),V=(0,m.useMemo)((()=>({detached:!y&&l,resizing:(0,x.isDefined)(D),hidden:!a,alignment:l?"left":null!=d?d:"left",disabled:y})),[d,a,l,D,y]),H=(0,m.useMemo)((()=>l?a?(0,A.jsx)(To.$Mr,{}):(0,A.jsx)(To.yIE,{}):"left"===d?a?(0,A.jsx)(To.Gk,{}):(0,A.jsx)(To.hIg,{}):"right"===d?a?(0,A.jsx)(To.hIg,{}):(0,A.jsx)(To.Gk,{}):null),[l,a,d]),B=(0,m.useMemo)((()=>`${a?"Collapse":"Expand"} ${v}`),[a,v]);return(0,m.useEffect)((()=>{Object.assign(M.current,{onResize:w,onResizeStart:k,onResizeEnd:C,onPositionChangeBegin:_,onPositionChange:R,onVisibilityChange:j,onSnap:S})}),[w,k,C,R,j,_,S]),Qy({elementRef:K,disabled:y||!l&&!a,onMouseDown(t){const o=t.target,i="[class*=__toggle]";if(o.matches(i)||o.closest(i))return;const s=l,r=E.current,a=n.current.getBoundingClientRect(),d=r.getBoundingClientRect(),[c,g]=[t.pageX,t.pageY],[m,p]=[d.left-a.left,d.top-a.top];return null==M.current.onPositionChangeBegin||M.current.onPositionChangeBegin(e,u,h,l),{x:c,y:g,oX:m,oY:p,allowDrag:s}},onMouseMove(t,n){if(n){const{x:a,y:l,oX:d,oY:c}=n;let{allowDrag:u}=n;const[h,g]=[t.pageX,t.pageY];if((o=a,i=h,s=l,r=g,Math.sqrt((i-o)**2+(r-s)**2))>30&&(u=!0),!u)return;const[m,p]=[d+(h-a),c+(g-l)];null==M.current.onPositionChange||M.current.onPositionChange(e,p,m,!0)}var o,i,s,r},onMouseUp(){null==M.current.onSnap||M.current.onSnap(e)}},[K,l,a,y]),Qy({elementRef:P,disabled:y||b,capture:!0,passive:!0,onMouseDown(e){const t=e.target.dataset.resize,n=(()=>{switch(t){case"top-left":return"top-left";case"top":case"top-right":return"top";case"left":case"bottom-left":return"left"}})(),o={x:null!==(null==t?void 0:t.match(/left|right/i)),y:null!==(null==t?void 0:t.match(/top|bottom/i))};return O(t),null==M.current.onResizeStart||M.current.onResizeStart(),{pos:[e.pageX,e.pageY],type:t,width:i,maxWidth:s,height:r,top:u,left:h,resizeDirections:o,shift:n}},onMouseMove(t,n){if(n){const{pos:o,width:i,height:s,maxWidth:r,top:a,left:l,resizeDirections:d,shift:c}=n,[u,h]=o,g=d.x?t.pageX-u:0,m=d.y?t.pageY-h:0,p=(0,x.isDefined)(c)&&["left","top-left"].includes(c),f=(0,x.isDefined)(c)&&["top","top-left"].includes(c),v=(0,x.clamp)(p?i-g:i+g,eb,r),y=(0,x.clamp)(f?s-m:s+m,tb,a+s),b=f?a+(s-y):a,S=p?l+(i-v):l;M.current.onResize(e,v,y,b,S)}},onMouseUp(){null==M.current.onResizeEnd||M.current.onResizeEnd(),O(void 0)}},[M,l,i,s,r,u,h,a,y,b]),(0,A.jsxs)(Qe.eB,{ref:E,name:"panel",mix:e,mod:V,style:Object.assign({},N,z),children:[(0,A.jsxs)(Qe.Sl,{name:"content",children:[!y&&(0,A.jsxs)(Qe.Sl,{ref:K,name:"header",onClick:l?void 0:L,children:[(a||l)&&(0,A.jsx)(Qe.Sl,{name:"title",children:o}),(0,A.jsx)(Qe.Sl,{name:"toggle",mod:{enabled:a},onClick:l&&!a?L:I,"data-tooltip":B,children:H})]}),a&&(0,A.jsx)(Qe.Sl,{name:"body",children:(0,A.jsx)(Qe.eB,{name:e,mix:t,children:T})})]}),a&&!b&&!y&&(0,A.jsx)(Qe.Sl,{name:"resizers",ref:P,mod:{locked:b||y},children:ib.map((e=>("left"===e||"right"===e)&&d!==e||l||l?(0,A.jsx)(Qe.Sl,{name:"resizer",mod:{drag:e===D},"data-resize":e},e):null))})]})},rb={container:"container--d7fgb",labelText:"labelText--ZGgO7",input:"input--HLuCD"},ab=["label","value","onChange","region","min","max"],lb=(0,v.PA)((({region:e})=>{const{start:t,end:n}=e.ranges[0],o=e.object.length;return(0,A.jsxs)("div",{className:rb.container,children:[(0,A.jsx)(db,{label:"Start frame",value:t,onChange:t=>{+t!==e.ranges[0].start&&e.setRange([+t,e.ranges[0].end])},region:e,min:1,max:n}),(0,A.jsx)(db,{label:"End frame",value:n,onChange:t=>{+t!==e.ranges[0].end&&e.setRange([e.ranges[0].start,+t])},region:e,min:t,max:o}),(0,A.jsx)(db,{label:"Duration",value:n-t+1,region:e})]})})),db=e=>{let{label:t,value:n,onChange:o,min:i,max:s}=e,r=(0,Zn.A)(e,ab);const a=!o,l=e=>{let t=+e.target.value;i&&t<+i&&(e.target.value=i,t=+i),s&&t>+s&&(e.target.value=s,t=+s),null==o||o(t)};return(0,A.jsxs)("label",{className:rb.label,children:[(0,A.jsx)("span",{className:rb.labelText,children:t}),(0,A.jsx)("input",Object.assign({className:rb.input,type:"number",step:1,readOnly:a,onBlur:l,onClick:l,onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()},[a?"value":"defaultValue"]:n,min:i,max:s},r),n)]})},cb=["onChange","type","value","step"],ub=e=>{const t=(e=>{if((0,u.fn)(e)){const t=e.getSubTypes();return(0,u.Cb)(t)?t.name:null}return(0,u.Cb)(e)?e.name:null})(e);return"number"===t?"number":"text"},hb={angle:To.oDh},gb=({region:e})=>{var t;const n=null!=(t=e.editableFields)?t:[];return(0,A.jsx)(Qe.Sl,{name:"wrapper",children:e.editorEnabled&&n.map(((t,n)=>(0,A.jsx)(pb,{property:t.property,label:t.label,region:e},`${t.property}-${n}`)))})},mb=({region:e})=>{var t;return(0,A.jsx)(Qe.Sl,{name:"wrapper-time-control",children:(0,A.jsx)(Jo,{startTime:e.start,endTime:e.end,minTime:0,maxTime:null==e||null==(t=e._ws_region)?void 0:t.duration,isSidepanel:!0,onChangeStartTime:t=>{e.setProperty("start",t)},onChangeEndTime:t=>{e.setProperty("end",t)},showLabels:!0,showDuration:!0})})},pb=({property:e,label:t,region:n})=>{const o=(0,Qe.KE)(),[i,s]=(0,m.useState)(n.getProperty(e)),r=(0,m.useMemo)((()=>n.getPropertyType(e)),[n,e]),a=(0,m.useMemo)((()=>(0,u.Cb)(r)),[r]),l=(0,m.useMemo)((()=>{if(a)return null;let e=null;if((0,u.CK)(r)){const t=(0,u.fn)(r)?r.getSubTypes().getSubTypes():r.getSubTypes();e=t.some((e=>(0,u.aw)(e)||(0,u.Cb)(e)))?t.map((e=>e.value)):null}return e}),[r,a]),d=(0,m.useMemo)((()=>{if(!a)return!1;return((0,u.fn)(r)?r.getSubTypes():r)===u.gK.boolean}),[r,a]),h=(0,m.useCallback)((t=>{if(t!==n.getProperty(e))try{n.setProperty(e,t)}catch(e){console.error(e)}}),[r,d]);return(0,m.useEffect)((()=>{const t=(0,c.lB)(n,e,(({newValue:e,oldValue:t})=>{t.storedValue!==e.storedValue&&s(e.storedValue)}));return()=>t()}),[n]),(0,A.jsxs)(Qe.Sl,{name:"property",tag:"label",children:[d?(0,A.jsx)(Qn.Sc0,{className:null==o?void 0:o.elem("input").toClassName(),checked:i,onChange:e=>h(e.target.checked)}):a?(0,A.jsx)(fb,{type:ub(r),step:"0.01",value:i,onChange:e=>h(Number(e))}):l?(0,A.jsx)(Qn.l6P,{value:i,onChange:e=>h(e),className:null==o?void 0:o.elem("select").toClassName(),options:l}):null,(0,A.jsx)(vb,{label:t})]})},fb=e=>{let{onChange:t,type:n,value:o,step:i}=e,s=(0,Zn.A)(e,cb);const r=(0,Qe.KE)(),[a,l]=(0,m.useState)(o),d=(0,m.useCallback)(((e,n=!0)=>{const o=e;l(o),n&&(null==t||t(o))}),[t,n]),c=(0,m.useCallback)((e=>{let t=e.target.value,o=!0;"number"===n&&(t.match(/^([0-9,.]+)$/gi)||(o=!1),t.match(/(,|\.)$/)&&(t=t.replace(/,/,"."),o=!1),o&&(t=Number.parseFloat(t))),d(t,o)}),[d,n]),u=(0,m.useCallback)((e=>{if("number"===n&&("ArrowUp"===e.key||"ArrowDown"===e.key)){e.preventDefault();const t=e.altKey&&e.shiftKey?.01:e.shiftKey?10:e.altKey?.1:1;let n=Number(a);"ArrowUp"===e.key?n+=t:n-=t,d(n)}}),[a,n,i]);return(0,m.useEffect)((()=>{d(o)}),[o]),(0,A.jsx)("input",Object.assign({},s,{className:null==r?void 0:r.elem("input").toClassName(),type:"text",step:i,onChange:c,onKeyDown:u,value:a}))},vb=({label:e})=>{const t=(0,m.useMemo)((()=>{if(e.startsWith("icon:")){var t;const n=e.split(":")[1];return null!=(t=hb[n])?t:null}return null}),[e]);return(0,A.jsx)(Qe.Sl,{name:"text",tag:"span",children:t?(0,A.jsx)(t,{}):e})},yb=(0,v.PA)((({region:e})=>{const t=(0,j.VS)(j.vS)&&"audioregion"===e.type,n="timelineregion"===e.type?lb:t?mb:gb;return(0,A.jsx)(Qe.eB,{name:"region-editor",mod:{disabled:e.isReadOnly()},children:(0,A.jsx)(n,{region:e})})})),{Text:bb}=rc.A,xb=(0,v.PA)((({mainValue:e})=>(0,A.jsx)(bb,{mark:!0,children:e.map(((e,t)=>(0,A.jsx)("p",{"data-counter":t+1,children:e},`${e}-${t}`)))}))),Sb=(0,v.PA)((({mainValue:e})=>(0,A.jsx)(bb,{mark:!0,children:e.join(", ")}))),wb=(0,v.PA)((({mainValue:e})=>(0,A.jsx)("span",{children:e}))),kb=(0,v.PA)((({result:e})=>{const{type:t,mainValue:n}=e,o=(0,m.useMemo)((()=>"rating"===t?(0,A.jsxs)(Qe.Sl,{name:"result",children:[(0,A.jsx)(bb,{children:"Rating: "}),(0,A.jsx)(Qe.Sl,{name:"value",children:(0,A.jsx)(wb,{mainValue:n})})]}):"textarea"===t?(0,A.jsxs)(Qe.Sl,{name:"result",children:[(0,A.jsx)(bb,{children:"Text: "}),(0,A.jsx)(Qe.Sl,{name:"value",children:(0,A.jsx)(xb,{mainValue:n})})]}):"choices"===t?(0,A.jsxs)(Qe.Sl,{name:"result",children:[(0,A.jsx)(bb,{children:"Choices: "}),(0,A.jsx)(Qe.Sl,{name:"value",children:(0,A.jsx)(Sb,{mainValue:n})})]}):"taxonomy"===t?(0,A.jsxs)(Qe.Sl,{name:"result",children:[(0,A.jsx)(bb,{children:"Taxonomy: "}),(0,A.jsx)(Qe.Sl,{name:"value",children:(0,A.jsx)(Sb,{mainValue:n.map((e=>e.join("/")))})})]}):void 0),[t,n]);return o?(0,A.jsx)(Qe.eB,{name:"region-meta",children:o}):null})),Cb=(0,v.PA)((({region:e})=>(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(Qe.Sl,{name:"result",children:[(null==e?void 0:e.results).map((e=>(0,A.jsx)(kb,{result:e},e.pid))),null!=e&&e.text?(0,A.jsx)(Qe.eB,{name:"region-meta",children:(0,A.jsx)(Qe.Sl,{name:"item",children:(0,A.jsx)(Qe.Sl,{name:"content",mod:{type:"text"},children:e.text.replace(/\\n/g,"\n")})})}):null]}),(0,A.jsx)(yb,{region:e})]}))),jb=(0,v.PA)((({region:e,editMode:t,cancelEditMode:n,enterEditMode:o})=>{var i,s;const r=(0,Qe.KE)(),a=(0,m.useRef)(),l=t=>{e.setMetaText(t)};return(0,m.useEffect)((()=>{if(t&&a.current){const{current:e}=a;e.focus(),e.setSelectionRange(e.value.length,e.value.length)}}),[t]),(0,A.jsx)(A.Fragment,{children:t?(0,A.jsx)("textarea",{ref:e=>a.current=e,placeholder:"Meta",className:r.elem("meta-text").toClassName(),value:e.meta.text,onChange:e=>l(e.target.value),onBlur:e=>{l(e.target.value),null==n||n()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),l(e.target.value),null==n||n())}}):(null==(i=e.meta)?void 0:i.text)&&(0,A.jsx)(Qe.Sl,{name:"meta-text",onClick:()=>null==o?void 0:o(),children:null==(s=e.meta)?void 0:s.text})})})),Rb=["children","onClick"],_b=e=>{var t;let{children:n,onClick:o}=e,i=(0,Zn.A)(e,Rb);return(0,A.jsx)(Po,Object.assign({},i,{onClick:e=>{e.stopPropagation(),null==o||o(e)},type:"text",style:Object.assign({padding:0,width:24,height:24},null!=(t=i.style)?t:{}),children:n}))},Tb=(0,v.PA)((({item:e,annotation:t,hovered:n,locked:o,hotkey:i,look:s,style:r,onClick:a})=>{if(!e)return null;const l=o||e.isReadOnly()||t.isReadOnly(),d=e.isReadOnly()&&!o;if((0,j.VS)(j.bA)){const t=Object.assign({},r,{display:e.isReadOnly()||o?void 0:"none"});return(0,A.jsx)(_b,{disabled:d,onClick:a,hotkey:i,look:s,style:t,children:l?(0,A.jsx)(To.xIO,{}):(0,A.jsx)(To.O7E,{})})}return e&&(n||e.isReadOnly()||o)&&(0,A.jsx)(_b,{disabled:d,onClick:a,hotkey:i,look:s,style:r,children:l?(0,A.jsx)(To.xIO,{}):(0,A.jsx)(To.O7E,{})})})),Ab=(0,v.PA)((({region:e})=>{const t=e.labelings.map((e=>e.selectedLabels||[])),n=[].concat(...t);return n.length?(0,A.jsx)(Qe.eB,{name:"labels-list",children:n.map(((e,t)=>{const n=e.background||"#000000";return[t?", ":null,(0,A.jsx)("span",{style:{color:n},children:e.value},e.id)]}))}):(0,A.jsx)(Qe.eB,{name:"labels-list",children:"No label"})})),Kb=["children"],Eb=(0,v.PA)((({region:e,compact:t=!1,withActions:n=!0,withIds:o=!0,mainDetails:i,metaDetails:s})=>{var r,a;const{annotation:l}=e,{selectedRegions:d}=l,[c,u]=(0,m.useState)(!1),h=(0,m.useMemo)((()=>!!d.find((e=>!e.isReadOnly()&&!e.classification))),[d]),g=(0,m.useMemo)((()=>{var t,n;const o=null!=(t=null!=(n=e.background)?n:e.getOneColor())?t:"#666";return St()(o).alpha(1)}),[e.background,e.style]);return(0,A.jsxs)(Qe.eB,{name:"detailed-region",mod:{compact:t},children:[(0,A.jsxs)(Qe.Sl,{name:"head",style:{color:g.css()},children:[(0,A.jsxs)(Qe.Sl,{name:"title",children:[(0,A.jsx)(Qe.Sl,{name:"icon",children:(0,A.jsx)(cl,{node:e})}),(0,A.jsx)(Qe.Sl,{name:"index",children:(0,A.jsx)(Qe.Sl,{tag:"span",name:"index_value",children:e.region_index})}),(0,A.jsx)(Ab,{region:e})]}),o&&(0,A.jsx)("span",{children:e.cleanId})]}),i&&(0,A.jsx)(Qe.Sl,{name:"content",children:(0,A.jsx)(i,{region:e})}),e.isDrawing&&(0,A.jsxs)(Qe.Sl,{name:"warning",children:[(0,A.jsx)(To.iQw,{}),(0,A.jsxs)(Qe.Sl,{name:"warning-text",children:["Incomplete ",null!=(r=null==(a=e.type)?void 0:a.replace("region",""))?r:"region"]})]}),n&&(0,A.jsx)(Pb,{region:e,editMode:c,annotation:l,hasEditableRegions:h,onEditModeChange:u}),s&&(0,A.jsx)(Qe.Sl,{name:"content",children:(0,A.jsx)(s,{region:e,editMode:c,enterEditMode:()=>u(!0),cancelEditMode:()=>u(!1)})})]})})),Pb=(0,v.PA)((({region:e,annotation:t,editMode:n,onEditModeChange:o})=>{const i=[];return i.push((0,A.jsx)(Mb,{icon:(0,A.jsx)(To.ioK,{}),primary:t.isLinkingMode,onClick:(n,o)=>{o||(t.isLinkingMode?t.stopLinkingMode():t.startLinkingMode(F,e))},hotkey:"region:relation","aria-label":"Create Relation"},"relation")),i.push((0,A.jsx)(Mb,{icon:(0,A.jsx)(To.uID,{}),primary:n,onClick:()=>o(!n),hotkey:"region:meta","aria-label":"Edit region's meta"},"meta")),(0,A.jsxs)(Qe.eB,{name:"region-actions",children:[(0,A.jsx)(Qe.Sl,{name:"group",mod:{align:"left"},children:!e.isReadOnly()&&i}),(0,A.jsxs)(Qe.Sl,{name:"group",mod:{align:"right"},children:[(0,A.jsx)(Tb,{item:e,annotation:null==e?void 0:e.annotation,hovered:!0,locked:null==e?void 0:e.locked,onClick:()=>e.setLocked(!e.locked),hotkey:"region:lock",look:"alt",style:{width:36,height:32}}),(0,A.jsx)(Mb,{icon:e.hidden?(0,A.jsx)(To.r9M,{}):(0,A.jsx)(To.C_F,{}),onClick:e.toggleHidden,displayedHotkey:"region:visibility","aria-label":(e.hidden?"Show":"Hide")+" selected region"}),(0,A.jsx)(Mb,{danger:!0,disabled:e.isReadOnly(),icon:(0,A.jsx)(To.Eau,{}),onClick:()=>t.deleteRegion(e),displayedHotkey:"region:delete","aria-label":"Delete selected region"})]})]})})),Mb=e=>{let{children:t}=e,n=(0,Zn.A)(e,Kb);return(0,A.jsx)(Po,Object.assign({},n,{look:"alt",style:{padding:0},children:t}))},Db=(0,v.PA)((({relations:e})=>(0,A.jsx)(A.Fragment,{children:e.map(((e,t)=>(0,A.jsx)(Ob,{relation:e},t)))}))),Ob=(0,v.PA)((({relation:e})=>{const[t,n]=(0,m.useState)(!1),o=(0,m.useCallback)((()=>{e.node1&&e.node2&&(n(!0),e.toggleHighlight(),e.setSelfHighlight(!0))}),[]),i=(0,m.useCallback)((()=>{e.node1&&e.node2&&(n(!1),e.toggleHighlight(),e.setSelfHighlight(!1))}),[]),s=(0,m.useMemo)((()=>{const{direction:t}=e;switch(t){case"left":return(0,A.jsx)(To.pyZ,{"data-direction":e.direction});case"right":return(0,A.jsx)(To.WVI,{"data-direction":e.direction});case"bi":return(0,A.jsx)(To.dOr,{"data-direction":e.direction});default:return null}}),[e.direction]);return(0,A.jsxs)(Qe.Sl,{name:"item",mod:{hidden:!e.visible},onMouseEnter:o,onMouseLeave:i,children:[(0,A.jsxs)(Qe.Sl,{name:"content",children:[(0,A.jsx)(Qe.Sl,{name:"icon",onClick:e.rotateDirection,children:(0,A.jsx)(Qe.Sl,{name:"direction",children:s})}),(0,A.jsxs)(Qe.Sl,{name:"nodes",children:[(0,A.jsx)(Eb,{compact:!0,withActions:!1,withIds:!1,region:e.node1}),(0,A.jsx)(Eb,{compact:!0,withActions:!1,withIds:!1,region:e.node2})]}),(0,A.jsxs)(Qe.Sl,{name:"actions",children:[(0,A.jsx)(Qe.Sl,{name:"action",children:(t||e.showMeta)&&e.hasRelations&&(0,A.jsx)(Po,{primary:e.showMeta,"aria-label":(e.showMeta?"Hide":"Show")+" Relation Labels",type:e.showMeta?void 0:"text",onClick:e.toggleMeta,style:{padding:0},children:(0,A.jsx)(To.dd8,{})})}),(0,A.jsx)(Qe.Sl,{name:"action",children:(t||!e.visible)&&(0,A.jsx)(Po,{type:"text",onClick:e.toggleVisibility,"aria-label":(e.visible?"Hide":"Show")+" Relation",children:e.visible?(0,A.jsx)(To.C_F,{style:{width:20,height:20}}):(0,A.jsx)(To.r9M,{style:{width:20,height:20}})})}),(0,A.jsx)(Qe.Sl,{name:"action",children:t&&(0,A.jsx)(Po,{type:"text",danger:!0,"aria-label":"Delete Relation",onClick:()=>{e.node1.setHighlight(!1),e.node2.setHighlight(!1),e.parent.deleteRelation(e)},children:(0,A.jsx)(To.Eau,{})})})]})]}),e.showMeta&&(0,A.jsx)(Ib,{relation:e})]})})),Ib=(0,v.PA)((({relation:e})=>{const{selectedValues:t,control:n}=e,{children:o,choice:i}=n,s=(0,m.useMemo)((()=>"multiple"===i),[i]),r=(0,m.useCallback)((t=>{const n=(0,x.wrapArray)(t);e.setRelations(n)}),[e]),a=(0,m.useMemo)((()=>o.map((e=>({value:e.value,style:{background:e.background}})))),[o]);return(0,A.jsx)(Qe.eB,{name:"relation-meta",children:(0,A.jsx)(Qn.l6P,{multiple:s,style:{width:"100%"},placeholder:"Select labels",value:t,onChange:r,options:a})})})),Lb=(0,v.PA)((({relationStore:e})=>{const t=e.orderedRelations;return(0,A.jsx)(Qe.eB,{name:"relations",children:(0,A.jsx)(Db,{relations:t})})})),Nb=(0,v.PA)((({relationStore:e})=>{var t;const n=(0,m.useCallback)((t=>{t.preventDefault(),t.stopPropagation(),e.toggleAllVisibility()}),[e]),o=!(null!=e&&null!=(t=e.relations)&&t.length),i=!(!o&&e.isAllHidden);return(0,A.jsx)(Qe.Sl,{tag:Po,type:"text",disabled:o,onClick:n,mod:{hidden:i},"aria-label":i?"Show all":"Hide all",icon:i?(0,A.jsx)(To.liT,{width:16,height:16}):(0,A.jsx)(To.CuU,{width:16,height:16}),tooltip:i?"Show all":"Hide all",tooltipTheme:"dark"})})),zb=(0,v.PA)((({relationStore:e})=>{var t;const n=(0,m.useCallback)((t=>{t.preventDefault(),t.stopPropagation(),e.toggleOrder()}),[e]),o=!(null!=e&&null!=(t=e.relations)&&t.length),i="asc"===e.order;return(0,A.jsx)(Qe.Sl,{tag:Po,type:"text",onClick:n,disabled:o,mod:{order:e.order},"aria-label":i?"Order by oldest":"Order by newest",icon:i?(0,A.jsx)(To.n5,{}):(0,A.jsx)(To.WCw,{}),tooltip:i?"Order by oldest":"Order by newest",tooltipTheme:"dark"})})),Vb=(0,v.PA)((({relationStore:e})=>(0,A.jsxs)(Qe.eB,{name:"relation-controls",children:[(0,A.jsx)(Nb,{relationStore:e}),(0,A.jsx)(zb,{relationStore:e})]}))),Hb=["currentEntity","regions"],Bb=(0,v.PA)((({selection:e,currentEntity:t})=>(0,A.jsx)(A.Fragment,{children:e.size?(0,A.jsx)(Xb,{regions:e}):(0,A.jsx)(Yb,{currentEntity:t})}))),Fb=(0,v.WQ)("store")((0,v.PA)((({store:e})=>(0,A.jsx)(A.Fragment,{children:e.hasInterface("annotations:comments")&&e.commentStore.isCommentable&&(0,A.jsx)(Qe.eB,{name:"comments-panel",children:(0,A.jsx)(Qe.Sl,{name:"section-tab",children:(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Uy,{annotationStore:e.annotationStore,commentStore:e.commentStore,cacheKey:`task.${e.task.id}`})})})})})))),Wb=(0,v.WQ)("store")((0,v.PA)((({currentEntity:e})=>{const{relationStore:t}=e;return(0,A.jsx)(A.Fragment,{children:(0,A.jsx)(Qe.eB,{name:"relations",children:(0,A.jsxs)(Qe.Sl,{name:"section-tab",children:[(0,A.jsxs)(Qe.Sl,{name:"view-control",children:[(0,A.jsxs)(Qe.Sl,{name:"section-head",children:["Relations (",t.size,")"]}),(0,A.jsx)(Vb,{relationStore:t})]}),(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Lb,{relationStore:t})})]})})})}))),$b=(0,v.WQ)("store")((0,v.PA)((({store:e,currentEntity:t})=>{var n;const o=e.hasInterface("annotations:history");return(0,A.jsx)(A.Fragment,{children:(0,A.jsx)(Qe.eB,{name:"history",children:(0,A.jsxs)(Qe.Sl,{name:"section-tab",children:[(0,A.jsxs)(Qe.Sl,{name:"section-head",children:["Annotation History",(0,A.jsxs)("span",{children:["#",null!=(n=t.pk)?n:t.id]})]}),(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Jy,{inline:!0,enabled:o})})]})})})}))),Ub=(0,v.WQ)("store")((0,v.PA)((({selection:e})=>(0,A.jsx)(A.Fragment,{children:(0,A.jsx)(Qe.eB,{name:"info",children:(0,A.jsxs)(Qe.Sl,{name:"section-tab",children:[(0,A.jsx)(Qe.Sl,{name:"section-head",children:"Selection Details"}),(0,A.jsx)(Xb,{regions:e})]})})})))),Yb=(0,v.WQ)("store")((0,v.PA)((({store:e,currentEntity:t})=>{var n;const{relationStore:o}=t,i=e.hasInterface("annotations:history");return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(Qe.Sl,{name:"section",children:[(0,A.jsxs)(Qe.Sl,{name:"section-head",children:["Annotation History",(0,A.jsxs)("span",{children:["#",null!=(n=t.pk)?n:t.id]})]}),(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Jy,{inline:!0,enabled:i})})]}),(0,A.jsxs)(Qe.Sl,{name:"section",children:[(0,A.jsxs)(Qe.Sl,{name:"view-control",children:[(0,A.jsxs)(Qe.Sl,{name:"section-head",children:["Relations (",o.size,")"]}),(0,A.jsx)(Vb,{relationStore:o})]}),(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Lb,{relationStore:o})})]}),e.hasInterface("annotations:comments")&&e.commentStore.isCommentable&&(0,A.jsxs)(Qe.Sl,{name:"section",children:[(0,A.jsx)(Qe.Sl,{name:"section-head",children:"Comments"}),(0,A.jsx)(Qe.Sl,{name:"section-content",children:(0,A.jsx)(Uy,{annotationStore:e.annotationStore,commentStore:e.commentStore,cacheKey:`task.${e.task.id}`})})]})]})})));Yb.displayName="GeneralPanel";const Xb=(0,v.PA)((({regions:e})=>(0,A.jsx)("div",{children:e.list.map((e=>(0,A.jsx)(Gb,{region:e},e.id)))}))),Gb=(0,v.PA)((({region:e})=>(0,A.jsx)(Eb,{region:e,mainDetails:Cb,metaDetails:jb}))),Zb=Fb,qb=$b,Jb=Wb,Qb=Ub,ex=((0,v.PA)((({currentEntity:e,regions:t})=>{const n=t.selection;return(0,A.jsx)(Qe.eB,{name:"details-tab",children:(0,A.jsx)(Bb,{selection:n,currentEntity:e})})})),(0,v.PA)((e=>{let{currentEntity:t,regions:n}=e,o=(0,Zn.A)(e,Hb);const i=n.selection;return(0,A.jsx)(sb,Object.assign({},o,{currentEntity:t,name:"details",title:"Details",children:(0,A.jsx)(Bb,{selection:i,currentEntity:t})}))})));var tx=n(99305),nx=n(19220),ox=n(54357);const ix={menu:"menu--T1p4B",seperator:"seperator--KYwdN",icon:"icon--lm29f",option:"option--uu8tw",danger:"danger--_ukYc",trigger:"trigger--eUuJT",open:"open--fDDq9"},sx=({actions:e,className:t})=>{const n=Fh();return(0,A.jsx)("div",{className:(0,ox.A)(ix.contextMenu,t),children:e.map(((e,t)=>{var o;return!1!==e.enabled&&(0,A.jsxs)(m.Fragment,{children:[e.separator&&(0,A.jsx)("div",{className:ix.seperator}),(0,A.jsxs)("div",{className:(0,ox.A)(ix.option,e.danger&&ix.danger),onClick:t=>e.onClick(t,{dropdown:n}),children:[e.icon&&(0,A.jsx)("span",{className:(0,ox.A)(ix.icon,e.iconClassName),children:e.icon}),e.label]})]},null!=(o=e.key)?o:t)}))})},rx=({children:e,content:t,onToggle:n,className:o})=>{const[i,s]=(0,m.useState)(!1);return(0,A.jsx)("div",{className:(0,ox.A)(ix.trigger,i&&ix.open,o),onClick:e=>e.stopPropagation(),children:(0,A.jsx)(Wh.Trigger,{content:t||void 0,onToggle:e=>{s(e),null==n||n(e)},children:e||(0,A.jsx)(To.ViA,{width:28,height:28})})})},ax=(0,v.PA)((({item:e})=>{const[t,n]=(0,m.useState)(!1),o=(0,m.useMemo)((()=>{const t=new URL(window.location.href);return e.annotation.pk&&t.searchParams.set("annotation",e.annotation.pk),e.id&&t.searchParams.set("region",e.id.split("#")[0]),t.toString()}),[e]),[i]=(0,nx.s)(o),s=(0,Qn.djX)(),r=(0,m.useCallback)(((e,t)=>{var n;i(),null==(n=t.dropdown)||n.close(),s.show({message:"Region link copied to clipboard",type:Qn.CkR.info})}),[i]),a=(0,m.useMemo)((()=>[{label:"Copy Region Link",onClick:r,icon:(0,A.jsx)(To.AXG,{})}]),[r]);return(0,A.jsx)(rx,{className:(0,Qe.cn)("region-context-menu").toClassName(),content:(0,A.jsx)(sx,{actions:a}),onToggle:e=>n(e),children:(0,A.jsx)(Po,{type:"text",style:Object.assign({padding:0,width:24,height:24},t?{display:"flex !important"}:null),children:(0,A.jsx)(To.dbp,{})})})})),lx=["item","label","isArea"],{localStorage:dx}=window,cx="collapsed-label-pos",ux=(0,m.createContext)({regions:null}),hx=({entity:e})=>(0,A.jsx)(yx,{node:e}),gx=({isLeaf:e})=>(0,A.jsx)(vx,{isLeaf:e}),mx=(0,v.PA)((({regions:e,regionsTree:t})=>{const n=(0,m.useRef)(),[o,i]=(0,m.useState)(0);let s=(0,m.useMemo)((()=>{let e=0;return new X((t=>{requestAnimationFrame((()=>{var o,s,r;null!=t&&null!=(o=t[0])&&o.contentRect&&(null==t||null==(s=t[0])||null==(s=s.contentRect)?void 0:s.height)!==e&&(e=(null==t||null==(r=t[0])||null==(r=r.contentRect)?void 0:r.height)||1,n.current&&i(e))}))}))}),[]);(0,m.useEffect)((()=>()=>{var e;null==(e=s)||e.disconnect(),s=null}),[]);const r=(0,m.useCallback)((e=>{var t;if(e)null==(t=s)||t.observe(e);else if(n.current){var o;null==(o=s)||o.unobserve(n.current)}n.current=e,i((null==e?void 0:e.clientHeight)||1)}),[]),a=fx(),l=e.selection.keys,d=(0,Qe.cn)("tree");let c,u;const h=(0,j.VS)(j.TU)&&"label"===e.group;if((0,j.VS)(j.TU)){var g,p,f;const[e,n]=(0,m.useState)(null!=(g=null==(p=dx.getItem(cx))||null==p.split||null==(p=p.split(","))?void 0:p.filter((e=>!!e)))?g:[]),o=e=>{dx.setItem(cx,e.join(","))},i=t=>{const i=[...e,t];n(i),o(i)},s=t=>{const i=e.filter((e=>e!==t));n(i),o(i)};c=null!=(f=t.filter((t=>!e.includes(t.pos))).map((e=>e.key)))?f:[],u=(n,{node:o})=>{const r=t.find((e=>e.key===o.key)).pos;e.includes(r)?s(r):i(r)}}return(0,A.jsx)(Qe.eB,{name:"outliner-tree",ref:r,children:!!o&&(0,A.jsx)(tx.A,Object.assign({draggable:"manual"===e.group,multiple:!0,defaultExpandAll:!0,defaultExpandParent:!h,autoExpandParent:!0,checkable:!1,prefixCls:d.toClassName(),className:d.toClassName(),treeData:t,selectedKeys:l,icon:hx,switcherIcon:gx,virtual:!0,itemHeight:34,height:o},a,h?{expandedKeys:c,onExpand:u}:{}),e.group)})})),px=({regions:e,rootClass:t,footer:n})=>{const o=(0,m.useCallback)(((e,n,o,i,s)=>{var r;const{id:a,type:l,hidden:d,isDrawing:c}=null!=e?e:{},u=null!=(r=null==e?void 0:e.background)?r:null==e||null==e.getOneColor?void 0:e.getOneColor(),h=St()(null!=u?u:"#666").alpha(1),g={hidden:d,type:l,isDrawing:c};return{idx:n,key:a,type:l,label:(0,A.jsx)(Ky,{item:e}),hidden:d,entity:e,color:h.css(),style:{"--icon-color":h.css(),"--text-color":h.css(),"--selection-color":h.alpha(.1).css()},className:t.elem("node").mod(g).toClassName(),title:e=>(0,A.jsx)(bx,Object.assign({},e))}}),[]),i=e.getRegionsTree(o);return n&&i.push({key:"__footer__",disabled:!0,className:t.elem("node").mod({type:"footer"}).toClassName(),title:n}),i},fx=()=>{const e=(0,m.useCallback)(((e,t)=>{const n=t.nativeEvent.ctrlKey||(0,x.isMacOS)()&&t.nativeEvent.metaKey,{node:o}=t,i=null==o?void 0:o.item;if(null==i||!i.annotation)return;const s=i.annotation;if(n)return void s.toggleRegionSelection(i);if((0,j.VS)(j.v1)&&!i.isReadOnly()&&s.isLinkingMode)return s.addLinkedRegion(i),s.stopLinkingMode(),void s.regionStore.unselectAll();const r=!i.selected;r?(s.selectArea(i),null==i.onSelectInOutliner||i.onSelectInOutliner(r)):s.unselectAll()}),[]),t=(0,m.useRef)(),n=(0,m.useCallback)((({node:e})=>{var n,o;t.current&&(null==(o=t.current)||o.setHighlight(!1));null==(n=e.item)||n.setHighlight(!0),t.current=e.item}),[]),o=(0,m.useCallback)((({node:e})=>{var n,o;(null==e||null==(n=e.item)||n.setHighlight(!1),t.current!==(null==e?void 0:e.item))&&(null==(o=t.current)||o.setHighlight(!1));t.current=void 0}),[]),i=o,s=(0,m.useCallback)((e=>{if(!e)return 0;const t=e.item.annotation.regionStore.filterByParentID(e.pid).map((e=>s(e)));return t.length?1+Math.max(...t):0}),[]);return{onSelect:e,onMouseEnter:n,onMouseLeave:o,onDrop:(0,m.useCallback)((({node:e,dragNode:t,dropPosition:n,dropToGap:o})=>{if(e.classification)return!1;const i=e.props.eventKey,r=t.props.eventKey,a=e.props.pos.split("-"),l=e.item.annotation.regionStore;n-=Number.parseInt(a[a.length-1]);const d=a.length,c=l.findRegionID(r),u=l.findRegionID(i);if(l.unhighlightAll(),2===d&&o&&-1===n)c.setParentID("");else if(-1!==n){var h,g;const e=((null==(h=u.labeling)?void 0:h.selectedLabels)||[]).filter((e=>e.groupcancontain));if(e.length){const t=c.labeling.selectedLabels,n=(0,x.flatten)(e.map((e=>e.groupcancontain.split(",")))),o=(0,x.flatten)(t.map((e=>e.alias?[e.alias,e.value]:[e.value])));if(0===n.filter((e=>-1!==o.indexOf(e))).length)return}if(null!=(g=u.labeling)&&null!=(g=g.from_name)&&g.groupdepth){let e=Number(u.labeling.from_name.groupdepth);if(e>=0){e-=s(c);let t=u;for(;t;)t=l.findRegion(t.parentID),e-=1;if(e<0)return}}c.setParentID(u.id)}}),[]),onScroll:i}},vx=(0,v.PA)((({isLeaf:e})=>e?null:(0,A.jsx)(To.Pl9,{}))),yx=(0,v.PA)((({node:e})=>e?(0,A.jsx)(cl,{node:e}):null)),bx=(0,v.PA)((e=>{var t,n;let{item:o,label:i,isArea:s}=e,r=(0,Zn.A)(e,lx);const a=null==o?void 0:o.highlighted,[l,d]=(0,m.useState)(!1),c=(0,m.useMemo)((()=>{var e;return s&&null!=(e=o.perRegionDescControls)?e:[]}),[null==o?void 0:o.perRegionDescControls,s]),u=(0,m.useMemo)((()=>c.length>0),[c.length]),h=(0,m.useCallback)((e=>{e.preventDefault(),e.stopPropagation(),d(!l)}),[l]);return(0,A.jsxs)(Qe.eB,{name:"outliner-item",children:[(0,A.jsxs)(Qe.Sl,{name:"content",children:[!r.isGroup&&(0,A.jsx)(Qe.Sl,{name:"index",children:r.idx+1}),(0,A.jsxs)(Qe.Sl,{name:"title",children:[i,(null==o?void 0:o.text)&&(0,A.jsx)(Qe.Sl,{name:"text",children:o.text.replace(/\\n/g,"\n")}),(null==o?void 0:o.isDrawing)&&(0,A.jsx)(Qe.Sl,{tag:"span",name:"incomplete",children:(0,A.jsx)(Qn.m_M,{title:`Incomplete ${null!=(t=null==(n=o.type)?void 0:n.replace("region",""))?t:"region"}`,children:(0,A.jsx)(To.iQw,{})})})]}),(0,A.jsx)(Sx,{hovered:a,item:o,entity:r.entity,regions:r.children,type:r.type,collapsed:l,hasControls:u&&s,toggleCollapsed:h})]}),!l&&u&&s&&(0,A.jsx)(Qe.Sl,{name:"ocr",children:(0,A.jsx)(wx,{item:o,controls:c,collapsed:l,setCollapsed:d,selected:r.selected})})]})})),xx=(0,v.WQ)((({store:e})=>({store:e}))),Sx=xx((0,v.PA)((({hovered:e,item:t,entity:n,collapsed:o,regions:i,hasControls:s,type:r,toggleCollapsed:a,store:l})=>{var d;const{regions:c}=(0,m.useContext)(ux),u=(0,m.useMemo)((()=>null!=r&&r.includes("region")||null!=r&&r.includes("range")?n.hidden:!(!(!r||r.includes("label")||null!=r&&r.includes("tool"))||!i)&&Object.values(i).every((({hidden:e})=>e))),[n,r,i]),h=(0,m.useCallback)((()=>{null!=r&&r.includes("region")||null!=r&&r.includes("range")?n.toggleHidden():!r||r.includes("label")?c.setHiddenByLabel(!u,n):null!=r&&r.includes("tool")&&c.setHiddenByTool(!u,n)}),[t,null==t?void 0:t.toggleHidden,u]),g=(0,m.useCallback)((e=>{a(e)}),[a]),p=(0,m.useCallback)((()=>{t.setLocked((e=>!e))}),[]);return(0,A.jsxs)(Qe.Sl,{name:"controls",mod:{withControls:s,newUI:(0,j.VS)(j.bA)},children:[(0,j.VS)(j.bA)?(0,A.jsx)(Qn.m_M,{title:"Confidence Score",children:(0,A.jsxs)(Qe.Sl,{name:"control-wrapper",children:[(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"predict"},children:"prediction"===(null==t?void 0:t.origin)&&(0,A.jsx)(To.ccx,{style:{width:18,height:18}})}),(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"score"},children:(0,x.isDefined)(null==t?void 0:t.score)&&t.score.toFixed(2)})]})}):(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"score"},children:(0,x.isDefined)(null==t?void 0:t.score)&&t.score.toFixed(2)}),(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"dirty"}}),(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"predict"},children:"prediction"===(null==t?void 0:t.origin)&&(0,A.jsx)(To.ccx,{style:{width:18,height:18}})})]}),(0,A.jsxs)(Qe.Sl,{name:"wrapper",children:[l.hasInterface("annotations:copy-link")&&(0,x.isDefined)(null==t||null==(d=t.annotation)?void 0:d.pk)&&(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"menu"},children:(0,A.jsx)(ax,{item:t})}),(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"lock"},children:(0,A.jsx)(Tb,{item:t,annotation:null==t?void 0:t.annotation,hovered:e,locked:null==t?void 0:t.locked,onClick:p})}),(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"visibility"},children:(0,j.VS)(j.bA)?(0,A.jsx)(_b,{onClick:h,style:u?void 0:{display:"none"},children:u?(0,A.jsx)(To.r9M,{style:{width:20,height:20}}):(0,A.jsx)(To.C_F,{style:{width:20,height:20}})}):(0,A.jsx)(_b,{onClick:h,children:u?(0,A.jsx)(To.r9M,{style:{width:20,height:20}}):(0,A.jsx)(To.C_F,{style:{width:20,height:20}})})}),s&&(0,A.jsx)(Qe.Sl,{name:"control",mod:{type:"visibility"},children:(0,A.jsx)(_b,{onClick:g,children:(0,A.jsx)(To.gu7,{style:{transform:`rotate(${o?-90:90}deg)`}})})})]})]})}))),wx=(0,v.PA)((({item:e,collapsed:t,setCollapsed:n,selected:o})=>{const i=e.perRegionDescControls||[],s=(0,m.useCallback)((t=>{t.stopPropagation(),o||e.annotation.selectArea(e)}),[e,o,t]);return(0,A.jsx)(Qe.eB,{name:"ocr",mod:{collapsed:t,empty:!((null==i?void 0:i.length)>0)},onClick:s,onDragStart:e=>e.stopPropagation(),children:(0,A.jsx)(Qe.Sl,{name:"controls",children:i.map(((o,i)=>{const s=b.getPerRegionView(o.type,mt.REGION_LIST),r=e.getOneColor(),a=r?St()(r).alpha(.2).css():void 0;return s?(0,A.jsx)(s,{item:o,area:e,collapsed:t,setCollapsed:n,color:a,outliner:!0,canDelete:!1},i):null}))})})})),kx=(0,v.PA)((({regions:e,footer:t})=>{const n=(0,Qe.cn)("tree"),o=px({regions:e,rootClass:n,footer:t,grouping:e.group});return(0,A.jsx)(ux.Provider,{value:{regions:e},children:(0,A.jsx)(mx,{regions:e,regionsTree:o})})})),Cx=(0,m.createContext)({locked:!1}),{Block:jx,Elem:Rx}=(0,Qe.JE)(),_x=(0,v.PA)((({ordering:e,regions:t,orderingDirection:n,onOrderingChange:o,onGroupingChange:i,onFilterChange:s})=>{const r=t.group,a=(0,m.useContext)(Cx),l=(0,m.useCallback)((e=>{switch(e){case"manual":return{label:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(To.uMc,{})," Group Manually"]}),selectedLabel:(0,j.VS)(j.bA)?"Manual":"Manual Grouping",icon:(0,A.jsx)(To.uMc,{width:16,height:16}),tooltip:"Manually Grouped"};case"label":return{label:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(To.vHH,{})," Group by Label"]}),selectedLabel:(0,j.VS)(j.bA)?"By Label":"Grouped by Label",icon:(0,A.jsx)(To.vHH,{width:16,height:16}),tooltip:"Grouped by Label"};case"type":return{label:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(To.ECq,{})," Group by Tool"]}),selectedLabel:(0,j.VS)(j.bA)?"By Tool":"Grouped by Tool",icon:(0,A.jsx)(To.ECq,{width:16,height:16}),tooltip:"Grouped by Tool"}}}),[]),d=(0,m.useCallback)((e=>{switch(e){case"date":return{label:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(To.NH8,{})," Order by Time"]}),selectedLabel:"By Time",icon:(0,A.jsx)(To.NH8,{width:16,height:16})};case"score":return{label:(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(To.aHw,{})," Order by Score"]}),selectedLabel:"By Score",icon:(0,A.jsx)(To.aHw,{width:16,height:16})}}}),[]),c="asc"===n?(0,A.jsx)(To.n5,{}):(0,A.jsx)(To.WCw,{});return(0,A.jsxs)(jx,{name:"view-controls",mod:{collapsed:a.locked},children:[(0,A.jsx)(Tx,{value:r,options:["manual","type","label"],onChange:e=>i(e),readableValueForKey:l}),"manual"===r&&(0,A.jsx)(Rx,{name:"sort",children:(0,A.jsx)(Tx,{value:e,direction:n,options:["score","date"],onChange:e=>o(e),readableValueForKey:d,allowClickSelected:!0,extraIcon:c})}),(0,A.jsx)(Ex,{regions:t})]})})),Tx=({value:e,options:t,direction:n,allowClickSelected:o,onChange:i,readableValueForKey:s,extraIcon:r})=>{const a=(0,m.useMemo)((()=>s(e)),[e]),l=(0,m.useMemo)((()=>t.map((e=>[e,s(e)]))),[]),d=(0,m.useMemo)((()=>(0,A.jsx)(Yh,{size:"medium",style:{width:200,minWidth:200,borderRadius:(0,j.VS)(j.bA)&&4},selectedKeys:[e],allowClickSelected:o,children:l.map((([t,o])=>(0,A.jsx)(Ax,{name:t,value:e,direction:n,label:o,onChange:e=>i(e)},t)))})),[e,l,a,n,i]),c=(0,j.VS)(j.bA)?{mod:{newUI:!0}}:void 0,u=(0,j.VS)(j.bA)?{padding:"0 12px 0 2px"}:{};return(0,A.jsx)(Wh.Trigger,{content:d,style:{width:200},children:(0,A.jsx)(Po,Object.assign({type:"text","data-testid":`grouping-${e}`},c,{icon:a.icon,style:u,extra:(0,j.VS)(j.bA)?r:(0,A.jsx)(Kx,{direction:n,name:e,value:e,wrap:!1}),tooltip:a.tooltip||void 0,tooltipTheme:"dark",children:a.selectedLabel}))})},Ax=({value:e,name:t,label:n,direction:o,onChange:i})=>(0,A.jsx)(Yh.Item,{name:t,onClick:()=>i(t),children:(0,A.jsxs)(Rx,{name:"label",children:[n.label,(0,A.jsx)(Kx,{direction:o,name:t,value:e})]})}),Kx=({direction:e,value:t,name:n,wrap:o=!0})=>{const i="asc"===e?(0,A.jsx)(To.n5,{}):(0,A.jsx)(To.WCw,{});return!e||t!==n||(0,j.VS)(j.bA)?null:o?(0,A.jsx)("span",{children:i}):i},Ex=(0,v.PA)((({regions:e})=>{var t;const n=(0,m.useCallback)((t=>{t.preventDefault(),t.stopPropagation(),e.toggleVisibility()}),[e]),o=!(null!=e&&null!=(t=e.regions)&&t.length),i=!o&&e.isAllHidden;return(0,A.jsx)(Rx,{tag:Po,type:"text",disabled:o,onClick:n,mod:{hidden:i},"aria-label":i?"Show all regions":"Hide all regions",icon:i?(0,A.jsx)(To.liT,{width:16,height:16}):(0,A.jsx)(To.CuU,{width:16,height:16}),tooltip:i?"Show all regions":"Hide all regions",tooltipTheme:"dark"})})),Px=["regions"],Mx=[];Mx.push("ff_hide_all_regions");const Dx=(0,v.PA)((({regions:e})=>{var t,n,o,i,s;const r=(null==e||null==(t=e.regions)?void 0:t.length)>0&&0===(null==e||null==(n=e.filter)?void 0:n.length),a=(0,m.useMemo)((()=>{var t,n,o,i;return null!=e&&null!=(t=e.regions)&&t.length&&null!=(n=e.filter)&&n.length?(null==e||null==(o=e.regions)?void 0:o.length)-(null==e||null==(i=e.filter)?void 0:i.length):0}),[null==e||null==(o=e.regions)?void 0:o.length,null==e||null==(i=e.filter)?void 0:i.length]);return(0,A.jsx)(A.Fragment,{children:r?(0,A.jsxs)(Qe.eB,{name:"filters-info",children:[(0,A.jsx)(To.G_L,{width:21,height:20}),(0,A.jsx)(Qe.Sl,{name:"filters-title",children:"All regions hidden"}),(0,A.jsx)(Qe.Sl,{name:"filters-description",children:"Adjust or remove the filters to view"})]}):(null==e||null==(s=e.regions)?void 0:s.length)>0?(0,A.jsx)(A.Fragment,{children:(0,A.jsx)(kx,{regions:e,footer:a>0&&(0,A.jsxs)(Qe.eB,{name:"filters-info",children:[(0,A.jsx)(To.G_L,{width:21,height:20}),(0,A.jsxs)(Qe.Sl,{name:"filters-title",children:["There ",1===a?"is":"are"," ",a," hidden region",a>1&&"s"]}),(0,A.jsx)(Qe.Sl,{name:"filters-description",children:"Adjust or remove filters to view"})]})})}):(0,A.jsx)(Qe.Sl,{name:"empty",children:"Regions not added"})})})),Ox=(0,v.PA)((({regions:e})=>{const t=(0,m.useCallback)((t=>{e.setSort(t)}),[e]),n=(0,m.useCallback)((t=>{e.setGrouping(t)}),[e]),o=(0,m.useCallback)((t=>{e.setFilteredRegions(t)}),[e]);return(0,A.jsxs)(Qe.eB,{name:"outliner",mix:Mx,children:[(0,A.jsx)(_x,{ordering:e.sort,regions:e,orderingDirection:e.sortOrder,onOrderingChange:t,onGroupingChange:n,onFilterChange:o}),(0,A.jsx)(Dx,{regions:e})]})})),Ix=(0,v.PA)((e=>{let{regions:t}=e,n=(0,Zn.A)(e,Px);const[o,i]=(0,m.useState)(),s=(0,m.useCallback)((e=>{t.setSort(e)}),[t]),r=(0,m.useCallback)((e=>{t.setGrouping(e),i(e)}),[t]),a=(0,m.useCallback)((e=>{t.setFilteredRegions(e)}),[t]);return(0,m.useEffect)((()=>{i(t.group)}),[]),t.setGrouping(o),(0,A.jsxs)(sb,Object.assign({},n,{name:"outliner",mix:Mx,title:"Outliner",children:[(0,A.jsx)(_x,{ordering:t.sort,regions:t,orderingDirection:t.sortOrder,onOrderingChange:s,onGroupingChange:r,onFilterChange:a}),(0,A.jsx)(Dx,{regions:t})]}))})),Lx=e=>{const[t,n]=(0,m.useState)(window.matchMedia(e));return(0,m.useEffect)((()=>{const t=()=>{n(window.matchMedia(e))};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)}),[]),(0,m.useEffect)((()=>{n(window.matchMedia(e))}),[e]),t},Nx=e=>{var t;(0,m.useEffect)((()=>{const t=e=>{var t;if(!e)return!1;if(e.nodeType!==Node.ELEMENT_NODE)return!1;const n=e,o=Number.parseInt(null!=(t=n.getAttribute("tabindex"))?t:"",10);return n.matches("a, button, input, textarea, select, details, [tabindex], [contenteditable]")||o>-1},n=()=>{var e;const n=window.getSelection(),o=null==n?void 0:n.focusNode,i=t(o),s=t(document.activeElement);return(null==(e=null==n?void 0:n.isCollapsed)||e)&&!i&&!s},o=t=>{const{clipboardData:n}=t,o=e.serializedSelection;null==n||n.setData("application/json",JSON.stringify(o)),t.preventDefault()},i=e=>{n()&&o(e)},s=t=>{n()&&(t=>{const{clipboardData:n}=t,o=null==n?void 0:n.getData("application/json");try{const n=(o?JSON.parse(o):[]).map((e=>Object.assign({},e,{readonly:!1})));e.appendResults(n),t.preventDefault()}catch(e){return void console.error(e)}})(t)},r=t=>{n()&&(o(t),e.deleteSelectedRegions())};return window.addEventListener("copy",i),window.addEventListener("paste",s),window.addEventListener("cut",r),()=>{window.removeEventListener("copy",i),window.removeEventListener("paste",s),window.removeEventListener("cut",r)}}),[null!=(t=e.pk)?t:e.id])},zx=980,Vx=(e,t)=>{const n=window.localStorage.getItem(`panel:${e}`);return n?Object.assign({},t,JSON.parse(n)):t},Hx=(e,t)=>{window.localStorage.setItem(`panel:${e}`,JSON.stringify(t))},Bx={outliner:{title:"Outliner",component:Ix,icon:To.v},details:{title:"Details",component:ex,icon:To.Iap}},Fx=(0,v.PA)((({currentEntity:e,panelsHidden:t,children:n})=>{const o=e.regionStore,i=(0,m.useRef)({width:0,height:0}),s=Lx("screen and (max-width: 980px)"),[r,a]=(0,m.useState)(500),[l,d]=(0,m.useState)(!1),[c,u]=(0,m.useState)(!1),[h,g]=(0,m.useState)(!1),[p,f]=(0,m.useState)(!1),v=(0,m.useRef)(),[y,b]=(0,m.useState)(),S=(0,m.useRef)(y);S.current=y;const[w,k]=(0,m.useState)({outliner:Vx("outliner",{top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:eb,height:tb,visible:!0,detached:!1,alignment:"left",maxHeight:nb}),details:Vx("details",{top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:eb,height:tb,visible:!0,detached:!1,alignment:"right",maxHeight:nb})});Nx(e);const C=(0,m.useMemo)((()=>l||s.matches),[l,s.matches]),R=(0,m.useCallback)(((e,t)=>{k((n=>{const o=Object.assign({},n[e],t);return Hx(e,o),Object.assign({},n,{[e]:o})}))}),[w]),_=(0,m.useCallback)(((e,t)=>{const n=w[e],o=E(e,n.top,n.left,t);R(e,{visible:t,storedTop:o.top/i.current.height*100,storedLeft:o.left/i.current.width*100})}),[R]),T=(0,m.useCallback)((e=>(0,j.VS)(j.bA)||void 0===Object.values(w).find((t=>t.alignment===e&&!t.detached))),[w]),K=(0,m.useCallback)(((e,t,n)=>{const o=e+n,i=t-5;e>=0&&e<=5&&T("left")?b("left"):o<=t&&o>=i&&T("right")?b("right"):b(void 0)}),[T]),E=(e,t,n,o)=>{var i,s,r,a;const l=w[e],d=null!=(i=null==(s=v.current)?void 0:s.clientWidth)?i:0,c=l.detached?(null!=o?o:l.visible)?l.height:26:l.height;return{left:(0,x.clamp)(n,0,d-l.width),top:(0,x.clamp)(t,0,(null!=(r=null==(a=v.current)?void 0:a.clientHeight)?r:0)-c)}},P=(0,m.useCallback)((e=>{const t=Object.entries(w).reduce(((e,[t,n])=>{const o=Object.assign({},n,{zIndex:1});return g(!0),Hx(t,o),Object.assign({},e,{[t]:o})}),Object.assign({},w));t[e]=Object.assign({},t[e],{zIndex:15}),Hx(e,t[e]),k(t)}),[w]),M=(0,m.useCallback)(((e,t,n,o)=>{var s,r;const a=w[e],l=null!=(s=null==(r=v.current)?void 0:r.clientWidth)?s:0,{left:d,top:c}=E(e,t,n,a.visible),u=i.current.height-c;K(d,l,a.width),requestAnimationFrame((()=>{R(e,{top:c,left:d,relativeTop:c/i.current.height*100,relativeLeft:d/i.current.width*100,storedLeft:void 0,storedTop:void 0,detached:o,maxHeight:u,alignment:o?void 0:a.alignment})}))}),[R,K,w]),D=(0,m.useCallback)((()=>{u((()=>!0))}),[]),O=(0,m.useCallback)((()=>{u((()=>!1))}),[]),I=(0,m.useCallback)((e=>Object.keys(w).filter((t=>{var n;return(null==(n=w[t])?void 0:n.alignment)===e}))),[w]),L=(0,m.useCallback)(((e,t,n,o,s)=>{const{left:a,top:l}=E(e,o,s),d=i.current.height-l;requestAnimationFrame((()=>{if((0,j.VS)(j.bA)){var o;I(null==(o=w[e])?void 0:o.alignment).forEach((e=>{R(e,{top:l,left:a,relativeTop:l/i.current.height*100,relativeLeft:a/i.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:d,width:(0,x.clamp)(t,eb,r),height:(0,x.clamp)(n,tb,d)})}))}else R(e,{top:l,left:a,relativeTop:l/i.current.height*100,relativeLeft:a/i.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:d,width:(0,x.clamp)(t,eb,r),height:(0,x.clamp)(n,tb,d)})}))}),[R,r,w]),N=(0,m.useCallback)((e=>{if(g(!1),!S.current)return;const t={alignment:S.current,detached:!1};if((0,j.VS)(j.bA)){var n;const i=null==(n=I(S.current).filter((t=>t!==e)))?void 0:n[0];var o;if(i)t.width=(0,x.clamp)(null==(o=w[i])?void 0:o.width,eb,r)}R(e,t),b(void 0)}),[R]),z=(0,m.useMemo)((()=>({onResize:L,onResizeStart:D,onResizeEnd:O,onPositionChange:M,onVisibilityChange:_,onPositionChangeBegin:P,onSnap:N})),[L,D,O,M,_,N]),V=(0,m.useMemo)((()=>Object.assign({},z,{root:v,regions:o,selection:o.selection,currentEntity:e})),[z,v,o,o.selectio,e]),H=(0,m.useMemo)((()=>{if(t&&(0,j.VS)(j.bA))return{};const e={paddingLeft:0,paddingRight:0};return C?e:Object.values(w).reduce(((e,n)=>{const o=(0,j.VS)(j.bA)||!t&&!n.detached&&n.visible?n.width:ob,i="left"===n.alignment?"paddingLeft":"paddingRight";return n.detached?e:Object.assign({},e,{[i]:o})}),e)}),[t,w,C]),B=(0,m.useMemo)((()=>{if(t)return{};const e={detached:[],left:[],right:[]},n=Object.entries(w);for(const[t,s]of n){var o,i;const{alignment:n,detached:a}=s,l=Bx[t],d=l.component,c=l.icon,u={props:Object.assign({},s,V,{top:null!=(o=s.storedTop)?o:s.top,left:null!=(i=s.storedLeft)?i:s.left,tooltip:l.title,icon:(0,A.jsx)(c,{}),positioning:h,maxWidth:r,zIndex:s.zIndex,expanded:C,alignment:C?"left":s.alignment,locked:C}),Component:d};a?e.detached.push(u):"left"===n?e.left.push(u):"right"===n&&e.right.push(u)}return e}),[w,V,t,C,h,r]);(0,m.useEffect)((()=>{const e=v.current;if(!e)return;const t=()=>{var e,t;return(null!=(e=null==(t=v.current)?void 0:t.clientWidth)?e:0)<zx},n=new X((()=>{requestAnimationFrame((()=>{if(!v.current)return;const{clientWidth:e,clientHeight:n}=v.current;e<=zx||(i.current.width=null!=e?e:0,i.current.height=null!=n?n:0,d(t()),a(.4*v.current.clientWidth))}))}));return e&&(n.observe(e),d(t()),a(.4*e.clientWidth),f(!0)),()=>{e&&n.unobserve(e),n.disconnect()}}),[]);const F=(0,m.useMemo)((()=>({locked:C})),[C]);return(0,A.jsx)(Cx.Provider,{value:F,children:(0,A.jsx)(Qe.eB,{ref:e=>{e&&(v.current=e,d(e.clientWidth<=zx))},name:"sidepanels",style:Object.assign({},H),mod:{collapsed:C,newLabelingUI:(0,j.VS)(j.bA)},children:p&&(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"content",mod:{resizing:c||h},children:n}),!0!==t&&(0,A.jsx)(A.Fragment,{children:Object.entries(B).map((([e,t])=>{const n=t.map((({props:e,Component:t},n)=>(0,A.jsx)(t,Object.assign({},e),n)));return"detached"===e?(0,A.jsx)(m.Fragment,{children:n},e):(0,A.jsx)(Qe.Sl,{name:"wrapper",mod:{align:e,snap:y===e&&void 0!==y},children:n},e)}))})]})})})}));let Wx=function(e){return e.left="left",e.right="right",e}({}),$x=function(e){return e.left="left",e.right="right",e.topRight="right-top",e.topLeft="left-top",e.bottomRight="right-bottom",e.bottomLeft="left-bottom",e}({}),Ux=function(e){return e.top="top",e.bottom="bottom",e}({});const Yx={order:0,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:1,width:eb,height:tb,visible:!0,detached:!0,alignment:Wx.left,maxHeight:nb,panelViews:[]},Xx=(e,t)=>{const n=t||e.target,o=n.clientWidth;return e.pageX-n.getBoundingClientRect().left>o/2?Wx.right:Wx.left},Gx=(e,t,n)=>{const o=Object.assign({},e);return o[t]?Object.assign({},o,{[t]:Object.assign({},o[t],{panelViews:o[t].panelViews.filter(((e,t)=>t!==n))})}):o},Zx=(e,t,n)=>{const o=Object.assign({},e,{[t]:Object.assign({},e[t],{panelViews:e[t].panelViews.map(((e,t)=>(e.active=t===n,e)))})});return o},qx=e=>{const t=Object.assign({},e);return Object.values(t).forEach((e=>{const t=!e.panelViews.find((e=>e.active));t&&(e.panelViews[0].active=!0)})),t},Jx=e=>{const t={};return Object.keys(e).forEach((n=>{const o=`${e[n].panelViews.map((e=>e.name)).join("-")}`,i=Object.assign({},e[n]);Object.assign(t,{[o]:i})})),t},Qx=e=>{const t=Object.assign({},e);return Object.keys(t).forEach((e=>{0===t[e].panelViews.length&&delete t[e]})),t},eS={regions:Ox,history:qb,relations:Jb,comments:Zb,info:Qb},tS=[{name:"regions",title:"Regions",component:eS.regions,active:!0},{name:"history",title:"History",component:eS.history,active:!1},{name:"relations",title:"Relations",component:eS.relations,active:!1},{name:"info",title:"Info",component:eS.info,active:!0},{name:"comments",title:"Comments",component:eS.comments,active:!1}],nS={"info-comments-history":{order:1,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:eb,height:tb,visible:!0,detached:!1,alignment:Wx.right,maxHeight:nb,panelViews:[tS[3],tS[4],tS[1]]},"regions-relations":{order:2,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:eb,height:tb,visible:!0,detached:!1,alignment:Wx.right,maxHeight:nb,panelViews:[tS[0],tS[2]]}},oS={"info-history":{order:1,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:eb,height:tb,visible:!0,detached:!1,alignment:Wx.right,maxHeight:nb,panelViews:[tS[3],tS[1]]},"regions-relations":{order:2,top:0,left:0,relativeLeft:0,relativeTop:0,zIndex:10,width:eb,height:tb,visible:!0,detached:!1,alignment:Wx.right,maxHeight:nb,panelViews:[tS[0],tS[2]]}},iS=Object.assign({},Yx,{name:"breakpointCollapsed",positioning:!1,height:tb,maxHeight:tb,detached:!1,maxWidth:500,zIndex:10,expanded:!0,locked:!0,alignment:Wx.left,lockPanelContents:!1,attachedKeys:[],sidePanelCollapsed:{[Wx.left]:!1,[Wx.right]:!1},setSidePanelCollapsed:()=>{},dragTop:!1,dragBottom:!1,panelViews:[tS[0],tS[1],tS[2],tS[3],tS[4]]}),sS=["top-left","top-right","bottom-left","bottom-right","top","bottom","right","left"],rS=e=>{var t;const n=window.localStorage.getItem("panelState"),o=n&&JSON.parse(n),i=o&&o.panelData,s={[Wx.left]:!1,[Wx.right]:!1},r=null!=(t=null==o?void 0:o.collapsedSide)?t:s,a=i&&Object.values(i).flatMap((e=>e.panelViews)),l=tS.length-(e?0:1);if(!a||a.length!==l){return{panelData:e?nS:oS,collapsedSide:s}}const d=Qx(i),c=qx(d),u=((e,t)=>{const n=Object.assign({},e);return Object.keys(n).filter((e=>n[e])).forEach((e=>{Object.keys(t).some((n=>t[n].alignment===e&&!t[n].detached))||(n[e]=!1)})),n})(r,c);return{panelData:aS(c),collapsedSide:u}},aS=e=>{const t=Object.assign({},e);return Object.keys(t).forEach((e=>{t[e].panelViews.forEach((e=>{e.component=eS[e.name]}))})),t},lS=e=>Object.keys(e).filter((t=>!e[t].detached&&e[t].alignment===Wx.left)),dS=e=>Object.keys(e).filter((t=>!e[t].detached&&e[t].alignment===Wx.right)),cS=(e,t)=>t===Wx.left?lS(e).sort(((t,n)=>e[t].order-e[n].order)):t===Wx.right?dS(e).sort(((t,n)=>e[t].order-e[n].order)):void 0,uS=(e,t)=>{const n=Object.assign({},e);return[lS(n),dS(n)].forEach((o=>{const i=o.filter((t=>!e[t].visible)).length,s=o.filter((t=>e[t].visible)),r=ob*i,a=s.reduce(((e,t)=>e+n[t].height),0),l=t-r-a,d=l<0,c=Math.abs(l)/(s.length||1);let u=0;s.forEach((e=>{const t=d?n[e].height-c:n[e].height+c;n[e].visible?(n[e].height=t,n[e].top=u,u+=t):u+=ob}))})),n},hS=(e,t,n)=>{const o=Object.assign({},e),i=cS(o,n);if(null==i||!i.length)return e;const s=i.filter((e=>o[e].visible)),r=i.filter((e=>!o[e].visible)).length,a=(t-ob*r)/s.length||1;return s.forEach((e=>{let t=0;o[e].visible?(o[e].height=a,o[e].top=t,t+=a):t+=ob})),o},gS=(e,t,n,o,i,s=Ux.bottom)=>{const r=Object.assign({},e),a=cS(r,n),l=a?a.reduce(((t,n)=>t<e[n].width?e[n].width:t),0)||o:o||eb,d=Object.assign({},r,{[t]:Object.assign({},r[t],{width:l,alignment:n,detached:!1})}),c=((e,t,n,o)=>{const i=Object.assign({},e);i[t].order=o===Ux.top?0:n.length;let s=o===Ux.bottom?0:1;return n.forEach((e=>{t!==e&&(i[e].order=s,s+=1)})),i})(d,t,cS(d,n),s),u=pS(c,t);return hS(u,i,n)},mS=(e,t,n,o,i,s,r)=>{const a=((e,t,n,o,i,s,r)=>Object.assign({},Yx,{name:t,panelViews:[Object.assign({},e[n].panelViews[o],{active:!0})],top:s,left:i,relativeTop:s/r.current.height*100,relativeLeft:i/r.current.width*100,visible:!0,detached:!0,zIndex:12}))(e,t,n,o,i,s,r),l=Gx(e,n,o),d=Qx(l),c=Object.assign({},d,{[`${a.name}`]:a}),u=Jx(c),h=qx(u),g=pS(h,a.name);return uS(g,r.current.height)},pS=(e,t)=>{const n=Object.assign({},e),[o,i]=(e=>Object.keys(e).reduce(((t,n)=>(e[n].detached?t[0].push({zIndex:e[n].zIndex,panelKey:n}):t[1].push({zIndex:e[n].zIndex,panelKey:n}),t)),[[],[]]))(n);let s=12;return i.forEach((e=>n[e.panelKey].zIndex=10)),o.sort(((e,t)=>e.zIndex-t.zIndex)).forEach((e=>{n[e.panelKey].zIndex=s,s++})),n[t].detached&&(n[t].zIndex=o.length+12),n},fS=({name:e,root:t,width:n,maxWidth:o,height:i,visible:s,detached:r,alignment:a,top:l,left:d,relativeTop:c,relativeLeft:u,zIndex:h,locked:g=!1,positioning:p=!1,onSnap:f,onResize:v,onGroupHeightResize:y,onResizeStart:b,onResizeEnd:S,onVisibilityChange:w,onPositionChange:k,onPositionChangeBegin:C,children:j,panelViews:R,attachedKeys:_,sidePanelCollapsed:T,setSidePanelCollapsed:K,dragTop:E,dragBottom:P,lockPanelContents:M})=>{const D=(0,m.useRef)(),O=(0,m.useRef)(),I=(0,m.useRef)(),L=(0,m.useRef)(),N=(0,m.useRef)({onResize:v,onGroupHeightResize:y,onResizeStart:b,onResizeEnd:S,onPositionChange:k,onPositionChangeBegin:C,onVisibilityChange:w,onSnap:f}),[z,V]=(0,m.useState)(),H=(0,m.useRef)(e),B=T[a]&&!r,F=_&&_[0]===e,W=_&&_.includes(e)&&_[0]!==e,$=!(B&&!F),U=s&&!B?"Collapse":"Expand";N.current={onResize:v,onGroupHeightResize:y,onResizeStart:b,onResizeEnd:S,onPositionChange:k,onPositionChangeBegin:C,onVisibilityChange:w,onSnap:f},H.current=e;const Y=(0,m.useMemo)((()=>{const e=s?{height:g?tb:B?"100%":null!=i?i:"100%",width:g?"100%":B?ob:null!=n?n:"100%"}:{width:B?"100%":null!=n?n:eb,height:B?"100%":ob};return Object.assign({},e,{zIndex:h})}),[n,i,s,g,B,h]),X=(0,m.useMemo)((()=>r&&!g?{top:`${c}%`,left:`${u}%`}:{}),[r,c,u,g]),G=(0,m.useMemo)((()=>({detached:!g&&r,hidden:!s,alignment:r?"left":null!=a?a:"left",disabled:g,collapsed:B,dragTop:E&&_&&_[0]===e,dragBottom:P&&_&&_[_.length-1]===e})),[a,s,r,z,g,B,E,P]);Qy({elementRef:D,disabled:g,onMouseDown(e){var n;const o=e.target,i="[class*=__toggle]";if(o.matches(i)||o.closest(i)||B)return;const s=O.current,l=t.current.getBoundingClientRect(),d=s.getBoundingClientRect(),c=null==(n=e.target)?void 0:n.getBoundingClientRect(),u=e.clientX-c.left,h=e.clientY-c.top,[g,m]=[e.pageX,e.pageY],[p,f]=[d.left-l.left,d.top-l.top],{current:v}=H,[y,b]=[g-u,m-h];return null==N.current.onPositionChangeBegin||N.current.onPositionChangeBegin(v,y,b,a,r),{x:g,y:m,oX:p,oY:f,allowDrag:!0,alignment:a,key:v}},onMouseMove(e,t){if(!t)return;const{x:n,y:o,oX:i,oY:s,key:r}=t,[l,d]=[e.pageX,e.pageY];var c,u,h,g;if((c=n,u=l,h=o,g=d,Math.sqrt((u-c)**2+(g-h)**2))<30)return;const[m,p]=[i+(l-n),s+(d-o)];null==N.current.onPositionChange||N.current.onPositionChange(r,p,m,!0,a)},onMouseUp(e,t){if(!t)return;const{key:n}=t;null==N.current.onSnap||N.current.onSnap(n)}},[r,s,g,a,e,B,D.current]),Qy({elementRef:I,disabled:g||p,capture:!0,passive:!0,onMouseDown(e){const t=e.target.dataset.resize,s=(()=>{switch(t){case"top-left":return"top-left";case"top":case"top-right":return"top";case"left":case"bottom-left":return"left"}})(),r={x:null!==(null==t?void 0:t.match(/left|right/i)),y:null!==(null==t?void 0:t.match(/top|bottom/i))};return V(t),null==N.current.onResizeStart||N.current.onResizeStart(),{pos:[e.pageX,e.pageY],type:t,width:n,maxWidth:o,height:i,top:l,left:d,resizeDirections:r,shift:s}},onMouseMove(e,t){if(t){const{pos:n,width:o,height:i,maxWidth:s,top:r,left:a,resizeDirections:l,shift:d}=t,[c,u]=n,h=l.x?e.pageX-c:0,g=l.y?e.pageY-u:0,m=(0,x.isDefined)(d)&&["left","top-left"].includes(d),p=(0,x.isDefined)(d)&&["top","top-left"].includes(d),f=(0,x.clamp)(m?o-h:o+h,eb,s),v=(0,x.clamp)(p?i-g:i+g,55,r+i),y=p?r+(i-v):r,b=m?a+(o-f):a,{current:S}=H;N.current.onResize(S,f,v,y,b)}},onMouseUp(){null==N.current.onResizeEnd||N.current.onResizeEnd(),V(void 0)}},[N,r,n,o,i,l,d,s,g,p]),Qy({elementRef:L,disabled:g||p,capture:!0,passive:!0,onMouseDown:e=>(V("grouped-top"),null==N.current.onResizeStart||N.current.onResizeStart(),{sY:e.pageY,h:i}),onMouseMove(e,t){if(!t)return;const{sY:n,h:o}=t,i=e.pageY-n,s=o-i,{current:r}=H;null==N.current.onGroupHeightResize||N.current.onGroupHeightResize(r,s,i)},onMouseUp(){null==N.current.onResizeEnd||N.current.onResizeEnd(),V(void 0)}},[N,n,i,l,d,g,p,L.current]);const Z=()=>{K(Object.assign({},T,{[a]:!T[a]}))},q=(0,m.useCallback)((t=>{t.stopPropagation(),t.preventDefault(),null==w||w(e,!s)}),[w,e,s]);return(0,A.jsxs)(Qe.eB,{ref:O,name:"tabs-panel",mod:G,style:Object.assign({},Y,X),children:[(0,A.jsxs)(Qe.Sl,{name:"content",children:[!g&&$&&(0,A.jsxs)(A.Fragment,{children:[W&&s&&(0,A.jsx)(Qe.Sl,{name:"grouped-top",ref:L,mod:{drag:"grouped-top"===z},"data-resize":"grouped-top"}),(0,A.jsxs)(Qe.Sl,{ref:D,onClick:()=>{B&&Z()},id:e,mod:{collapsed:B},name:"header",children:[(0,A.jsxs)(Qe.Sl,{name:"header-left",children:[!B&&(0,A.jsx)(Qe.Sl,{name:"icon",style:{pointerEvents:"none"},tag:To.ORE}),!s&&!B&&(0,A.jsx)(Qe.Sl,{name:"title",children:R.map((e=>e.title)).join(" ")})]}),(0,A.jsxs)(Qe.Sl,{name:"header-right",children:[(!r||B)&&(0,A.jsx)(Qe.Sl,{name:"toggle",mod:{detached:r,collapsed:B,alignment:a},onClick:Z,"data-tooltip":`${U} Group`,children:Wx.left===a?(0,A.jsx)(To.gu7,{}):(0,A.jsx)(To.Vjx,{})}),!B&&(0,A.jsx)(Qe.Sl,{name:"toggle",mod:{detached:r,collapsed:B,alignment:a},onClick:q,"data-tooltip":U,children:s?(0,A.jsx)(To.A8g,{}):(0,A.jsx)(To.hHu,{})})]})]})]}),s&&!B&&(0,A.jsxs)(Qe.Sl,{name:"body",children:[M&&(0,A.jsx)(Qe.Sl,{name:"shield"}),j]})]}),s&&!p&&!g&&(0,A.jsx)(Qe.Sl,{name:"resizers",ref:I,mod:{locked:p||g},children:sS.map((e=>!B&&(("left"===e||"right"===e)&&a!==e||r)?(0,A.jsx)(Qe.Sl,{name:"resizer",mod:{drag:e===z},"data-resize":e},e):null))})]})},vS=[];var yS=function(e){return e.tabLeft="lsf-drag_over_tab_left",e.tabRight="lsf-drag_over_tab_right",e.emptyTabSpace="lsf-drag_over_empty_tab_space",e}(yS||{});const bS=()=>{vS.forEach((e=>{null==e||e.classList.remove(yS.tabLeft),null==e||e.classList.remove(yS.tabRight),null==e||e.classList.remove(yS.emptyTabSpace)}))},xS=({name:e,rootRef:t,tabTitle:n,tabIndex:o,panelKey:i,viewLength:s,children:r,active:a,panelWidth:l,locked:d,breakPointActiveTab:c,setBreakPointActiveTab:u,transferTab:h,createNewPanel:g,setActiveTab:p,checkSnap:f})=>{const v=(0,m.useRef)(),y=(0,m.useRef)(),b=(0,m.useRef)(!1),x=(0,m.useRef)({panelKey:i,tabIndex:o}),[S,w]=(0,m.useState)(!1);x.current={panelKey:i,tabIndex:o},Qy({elementRef:v,onMouseDown(e){var n;if(d)return void(u&&u(x.current.tabIndex));if(2===e.buttons)return;const{panelKey:o,tabIndex:i}=Object.assign({},x.current);p(o,i),null==(n=t.current)||n.append(y.current),y.current.style.pointerEvents="all";const s=v.current,r=t.current.getBoundingClientRect(),a=s.getBoundingClientRect(),[l,c]=[e.pageX,e.pageY],[h,g]=[a.left-r.left,a.top-r.top];return{x:l,y:c,oX:h,oY:g,panelKey:o,tabIndex:i}},onMouseMove(e,t){var n,s;if(!t)return;document.body.style.cursor="grabbing",null==(n=window.getSelection())||n.removeAllRanges(),b.current=!0;const{x:r,y:a,oX:d,oY:c}=t,u=e.pageY-(a-c),h=e.pageX-(r-d);y.current&&(w(!0),y.current.style.display="block",y.current.style.top=`${u}px`,y.current.style.left=`${h}px`);const g=document.elementsFromPoint(e.clientX,e.clientY).find(((e,t)=>e.id.includes("droppable")&&t>0));let m=Xx(e,g);const p=null==(s=y.current)?void 0:s.getBoundingClientRect().height;p&&f(h,l,u,p),bS(),(null==g?void 0:g.id)!==`${i}_${o}_droppable`&&(null!=g&&g.id.includes("droppable-space")&&(m=void 0),((e,t)=>{let n;vS.push(t),e===Wx.left&&(n=yS.tabLeft),e===Wx.right&&(n=yS.tabRight),void 0===e&&(n=yS.emptyTabSpace),n&&(null==t||t.classList.add(n))})(m,g))},onMouseUp(t,n){var o,i;if(bS(),vS.length=0,null==(o=v.current)||o.append(y.current),null!=(i=y.current)&&i.style&&(y.current.style.display="none",w(!1)),document.body.style.cursor="auto",!n||!b.current)return;b.current=!1;const{x:r,y:a,oX:l,oY:d,panelKey:c,tabIndex:u}=n,[m,p]=[t.pageX-(r-l),t.pageY-(a-d)],f=m<0?0:m,x=p-32,S=x<0?0:x,k=document.elementFromPoint(t.clientX,t.clientY);var C,j;if(null==(C=k)||null==(j=C.id)?void 0:j.includes("droppable")){const e=document.elementFromPoint(t.clientX,t.clientY),n=null==e?void 0:e.id;if(!n||null==n||!n.includes("droppable"))return;const o=n.split("_"),i=o[0],r=Number.parseInt(o[1]),a=Xx(t,e);if(u===r&&c===i||1===s&&c===i)return;a&&h(u,c,i,r,a)}else g(e,c,u,f,S)}},[]);const k=()=>(0,A.jsxs)(Qe.Sl,{id:`${i}_${o}_droppable`,name:"tab",mod:{active:d?o===c:a},children:[!d&&(0,A.jsx)(Qe.Sl,{name:"icon",tag:Qn.ORE}),n]});return(0,A.jsxs)(Qe.eB,{name:"panel-tabs",children:[(0,A.jsx)(Qe.Sl,{name:"draggable-tab",id:`${n}-draggable`,ref:v,children:(0,A.jsx)(k,{})}),(0,A.jsxs)(Qe.Sl,{ref:y,name:"ghost-tab",style:{width:`${l}px`,height:"fit-content",maxHeight:"300px",overflow:"hidden"},children:[(0,A.jsx)(k,{}),S&&(0,A.jsx)(Qe.Sl,{name:"contents",children:r})]})]})},SS=e=>{var t;const n=e.locked?e.panelViews[e.breakPointActiveTab].component:null==(t=e.panelViews)||null==(t=t.find((e=>e.active)))?void 0:t.component;return(0,A.jsx)(A.Fragment,{children:(0,A.jsxs)(Qe.eB,{name:"tabs",children:[(0,A.jsxs)(Qe.Sl,{name:"tabs-row",children:[e.panelViews.map(((t,n)=>{const{component:o}=t;return(0,A.jsx)(Qe.Sl,{name:"tab-container",mod:{active:t.active},children:(0,A.jsx)(xS,{name:t.name,rootRef:e.root,panelKey:e.name,tabIndex:n,active:t.active,tabTitle:t.title,panelWidth:e.width,viewLength:e.panelViews.length,locked:e.locked,transferTab:e.transferTab,createNewPanel:e.createNewPanel,setActiveTab:e.setActiveTab,checkSnap:e.checkSnap,breakPointActiveTab:e.breakPointActiveTab,setBreakPointActiveTab:e.setBreakPointActiveTab,children:(0,A.jsx)(Qe.Sl,{name:"content",children:(0,A.jsx)(o,Object.assign({},e,{name:"outliner"}),`${t.title}-${n}-ghost`)})},`${t.title}-tab`)},`${t.title}-${n}-tab`)})),(0,A.jsx)(Qe.Sl,{id:`${e.name}_${e.panelViews.length}-droppable-space`,name:"drop-space-after"})]}),(0,A.jsx)(Qe.Sl,{name:"contents",children:n&&(0,A.jsx)(n,Object.assign({},e))})]})})},wS=980,kS=(0,v.PA)((({currentEntity:e,panelsHidden:t,children:n,showComments:o,focusTab:i})=>{const s=e.regionStore,r=(0,m.useRef)({width:0,height:0}),a=Lx("screen and (max-width: 980px)"),[l,d]=(0,m.useState)(500),[c,u]=(0,m.useState)(!1),[h,g]=(0,m.useState)(!1),[p,f]=(0,m.useState)(!1),[v,y]=(0,m.useState)(!1),b=(0,m.useRef)(),[S,w]=(0,m.useState)(),k=(0,m.useMemo)((()=>rS(o)),[o]),[C,j]=(0,m.useState)(k.panelData),[R,_]=(0,m.useState)(k.collapsedSide),[T,K]=(0,m.useState)(0),E=(0,m.useRef)(S),P=(0,m.useRef)(R);P.current=R,E.current=S,Nx(e);const M=(0,m.useMemo)((()=>c||a.matches),[c,a.matches]),D=(0,m.useCallback)(((e,t)=>{j((n=>{const o=Object.assign({},n[e],t);return Object.assign({},n,{[e]:o})}))}),[C]),O=(0,m.useCallback)(((e,t,n,o,i)=>{j((s=>{const a=s[t].panelViews[e];a&&(a.active=!0);const l=Gx(s,t,e),d=((e,t,n,o,i,s)=>{const r=Object.assign({},e),a=r[n];a.panelViews=r[n].panelViews.map((e=>(e.active=!1,e)));let l=i+(s===Wx.right?1:0);return t===n&&l>0&&(l-=1),a.panelViews.splice(l,0,o),r})(Qx(l),t,n,a,o,i),c=pS(d,n),u=Jx(c),h=qx(u);return uS(h,r.current.height)})),w(void 0)}),[C]),I=(0,m.useCallback)(((e,t,n,o,i)=>{if(E.current){var s;const a=E.current.split("-"),l=a[0];if(null!=(s=P.current)&&s[l])return;const d="top"===a[1]?Ux.top:Ux.bottom,c=r.current.height;j((s=>{const a=mS(s,e,t,n,o,i,r);return gS(a,e,l,eb,c,d)}))}else j((s=>mS(s,e,t,n,o,i,r)));w(void 0)}),[C,R,R[Wx.left],R[Wx.right]]),L=(0,m.useCallback)(((e,t)=>j((n=>Zx(n,e,t)))),[C]),N=(0,m.useCallback)(((e,t)=>{j((n=>{const o=C[e],i=V(e,o.top,o.left,t),s=Object.assign({},n,{[e]:Object.assign({},o,{visible:t,storedTop:i.top/r.current.height*100,storedLeft:i.left/r.current.width*100})});return hS(s,r.current.height,o.alignment)}))}),[j,C]),z=(0,m.useCallback)(((e,t,n,o)=>{var i,s,a,l,d,c;const u=e+t,h=n+o,g=null!=(i=r.current.width)?i:0,m=null!=(s=r.current.height)?s:0,p=u>=g-((null==(a=Object.entries(C).find((([e,t])=>t.alignment===Wx.right)))?void 0:a[1].width)||0),f=e<=((null==(l=Object.entries(C).find((([e,t])=>t.alignment===Wx.left)))?void 0:l[1].width)||0),v=n<=5,y=h>=m-5;let b;null!=(d=P.current)&&d[Wx.left]||!f||(e<=5&&(b=$x.left),v&&(b=$x.topLeft),y&&(b=$x.bottomLeft)),null!=(c=P.current)&&c[Wx.right]||!p||(u>=g-5&&(b=$x.right),v&&(b=$x.topRight),y&&(b=$x.bottomRight)),w(b)}),[C]),V=(0,m.useCallback)(((e,t,n,o)=>{var i,s,r,a,l;const d=C[e],c=null!=(i=null==(s=b.current)?void 0:s.clientWidth)?i:0,u=(null!=o?o:d.visible)?d.height:ob,h=d.detached?u:d.height,g=d.height!==(null==(r=b.current)?void 0:r.clientHeight)&&d.detached?h:tb;return{left:(0,x.clamp)(n,0,c-d.width),top:(0,x.clamp)(t,0,(null!=(a=null==(l=b.current)?void 0:l.clientHeight)?a:0)-g)||1}}),[C]),H=(0,m.useCallback)((e=>{g((()=>!0)),j((t=>pS(t,e)))}),[C]),B=(0,m.useCallback)(((e,t,n,o)=>{const i=C[e],{left:s,top:a}=V(e,t,n,i.visible),l=r.current.height-a;p||C[e].detached||(f(!0),j((t=>((e,t,n)=>{const o=Object.assign({},e),i=o[t].alignment,s={width:eb,detached:!0,height:tb},r=Object.assign({},o,{[t]:Object.assign({},o[t],s)}),a=cS(o,i);return null==a||a.forEach(((e,t)=>{o[e].order=t})),hS(r,n,i)})(t,e,r.current.height)))),z(s,i.width,a,tb),requestAnimationFrame((()=>{D(e,{top:a,left:s,relativeTop:a/r.current.height*100,relativeLeft:s/r.current.width*100,storedLeft:void 0,storedTop:void 0,detached:o,zIndex:Object.keys(C).length+12,maxHeight:l,alignment:o?void 0:i.alignment})}))}),[D,z,C,p]),F=(0,m.useCallback)((()=>{g((()=>!0))}),[]),W=(0,m.useCallback)((()=>{g((()=>!1))}),[]),$=(0,m.useCallback)(((e,t,n)=>{requestAnimationFrame((()=>{j((o=>((e,t,n,o,i)=>{var s;const r=Object.assign({},e),a=cS(r,null==(s=r[t])?void 0:s.alignment),l=i;if(!a)return e;const d=n-r[t].height,c=a.filter((e=>r[e].visible)),u=(null==c?void 0:c.findIndex((e=>e===t)))-1;if(void 0===u)return e;const h=c[u];a.forEach((e=>{let s=r[e].height;e===t&&(s=n),e===h&&(s-=d),n<=55&&(n=55),r[e].visible&&(r[e]=Object.assign({},r[e],{relativeTop:o/i*100,storedLeft:void 0,storedTop:void 0,maxHeight:l,height:(0,x.clamp)(s,55,i)}))}));const g=a.filter((e=>!r[e].visible)).length*ob,m=a.filter((e=>r[e].visible)).reduce(((e,t)=>e+r[t].height),0);return uS(m+g>i?e:r,i)})(o,e,t,n,r.current.height)))}))}),[j]),U=(0,m.useCallback)((e=>Object.keys(C).filter((t=>{var n;return(null==(n=C[t])?void 0:n.alignment)===e}))),[C]),Y=(0,m.useCallback)(((e,t,n,o,i)=>{const{left:s,top:a}=V(e,o,i),d=r.current.height-a;requestAnimationFrame((()=>{var o;(C[e].detached?[e]:U(null==(o=C[e])?void 0:o.alignment)).forEach((e=>{D(e,{top:a,left:s,relativeTop:a/r.current.height*100,relativeLeft:s/r.current.width*100,storedLeft:void 0,storedTop:void 0,maxHeight:d,width:(0,x.clamp)(t,eb,l),height:C[e].detached?(0,x.clamp)(n,tb,nb):C[e].height}),w(void 0)}))}))}),[D,l,C]),G=(0,m.useCallback)((e=>{var t;if(f(!1),g((()=>!1)),!E.current)return;const n=E.current.split("-"),o=n[0],i="top"===n[1]?Ux.top:Ux.bottom,s=null==(t=cS(C,o))?void 0:t.filter((t=>t!==e));s&&s.length>0?j((t=>gS(t,e,o,eb,r.current.height,i))):D(e,{height:r.current.height,alignment:o,detached:!1}),w(void 0)}),[D,C]),Z=(0,m.useMemo)((()=>({onResize:Y,onGroupHeightResize:$,onResizeStart:F,onResizeEnd:W,onPositionChange:B,onVisibilityChange:N,onPositionChangeBegin:H,onSnap:G,transferTab:O,createNewPanel:I,setActiveTab:L,checkSnap:z,setBreakPointActiveTab:K})),[Y,$,F,W,B,N,G,O,I,L]),q=(0,m.useMemo)((()=>Object.assign({},Z,{root:b,regions:s,selection:s.selection,currentEntity:e})),[Z,s,s.selection,e]),J=(0,m.useMemo)((()=>{const e=lS(C),n=dS(C),o=e.every((e=>!C[e].visible)),i=n.every((e=>!C[e].visible)),{left:s,right:r}=R,a=e.length&&C[e[0]].width||0,l=n.length&&C[n[0]].width||0;return{paddingLeft:M||t?0:s?ob:o?0:a,paddingRight:M||t?0:r?ob:i?0:l}}),[t,C,R,M]),Q=(0,m.useMemo)((()=>{if(t)return{};const e={detached:[],left:[],right:[]},n=Object.entries(C);for(const[t,s]of n){var o,i;const{alignment:n,detached:r}=s,a=cS(C,n),d=Object.assign({},s,q,{name:t,top:null!=(o=s.storedTop)?o:s.top,left:null!=(i=s.storedLeft)?i:s.left,positioning:p,maxWidth:l,zIndex:s.zIndex,expanded:R[n],alignment:s.alignment,locked:M,attachedKeys:a,lockPanelContents:h,breakPointActiveTab:T,sidePanelCollapsed:R,setSidePanelCollapsed:_,dragTop:n===Wx.left?S===$x.topLeft:S===$x.topRight,dragBottom:n===Wx.left?S===$x.bottomLeft:S===$x.bottomRight});r?e.detached.push(d):"left"===n?e.left.push(d):"right"===n&&e.right.push(d)}return e}),[C,q,h,t,M,p,l,R,S]);(0,m.useEffect)((()=>{Object.keys(C).length&&((e,t)=>{window.localStorage.setItem("panelState",JSON.stringify({panelData:e,collapsedSide:t}))})(C,R)}),[C,R]),(0,m.useEffect)((()=>{if(i){const e=Object.assign({},C),t=((e,t)=>{var n;const o=Object.keys(e).find((e=>e.includes(t)))||"",i=null==(n=e[o])?void 0:n.panelViews.findIndex((e=>e.name===t));return i>=0?{panelName:o,tab:e[o].panelViews[i],panelViewIndex:i}:void 0})(e,i);if(!t)return;const{panelName:n,tab:o,panelViewIndex:s}=t,{alignment:r,detached:a,visible:l}=e[n];o.active||j(Zx(e,n,s)),!a&&R[r]&&_(Object.assign({},R,{[r]:!1})),l||N(n,!0)}}),[i]),(0,m.useEffect)((()=>{const e=b.current;if(!e)return;const t=()=>{var e,t;return(null!=(e=null==(t=b.current)?void 0:t.clientWidth)?e:0)<wS},n=new X((()=>{requestAnimationFrame((()=>{if(!b.current)return;const{clientWidth:e,clientHeight:n}=b.current;e<=wS||(r.current.height!==n&&j(uS(C,n)),r.current.width=null!=e?e:0,r.current.height=null!=n?n:0,u(t()),d(.4*b.current.clientWidth))}))}));return e&&(n.observe(e),u(t()),d(.4*e.clientWidth),y(!0)),()=>{e&&n.unobserve(e),n.disconnect()}}),[C]);const ee=(0,m.useMemo)((()=>({locked:M})),[]),te=(0,m.useMemo)((()=>{const e=Object.assign({},iS);return e.panelViews=iS.panelViews.filter((e=>"comments"!==e.name||o)),e}),[iS,o]),ne=Object.assign({},te,q,{breakPointActiveTab:T,setBreakPointActiveTab:K});return(0,A.jsx)(Cx.Provider,{value:ee,children:(0,A.jsx)(Qe.eB,{ref:e=>{e&&(b.current=e,u(e.clientWidth<=wS))},name:"sidepanels",mod:{collapsed:M},style:Object.assign({},J),children:v&&(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"content",mod:{resizing:h||p},children:n}),!0!==t&&M?(0,A.jsx)(A.Fragment,{children:(0,A.jsx)(Qe.Sl,{name:"wrapper",children:(0,A.jsx)(fS,Object.assign({},ne,{children:(0,A.jsx)(SS,Object.assign({},ne))}))})}):(0,A.jsx)(A.Fragment,{children:Object.entries(Q).map((([e,t],n)=>{const o=t.sort(((e,t)=>e.order-t.order)).map(((t,o)=>(0,A.jsx)(fS,Object.assign({},t,{children:(0,A.jsx)(SS,Object.assign({},t))}),`${e}-${o}-${n}`)));return"detached"===e?(0,A.jsx)(m.Fragment,{children:o},e):(0,A.jsx)(Qe.Sl,{name:"wrapper",mod:{align:e,snap:!h&&S===e&&void 0!==S},children:o},e)}))})]})})})}));var CS=n(49589),jS=n(57958),RS=n(8593);const _S=["date"],TS=6e4,AS=[[3e4,3e4],[267e4,TS],[Number.MAX_SAFE_INTEGER,18e5]];const KS=e=>{let{date:t}=e,n=(0,Zn.A)(e,_S);const[o,i]=(0,m.useState)(Date.now()),s=(0,m.useMemo)((()=>new Date(t).valueOf()),[t]),r=(0,m.useRef)(),a=(0,m.useCallback)((()=>{const e=Date.now()-s,t=function(e=0){const t=AS.findIndex((([t],n)=>t>e||n===AS.length-1)),n=t>0?AS[t-1][0]:0,o=AS[t][1];return Math.ceil((e-n+1)/o)*o+n}(e);r.current=window.setTimeout((()=>{i(Date.now())}),t-e)}),[t]);(0,m.useEffect)((()=>(a(),()=>{clearTimeout(r.current)})),[t,o]);const l="less than a minute ago"===(0,jS.A)(s,{addSuffix:!0})?"seconds ago":(0,jS.A)(s,{addSuffix:!0});return(0,A.jsx)("time",Object.assign({dateTime:(0,RS.default)(s,"yyyy-MM-dd'T'HH:mm:ss.SSSxxx"),title:(0,RS.default)(s,"PPpp")},n,{children:l}))},{Block:ES,Elem:PS}=(0,Qe.JE)();class MS extends m.Component{constructor(e){var t;super(e),this.modalRef=(0,m.createRef)(),this.onClickOutside=e=>{const t=(0,Qe.cn)("modal"),{closeOnClickOutside:n}=this.props,o=this.modalRef.current.contains(e.target),i=t.elem("content").closest(e.target),s=t.elem("close").closest(e.target);(o&&s||null===i&&!1!==n)&&this.hide()},this.state={title:e.title,body:e.body,footer:e.footer,visible:!e.animateAppearance&&(null!=(t=e.visible)&&t),transition:e.visible?"visible":null}}componentDidMount(){this.props.animateAppearance&&setTimeout((()=>this.show()),30)}setBody(e){this.setState({body:e})}show(e){var t=this;return new Promise((n=>{this.setState({visible:!0},(async function(){null==e||e(),null==t.props.onShow||t.props.onShow(),await t.transition("appear",n)}))}))}async hide(e){return new Promise((t=>{this.transition("disappear",(()=>{this.setState({visible:!1},(()=>{var n,o;null==(n=(o=this.props).onHide)||n.call(o),t(),null==e||e()}))}))}))}render(){if(!this.state.visible)return null;const e=this.props.bare,t={fullscreen:!!this.props.fullscreen,bare:this.props.bare,visible:this.props.visible||this.state.visible},n=[this.transitionClass,this.props.className],o=(0,A.jsx)(ES,{name:"modal",ref:this.modalRef,mod:t,mix:n,onClick:this.onClickOutside,children:(0,A.jsx)(PS,{name:"wrapper",children:(0,A.jsxs)(PS,{name:"content",style:this.props.style,children:[!e&&(0,A.jsxs)(MS.Header,{children:[(0,A.jsx)(PS,{name:"title",children:this.state.title}),!1!==this.props.allowClose&&(0,A.jsx)(PS,{tag:Po,name:"close",type:"text",style:{color:"0099FF"},icon:(0,A.jsx)(To.CA7,{})})]}),(0,A.jsx)(PS,{name:"body",mod:{bare:e},children:this.body}),this.state.footer&&(0,A.jsx)(MS.Footer,{children:this.state.footer})]})})});return(0,h.createPortal)(o,document.body)}transition(e,t){var n=this;return(0,Ih.P)(this.modalRef.current,{transition:async function(){return new Promise((t=>{n.setState({transition:e},(()=>{t()}))}))},beforeTransition:async function(){return new Promise((t=>{n.setState({transition:`before-${e}`},(()=>{t()}))}))},afterTransition:async function(){return new Promise((o=>{n.setState({transition:"appear"===e?"visible":null},(()=>{null==t||t(),o()}))}))}})}get transitionClass(){switch(this.state.transition){case"before-appear":return"before-appear";case"appear":return"appear before-appear";case"before-disappear":return"before-disappear";case"disappear":return"disappear before-disappear";case"visible":return"visible"}return null}get body(){if(this.state.body){const e=this.state.body;return e instanceof Function?(0,A.jsx)(e,{}):e}return this.props.children}}MS.Header=({children:e,divided:t})=>(0,A.jsx)(PS,{name:"header",mod:{divided:t},children:e}),MS.Footer=({children:e})=>(0,A.jsx)(PS,{name:"footer",children:e});const DS=["okText","onOk","cancelText","onCancel","buttonLook"],OS=["okText","onOkPress"],IS=e=>{const t=(0,m.createRef)(),n=document.createElement("div");n.className=(0,Qe.cn)("modal-holder").toClassName(),document.body.appendChild(n);const o=(e,o)=>{(0,h.render)((0,A.jsx)(MS,Object.assign({ref:t},e,{onHide:()=>{null==e.onHidden||e.onHidden(),n.remove()},animateAppearance:o})),n)};return o(e,!0),{update(t){o(Object.assign({},e,null!=t?t:{}),!1)},close(){t.current.hide()}}},LS=e=>{let{okText:t,onOk:n,cancelText:o,onCancel:i,buttonLook:s}=e,r=(0,Zn.A)(e,DS);const a=IS(Object.assign({},r,{allowClose:!1,footer:(0,A.jsxs)(Oo,{align:"end",children:[(0,A.jsx)(Po,{onClick:()=>{null==i||i(),a.close()},size:"compact",autoFocus:!0,children:null!=o?o:"Cancel"}),(0,A.jsx)(Po,{onClick:()=>{null==n||n(),a.close()},size:"compact",look:null!=s?s:"primary",children:null!=t?t:"OK"})]})}));return a};Object.assign(MS,{info:e=>{let{okText:t,onOkPress:n}=e,o=(0,Zn.A)(e,OS);const i=IS(Object.assign({},o,{footer:(0,A.jsx)(Oo,{align:"end",children:(0,A.jsx)(Po,{onClick:()=>{null==n||n(),i.close()},look:"primary",size:"compact",children:null!=t?t:"OK"})})}));return i},confirm:LS,modal:IS});const NS=e=>e.unresolved_comment_count>0?"Unresolved Comments":e.comment_count>0?"All Comments Resolved":"",zS=(0,v.WQ)((({store:e})=>({store:e}))),VS=(0,v.PA)((({entity:e,capabilities:t,annotationStore:n,onAnnotationChange:o})=>{var i,s,r,a,l;const d="prediction"===e.type,c=(0,CS.Jf)(null!=(i=e.user)?i:{firstName:e.createdBy||"Admin"}),[u,h]=(0,m.useState)(),g=null==(s=n.store)?void 0:s.hasInterface("annotations:hide-info");let p=null;if(g){var f;const t=n.store.user;p={email:(null==(f=e.user)?void 0:f.id)===t.id||e.createdBy===t.email?"Me":"User"}}const y=(b=e).unresolved_comment_count>0?To.qLl:b.comment_count>0?To.f31:null;var b;(0,m.useEffect)((()=>{h(e.ground_truth)}),[e,e.ground_truth]);const x=(0,m.useCallback)((()=>{const{selected:t,id:o,type:i}=e;t||("prediction"===i?n.selectPrediction(o):n.selectAnnotation(o))}),[e]),S=zS((0,v.PA)((({entity:e,capabilities:t,store:i})=>{const s=(0,m.useMemo)((()=>{const t=new URL(window.location.href);return e.pk&&t.searchParams.set("annotation",e.pk),t.searchParams.delete("region"),t.toString()}),[e.pk]),[r]=(0,nx.s)(s),a=(0,Qn.djX)(),l=Fh(),d=()=>{null==o||o(),null==l||l.close()},c=(0,m.useCallback)((()=>{e.setGroundTruth(!u),d()}),[e]),h=(0,m.useCallback)((()=>{const t=n.addAnnotationFromPrediction(e);window.setTimeout((()=>{n.selectAnnotation(t.id),d()}))}),[e]),g=(0,m.useCallback)((()=>{r(),null==l||l.close(),a.show({message:"Annotation link copied to clipboard",type:Qn.CkR.info})}),[e,r]),p=(0,m.useCallback)((()=>{d(),LS({title:"Delete annotation?",body:(0,A.jsxs)(A.Fragment,{children:["This will ",(0,A.jsx)("strong",{children:"delete all existing regions"}),". Are you sure you want to delete them?",(0,A.jsx)("br",{}),"This action cannot be undone."]}),buttonLook:"destructive",okText:"Delete",onOk:()=>{e.list.deleteAnnotation(e)}})}),[e]),f="prediction"===e.type,v=!(0,CS.O9)(e.pk),y=t.groundTruthEnabled&&!f&&!v,b=t.enableCreateAnnotation&&!v,x=(0,m.useMemo)((()=>[{label:(u?"Unset ":"Set ")+" as Ground Truth",onClick:c,icon:u?(0,A.jsx)(To.aGI,{color:"#FFC53D",width:32,height:32}):(0,A.jsx)(To.gkI,{width:32,height:32}),enabled:y},{label:"Duplicate Annotation",onClick:h,icon:(0,A.jsx)(To.FEH,{width:20,height:20}),enabled:b},{label:"Copy Annotation Link",onClick:g,icon:(0,A.jsx)(To.AXG,{}),enabled:!v&&i.hasInterface("annotations:copy-link")},{label:"Delete Annotation",onClick:p,icon:(0,A.jsx)(To.Wus,{}),separator:!0,danger:!0,enabled:t.enableAnnotationDelete&&!f}]),[e,u,f,v,t.enableAnnotationDelete,t.enableCreateAnnotation,t.groundTruthEnabled]);return(0,A.jsx)(sx,{actions:x})})));return(0,A.jsxs)(Qe.eB,{name:"annotation-button",mod:{selected:e.selected},children:[(0,A.jsxs)(Qe.Sl,{name:"mainSection",onClick:x,children:[(0,A.jsx)(Qe.Sl,{name:"picSection",children:(0,A.jsx)(Qe.Sl,{name:"userpic",tag:Qn.an1,showUsername:!0,username:d?e.createdBy:null,user:null!=(r=null!=(a=p)?a:e.user)?r:{email:e.createdBy},mod:{prediction:d},size:24,children:d&&(0,A.jsx)(To.ccx,{style:{width:18,height:18}})})}),(0,A.jsxs)(Qe.Sl,{name:"main",children:[(0,A.jsxs)(Qe.Sl,{name:"user",children:[(0,A.jsx)(Qe.Sl,{tag:"span",name:"name",children:p?p.email:c}),!g&&(0,A.jsxs)(Qe.Sl,{tag:"span",name:"entity-id",children:["#",null!=(l=e.pk)?l:e.id]})]}),!g&&(0,A.jsxs)(Qe.Sl,{name:"info",children:[(0,A.jsx)(Qe.Sl,{name:"date",component:KS,date:e.createdDate}),d&&(0,CS.O9)(e.score)&&(0,A.jsxs)("span",{title:`Prediction score = ${e.score}`,children:["  "," ",(100*e.score).toFixed(2),"%"]})]})]}),!d&&(0,A.jsxs)(Qe.Sl,{name:"icons",children:[e.draftId>0&&(0,A.jsx)(Qn.m_M,{title:"Draft",children:(0,A.jsx)(Qe.Sl,{name:"icon",mod:{draft:!0},children:(0,A.jsx)(To.jrm,{color:"#617ADA"})})}),e.skipped&&(0,A.jsx)(Qn.m_M,{title:"Skipped",children:(0,A.jsx)(Qe.Sl,{name:"icon",mod:{skipped:!0},children:(0,A.jsx)(To.f0x,{color:"#DD0000"})})}),u&&(0,A.jsx)(Qn.m_M,{title:"Ground-truth",children:(0,A.jsx)(Qe.Sl,{name:"icon",mod:{groundTruth:!0},children:(0,A.jsx)(To.h1n,{})})}),y&&(0,A.jsx)(Qn.m_M,{title:NS(e),children:(0,A.jsx)(Qe.Sl,{name:"icon",mod:{comments:!0},children:(0,A.jsx)(y,{})})})]})]}),(0,A.jsx)(rx,{className:(0,Qe.cn)("annotation-button").elem("trigger").toClassName(),content:(0,A.jsx)(S,{entity:e,capabilities:t,annotationStore:n})})]})})),HS=(0,v.PA)((({store:e,annotationStore:t})=>{const[n,o]=(0,m.useState)([]),i=e.hasInterface("annotations:tabs"),s=e.hasInterface("predictions:tabs"),r=e.hasInterface("annotations:add-new"),a=e.hasInterface("ground-truth"),l=e.hasInterface("annotations:delete"),d=(0,m.useRef)(),c=(0,m.useRef)(),[u,h]=(0,m.useState)(0),[g,p]=(0,m.useState)(!1),[f,v]=(0,m.useState)(!1),y=(0,m.useCallback)(((e,t=!0)=>{if(c.current&&d.current){const e=c.current.clientWidth,n=d.current.clientWidth,o=(0,x.clamp)(t?u-e:u+e,0,n-e);h(o)}}),[c,d,u]);return(0,m.useEffect)((()=>{var e,t,n,o;p(u<=0),v(u>=(null!=(e=null==(t=d.current)?void 0:t.clientWidth)?e:0)-(null!=(n=null==(o=c.current)?void 0:o.clientWidth)?n:0))}),[n.length,c.current,d.current,u,window.innerWidth,window.innerHeight]),(0,m.useEffect)((()=>{const e=[];s&&e.push(...t.predictions),i&&e.push(...t.annotations),o(e)}),[t,JSON.stringify(t.predictions),JSON.stringify(t.annotations)]),i||s||r?(0,A.jsxs)(Qe.eB,{name:"annotations-carousel",style:{"--carousel-left":`${u}px`},children:[(0,A.jsx)(Qe.Sl,{ref:c,name:"container",children:(0,A.jsx)(Qe.Sl,{ref:d,name:"carosel",children:(0,x.sortAnnotations)(n).map((e=>(0,A.jsx)(VS,{entity:e,capabilities:{enablePredictions:s,enableCreateAnnotation:r,groundTruthEnabled:a,enableAnnotations:i,enableAnnotationDelete:l},annotationStore:t},null==e?void 0:e.id)))})}),(!g||!f)&&(0,A.jsxs)(Qe.Sl,{name:"carousel-controls",children:[(0,A.jsx)(Qe.Sl,{tag:Po,name:"nav",disabled:g,mod:{left:!0,disabled:g},"aria-label":"Carousel left",onClick:e=>!g&&y(e,!0),children:(0,A.jsx)(Qe.Sl,{name:"arrow",mod:{left:!0},tag:Qn.Vh6})}),(0,A.jsx)(Qe.Sl,{tag:Po,name:"nav",disabled:f,mod:{right:!0,disabled:f},"aria-label":"Carousel right",onClick:e=>!f&&y(e,!1),children:(0,A.jsx)(Qe.Sl,{name:"arrow",mod:{right:!0},tag:Qn.Vh6})})]})]}):null})),BS=(0,v.PA)((({entity:e})=>{const{history:t}=e;return(0,A.jsxs)(Qe.eB,{name:"history-buttons",children:[(0,A.jsx)(Qn.m_M,{title:"Undo",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",type:"text","aria-label":"Undo",disabled:!(null!=t&&t.canUndo),onClick:()=>e.undo(),icon:(0,A.jsx)(To.GFc,{})})}),(0,A.jsx)(Qn.m_M,{title:"Redo",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",type:"text","aria-label":"Redo",disabled:!(null!=t&&t.canRedo),onClick:()=>e.redo(),icon:(0,A.jsx)(To.cHj,{})})}),(0,A.jsx)(Qn.m_M,{title:"Reset",children:(0,A.jsx)(Qe.Sl,{tag:Po,name:"action",look:"danger",type:"text","aria-label":"Reset",disabled:!(null!=t&&t.canUndo),onClick:()=>null==t?void 0:t.reset(),icon:(0,A.jsx)(To.CA7,{})})})]})})),FS=({store:e})=>{const t=e.annotationStore,n=t.selected,o=!n.userGenerate||n.sentUserGenerate,i="prediction"===(null==n?void 0:n.type),s=t.viewingAll,r=(0,j.VS)(j.U2)&&!R()&&e.hasInterface("annotation:bulk"),a=(0,m.useCallback)((()=>{t.toggleViewingAllAnnotations()}),[t]);return(0,A.jsxs)(Qe.Sl,{name:"section",children:[e.hasInterface("annotations:view-all")&&!r&&(0,A.jsx)(Qn.m_M,{title:"Compare all annotations",children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.M7M,{}),type:"text","aria-label":"Compare all annotations",onClick:()=>a(),primary:s,style:{height:36,width:36,padding:0}})}),!s&&!r&&e.hasInterface("ground-truth")&&(0,A.jsx)(bv,{entity:n}),!i&&!s&&e.hasInterface("edit-history")&&(0,A.jsx)(BS,{entity:n}),!s&&!r&&e.hasInterface("annotations:delete")&&(0,A.jsx)(Qn.m_M,{title:"Delete annotation",children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.Eau,{}),look:"danger",type:"text","aria-label":"Delete",onClick:()=>{LS({title:"Delete annotation",body:"This action cannot be undone",buttonLook:"destructive",okText:"Proceed",onOk:()=>n.list.deleteAnnotation(n)})},style:{height:36,width:36,padding:0}})}),!s&&!r&&e.hasInterface("annotations:add-new")&&o&&(0,A.jsx)(Qn.m_M,{title:`Create copy of current ${n.type}`,children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.bzS,{style:{width:36,height:36}}),size:"small",look:"ghost",type:"text","aria-label":"Copy Annotation",onClick:t=>{t.preventDefault();const o=e.annotationStore.addAnnotationFromPrediction(n);window.setTimeout((()=>{e.annotationStore.selectAnnotation(o.id)}),50)},style:{height:36,width:36,padding:0}})}),(0,A.jsx)(Po,{icon:(0,A.jsx)(To.Ni9,{}),type:"text","aria-label":"Settings",onClick:()=>e.toggleSettings(),style:{height:36,width:36,padding:0}}),e.description&&e.hasInterface("instruction")&&!r&&(0,A.jsx)(Po,{icon:(0,A.jsx)(To.G_L,{style:{width:16,height:16}}),primary:e.showingDescription,type:"text","aria-label":"Instructions",onClick:()=>e.toggleDescription(),style:{height:36,width:36,padding:0}})]})},WS=["entity","selected","onClick","extra"],$S=(0,v.PA)((({store:e,annotationStore:t,commentStore:n})=>{const o=(0,m.useRef)(),[i,s]=(0,m.useState)(!1),r=e.hasInterface("annotations:tabs"),a=e.hasInterface("predictions:tabs"),l=e.hasInterface("annotations:add-new"),d=e.hasInterface("ground-truth"),u=[];a&&u.push(...t.predictions),r&&u.push(...t.annotations);const h=(0,m.useCallback)(((e,n)=>{e.selected||(n?t.selectPrediction(e.id):t.selectAnnotation(e.id))}),[t]);(0,m.useEffect)((()=>{const e=e=>{const t=e.target,n=o.current;t===n||null!=n&&n.contains(t)||s(!1)};document.addEventListener("click",e);const t=(0,c.mJ)((()=>[...n.comments.map((e=>e.isResolved))]),(e=>{let t=0,o=0;e.forEach((e=>{o++,e||t++})),n.annotation.setUnresolvedCommentCount(t),n.annotation.setCommentCount(o)}));return()=>{document.removeEventListener("click",e),t()}}),[]);const g=e=>e.unresolved_comment_count>0?(0,A.jsx)(To.QV6,{}):e.comment_count>0?(0,A.jsx)(To.RU_,{}):null,p=(e,n)=>{var o;return(0,A.jsx)(YS,{entity:e,"aria-label":`${e.type} ${n+1}`,selected:e===t.selected,onClick:t=>{t.preventDefault(),t.stopPropagation(),s(!1),null==h||h(e,"prediction"===e.type)},extra:(0,A.jsxs)(Qe.Sl,{name:"icons",children:[(0,A.jsx)(Qe.Sl,{name:"icon-column",children:g(e)}),(0,A.jsx)(Qe.Sl,{name:"icon-column",children:d&&(0,A.jsx)(bv,{entity:e,disabled:!0})})]})},`${null!=(o=e.pk)?o:e.id}${e.type}`)};return r||a||l?(0,A.jsx)(Qe.Sl,{name:"section",mod:{flat:!0},children:(0,A.jsxs)(Qe.eB,{name:"annotations-list",ref:o,children:[(0,A.jsx)(Qe.Sl,{name:"selected",children:(0,A.jsx)(YS,{"aria-label":"Annotations List Toggle",entity:t.selected,onClick:e=>{e.stopPropagation(),s(!i)},extra:u.length>0?(0,A.jsxs)(Oo,{size:"none",style:{marginRight:-8,marginLeft:8},children:[(0,A.jsxs)(Qe.Sl,{name:"counter",children:[u.indexOf(t.selected)+1,"/",u.length]}),(0,A.jsx)(Qe.Sl,{name:"toggle",mod:{opened:i}})]}):null})}),i&&(0,A.jsxs)(Qe.Sl,{name:"list",children:[e.hasInterface("annotations:add-new")&&(0,A.jsx)(US,{annotationStore:t,onClick:()=>s(!1)}),(e=>{const t=[],n=[];return e.forEach(((e,o)=>{e.pk?n.push(p(e,o)):t.push(p(e,o))})),(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)(Qe.Sl,{name:"draft",children:t}),(0,A.jsx)(Qe.Sl,{name:"annotation",children:n})]})})(u)]})]})}):null})),US=(0,v.PA)((({annotationStore:e,onClick:t})=>{const n=(0,m.useCallback)((()=>{const n=e.createAnnotation();e.selectAnnotation(n.id),t()}),[e,t]);return(0,A.jsx)(Qe.Sl,{name:"create","aria-label":"Create Annotation",onClick:n,children:(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsx)(Qe.Sl,{name:"userpic",tag:Qn.an1,mod:{prediction:!0},children:(0,A.jsx)(To.KSs,{})}),"Create Annotation"]})})})),YS=(0,v.PA)((e=>{var t,n,o;let{entity:i,selected:s,onClick:r,extra:a}=e,l=(0,Zn.A)(e,WS);const d="prediction"===i.type,c=(0,x.userDisplayName)(null!=(t=i.user)?t:{firstName:i.createdBy||"Admin"});return(0,A.jsx)(Qe.Sl,Object.assign({},l,{name:"entity",mod:{selected:s},onClick:r,children:(0,A.jsxs)(Oo,{spread:!0,children:[(0,A.jsxs)(Oo,{size:"small",children:[(0,A.jsx)(Qe.Sl,{name:"userpic",tag:Qn.an1,showUsername:!0,username:d?i.createdBy:null,user:null!=(n=i.user)?n:{username:c},mod:{prediction:d},children:d&&(0,A.jsx)(To.ccx,{color:"#944BFF",style:{width:18,height:18}})}),(0,A.jsxs)(Oo,{direction:"vertical",size:"none",children:[(0,A.jsxs)(Qe.Sl,{name:"user",children:[(0,A.jsx)(Qe.Sl,{tag:"span",name:"name",children:c}),(0,A.jsxs)(Qe.Sl,{tag:"span",name:"entity-id",children:["#",null!=(o=i.pk)?o:i.id]})]}),(0,x.isDefined)(i.acceptedState)?(0,A.jsx)(Qe.Sl,{name:"review",mod:{state:i.acceptedState},children:i.acceptedState}):(0,A.jsxs)(Qe.Sl,{name:"created",children:["created, ",(0,A.jsx)(Qe.Sl,{name:"date",component:KS,date:i.createdDate})]})]})]}),a]})}))})),XS=(0,v.WQ)("store")((0,v.PA)((({store:e,title:t,children:n})=>(0,A.jsx)(Qn.m_M,{title:t,disabled:!e.settings.enableTooltips,children:n})))),GS=(0,v.WQ)((({store:e})=>{var t;return{store:e,history:null==e||null==(t=e.annotationStore)||null==(t=t.selected)?void 0:t.history}})),ZS=GS((0,v.PA)((({store:e,history:t,annotation:n})=>{const o=e.hasInterface("review"),i=(0,x.isDefined)(e.annotationStore.selectedHistory),{userGenerate:s,sentUserGenerate:r,versions:a,results:l,editable:d}=n,c=[],[u,h]=(0,m.useState)(!1),g=!d||e.isSubmitting||i||u,p=e.hasInterface("annotations:deny-empty")&&0===l.length,f=(0,m.useCallback)((async(t,n,o)=>{const{addedCommentThisSession:i,currentComment:s,commentFormSubmit:r,inputRef:a}=e.commentStore;if(!u){if(h(!0),!a.current||i)n();else if((null!=s?s:"").trim())t.preventDefault(),await r(),n();else{const t=a.current;e.commentStore.setTooltipMessage(o),t.scrollIntoView({behavior:"smooth"}),t.focus({preventScroll:!0})}h(!1)}}),[e.rejectAnnotation,e.skipTask,e.commentStore.currentComment,e.commentStore.inputRef,e.commentStore.commentFormSubmit,e.commentStore.addedCommentThisSession,u]),v=(0,m.useMemo)((()=>(0,A.jsx)(XS,{title:"Reject annotation: [ Ctrl+Space ]",children:(0,A.jsx)(Po,{"aria-label":"reject-annotation",disabled:g,look:"danger",onClick:async t=>{var n;null==(n=e.hasInterface("comments:reject"))||n?f(t,(()=>e.rejectAnnotation({})),"Please enter a comment before rejecting"):(console.log("rejecting"),await e.commentStore.commentFormSubmit(),e.rejectAnnotation({}))},children:"Reject"})},"reject")),[g,e]);if(o)c.push(v),c.push((0,A.jsx)(XS,{title:"Accept annotation: [ Ctrl+Enter ]",children:(0,A.jsx)(Po,{"aria-label":"accept-annotation",disabled:g,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.acceptAnnotation()},children:t.canUndo?"Fix + Accept":"Accept"})},"accept"));else if(n.skipped)c.push((0,A.jsxs)(Qe.Sl,{name:"skipped-info",children:[(0,A.jsx)(To.r7P,{color:"#d00"})," Was skipped"]},"skipped")),c.push((0,A.jsx)(XS,{title:"Cancel skip: []",children:(0,A.jsx)(Po,{"aria-label":"cancel-skip",disabled:g,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.unskipTask()},children:"Cancel skip"})},"cancel-skip"));else{if(e.hasInterface("skip")&&c.push((0,A.jsx)(XS,{title:"Cancel (skip) task: [ Ctrl+Space ]",children:(0,A.jsx)(Po,{"aria-label":"skip-task",disabled:g,look:"danger",onClick:async t=>{var n;null==(n=e.hasInterface("comments:skip"))||n?f(t,(()=>e.skipTask({})),"Please enter a comment before skipping"):(await e.commentStore.commentFormSubmit(),e.skipTask({}))},children:"Skip"})},"skip")),s&&!r||e.explore&&!s&&e.hasInterface("submit")){const t=p?"Empty annotations denied in this project":"Save results: [ Ctrl+Enter ]";c.push((0,A.jsx)(XS,{title:t,children:(0,A.jsx)(Qe.Sl,{name:"tooltip-wrapper",children:(0,A.jsx)(Po,{"aria-label":"submit",disabled:g||p,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.submitAnnotation()},children:"Submit"})})},"submit"))}if(s&&r||!s&&e.hasInterface("update")){const t=r||a.result,n=(0,A.jsx)(XS,{title:"Update this task: [ Alt+Enter ]",children:(0,A.jsx)(Po,{"aria-label":"submit",disabled:g||p,look:"primary",onClick:async()=>{await e.commentStore.commentFormSubmit(),e.updateAnnotation()},children:t?"Update":"Submit"})},"update");c.push(n)}}return(0,A.jsx)(Qe.eB,{name:"controls",children:c})}))),qS=(0,v.PA)((({store:e})=>{var t;const n=(0,m.useMemo)((()=>e.taskHistory.findIndex((t=>t.taskId===e.task.id))+1),[e.taskHistory]),[o,i]=(0,m.useState)(0),[s,r]=(0,m.useState)(0);(0,m.useEffect)((()=>{e.commentStore.setAddedCommentThisSession(!1);const t=(0,c.mJ)((()=>e.commentStore.comments.map((e=>e.isDeleted))),(e=>{r(e.filter((e=>!e)).length)}));return()=>{null==t||t()}}),[]),(0,m.useEffect)((()=>{e.commentStore.addedCommentThisSession&&i(s)}),[e.commentStore.addedCommentThisSession]);const a=e.hasInterface("topbar:prevnext"),l=e.hasInterface("topbar:task-counter");let d=!(0,x.isDefined)(e.annotationStore.selected.pk)&&(!(0,j.VS)(j.JO)||e.hasInterface("skip"))&&!e.canGoNextTask&&!e.hasInterface("review")&&e.hasInterface("postpone");return e.hasInterface("annotations:comments")&&(0,j.VS)(j.ow)&&(d=d&&e.commentStore.addedCommentThisSession&&s>=o),(0,A.jsx)(Qe.Sl,{name:"section",children:(0,A.jsxs)(Qe.eB,{name:"current-task",mod:{"with-history":a},style:{padding:(0,j.VS)(j.bA)&&0,width:(0,j.VS)(j.bA)&&"auto"},children:[(0,A.jsxs)(Qe.Sl,{name:"task-id",style:{fontSize:(0,j.VS)(j.bA)?12:14},children:[null!=(t=e.task.id)?t:T(),a&&l&&((0,j.VS)(j.P2)?(0,A.jsxs)(Qe.Sl,{name:"task-count",children:[e.queuePosition," of ",e.queueTotal]}):(0,A.jsxs)(Qe.Sl,{name:"task-count",children:[n," of ",e.taskHistory.length]}))]}),a&&(0,A.jsxs)(Qe.Sl,{name:"history-controls",mod:{newui:(0,j.VS)(j.bA)},children:[(0,A.jsx)(Qe.Sl,{tag:Po,name:"prevnext",mod:{prev:!0,disabled:!e.canGoPrevTask,newui:(0,j.VS)(j.bA)},type:"link",disabled:!a||!e.canGoPrevTask,onClick:e.prevTask,style:{background:!(0,j.VS)(j.bA)&&"none",backgroundColor:(0,j.VS)(j.bA)&&"none"}}),(0,A.jsx)(Qe.Sl,{tag:Po,name:"prevnext","data-testid":"next-task",mod:{next:!0,disabled:!e.canGoNextTask&&!d,postpone:!e.canGoNextTask&&d,newui:(0,j.VS)(j.bA)},type:"link",disabled:!e.canGoNextTask&&!d,onClick:e.canGoNextTask?e.nextTask:e.postponeTask,style:{background:!(0,j.VS)(j.bA)&&"none",backgroundColor:(0,j.VS)(j.bA)&&"none"}})]})]})})})),JS=(0,v.PA)((({store:e})=>{const t=e.annotationStore,n=null==t?void 0:t.selected,o="prediction"===(null==n?void 0:n.type),i=!0===(null==t?void 0:t.viewingAll),s=(0,j.VS)(j.U2)&&!R()&&e.hasInterface("annotation:bulk");return(0,j.VS)(j.bA)&&s?null:e?(0,A.jsx)(Qe.eB,{name:"topbar",mod:{newLabelingUI:(0,j.VS)(j.bA)},children:(0,j.VS)(j.bA)?(0,A.jsxs)(Qe.Sl,{name:"group",children:[(0,A.jsx)(qS,{store:e}),e.hasInterface("annotations:view-all")&&(0,A.jsx)(Qn.m_M,{title:"Compare all annotations",children:(0,A.jsx)(Po,{className:"topbar__button",icon:(0,A.jsx)(To.M7M,{width:20,height:20}),type:i?void 0:"text","aria-label":"Compare all annotations",onClick:t.toggleViewingAllAnnotations,primary:i,size:"medium",style:{height:28,width:28,padding:0,marginRight:"var(--spacing-tight, 8px)"}})}),e.hasInterface("annotations:add-new")&&(0,A.jsx)(Qn.m_M,{title:"Create a new annotation",style:{"--offset-x":"11px"},children:(0,A.jsx)(Po,{icon:(0,A.jsx)(To.uID,{}),className:"topbar__button",type:i?void 0:"text","aria-label":"Create an annotation",onClick:t=>{t.preventDefault();const n=e.annotationStore.createAnnotation();e.annotationStore.selectAnnotation(n.id)},style:{height:28,width:28,padding:0,marginRight:"var(--spacing-tight, 8px)"}})}),!i&&(0,A.jsx)(HS,{store:e,annotationStore:e.annotationStore,commentStore:e.commentStore})]}):(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(Qe.Sl,{name:"group",children:[!s&&(0,A.jsx)(qS,{store:e}),!i&&!s&&(0,A.jsx)($S,{store:e,annotationStore:e.annotationStore,commentStore:e.commentStore}),(0,A.jsx)(FS,{store:e})]}),(0,A.jsxs)(Qe.Sl,{name:"group",children:[!i&&(0,A.jsx)(Qe.Sl,{name:"section",children:(0,A.jsx)(mv,{})}),!i&&e.hasInterface("controls")&&(e.hasInterface("review")||!o)&&(0,A.jsx)(Qe.Sl,{name:"section",mod:{flat:!0},style:{width:320,boxSizing:"border-box"},children:(0,A.jsx)(ZS,{annotation:n})})]})]})}):null}));class QS extends m.Component{constructor(...e){super(...e),this.relationsRef=m.createRef(),this._notifyScroll=()=>{this.relationsRef.current&&this.relationsRef.current.onResize()}}componentDidMount(){window.blur(),document.body.focus()}renderSuccess(){return(0,A.jsx)(Qe.eB,{name:"editor",children:(0,A.jsx)(p.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.DONE})})}renderNoAnnotation(){return(0,A.jsx)(Qe.eB,{name:"editor",children:(0,A.jsx)(p.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.NO_COMP_LEFT})})}renderNothingToLabel(e){return(0,A.jsxs)(Qe.eB,{name:"editor",style:{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",paddingBottom:"30vh"},children:[(0,A.jsx)(p.Ay,{status:"success",title:(0,u._$)(this.props.store).messages.NO_NEXT_TASK}),(0,A.jsx)(Qe.eB,{name:"sub__result",children:"All tasks in the queue have been completed"}),e.taskHistory.length>0&&(0,A.jsx)(Po,{onClick:t=>e.prevTask(t,!0),look:"outlined",style:{margin:"16px 0"},children:"Go to Previous Task"})]})}renderNoAccess(){return(0,A.jsx)(Qe.eB,{name:"editor",children:(0,A.jsx)(p.Ay,{status:"warning",title:(0,u._$)(this.props.store).messages.NO_ACCESS})})}renderConfigValidationException(e){return(0,A.jsxs)(Qe.eB,{name:"main-view",children:[(0,A.jsx)(Qe.Sl,{name:"annotation",children:(0,A.jsx)(Pe,{errors:this.props.store.annotationStore.validation})}),!(0,j.VS)(j.bA)&&e.hasInterface("infobar")&&(0,A.jsxs)(Qe.Sl,{name:"infobar",children:["Task #",e.task.id]})]})}renderLoader(){return(0,A.jsx)(p.Ay,{icon:(0,A.jsx)(f.A,{size:"large"})})}_renderAll(e){if(1===e.length)return(0,A.jsx)(dy,{annotation:e[0],children:[L.renderItem(e[0].root)]});const t=cn("renderall").toClassName(),n=cn("fade").toClassName();return(0,A.jsx)("div",{className:t,children:e.map(((e,t)=>(0,A.jsx)("div",{className:n,children:(0,A.jsx)(dy,{annotation:e,children:[L.renderItem(e.root)]})},`all-${t}`)))})}_renderUI(e,t){var n,o;return t.viewingAll?this.renderAllAnnotations():(0,A.jsxs)(Qe.eB,{name:"main-view",onScrollCapture:this._notifyScroll,children:[(0,A.jsxs)(Qe.Sl,{name:"annotation",children:[(0,A.jsx)(hv,{root:e,annotation:t.selected}),this.renderRelations(t.selected),(0,j.VS)(j.v1)&&this.renderCommentsOverlay(t.selected)]}),!(0,j.VS)(j.bA)&&(0,u.Zn)(t).hasInterface("infobar")&&this._renderInfobar(t)]},null==(n=null!=(o=t.selectedHistory)?o:t.selected)?void 0:n.id)}_renderInfobar(e){const{id:t,queue:n}=(0,u.Zn)(e).task;return(0,A.jsxs)(Qe.Sl,{name:"infobar",tag:Oo,size:"small",children:[(0,A.jsxs)("span",{children:["Task #",t]}),n&&(0,A.jsx)("span",{children:n})]})}renderAllAnnotations(){const e=this.props.store.annotationStore,t=[...e.annotations,...e.predictions];return(0,j.VS)(j.F5)&&(0,x.sortAnnotations)(t),(0,A.jsx)(Hv,{store:e,annotations:t,root:e.root})}renderRelations(e){var t;const n=e.relationStore,o=null==(t=this.props.store.task)?void 0:t.data;return(0,A.jsx)(ay,{store:n,ref:this.relationsRef,tags:e.names,taskData:o},T())}renderCommentsOverlay(e){const{store:t}=this.props,{commentStore:n}=t;return t.hasInterface("annotations:comments")&&n.isCommentable?(0,A.jsx)(_e,{commentStore:n,annotation:e}):null}render(){var e,t,n,o;const{store:i}=this.props,s=i.annotationStore,r=s.selected&&s.selected.root,{settings:a}=i;if(i.isLoading)return this.renderLoader();if(i.noTask)return this.renderNothingToLabel(i);if(i.noAccess)return this.renderNoAccess();if(i.labeledSuccess)return this.renderSuccess();if(!r)return this.renderNoAnnotation();const l=s.viewingAll,d=(0,A.jsx)(Qe.eB,{name:"main-content",mix:i.awaitingSuggestions?["requesting"]:[],children:null===s.validation?this._renderUI(null!=(e=null==(t=s.selectedHistory)?void 0:t.root)?e:r,s):this.renderConfigValidationException(i)}),c=(0,j.VS)(j.U2)&&!R()&&i.hasInterface("annotation:bulk"),u=(0,j.VS)(j.bA);return(0,A.jsxs)(Qe.eB,{name:"editor",mod:{fullscreen:a.fullscreen},ref:(0,j.VS)(j.SM)?cv(this):null,children:[(0,A.jsx)(jy,{store:i}),(0,A.jsx)(v.Kq,{store:i,children:(0,A.jsxs)(uv.tE,{children:[u?(0,A.jsx)(Bv,{visible:i.showingDescription,onCancel:()=>i.toggleDescription(),title:i.hasInterface("review")?"Review Instructions":"Labeling Instructions",children:i.description}):(0,A.jsx)(A.Fragment,{children:i.showingDescription&&(0,A.jsx)(dy,{children:(0,A.jsx)("div",{dangerouslySetInnerHTML:{__html:(0,Ke.sanitizeHtml)(i.description)}})})}),(0,x.isDefined)(i)&&i.hasInterface("topbar")&&(0,A.jsx)(JS,{store:i}),(0,A.jsx)(Qe.eB,{name:"wrapper",mod:{viewAll:l,bsp:a.bottomSidePanel,showingBottomBar:u},children:u?c?(0,A.jsxs)(A.Fragment,{children:[d,i.hasInterface("topbar")&&(0,A.jsx)(Av,{store:i})]}):(0,A.jsxs)(kS,{panelsHidden:l,currentEntity:null!=(n=s.selectedHistory)?n:s.selected,regions:s.selected.regionStore,showComments:i.hasInterface("annotations:comments"),focusTab:i.commentStore.tooltipMessage?"comments":null,children:[d,i.hasInterface("topbar")&&(0,A.jsx)(Av,{store:i})]}):c?d:(0,A.jsx)(Fx,{panelsHidden:l,currentEntity:null!=(o=s.selectedHistory)?o:s.selected,regions:s.selected.regionStore,children:d})}),(0,A.jsx)(uv.US,{})]})}),i.hasInterface("debug")&&(0,A.jsx)(Pv,{store:i})]})}}const ew=(0,v.PA)(QS),tw={CONFIG:class{static validate(e){const t=[];pr(e,null,[],t);const n=["id","children","name","toname","controlledTags","parentTypes"],o=[];for(const e of t)try{const i=b.getModelByTag(e.type),s=fr(e,i);null!==s&&o.push(s);const r=vr(e,i,t);null!==r&&o.push(r);const a=yr(e,i);null!==a&&o.push(a),o.push(...xr(e)),o.push(...br(e,i,n))}catch(t){o.push(mr.unknownTag(e.type,e.name,e.type))}return o.length?o.map((e=>{return Object.assign({},e,{validType:(t=e.validType,t?((e,t=!0)=>{const n=e.describe().match(/([a-z0-9?|]+)/gi).join("").split("|");if(!1===t){const e=n.indexOf("null?");e>=0&&n.splice(e,1)}return n})(t,!1):null)});var t})):[]}},RESULT:{validate:()=>[]}},nw=Object.keys(tw).reduce(((e,t)=>Object.assign({},e,{[t]:t})),{}),ow=u.gK.union(u.gK.string,u.gK.array(u.gK.string)),iw=u.gK.model({modelName:u.gK.string,field:u.gK.string,error:u.gK.string,value:u.gK.maybeNull(u.gK.string),validType:u.gK.maybeNull(ow)}).views((e=>({get identifier(){return[e.modelName,e.field,e.error,e.value].concat(e.validType).filter((e=>null!==e)).join("-")}})));class sw{constructor(){this.callbacks=new Set}addErrorCallback(e){return!this.callbacks.has(e)&&(this.callbacks.add(e),!0)}removeErrorCallback(e){return!!this.callbacks.has(e)&&(this.callbacks.delete(e),!0)}validate(e,t){const n=tw[e];let o=[];var i;n?o=(null!=(i=n.validate(t))?i:[]).map((e=>{try{return iw.create(e)}catch(t){throw console.log({compiledError:e}),t}})):console.error(`Unknown validator: ${e}`);setTimeout((()=>{if(o.length)for(const e of this.callbacks)e(o)}),0)}}const rw=u.gK.model("StoreExtender",{sharedStores:u.gK.optional(u.gK.map(Jm),{})}).actions((e=>({addSharedStore(t){e.sharedStores.set(t.id,t)},beforeReset(){e.sharedStores.forEach((e=>{(0,u.Yo)(e)})),e.sharedStores.clear()},afterReset(){Qm.forEach((t=>{e.addSharedStore(t)}))},beforeDestroy(){e.sharedStores.forEach((e=>{(0,u.Yo)(e),(0,u.zr)(e)})),e.sharedStores.clear()}}))),aw=u.gK.compose("HistoryItem",tm,u.gK.model({comment:u.gK.optional(u.gK.maybeNull(u.gK.string),null),actionType:u.gK.optional(u.gK.maybeNull(u.gK.string),null)})).preProcessSnapshot((e=>{var t,n;return Object.assign({},e,{pk:T(),user:e.created_by,createdDate:e.created_at,actionType:null!=(t=null!=(n=e.action)?n:e.action_type)?t:e.actionType,readonly:!0,editable:!1})})),lw=u.gK.union(tm,aw),dw=u.gK.model("AnnotationStore",{selected:u.gK.maybeNull(u.gK.reference(lw)),selectedHistory:u.gK.maybeNull(u.gK.safeReference(lw)),root:Le.allModelsTypes(),names:u.gK.map(u.gK.reference(Le.allModelsTypes())),toNames:u.gK.map(u.gK.array(u.gK.reference(Le.allModelsTypes()))),annotations:u.gK.array(tm),predictions:u.gK.array(tm),history:u.gK.array(aw),viewingAllAnnotations:u.gK.optional(u.gK.boolean,!1),validation:u.gK.maybeNull(u.gK.array(iw))}).volatile((()=>({initialized:!1}))).views((e=>({get store(){return(0,u.Zn)(e)},get viewingAll(){return e.viewingAllAnnotations}}))).actions((e=>{function t(t,n,o=!0){e.viewingAllAnnotations=!1,e._unselectAll();const i=n.find((e=>e.id===t||e.pk===String(t)))||n[0];return i?(i.selected=!0,o&&(e.selectedHistory=null,e.history=[]),e.selected=i,i.updateObjects(),"annotation"===i.type&&i.setInitialValues(),i):null}function n(n,o={}){if(!e.annotations.length)return null;const{selected:i}=e,s=t(n,e.annotations,!o.retainHistory);return s.editable=!0,s.setupHotKeys(),(0,u._$)(e).events.invoke("selectAnnotation",s,i,null!=o?o:{}),s.pk&&(0,u.PA)(e).addAnnotationToTaskHistory(s.pk),s}function o(t){return t&&e.addErrors([mr.generalError(t)]),e.root=Zf.create({id:"error"})}function i(t){if(e.root)return;if(!t)return e.root=Zf.create({id:"empty"});let n;try{n=L.treeToModel(t,e.store)}catch(e){return console.error(e),o(e)}const i=b.getModelByTag(n.type),s=b.objectTypes().map((e=>e.name.replace("Model","").toLowerCase())),r=[];e.validate(nw.CONFIG,n);try{e.root=i.create(n)}catch(e){return console.error(e),o(e)}if((0,j.VS)(j.cE)){const{names:t,toNames:n}=L.extractNames(e.root);return t.forEach((t=>e.names.put(t))),n.forEach(((t,n)=>e.toNames.set(n,t))),L.traverseTree(e.root,(t=>{e.store.task&&t.updateValue&&t.updateValue(e.store)})),e.initialized=!0,e.root}return L.traverseTree(e.root,(t=>{null!=t&&t.name&&(e.addName(t),s.includes(t.type)&&r.push(t.name));t.name&&!s.includes(t.type)&&!t.toname&&1===r.length&&(t.toname=r[0]),t&&t.toname&&e.upsertToName(t),e.store.task&&t.updateValue&&t.updateValue(e.store)})),e.initialized=!0,e.root}function s(t){var n;const{user:o,config:s}=e.store;e.root||i(s);let r=t.pk||t.id;var a;"annotation"===t.type&&r&&isNaN(r)&&(r=null==(a=e.annotations)||null==(a=a[e.annotations.length-1])||null==(a=a.storedValue)?void 0:a.pk);const l=Object.assign({userGenerate:!1,createdDate:sn.UDate.currentISODate()},t,{id:T(5),pk:r&&String(r),root:null!=(n=t.root)?n:e.root});return o&&!("createdBy"in l)&&(l.createdBy=o.displayName),t.user&&(l.user=t.user),l}const r=t=>{e.addErrors(t)};return{afterCreate:()=>{e._validator=new sw,e._validator.addErrorCallback(r)},beforeDestroy:()=>{e._validator.removeErrorCallback(r)},toggleViewingAllAnnotations:function(){e.viewingAllAnnotations=!e.viewingAllAnnotations,e.viewingAllAnnotations?(e.selected&&("annotation"===e.selected.type&&e.selected.saveDraftImmediately(),e.selected.unselectAll(),e.selected.selected=!1),(0,j.VS)(j.F5)&&[...e.predictions,...e.annotations].forEach((t=>{t!==e.selected&&t.updateObjects()})),e.annotations.forEach((e=>{e.editable=!1}))):n(e.annotations.at((0,j.VS)(j.F5)?-1:0).id,{fromViewAll:!0})},initRoot:i,addToName:function(t){e.toNames.set(t.toname,[t.name])},addName:function(t){e.names.put(t)},upsertToName:function(t){const n=e.toNames.get(t.toname);n?n.push(t.name):e.addToName(t)},addPrediction:function(t={}){t.editable=!1,t.type="prediction";const n=s(t);return(0,j.VS)(j.F5)?(e.predictions.push(n),e.predictions.at(-1)):(e.predictions.unshift(n),e.predictions[0])},addAnnotation:function(t={}){t.type="annotation";const n=s(t);if(n.userGenerate){var o,i,r;let t;if((0,j.VS)(j.K3)){const o=(0,x.emailFromCreatedBy)(n.createdBy),i=o&&e.store.users.find((e=>e.email===o));i&&(t=i.id)}n.completed_by=null!=(o=null!=(i=t)?i:null==(r=(0,u.Zn)(e).user)?void 0:r.id)?o:void 0}(0,j.VS)(j.F5)?e.annotations.push(n):e.annotations.unshift(n);const a=e.annotations.at((0,j.VS)(j.F5)?-1:0);return a.addVersions({result:t.result,draft:t.draft}),a},createAnnotation:function(t={userGenerate:!0}){const o=e.predictions.reduce(((e,t)=>[...e,...t._initialAnnotationObj.filter((e=>!1===e.interactive_mode)).map((e=>Object.assign({},e)))]),[]),i=e.addAnnotation(Object.assign({},t,{result:o}));if(o&&o.length){const e={};o.forEach((t=>{if("id"in t){const n=t.id.replace(/#.*$/,`#${i.id}`);e[t.id]=n,t.id=n}})),o.forEach((t=>{t.parent_id&&(e[t.parent_id]?t.parent_id=e[t.parent_id]:t.parent_id=null)})),n(i.id),i.deserializeAnnotation(o),i.reinitHistory()}else i.setDefaultValues();return i},addAnnotationFromPrediction:function(t){const o=t._initialAnnotationObj.map((e=>Object.assign({},e))),i=e.addAnnotation({userGenerate:!0,result:o}),s={};return o.forEach((e=>{if("id"in e){const t=e.id.replace(/#.*$/,`#${i.id}`);s[e.id]=t,e.id=t}})),o.forEach((e=>{e.parent_id&&(s[e.parent_id]?e.parent_id=s[e.parent_id]:e.parent_id=null)})),n(i.id),i.deserializeAnnotation(o),i.reinitHistory(),t.pk&&("prediction"===t.type?i.parent_prediction=Number.parseInt(t.pk):"annotation"===t.type&&(i.parent_annotation=Number.parseInt(t.pk))),i},addHistory:function(t={}){t.type="history",(0,j.VS)(j.cE)&&(t.root=e.selected.root);const n=s(t);return e.history.push(n),e.history[e.history.length-1]},clearHistory:function(){e.history.forEach((e=>(0,u.zr)(e))),e.history.length=0},selectHistory:function(t){e.selectedHistory=t,setTimeout((()=>{const n=null!=t?t:e.selected;Array.from(n.names.values()).filter((e=>e.isClassificationTag)).forEach((e=>e.updateFromResult([]))),null==n||n.results.filter((e=>e.area.classification)).forEach((e=>null==e.from_name.updateFromResult?void 0:e.from_name.updateFromResult(e.mainValue)))})),(0,u._$)(e).events.invoke("selectHistory",e.store,e.selected,e.selectedHistory)},addErrors:t=>{var n;const o=[],i=[...null!=(n=e.validation)?n:[],...t].reduce(((e,t)=>{const n=t.identifier;return o.indexOf(n)<0&&(o.push(n),e.push(t)),e}),[]);e.validation=i},validate:(t,n)=>e._validator.validate(t,n),selectAnnotation:n,selectPrediction:function(n){return t(n,e.predictions)},_selectItem:function(t){e._unselectAll(),t.editable=!1,t.selected=!0,e.selected=t,t.updateObjects()},_unselectAll:function(){e.selected&&(e.selected.unselectAll(),e.selected.selected=!1)},deleteAnnotation:function(t){(0,u._$)(e).events.invoke("deleteAnnotation",e.store,t),(0,u.zr)(t),e.clearDeletedParents(t),e.selected=null,e.annotations.length>0&&e.selectAnnotation(e.annotations[0].id)},clearDeletedParents:function(t){null!=t&&t.pk&&e.annotations.forEach((e=>{e.parent_annotation&&+e.parent_annotation==+t.pk&&(e.parent_annotation=null)}))},resetAnnotations:()=>{e.selected=null,e.selectedHistory=null,e.annotations=[],e.predictions=[],e.history=[]}}})),cw=u.gK.compose("AnnotationStore",dw,rw),uw=u.gK.model("Project",{id:u.gK.identifierNumber}).views((e=>({get app(){return(0,u.PA)(e)}}))),hw="SIDEPANEL_MODE_REGIONS",gw="SIDEPANEL_MODE_LABELS",mw=u.gK.model("SettingsModel",{enableHotkeys:u.gK.optional(u.gK.boolean,!0),enablePanelHotkeys:u.gK.optional(u.gK.boolean,!0),enableTooltips:u.gK.optional(u.gK.boolean,!1),enableLabelTooltips:u.gK.optional(u.gK.boolean,!0),continuousLabeling:!1,selectAfterCreate:!1,fullscreen:u.gK.optional(u.gK.boolean,!1),bottomSidePanel:u.gK.optional(u.gK.boolean,!1),sidePanelMode:u.gK.optional(u.gK.enumeration([hw,gw]),hw),imageFullSize:u.gK.optional(u.gK.boolean,!1),enableAutoSave:u.gK.optional(u.gK.boolean,!1),showLabels:u.gK.optional(u.gK.boolean,!1),showLineNumbers:!1,showAnnotationsPanel:u.gK.optional(u.gK.boolean,!0),showPredictionsPanel:u.gK.optional(u.gK.boolean,!0),preserveSelectedTool:u.gK.optional(u.gK.boolean,!0),enableSmoothing:u.gK.optional(u.gK.boolean,!0),videoHopSize:u.gK.optional(u.gK.number,10),isDestroying:u.gK.optional(u.gK.boolean,!1)}).views((e=>({get annotation(){return(0,u.Zn)(e).annotationStore.selected},get displayLabelsByDefault(){return e.sidePanelMode===gw}}))).actions((e=>({beforeDestroy(){e.isDestroying=!0},afterCreate(){try{const{localStorage:e}=window;if(!e)return}catch(e){return}const t="labelStudio:settings",n=localStorage.getItem(t);if(n){const t=JSON.parse(n);"object"==typeof t&&null!==t&&Object.keys(t).forEach((n=>{n in e&&(e[n]=t[n])}))}else{const t=(0,u._$)(e);Object.keys(uy).map((n=>{"boolean"==typeof t.settings[n]?e[n]=t.settings[n]:e[n]=uy[n].defaultValue}))}(0,u.aQ)(e,(n=>{setTimeout((()=>{e.isDestroying||localStorage.setItem(t,JSON.stringify(n))}))}))},toggleShowLabels(){e.showLabels=!e.showLabels,sn.HTML.toggleLabelsAndScores(e.showLabels)},toggleShowLineNumbers(){e.showLineNumbers=!e.showLineNumbers},toggleContinuousLabeling(){e.continuousLabeling=!e.continuousLabeling},toggleSelectAfterCreate(){e.selectAfterCreate=!e.selectAfterCreate},toggleSidepanelModel(){e.sidePanelMode=e.sidePanelMode===gw?hw:gw,e.annotation.regionStore.setView(e.displayLabelsByDefault?"labels":"regions")},toggleAutoSave(){e.enableAutoSave=!e.enableAutoSave},togglepreserveSelectedTool(){e.preserveSelectedTool=!e.preserveSelectedTool},toggleHotkeys(){e.enableHotkeys=!e.enableHotkeys,e.enableHotkeys?go.setScope(go.DEFAULT_SCOPE):go.setScope("__none__")},togglePanelHotkeys(){e.enablePanelHotkeys=!e.enablePanelHotkeys},toggleTooltips(){e.enableTooltips=!e.enableTooltips},toggleFullscreen(){e.fullscreen=!e.fullscreen},toggleBottomSP(){e.bottomSidePanel=!e.bottomSidePanel},toggleImageFS(){e.imageFullSize=!e.imageFullSize},toggleLabelTooltips(){e.enableLabelTooltips=!e.enableLabelTooltips},toggleAnnotationsPanel(){e.showAnnotationsPanel=!e.showAnnotationsPanel},togglePredictionsPanel(){e.showPredictionsPanel=!e.showPredictionsPanel},toggleSmoothing(){e.enableSmoothing=!e.enableSmoothing},setSmoothing(t){e.enableSmoothing=t},setVideoHopSize(t){e.videoHopSize=t},setProperty(t,n){e[t]=n}}))),pw=u.gK.model({enable:u.gK.optional(u.gK.boolean,!1),username:u.gK.string,password:u.gK.string,to:u.gK.string}),fw=u.gK.model("Task",{id:u.gK.maybeNull(u.gK.number),load:u.gK.optional(u.gK.boolean,!1),auth:u.gK.maybeNull(pw),data:u.gK.maybeNull(u.gK.string),queue:u.gK.optional(u.gK.maybeNull(u.gK.string),null)}).views((e=>({get app(){return(0,u.PA)(e)},get dataObj(){return sn.Checkers.isStringJSON(e.data)?JSON.parse(e.data):"object"==typeof e.data?e.data:null}}))),vw=u.gK.model({controls:u.gK.frozen({})}).actions((e=>({addLabel(t,n){var o;const i={path:n,origin:"session"},s=[...null!=(o=e.controls[t])?o:[],i];e.controls=Object.assign({},e.controls,{[t]:s})},deleteLabel(t,n){if(!e.controls[t])return;const o=e.controls[t].filter((e=>e.path.length!==n.length||!e.path.every(((e,t)=>e===n[t]))));e.controls=Object.assign({},e.controls,{[t]:o})},init(t){const n={};for(const e in t)n[e]=t[e].map((e=>({origin:"user",path:e})));e.controls=n}}))),yw=u.gK.model("CustomButton",{id:u.gK.optional(u.gK.identifier,T),name:u.gK.string,title:u.gK.string,look:u.gK.maybe(u.gK.enumeration(["primary","danger","destructive","alt","outlined","active","disabled"])),tooltip:u.gK.maybe(u.gK.string),ariaLabel:u.gK.maybe(u.gK.string),disabled:u.gK.maybe(u.gK.boolean),props:u.gK.maybe(u.gK.frozen())}).actions((e=>({updateState(t){for(const n in t)n in e&&(e[n]=t[n])}}))),bw=go("AppStore","Global Hotkeys"),xw=u.gK.model("AppStore",{config:u.gK.string,task:u.gK.maybeNull(fw),project:u.gK.maybeNull(uw),taskHistory:u.gK.array(u.gK.model({taskId:u.gK.number,annotationId:u.gK.maybeNull(u.gK.string)}),[]),interfaces:u.gK.array(u.gK.string),explore:u.gK.optional(u.gK.boolean,!1),annotationStore:u.gK.optional(cw,{annotations:[],predictions:[],history:[]}),commentStore:u.gK.optional(Dg,{comments:[]}),user:u.gK.optional(u.gK.maybeNull(u.gK.safeReference(Ag)),null),debug:!0===window.HTX_DEBUG,settings:u.gK.optional(mw,{}),description:u.gK.maybeNull(u.gK.string),showingSettings:u.gK.optional(u.gK.boolean,!1),showingDescription:u.gK.optional(u.gK.boolean,!1),isLoading:u.gK.optional(u.gK.boolean,!1),isSubmitting:!1,noTask:u.gK.optional(u.gK.boolean,!1),noAccess:u.gK.optional(u.gK.boolean,!1),labeledSuccess:u.gK.optional(u.gK.boolean,!1),showComments:!1,_autoAnnotation:!1,_autoAcceptSuggestions:!1,awaitingSuggestions:!1,users:u.gK.optional(u.gK.array(Ag),[]),userLabels:(0,j.VS)(j.RI)?u.gK.optional(vw,{controls:{}}):u.gK.undefined,queueTotal:u.gK.optional(u.gK.number,0),queuePosition:u.gK.optional(u.gK.number,0),commentClassificationConfig:u.gK.maybeNull(u.gK.string),customButtons:u.gK.map(u.gK.union(u.gK.string,yw,u.gK.array(u.gK.union(u.gK.string,yw))))}).preProcessSnapshot((e=>{if("number"!=typeof e.user){var t,n,o;const s=null!=(t=null!=(n=e.user)?n:null==(o=window.APP_SETTINGS)?void 0:o.user)?t:null;var i;if(s)e.user=s.id,e.users=null!=(i=e.users)&&i.length?[s,...e.users.filter((({id:e})=>e!==s.id))]:[s]}return Array.isArray(e.customButtons)&&(e.customButtons={_replace:e.customButtons}),Object.assign({},e,{_autoAnnotation:"true"===localStorage.getItem("autoAnnotation"),_autoAcceptSuggestions:"true"===localStorage.getItem("autoAcceptSuggestions")})})).volatile((()=>({version:"string"==typeof LSF_VERSION?LSF_VERSION:"0.0.0",initialized:!1,hydrated:!1,suggestionsRequest:null,simpleInit:(0,j.VS)(j.F5)}))).views((e=>({get events(){return(0,u._$)(e).events},get hasSegmentation(){return Array.from(e.annotationStore.names.values()).some((e=>!e.getAvailableStates&&!e.perRegionVisible))},get canGoNextTask(){if(e.task&&e.taskHistory&&e.taskHistory.length>1){const t=e.taskHistory[e.taskHistory.length-1].taskId;return e.task.id!==t}return!1},get canGoPrevTask(){if(e.task&&e.taskHistory&&e.taskHistory.length>1){const t=e.taskHistory[0].taskId;return e.task.id!==t}return!1},get forceAutoAnnotation(){return(0,u._$)(e).forceAutoAnnotation},get forceAutoAcceptSuggestions(){return(0,u._$)(e).forceAutoAcceptSuggestions},get autoAnnotation(){return e.forceAutoAnnotation||e._autoAnnotation},get autoAcceptSuggestions(){return e.forceAutoAcceptSuggestions||e._autoAcceptSuggestions}}))).actions((e=>{let t;function n(e,t="warning"){yn[t](e)}function o(t,o="Error during submit"){if(e.isSubmitting)return;e.setFlags({isSubmitting:!0});const i=t();e.commentStore.setAddedCommentThisSession(!1),Promise.race([Promise.all([i,(0,x.delay)(200)]),(0,x.delay)(5e3)]).catch((e=>{n((null==e?void 0:e.message)||e||o),console.error(e)})).then((()=>e.setFlags({isSubmitting:!1})))}return{setFlags:function(t){const n=["showingSettings","showingDescription","isLoading","isSubmitting","noTask","noAccess","labeledSuccess","awaitingSuggestions"];for(const o of n)o in t&&(e[o]=t[o])},addInterface:function(t){return e.interfaces.push(t)},hasInterface:function(...t){return void 0!==e.interfaces.find((e=>t.includes(e)))},toggleInterface:function(t,n){const o=e.interfaces.indexOf(t);if(null!=n?n:o<0)o<0&&e.interfaces.push(t);else{if(o<0)return;e.interfaces.splice(o,1)}},afterCreate:function(){od.setRoot(e),window.Htx=e,e.attachHotkeys(),(0,u._$)(e).events.invoke("labelStudioLoad",e)},assignTask:function(t){t&&!sn.Checkers.isString(t.data)&&(t=Object.assign({},t,{data:JSON.stringify(t.data)})),e.task=fw.create(t),e.taskHistory.some((t=>t.taskId===e.task.id))||e.taskHistory.push({taskId:e.task.id,annotationId:null})},assignConfig:function(t){const n=e.annotationStore;e.config=t,n.initRoot(e.config)},resetState:function(){od.removeAllTools(),go.unbindAll(),e.attachHotkeys();const t=e.annotationStore;t&&(null==t.beforeReset||t.beforeReset(),(0,j.VS)(j.C8)&&ip(),(0,u.Yo)(t),(0,u.zr)(t)),e.annotationStore=cw.create({annotations:[]}),e.initialized=!1},resetAnnotationStore:function(){const t=e.annotationStore;t&&(null==t.beforeReset||t.beforeReset(),null==t.resetAnnotations||t.resetAnnotations())},initializeStore:function({annotations:n=[],completions:o=[],predictions:i=[],annotationHistory:s}){const r=e.annotationStore;var a,l;if(null==r.afterReset||r.afterReset(),r.initialized||(r.initRoot(e.config),!(0,j.VS)(j.SM)||null!=(a=t)&&a.isRendered()||null==(l=t)||l.render()),e.simpleInit){window.STORE_INIT_OK=!1,i.forEach((e=>{const t=r.addPrediction(e),n=e.result.map((e=>Object.assign({},e,{origin:"prediction"})));t.deserializeResults(n,{hidden:!0})})),[...o,...n].forEach((e=>{r.addAnnotation(e).deserializeResults(e.draft||e.result,{hidden:!0})})),window.STORE_INIT_OK=!0,console.log("LSF: deserialization is finished");const e=r.annotations.at(-1),t=!e&&r.predictions.at(-1);e?(r.selectAnnotation(e.id),e.reinitHistory()):t&&r.selectPrediction(t.id)}else{var d;(null!=i?i:[]).forEach((e=>{const t=r.addPrediction(e);r.selectPrediction(t.id),t.deserializeResults(e.result.map((e=>Object.assign({},e,{origin:"prediction"}))))})),null==(d=[...null!=o?o:[],...null!=n?n:[]])||d.forEach((e=>{const t=r.addAnnotation(e);r.selectAnnotation(t.id),t.deserializeResults(e.draft||e.result),t.reinitHistory()}));const t=r.annotations.at(-1);t&&t.setInitialValues(),e.setHistory(s)}e.initialized||(e.initialized=!0,(0,u._$)(e).events.invoke("storageInitialized",e))},setHistory:function(t=[]){var n;const o=e.annotationStore;o.clearHistory(),t.length&&null!=(n=o.selected)&&n.pk&&Number(o.selected.pk)===Number(t[0].annotation_id)&&(null!=t?t:[]).forEach((e=>{var t;o.addHistory(e).deserializeResults(null!=(t=e.result)?t:[],{hidden:!0})}))},attachHotkeys:function(){bw.unbindAll(),e.hasInterface("submit","update","review")&&bw.addNamed("annotation:submit",(()=>{const t=e.annotationStore,n=e.hasInterface("annotations:deny-empty"),o=t.selected,i=0===o.results.length,s=e.hasInterface("review")||o.canBeReviewed,r=!s&&(0,x.isDefined)(o.pk),a=!o.history.canUndo&&!o.draftId,l=(0,j.VS)(j.I8)&&r&&a;n&&i||t.viewingAll||l||o.isReadOnly()||(null==o||o.submissionInProgress(),s?e.acceptAnnotation():!r&&e.hasInterface("submit")?e.submitAnnotation():e.hasInterface("update")&&e.updateAnnotation())})),e.hasInterface("skip","review")&&bw.addNamed("annotation:skip",(()=>{if(e.annotationStore.viewingAll)return;const t=e.annotationStore.selected;null==t||t.submissionInProgress(),e.hasInterface("review")?e.rejectAnnotation():e.skipTask()})),bw.addNamed("region:delete-all",(()=>{const{selected:t}=e.annotationStore;window.confirm((0,u._$)(e).messages.CONFIRM_TO_DELETE_ALL_REGIONS)&&t.deleteAllRegions()})),bw.addNamed("region:relation",(()=>{const t=e.annotationStore.selected;t&&t.highlightedNode&&!t.isLinkingMode&&t.startLinkingMode(F,t.highlightedNode)})),bw.addNamed("region:focus",(t=>{t.preventDefault();const n=e.annotationStore.selected;n&&n.highlightedNode&&!n.isLinkingMode&&n.highlightedNode.requestPerRegionFocus()})),bw.addNamed("region:unselect",(()=>{const t=e.annotationStore.selected;!t||t.isLinkingMode||t.isDrawing||(e.annotationStore.history.forEach((e=>{e.unselectAll()})),t.unselectAll())})),bw.addNamed("region:visibility",(()=>{const t=e.annotationStore.selected;t&&!t.isLinkingMode&&t.hideSelectedRegions()})),bw.addNamed("region:visibility-all",(()=>{const{selected:t}=e.annotationStore;t.regionStore.toggleVisibility()})),bw.addNamed("annotation:undo",(()=>{const t=e.annotationStore.selected;t.isDrawing||t.undo()})),bw.addNamed("annotation:redo",(()=>{const t=e.annotationStore.selected;t.isDrawing||t.redo()})),bw.addNamed("region:exit",(()=>{const t=e.annotationStore.selected;t&&t.isLinkingMode?t.stopLinkingMode():t.isDrawing||t.unselectAll()})),bw.addNamed("region:delete",(()=>{const t=e.annotationStore.selected;t&&t.deleteSelectedRegions()})),bw.addNamed("region:cycle",(()=>{const t=e.annotationStore.selected;t&&t.regionStore.selectNext()})),bw.addNamed("region:duplicate",(t=>{const{selected:n}=e.annotationStore,{serializedSelection:o}=n||{};if(null==o||!o.length)return;t.preventDefault();const i=n.appendResults(o);n.selectAreas(i)}))},skipTask:function(t){e.isSubmitting||o((()=>{(0,u._$)(e).events.invoke("skipTask",e,t),e.incrementQueuePosition()}),"Error during skip, try again")},unskipTask:function(){e.isSubmitting||o((()=>{(0,u._$)(e).events.invoke("unskipTask",e)}),"Error during cancel skipping task, try again")},setTaskHistory:function(t){e.taskHistory=t},submitDraft:function(t,n={}){return new Promise((o=>{const i=(0,u._$)(e).events;if(!i.hasEvent("submitDraft"))return o();const s=i.invokeFirst("submitDraft",e,t,n);s&&s.then?s.then(o):o(s)}))},waitForDraftSubmission:function(){return new Promise((t=>{e.annotationStore.selected.isDraftSaving||t();const n=setInterval((()=>{e.annotationStore.selected.isDraftSaving||(clearInterval(n),t())}),100)}))},submitAnnotation:function(){if(e.isSubmitting)return;const t=e.annotationStore.selected,n=t.exists?"updateAnnotation":"submitAnnotation";t.beforeSend(),t.validate()&&((0,j.VS)(j.Bg)||t.sendUserGenerate(),o((async()=>{if((0,j.VS)(j.Bg)){await e.waitForDraftSubmission();const o=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,t,{event:n});if(o&&o.some((e=>!1===e)))return;t.sendUserGenerate()}await(0,u._$)(e).events.invoke(n,e,t),e.incrementQueuePosition(),(0,j.VS)(j.Bg)&&t.dropDraft()})),(0,j.VS)(j.Bg)||t.dropDraft())},updateAnnotation:function(t){if(e.isSubmitting)return;const n=e.annotationStore.selected;n.beforeSend(),n.validate()&&(o((async()=>{if((0,j.VS)(j.Bg)){const t=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,n,{event:"updateAnnotation"});if(t&&t.some((e=>!1===e)))return}await(0,u._$)(e).events.invoke("updateAnnotation",e,n,t),e.incrementQueuePosition(),(0,j.VS)(j.Bg)&&(n.dropDraft(),!n.sentUserGenerate&&n.sendUserGenerate())})),(0,j.VS)(j.Bg)||(n.dropDraft(),!n.sentUserGenerate&&n.sendUserGenerate()))},acceptAnnotation:function(){e.isSubmitting||o((async()=>{const t=e.annotationStore.selected;if(t.beforeSend(),!t.validate())return;if((0,j.VS)(j.Bg)){const n=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,t,{event:"acceptAnnotation"});if(n&&n.some((e=>!1===e)))return}const n=t.history.canUndo;t.dropDraft(),await(0,u._$)(e).events.invoke("acceptAnnotation",e,{isDirty:n,entity:t}),e.incrementQueuePosition()}),"Error during accept, try again")},rejectAnnotation:function({comment:t=null}){e.isSubmitting||o((async()=>{const n=e.annotationStore.selected;if(n.beforeSend(),!n.validate())return;if((0,j.VS)(j.Bg)){const t=await(0,u._$)(e).events.invoke("beforeSaveAnnotation",e,n,{event:"rejectAnnotation"});if(t&&t.some((e=>!1===e)))return}const o=n.history.canUndo;n.dropDraft(),await(0,u._$)(e).events.invoke("rejectAnnotation",e,{isDirty:o,entity:n,comment:t}),e.incrementQueuePosition(-1)}),"Error during reject, try again")},handleCustomButton:function(t){if(e.isSubmitting)return;const n=t.name;o((async()=>{const o=e.annotationStore.selected;o.beforeSend();const i=o.history.canUndo;await(0,u._$)(e).events.invoke("customButton",e,n,{isDirty:i,entity:o,button:t}),e.incrementQueuePosition(),o.dropDraft()}),`Error during handling ${t} button, try again`)},presignUrlForProject:async function(t){const n=await e.events.invoke("presignUrlForProject",e,t);return null==n?void 0:n[0]},setUsers:function(t){e.users.replace(t)},mergeUsers:function(t){e.setUsers(Rg()([...(0,u.dV)(e.users),...t],"id"))},enrichUsers:function(t){const n=(0,u.dV)(e.users),o={};n.forEach((e=>{o[e.id]=e}));const i=t.map((e=>Object.assign({},o[e.id],e)));e.setUsers(Rg()([...i,...n],"id"))},showModal:n,toggleComments:function(t){return e.showComments=t},toggleSettings:function(){e.showingSettings=!e.showingSettings},toggleDescription:function(){e.showingDescription=!e.showingDescription},setAutoAnnotation:t=>{e._autoAnnotation=t,localStorage.setItem("autoAnnotation",t)},setAutoAcceptSuggestions:t=>{e._autoAcceptSuggestions=t,localStorage.setItem("autoAcceptSuggestions",t)},loadSuggestions:(0,u.L3)((function*(t,n){const o=T();e.suggestionsRequest=o,e.setFlags({awaitingSuggestions:!0});try{const i=yield t;o===e.suggestionsRequest&&(e.annotationStore.selected.setSuggestions(n(i)),e.setFlags({awaitingSuggestions:!1}))}catch(t){e.setFlags({awaitingSuggestions:!1})}})),addAnnotationToTaskHistory:function(t){const n=e.taskHistory.findIndex((({taskId:t})=>t===e.task.id));n>=0&&(e.taskHistory[n].annotationId=t)},nextTask:function(){if(e.canGoNextTask){const{taskId:t,annotationId:n}=e.taskHistory[e.taskHistory.findIndex((t=>t.taskId===e.task.id))+1];(0,u._$)(e).events.invoke("nextTask",t,n),e.incrementQueuePosition()}},prevTask:function(t,n=!1){const o=n?e.taskHistory.length-1:e.taskHistory.findIndex((t=>t.taskId===e.task.id))-1;if(e.canGoPrevTask||n){const{taskId:t,annotationId:n}=e.taskHistory[o];(0,u._$)(e).events.invoke("prevTask",t,n),e.incrementQueuePosition(-1)}},postponeTask:async function(){const t=e.annotationStore.selected;await t.saveDraft({was_postponed:!0}),await(0,u._$)(e).events.invoke("nextTask"),e.incrementQueuePosition()},incrementQueuePosition:function(t=1){e.queuePosition=(0,x.clamp)(e.queuePosition+t,1,e.queueTotal)},beforeDestroy(){od.removeAllTools(),t=null},setAppControls:function(e){t=e},clearApp:function(){var e;null==(e=t)||e.clear()},renderApp:function(){var e;null==(e=t)||e.render()},selfDestroy(){const t=[];let n;for((0,u.GG)(e,(n=>{(0,u.jX)(n)||(0,u.PA)(n)!==e||t.push(n)}));n=t.shift();)try{(0,u.zr)(n)}catch(e){console.log("Problem: ",e)}}}})),Sw=async(e,t)=>{var o,i,s,r,a,l,d,c,u;null!=(o=e.options)&&o.secureMode&&(window.LS_SECURE_MODE=!0);const h=await(async()=>(await n.e(99).then(n.bind(n,64099))).default)();if(null!=(i=e=Object.assign({},e))&&i.config||!h.getExample)null!=(s=e)&&s.task&&(e.task=h.getData(e.task));else{const{task:t,config:n}=await h.getExample();e.config=n,e.task=t}null!=(r=e.task)&&r.id&&(e.taskHistory=[{taskId:e.task.id,annotationId:null}]);const g=xw.create(e,Object.assign({},h.configureApplication(e),{events:t}));return g.initializeStore(Object.assign({},null!=(a=e.task)?a:{},{hydrated:null==(l=null==(d=e)?void 0:d.hydrated)||l,users:null!=(c=e.users)?c:[],annotationHistory:null!=(u=e.history)?u:[]})),{store:g,getRoot:h.rootElement}};class ww extends m.Component{constructor(...e){super(...e),this.state={initialized:!1}}componentDidMount(){Sw(this.props).then((({store:e})=>{this.store=e,window.Htx=this.store,this.setState({initialized:!0})}))}componentDidUpdate(e){this.props.task!==e.task&&(this.store.resetState(),this.store.assignTask(this.props.task),this.store.initializeStore(this.props.task))}render(){return this.state.initialized?(0,A.jsx)(ew,{store:this.store}):null}}var kw=n(30997);const Cw={interfaces:["panel","update","submit","skip","controls","infobar","topbar","instruction","side-column","annotations:history","annotations:tabs","annotations:menu","annotations:current","annotations:add-new","annotations:delete","annotations:view-all","predictions:tabs","predictions:menu","auto-annotation","edit-history"]};class jw{constructor(){this.events=new Map}on(e,t){const n=this.getEventMap(e);n.has(t)||n.add(t)}off(e,t){const n=this.getEventMap(e);n.has(t)&&n.delete(t)}removeAll(e){this.getEventMap(e).clear()}invoke(e,...t){const n=this.getEventMap(e);if(n.size>0)return Promise.all([...n].map((e=>e(...t))))}invokeFirst(e,...t){const n=this.getEventMap(e);if(n.size>0){return Array.from(n)[0](...t)}}hasEvent(e){return this.getEventMap(e).size>0}getEventMap(e){let t;return this.events.has(e)?t=this.events.get(e):(t=new Set,this.events.set(e,t)),t}}(0,c.jK)({isolateGlobalState:!0});class Rw{static destroyAll(){Rw.instances.forEach((e=>null==e.destroy?void 0:e.destroy())),Rw.instances.clear()}getRootElement(e){let t=null;if(t="string"==typeof e?document.getElementById(e):e,!t)throw new Error(`Root element not found (selector: ${e})`);return t}constructor(e,t={}){this.options=void 0,this.root=void 0,this.store=void 0,this.destroy=()=>{},this.events=new jw;const n=Object.assign({},Cw,t);n.keymap&&go.setKeymap(n.keymap),this.root=e,this.options=n,this.supportLegacyEvents(),this.createApp(),Rw.instances.add(this)}on(e,t){this.events.on(e,t)}off(e,t){(0,x.isDefined)(t)?this.events.off(e,t):this.events.removeAll(e)}async createApp(){const{store:e}=await Sw(this.options,this.events),t=this.getRootElement(this.root);this.store=e,window.Htx=this.store;const n=!1,o=()=>{(0,h.render)((0,A.jsx)(ew,{store:this.store}),t)},i=()=>{var e;if(null==(e=t.childNodes)||!e.length)return;const n=[...t.childNodes],o=av(n[0]);(0,h.unmountComponentAtNode)(t),lv(n,o),lv([t],o)};o(),e.setAppControls({isRendered:()=>n,render:o,clear:i}),this.destroy=()=>{(0,j.VS)(j.SM)&&i(),ip(),(0,j.VS)(j.SM)&&this.store.selfDestroy(),(0,u.zr)(this.store),go.unbindAll(),(0,j.VS)(j.SM)&&(this.store=null,this.destroy=null,Rw.instances.delete(this))}}supportLegacyEvents(){Object.keys(kw.A).forEach((e=>{const t=this.options[e];if((0,x.isDefined)(t)){const n=(0,g.toCamelCase)(e.replace(/^on/,""));this.events.on(n,t)}}))}}Rw.Component=ww,Rw.instances=new Set,window.LabelStudio=Rw;const _w=Rw},50494:(e,t,n)=>{"use strict";n.d(t,{JE:()=>c,KE:()=>g,Sl:()=>h,cn:()=>d,eB:()=>u});var o=n(73033),i=n(14041);const s=["tag","name","mod","mix"],r=["tag","component","block","name","mod","mix"];const a=null!="lsf-"?"lsf-":"dm-",l=(0,i.createContext)(null),d=(e,t={})=>{const{elem:n,mix:o,mod:i}=null!=t?t:{},s=e,r={block:e=>d(e,{elem:n,mix:o,mod:i}),elem:t=>d(e,{elem:t,mix:o,mod:i}),mod(t={}){const r=Object.assign({},null!=i?i:{},t);return d(null!=e?e:s,{elem:n,mix:o,mod:r})},mix:(...t)=>d(e,{elem:n,mix:t,mod:i}),select(e=document){return e.querySelector(this.toCSSSelector())},selectAll(e=document){return e.querySelectorAll(this.toCSSSelector())},closest(e){return e.closest(this.toCSSSelector())},toString:()=>((e,t,n,o)=>{const i=e,s=t?`${i}__${t}`:null,r=Object.entries(null!=o?o:{}).reduce(((e,[t,n])=>{const o=[null!=s?s:i];return null==n||!1!==n&&(o.push(t),!0!==n&&o.push(n),e.push(o.join("_"))),e}),[]),l=[];if(l.push(null!=s?s:i),l.push(...r),n){const e=Array.isArray(n)?n:[n],t=[].concat(...e).filter((e=>"string"==typeof e?""!==e.trim():null!=e)).map((e=>"string"==typeof e?e:null==e||null==e.toClassName?void 0:e.toClassName())).reduce(((e,t)=>[...e,...t.split(/\s+/)]),[]);l.push(...Array.from(new Set(t)))}return l.map((e=>("string"!=typeof e&&console.error("Non-string classname: ",e),String(e).startsWith(a)?e:`${a}${e}`))).join(" ")})(e,n,o,i),toClassName(){return this.toString()},toCSSSelector(){return`.${this.toClassName().replace(/(\s+)/g,".")}`}};return Object.defineProperty(r,"Block",{value:u}),Object.defineProperty(r,"Elem",{value:h}),Object.defineProperty(r,"__class",{value:{block:e,elem:n,mix:o,mod:i}}),r},c=e=>{const t=null!=e?e:(0,i.createContext)(null),n=(0,i.forwardRef)(((e,n)=>{let{tag:r="div",name:a,mod:l,mix:c}=e,u=(0,o.A)(e,s);const h=d(a),g=[].concat(c).filter((e=>!!e)),m=h.mod(l).mix(...g,u.className).toClassName(),p=Object.assign({},u,{ref:n,className:m});return(0,i.createElement)(t.Provider,{value:h},(0,i.createElement)(r,p))})),a=(0,i.forwardRef)(((e,n)=>{let{tag:s="div",component:a,block:l,name:c,mod:u,mix:h}=e,g=(0,o.A)(e,r);const m=(0,i.useContext)(t),p=[].concat(h).filter((e=>!!e)),f=(l?d(l):m).elem(c).mod(u).mix(...p,g.className).toClassName(),v=Object.assign({},g,{ref:n,className:f});return"string"!=typeof s&&(v.block=m),a&&(v.tag=s),(0,i.createElement)(null!=a?a:s,v)}));return n.displayName="Block",a.displayName="Elem",{Block:n,Elem:a,Context:t}},{Block:u,Elem:h}=c(l),g=()=>(0,i.useContext)(l)},78438:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(83960),i=n(75696),s=n.n(i),r=n(47895),a=n(72902),l=n(84826);function d(e,t,n,o,i,r){const[a,l,d]=s()(i).rgb(),c=e.getImageData(0,0,n,o),u=new ArrayBuffer(n*o*4),h=new Uint32Array(u),g=new Uint8ClampedArray(u),m=function(){const e=new ArrayBuffer(2),t=new Uint8Array(e),n=new Uint16Array(e);if(t[0]=170,t[1]=187,48042===n[0])return"little endian";if(43707===n[0])return"big endian";return console.error("Can not determine platform endianness, assuming little endian"),"little endian"}();let p,f,v;"little endian"===m?p=255<<24|d<<16|l<<8|a:"big endian"===m?p=a<<24|l<<16|d<<8|255:(console.error(`Unknown platform endianness (${m}), assuming little endian`),p=255<<24|d<<16|l<<8|a);const y=r;for(v=0;v<=o;v++)for(f=0;f<=n;f++){const e=v*n+f;t[e*y]&&(h[e]=p)}c.data.set(g),e.putImageData(c,0,0)}const c={Region2RLE:function(e){var t;if((0,l.VS)(l.gF))return function(e){const{naturalWidth:t,naturalHeight:n}=e.currentImageEntity,i=document.createElement("canvas");i.width=t,i.height=n,i.style.setProperty("position","absolute"),i.style.setProperty("bottom","200%"),i.style.setProperty("right","200%"),i.style.setProperty("opacity","0");const s=i.getContext("2d");if(document.body.appendChild(i),e.rle&&e.rle.length>0){const i=s.createImageData(t,n);i.data.set((0,o.D)(e.rle)),s.putImageData(i,0,0)}const r=null==e.getMaskImage?void 0:e.getMaskImage();r&&s.drawImage(r,0,0),e.touches.length>0&&e.touches.forEach((e=>{const{relativePoints:o}=e.toJSON(),i=(e,o)=>[t*(e/100),n*(o/100)];s.save(),s.beginPath(),s.moveTo(...i(o[0],o[1]));for(let e=0;e<o.length/2;e++)s.lineTo(...i(o[2*e],o[2*e+1]));s.strokeStyle="#000",s.lineWidth=e.relativeStrokeWidth/100*t,s.lineCap="round",s.lineJoin="round",s.globalCompositeOperation=e.compositeOperation,s.stroke()}));const a=s.getImageData(0,0,t,n).data;for(let e=a.length/4;e--;)a[4*e]=a[4*e+1]=a[4*e+2]=a[4*e+3];return i.remove(),(0,o.l)(a,a.length)}(e);const n=e.currentImageEntity.naturalWidth,i=e.currentImageEntity.naturalHeight,s=null==(t=e.object)?void 0:t.stageRef,r=e.parent;if(!s)return void console.error(`Stage not found for area #${e.cleanId}`);const a=s.findOne(`#${e.cleanId}`);if(!a)return console.error(`Layer #${e.id} was not found on Stage`),[];const d=a.visible();!d&&a.show(),a.findOne(".highlight").hide();const c=s.getWidth(),u=s.getHeight(),h=s.getScaleX(),g=s.getScaleY(),m=s.getX(),p=s.getY(),f=s.getOffsetX(),v=s.getOffsetY(),y=s.getRotation();s.setWidth(r.stageWidth).setHeight(r.stageHeight).setScaleX(1).setScaleY(1).setX(0).setY(0).setOffsetX(0).setOffsetY(0).setRotation(0),s.drawScene();const b=a.toCanvas({pixelRatio:n/e.currentImageEntity.stageWidth}).getContext("2d").getImageData(0,0,n,i);for(let e=b.data.length/4;e--;)b.data[4*e]=b.data[4*e+1]=b.data[4*e+2]=b.data[4*e+3];a.findOne(".highlight").show(),s.setWidth(c).setHeight(u).setScaleX(h).setScaleY(g).setX(m).setY(p).setOffsetX(f).setOffsetY(v).setRotation(y),s.drawScene();const x=(0,o.l)(b.data,b.data.length);return!d&&a.hide(),x},RLE2Region:function(e,{color:t=r.A.FILL_COLOR}={}){const{rle:n}=e,i=e.currentImageEntity.naturalWidth,a=e.currentImageEntity.naturalHeight,l=document.createElement("canvas"),d=l.getContext("2d");l.width=i,l.height=a;const c=d.createImageData(i,a),u=(0,o.D)(n);c.data.set(u,0);const h=s()(t).rgb();for(let e=c.data.length/4;e--;)c.data[4*e+3]&&(c.data[4*e]=h[0],c.data[4*e+1]=h[1],c.data[4*e+2]=h[2]);d.putImageData(c,0,0);const g=new Image;return g.src=l.toDataURL(),g},mask2DataURL:function(e,t,n,o){const i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=n,d(s,e,t,n,o,1),i.toDataURL()},maskDataURL2Image:function(e,{color:t=r.A.FILL_COLOR}={}){return new Promise(((n,o)=>{const i=document.createElement("img");i.onload=()=>{const e=document.createElement("canvas"),o=i.width,s=i.height;e.width=o,e.height=s;const r=e.getContext("2d");r.drawImage(i,0,0);const a=r.getImageData(0,0,o,s);d(r,a.data,o,s,t,4),i.src=e.toDataURL(),n(i)},i.src=e}))},createBrushSizeCircleCursor:function(e){const t=document.createElement("canvas"),n=t.getContext("2d"),o=e+8,i=o/2,s=e/2;return t.width=o,t.height=o,n.beginPath(),n.arc(i,i,s,0,2*Math.PI,!1),n.lineWidth=3,n.strokeStyle="black",n.stroke(),n.beginPath(),n.arc(i,i,s,0,2*Math.PI,!1),n.lineWidth=2,n.strokeStyle="white",n.stroke(),`url('${t.toDataURL()}') ${i} ${i}, auto`},labelToSVG:(()=>{const e={};return({label:t,score:n})=>{let o=t;if(null!==n&&(o+=n),o in e)return e[o];let i=0;const s=[];if(null!=n){const e=a.getScaleGradient(n);s.push(`<rect x="0" y="0" rx="2" ry="2" width="24" height="14" style="fill:${e};opacity:0.5" />`),s.push(`<text x="3" y="10" style="font-size: 8px; font-family: var(--font-mono);">${n.toFixed(2)}</text>`),i+=26}t&&(s.push(`<text x="${i}" y="11" style="font-size: 9.5px; font-weight: bold; font-family: var(--font-mono);">${t}</text>`),i=i+function(e){const t=document.createElement("svg"),n=document.createElement("text");n.style="font-size: 9.5px; font-weight: bold; color: red; fill: red; font-family: var(--font-mono);",n.innerHTML=e,t.appendChild(n),document.body.appendChild(t);const o=n.getBoundingClientRect().width;return t.remove(),o}(t)+2);const r=`<svg xmlns="http://www.w3.org/2000/svg" height="16" width="${i}">${s.join("")}</svg>`,l=`'data:image/svg+xml,${r.replace(/\s{2,}/g," ").replace(/[\r\n%#()<>?[\\\]^`{|}]/g,encodeURIComponent)}'`;return e[o]=l,l}})(),trim:e=>{var t,n;let o,i=e.width,s=e.height;const r=e.getContext("2d"),a={top:null,left:null,right:null,bottom:null};try{o=document.createElement("canvas").getContext("2d");const t=r.getImageData(0,0,e.width,e.height),n=t.data.length;let l,d,c;for(l=0;l<n;l+=4)0!==t.data[l+3]&&(d=l/4%e.width,c=~~(l/4/e.width),null===a.top&&(a.top=c),(null===a.left||d<a.left)&&(a.left=d),(null===a.right||a.right<d)&&(a.right=d),(null===a.bottom||a.bottom<c)&&(a.bottom=c));i=a.right-a.left,s=a.bottom-a.top;const u=r.getImageData(a.left,a.top,i,s);o.canvas.width=i,o.canvas.height=s,o.putImageData(u,0,0)}catch(e){}return{canvas:null!=(t=null==(n=o)?void 0:n.canvas)?t:e,bbox:Object.assign({},a,{width:i,height:s})}}}},72902:(e,t,n)=>{"use strict";n.r(t),n.d(t,{colorToRGBA:()=>u,colorToRGBAArray:()=>y,contrastColor:()=>v,convertToRGBA:()=>h,getScaleGradient:()=>p,hexToRGBA:()=>c,over:()=>S,removeAlpha:()=>f,rgbArrayToHex:()=>b,rgbaArrayToRGBA:()=>x,rgbaChangeAlpha:()=>m,stringToColor:()=>g});var o=n(75696),i=n.n(o);const s=["#c22525","#c13025","#bf3b24","#be4624","#bc5124","#bb5b23","#ba6623","#b87023","#b77a22","#b58422","#b48d22","#b39722","#b1a021","#b0aa21","#aaae21","#9ead20","#93ab20","#87aa20","#7ca91f","#71a71f","#66a61f","#5ba41e","#51a31e","#46a21e","#3ca01e","#329f1d","#289d1d","#1e9c1d","#1c9a24","#1c992d","#1c992d"],r={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},a=/^rgba\((25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*(?:,\s*([01]\.?\d*?))\)$/,l=/^rgb\((25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*,\s*(25[0-5]|2[0-4]\d|1\d{2}|\d\d?)\s*\)$/;function d(e){const t=[0,0,0];return e&&4===e.length?(t[0]=`0x${e[1]}${e[1]}`,t[1]=`0x${e[2]}${e[2]}`,t[2]=`0x${e[3]}${e[3]}`):e&&7===e.length&&(t[0]=`0x${e[1]}${e[2]}`,t[1]=`0x${e[3]}${e[4]}`,t[2]=`0x${e[5]}${e[6]}`),t.map((e=>+e))}function c(e,t){const n=d(e);let o=.3;return"number"==typeof Number.parseInt(t)&&(o=t),`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${o})`}function u(e,t){if("string"==typeof e){return c(r[e.toLowerCase()],t)}return e}function h(e,t){const n=y(e);return n[3]=Number(t)===t?t:n[3],x(n)}function g(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);let n="#";for(let e=0;e<3;e++){n+=`00${(t>>8*e&255).toString(16)}`.substr(-2)}return n}function m(e,t){return e.replace(/[\d\.]+\)$/g,`${t})`)}function p(e){return s[Math.ceil(30*e)]}const f=(e,t,n,o,i=[255,255,255,1])=>{const s=[];return s[3]=1-(1-o)*(1-i[3]),s[0]=Math.round(e*o/s[3]+i[0]*i[3]*(1-o)/s[3]),s[1]=Math.round(t*o/s[3]+i[1]*i[3]*(1-o)/s[3]),s[2]=Math.round(n*o/s[3]+i[2]*i[3]*(1-o)/s[3]),s},v=e=>{const[t,n,o]=f(...e.match(/([0-9.]{1,3})/g).map(Number));return(299*t+587*n+114*o)/1e3>=128?"rgb(0,0,0)":"rgb(255,255,255)"};function y(e){if(e){if("#"===e.charAt(0)){const t=d(e);return t.push(1),t}let t;if(t=a.exec(e))return t.slice(1,5).map((e=>+e));if(t=l.exec(e)){const e=t.slice(1,4);return e.push(1),e.map((e=>+e))}if("string"==typeof e){const t=d(r[e.toLowerCase()]);return t.push(1),t}}return[0,0,0,1]}function b(e){const t=e.slice(0,3).map((e=>(256|e).toString(16).slice(1)));return t.unshift("#"),t.join("")}function x(e){return`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}function S(e,t="white"){e=i()(e),t=i()(t);const n=e.alpha(),o=t.alpha()*(1-n),s=n+o,r=t.rgb()||[];return i()([...e.rgb().map(((e,t)=>(n*e+o*r[t])/s)),s])}},84826:(e,t,n)=>{"use strict";var o,i,s,r;n.d(t,{$b:()=>a,Bg:()=>B,C8:()=>P,F2:()=>R,F5:()=>L,Gd:()=>p,H:()=>v,I8:()=>H,JO:()=>$,JZ:()=>Y,K3:()=>f,LG:()=>k,MV:()=>S,P2:()=>I,RI:()=>d,SM:()=>A,Sm:()=>F,TU:()=>m,Tm:()=>X,U2:()=>W,VS:()=>Z,_m:()=>D,aT:()=>y,bA:()=>x,cE:()=>b,fw:()=>u,gF:()=>j,id:()=>h,jS:()=>C,ow:()=>w,pG:()=>N,pN:()=>z,q$:()=>E,sg:()=>c,um:()=>O,v1:()=>U,vS:()=>g,x0:()=>l,xB:()=>V,xS:()=>K,y8:()=>T,yD:()=>M,yP:()=>_});const a="fflag_fix_front_dev_1284_auto_detect_undo_281022_short",l="ff_front_dev_1442_unselect_shape_on_click_outside_080622_short",d="ff_front_dev_1536_taxonomy_user_labels_150222_long",c="ff_front_DEV_1713_audio_ui_150222_short",u="ff_front_dev_2669_paragraph_author_filter_210622_short",h="ff_front_dev_2671_anchor_rotate_bbox_010722_short",g="ff_front_dev_2715_audio_3_280722_short",m="fflag_feat_dev_2755_regions_list_grouped_by_labels_with_ordered_collapse_short",p="fflag_fix_front_dev_2918_labeling_filtered_paragraphs_250822_short",f="fflag-feat-dev-3034-comments-with-drafts-short",v="fflag_feat_front_dev_3077_repeater_tag_loading_performance_short",y="fflag_fix_front_dev_3377_image_regions_shift_on_resize_280922_short",b="fflag_fix_front_dev_3391_interactive_view_all",x="fflag_feat_front_dev_3873_labeling_ui_improvements_short",S="fflag_fix_front_dev_3793_relative_coords_short",w="fflag_fix_back_dev_4174_overlap_issue_experiments_10012023_short",k="fflag_feat_front_lsdv_e_278_contextual_scrolling_short",C="fflag_feat_all_lsdv_e_294_llm_annotations_180723_long",j="fflag_feat_front_lsdv_4583_multi_image_segmentation_short",R="fflag_feat_front_lsdv_4583_6_images_preloading_short",_="fflag_fix_font_lsdv_3009_draft_saving_stuck_130223_short",T="fflag_fix_front_lsdv_4600_lead_time_27072023_short",A="fflag_fix_front_lsdv_4620_memory_leaks_100723_short",K="fflag_fix_all_lsdv_4711_cors_errors_accessing_task_data_short",E="fflag_fix_front_lsdv_4930_selection_tool_fixes_240423_short",P="fflag_fix_front_lsdv_4998_missed_dynamic_children_030523_short",M="fflag_feat_front_lsdv_5451_async_taxonomy_110823_short",D="fflag_fix_front_leap_218_improve_performance_of_taxonomy_search_short",O="fflag_feat_front_lsdv_5452_taxonomy_labeling_110823_short",I="fflag_fix_all_optic_79_task_count_is_wrong_short",L="fflag_fix_front_leap_443_select_annotation_once",N="fflag_fix_front_leap_32_zoom_perf_190923_short",z="fflag_fix_leap_466_text_sanitization",V="fflag_fix_leap_246_multi_object_hotkeys_160124_short",H="fflag_feat_all_leap_1081_reviewer_flow_updates",B="fflag_feat_all_leap_883_custom_script_270524_short",F="fflag_feat_front_leap_482_self_serve_short",W="fflag_feat_all_leap_1181_bulk_annotation_short",$="fflag_feat_front_leap_1173_disable_postpone_skip_short",U="fflag_feat_all_leap_1430_per_field_comments_100924_short",Y="fflag_feat_front_optic_1479_improve_image_tag_memory_usage_short",X="fflag_fix_front_optic_1608_improve_video_frame_seek_precision_short";function G(){var e,t;return Object.assign({},null!=(e=null==(t=window.APP_SETTINGS)?void 0:t.feature_flags)?e:{})}function Z(e){var t;const n=G(),o={fflag_fix_front_lsdv_4620_memory_leaks_100723_short:!1};return e in o?o[e]:e in n?!0===n[e]:!0===(null==(t=window.APP_SETTINGS)?void 0:t.feature_flags_default_value)}Object.assign(window,{APP_SETTINGS:Object.assign({},null!=(o=window.APP_SETTINGS)?o:{},{feature_flags:Object.assign({},null!=(i=null==(s=window.APP_SETTINGS)?void 0:s.feature_flags)?i:{},null!=(r=window.FEATURE_FLAGS)?r:{})})}),Object.assign(window,{getFeatureFlags:G,isFF:Z})},84411:(e,t,n)=>{"use strict";n.r(t),n.d(t,{applyHighlightStylesToDoc:()=>A,createClass:()=>h,findByXpath:()=>E,findIdxContainer:()=>R,findNodeAt:()=>M,getNodesInRange:()=>y,getTextNodesInRange:()=>b,highlightRange:()=>w,htmlEscape:()=>P,isValidTreeNode:()=>v,labelWithCSS:()=>u,mainOffsets:()=>j,matchesSelector:()=>K,moveStylesBetweenHeadTags:()=>T,normalizeBoundaries:()=>S,removeSpans:()=>_,sanitizeHtml:()=>D,splitBoundaries:()=>k,toGlobalOffset:()=>C,toggleLabelsAndScores:()=>c});var o=n(72829),i=n.n(o),s=n(48862),r=n(47521),a=n.n(r),l=n(78438),d=n(50494);function c(e){const t=t=>{const n=t.getElementsByClassName("htx-highlight");Array.from(n).forEach((t=>{t.classList.contains("htx-manual-label")||(e?t.classList.remove("htx-no-label"):t.classList.add("htx-no-label"))}))},n=(0,d.cn)("htx-richtext").toClassName();t(document),document.querySelectorAll(`iframe.${n}`).forEach((e=>t(e.contentWindow.document)))}const u=(()=>{const e={};return(t,{index:n,labels:o,score:i})=>{const r=o?o.join(","):"",a=[n,r].filter(Boolean).join(":"),d=s.hashCode(a+i);let c=`htx-label-${d}`;if(c=c.toLowerCase(),c in e)return e[c];t.setAttribute("data-labels",r);return h(`.${c}:after`,`content:${`url(${l.A.labelToSVG({label:a,score:i})})`}`),e[d]=!0,c}})();function h(e,t){const n=document.createElement("style");n.type="text/css",document.getElementsByTagName("head")[0].appendChild(n),(n.sheet||{}).insertRule?n.sheet.insertRule(`${e}{${t}}`,0):(n.styleSheet||n.sheet).addRule(e,t)}function g(e){return e.nodeType===Node.TEXT_NODE}function m(e){for(;e.hasChildNodes();)e=e.firstChild;return e}function p(e){for(;e.hasChildNodes();)e=e.lastChild;return e}function f(e){if(e.firstChild)return e.firstChild;for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}}function v(e,t){for(;e;){if(t&&e===t)return!0;if(e.nodeType===Node.ELEMENT_NODE&&"true"===e.dataset.skipNode)return!1;e=e.parentNode}return!0}function y(e){const t=e.startContainer,n=e.endContainer,o=e.commonAncestorContainer,i=[];let s;for(s=t.parentNode;s&&(v(s,o)&&i.push(s),s!==o);s=s.parentNode);for(i.reverse(),s=t;s&&(v(s,o)&&i.push(s),s!==n);s=f(s));return i}function b(e){return y(e).filter((e=>g(e)))}function x(e,t){const n=e.cloneNode(!1);return n.deleteData(0,t),e.deleteData(t,e.length-t),i()(n,e)}function S(e){let t,n,o,{startContainer:i,startOffset:s,endContainer:r,endOffset:a}=e;function l(e){return!!g(e)&&(!(e===i&&s>0)&&(e!==r||0!==a))}for(i.childNodes.length&&s>0&&(i=p(i.childNodes[s-1]),s=i.length||i.childNodes.length),a<r.childNodes.length&&(r=m(r.childNodes[a]),a=0),t=i,n=e=>e===o?null:function(e){if(e.firstChild)return e.firstChild;for(;!e.nextSibling;)if(!(e=e.parentNode))return null;return e.nextSibling}(e),o=p(r);t&&!l(t);)t=n(t);const d=t;for(t=r,n=e=>e===o?null:function(e){if(e.lastChild)return e.lastChild;for(;!e.previousSibling;)if(!(e=e.parentNode))return null;return e.previousSibling}(e),o=m(i);t&&!l(t);)t=n(t);const c=t;e.setStart(d,0),e.setEnd(c,c.length)}function w(e,t,n){null==t&&(t="htx-annotation");const o=/^\s*$/,i=b(e._range);let s=0;e._range.startOffset===i[s].length&&s++;let r=i.length;r>1&&i[i.length-1].length!==e._range.endOffset&&(r-=1);const a=[];for(let e=s,l=r;e<l;e++){const s=i[e];if(!o.test(s.nodeValue)){const e=window.document.createElement("span");e.style.backgroundColor=n.backgroundColor,e.className=t,s.parentNode.replaceChild(e,s),e.appendChild(s),a.push(e)}}return a}function k(e){let{startContainer:t,endContainer:n}=e;const{startOffset:o,endOffset:i}=e;g(n)&&i>0&&i<n.length&&(n=x(n,i),e.setEnd(n,0)),g(t)&&o>0&&o<t.length&&(t===n?(t=x(t,o),e.setEnd(t,i-o)):t=x(t,o),e.setStart(t,0))}const C=(e,t,n)=>{let o=0;const i=e=>{if(e===t)return o;"#text"===e.nodeName&&(o+=e.length),"BR"===e.nodeName&&(o+=1);for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=i(n);if(void 0!==e)return e}}};return n+i(e)},j=e=>{const t=window.getSelection().getRangeAt(0).cloneRange();let n=t.startOffset,o=t.endOffset,i=!1,s=!1;const r=e=>{if("#text"===e.nodeName&&(e===t.startContainer||i||(n+=e.length),e===t.startContainer&&(i=!0),e===t.endContainer||s||(o+=e.length),e===t.endContainer&&(s=!0)),"BR"===e.nodeName&&(i||(n+=1),s||(o+=1)),e.childNodes.length>0)for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=r(n);if(e)return e}}};return r(e),{start:n,end:o}},R=(e,t)=>{let n=t;const o=e=>{if(e)if("#text"===e.nodeName){if(n-e.length<=0)return e;n-=e.length}else if("BR"===e.nodeName)n-=1;else if(e.childNodes.length>0)for(let t=0;t<=e.childNodes.length;t++){const n=e.childNodes[t];if(n){const e=o(n);if(e)return e}}};return{node:o(e),len:n}};function _(e){const t=[];e&&e.forEach((e=>{for(;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);t.push(e.parentNode),e.parentNode.removeChild(e)})),t.forEach((e=>e.normalize()))}function T(e,t){const n={},o=document.createDocumentFragment();for(let t=0;t<e.children.length;){const i=e.children[t];if("STYLE"!==(null==i?void 0:i.tagName)){t++;continue}const s=i.sheet;try{const e=s.rules,t=n[i.id]=[];for(let n=0;n<e.length;n++)t.push(e[n].cssText)}finally{o.appendChild(i)}}t.appendChild(o),A(t.ownerDocument,n)}function A(e,t){for(let n=0;n<e.styleSheets.length;n++){const o=e.styleSheets[n].ownerNode;if(o.id)try{const e=t[o.id];if(!e)continue;for(let t=0;t<e.length;t++)o.sheet.insertRule(e[t])}catch(e){}}}const K=(e,t)=>e.matches(t)||null!==e.closest(t),E=(e,t=document)=>(t!==document&&"."!==e[0]&&(e=`.${e}`),document.evaluate(e,t,null,XPathResult.ANY_TYPE,null).iterateNext()),P=e=>{const t=`${e}`,n=/["'&<>]/.exec(t);if(!n)return t;let o,i="",s=0,r=0;for(s=n.index;s<t.length;s++){switch(t.charCodeAt(s)){case 34:o="&quot;";break;case 38:o="&amp;";break;case 39:o="&#39;";break;case 60:o="&lt;";break;case 62:o="&gt;";break;default:continue}r!==s&&(i+=t.substring(r,s)),r=s+1,i+=o}return r!==s?i+t.substring(r,s):i};function M(e,t){for(let n=e.firstChild,o=0;n;)if(n.textContent.length+o>=t){if(!n.firstChild)return[n,t-o];n=n.firstChild}else o+=n.textContent.length,n=n.nextSibling}function D(e=[]){if(!e)return"";const t=["onauxclick","onafterprint","onbeforematch","onbeforeprint","onbeforeunload","onbeforetoggle","onblur","oncancel","oncanplay","oncanplaythrough","onchange","onclick","onclose","oncontextlost","oncontextmenu","oncontextrestored","oncopy","oncuechange","oncut","ondblclick","ondrag","ondragend","ondragenter","ondragleave","ondragover","ondragstart","ondrop","ondurationchange","onemptied","onended","onerror","onfocus","onformdata","onhashchange","oninput","oninvalid","onkeydown","onkeypress","onkeyup","onlanguagechange","onload","onloadeddata","onloadedmetadata","onloadstart","onmessage","onmessageerror","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onoffline","ononline","onpagehide","onpageshow","onpaste","onpause","onplay","onplaying","onpopstate","onprogress","onratechange","onreset","onresize","onrejectionhandled","onscroll","onscrollend","onsecuritypolicyviolation","onseeked","onseeking","onselect","onslotchange","onstalled","onstorage","onsubmit","onsuspend","ontimeupdate","ontoggle","onunhandledrejection","onunload","onvolumechange","onwaiting","onwheel"],n={script:!0,iframe:!0};return a()(e,{allowedTags:!1,allowedAttributes:!1,disallowedTagsMode:"discard",allowVulnerableTags:!0,exclusiveFilter:e=>n[e.tag],nonTextTags:["script","textarea","option","noscript"],transformTags:{"*":(e,n)=>(Object.keys(n).forEach((e=>{t.includes(e)&&delete n[e]})),{tagName:e,attribs:n})}})}},18094:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(84411),i=n(31085);const s={DONE:"Done!",NO_COMP_LEFT:"No more annotations",NO_NEXT_TASK:"No More Tasks Left in Queue",NO_ACCESS:"You don't have access to this task",CONFIRM_TO_DELETE_ALL_REGIONS:"Please confirm you want to delete all labeled regions",ERR_REQUIRED:({modelName:e,field:t})=>`Attribute <b>${t}</b> is required for <b>${e}</b>`,ERR_UNKNOWN_TAG:({modelName:e,field:t,value:n})=>`Tag with name <b>${n}</b> is not registered. Referenced by <b>${e}#${t}</b>.`,ERR_TAG_NOT_FOUND:({modelName:e,field:t,value:n})=>`Tag with name <b>${n}</b> does not exist in the config. Referenced by <b>${e}#${t}</b>.`,ERR_TAG_UNSUPPORTED:({modelName:e,field:t,value:n,validType:o})=>`Invalid attribute <b>${t}</b> for <b>${e}</b>: referenced tag is <b>${n}</b>, but <b>${e}</b> can only control <b>${[].concat(o).join(", ")}</b>`,ERR_PARENT_TAG_UNEXPECTED:({validType:e,value:t})=>`Tag <b>${t}</b> must be a child of one of the tags <b>${[].concat(e).join(", ")}</b>.`,ERR_BAD_TYPE:({modelName:e,field:t,validType:n})=>`Attribute <b>${t}</b> of tag <b>${e}</b> has invalid type. Valid types are: <b>${n}</b>.`,ERR_INTERNAL:({value:e})=>`Internal error. See browser console for more info. Try again or contact developers.<br/>${e}`,ERR_GENERAL:({value:e})=>e,URL_CORS_DOCS:"https://labelstud.io/guide/storage.html#Troubleshoot-CORS-and-access-problems",URL_TAGS_DOCS:"https://labelstud.io/tags",ERR_LOADING_AUDIO:({attr:e,url:t,error:n})=>(0,i.jsxs)("div",{"data-testid":"error:audio",children:[(0,i.jsxs)("p",{children:["Error while loading audio. Check ",(0,i.jsx)("code",{children:e})," field in task."]}),(0,i.jsxs)("p",{children:["Technical description: ",n]}),(0,i.jsxs)("p",{children:["URL: ",(0,o.htmlEscape)(t)]})]}),ERR_LOADING_S3:({attr:e,url:t})=>`\n    <div>\n      <p>\n        There was an issue loading URL from <code>${e}</code> value.\n        The request parameters are invalid.\n        If you are using S3, make sure youve specified the right bucket region name.\n      </p>\n      <p>URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,o.htmlEscape)(t)}</a></code></p>\n    </div>`,ERR_LOADING_CORS({attr:e,url:t}){return`\n    <div>\n      <p>\n        There was an issue loading URL from <code>${e}</code> value.\n        Most likely that's because static server has wide-open CORS.\n        <a href="${this.URL_CORS_DOCS}" target="_blank">Read more on that here.</a>\n      </p>\n      <p>\n        Also check that:\n        <ul>\n          <li>URL is valid</li>\n          <li>Network is reachable</li>\n        </ul>\n      </p>\n      <p>URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,o.htmlEscape)(t)}</a></code></p>\n    </div>`},ERR_LOADING_HTTP({attr:e,url:t,error:n}){return`\n    <div data-testid="error:http">\n      <p>\n        There was an issue loading URL from <code>${e}</code> value\n      </p>\n      <p>\n        Things to look out for:\n        <ul>\n          <li>URL is valid</li>\n          <li>URL scheme matches the service scheme, i.e. https and https</li>\n          <li>\n            The static server has wide-open CORS,\n            <a href=${this.URL_CORS_DOCS} target="_blank">more on that here</a>\n          </li>\n        </ul>\n      </p>\n      <p>\n        Technical description: <code>${n}</code>\n        <br />\n        URL: <code><a href="${encodeURI(t)}" target="_blank" rel="noreferrer">${(0,o.htmlEscape)(t)}</a></code>\n      </p>\n    </div>`}}},48862:(e,t,n)=>{"use strict";n.r(t),n.d(t,{atobUnicode:()=>m,camelizeKeys:()=>R,chunks:()=>k,clamp:()=>w,delay:()=>b,destroyMSTObject:()=>P,emailFromCreatedBy:()=>j,escapeHtml:()=>p,findClosestParent:()=>S,fixMobxObserve:()=>M,flatten:()=>h,getUrl:()=>d,hashCode:()=>g,humanDateDiff:()=>E,isArraysEqual:()=>f,isDefined:()=>x,isMacOS:()=>A,isString:()=>r,isStringEmpty:()=>a,isStringJSON:()=>l,isValidObjectURL:()=>c,minMax:()=>T,snakeizeKeys:()=>_,sortAnnotations:()=>D,toArray:()=>y,toTimeString:()=>u,triggerResizeEvent:()=>K,userDisplayName:()=>C,wrapArray:()=>v});var o=n(57958),i=n(77099),s=n(83126);const r=e=>"string"==typeof e||e instanceof String,a=e=>!!r(e)&&0===e.length,l=e=>{if(r(e)){try{JSON.parse(e)}catch(e){return!1}return!0}return!1};function d(e,t){const n=t.slice(e),o=/^(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/g.exec(n);return o&&o.length?o[1]:""}function c(e,t=!1){return"string"==typeof e&&(!(!t||!e.startsWith("/"))||/^https?:\/\//.test(e))}function u(e){var t;if("number"==typeof e)return null==(t=new Date(e).toUTCString().match(/(\d\d:\d\d:\d\d)/))?void 0:t[0]}function h(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?h(t):t)),[])}function g(e){let t=0;if(0===e.length)return`${t}`;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return`${t}`}function m(e){return decodeURIComponent(atob(e).split("").map((e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`)).join(""))}function p(e){return(null!=e?e:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function f(e,t){return e.length===t.length&&e.every(((e,n)=>t[n]===e))}function v(e){return[].concat(e)}function y(e){return(Array.isArray(e)?e:[e]).filter((e=>void 0!==e))}function b(e=0){return new Promise((t=>setTimeout(t,e)))}const x=e=>null!=e;function S(e,t=()=>!0,n=e=>e.parent){for(;e=n(e);)if(t(e))return e;return null}function w(e,t,n){return Math.min(n,Math.max(t,e))}const k=(e,t)=>{const n=[];let o,i;for(o=0,i=e.length;o<i;o+=t)n.push(e.slice(o,o+t));return n},C=(e={})=>{const{firstName:t,lastName:n}=e;return t||n?[t,n].filter((e=>!!e)).join(" ").trim():e.username||e.email},j=e=>{var t;return null==e||null==(t=e.match(/([^@,\s]+@[^@,\s]+)(,\s*\d+)?$/))?void 0:t[1]},R=e=>Object.fromEntries(Object.entries(e).map((([e,t])=>"[object Object]"===Object.prototype.toString.call(t)?[(0,s.toCamelCase)(e),R(t)]:[(0,s.toCamelCase)(e),t]))),_=e=>Object.fromEntries(Object.entries(e).map((([e,t])=>"[object Object]"===Object.prototype.toString.call(t)?[(0,s.toSnakeCase)(e),_(t)]:[(0,s.toSnakeCase)(e),t])));function T(e){return e.reduce(((e,t)=>(e[0]=void 0===e[0]||t<e[0]?t:e[0],e[1]=void 0===e[1]||t>e[1]?t:e[1],e)),[])}function A(){return navigator.platform.indexOf("Mac")>-1}const K=()=>{const e=new Event("resize");e.initEvent("resize",!1,!1),window.dispatchEvent(e)},E=e=>{const t=(0,o.A)(new Date(e),{addSuffix:!0});return"less than a minute ago"===t?"just now":t},P=e=>{e&&((0,i.Yo)(e),(0,i.zr)(e))},M=(...e)=>{},D=e=>e.sort(((e,t)=>new Date(t.createdDate).getTime()-new Date(e.createdDate).getTime()))},13346:()=>{},49264:()=>{},35296:()=>{}}]);
//# sourceMappingURL=667.js.map